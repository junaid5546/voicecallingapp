// Copyright (c) Microsoft Corporation. All rights reserved.
// Licensed under the Microsoft Software License Terms for the Azure Communications Services, Azure CPaaS, AZURE COMMUNICATION SERVICES VOICE AND VIDEO CALLING CLIENT LIBRARY
// See LICENSE file for license information.
import{createClientLogger as g,AzureLogger as m}from"@azure/logger";import{getIdentifierKind as f,isPhoneNumberIdentifier as S}from"@azure/communication-common";var v,C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function getDefaultExportFromCjs(g){return g&&g.__esModule&&Object.prototype.hasOwnProperty.call(g,"default")?g.default:g}function createCommonjsModule(g,m,f){return g(f={path:m,exports:{},require:function(g,m){return commonjsRequire(g,null==m?f.path:m)}},f.exports),f.exports}function getAugmentedNamespace(g){if(g.__esModule)return g;var m=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(g).forEach((function(f){var S=Object.getOwnPropertyDescriptor(g,f);Object.defineProperty(m,f,S.get?S:{enumerable:!0,get:function(){return g[f]}})})),m}function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}
/*! *****************************************************************************
Copyright (C) Microsoft. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */!function(g){!function(m){var f="object"==typeof C?C:"object"==typeof self?self:"object"==typeof this?this:Function("return this;")(),S=makeExporter(g);function makeExporter(g,m){return function(f,S){"function"!=typeof g[f]&&Object.defineProperty(g,f,{configurable:!0,writable:!0,value:S}),m&&m(f,S)}}void 0===f.Reflect?f.Reflect=g:S=makeExporter(f.Reflect,S),m(S)}((function(g){var m=Object.prototype.hasOwnProperty,f="function"==typeof Symbol,S=f&&void 0!==Symbol.toPrimitive?Symbol.toPrimitive:"@@toPrimitive",v=f&&void 0!==Symbol.iterator?Symbol.iterator:"@@iterator",C="function"==typeof Object.create,_={__proto__:[]}instanceof Array,E=!C&&!_,T={create:C?function(){return MakeDictionary(Object.create(null))}:_?function(){return MakeDictionary({__proto__:null})}:function(){return MakeDictionary({})},has:E?function(g,f){return m.call(g,f)}:function(g,m){return m in g},get:E?function(g,f){return m.call(g,f)?g[f]:void 0}:function(g,m){return g[m]}},I=Object.getPrototypeOf(Function),b="object"==typeof process&&process.env&&"true"===process.env.REFLECT_METADATA_USE_MAP_POLYFILL,A=b||"function"!=typeof Map||"function"!=typeof Map.prototype.entries?CreateMapPolyfill():Map,P=b||"function"!=typeof Set||"function"!=typeof Set.prototype.entries?CreateSetPolyfill():Set,R=new(b||"function"!=typeof WeakMap?CreateWeakMapPolyfill():WeakMap);function decorate(g,m,f,S){if(IsUndefined(f)){if(!IsArray(g))throw new TypeError;if(!IsConstructor(m))throw new TypeError;return DecorateConstructor(g,m)}if(!IsArray(g))throw new TypeError;if(!IsObject(m))throw new TypeError;if(!IsObject(S)&&!IsUndefined(S)&&!IsNull(S))throw new TypeError;return IsNull(S)&&(S=void 0),DecorateProperty(g,m,f=ToPropertyKey(f),S)}function metadata(g,m){function decorator(f,S){if(!IsObject(f))throw new TypeError;if(!IsUndefined(S)&&!IsPropertyKey(S))throw new TypeError;OrdinaryDefineOwnMetadata(g,m,f,S)}return decorator}function defineMetadata(g,m,f,S){if(!IsObject(f))throw new TypeError;return IsUndefined(S)||(S=ToPropertyKey(S)),OrdinaryDefineOwnMetadata(g,m,f,S)}function hasMetadata(g,m,f){if(!IsObject(m))throw new TypeError;return IsUndefined(f)||(f=ToPropertyKey(f)),OrdinaryHasMetadata(g,m,f)}function hasOwnMetadata(g,m,f){if(!IsObject(m))throw new TypeError;return IsUndefined(f)||(f=ToPropertyKey(f)),OrdinaryHasOwnMetadata(g,m,f)}function getMetadata(g,m,f){if(!IsObject(m))throw new TypeError;return IsUndefined(f)||(f=ToPropertyKey(f)),OrdinaryGetMetadata(g,m,f)}function getOwnMetadata(g,m,f){if(!IsObject(m))throw new TypeError;return IsUndefined(f)||(f=ToPropertyKey(f)),OrdinaryGetOwnMetadata(g,m,f)}function getMetadataKeys(g,m){if(!IsObject(g))throw new TypeError;return IsUndefined(m)||(m=ToPropertyKey(m)),OrdinaryMetadataKeys(g,m)}function getOwnMetadataKeys(g,m){if(!IsObject(g))throw new TypeError;return IsUndefined(m)||(m=ToPropertyKey(m)),OrdinaryOwnMetadataKeys(g,m)}function deleteMetadata(g,m,f){if(!IsObject(m))throw new TypeError;IsUndefined(f)||(f=ToPropertyKey(f));var S=GetOrCreateMetadataMap(m,f,!1);if(IsUndefined(S))return!1;if(!S.delete(g))return!1;if(S.size>0)return!0;var v=R.get(m);return v.delete(f),v.size>0||R.delete(m),!0}function DecorateConstructor(g,m){for(var f=g.length-1;f>=0;--f){var S=(0,g[f])(m);if(!IsUndefined(S)&&!IsNull(S)){if(!IsConstructor(S))throw new TypeError;m=S}}return m}function DecorateProperty(g,m,f,S){for(var v=g.length-1;v>=0;--v){var C=(0,g[v])(m,f,S);if(!IsUndefined(C)&&!IsNull(C)){if(!IsObject(C))throw new TypeError;S=C}}return S}function GetOrCreateMetadataMap(g,m,f){var S=R.get(g);if(IsUndefined(S)){if(!f)return;S=new A,R.set(g,S)}var v=S.get(m);if(IsUndefined(v)){if(!f)return;v=new A,S.set(m,v)}return v}function OrdinaryHasMetadata(g,m,f){if(OrdinaryHasOwnMetadata(g,m,f))return!0;var S=OrdinaryGetPrototypeOf(m);return!IsNull(S)&&OrdinaryHasMetadata(g,S,f)}function OrdinaryHasOwnMetadata(g,m,f){var S=GetOrCreateMetadataMap(m,f,!1);return!IsUndefined(S)&&ToBoolean(S.has(g))}function OrdinaryGetMetadata(g,m,f){if(OrdinaryHasOwnMetadata(g,m,f))return OrdinaryGetOwnMetadata(g,m,f);var S=OrdinaryGetPrototypeOf(m);return IsNull(S)?void 0:OrdinaryGetMetadata(g,S,f)}function OrdinaryGetOwnMetadata(g,m,f){var S=GetOrCreateMetadataMap(m,f,!1);if(!IsUndefined(S))return S.get(g)}function OrdinaryDefineOwnMetadata(g,m,f,S){GetOrCreateMetadataMap(f,S,!0).set(g,m)}function OrdinaryMetadataKeys(g,m){var f=OrdinaryOwnMetadataKeys(g,m),S=OrdinaryGetPrototypeOf(g);if(null===S)return f;var v=OrdinaryMetadataKeys(S,m);if(v.length<=0)return f;if(f.length<=0)return v;for(var C=new P,_=[],E=0,T=f;E<T.length;E++){var I=T[E];C.has(I)||(C.add(I),_.push(I))}for(var b=0,A=v;b<A.length;b++){I=A[b];C.has(I)||(C.add(I),_.push(I))}return _}function OrdinaryOwnMetadataKeys(g,m){var f=[],S=GetOrCreateMetadataMap(g,m,!1);if(IsUndefined(S))return f;for(var v=GetIterator(S.keys()),C=0;;){var _=IteratorStep(v);if(!_)return f.length=C,f;var E=IteratorValue(_);try{f[C]=E}catch(g){try{IteratorClose(v)}finally{throw g}}C++}}function Type(g){if(null===g)return 1;switch(typeof g){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return null===g?1:6;default:return 6}}function IsUndefined(g){return void 0===g}function IsNull(g){return null===g}function IsSymbol(g){return"symbol"==typeof g}function IsObject(g){return"object"==typeof g?null!==g:"function"==typeof g}function ToPrimitive(g,m){switch(Type(g)){case 0:case 1:case 2:case 3:case 4:case 5:return g}var f=3===m?"string":5===m?"number":"default",v=GetMethod(g,S);if(void 0!==v){var C=v.call(g,f);if(IsObject(C))throw new TypeError;return C}return OrdinaryToPrimitive(g,"default"===f?"number":f)}function OrdinaryToPrimitive(g,m){if("string"===m){var f=g.toString;if(IsCallable(f))if(!IsObject(v=f.call(g)))return v;if(IsCallable(S=g.valueOf))if(!IsObject(v=S.call(g)))return v}else{var S;if(IsCallable(S=g.valueOf))if(!IsObject(v=S.call(g)))return v;var v,C=g.toString;if(IsCallable(C))if(!IsObject(v=C.call(g)))return v}throw new TypeError}function ToBoolean(g){return!!g}function ToString(g){return""+g}function ToPropertyKey(g){var m=ToPrimitive(g,3);return IsSymbol(m)?m:ToString(m)}function IsArray(g){return Array.isArray?Array.isArray(g):g instanceof Object?g instanceof Array:"[object Array]"===Object.prototype.toString.call(g)}function IsCallable(g){return"function"==typeof g}function IsConstructor(g){return"function"==typeof g}function IsPropertyKey(g){switch(Type(g)){case 3:case 4:return!0;default:return!1}}function GetMethod(g,m){var f=g[m];if(null!=f){if(!IsCallable(f))throw new TypeError;return f}}function GetIterator(g){var m=GetMethod(g,v);if(!IsCallable(m))throw new TypeError;var f=m.call(g);if(!IsObject(f))throw new TypeError;return f}function IteratorValue(g){return g.value}function IteratorStep(g){var m=g.next();return!m.done&&m}function IteratorClose(g){var m=g.return;m&&m.call(g)}function OrdinaryGetPrototypeOf(g){var m=Object.getPrototypeOf(g);if("function"!=typeof g||g===I)return m;if(m!==I)return m;var f=g.prototype,S=f&&Object.getPrototypeOf(f);if(null==S||S===Object.prototype)return m;var v=S.constructor;return"function"!=typeof v||v===g?m:v}function CreateMapPolyfill(){var g={},m=[],f=function(){function MapIterator(g,m,f){this._index=0,this._keys=g,this._values=m,this._selector=f}return MapIterator.prototype["@@iterator"]=function(){return this},MapIterator.prototype[v]=function(){return this},MapIterator.prototype.next=function(){var g=this._index;if(g>=0&&g<this._keys.length){var f=this._selector(this._keys[g],this._values[g]);return g+1>=this._keys.length?(this._index=-1,this._keys=m,this._values=m):this._index++,{value:f,done:!1}}return{value:void 0,done:!0}},MapIterator.prototype.throw=function(g){throw this._index>=0&&(this._index=-1,this._keys=m,this._values=m),g},MapIterator.prototype.return=function(g){return this._index>=0&&(this._index=-1,this._keys=m,this._values=m),{value:g,done:!0}},MapIterator}();return function(){function Map(){this._keys=[],this._values=[],this._cacheKey=g,this._cacheIndex=-2}return Object.defineProperty(Map.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),Map.prototype.has=function(g){return this._find(g,!1)>=0},Map.prototype.get=function(g){var m=this._find(g,!1);return m>=0?this._values[m]:void 0},Map.prototype.set=function(g,m){var f=this._find(g,!0);return this._values[f]=m,this},Map.prototype.delete=function(m){var f=this._find(m,!1);if(f>=0){for(var S=this._keys.length,v=f+1;v<S;v++)this._keys[v-1]=this._keys[v],this._values[v-1]=this._values[v];return this._keys.length--,this._values.length--,m===this._cacheKey&&(this._cacheKey=g,this._cacheIndex=-2),!0}return!1},Map.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=g,this._cacheIndex=-2},Map.prototype.keys=function(){return new f(this._keys,this._values,getKey)},Map.prototype.values=function(){return new f(this._keys,this._values,getValue)},Map.prototype.entries=function(){return new f(this._keys,this._values,getEntry)},Map.prototype["@@iterator"]=function(){return this.entries()},Map.prototype[v]=function(){return this.entries()},Map.prototype._find=function(g,m){return this._cacheKey!==g&&(this._cacheIndex=this._keys.indexOf(this._cacheKey=g)),this._cacheIndex<0&&m&&(this._cacheIndex=this._keys.length,this._keys.push(g),this._values.push(void 0)),this._cacheIndex},Map}();function getKey(g,m){return g}function getValue(g,m){return m}function getEntry(g,m){return[g,m]}}function CreateSetPolyfill(){return function(){function Set(){this._map=new A}return Object.defineProperty(Set.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),Set.prototype.has=function(g){return this._map.has(g)},Set.prototype.add=function(g){return this._map.set(g,g),this},Set.prototype.delete=function(g){return this._map.delete(g)},Set.prototype.clear=function(){this._map.clear()},Set.prototype.keys=function(){return this._map.keys()},Set.prototype.values=function(){return this._map.values()},Set.prototype.entries=function(){return this._map.entries()},Set.prototype["@@iterator"]=function(){return this.keys()},Set.prototype[v]=function(){return this.keys()},Set}()}function CreateWeakMapPolyfill(){var g=16,f=T.create(),S=CreateUniqueKey();return function(){function WeakMap(){this._key=CreateUniqueKey()}return WeakMap.prototype.has=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m&&T.has(m,this._key)},WeakMap.prototype.get=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m?T.get(m,this._key):void 0},WeakMap.prototype.set=function(g,m){return GetOrCreateWeakMapTable(g,!0)[this._key]=m,this},WeakMap.prototype.delete=function(g){var m=GetOrCreateWeakMapTable(g,!1);return void 0!==m&&delete m[this._key]},WeakMap.prototype.clear=function(){this._key=CreateUniqueKey()},WeakMap}();function CreateUniqueKey(){var g;do{g="@@WeakMap@@"+CreateUUID()}while(T.has(f,g));return f[g]=!0,g}function GetOrCreateWeakMapTable(g,f){if(!m.call(g,S)){if(!f)return;Object.defineProperty(g,S,{value:T.create()})}return g[S]}function FillRandomBytes(g,m){for(var f=0;f<m;++f)g[f]=255*Math.random()|0;return g}function GenRandomBytes(g){return"function"==typeof Uint8Array?"undefined"!=typeof crypto?crypto.getRandomValues(new Uint8Array(g)):"undefined"!=typeof msCrypto?msCrypto.getRandomValues(new Uint8Array(g)):FillRandomBytes(new Uint8Array(g),g):FillRandomBytes(new Array(g),g)}function CreateUUID(){var m=GenRandomBytes(g);m[6]=79&m[6]|64,m[8]=191&m[8]|128;for(var f="",S=0;S<g;++S){var v=m[S];4!==S&&6!==S&&8!==S||(f+="-"),v<16&&(f+="0"),f+=v.toString(16).toLowerCase()}return f}}function MakeDictionary(g){return g.__=void 0,delete g.__,g}g("decorate",decorate),g("metadata",metadata),g("defineMetadata",defineMetadata),g("hasMetadata",hasMetadata),g("hasOwnMetadata",hasOwnMetadata),g("getMetadata",getMetadata),g("getOwnMetadata",getOwnMetadata),g("getMetadataKeys",getMetadataKeys),g("getOwnMetadataKeys",getOwnMetadataKeys),g("deleteMetadata",deleteMetadata)}))}(v||(v={}));var _=createCommonjsModule((function(g,m){function vsprintf(g,m){var f=0;return g.replace(/%[dixs%]/g,(function(g){var S=0;if("%"!==g[S++])return"";var v=g[S++];return"%"===v?"%":"s"===v||"d"===v||"i"===v?m[f++]:"x"===v?m[f++].toString(16):g}))}function sprintf(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];return vsprintf(g,m)}
/*!
 *  AufLog.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2016-12-29
 *  Copyright 2016 Microsoft. All rights reserved.
 *
 */
Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Trace=10]="Trace",g[g.Debug6=16]="Debug6",g[g.Debug5=18]="Debug5",g[g.Debug4=20]="Debug4",g[g.Debug3=30]="Debug3",g[g.Debug2=40]="Debug2",g[g.Debug1=50]="Debug1",g[g.Warning=60]="Warning",g[g.Error=70]="Error",g[g.Fatal=80]="Fatal",g[g.MetaData=90]="MetaData"}(m.LogLevel||(m.LogLevel={})),function(g){g[g.UseDefault=0]="UseDefault",g[g.Compress=1]="Compress",g[g.Disabled=2]="Disabled"}(m.LogFileCompression||(m.LogFileCompression={})),function(g){g[g.Raw=0]="Raw",g[g.Base64=1]="Base64"}(m.LogFileEncoding||(m.LogFileEncoding={})),function(g){g[g.Unencrypted=0]="Unencrypted",g[g.Encrypted=1]="Encrypted"}(m.LogFileEncryption||(m.LogFileEncryption={})),function(g){g[g.PEM=0]="PEM",g[g.DER=1]="DER",g[g.BER=2]="BER"}(m.CertStoreFormat||(m.CertStoreFormat={})),function(g){g[g.InsertFront=8]="InsertFront"}(m.AppenderFlags||(m.AppenderFlags={})),m.vsprintf=vsprintf,m.sprintf=sprintf})),E=createCommonjsModule((function(g,m){
/*!
 *  LogFactory.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2016-12-29
 *  Copyright 2016 Microsoft. All rights reserved.
 *
 */
var f,S,v=C&&C.__extends||(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});function hash(g){if(null===g)return-1;for(var m=0,f=g.length-1;f>=0;f--)m=37*m+g.charCodeAt(f)|0;var S="__auf_literal:";for(f=S.length-1;f>=0;f--)m=37*m+S.charCodeAt(f)|0;return m}Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Unsafe=0]="Unsafe",g[g.Safe=1]="Safe",g[g.Inherited_Unsafe=2]="Inherited_Unsafe",g[g.Inherited_Safe=3]="Inherited_Safe",g[g.Blacklisted_Unsafe=4]="Blacklisted_Unsafe"}(S||(S={}));var E,T=function(){function LogComponentImpl(g,m){this._level=_.LogLevel.Debug4,this._threshold=255,this._safe=S.Inherited_Unsafe,this._name=g,m&&(this._level=m.level(),this._safe=m.safe()?S.Inherited_Safe:S.Inherited_Unsafe,this._extendedInfo=m.extendedInfo())}return LogComponentImpl.prototype.name=function(){return this._name},LogComponentImpl.prototype.safe=function(){return this._safe===S.Safe||this._safe===S.Inherited_Safe},LogComponentImpl.prototype.safety=function(){return this._safe},LogComponentImpl.prototype.setSafety=function(g){this._safe=g},LogComponentImpl.prototype.description=function(){return this._desc},LogComponentImpl.prototype.setDescription=function(g){this._desc=g},LogComponentImpl.prototype.level=function(){return this._level},LogComponentImpl.prototype.setLevel=function(g){E.setLevel(this,g)},LogComponentImpl.prototype._setLevel=function(g){this._level=g},LogComponentImpl.prototype._setThreshold=function(g){this._threshold=g},LogComponentImpl.prototype.isEnabled=function(g){return this._threshold<=g},LogComponentImpl.prototype.setExtendedInfo=function(g){this._extendedInfo=g},LogComponentImpl.prototype.extendedInfo=function(){return this._extendedInfo},LogComponentImpl.prototype.trace=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Trace,hash(g),g].concat(m))},LogComponentImpl.prototype.debug6=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug6,hash(g),g].concat(m))},LogComponentImpl.prototype.debug5=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug5,hash(g),g].concat(m))},LogComponentImpl.prototype.debug4=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug4,hash(g),g].concat(m))},LogComponentImpl.prototype.debug3=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug3,hash(g),g].concat(m))},LogComponentImpl.prototype.debug2=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug2,hash(g),g].concat(m))},LogComponentImpl.prototype.debug1=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Debug1,hash(g),g].concat(m))},LogComponentImpl.prototype.warn=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Warning,hash(g),g].concat(m))},LogComponentImpl.prototype.error=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Error,hash(g),g].concat(m))},LogComponentImpl.prototype.fatal=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.Fatal,hash(g),g].concat(m))},LogComponentImpl.prototype.meta=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];E.log.apply(E,[this,_.LogLevel.MetaData,hash(g),g].concat(m))},LogComponentImpl}(),I=function(){function LogFactory(){}return LogFactory.instance=function(){return E},LogFactory.levelToString=function(g){return g<=_.LogLevel.Trace?"TRACE":g<=_.LogLevel.Debug6?"DEBUG6":g<=_.LogLevel.Debug5?"DEBUG5":g<=_.LogLevel.Debug4?"DEBUG4":g<=_.LogLevel.Debug3?"DEBUG3":g<=_.LogLevel.Debug2?"DEBUG2":g<=_.LogLevel.Debug1?"DEBUG1":g<=_.LogLevel.Warning?"WARN":g<=_.LogLevel.Error?"ERROR":g<=_.LogLevel.Fatal?"FATAL":(_.LogLevel.MetaData,"META")},LogFactory.levelFromString=function(g){return this._levelFromString[g]||parseInt(g,10)},LogFactory}();function findLevel(g,m){for(var f=m.name();f.length>0;){if(g[f])return g[f];var S=f.lastIndexOf(".");f=S<0?"":f.substr(0,S)}return g[""]?g[""]:_.LogLevel.Debug4}function findThreshold(g,m){var f=255;return m.forEach((function(m){var S=255;m.appender.levels()?S=Math.min(S,findLevel(m.appender.levels(),g)):m.appender.receiveAll()||(S=Math.min(S,g.level())),f=Math.min(f,S)})),f}function appenderMatches(g,m,f){return!!g.appender.receiveAll()||(g.appender.levels()?f>=findLevel(g.appender.levels(),m):f>=m.level())}I._levelFromString={TRACE:_.LogLevel.Trace,DEBUG6:_.LogLevel.Debug6,DEBUG5:_.LogLevel.Debug5,DEBUG4:_.LogLevel.Debug4,DEBUG3:_.LogLevel.Debug3,DEBUG2:_.LogLevel.Debug2,DEBUG1:_.LogLevel.Debug1,WARN:_.LogLevel.Warning,ERROR:_.LogLevel.Error,FATAL:_.LogLevel.Fatal,META:_.LogLevel.MetaData},m.LogFactory=I;var b=function(g){function LogFactoryImpl(){var m=g.call(this)||this;return m._nextId=0,m._appenders=[],m._components={},m._componentBlacklist=[],m._components[""]=new T("",null),m}return v(LogFactoryImpl,g),LogFactoryImpl.prototype.toHex=function(g){return(4294967296+g).toString(16).substr(-8)},LogFactoryImpl.prototype.addAppender=function(g,m){void 0===m&&(m=0);var f=this._nextId++;return m&_.AppenderFlags.InsertFront?this._appenders.unshift({appender:g,handle:f}):this._appenders.push({appender:g,handle:f}),this.recalcComponentThresholds(),f},LogFactoryImpl.prototype.removeAppender=function(g){for(var m=0;m<this._appenders.length;m++)if(this._appenders[m].handle===g){this._appenders.splice(m,1);break}this.recalcComponentThresholds()},LogFactoryImpl.prototype.log=function(g,m,f,S){for(var v=[],C=4;C<arguments.length;C++)v[C-4]=arguments[C];try{if(g.isEnabled(m)){var _={timestamp:(new Date).getTime(),component:g,level:m};this._appenders.forEach((function(C){appenderMatches(C,g,m)&&C.appender.log(_,f,S,v)}))}}catch(g){}},LogFactoryImpl.prototype.parent=function(g){for(;;){var m=g.lastIndexOf(".");if(g=m>=0?g.substr(0,m):"",this._components[g])return this._components[g]}},LogFactoryImpl.prototype.children=function(g){var m=[];for(var f in this._components)this.parent(f).name()===g&&m.push(this._components[f]);return m},LogFactoryImpl.prototype.component=function(g){if(this._components[g])return this._components[g];var m=new T(g,this.parent(g));this._components[g]=m;var f=findThreshold(m,this._appenders);return m._setThreshold(f),m},LogFactoryImpl.prototype.rootComponent=function(){return this.component("")},LogFactoryImpl.prototype.setSafetyRecursive=function(g,m){var f=this;this.children(g).forEach((function(g){g.safety()!==S.Inherited_Safe&&g.safety()!==S.Inherited_Unsafe||(g.setSafety(m),f.setSafetyRecursive(g.name(),m))}))},LogFactoryImpl.prototype.declareComponentSafe=function(g,m){var f=this.component(g);-1!==this._componentBlacklist.indexOf(f.name())?f.setSafety(S.Blacklisted_Unsafe):f.setSafety(m?S.Safe:S.Unsafe),this.setSafetyRecursive(g,m?S.Inherited_Safe:S.Inherited_Unsafe)},LogFactoryImpl.prototype.declareComponentDescription=function(g,m){this.component(g).setDescription(m)},LogFactoryImpl.prototype.setExtendedInfoRecursive=function(g,m){var f=this;this.children(g).forEach((function(g){void 0===g.extendedInfo()&&(g.setExtendedInfo(m),f.setExtendedInfoRecursive(g.name(),m))}))},LogFactoryImpl.prototype.declareComponentExtendedInfo=function(g,m){var f=this.component(g);f.setExtendedInfo(m),this.setExtendedInfoRecursive(f.name(),m)},LogFactoryImpl.prototype.recalcComponentThresholds=function(){for(var g in this._components){var m=this._components[g],f=findThreshold(m,this._appenders);m._setThreshold(f)}},LogFactoryImpl.prototype.setLevel=function(g,m){if(""===g.name())for(var f in this._components){(C=this._components[f])._setLevel(m);var S=findThreshold(C,this._appenders);C._setThreshold(S)}else{var v=g.name()+".";g._setLevel(m);S=findThreshold(g,this._appenders);for(var f in g._setThreshold(S),this._components){var C;if((C=this._components[f]).name().substr(0,v.length)===v){C._setLevel(m);var _=findThreshold(C,this._appenders);C._setThreshold(_)}}}},LogFactoryImpl.prototype.setComponentBlacklist=function(g){for(var m in this._componentBlacklist=g,this._components){var f=this._components[m];-1!==this._componentBlacklist.indexOf(f.name())&&f.setSafety(S.Blacklisted_Unsafe)}},LogFactoryImpl}(I);E=new b})),T=createCommonjsModule((function(g,m){function fromThenable(g){var m=Defer();return g.then((function(g){m.resolve(g)}),(function(g){m.reject(g)})),m.promise().thenAsync((function(g){return g}))}function isThenable(g){return null!=g&&"function"==typeof g.then}function isCancelable(g){return null!=g&&"function"==typeof g.cancel}function run(g,f){if(!m.config.catchExceptions)return g();try{return g()}catch(g){return f(g)}}Object.defineProperty(m,"__esModule",{value:!0}),m.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(g){throw g}},m.fromThenable=fromThenable;var f,S=[],v="undefined"!=typeof setImmediate;function asyncCallback(g){S.push(g),1===S.length&&(v?setImmediate(resolveAsyncCallbacks):setTimeout(resolveAsyncCallbacks,0))}function resolveAsyncCallbacks(){var g=S;S=[];for(var m=0;m<g.length;m++)g[m]()}function all(g){if(0===g.length)return Resolved([]);var m,S=Defer(),v=g.length,C=Array(g.length);S.onCancel((function(m){g.forEach((function(g){isCancelable(g)&&f.SyncTask.cancelOtherInternal(g,m)}))}));var checkFinish=function(){0==--v&&(void 0!==m?S.reject(m):S.resolve(C))};return g.forEach((function(g,f){isThenable(g)?g.then((function(g){C[f]=g,checkFinish()}),(function(g){void 0===m&&(m=void 0===g||g),checkFinish()})):(C[f]=g,checkFinish())})),S.promise()}function Defer(){return new f.SyncTask}function Resolved(g){return(new f.SyncTask).resolve(g).promise()}function Rejected(g){return(new f.SyncTask).reject(g).promise()}function race(g){var m=Defer(),S=!1;return m.onCancel((function(m){g.forEach((function(g){isCancelable(g)&&f.SyncTask.cancelOtherInternal(g,m)}))})),g.forEach((function(g){isThenable(g)?g.then((function(g){S||(S=!0,m.resolve(g))}),(function(g){S||(S=!0,m.reject(g))})):S||(S=!0,m.resolve(g))})),m.promise()}function raceTimer(g,m){var f=Defer(),S=setTimeout((function(){f.resolve({timedOut:!0})}),m);return race([g.then((function(g){return clearTimeout(S),{timedOut:!1,result:g}})),f.promise()])}m.asyncCallback=asyncCallback,function(g){var f=function(){function SyncTask(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return SyncTask.prototype._addCallbackSet=function(g,m){var f=this,S=new SyncTask;return S.onCancel((function(m){g.wasCanceled=!0,g.cancelContext=m,f._cancelInternal(m)})),g.task=S,this._storedCallbackSets.push(g),m?this._mustHandleError=!1:S._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),S.promise()},SyncTask.prototype.onCancel=function(g){return this._completedSuccess||this._completedFail||(this._wasCanceled?g(this._cancelContext):this._cancelCallbacks.push(g)),this},SyncTask.prototype.then=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m},!0)},SyncTask.prototype.thenAsync=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m,asyncCallback:!0},!0)},SyncTask.prototype.catch=function(g){return this._addCallbackSet({failFunc:g},!0)},SyncTask.prototype.always=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!0)},SyncTask.prototype.setTracingEnabled=function(g){return this._traceEnabled=g,this},SyncTask.prototype.finally=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!1),this},SyncTask.prototype.done=function(g){return this._addCallbackSet({successFunc:g},!1),this},SyncTask.prototype.fail=function(g){return this._addCallbackSet({failFunc:g},!1),this},SyncTask.prototype.resolve=function(g){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=g,this._cancelCallbacks=[],this._resolveSuccesses(),this},SyncTask.prototype.reject=function(g){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=g,this._cancelCallbacks=[],this._resolveFailures(),SyncTask._enforceErrorHandled(this),this},SyncTask.prototype._checkState=function(g){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var f="Failed to "+(g?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(f)}(m.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},SyncTask._enforceErrorHandled=function(g){g._mustHandleError&&(SyncTask._rejectedTasks.push(g),SyncTask._enforceErrorHandledTimer||(SyncTask._enforceErrorHandledTimer=setTimeout((function(){SyncTask._enforceErrorHandledTimer=void 0;var g=SyncTask._rejectedTasks;SyncTask._rejectedTasks=[],g.forEach((function(g,f){g._mustHandleError&&m.config.unhandledErrorHandler(g._storedErrResolution)}))}),0)))},SyncTask.prototype.cancel=function(g){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(g)},SyncTask.prototype._cancelInternal=function(g){var m=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=g;var f=this._cancelCallbacks;this._cancelCallbacks=[],f.length>0&&f.forEach((function(g){m._completedSuccess||m._completedFail||g(m._cancelContext)}))}},SyncTask.cancelOtherInternal=function(g,m){var f=g;f._storedCallbackSets&&f._cancelInternal?f._cancelInternal(m):g.cancel(m)},SyncTask.prototype.promise=function(){return this},SyncTask.prototype._resolveSuccesses=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveSuccessCallback(m)})):g._resolveSuccessCallback(m)}))}this._resolving=!1},SyncTask.prototype._resolveSuccessCallback=function(g){var m=this;g.successFunc?run((function(){var f=g.successFunc(m._storedResolution);isCancelable(f)&&(g.wasCanceled?SyncTask.cancelOtherInternal(f,g.cancelContext):g.task.onCancel((function(g){return SyncTask.cancelOtherInternal(f,g)}))),isThenable(f)?f.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(f)}),(function(f){m._handleException(f,"SyncTask caught exception in success block: "+f.toString()),g.task.reject(f)})):g.task.resolve(this._storedResolution)},SyncTask.prototype._resolveFailures=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveFailureCallback(m)})):g._resolveFailureCallback(m)}))}this._resolving=!1},SyncTask.prototype._resolveFailureCallback=function(g){var m=this;g.failFunc?run((function(){var f=g.failFunc(m._storedErrResolution);isCancelable(f)&&(g.wasCanceled?SyncTask.cancelOtherInternal(f,g.cancelContext):g.task.onCancel((function(g){return SyncTask.cancelOtherInternal(f,g)}))),isThenable(f)?f.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(f)}),(function(f){m._handleException(f,"SyncTask caught exception in failure block: "+f.toString()),g.task.reject(f)})):g.task.reject(this._storedErrResolution)},SyncTask.prototype._handleException=function(g,f){m.config.exceptionsToConsole&&console.error(f),m.config.exceptionHandler&&m.config.exceptionHandler(g)},SyncTask.prototype.toEs6Promise=function(){var g=this;return new Promise((function(m,f){return g.then(m,f)}))},SyncTask._rejectedTasks=[],SyncTask}();g.SyncTask=f}(f||(f={})),m.all=all,m.Defer=Defer,m.Resolved=Resolved,m.Rejected=Rejected,m.race=race,m.raceTimer=raceTimer})),I=createCommonjsModule((function(g,m){
/*!
 *  Appenders.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2016-12-29
 *  Copyright 2016 Microsoft. All rights reserved.
 *
 */
var f,S=C&&C.__extends||(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var v,T=function(){function AbstractLogAppender(g){this._formatter=g||new I}return AbstractLogAppender.prototype.formatter=function(){return this._formatter},AbstractLogAppender.prototype.receiveAll=function(){return!1},AbstractLogAppender.prototype.levels=function(){return null},AbstractLogAppender}();function toHex(g){return(4294967296+g).toString(16).substr(-8)}function pad(g,m){return(1e12+g).toString(10).substr(-m)}m.AbstractLogAppender=T,function(g){g[g.Timestamp=1]="Timestamp",g[g.Component=4]="Component",g[g.Level=8]="Level",g[g.FullDate=32]="FullDate",g[g.LogId=64]="LogId"}(v=m.SLF_Flags||(m.SLF_Flags={}));var I=function(){function StandardLogFormatter(g){void 0===g&&(g=4294967295),this._flags=g}return StandardLogFormatter.prototype.format=function(g,m,f,S){var C="";if(this._flags&v.FullDate)C+=new Date(g.timestamp).toISOString()+" ";else if(this._flags&v.Timestamp){var T=new Date(g.timestamp);C+=pad(T.getHours(),2)+":"+pad(T.getMinutes(),2)+":"+pad(T.getSeconds(),2)+"."+pad(T.getMilliseconds(),2)+" "}return this._flags&v.LogId&&(C+="[#"+toHex(m)+"-"+(g.component.safe()?"S":"u")+"] "),this._flags&v.Level&&(C+="["+E.LogFactory.levelToString(g.level)+"] "),this._flags&v.Component&&(C+="["+g.component.name()+"] "),f||""===f?C+_.vsprintf(f,S):C+toHex(m)+": "+S.join(" ")},StandardLogFormatter}();m.StandardLogFormatter=I;var b=console,A=console.log||function(){},P=console.info||A,R=console.warn||P,w=console.error||R,M=function(g){function ConsoleAppender(){return null!==g&&g.apply(this,arguments)||this}return S(ConsoleAppender,g),ConsoleAppender.prototype.log=function(g,m,f,S){S=S.slice(0);var v=g.level<=_.LogLevel.Debug3?A:g.level<=_.LogLevel.Debug1?P:g.level<=_.LogLevel.Warning?R:w;if(-1===m){var C=this.formatter().format(g,m,"",[]);"string"==typeof S[0]&&(C+=S.shift()),v.apply(b,[C].concat(S))}else{for(var E=void 0,T=[];E=f.match(/\s*%@\s*$/);)f=f.substr(0,f.length-E[0].length),T.unshift(S.pop());C=this.formatter().format(g,m,f,S);v.apply(b,[C].concat(T))}},ConsoleAppender}(T);m.ConsoleAppender=M;var D=function(){function ChainedLogAppender(g){this._chained=g}return ChainedLogAppender.prototype.log=function(g,m,f,S){this._chained.log(g,m,f,S)},ChainedLogAppender.prototype.receiveAll=function(){return this._chained.receiveAll()},ChainedLogAppender.prototype.levels=function(){return this._chained.levels()},ChainedLogAppender}();m.ChainedLogAppender=D;var O=function(g){function LevelWrappedAppender(m,f){var S=g.call(this,m)||this;return S._levels=f,S}return S(LevelWrappedAppender,g),LevelWrappedAppender.prototype.levels=function(){return this._levels},LevelWrappedAppender}(D);function wrapAppenderWithLogLevels(g,m){return new O(g,m)}m.wrapAppenderWithLogLevels=wrapAppenderWithLogLevels})),b=createCommonjsModule((function(g,m){
/*!
 *  RootToolsManager.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2016-12-29
 *  Copyright 2016 Microsoft. All rights reserved.
 *
 */
var f,S=C&&C.__extends||(f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var v=E.LogFactory.instance().component("RootToolsManager");E.LogFactory.instance().declareComponentSafe("RootToolsManager",!0);var b,A="638b8ba2bae14e07aa5d73ddb5d5e5c5-297b8412-5df3-4a83-83c4-7b76c6c5d3f0-7104";!function(g){g[g.InternalBuild=0]="InternalBuild",g[g.PublicBuild=1]="PublicBuild"}(b=m.BuildType||(m.BuildType={}));var P=b.InternalBuild;function setBuildType(g){var m=P;return P=g,m}function toHex(g){return(4294967296+g).toString(16).substr(-8)}function map(g,m){var f=[];for(var S in g)f.push(m(S,g[S]));return f}function arrayEquals(g,m,f){if(null==g)return null==m||0===m.length;if(null==m)return null==g||0===g.length;if(g.length===m.length){for(var S=0;S<g.length;S++)if(!f(g[S],m[S]))return!1;return!0}return!1}function matcherEquals(g,m){return null==g?null==m:null==m?null==g:g.arg===m.arg&&g.op===m.op&&g.value===m.value}function conditionEquals(g,m){return null==g?null==m||0===m.logId:null==m?null==g||0===g.logId:g.logId===m.logId&&g.name===m.name&&arrayEquals(g.matchers,m.matchers,matcherEquals)}function filterEqualsToNativeFilter(g,m){return null==g?null==m:null==m?null==g:g.component===m.component&&g.parsedLevel===m.level}function filterEquals(g,m){return null==g?null==m:null==m?null==g:g.component===m.component&&g.level===m.level}function formatArgs(g){for(var m=[],f=0;f<g.length;f++)"string"==typeof g[f]||"number"==typeof g[f]?m.push(g[f]):m.push(JSON.stringify(g[f]));return m}m.setBuildType=setBuildType;var R=function(g){function Trigger(m,f,S){var v=g.call(this)||this;return v._unmetConditions=[],v._rtMan=m,v._triggerCallback=f,v._ecsConfig=S,v.resetConditions(),v}return S(Trigger,g),Trigger.prototype.config=function(){return this._ecsConfig},Trigger.prototype.configEquals=function(g){return this._ecsConfig.includeUnsafe===g.includeUnsafe&&this._ecsConfig.mutualSubmissionType===g.mutualSubmissionType&&this._ecsConfig.name===g.name&&this._ecsConfig.reenableAfterTriggering===g.reenableAfterTriggering&&this._ecsConfig.experimentTarget===g.experimentTarget&&conditionEquals(this._ecsConfig.resetCondition,g.resetCondition)&&arrayEquals(this._ecsConfig.conditions,g.conditions,conditionEquals)&&arrayEquals(this._ecsConfig.filters,g.filters,filterEquals)},Trigger.prototype.nativeConfigEquals=function(g){return this._ecsConfig.includeUnsafe===g.includeUnsafe&&this._ecsConfig.name===g.name&&this._ecsConfig.reenableAfterTriggering===g.reenableAfterTriggering&&conditionEquals(this._ecsConfig.resetCondition,g.resetCondition)&&arrayEquals(this._ecsConfig.conditions,g.conditions,conditionEquals)&&arrayEquals(this._ecsConfig.filters,g.filters,filterEqualsToNativeFilter)},Trigger.prototype.needReset=function(g){return!this.configEquals(g)},Trigger.prototype.resetConditions=function(){this._unmetConditions=[];for(var g=0;g<this._ecsConfig.conditions.length;g++)this._unmetConditions.push(g)},Trigger.prototype.matcherMatches=function(g,m){if(g.arg>=m.length)return!1;var f=m[g.arg],S="string"==typeof f?g.value:parseInt(g.value,10);return"="===g.op||"=="===g.op?f===S:"!="===g.op?f!==S:"<"===g.op?f<S:"<="===g.op?f<=S:">"===g.op?f>S:">="===g.op?f>=S:"CONTAINS"===g.op.toUpperCase()&&(""+f).indexOf(g.value)>=0},Trigger.prototype.conditionMatches=function(g,m,f){if(m!==g.logId)return!1;if(g.matchers)for(var S=0;S<g.matchers.length;S++)if(!this.matcherMatches(g.matchers[S],f))return!1;return!0},Trigger.prototype.log=function(g,m,f,S){if(0!==this._unmetConditions.length&&g.component!==v){var C=this._ecsConfig;C.resetCondition&&this.conditionMatches(C.resetCondition,m,S)&&(v.debug4("LogTrigger %s: resetCondition met",C.name),this.resetConditions());for(var _=0;_<this._unmetConditions.length;_++){var E=this._unmetConditions[_];if(this.conditionMatches(C.conditions[E],m,S)){v.debug4("LogTrigger %s: condition %s met",C.name,C.conditions[E].name),this._unmetConditions.splice(_,1);break}}0===this._unmetConditions.length&&(v.debug1("LogTrigger %s has triggered, trying to send the log",C.name),this._triggerCallback.call(this._rtMan,C),C.reenableAfterTriggering&&this.resetConditions())}},Trigger.prototype.receiveAll=function(){return!0},Trigger}(I.AbstractLogAppender),w=function(g){function CircularBuffer(m,f,S){var v=g.call(this)||this;return v._circularBuffer=[],v._circularBufferMaxSize=0,v._onBufferOverflow=null,v._circularBuffer=[],v._circularBufferMaxSize=f,v._includeUnsafe=m,v._onBufferOverflow=S||function(){return v._circularBuffer.shift()},v}return S(CircularBuffer,g),CircularBuffer.prototype.log=function(g,m,f,S){if((this._includeUnsafe||g.component.safe())&&!(this._circularBuffer.length>this._circularBufferMaxSize)){var v={md:g,logId:m,messages:formatArgs(S)};this._circularBuffer.push(v),this._circularBuffer.length>this._circularBufferMaxSize&&this._onBufferOverflow()}},CircularBuffer.prototype.visitReverseOrder=function(g){for(var m=this._circularBuffer.length-1;m>=0;m--){var f=this._circularBuffer[m];if(!g(f.md,f.logId,f.messages))return}},CircularBuffer.prototype.visitForwardOrder=function(g){for(var m=0;m<this._circularBuffer.length;m++){var f=this._circularBuffer[m];if(!g(f.md,f.logId,f.messages))return}},CircularBuffer.prototype.needReset=function(g,m){return g!==this._includeUnsafe||m!==this._circularBufferMaxSize},CircularBuffer.prototype.dumpLogBuffer=function(g,m,f){var S=this,v=new M(g.reverse),C=g.filter.map((function(g){return{component:"root"===g.component?"":g.component,parsedLevel:g.level}})),_=f||{matchedLines:0,totalLines:0};return(g.reverse?this.visitReverseOrder:this.visitForwardOrder).apply(this,[function(g,f,E){return _.totalLines++,S.filterMatches(g,f,E,C)&&(_.matchedLines++,v.log(g.component,g.timestamp,g.level,f,E)),!m||v._data.length<m}]),v.close(),v.data()},CircularBuffer.prototype.filterMatches=function(g,m,f,S){for(var v=0;v<S.length;v++)if((""===S[v].component||g.component.name()===S[v].component||g.component.name().substr(0,S[v].component.length)===S[v].component&&"."===g.component.name().charAt(S[v].component.length))&&g.level>=S[v].parsedLevel)return!0;return!1},CircularBuffer.prototype.clear=function(){this._circularBuffer=[]},CircularBuffer.prototype.size=function(){return this._circularBuffer.length},CircularBuffer.prototype.empty=function(){return 0===this.size()},CircularBuffer.prototype.capacity=function(){return this._circularBufferMaxSize},CircularBuffer}(I.AbstractLogAppender);m.CircularBuffer=w;var M=function(){function BinaryLogFormatter(g){this._reverse=g,this._first=!0,this._pending=[],this._components={},this._componentCount=0,this._lastts=0,this._base64chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",this._data="ULOG2"+String.fromCharCode(33)+String.fromCharCode(32),this._data+=g?String.fromCharCode(34):String.fromCharCode(32),this._data+=String.fromCharCode(32)}return BinaryLogFormatter.prototype._add8=function(g){if(this._pending.push(255&g),3===this._pending.length){var m=(this._pending[0]<<16)+(this._pending[1]<<8)+(this._pending[2]<<0),f=this._base64chars[m>>18&63]+this._base64chars[m>>12&63]+this._base64chars[m>>6&63]+this._base64chars[m>>0&63];this._data+=f,this._pending=[]}},BinaryLogFormatter.prototype._add16=function(g){this._add8(g>>8&255),this._add8(g>>0&255)},BinaryLogFormatter.prototype._add32=function(g){this._add8(g>>24&255),this._add8(g>>16&255),this._add8(g>>8&255),this._add8(g>>0&255)},BinaryLogFormatter.prototype._add64=function(g){this._add32(g/4294967296|0),this._add32(0|g)},BinaryLogFormatter.prototype._addS=function(g){for(var m=0;m<g.length;m++)this._add8(g.charCodeAt(m));this._add8(0)},BinaryLogFormatter.prototype._close=function(){for(;this._pending.length;)this._add8(0)},BinaryLogFormatter.prototype.log=function(g,m,f,S,v){var C=this._components[g.name()];C||(C=++this._componentCount,this._components[g.name()]=C,this._add8(2),this._add16(C),this._addS(g.name()),this._addS(""),this._addS(""),this._add8(g.safe()?1:0));var _=128;this._first&&(_|=2);var E=m-this._lastts;this._lastts=m,E>-128&&E<128&&(_|=1),this._add8(_),1&_?this._add8(E):this._add64(1e3*m),this._first&&(this._add32(1),this._add8(0),this._add16(0)),this._add16(C),this._add8(f),this._add32(S),this._add8(v.length);for(var T=0;T<v.length;T++)this._add8(8),this._addS(""+v[T]);this._first=!1},BinaryLogFormatter.prototype.close=function(){this._add8(7),this._close()},BinaryLogFormatter.prototype.data=function(){return this._data},BinaryLogFormatter.prototype.empty=function(){return this._first},BinaryLogFormatter}(),D=function(g){function DumperBuffer(m,f,S,v){var C=g.call(this)||this;return C._capacity=m,C._onBufferOverflow=f,C._enableThrottling=S,C._maxVerbosityLevel=v,C._outputFormatter=new M(!1),C._linesStored=0,C._throttling=!1,C._linesThrottled=0,C}return S(DumperBuffer,g),DumperBuffer.prototype.log=function(g,m,f,S){this._maxVerbosityLevel&&g.level<this._maxVerbosityLevel||(this._throttling?this._linesThrottled++:(this._linesStored++,this._outputFormatter.log(g.component,g.timestamp,g.level,m,formatArgs(S))),this._linesStored>this._capacity&&(this._enableThrottling?this._throttling||(this._throttling=!0):this._onBufferOverflow()))},DumperBuffer.prototype.dumpAndReset=function(){if(this._outputFormatter.empty())return"";this._linesThrottled>0&&this._outputFormatter.log(v,(new Date).getTime(),_.LogLevel.Fatal,-1,["RooToolsManager: Log buffer overflow! "+this._linesThrottled+" lines thrown away"]),this._outputFormatter.close();var g=this._outputFormatter.data();return this.clearBuffer(),g},DumperBuffer.prototype.empty=function(){return this._outputFormatter.empty()},DumperBuffer.prototype.clearBuffer=function(){this._outputFormatter=new M(!1),this._linesStored=0,this._linesThrottled=0,this._throttling=!1},DumperBuffer.prototype.capacity=function(){return this._capacity},DumperBuffer.prototype.throttlingEnabled=function(){return this._enableThrottling},DumperBuffer.prototype.size=function(){return this._linesStored},DumperBuffer.prototype.maxVerbosityLevel=function(){return this._maxVerbosityLevel},DumperBuffer}(I.AbstractLogAppender);function validateExperimentTarget(g){return"Native"===g||"JavaScript"===g||"Mixed"===g}m.DumperBuffer=D;var O=function(){function RootToolsManagerImpl(){this._maxUploadSize=0,this._jsToNativeBuffer=null,this._jsToNativeBufferHandle=null,this._jsToNativeFlushTimer=null,this._jsToNativeFlushInterval=0,this._triggers={},this._defaultBuffers=[{size:2097152,level:_.LogLevel.Debug4}],this._defaultKillswitch={blacklist:[],whitelist:[]},this._defaultBlacklists={component:[],logline:[]},this._localLogLevels={},this._defaultExperimentTarget="Mixed",this._BRBCallback=null}return RootToolsManagerImpl.prototype.setDelegate=function(g){this._glue=g,this.registerListeners()},RootToolsManagerImpl.prototype.isDelegateSet=function(){return null!=this._glue},RootToolsManagerImpl.prototype.setNativeFunctions=function(g){this._native&&this._native.log_config.removeLogTriggerListener(this),this._native=g,this._native&&this._native.log_config.addLogTriggerListener(this)},RootToolsManagerImpl.prototype.applyLogLevels=function(){var g={};for(var m in this._localLogLevels)g[m]=this._localLogLevels[m];g[""]=g.root||_.LogLevel.Debug4,delete g.root;var f=map(g,(function(g,m){return{component:g,level:m}}));f.sort((function(g,m){return g.component.length-m.component.length})),f.forEach((function(g){return E.LogFactory.instance().component(g.component).setLevel(g.level)})),this._native&&this._native.log_config.setLogLevelConfig(f)},RootToolsManagerImpl.prototype.setLocalLogLevelConfig=function(g){this._localLogLevels=g,this.applyLogLevels()},RootToolsManagerImpl.prototype.parseMatcher=function(g){return null==g||null==g.arg||null==g.op||null==g.value?null:{arg:g.arg,op:g.op,value:g.value}},RootToolsManagerImpl.prototype.parseCondition=function(g){if(null==g||null==g.logId)return null;if(g.matchers&&!(g.matchers instanceof Array))return null;var m={name:g.name||toHex(g.logId),logId:g.logId,matchers:[]};if(g.matchers&&g.matchers.length)for(var f=0,S=g.matchers;f<S.length;f++){var v=S[f],C=this.parseMatcher(v);C&&m.matchers.push(C)}return m},RootToolsManagerImpl.prototype.parseFilter=function(g){return null==g||null==g.component||0===g.component.length?null:{component:g.component,level:g.level,parsedLevel:E.LogFactory.levelFromString(g.level)}},RootToolsManagerImpl.prototype.parseConfig=function(g,m,f){if(null==g)return null;if(!(g.conditions instanceof Array)||0==g.conditions.length)return null;if(!(g.filters instanceof Array)||0==g.filters.length)return null;if(g.resetCondition&&!this.parseCondition(g.resetCondition))return null;for(var S={name:g.name||m+"->"+f,ecsNs:m,reenableAfterTriggering:g.reenableAfterTriggering||!1,mutualSubmissionType:g.mutualSubmissionType||"",includeUnsafe:P!==b.PublicBuild&&(g.includeUnsafe||!1),experimentTarget:validateExperimentTarget(g.experimentTarget)&&g.experimentTarget||this._defaultExperimentTarget,conditions:[],resetCondition:null==g.resetCondition?g.resetCondition:this.parseCondition(g.resetCondition),filters:[]},v=0,C=g.conditions;v<C.length;v++){var _=C[v],E=this.parseCondition(_);E&&S.conditions.push(E)}for(var T=0,I=g.filters;T<I.length;T++){var A=I[T],R=this.parseFilter(A);R&&S.filters.push(R)}return 0===S.conditions.length?null:S},RootToolsManagerImpl.prototype.isExperimentListed=function(g,m,f,S){return!!g&&(!(!S||!g.some((function(g){return"*"===g.namespace})))||g.some((function(g){return g.namespace===m&&(g.experiment===f||"*"==g.experiment)})))},RootToolsManagerImpl.prototype.isExperimentAllowed=function(g,m,f){return!this.isExperimentListed(g.blacklist,m,f,!0)||this.isExperimentListed(g.whitelist,m,f,!1)},RootToolsManagerImpl.prototype.findTrigger=function(g,m){for(var f in g)if(g[f].configEquals(m))return f;return null},RootToolsManagerImpl.prototype.findTriggerByNativeConfig=function(g,m){for(var f in g)if(g[f].nativeConfigEquals(m))return f;return null},RootToolsManagerImpl.prototype.OnEcsChange=function(){var g=this;function forEachAsync(g,m,f){return m<g.length?f(g[m]).then((function(){return forEachAsync(g,m+1,f)})):T.Resolved()}return null==this._glue?T.Resolved():this._glue.fetchEcsConfig("SkypeRootTools","ULBaseline").then((function(m){v.debug4("Reloading ULBaseline config - new config: %@",m),m||(v.warn("No ULBaseline config"),m={}),g._maxUploadSize=m.logUpload&&m.logUpload.maxSize||1024;var f=[],S=g._triggers;g._triggers={};var C=(m.logUpload&&m.logUpload.maxSize||1024)/100,T=m.circularBuffer&&m.circularBuffer.enabled,b=m.circularBuffer&&m.circularBuffer.buffers||g._defaultBuffers,A=m.circularBuffer&&m.circularBuffer.storeUnsafe;g._defaultExperimentTarget=validateExperimentTarget(m.defaultExperimentTarget)&&m.defaultExperimentTarget||"Mixed";var P=m.killswitch||g._defaultKillswitch,M=m.blacklists||g._defaultBlacklists;M.component.length>0&&E.LogFactory.instance().setComponentBlacklist(M.component);var D={};(m.componentLevels||[]).forEach((function(g){return D[g.component]=g.level})),forEachAsync(m.configPaths||[],0,(function(m){return g._glue.fetchEcsConfig(m.ns,m.key).then((function(C){var _=C instanceof Array?C:[C];v.debug4("Reloading ECS config for %s->%s - new config: %@",m.ns,m.key,_);for(var E=0,I=_;E<I.length;E++){var b=I[E];if(null!=b){var R=g.parseConfig(b,m.ns,m.key);if(null!=R)if("JavaScript"===R.experimentTarget||"Mixed"===R.experimentTarget)if(v.debug2("Parsed ECS config for %s->%s - %@",m.ns,m.key,R),g.isExperimentAllowed(P,m.ns,R.name)){v.debug2("Allowing %s->%s:%s according to killswitch",m.ns,m.key,R.name),T=!0;var w=g.findTrigger(S,R);null!=w?(v.debug2("Triggers updated, keeping trigger %s",R.name),g._triggers[w]=S[w],delete S[w]):f.push(R),R.filters&&R.filters.forEach((function(g){return D[g.component]=Math.min(D[g.component]||255,g.parsedLevel)})),R.includeUnsafe&&(A=!0)}else v.debug2("Disallowing %s->%s according to killswitch",m.ns,m.key);else v.debug4("Skipping %s->%s, targeted for %s",m.ns,m.key,R);else v.error("Failed to parse ECS config for %s->%s",m.ns,m.key)}}}))})).always((function(){for(var m in g.applyLogLevels(),S)v.debug2("Triggers updated, removing trigger %s",S[m].config().name),E.LogFactory.instance().removeAppender(+m);if(f.forEach((function(m){v.debug2("Triggers updated, adding trigger %s",m.name);var f=new R(g,g._triggered,m),S=E.LogFactory.instance().addAppender(f);g._triggers[String(S)]=f})),D[""]=D.root||_.LogLevel.Debug4,delete D.root,!g._circularBuffer||T&&!g._circularBuffer.needReset(A,C)?g._circularBuffer&&(Object.keys(S).length>0||f.length>0?(v.debug2("Buffer updated, reapplying log levels, removing log levels wrapper"),E.LogFactory.instance().removeAppender(g._circularBufferHandle),g._circularBufferHandle=null):v.debug2("Buffer updated, no change")):(v.debug2("Buffer updated, removing existing buffer"),E.LogFactory.instance().removeAppender(g._circularBufferHandle),g._circularBuffer=null,g._circularBufferHandle=null),T&&(g._circularBuffer||(v.debug2("Buffer updated, adding new buffer (storeUnsafe=%d,maxSize=%s)",A,C),g._circularBuffer=new w(A,C)),null==g._circularBufferHandle&&(v.debug2("Creating log level wrapper"),g._circularBufferHandle=E.LogFactory.instance().addAppender(I.wrapAppenderWithLogLevels(g._circularBuffer,D),_.AppenderFlags.InsertFront))),g._native){var P=map(D,(function(g,m){return{component:g,level:m}}));P.sort((function(g,m){return g.component.length-m.component.length})),g._native.log_config.setLogBufferConfig(T,{storeUnsafe:A,buffers:b},P);var M=[];for(var O in g._triggers){var N=g._triggers[O].config();M.push({name:N.name,ecsNs:N.ecsNs,conditions:N.conditions,resetCondition:N.resetCondition,includeUnsafe:N.includeUnsafe,reenableAfterTriggering:N.reenableAfterTriggering,filters:N.filters.map((function(g){return{component:g.component,level:g.parsedLevel}})),dumpFile:!1,metadata:{}})}g._native.log_config.setLogTriggerConfig(M,{})}}))}))},RootToolsManagerImpl.prototype._send=function(g,m){null!=this._glue&&(this._glue.sendTelemetry(A,{logTriggerName:g.name,logEcsNs:g.ecsNs,logdata:m}),v.debug4("LogSender::send, sent %d bytes",m.length))},RootToolsManagerImpl.prototype.triggered=function(g,m){},RootToolsManagerImpl.prototype.triggeredPartially=function(g,m,f,S,v){var C=this.findTriggerByNativeConfig(this._triggers,g);if(C){var _={level:m.level,component:E.LogFactory.instance().component(m.component),timestamp:m.timestamp};this._triggers[C].log(_,f,S,v)}},RootToolsManagerImpl.prototype.reset=function(g){var m=this.findTriggerByNativeConfig(this._triggers,g);m&&this._triggers[m].resetConditions()},RootToolsManagerImpl.prototype.dumpLogBuffer=function(g,m){if(this._circularBuffer){var f={matchedLines:0,totalLines:0},S=this._circularBuffer.dumpLogBuffer(g,this._maxUploadSize,f);if(v.debug4("dumpLogBuffer: dumped %d of %d lines, size of payload: %d",f.matchedLines,f.totalLines,null!=S?S.length:0),this._native){var C=T.Defer();return this._native.log_config.mergeAndDumpLogBuffer(S,g,m,(function(g){return C.resolve(g)})),C.promise()}return T.Resolved(S)}return v.warn("dumpLogBuffer: no log buffer enabled"),T.Rejected()},RootToolsManagerImpl.prototype._triggered=function(g){var m=this,f={compression:_.LogFileCompression.Compress,encoding:_.LogFileEncoding.Base64,encryption:_.LogFileEncryption.Encrypted,maxRotations:0,maxSize:this._maxUploadSize,reverse:!0},S={includeUnsafe:g.includeUnsafe,filter:g.filters.map((function(g){return{component:g.component,level:g.parsedLevel}})),reverse:!0};this.dumpLogBuffer(S,f).then((function(f){return m._send(g,f)}))},RootToolsManagerImpl.prototype.sendBRBEvent=function(g,m){try{if(v.debug2("sendBRBEvent %s",JSON.stringify(g)),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var f={eventType:"uploadBRB",mutualSubmissionType:"call",payload:g},S=void 0!==m?JSON.stringify({userIds:m}):"";this._glue.sendLoggingEventToNative(JSON.stringify(f),S)}}catch(g){v.error("sendBRBEvent %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.setBRBCallback=function(g){v.debug2("setBRBCallback"),null!=this._glue?"function"==typeof this._glue.setNativeLoggingEventCallback?this._BRBCallback=g:v.warn("setBRBCallback: RootToolsManagerDelegate missing setNativeLoggingEventCallback method"):v.warn("setBRBCallback: RootToolsManagerDelegate is not set")},RootToolsManagerImpl.prototype.registerListeners=function(){var g=this;null!=this._glue&&"function"==typeof this._glue.setNativeLoggingEventCallback?this._glue.setNativeLoggingEventCallback((function(m,f){return g.handleNativeLoggingEvent(m,f)})):v.warn("registerListeners: RootToolsManagerDelegate missing setNativeLoggingEventCallback method")},RootToolsManagerImpl.prototype.handleNativeLoggingEvent=function(g,m){try{v.debug2("Native Log event message: %s aux: %s",g,m);var f=JSON.parse(g);if(f.eventType&&"uploadBRB"===f.eventType){if("function"!=typeof this._BRBCallback)return void v.warn("BRBCallback not set, ignoring native event");v.debug4("Sending BRB callback: %@",f.payload),this._BRBCallback(f.payload)}else f.eventType&&"jsLogFileConfiguration"===f.eventType&&this.handleLogFileConfigEvent(f)}catch(g){v.error("handleNativeLoggingEvent %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.handleLogFileConfigEvent=function(g){if(g.payload){var m=g.payload;if(m.enabled){if(m.chunkSize&&m.flushInterval){var f={chunkSize:m.chunkSize,flushInterval:m.flushInterval,enableThrottling:m.enableThrottling,maxVerbosityLevel:m.maxVerbosityLevel};this.startJsToNativeLogging(f)}}else this.flushDisableJsToNativeLogging()}},RootToolsManagerImpl.prototype.logExternalForDDL=function(g,m){try{if(v.debug2("logExternalForDDL %s %s",g,m),null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative){var f={eventType:"logInSClog",payload:{message:g,parameters:m}};this._glue.sendLoggingEventToNative(JSON.stringify(f),"")}else v.warn("ignoring logExternalForDDL, delegate misconfigured")}catch(g){v.error("logExternalForDDL %s: %s",g.name,g.message)}},RootToolsManagerImpl.prototype.startJsToNativeLogging=function(g){var m=this,f=g.chunkSize,S=g.flushInterval,C=g.enableThrottling,_=this._getVerbosityLevelFromConfig(g.maxVerbosityLevel);if(this._jsToNativeBuffer){if(this._jsToNativeBuffer.capacity()===f&&this._jsToNativeFlushInterval===S&&this._jsToNativeBuffer.throttlingEnabled()===C&&this._jsToNativeBuffer.maxVerbosityLevel()===_)return void v.debug1("Same JS2Native settings received - doing nothing");v.debug1("Reapplying js to native settings"),this.flushDisableJsToNativeLogging()}this._jsToNativeBuffer=new D(f,(function(){m.onJsToNativeBufferReady(m._jsToNativeBuffer)}),C,_),this.setJsToNativeFlushTimeout(S),this._jsToNativeFlushInterval=S,this._jsToNativeBufferHandle=E.LogFactory.instance().addAppender(this._jsToNativeBuffer)},RootToolsManagerImpl.prototype._getVerbosityLevelFromConfig=function(g){return g?E.LogFactory.levelFromString(g):null},RootToolsManagerImpl.prototype.flushDisableJsToNativeLogging=function(){this._jsToNativeBuffer&&this.onJsToNativeBufferReady(this._jsToNativeBuffer),this.plainDisableJsToNativeLogging()},RootToolsManagerImpl.prototype.plainDisableJsToNativeLogging=function(){this.clearJsToNativeFlushTimeout(),this._jsToNativeBufferHandle&&(E.LogFactory.instance().removeAppender(this._jsToNativeBufferHandle),this._jsToNativeBufferHandle=0,this._jsToNativeBuffer=null,v.debug1("Disabling forwarding JS logs to native"))},RootToolsManagerImpl.prototype.onJsToNativeBufferReady=function(g){null!=this._glue&&"function"==typeof this._glue.sendLoggingEventToNative?(this.clearJsToNativeFlushTimeout(),this.dumpJsToNativeBuffer(g),this.setJsToNativeFlushTimeout(this._jsToNativeFlushInterval)):this.plainDisableJsToNativeLogging()},RootToolsManagerImpl.prototype.dumpJsToNativeBuffer=function(g){if(!g.empty()){var m=g.dumpAndReset(),f={eventType:"writeLogData"};this._glue.sendLoggingEventToNative(JSON.stringify(f),m)}},RootToolsManagerImpl.prototype.clearJsToNativeFlushTimeout=function(){this._jsToNativeFlushTimer&&(clearTimeout(this._jsToNativeFlushTimer),this._jsToNativeFlushTimer=null)},RootToolsManagerImpl.prototype.setJsToNativeFlushTimeout=function(g){var m=this;!this._jsToNativeFlushTimer&&g&&(this._jsToNativeFlushTimer=setTimeout((function(){m._jsToNativeFlushTimer=null,m.onJsToNativeBufferReady(m._jsToNativeBuffer)}),g))},RootToolsManagerImpl.prototype.stopAsyncOperations=function(){this.flushDisableJsToNativeLogging()},RootToolsManagerImpl}();m.RootToolsManager=new O})),A=createCommonjsModule((function(g,m){
/*!
 *  pii.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2017-01-16
 *  Copyright 2017 Microsoft. All rights reserved.
 *
 */
Object.defineProperty(m,"__esModule",{value:!0});var DefaultTagger=function(g){return g},f=!0,S=DefaultTagger,v={},C=0;function addName(g){return v[g]="u"+ ++C}var _,E=/^([0-9][0-9]?):([^<>\*\{\}&'\"\/\\?^`|~\s]+)$/;!function(g){g[g.MSA=1]="MSA",g[g.S4B_Bridge=2]="S4B_Bridge",g[g.PSTN=4]="PSTN",g[g.SkypeId=8]="SkypeId",g[g.Thread=19]="Thread",g[g.LegacyShortCircuit=20]="LegacyShortCircuit",g[g.OneToOneTextMessage=21]="OneToOneTextMessage",g[g.GroupTextMessage=22]="GroupTextMessage",g[g.Bot=28]="Bot",g[g.InternalSkype=48]="InternalSkype"}(_||(_={}));var T=[_.Thread,_.InternalSkype,_.Bot];function enableAnonymization(g){f=g}function useTagger(g){S=g||DefaultTagger}m.enableAnonymization=enableAnonymization,m.useTagger=useTagger,function(g){function untaggedUserName(g){return f?g?v[g]||addName(g):null:g}function UserName(g){var m=untaggedUserName(g);return S(m)}function Mri(g){var m,f=g.match(E);if(f){var v=Number(f[1]),C=f[2];m=-1!=T.indexOf(v)?g:v+":"+untaggedUserName(C)}else m=untaggedUserName(g);return S(m)}function Omit(g){var m;return m=f?"number"==typeof g?19229:"string"==typeof g?g.charAt(0)+"...":null:g,S(m)}g.UserName=UserName,g.Mri=Mri,g.Omit=Omit}(m.pii||(m.pii={}))})),P=createCommonjsModule((function(g,m){
/*!
 *  index.ts
 *  AUF
 *
 *  Created by Johan Blumenberg on 2016-12-29
 *  Copyright 2016 Microsoft. All rights reserved.
 *
 */
function __export(g){for(var f in g)m.hasOwnProperty(f)||(m[f]=g[f])}Object.defineProperty(m,"__esModule",{value:!0}),__export(_),__export(E),__export(b),__export(I),__export(A)})),R=createCommonjsModule((function(g,m){(function(){var f,S="4.17.21",v=200,_="Unsupported core-js use. Try https://npms.io/search?q=ponyfill.",E="Expected a function",T="Invalid `variable` option passed into `_.template`",I="__lodash_hash_undefined__",b=500,A="__lodash_placeholder__",P=1,R=2,w=4,M=1,D=2,O=1,N=2,k=4,L=8,F=16,x=32,U=64,V=128,B=256,H=512,$=30,G="...",j=800,W=16,q=1,z=2,K=3,J=1/0,Y=9007199254740991,Q=17976931348623157e292,X=NaN,Z=4294967295,ee=Z-1,te=Z>>>1,ie=[["ary",V],["bind",O],["bindKey",N],["curry",L],["curryRight",F],["flip",H],["partial",x],["partialRight",U],["rearg",B]],ne="[object Arguments]",re="[object Array]",se="[object AsyncFunction]",ae="[object Boolean]",oe="[object Date]",le="[object DOMException]",ce="[object Error]",de="[object Function]",he="[object GeneratorFunction]",ue="[object Map]",ge="[object Number]",pe="[object Null]",me="[object Object]",fe="[object Promise]",Se="[object Proxy]",ve="[object RegExp]",ye="[object Set]",Ce="[object String]",_e="[object Symbol]",Ee="[object Undefined]",Te="[object WeakMap]",Ie="[object WeakSet]",be="[object ArrayBuffer]",Ae="[object DataView]",Pe="[object Float32Array]",Re="[object Float64Array]",we="[object Int8Array]",Me="[object Int16Array]",De="[object Int32Array]",Oe="[object Uint8Array]",Ne="[object Uint8ClampedArray]",ke="[object Uint16Array]",Le="[object Uint32Array]",Fe=/\b__p \+= '';/g,xe=/\b(__p \+=) '' \+/g,Ue=/(__e\(.*?\)|\b__t\)) \+\n'';/g,Ve=/&(?:amp|lt|gt|quot|#39);/g,Be=/[&<>"']/g,He=RegExp(Ve.source),$e=RegExp(Be.source),Ge=/<%-([\s\S]+?)%>/g,je=/<%([\s\S]+?)%>/g,We=/<%=([\s\S]+?)%>/g,qe=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,ze=/^\w*$/,Ke=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,Je=/[\\^$.*+?()[\]{}|]/g,Ye=RegExp(Je.source),Qe=/^\s+/,Xe=/\s/,Ze=/\{(?:\n\/\* \[wrapped with .+\] \*\/)?\n?/,et=/\{\n\/\* \[wrapped with (.+)\] \*/,tt=/,? & /,it=/[^\x00-\x2f\x3a-\x40\x5b-\x60\x7b-\x7f]+/g,nt=/[()=,{}\[\]\/\s]/,rt=/\\(\\)?/g,st=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,at=/\w*$/,ot=/^[-+]0x[0-9a-f]+$/i,lt=/^0b[01]+$/i,ct=/^\[object .+?Constructor\]$/,dt=/^0o[0-7]+$/i,ht=/^(?:0|[1-9]\d*)$/,ut=/[\xc0-\xd6\xd8-\xf6\xf8-\xff\u0100-\u017f]/g,gt=/($^)/,pt=/['\n\r\u2028\u2029\\]/g,mt="\\ud800-\\udfff",ft="\\u0300-\\u036f"+"\\ufe20-\\ufe2f"+"\\u20d0-\\u20ff",St="\\u2700-\\u27bf",vt="a-z\\xdf-\\xf6\\xf8-\\xff",yt="A-Z\\xc0-\\xd6\\xd8-\\xde",Ct="\\ufe0e\\ufe0f",_t="\\xac\\xb1\\xd7\\xf7"+"\\x00-\\x2f\\x3a-\\x40\\x5b-\\x60\\x7b-\\xbf"+"\\u2000-\\u206f"+" \\t\\x0b\\f\\xa0\\ufeff\\n\\r\\u2028\\u2029\\u1680\\u180e\\u2000\\u2001\\u2002\\u2003\\u2004\\u2005\\u2006\\u2007\\u2008\\u2009\\u200a\\u202f\\u205f\\u3000",Et="['’]",Tt="["+mt+"]",It="["+_t+"]",bt="["+ft+"]",At="\\d+",Pt="["+St+"]",Rt="["+vt+"]",wt="[^"+mt+_t+At+St+vt+yt+"]",Mt="\\ud83c[\\udffb-\\udfff]",Dt="[^"+mt+"]",Ot="(?:\\ud83c[\\udde6-\\uddff]){2}",Nt="[\\ud800-\\udbff][\\udc00-\\udfff]",kt="["+yt+"]",Lt="\\u200d",Ft="(?:"+Rt+"|"+wt+")",xt="(?:"+kt+"|"+wt+")",Ut="(?:"+Et+"(?:d|ll|m|re|s|t|ve))?",Vt="(?:"+Et+"(?:D|LL|M|RE|S|T|VE))?",Bt="(?:"+bt+"|"+Mt+")"+"?",Ht="["+Ct+"]?",$t="\\d*(?:1st|2nd|3rd|(?![123])\\dth)(?=\\b|[A-Z_])",Gt="\\d*(?:1ST|2ND|3RD|(?![123])\\dTH)(?=\\b|[a-z_])",jt=Ht+Bt+("(?:"+Lt+"(?:"+[Dt,Ot,Nt].join("|")+")"+Ht+Bt+")*"),Wt="(?:"+[Pt,Ot,Nt].join("|")+")"+jt,qt="(?:"+[Dt+bt+"?",bt,Ot,Nt,Tt].join("|")+")",zt=RegExp(Et,"g"),Kt=RegExp(bt,"g"),Jt=RegExp(Mt+"(?="+Mt+")|"+qt+jt,"g"),Yt=RegExp([kt+"?"+Rt+"+"+Ut+"(?="+[It,kt,"$"].join("|")+")",xt+"+"+Vt+"(?="+[It,kt+Ft,"$"].join("|")+")",kt+"?"+Ft+"+"+Ut,kt+"+"+Vt,Gt,$t,At,Wt].join("|"),"g"),Qt=RegExp("["+Lt+mt+ft+Ct+"]"),Xt=/[a-z][A-Z]|[A-Z]{2}[a-z]|[0-9][a-zA-Z]|[a-zA-Z][0-9]|[^a-zA-Z0-9 ]/,Zt=["Array","Buffer","DataView","Date","Error","Float32Array","Float64Array","Function","Int8Array","Int16Array","Int32Array","Map","Math","Object","Promise","RegExp","Set","String","Symbol","TypeError","Uint8Array","Uint8ClampedArray","Uint16Array","Uint32Array","WeakMap","_","clearTimeout","isFinite","parseInt","setTimeout"],ei=-1,ti={};ti[Pe]=ti[Re]=ti[we]=ti[Me]=ti[De]=ti[Oe]=ti[Ne]=ti[ke]=ti[Le]=!0,ti[ne]=ti[re]=ti[be]=ti[ae]=ti[Ae]=ti[oe]=ti[ce]=ti[de]=ti[ue]=ti[ge]=ti[me]=ti[ve]=ti[ye]=ti[Ce]=ti[Te]=!1;var ii={};ii[ne]=ii[re]=ii[be]=ii[Ae]=ii[ae]=ii[oe]=ii[Pe]=ii[Re]=ii[we]=ii[Me]=ii[De]=ii[ue]=ii[ge]=ii[me]=ii[ve]=ii[ye]=ii[Ce]=ii[_e]=ii[Oe]=ii[Ne]=ii[ke]=ii[Le]=!0,ii[ce]=ii[de]=ii[Te]=!1;var ni={"À":"A","Á":"A","Â":"A","Ã":"A","Ä":"A","Å":"A","à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","Ç":"C","ç":"c","Ð":"D","ð":"d","È":"E","É":"E","Ê":"E","Ë":"E","è":"e","é":"e","ê":"e","ë":"e","Ì":"I","Í":"I","Î":"I","Ï":"I","ì":"i","í":"i","î":"i","ï":"i","Ñ":"N","ñ":"n","Ò":"O","Ó":"O","Ô":"O","Õ":"O","Ö":"O","Ø":"O","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ø":"o","Ù":"U","Ú":"U","Û":"U","Ü":"U","ù":"u","ú":"u","û":"u","ü":"u","Ý":"Y","ý":"y","ÿ":"y","Æ":"Ae","æ":"ae","Þ":"Th","þ":"th","ß":"ss","Ā":"A","Ă":"A","Ą":"A","ā":"a","ă":"a","ą":"a","Ć":"C","Ĉ":"C","Ċ":"C","Č":"C","ć":"c","ĉ":"c","ċ":"c","č":"c","Ď":"D","Đ":"D","ď":"d","đ":"d","Ē":"E","Ĕ":"E","Ė":"E","Ę":"E","Ě":"E","ē":"e","ĕ":"e","ė":"e","ę":"e","ě":"e","Ĝ":"G","Ğ":"G","Ġ":"G","Ģ":"G","ĝ":"g","ğ":"g","ġ":"g","ģ":"g","Ĥ":"H","Ħ":"H","ĥ":"h","ħ":"h","Ĩ":"I","Ī":"I","Ĭ":"I","Į":"I","İ":"I","ĩ":"i","ī":"i","ĭ":"i","į":"i","ı":"i","Ĵ":"J","ĵ":"j","Ķ":"K","ķ":"k","ĸ":"k","Ĺ":"L","Ļ":"L","Ľ":"L","Ŀ":"L","Ł":"L","ĺ":"l","ļ":"l","ľ":"l","ŀ":"l","ł":"l","Ń":"N","Ņ":"N","Ň":"N","Ŋ":"N","ń":"n","ņ":"n","ň":"n","ŋ":"n","Ō":"O","Ŏ":"O","Ő":"O","ō":"o","ŏ":"o","ő":"o","Ŕ":"R","Ŗ":"R","Ř":"R","ŕ":"r","ŗ":"r","ř":"r","Ś":"S","Ŝ":"S","Ş":"S","Š":"S","ś":"s","ŝ":"s","ş":"s","š":"s","Ţ":"T","Ť":"T","Ŧ":"T","ţ":"t","ť":"t","ŧ":"t","Ũ":"U","Ū":"U","Ŭ":"U","Ů":"U","Ű":"U","Ų":"U","ũ":"u","ū":"u","ŭ":"u","ů":"u","ű":"u","ų":"u","Ŵ":"W","ŵ":"w","Ŷ":"Y","ŷ":"y","Ÿ":"Y","Ź":"Z","Ż":"Z","Ž":"Z","ź":"z","ż":"z","ž":"z","Ĳ":"IJ","ĳ":"ij","Œ":"Oe","œ":"oe","ŉ":"'n","ſ":"s"},ri={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},si={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"},ai={"\\":"\\","'":"'","\n":"n","\r":"r","\u2028":"u2028","\u2029":"u2029"},oi=parseFloat,li=parseInt,ci="object"==typeof C&&C&&C.Object===Object&&C,di="object"==typeof self&&self&&self.Object===Object&&self,hi=ci||di||Function("return this")(),ui=m&&!m.nodeType&&m,gi=ui&&g&&!g.nodeType&&g,pi=gi&&gi.exports===ui,mi=pi&&ci.process,fi=function(){try{var g=gi&&gi.require&&gi.require("util").types;return g||mi&&mi.binding&&mi.binding("util")}catch(g){}}(),Si=fi&&fi.isArrayBuffer,vi=fi&&fi.isDate,yi=fi&&fi.isMap,Ci=fi&&fi.isRegExp,_i=fi&&fi.isSet,Ei=fi&&fi.isTypedArray;function apply(g,m,f){switch(f.length){case 0:return g.call(m);case 1:return g.call(m,f[0]);case 2:return g.call(m,f[0],f[1]);case 3:return g.call(m,f[0],f[1],f[2])}return g.apply(m,f)}function arrayAggregator(g,m,f,S){for(var v=-1,C=null==g?0:g.length;++v<C;){var _=g[v];m(S,_,f(_),g)}return S}function arrayEach(g,m){for(var f=-1,S=null==g?0:g.length;++f<S&&!1!==m(g[f],f,g););return g}function arrayEachRight(g,m){for(var f=null==g?0:g.length;f--&&!1!==m(g[f],f,g););return g}function arrayEvery(g,m){for(var f=-1,S=null==g?0:g.length;++f<S;)if(!m(g[f],f,g))return!1;return!0}function arrayFilter(g,m){for(var f=-1,S=null==g?0:g.length,v=0,C=[];++f<S;){var _=g[f];m(_,f,g)&&(C[v++]=_)}return C}function arrayIncludes(g,m){return!!(null==g?0:g.length)&&baseIndexOf(g,m,0)>-1}function arrayIncludesWith(g,m,f){for(var S=-1,v=null==g?0:g.length;++S<v;)if(f(m,g[S]))return!0;return!1}function arrayMap(g,m){for(var f=-1,S=null==g?0:g.length,v=Array(S);++f<S;)v[f]=m(g[f],f,g);return v}function arrayPush(g,m){for(var f=-1,S=m.length,v=g.length;++f<S;)g[v+f]=m[f];return g}function arrayReduce(g,m,f,S){var v=-1,C=null==g?0:g.length;for(S&&C&&(f=g[++v]);++v<C;)f=m(f,g[v],v,g);return f}function arrayReduceRight(g,m,f,S){var v=null==g?0:g.length;for(S&&v&&(f=g[--v]);v--;)f=m(f,g[v],v,g);return f}function arraySome(g,m){for(var f=-1,S=null==g?0:g.length;++f<S;)if(m(g[f],f,g))return!0;return!1}var Ti=baseProperty("length");function asciiToArray(g){return g.split("")}function asciiWords(g){return g.match(it)||[]}function baseFindKey(g,m,f){var S;return f(g,(function(g,f,v){if(m(g,f,v))return S=f,!1})),S}function baseFindIndex(g,m,f,S){for(var v=g.length,C=f+(S?1:-1);S?C--:++C<v;)if(m(g[C],C,g))return C;return-1}function baseIndexOf(g,m,f){return m==m?strictIndexOf(g,m,f):baseFindIndex(g,baseIsNaN,f)}function baseIndexOfWith(g,m,f,S){for(var v=f-1,C=g.length;++v<C;)if(S(g[v],m))return v;return-1}function baseIsNaN(g){return g!=g}function baseMean(g,m){var f=null==g?0:g.length;return f?baseSum(g,m)/f:X}function baseProperty(g){return function(m){return null==m?f:m[g]}}function basePropertyOf(g){return function(m){return null==g?f:g[m]}}function baseReduce(g,m,f,S,v){return v(g,(function(g,v,C){f=S?(S=!1,g):m(f,g,v,C)})),f}function baseSortBy(g,m){var f=g.length;for(g.sort(m);f--;)g[f]=g[f].value;return g}function baseSum(g,m){for(var S,v=-1,C=g.length;++v<C;){var _=m(g[v]);_!==f&&(S=S===f?_:S+_)}return S}function baseTimes(g,m){for(var f=-1,S=Array(g);++f<g;)S[f]=m(f);return S}function baseToPairs(g,m){return arrayMap(m,(function(m){return[m,g[m]]}))}function baseTrim(g){return g?g.slice(0,trimmedEndIndex(g)+1).replace(Qe,""):g}function baseUnary(g){return function(m){return g(m)}}function baseValues(g,m){return arrayMap(m,(function(m){return g[m]}))}function cacheHas(g,m){return g.has(m)}function charsStartIndex(g,m){for(var f=-1,S=g.length;++f<S&&baseIndexOf(m,g[f],0)>-1;);return f}function charsEndIndex(g,m){for(var f=g.length;f--&&baseIndexOf(m,g[f],0)>-1;);return f}function countHolders(g,m){for(var f=g.length,S=0;f--;)g[f]===m&&++S;return S}var Ii=basePropertyOf(ni),bi=basePropertyOf(ri);function escapeStringChar(g){return"\\"+ai[g]}function getValue(g,m){return null==g?f:g[m]}function hasUnicode(g){return Qt.test(g)}function hasUnicodeWord(g){return Xt.test(g)}function iteratorToArray(g){for(var m,f=[];!(m=g.next()).done;)f.push(m.value);return f}function mapToArray(g){var m=-1,f=Array(g.size);return g.forEach((function(g,S){f[++m]=[S,g]})),f}function overArg(g,m){return function(f){return g(m(f))}}function replaceHolders(g,m){for(var f=-1,S=g.length,v=0,C=[];++f<S;){var _=g[f];_!==m&&_!==A||(g[f]=A,C[v++]=f)}return C}function setToArray(g){var m=-1,f=Array(g.size);return g.forEach((function(g){f[++m]=g})),f}function setToPairs(g){var m=-1,f=Array(g.size);return g.forEach((function(g){f[++m]=[g,g]})),f}function strictIndexOf(g,m,f){for(var S=f-1,v=g.length;++S<v;)if(g[S]===m)return S;return-1}function strictLastIndexOf(g,m,f){for(var S=f+1;S--;)if(g[S]===m)return S;return S}function stringSize(g){return hasUnicode(g)?unicodeSize(g):Ti(g)}function stringToArray(g){return hasUnicode(g)?unicodeToArray(g):asciiToArray(g)}function trimmedEndIndex(g){for(var m=g.length;m--&&Xe.test(g.charAt(m)););return m}var Ai=basePropertyOf(si);function unicodeSize(g){for(var m=Jt.lastIndex=0;Jt.test(g);)++m;return m}function unicodeToArray(g){return g.match(Jt)||[]}function unicodeWords(g){return g.match(Yt)||[]}var Pi=function runInContext(g){var m,C=(g=null==g?hi:Ri.defaults(hi.Object(),g,Ri.pick(hi,Zt))).Array,Xe=g.Date,it=g.Error,mt=g.Function,ft=g.Math,St=g.Object,vt=g.RegExp,yt=g.String,Ct=g.TypeError,_t=C.prototype,Et=mt.prototype,Tt=St.prototype,It=g["__core-js_shared__"],bt=Et.toString,At=Tt.hasOwnProperty,Pt=0,Rt=(m=/[^.]+$/.exec(It&&It.keys&&It.keys.IE_PROTO||""))?"Symbol(src)_1."+m:"",wt=Tt.toString,Mt=bt.call(St),Dt=hi._,Ot=vt("^"+bt.call(At).replace(Je,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),Nt=pi?g.Buffer:f,kt=g.Symbol,Lt=g.Uint8Array,Ft=Nt?Nt.allocUnsafe:f,xt=overArg(St.getPrototypeOf,St),Ut=St.create,Vt=Tt.propertyIsEnumerable,Bt=_t.splice,Ht=kt?kt.isConcatSpreadable:f,$t=kt?kt.iterator:f,Gt=kt?kt.toStringTag:f,jt=function(){try{var g=getNative(St,"defineProperty");return g({},"",{}),g}catch(g){}}(),Wt=g.clearTimeout!==hi.clearTimeout&&g.clearTimeout,qt=Xe&&Xe.now!==hi.Date.now&&Xe.now,Jt=g.setTimeout!==hi.setTimeout&&g.setTimeout,Yt=ft.ceil,Qt=ft.floor,Xt=St.getOwnPropertySymbols,ni=Nt?Nt.isBuffer:f,ri=g.isFinite,si=_t.join,ai=overArg(St.keys,St),ci=ft.max,di=ft.min,ui=Xe.now,gi=g.parseInt,mi=ft.random,fi=_t.reverse,Ti=getNative(g,"DataView"),Pi=getNative(g,"Map"),wi=getNative(g,"Promise"),Mi=getNative(g,"Set"),Di=getNative(g,"WeakMap"),Oi=getNative(St,"create"),Ni=Di&&new Di,ki={},Li=toSource(Ti),Fi=toSource(Pi),xi=toSource(wi),Ui=toSource(Mi),Vi=toSource(Di),Bi=kt?kt.prototype:f,Hi=Bi?Bi.valueOf:f,$i=Bi?Bi.toString:f;function lodash(g){if(isObjectLike(g)&&!zn(g)&&!(g instanceof LazyWrapper)){if(g instanceof LodashWrapper)return g;if(At.call(g,"__wrapped__"))return wrapperClone(g)}return new LodashWrapper(g)}var Gi=function(){function object(){}return function(g){if(!isObject(g))return{};if(Ut)return Ut(g);object.prototype=g;var m=new object;return object.prototype=f,m}}();function baseLodash(){}function LodashWrapper(g,m){this.__wrapped__=g,this.__actions__=[],this.__chain__=!!m,this.__index__=0,this.__values__=f}function LazyWrapper(g){this.__wrapped__=g,this.__actions__=[],this.__dir__=1,this.__filtered__=!1,this.__iteratees__=[],this.__takeCount__=Z,this.__views__=[]}function lazyClone(){var g=new LazyWrapper(this.__wrapped__);return g.__actions__=copyArray(this.__actions__),g.__dir__=this.__dir__,g.__filtered__=this.__filtered__,g.__iteratees__=copyArray(this.__iteratees__),g.__takeCount__=this.__takeCount__,g.__views__=copyArray(this.__views__),g}function lazyReverse(){if(this.__filtered__){var g=new LazyWrapper(this);g.__dir__=-1,g.__filtered__=!0}else(g=this.clone()).__dir__*=-1;return g}function lazyValue(){var g=this.__wrapped__.value(),m=this.__dir__,f=zn(g),S=m<0,v=f?g.length:0,C=getView(0,v,this.__views__),_=C.start,E=C.end,T=E-_,I=S?E:_-1,b=this.__iteratees__,A=b.length,P=0,R=di(T,this.__takeCount__);if(!f||!S&&v==T&&R==T)return baseWrapperValue(g,this.__actions__);var w=[];e:for(;T--&&P<R;){for(var M=-1,D=g[I+=m];++M<A;){var O=b[M],N=O.iteratee,k=O.type,L=N(D);if(k==z)D=L;else if(!L){if(k==q)continue e;break e}}w[P++]=D}return w}function Hash(g){var m=-1,f=null==g?0:g.length;for(this.clear();++m<f;){var S=g[m];this.set(S[0],S[1])}}function hashClear(){this.__data__=Oi?Oi(null):{},this.size=0}function hashDelete(g){var m=this.has(g)&&delete this.__data__[g];return this.size-=m?1:0,m}function hashGet(g){var m=this.__data__;if(Oi){var S=m[g];return S===I?f:S}return At.call(m,g)?m[g]:f}function hashHas(g){var m=this.__data__;return Oi?m[g]!==f:At.call(m,g)}function hashSet(g,m){var S=this.__data__;return this.size+=this.has(g)?0:1,S[g]=Oi&&m===f?I:m,this}function ListCache(g){var m=-1,f=null==g?0:g.length;for(this.clear();++m<f;){var S=g[m];this.set(S[0],S[1])}}function listCacheClear(){this.__data__=[],this.size=0}function listCacheDelete(g){var m=this.__data__,f=assocIndexOf(m,g);return!(f<0)&&(f==m.length-1?m.pop():Bt.call(m,f,1),--this.size,!0)}function listCacheGet(g){var m=this.__data__,S=assocIndexOf(m,g);return S<0?f:m[S][1]}function listCacheHas(g){return assocIndexOf(this.__data__,g)>-1}function listCacheSet(g,m){var f=this.__data__,S=assocIndexOf(f,g);return S<0?(++this.size,f.push([g,m])):f[S][1]=m,this}function MapCache(g){var m=-1,f=null==g?0:g.length;for(this.clear();++m<f;){var S=g[m];this.set(S[0],S[1])}}function mapCacheClear(){this.size=0,this.__data__={hash:new Hash,map:new(Pi||ListCache),string:new Hash}}function mapCacheDelete(g){var m=getMapData(this,g).delete(g);return this.size-=m?1:0,m}function mapCacheGet(g){return getMapData(this,g).get(g)}function mapCacheHas(g){return getMapData(this,g).has(g)}function mapCacheSet(g,m){var f=getMapData(this,g),S=f.size;return f.set(g,m),this.size+=f.size==S?0:1,this}function SetCache(g){var m=-1,f=null==g?0:g.length;for(this.__data__=new MapCache;++m<f;)this.add(g[m])}function setCacheAdd(g){return this.__data__.set(g,I),this}function setCacheHas(g){return this.__data__.has(g)}function Stack(g){var m=this.__data__=new ListCache(g);this.size=m.size}function stackClear(){this.__data__=new ListCache,this.size=0}function stackDelete(g){var m=this.__data__,f=m.delete(g);return this.size=m.size,f}function stackGet(g){return this.__data__.get(g)}function stackHas(g){return this.__data__.has(g)}function stackSet(g,m){var f=this.__data__;if(f instanceof ListCache){var S=f.__data__;if(!Pi||S.length<v-1)return S.push([g,m]),this.size=++f.size,this;f=this.__data__=new MapCache(S)}return f.set(g,m),this.size=f.size,this}function arrayLikeKeys(g,m){var f=zn(g),S=!f&&qn(g),v=!f&&!S&&Jn(g),C=!f&&!S&&!v&&er(g),_=f||S||v||C,E=_?baseTimes(g.length,yt):[],T=E.length;for(var I in g)!m&&!At.call(g,I)||_&&("length"==I||v&&("offset"==I||"parent"==I)||C&&("buffer"==I||"byteLength"==I||"byteOffset"==I)||isIndex(I,T))||E.push(I);return E}function arraySample(g){var m=g.length;return m?g[baseRandom(0,m-1)]:f}function arraySampleSize(g,m){return shuffleSelf(copyArray(g),baseClamp(m,0,g.length))}function arrayShuffle(g){return shuffleSelf(copyArray(g))}function assignMergeValue(g,m,S){(S!==f&&!eq(g[m],S)||S===f&&!(m in g))&&baseAssignValue(g,m,S)}function assignValue(g,m,S){var v=g[m];At.call(g,m)&&eq(v,S)&&(S!==f||m in g)||baseAssignValue(g,m,S)}function assocIndexOf(g,m){for(var f=g.length;f--;)if(eq(g[f][0],m))return f;return-1}function baseAggregator(g,m,f,S){return ji(g,(function(g,v,C){m(S,g,f(g),C)})),S}function baseAssign(g,m){return g&&copyObject(m,keys(m),g)}function baseAssignIn(g,m){return g&&copyObject(m,keysIn(m),g)}function baseAssignValue(g,m,f){"__proto__"==m&&jt?jt(g,m,{configurable:!0,enumerable:!0,value:f,writable:!0}):g[m]=f}function baseAt(g,m){for(var S=-1,v=m.length,_=C(v),E=null==g;++S<v;)_[S]=E?f:get(g,m[S]);return _}function baseClamp(g,m,S){return g==g&&(S!==f&&(g=g<=S?g:S),m!==f&&(g=g>=m?g:m)),g}function baseClone(g,m,S,v,C,_){var E,T=m&P,I=m&R,b=m&w;if(S&&(E=C?S(g,v,C,_):S(g)),E!==f)return E;if(!isObject(g))return g;var A=zn(g);if(A){if(E=initCloneArray(g),!T)return copyArray(g,E)}else{var M=nn(g),D=M==de||M==he;if(Jn(g))return cloneBuffer(g,T);if(M==me||M==ne||D&&!C){if(E=I||D?{}:initCloneObject(g),!T)return I?copySymbolsIn(g,baseAssignIn(E,g)):copySymbols(g,baseAssign(E,g))}else{if(!ii[M])return C?g:{};E=initCloneByTag(g,M,T)}}_||(_=new Stack);var O=_.get(g);if(O)return O;_.set(g,E),Zn(g)?g.forEach((function(f){E.add(baseClone(f,m,S,f,g,_))})):Qn(g)&&g.forEach((function(f,v){E.set(v,baseClone(f,m,S,v,g,_))}));var N=A?f:(b?I?getAllKeysIn:getAllKeys:I?keysIn:keys)(g);return arrayEach(N||g,(function(f,v){N&&(f=g[v=f]),assignValue(E,v,baseClone(f,m,S,v,g,_))})),E}function baseConforms(g){var m=keys(g);return function(f){return baseConformsTo(f,g,m)}}function baseConformsTo(g,m,S){var v=S.length;if(null==g)return!v;for(g=St(g);v--;){var C=S[v],_=m[C],E=g[C];if(E===f&&!(C in g)||!_(E))return!1}return!0}function baseDelay(g,m,S){if("function"!=typeof g)throw new Ct(E);return an((function(){g.apply(f,S)}),m)}function baseDifference(g,m,f,S){var C=-1,_=arrayIncludes,E=!0,T=g.length,I=[],b=m.length;if(!T)return I;f&&(m=arrayMap(m,baseUnary(f))),S?(_=arrayIncludesWith,E=!1):m.length>=v&&(_=cacheHas,E=!1,m=new SetCache(m));e:for(;++C<T;){var A=g[C],P=null==f?A:f(A);if(A=S||0!==A?A:0,E&&P==P){for(var R=b;R--;)if(m[R]===P)continue e;I.push(A)}else _(m,P,S)||I.push(A)}return I}lodash.templateSettings={escape:Ge,evaluate:je,interpolate:We,variable:"",imports:{_:lodash}},lodash.prototype=baseLodash.prototype,lodash.prototype.constructor=lodash,LodashWrapper.prototype=Gi(baseLodash.prototype),LodashWrapper.prototype.constructor=LodashWrapper,LazyWrapper.prototype=Gi(baseLodash.prototype),LazyWrapper.prototype.constructor=LazyWrapper,Hash.prototype.clear=hashClear,Hash.prototype.delete=hashDelete,Hash.prototype.get=hashGet,Hash.prototype.has=hashHas,Hash.prototype.set=hashSet,ListCache.prototype.clear=listCacheClear,ListCache.prototype.delete=listCacheDelete,ListCache.prototype.get=listCacheGet,ListCache.prototype.has=listCacheHas,ListCache.prototype.set=listCacheSet,MapCache.prototype.clear=mapCacheClear,MapCache.prototype.delete=mapCacheDelete,MapCache.prototype.get=mapCacheGet,MapCache.prototype.has=mapCacheHas,MapCache.prototype.set=mapCacheSet,SetCache.prototype.add=SetCache.prototype.push=setCacheAdd,SetCache.prototype.has=setCacheHas,Stack.prototype.clear=stackClear,Stack.prototype.delete=stackDelete,Stack.prototype.get=stackGet,Stack.prototype.has=stackHas,Stack.prototype.set=stackSet;var ji=createBaseEach(baseForOwn),Wi=createBaseEach(baseForOwnRight,!0);function baseEvery(g,m){var f=!0;return ji(g,(function(g,S,v){return f=!!m(g,S,v)})),f}function baseExtremum(g,m,S){for(var v=-1,C=g.length;++v<C;){var _=g[v],E=m(_);if(null!=E&&(T===f?E==E&&!isSymbol(E):S(E,T)))var T=E,I=_}return I}function baseFill(g,m,S,v){var C=g.length;for((S=toInteger(S))<0&&(S=-S>C?0:C+S),(v=v===f||v>C?C:toInteger(v))<0&&(v+=C),v=S>v?0:toLength(v);S<v;)g[S++]=m;return g}function baseFilter(g,m){var f=[];return ji(g,(function(g,S,v){m(g,S,v)&&f.push(g)})),f}function baseFlatten(g,m,f,S,v){var C=-1,_=g.length;for(f||(f=isFlattenable),v||(v=[]);++C<_;){var E=g[C];m>0&&f(E)?m>1?baseFlatten(E,m-1,f,S,v):arrayPush(v,E):S||(v[v.length]=E)}return v}var qi=createBaseFor(),zi=createBaseFor(!0);function baseForOwn(g,m){return g&&qi(g,m,keys)}function baseForOwnRight(g,m){return g&&zi(g,m,keys)}function baseFunctions(g,m){return arrayFilter(m,(function(m){return isFunction(g[m])}))}function baseGet(g,m){for(var S=0,v=(m=castPath(m,g)).length;null!=g&&S<v;)g=g[toKey(m[S++])];return S&&S==v?g:f}function baseGetAllKeys(g,m,f){var S=m(g);return zn(g)?S:arrayPush(S,f(g))}function baseGetTag(g){return null==g?g===f?Ee:pe:Gt&&Gt in St(g)?getRawTag(g):objectToString(g)}function baseGt(g,m){return g>m}function baseHas(g,m){return null!=g&&At.call(g,m)}function baseHasIn(g,m){return null!=g&&m in St(g)}function baseInRange(g,m,f){return g>=di(m,f)&&g<ci(m,f)}function baseIntersection(g,m,S){for(var v=S?arrayIncludesWith:arrayIncludes,_=g[0].length,E=g.length,T=E,I=C(E),b=1/0,A=[];T--;){var P=g[T];T&&m&&(P=arrayMap(P,baseUnary(m))),b=di(P.length,b),I[T]=!S&&(m||_>=120&&P.length>=120)?new SetCache(T&&P):f}P=g[0];var R=-1,w=I[0];e:for(;++R<_&&A.length<b;){var M=P[R],D=m?m(M):M;if(M=S||0!==M?M:0,!(w?cacheHas(w,D):v(A,D,S))){for(T=E;--T;){var O=I[T];if(!(O?cacheHas(O,D):v(g[T],D,S)))continue e}w&&w.push(D),A.push(M)}}return A}function baseInverter(g,m,f,S){return baseForOwn(g,(function(g,v,C){m(S,f(g),v,C)})),S}function baseInvoke(g,m,S){var v=null==(g=parent(g,m=castPath(m,g)))?g:g[toKey(last(m))];return null==v?f:apply(v,g,S)}function baseIsArguments(g){return isObjectLike(g)&&baseGetTag(g)==ne}function baseIsArrayBuffer(g){return isObjectLike(g)&&baseGetTag(g)==be}function baseIsDate(g){return isObjectLike(g)&&baseGetTag(g)==oe}function baseIsEqual(g,m,f,S,v){return g===m||(null==g||null==m||!isObjectLike(g)&&!isObjectLike(m)?g!=g&&m!=m:baseIsEqualDeep(g,m,f,S,baseIsEqual,v))}function baseIsEqualDeep(g,m,f,S,v,C){var _=zn(g),E=zn(m),T=_?re:nn(g),I=E?re:nn(m),b=(T=T==ne?me:T)==me,A=(I=I==ne?me:I)==me,P=T==I;if(P&&Jn(g)){if(!Jn(m))return!1;_=!0,b=!1}if(P&&!b)return C||(C=new Stack),_||er(g)?equalArrays(g,m,f,S,v,C):equalByTag(g,m,T,f,S,v,C);if(!(f&M)){var R=b&&At.call(g,"__wrapped__"),w=A&&At.call(m,"__wrapped__");if(R||w){var D=R?g.value():g,O=w?m.value():m;return C||(C=new Stack),v(D,O,f,S,C)}}return!!P&&(C||(C=new Stack),equalObjects(g,m,f,S,v,C))}function baseIsMap(g){return isObjectLike(g)&&nn(g)==ue}function baseIsMatch(g,m,S,v){var C=S.length,_=C,E=!v;if(null==g)return!_;for(g=St(g);C--;){var T=S[C];if(E&&T[2]?T[1]!==g[T[0]]:!(T[0]in g))return!1}for(;++C<_;){var I=(T=S[C])[0],b=g[I],A=T[1];if(E&&T[2]){if(b===f&&!(I in g))return!1}else{var P=new Stack;if(v)var R=v(b,A,I,g,m,P);if(!(R===f?baseIsEqual(A,b,M|D,v,P):R))return!1}}return!0}function baseIsNative(g){return!(!isObject(g)||isMasked(g))&&(isFunction(g)?Ot:ct).test(toSource(g))}function baseIsRegExp(g){return isObjectLike(g)&&baseGetTag(g)==ve}function baseIsSet(g){return isObjectLike(g)&&nn(g)==ye}function baseIsTypedArray(g){return isObjectLike(g)&&isLength(g.length)&&!!ti[baseGetTag(g)]}function baseIteratee(g){return"function"==typeof g?g:null==g?identity:"object"==typeof g?zn(g)?baseMatchesProperty(g[0],g[1]):baseMatches(g):property(g)}function baseKeys(g){if(!isPrototype(g))return ai(g);var m=[];for(var f in St(g))At.call(g,f)&&"constructor"!=f&&m.push(f);return m}function baseKeysIn(g){if(!isObject(g))return nativeKeysIn(g);var m=isPrototype(g),f=[];for(var S in g)("constructor"!=S||!m&&At.call(g,S))&&f.push(S);return f}function baseLt(g,m){return g<m}function baseMap(g,m){var f=-1,S=isArrayLike(g)?C(g.length):[];return ji(g,(function(g,v,C){S[++f]=m(g,v,C)})),S}function baseMatches(g){var m=getMatchData(g);return 1==m.length&&m[0][2]?matchesStrictComparable(m[0][0],m[0][1]):function(f){return f===g||baseIsMatch(f,g,m)}}function baseMatchesProperty(g,m){return isKey(g)&&isStrictComparable(m)?matchesStrictComparable(toKey(g),m):function(S){var v=get(S,g);return v===f&&v===m?hasIn(S,g):baseIsEqual(m,v,M|D)}}function baseMerge(g,m,S,v,C){g!==m&&qi(m,(function(_,E){if(C||(C=new Stack),isObject(_))baseMergeDeep(g,m,E,S,baseMerge,v,C);else{var T=v?v(safeGet(g,E),_,E+"",g,m,C):f;T===f&&(T=_),assignMergeValue(g,E,T)}}),keysIn)}function baseMergeDeep(g,m,S,v,C,_,E){var T=safeGet(g,S),I=safeGet(m,S),b=E.get(I);if(b)assignMergeValue(g,S,b);else{var A=_?_(T,I,S+"",g,m,E):f,P=A===f;if(P){var R=zn(I),w=!R&&Jn(I),M=!R&&!w&&er(I);A=I,R||w||M?zn(T)?A=T:isArrayLikeObject(T)?A=copyArray(T):w?(P=!1,A=cloneBuffer(I,!0)):M?(P=!1,A=cloneTypedArray(I,!0)):A=[]:isPlainObject(I)||qn(I)?(A=T,qn(T)?A=toPlainObject(T):isObject(T)&&!isFunction(T)||(A=initCloneObject(I))):P=!1}P&&(E.set(I,A),C(A,I,v,_,E),E.delete(I)),assignMergeValue(g,S,A)}}function baseNth(g,m){var S=g.length;if(S)return isIndex(m+=m<0?S:0,S)?g[m]:f}function baseOrderBy(g,m,f){m=m.length?arrayMap(m,(function(g){return zn(g)?function(m){return baseGet(m,1===g.length?g[0]:g)}:g})):[identity];var S=-1;m=arrayMap(m,baseUnary(getIteratee()));var v=baseMap(g,(function(g,f,v){var C=arrayMap(m,(function(m){return m(g)}));return{criteria:C,index:++S,value:g}}));return baseSortBy(v,(function(g,m){return compareMultiple(g,m,f)}))}function basePick(g,m){return basePickBy(g,m,(function(m,f){return hasIn(g,f)}))}function basePickBy(g,m,f){for(var S=-1,v=m.length,C={};++S<v;){var _=m[S],E=baseGet(g,_);f(E,_)&&baseSet(C,castPath(_,g),E)}return C}function basePropertyDeep(g){return function(m){return baseGet(m,g)}}function basePullAll(g,m,f,S){var v=S?baseIndexOfWith:baseIndexOf,C=-1,_=m.length,E=g;for(g===m&&(m=copyArray(m)),f&&(E=arrayMap(g,baseUnary(f)));++C<_;)for(var T=0,I=m[C],b=f?f(I):I;(T=v(E,b,T,S))>-1;)E!==g&&Bt.call(E,T,1),Bt.call(g,T,1);return g}function basePullAt(g,m){for(var f=g?m.length:0,S=f-1;f--;){var v=m[f];if(f==S||v!==C){var C=v;isIndex(v)?Bt.call(g,v,1):baseUnset(g,v)}}return g}function baseRandom(g,m){return g+Qt(mi()*(m-g+1))}function baseRange(g,m,f,S){for(var v=-1,_=ci(Yt((m-g)/(f||1)),0),E=C(_);_--;)E[S?_:++v]=g,g+=f;return E}function baseRepeat(g,m){var f="";if(!g||m<1||m>Y)return f;do{m%2&&(f+=g),(m=Qt(m/2))&&(g+=g)}while(m);return f}function baseRest(g,m){return on(overRest(g,m,identity),g+"")}function baseSample(g){return arraySample(values(g))}function baseSampleSize(g,m){var f=values(g);return shuffleSelf(f,baseClamp(m,0,f.length))}function baseSet(g,m,S,v){if(!isObject(g))return g;for(var C=-1,_=(m=castPath(m,g)).length,E=_-1,T=g;null!=T&&++C<_;){var I=toKey(m[C]),b=S;if("__proto__"===I||"constructor"===I||"prototype"===I)return g;if(C!=E){var A=T[I];(b=v?v(A,I,T):f)===f&&(b=isObject(A)?A:isIndex(m[C+1])?[]:{})}assignValue(T,I,b),T=T[I]}return g}var Ki=Ni?function(g,m){return Ni.set(g,m),g}:identity,Ji=jt?function(g,m){return jt(g,"toString",{configurable:!0,enumerable:!1,value:constant(m),writable:!0})}:identity;function baseShuffle(g){return shuffleSelf(values(g))}function baseSlice(g,m,f){var S=-1,v=g.length;m<0&&(m=-m>v?0:v+m),(f=f>v?v:f)<0&&(f+=v),v=m>f?0:f-m>>>0,m>>>=0;for(var _=C(v);++S<v;)_[S]=g[S+m];return _}function baseSome(g,m){var f;return ji(g,(function(g,S,v){return!(f=m(g,S,v))})),!!f}function baseSortedIndex(g,m,f){var S=0,v=null==g?S:g.length;if("number"==typeof m&&m==m&&v<=te){for(;S<v;){var C=S+v>>>1,_=g[C];null!==_&&!isSymbol(_)&&(f?_<=m:_<m)?S=C+1:v=C}return v}return baseSortedIndexBy(g,m,identity,f)}function baseSortedIndexBy(g,m,S,v){var C=0,_=null==g?0:g.length;if(0===_)return 0;for(var E=(m=S(m))!=m,T=null===m,I=isSymbol(m),b=m===f;C<_;){var A=Qt((C+_)/2),P=S(g[A]),R=P!==f,w=null===P,M=P==P,D=isSymbol(P);if(E)var O=v||M;else O=b?M&&(v||R):T?M&&R&&(v||!w):I?M&&R&&!w&&(v||!D):!w&&!D&&(v?P<=m:P<m);O?C=A+1:_=A}return di(_,ee)}function baseSortedUniq(g,m){for(var f=-1,S=g.length,v=0,C=[];++f<S;){var _=g[f],E=m?m(_):_;if(!f||!eq(E,T)){var T=E;C[v++]=0===_?0:_}}return C}function baseToNumber(g){return"number"==typeof g?g:isSymbol(g)?X:+g}function baseToString(g){if("string"==typeof g)return g;if(zn(g))return arrayMap(g,baseToString)+"";if(isSymbol(g))return $i?$i.call(g):"";var m=g+"";return"0"==m&&1/g==-J?"-0":m}function baseUniq(g,m,f){var S=-1,C=arrayIncludes,_=g.length,E=!0,T=[],I=T;if(f)E=!1,C=arrayIncludesWith;else if(_>=v){var b=m?null:Xi(g);if(b)return setToArray(b);E=!1,C=cacheHas,I=new SetCache}else I=m?[]:T;e:for(;++S<_;){var A=g[S],P=m?m(A):A;if(A=f||0!==A?A:0,E&&P==P){for(var R=I.length;R--;)if(I[R]===P)continue e;m&&I.push(P),T.push(A)}else C(I,P,f)||(I!==T&&I.push(P),T.push(A))}return T}function baseUnset(g,m){return null==(g=parent(g,m=castPath(m,g)))||delete g[toKey(last(m))]}function baseUpdate(g,m,f,S){return baseSet(g,m,f(baseGet(g,m)),S)}function baseWhile(g,m,f,S){for(var v=g.length,C=S?v:-1;(S?C--:++C<v)&&m(g[C],C,g););return f?baseSlice(g,S?0:C,S?C+1:v):baseSlice(g,S?C+1:0,S?v:C)}function baseWrapperValue(g,m){var f=g;return f instanceof LazyWrapper&&(f=f.value()),arrayReduce(m,(function(g,m){return m.func.apply(m.thisArg,arrayPush([g],m.args))}),f)}function baseXor(g,m,f){var S=g.length;if(S<2)return S?baseUniq(g[0]):[];for(var v=-1,_=C(S);++v<S;)for(var E=g[v],T=-1;++T<S;)T!=v&&(_[v]=baseDifference(_[v]||E,g[T],m,f));return baseUniq(baseFlatten(_,1),m,f)}function baseZipObject(g,m,S){for(var v=-1,C=g.length,_=m.length,E={};++v<C;){var T=v<_?m[v]:f;S(E,g[v],T)}return E}function castArrayLikeObject(g){return isArrayLikeObject(g)?g:[]}function castFunction(g){return"function"==typeof g?g:identity}function castPath(g,m){return zn(g)?g:isKey(g,m)?[g]:ln(toString(g))}var Yi=baseRest;function castSlice(g,m,S){var v=g.length;return S=S===f?v:S,!m&&S>=v?g:baseSlice(g,m,S)}var Qi=Wt||function(g){return hi.clearTimeout(g)};function cloneBuffer(g,m){if(m)return g.slice();var f=g.length,S=Ft?Ft(f):new g.constructor(f);return g.copy(S),S}function cloneArrayBuffer(g){var m=new g.constructor(g.byteLength);return new Lt(m).set(new Lt(g)),m}function cloneDataView(g,m){var f=m?cloneArrayBuffer(g.buffer):g.buffer;return new g.constructor(f,g.byteOffset,g.byteLength)}function cloneRegExp(g){var m=new g.constructor(g.source,at.exec(g));return m.lastIndex=g.lastIndex,m}function cloneSymbol(g){return Hi?St(Hi.call(g)):{}}function cloneTypedArray(g,m){var f=m?cloneArrayBuffer(g.buffer):g.buffer;return new g.constructor(f,g.byteOffset,g.length)}function compareAscending(g,m){if(g!==m){var S=g!==f,v=null===g,C=g==g,_=isSymbol(g),E=m!==f,T=null===m,I=m==m,b=isSymbol(m);if(!T&&!b&&!_&&g>m||_&&E&&I&&!T&&!b||v&&E&&I||!S&&I||!C)return 1;if(!v&&!_&&!b&&g<m||b&&S&&C&&!v&&!_||T&&S&&C||!E&&C||!I)return-1}return 0}function compareMultiple(g,m,f){for(var S=-1,v=g.criteria,C=m.criteria,_=v.length,E=f.length;++S<_;){var T=compareAscending(v[S],C[S]);if(T)return S>=E?T:T*("desc"==f[S]?-1:1)}return g.index-m.index}function composeArgs(g,m,f,S){for(var v=-1,_=g.length,E=f.length,T=-1,I=m.length,b=ci(_-E,0),A=C(I+b),P=!S;++T<I;)A[T]=m[T];for(;++v<E;)(P||v<_)&&(A[f[v]]=g[v]);for(;b--;)A[T++]=g[v++];return A}function composeArgsRight(g,m,f,S){for(var v=-1,_=g.length,E=-1,T=f.length,I=-1,b=m.length,A=ci(_-T,0),P=C(A+b),R=!S;++v<A;)P[v]=g[v];for(var w=v;++I<b;)P[w+I]=m[I];for(;++E<T;)(R||v<_)&&(P[w+f[E]]=g[v++]);return P}function copyArray(g,m){var f=-1,S=g.length;for(m||(m=C(S));++f<S;)m[f]=g[f];return m}function copyObject(g,m,S,v){var C=!S;S||(S={});for(var _=-1,E=m.length;++_<E;){var T=m[_],I=v?v(S[T],g[T],T,S,g):f;I===f&&(I=g[T]),C?baseAssignValue(S,T,I):assignValue(S,T,I)}return S}function copySymbols(g,m){return copyObject(g,en(g),m)}function copySymbolsIn(g,m){return copyObject(g,tn(g),m)}function createAggregator(g,m){return function(f,S){var v=zn(f)?arrayAggregator:baseAggregator,C=m?m():{};return v(f,g,getIteratee(S,2),C)}}function createAssigner(g){return baseRest((function(m,S){var v=-1,C=S.length,_=C>1?S[C-1]:f,E=C>2?S[2]:f;for(_=g.length>3&&"function"==typeof _?(C--,_):f,E&&isIterateeCall(S[0],S[1],E)&&(_=C<3?f:_,C=1),m=St(m);++v<C;){var T=S[v];T&&g(m,T,v,_)}return m}))}function createBaseEach(g,m){return function(f,S){if(null==f)return f;if(!isArrayLike(f))return g(f,S);for(var v=f.length,C=m?v:-1,_=St(f);(m?C--:++C<v)&&!1!==S(_[C],C,_););return f}}function createBaseFor(g){return function(m,f,S){for(var v=-1,C=St(m),_=S(m),E=_.length;E--;){var T=_[g?E:++v];if(!1===f(C[T],T,C))break}return m}}function createBind(g,m,f){var S=m&O,v=createCtor(g);function wrapper(){return(this&&this!==hi&&this instanceof wrapper?v:g).apply(S?f:this,arguments)}return wrapper}function createCaseFirst(g){return function(m){var S=hasUnicode(m=toString(m))?stringToArray(m):f,v=S?S[0]:m.charAt(0),C=S?castSlice(S,1).join(""):m.slice(1);return v[g]()+C}}function createCompounder(g){return function(m){return arrayReduce(words(deburr(m).replace(zt,"")),g,"")}}function createCtor(g){return function(){var m=arguments;switch(m.length){case 0:return new g;case 1:return new g(m[0]);case 2:return new g(m[0],m[1]);case 3:return new g(m[0],m[1],m[2]);case 4:return new g(m[0],m[1],m[2],m[3]);case 5:return new g(m[0],m[1],m[2],m[3],m[4]);case 6:return new g(m[0],m[1],m[2],m[3],m[4],m[5]);case 7:return new g(m[0],m[1],m[2],m[3],m[4],m[5],m[6])}var f=Gi(g.prototype),S=g.apply(f,m);return isObject(S)?S:f}}function createCurry(g,m,S){var v=createCtor(g);function wrapper(){for(var _=arguments.length,E=C(_),T=_,I=getHolder(wrapper);T--;)E[T]=arguments[T];var b=_<3&&E[0]!==I&&E[_-1]!==I?[]:replaceHolders(E,I);return(_-=b.length)<S?createRecurry(g,m,createHybrid,wrapper.placeholder,f,E,b,f,f,S-_):apply(this&&this!==hi&&this instanceof wrapper?v:g,this,E)}return wrapper}function createFind(g){return function(m,S,v){var C=St(m);if(!isArrayLike(m)){var _=getIteratee(S,3);m=keys(m),S=function(g){return _(C[g],g,C)}}var E=g(m,S,v);return E>-1?C[_?m[E]:E]:f}}function createFlow(g){return flatRest((function(m){var S=m.length,v=S,C=LodashWrapper.prototype.thru;for(g&&m.reverse();v--;){var _=m[v];if("function"!=typeof _)throw new Ct(E);if(C&&!T&&"wrapper"==getFuncName(_))var T=new LodashWrapper([],!0)}for(v=T?v:S;++v<S;){var I=getFuncName(_=m[v]),b="wrapper"==I?Zi(_):f;T=b&&isLaziable(b[0])&&b[1]==(V|L|x|B)&&!b[4].length&&1==b[9]?T[getFuncName(b[0])].apply(T,b[3]):1==_.length&&isLaziable(_)?T[I]():T.thru(_)}return function(){var g=arguments,f=g[0];if(T&&1==g.length&&zn(f))return T.plant(f).value();for(var v=0,C=S?m[v].apply(this,g):f;++v<S;)C=m[v].call(this,C);return C}}))}function createHybrid(g,m,S,v,_,E,T,I,b,A){var P=m&V,R=m&O,w=m&N,M=m&(L|F),D=m&H,k=w?f:createCtor(g);function wrapper(){for(var f=arguments.length,O=C(f),N=f;N--;)O[N]=arguments[N];if(M)var L=getHolder(wrapper),F=countHolders(O,L);if(v&&(O=composeArgs(O,v,_,M)),E&&(O=composeArgsRight(O,E,T,M)),f-=F,M&&f<A){var x=replaceHolders(O,L);return createRecurry(g,m,createHybrid,wrapper.placeholder,S,O,x,I,b,A-f)}var U=R?S:this,V=w?U[g]:g;return f=O.length,I?O=reorder(O,I):D&&f>1&&O.reverse(),P&&b<f&&(O.length=b),this&&this!==hi&&this instanceof wrapper&&(V=k||createCtor(V)),V.apply(U,O)}return wrapper}function createInverter(g,m){return function(f,S){return baseInverter(f,g,m(S),{})}}function createMathOperation(g,m){return function(S,v){var C;if(S===f&&v===f)return m;if(S!==f&&(C=S),v!==f){if(C===f)return v;"string"==typeof S||"string"==typeof v?(S=baseToString(S),v=baseToString(v)):(S=baseToNumber(S),v=baseToNumber(v)),C=g(S,v)}return C}}function createOver(g){return flatRest((function(m){return m=arrayMap(m,baseUnary(getIteratee())),baseRest((function(f){var S=this;return g(m,(function(g){return apply(g,S,f)}))}))}))}function createPadding(g,m){var S=(m=m===f?" ":baseToString(m)).length;if(S<2)return S?baseRepeat(m,g):m;var v=baseRepeat(m,Yt(g/stringSize(m)));return hasUnicode(m)?castSlice(stringToArray(v),0,g).join(""):v.slice(0,g)}function createPartial(g,m,f,S){var v=m&O,_=createCtor(g);function wrapper(){for(var m=-1,E=arguments.length,T=-1,I=S.length,b=C(I+E),A=this&&this!==hi&&this instanceof wrapper?_:g;++T<I;)b[T]=S[T];for(;E--;)b[T++]=arguments[++m];return apply(A,v?f:this,b)}return wrapper}function createRange(g){return function(m,S,v){return v&&"number"!=typeof v&&isIterateeCall(m,S,v)&&(S=v=f),m=toFinite(m),S===f?(S=m,m=0):S=toFinite(S),baseRange(m,S,v=v===f?m<S?1:-1:toFinite(v),g)}}function createRelationalOperation(g){return function(m,f){return"string"==typeof m&&"string"==typeof f||(m=toNumber(m),f=toNumber(f)),g(m,f)}}function createRecurry(g,m,S,v,C,_,E,T,I,b){var A=m&L;m|=A?x:U,(m&=~(A?U:x))&k||(m&=~(O|N));var P=[g,m,C,A?_:f,A?E:f,A?f:_,A?f:E,T,I,b],R=S.apply(f,P);return isLaziable(g)&&sn(R,P),R.placeholder=v,setWrapToString(R,g,m)}function createRound(g){var m=ft[g];return function(g,f){if(g=toNumber(g),(f=null==f?0:di(toInteger(f),292))&&ri(g)){var S=(toString(g)+"e").split("e");return+((S=(toString(m(S[0]+"e"+(+S[1]+f)))+"e").split("e"))[0]+"e"+(+S[1]-f))}return m(g)}}var Xi=Mi&&1/setToArray(new Mi([,-0]))[1]==J?function(g){return new Mi(g)}:noop;function createToPairs(g){return function(m){var f=nn(m);return f==ue?mapToArray(m):f==ye?setToPairs(m):baseToPairs(m,g(m))}}function createWrap(g,m,S,v,C,_,T,I){var b=m&N;if(!b&&"function"!=typeof g)throw new Ct(E);var A=v?v.length:0;if(A||(m&=~(x|U),v=C=f),T=T===f?T:ci(toInteger(T),0),I=I===f?I:toInteger(I),A-=C?C.length:0,m&U){var P=v,R=C;v=C=f}var w=b?f:Zi(g),M=[g,m,S,v,C,P,R,_,T,I];if(w&&mergeData(M,w),g=M[0],m=M[1],S=M[2],v=M[3],C=M[4],!(I=M[9]=M[9]===f?b?0:g.length:ci(M[9]-A,0))&&m&(L|F)&&(m&=~(L|F)),m&&m!=O)D=m==L||m==F?createCurry(g,m,I):m!=x&&m!=(O|x)||C.length?createHybrid.apply(f,M):createPartial(g,m,S,v);else var D=createBind(g,m,S);return setWrapToString((w?Ki:sn)(D,M),g,m)}function customDefaultsAssignIn(g,m,S,v){return g===f||eq(g,Tt[S])&&!At.call(v,S)?m:g}function customDefaultsMerge(g,m,S,v,C,_){return isObject(g)&&isObject(m)&&(_.set(m,g),baseMerge(g,m,f,customDefaultsMerge,_),_.delete(m)),g}function customOmitClone(g){return isPlainObject(g)?f:g}function equalArrays(g,m,S,v,C,_){var E=S&M,T=g.length,I=m.length;if(T!=I&&!(E&&I>T))return!1;var b=_.get(g),A=_.get(m);if(b&&A)return b==m&&A==g;var P=-1,R=!0,w=S&D?new SetCache:f;for(_.set(g,m),_.set(m,g);++P<T;){var O=g[P],N=m[P];if(v)var k=E?v(N,O,P,m,g,_):v(O,N,P,g,m,_);if(k!==f){if(k)continue;R=!1;break}if(w){if(!arraySome(m,(function(g,m){if(!cacheHas(w,m)&&(O===g||C(O,g,S,v,_)))return w.push(m)}))){R=!1;break}}else if(O!==N&&!C(O,N,S,v,_)){R=!1;break}}return _.delete(g),_.delete(m),R}function equalByTag(g,m,f,S,v,C,_){switch(f){case Ae:if(g.byteLength!=m.byteLength||g.byteOffset!=m.byteOffset)return!1;g=g.buffer,m=m.buffer;case be:return!(g.byteLength!=m.byteLength||!C(new Lt(g),new Lt(m)));case ae:case oe:case ge:return eq(+g,+m);case ce:return g.name==m.name&&g.message==m.message;case ve:case Ce:return g==m+"";case ue:var E=mapToArray;case ye:var T=S&M;if(E||(E=setToArray),g.size!=m.size&&!T)return!1;var I=_.get(g);if(I)return I==m;S|=D,_.set(g,m);var b=equalArrays(E(g),E(m),S,v,C,_);return _.delete(g),b;case _e:if(Hi)return Hi.call(g)==Hi.call(m)}return!1}function equalObjects(g,m,S,v,C,_){var E=S&M,T=getAllKeys(g),I=T.length;if(I!=getAllKeys(m).length&&!E)return!1;for(var b=I;b--;){var A=T[b];if(!(E?A in m:At.call(m,A)))return!1}var P=_.get(g),R=_.get(m);if(P&&R)return P==m&&R==g;var w=!0;_.set(g,m),_.set(m,g);for(var D=E;++b<I;){var O=g[A=T[b]],N=m[A];if(v)var k=E?v(N,O,A,m,g,_):v(O,N,A,g,m,_);if(!(k===f?O===N||C(O,N,S,v,_):k)){w=!1;break}D||(D="constructor"==A)}if(w&&!D){var L=g.constructor,F=m.constructor;L==F||!("constructor"in g)||!("constructor"in m)||"function"==typeof L&&L instanceof L&&"function"==typeof F&&F instanceof F||(w=!1)}return _.delete(g),_.delete(m),w}function flatRest(g){return on(overRest(g,f,flatten),g+"")}function getAllKeys(g){return baseGetAllKeys(g,keys,en)}function getAllKeysIn(g){return baseGetAllKeys(g,keysIn,tn)}var Zi=Ni?function(g){return Ni.get(g)}:noop;function getFuncName(g){for(var m=g.name+"",f=ki[m],S=At.call(ki,m)?f.length:0;S--;){var v=f[S],C=v.func;if(null==C||C==g)return v.name}return m}function getHolder(g){return(At.call(lodash,"placeholder")?lodash:g).placeholder}function getIteratee(){var g=lodash.iteratee||iteratee;return g=g===iteratee?baseIteratee:g,arguments.length?g(arguments[0],arguments[1]):g}function getMapData(g,m){var f=g.__data__;return isKeyable(m)?f["string"==typeof m?"string":"hash"]:f.map}function getMatchData(g){for(var m=keys(g),f=m.length;f--;){var S=m[f],v=g[S];m[f]=[S,v,isStrictComparable(v)]}return m}function getNative(g,m){var S=getValue(g,m);return baseIsNative(S)?S:f}function getRawTag(g){var m=At.call(g,Gt),S=g[Gt];try{g[Gt]=f;var v=!0}catch(g){}var C=wt.call(g);return v&&(m?g[Gt]=S:delete g[Gt]),C}var en=Xt?function(g){return null==g?[]:(g=St(g),arrayFilter(Xt(g),(function(m){return Vt.call(g,m)})))}:stubArray,tn=Xt?function(g){for(var m=[];g;)arrayPush(m,en(g)),g=xt(g);return m}:stubArray,nn=baseGetTag;function getView(g,m,f){for(var S=-1,v=f.length;++S<v;){var C=f[S],_=C.size;switch(C.type){case"drop":g+=_;break;case"dropRight":m-=_;break;case"take":m=di(m,g+_);break;case"takeRight":g=ci(g,m-_)}}return{start:g,end:m}}function getWrapDetails(g){var m=g.match(et);return m?m[1].split(tt):[]}function hasPath(g,m,f){for(var S=-1,v=(m=castPath(m,g)).length,C=!1;++S<v;){var _=toKey(m[S]);if(!(C=null!=g&&f(g,_)))break;g=g[_]}return C||++S!=v?C:!!(v=null==g?0:g.length)&&isLength(v)&&isIndex(_,v)&&(zn(g)||qn(g))}function initCloneArray(g){var m=g.length,f=new g.constructor(m);return m&&"string"==typeof g[0]&&At.call(g,"index")&&(f.index=g.index,f.input=g.input),f}function initCloneObject(g){return"function"!=typeof g.constructor||isPrototype(g)?{}:Gi(xt(g))}function initCloneByTag(g,m,f){var S=g.constructor;switch(m){case be:return cloneArrayBuffer(g);case ae:case oe:return new S(+g);case Ae:return cloneDataView(g,f);case Pe:case Re:case we:case Me:case De:case Oe:case Ne:case ke:case Le:return cloneTypedArray(g,f);case ue:return new S;case ge:case Ce:return new S(g);case ve:return cloneRegExp(g);case ye:return new S;case _e:return cloneSymbol(g)}}function insertWrapDetails(g,m){var f=m.length;if(!f)return g;var S=f-1;return m[S]=(f>1?"& ":"")+m[S],m=m.join(f>2?", ":" "),g.replace(Ze,"{\n/* [wrapped with "+m+"] */\n")}function isFlattenable(g){return zn(g)||qn(g)||!!(Ht&&g&&g[Ht])}function isIndex(g,m){var f=typeof g;return!!(m=null==m?Y:m)&&("number"==f||"symbol"!=f&&ht.test(g))&&g>-1&&g%1==0&&g<m}function isIterateeCall(g,m,f){if(!isObject(f))return!1;var S=typeof m;return!!("number"==S?isArrayLike(f)&&isIndex(m,f.length):"string"==S&&m in f)&&eq(f[m],g)}function isKey(g,m){if(zn(g))return!1;var f=typeof g;return!("number"!=f&&"symbol"!=f&&"boolean"!=f&&null!=g&&!isSymbol(g))||(ze.test(g)||!qe.test(g)||null!=m&&g in St(m))}function isKeyable(g){var m=typeof g;return"string"==m||"number"==m||"symbol"==m||"boolean"==m?"__proto__"!==g:null===g}function isLaziable(g){var m=getFuncName(g),f=lodash[m];if("function"!=typeof f||!(m in LazyWrapper.prototype))return!1;if(g===f)return!0;var S=Zi(f);return!!S&&g===S[0]}function isMasked(g){return!!Rt&&Rt in g}(Ti&&nn(new Ti(new ArrayBuffer(1)))!=Ae||Pi&&nn(new Pi)!=ue||wi&&nn(wi.resolve())!=fe||Mi&&nn(new Mi)!=ye||Di&&nn(new Di)!=Te)&&(nn=function(g){var m=baseGetTag(g),S=m==me?g.constructor:f,v=S?toSource(S):"";if(v)switch(v){case Li:return Ae;case Fi:return ue;case xi:return fe;case Ui:return ye;case Vi:return Te}return m});var rn=It?isFunction:stubFalse;function isPrototype(g){var m=g&&g.constructor;return g===("function"==typeof m&&m.prototype||Tt)}function isStrictComparable(g){return g==g&&!isObject(g)}function matchesStrictComparable(g,m){return function(S){return null!=S&&(S[g]===m&&(m!==f||g in St(S)))}}function memoizeCapped(g){var m=memoize(g,(function(g){return f.size===b&&f.clear(),g})),f=m.cache;return m}function mergeData(g,m){var f=g[1],S=m[1],v=f|S,C=v<(O|N|V),_=S==V&&f==L||S==V&&f==B&&g[7].length<=m[8]||S==(V|B)&&m[7].length<=m[8]&&f==L;if(!C&&!_)return g;S&O&&(g[2]=m[2],v|=f&O?0:k);var E=m[3];if(E){var T=g[3];g[3]=T?composeArgs(T,E,m[4]):E,g[4]=T?replaceHolders(g[3],A):m[4]}return(E=m[5])&&(T=g[5],g[5]=T?composeArgsRight(T,E,m[6]):E,g[6]=T?replaceHolders(g[5],A):m[6]),(E=m[7])&&(g[7]=E),S&V&&(g[8]=null==g[8]?m[8]:di(g[8],m[8])),null==g[9]&&(g[9]=m[9]),g[0]=m[0],g[1]=v,g}function nativeKeysIn(g){var m=[];if(null!=g)for(var f in St(g))m.push(f);return m}function objectToString(g){return wt.call(g)}function overRest(g,m,S){return m=ci(m===f?g.length-1:m,0),function(){for(var f=arguments,v=-1,_=ci(f.length-m,0),E=C(_);++v<_;)E[v]=f[m+v];v=-1;for(var T=C(m+1);++v<m;)T[v]=f[v];return T[m]=S(E),apply(g,this,T)}}function parent(g,m){return m.length<2?g:baseGet(g,baseSlice(m,0,-1))}function reorder(g,m){for(var S=g.length,v=di(m.length,S),C=copyArray(g);v--;){var _=m[v];g[v]=isIndex(_,S)?C[_]:f}return g}function safeGet(g,m){if(("constructor"!==m||"function"!=typeof g[m])&&"__proto__"!=m)return g[m]}var sn=shortOut(Ki),an=Jt||function(g,m){return hi.setTimeout(g,m)},on=shortOut(Ji);function setWrapToString(g,m,f){var S=m+"";return on(g,insertWrapDetails(S,updateWrapDetails(getWrapDetails(S),f)))}function shortOut(g){var m=0,S=0;return function(){var v=ui(),C=W-(v-S);if(S=v,C>0){if(++m>=j)return arguments[0]}else m=0;return g.apply(f,arguments)}}function shuffleSelf(g,m){var S=-1,v=g.length,C=v-1;for(m=m===f?v:m;++S<m;){var _=baseRandom(S,C),E=g[_];g[_]=g[S],g[S]=E}return g.length=m,g}var ln=memoizeCapped((function(g){var m=[];return 46===g.charCodeAt(0)&&m.push(""),g.replace(Ke,(function(g,f,S,v){m.push(S?v.replace(rt,"$1"):f||g)})),m}));function toKey(g){if("string"==typeof g||isSymbol(g))return g;var m=g+"";return"0"==m&&1/g==-J?"-0":m}function toSource(g){if(null!=g){try{return bt.call(g)}catch(g){}try{return g+""}catch(g){}}return""}function updateWrapDetails(g,m){return arrayEach(ie,(function(f){var S="_."+f[0];m&f[1]&&!arrayIncludes(g,S)&&g.push(S)})),g.sort()}function wrapperClone(g){if(g instanceof LazyWrapper)return g.clone();var m=new LodashWrapper(g.__wrapped__,g.__chain__);return m.__actions__=copyArray(g.__actions__),m.__index__=g.__index__,m.__values__=g.__values__,m}function chunk(g,m,S){m=(S?isIterateeCall(g,m,S):m===f)?1:ci(toInteger(m),0);var v=null==g?0:g.length;if(!v||m<1)return[];for(var _=0,E=0,T=C(Yt(v/m));_<v;)T[E++]=baseSlice(g,_,_+=m);return T}function compact(g){for(var m=-1,f=null==g?0:g.length,S=0,v=[];++m<f;){var C=g[m];C&&(v[S++]=C)}return v}function concat(){var g=arguments.length;if(!g)return[];for(var m=C(g-1),f=arguments[0],S=g;S--;)m[S-1]=arguments[S];return arrayPush(zn(f)?copyArray(f):[f],baseFlatten(m,1))}var cn=baseRest((function(g,m){return isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0)):[]})),dn=baseRest((function(g,m){var S=last(m);return isArrayLikeObject(S)&&(S=f),isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0),getIteratee(S,2)):[]})),hn=baseRest((function(g,m){var S=last(m);return isArrayLikeObject(S)&&(S=f),isArrayLikeObject(g)?baseDifference(g,baseFlatten(m,1,isArrayLikeObject,!0),f,S):[]}));function drop(g,m,S){var v=null==g?0:g.length;return v?baseSlice(g,(m=S||m===f?1:toInteger(m))<0?0:m,v):[]}function dropRight(g,m,S){var v=null==g?0:g.length;return v?baseSlice(g,0,(m=v-(m=S||m===f?1:toInteger(m)))<0?0:m):[]}function dropRightWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!0,!0):[]}function dropWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!0):[]}function fill(g,m,f,S){var v=null==g?0:g.length;return v?(f&&"number"!=typeof f&&isIterateeCall(g,m,f)&&(f=0,S=v),baseFill(g,m,f,S)):[]}function findIndex(g,m,f){var S=null==g?0:g.length;if(!S)return-1;var v=null==f?0:toInteger(f);return v<0&&(v=ci(S+v,0)),baseFindIndex(g,getIteratee(m,3),v)}function findLastIndex(g,m,S){var v=null==g?0:g.length;if(!v)return-1;var C=v-1;return S!==f&&(C=toInteger(S),C=S<0?ci(v+C,0):di(C,v-1)),baseFindIndex(g,getIteratee(m,3),C,!0)}function flatten(g){return(null==g?0:g.length)?baseFlatten(g,1):[]}function flattenDeep(g){return(null==g?0:g.length)?baseFlatten(g,J):[]}function flattenDepth(g,m){return(null==g?0:g.length)?baseFlatten(g,m=m===f?1:toInteger(m)):[]}function fromPairs(g){for(var m=-1,f=null==g?0:g.length,S={};++m<f;){var v=g[m];S[v[0]]=v[1]}return S}function head(g){return g&&g.length?g[0]:f}function indexOf(g,m,f){var S=null==g?0:g.length;if(!S)return-1;var v=null==f?0:toInteger(f);return v<0&&(v=ci(S+v,0)),baseIndexOf(g,m,v)}function initial(g){return(null==g?0:g.length)?baseSlice(g,0,-1):[]}var un=baseRest((function(g){var m=arrayMap(g,castArrayLikeObject);return m.length&&m[0]===g[0]?baseIntersection(m):[]})),gn=baseRest((function(g){var m=last(g),S=arrayMap(g,castArrayLikeObject);return m===last(S)?m=f:S.pop(),S.length&&S[0]===g[0]?baseIntersection(S,getIteratee(m,2)):[]})),pn=baseRest((function(g){var m=last(g),S=arrayMap(g,castArrayLikeObject);return(m="function"==typeof m?m:f)&&S.pop(),S.length&&S[0]===g[0]?baseIntersection(S,f,m):[]}));function join(g,m){return null==g?"":si.call(g,m)}function last(g){var m=null==g?0:g.length;return m?g[m-1]:f}function lastIndexOf(g,m,S){var v=null==g?0:g.length;if(!v)return-1;var C=v;return S!==f&&(C=(C=toInteger(S))<0?ci(v+C,0):di(C,v-1)),m==m?strictLastIndexOf(g,m,C):baseFindIndex(g,baseIsNaN,C,!0)}function nth(g,m){return g&&g.length?baseNth(g,toInteger(m)):f}var mn=baseRest(pullAll);function pullAll(g,m){return g&&g.length&&m&&m.length?basePullAll(g,m):g}function pullAllBy(g,m,f){return g&&g.length&&m&&m.length?basePullAll(g,m,getIteratee(f,2)):g}function pullAllWith(g,m,S){return g&&g.length&&m&&m.length?basePullAll(g,m,f,S):g}var fn=flatRest((function(g,m){var f=null==g?0:g.length,S=baseAt(g,m);return basePullAt(g,arrayMap(m,(function(g){return isIndex(g,f)?+g:g})).sort(compareAscending)),S}));function remove(g,m){var f=[];if(!g||!g.length)return f;var S=-1,v=[],C=g.length;for(m=getIteratee(m,3);++S<C;){var _=g[S];m(_,S,g)&&(f.push(_),v.push(S))}return basePullAt(g,v),f}function reverse(g){return null==g?g:fi.call(g)}function slice(g,m,S){var v=null==g?0:g.length;return v?(S&&"number"!=typeof S&&isIterateeCall(g,m,S)?(m=0,S=v):(m=null==m?0:toInteger(m),S=S===f?v:toInteger(S)),baseSlice(g,m,S)):[]}function sortedIndex(g,m){return baseSortedIndex(g,m)}function sortedIndexBy(g,m,f){return baseSortedIndexBy(g,m,getIteratee(f,2))}function sortedIndexOf(g,m){var f=null==g?0:g.length;if(f){var S=baseSortedIndex(g,m);if(S<f&&eq(g[S],m))return S}return-1}function sortedLastIndex(g,m){return baseSortedIndex(g,m,!0)}function sortedLastIndexBy(g,m,f){return baseSortedIndexBy(g,m,getIteratee(f,2),!0)}function sortedLastIndexOf(g,m){if(null==g?0:g.length){var f=baseSortedIndex(g,m,!0)-1;if(eq(g[f],m))return f}return-1}function sortedUniq(g){return g&&g.length?baseSortedUniq(g):[]}function sortedUniqBy(g,m){return g&&g.length?baseSortedUniq(g,getIteratee(m,2)):[]}function tail(g){var m=null==g?0:g.length;return m?baseSlice(g,1,m):[]}function take(g,m,S){return g&&g.length?baseSlice(g,0,(m=S||m===f?1:toInteger(m))<0?0:m):[]}function takeRight(g,m,S){var v=null==g?0:g.length;return v?baseSlice(g,(m=v-(m=S||m===f?1:toInteger(m)))<0?0:m,v):[]}function takeRightWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3),!1,!0):[]}function takeWhile(g,m){return g&&g.length?baseWhile(g,getIteratee(m,3)):[]}var Sn=baseRest((function(g){return baseUniq(baseFlatten(g,1,isArrayLikeObject,!0))})),vn=baseRest((function(g){var m=last(g);return isArrayLikeObject(m)&&(m=f),baseUniq(baseFlatten(g,1,isArrayLikeObject,!0),getIteratee(m,2))})),yn=baseRest((function(g){var m=last(g);return m="function"==typeof m?m:f,baseUniq(baseFlatten(g,1,isArrayLikeObject,!0),f,m)}));function uniq(g){return g&&g.length?baseUniq(g):[]}function uniqBy(g,m){return g&&g.length?baseUniq(g,getIteratee(m,2)):[]}function uniqWith(g,m){return m="function"==typeof m?m:f,g&&g.length?baseUniq(g,f,m):[]}function unzip(g){if(!g||!g.length)return[];var m=0;return g=arrayFilter(g,(function(g){if(isArrayLikeObject(g))return m=ci(g.length,m),!0})),baseTimes(m,(function(m){return arrayMap(g,baseProperty(m))}))}function unzipWith(g,m){if(!g||!g.length)return[];var S=unzip(g);return null==m?S:arrayMap(S,(function(g){return apply(m,f,g)}))}var Cn=baseRest((function(g,m){return isArrayLikeObject(g)?baseDifference(g,m):[]})),_n=baseRest((function(g){return baseXor(arrayFilter(g,isArrayLikeObject))})),En=baseRest((function(g){var m=last(g);return isArrayLikeObject(m)&&(m=f),baseXor(arrayFilter(g,isArrayLikeObject),getIteratee(m,2))})),Tn=baseRest((function(g){var m=last(g);return m="function"==typeof m?m:f,baseXor(arrayFilter(g,isArrayLikeObject),f,m)})),In=baseRest(unzip);function zipObject(g,m){return baseZipObject(g||[],m||[],assignValue)}function zipObjectDeep(g,m){return baseZipObject(g||[],m||[],baseSet)}var bn=baseRest((function(g){var m=g.length,S=m>1?g[m-1]:f;return S="function"==typeof S?(g.pop(),S):f,unzipWith(g,S)}));function chain(g){var m=lodash(g);return m.__chain__=!0,m}function tap(g,m){return m(g),g}function thru(g,m){return m(g)}var An=flatRest((function(g){var m=g.length,S=m?g[0]:0,v=this.__wrapped__,interceptor=function(m){return baseAt(m,g)};return!(m>1||this.__actions__.length)&&v instanceof LazyWrapper&&isIndex(S)?((v=v.slice(S,+S+(m?1:0))).__actions__.push({func:thru,args:[interceptor],thisArg:f}),new LodashWrapper(v,this.__chain__).thru((function(g){return m&&!g.length&&g.push(f),g}))):this.thru(interceptor)}));function wrapperChain(){return chain(this)}function wrapperCommit(){return new LodashWrapper(this.value(),this.__chain__)}function wrapperNext(){this.__values__===f&&(this.__values__=toArray(this.value()));var g=this.__index__>=this.__values__.length;return{done:g,value:g?f:this.__values__[this.__index__++]}}function wrapperToIterator(){return this}function wrapperPlant(g){for(var m,S=this;S instanceof baseLodash;){var v=wrapperClone(S);v.__index__=0,v.__values__=f,m?C.__wrapped__=v:m=v;var C=v;S=S.__wrapped__}return C.__wrapped__=g,m}function wrapperReverse(){var g=this.__wrapped__;if(g instanceof LazyWrapper){var m=g;return this.__actions__.length&&(m=new LazyWrapper(this)),(m=m.reverse()).__actions__.push({func:thru,args:[reverse],thisArg:f}),new LodashWrapper(m,this.__chain__)}return this.thru(reverse)}function wrapperValue(){return baseWrapperValue(this.__wrapped__,this.__actions__)}var Pn=createAggregator((function(g,m,f){At.call(g,f)?++g[f]:baseAssignValue(g,f,1)}));function every(g,m,S){var v=zn(g)?arrayEvery:baseEvery;return S&&isIterateeCall(g,m,S)&&(m=f),v(g,getIteratee(m,3))}function filter(g,m){return(zn(g)?arrayFilter:baseFilter)(g,getIteratee(m,3))}var Rn=createFind(findIndex),wn=createFind(findLastIndex);function flatMap(g,m){return baseFlatten(map(g,m),1)}function flatMapDeep(g,m){return baseFlatten(map(g,m),J)}function flatMapDepth(g,m,S){return S=S===f?1:toInteger(S),baseFlatten(map(g,m),S)}function forEach(g,m){return(zn(g)?arrayEach:ji)(g,getIteratee(m,3))}function forEachRight(g,m){return(zn(g)?arrayEachRight:Wi)(g,getIteratee(m,3))}var Mn=createAggregator((function(g,m,f){At.call(g,f)?g[f].push(m):baseAssignValue(g,f,[m])}));function includes(g,m,f,S){g=isArrayLike(g)?g:values(g),f=f&&!S?toInteger(f):0;var v=g.length;return f<0&&(f=ci(v+f,0)),isString(g)?f<=v&&g.indexOf(m,f)>-1:!!v&&baseIndexOf(g,m,f)>-1}var Dn=baseRest((function(g,m,f){var S=-1,v="function"==typeof m,_=isArrayLike(g)?C(g.length):[];return ji(g,(function(g){_[++S]=v?apply(m,g,f):baseInvoke(g,m,f)})),_})),On=createAggregator((function(g,m,f){baseAssignValue(g,f,m)}));function map(g,m){return(zn(g)?arrayMap:baseMap)(g,getIteratee(m,3))}function orderBy(g,m,S,v){return null==g?[]:(zn(m)||(m=null==m?[]:[m]),zn(S=v?f:S)||(S=null==S?[]:[S]),baseOrderBy(g,m,S))}var Nn=createAggregator((function(g,m,f){g[f?0:1].push(m)}),(function(){return[[],[]]}));function reduce(g,m,f){var S=zn(g)?arrayReduce:baseReduce,v=arguments.length<3;return S(g,getIteratee(m,4),f,v,ji)}function reduceRight(g,m,f){var S=zn(g)?arrayReduceRight:baseReduce,v=arguments.length<3;return S(g,getIteratee(m,4),f,v,Wi)}function reject(g,m){return(zn(g)?arrayFilter:baseFilter)(g,negate(getIteratee(m,3)))}function sample(g){return(zn(g)?arraySample:baseSample)(g)}function sampleSize(g,m,S){return m=(S?isIterateeCall(g,m,S):m===f)?1:toInteger(m),(zn(g)?arraySampleSize:baseSampleSize)(g,m)}function shuffle(g){return(zn(g)?arrayShuffle:baseShuffle)(g)}function size(g){if(null==g)return 0;if(isArrayLike(g))return isString(g)?stringSize(g):g.length;var m=nn(g);return m==ue||m==ye?g.size:baseKeys(g).length}function some(g,m,S){var v=zn(g)?arraySome:baseSome;return S&&isIterateeCall(g,m,S)&&(m=f),v(g,getIteratee(m,3))}var kn=baseRest((function(g,m){if(null==g)return[];var f=m.length;return f>1&&isIterateeCall(g,m[0],m[1])?m=[]:f>2&&isIterateeCall(m[0],m[1],m[2])&&(m=[m[0]]),baseOrderBy(g,baseFlatten(m,1),[])})),Ln=qt||function(){return hi.Date.now()};function after(g,m){if("function"!=typeof m)throw new Ct(E);return g=toInteger(g),function(){if(--g<1)return m.apply(this,arguments)}}function ary(g,m,S){return m=S?f:m,m=g&&null==m?g.length:m,createWrap(g,V,f,f,f,f,m)}function before(g,m){var S;if("function"!=typeof m)throw new Ct(E);return g=toInteger(g),function(){return--g>0&&(S=m.apply(this,arguments)),g<=1&&(m=f),S}}var Fn=baseRest((function(g,m,f){var S=O;if(f.length){var v=replaceHolders(f,getHolder(Fn));S|=x}return createWrap(g,S,m,f,v)})),xn=baseRest((function(g,m,f){var S=O|N;if(f.length){var v=replaceHolders(f,getHolder(xn));S|=x}return createWrap(m,S,g,f,v)}));function curry(g,m,S){var v=createWrap(g,L,f,f,f,f,f,m=S?f:m);return v.placeholder=curry.placeholder,v}function curryRight(g,m,S){var v=createWrap(g,F,f,f,f,f,f,m=S?f:m);return v.placeholder=curryRight.placeholder,v}function debounce(g,m,S){var v,C,_,T,I,b,A=0,P=!1,R=!1,w=!0;if("function"!=typeof g)throw new Ct(E);function invokeFunc(m){var S=v,_=C;return v=C=f,A=m,T=g.apply(_,S)}function leadingEdge(g){return A=g,I=an(timerExpired,m),P?invokeFunc(g):T}function remainingWait(g){var f=m-(g-b);return R?di(f,_-(g-A)):f}function shouldInvoke(g){var S=g-b;return b===f||S>=m||S<0||R&&g-A>=_}function timerExpired(){var g=Ln();if(shouldInvoke(g))return trailingEdge(g);I=an(timerExpired,remainingWait(g))}function trailingEdge(g){return I=f,w&&v?invokeFunc(g):(v=C=f,T)}function cancel(){I!==f&&Qi(I),A=0,v=b=C=I=f}function flush(){return I===f?T:trailingEdge(Ln())}function debounced(){var g=Ln(),S=shouldInvoke(g);if(v=arguments,C=this,b=g,S){if(I===f)return leadingEdge(b);if(R)return Qi(I),I=an(timerExpired,m),invokeFunc(b)}return I===f&&(I=an(timerExpired,m)),T}return m=toNumber(m)||0,isObject(S)&&(P=!!S.leading,_=(R="maxWait"in S)?ci(toNumber(S.maxWait)||0,m):_,w="trailing"in S?!!S.trailing:w),debounced.cancel=cancel,debounced.flush=flush,debounced}var Un=baseRest((function(g,m){return baseDelay(g,1,m)})),Vn=baseRest((function(g,m,f){return baseDelay(g,toNumber(m)||0,f)}));function flip(g){return createWrap(g,H)}function memoize(g,m){if("function"!=typeof g||null!=m&&"function"!=typeof m)throw new Ct(E);var memoized=function(){var f=arguments,S=m?m.apply(this,f):f[0],v=memoized.cache;if(v.has(S))return v.get(S);var C=g.apply(this,f);return memoized.cache=v.set(S,C)||v,C};return memoized.cache=new(memoize.Cache||MapCache),memoized}function negate(g){if("function"!=typeof g)throw new Ct(E);return function(){var m=arguments;switch(m.length){case 0:return!g.call(this);case 1:return!g.call(this,m[0]);case 2:return!g.call(this,m[0],m[1]);case 3:return!g.call(this,m[0],m[1],m[2])}return!g.apply(this,m)}}function once(g){return before(2,g)}memoize.Cache=MapCache;var Bn=Yi((function(g,m){var f=(m=1==m.length&&zn(m[0])?arrayMap(m[0],baseUnary(getIteratee())):arrayMap(baseFlatten(m,1),baseUnary(getIteratee()))).length;return baseRest((function(S){for(var v=-1,C=di(S.length,f);++v<C;)S[v]=m[v].call(this,S[v]);return apply(g,this,S)}))})),Hn=baseRest((function(g,m){var S=replaceHolders(m,getHolder(Hn));return createWrap(g,x,f,m,S)})),$n=baseRest((function(g,m){var S=replaceHolders(m,getHolder($n));return createWrap(g,U,f,m,S)})),Gn=flatRest((function(g,m){return createWrap(g,B,f,f,f,m)}));function rest(g,m){if("function"!=typeof g)throw new Ct(E);return baseRest(g,m=m===f?m:toInteger(m))}function spread(g,m){if("function"!=typeof g)throw new Ct(E);return m=null==m?0:ci(toInteger(m),0),baseRest((function(f){var S=f[m],v=castSlice(f,0,m);return S&&arrayPush(v,S),apply(g,this,v)}))}function throttle(g,m,f){var S=!0,v=!0;if("function"!=typeof g)throw new Ct(E);return isObject(f)&&(S="leading"in f?!!f.leading:S,v="trailing"in f?!!f.trailing:v),debounce(g,m,{leading:S,maxWait:m,trailing:v})}function unary(g){return ary(g,1)}function wrap(g,m){return Hn(castFunction(m),g)}function castArray(){if(!arguments.length)return[];var g=arguments[0];return zn(g)?g:[g]}function clone(g){return baseClone(g,w)}function cloneWith(g,m){return baseClone(g,w,m="function"==typeof m?m:f)}function cloneDeep(g){return baseClone(g,P|w)}function cloneDeepWith(g,m){return baseClone(g,P|w,m="function"==typeof m?m:f)}function conformsTo(g,m){return null==m||baseConformsTo(g,m,keys(m))}function eq(g,m){return g===m||g!=g&&m!=m}var jn=createRelationalOperation(baseGt),Wn=createRelationalOperation((function(g,m){return g>=m})),qn=baseIsArguments(function(){return arguments}())?baseIsArguments:function(g){return isObjectLike(g)&&At.call(g,"callee")&&!Vt.call(g,"callee")},zn=C.isArray,Kn=Si?baseUnary(Si):baseIsArrayBuffer;function isArrayLike(g){return null!=g&&isLength(g.length)&&!isFunction(g)}function isArrayLikeObject(g){return isObjectLike(g)&&isArrayLike(g)}function isBoolean(g){return!0===g||!1===g||isObjectLike(g)&&baseGetTag(g)==ae}var Jn=ni||stubFalse,Yn=vi?baseUnary(vi):baseIsDate;function isElement(g){return isObjectLike(g)&&1===g.nodeType&&!isPlainObject(g)}function isEmpty(g){if(null==g)return!0;if(isArrayLike(g)&&(zn(g)||"string"==typeof g||"function"==typeof g.splice||Jn(g)||er(g)||qn(g)))return!g.length;var m=nn(g);if(m==ue||m==ye)return!g.size;if(isPrototype(g))return!baseKeys(g).length;for(var f in g)if(At.call(g,f))return!1;return!0}function isEqual(g,m){return baseIsEqual(g,m)}function isEqualWith(g,m,S){var v=(S="function"==typeof S?S:f)?S(g,m):f;return v===f?baseIsEqual(g,m,f,S):!!v}function isError(g){if(!isObjectLike(g))return!1;var m=baseGetTag(g);return m==ce||m==le||"string"==typeof g.message&&"string"==typeof g.name&&!isPlainObject(g)}function isFinite(g){return"number"==typeof g&&ri(g)}function isFunction(g){if(!isObject(g))return!1;var m=baseGetTag(g);return m==de||m==he||m==se||m==Se}function isInteger(g){return"number"==typeof g&&g==toInteger(g)}function isLength(g){return"number"==typeof g&&g>-1&&g%1==0&&g<=Y}function isObject(g){var m=typeof g;return null!=g&&("object"==m||"function"==m)}function isObjectLike(g){return null!=g&&"object"==typeof g}var Qn=yi?baseUnary(yi):baseIsMap;function isMatch(g,m){return g===m||baseIsMatch(g,m,getMatchData(m))}function isMatchWith(g,m,S){return S="function"==typeof S?S:f,baseIsMatch(g,m,getMatchData(m),S)}function isNaN(g){return isNumber(g)&&g!=+g}function isNative(g){if(rn(g))throw new it(_);return baseIsNative(g)}function isNull(g){return null===g}function isNil(g){return null==g}function isNumber(g){return"number"==typeof g||isObjectLike(g)&&baseGetTag(g)==ge}function isPlainObject(g){if(!isObjectLike(g)||baseGetTag(g)!=me)return!1;var m=xt(g);if(null===m)return!0;var f=At.call(m,"constructor")&&m.constructor;return"function"==typeof f&&f instanceof f&&bt.call(f)==Mt}var Xn=Ci?baseUnary(Ci):baseIsRegExp;function isSafeInteger(g){return isInteger(g)&&g>=-Y&&g<=Y}var Zn=_i?baseUnary(_i):baseIsSet;function isString(g){return"string"==typeof g||!zn(g)&&isObjectLike(g)&&baseGetTag(g)==Ce}function isSymbol(g){return"symbol"==typeof g||isObjectLike(g)&&baseGetTag(g)==_e}var er=Ei?baseUnary(Ei):baseIsTypedArray;function isUndefined(g){return g===f}function isWeakMap(g){return isObjectLike(g)&&nn(g)==Te}function isWeakSet(g){return isObjectLike(g)&&baseGetTag(g)==Ie}var tr=createRelationalOperation(baseLt),ir=createRelationalOperation((function(g,m){return g<=m}));function toArray(g){if(!g)return[];if(isArrayLike(g))return isString(g)?stringToArray(g):copyArray(g);if($t&&g[$t])return iteratorToArray(g[$t]());var m=nn(g);return(m==ue?mapToArray:m==ye?setToArray:values)(g)}function toFinite(g){return g?(g=toNumber(g))===J||g===-J?(g<0?-1:1)*Q:g==g?g:0:0===g?g:0}function toInteger(g){var m=toFinite(g),f=m%1;return m==m?f?m-f:m:0}function toLength(g){return g?baseClamp(toInteger(g),0,Z):0}function toNumber(g){if("number"==typeof g)return g;if(isSymbol(g))return X;if(isObject(g)){var m="function"==typeof g.valueOf?g.valueOf():g;g=isObject(m)?m+"":m}if("string"!=typeof g)return 0===g?g:+g;g=baseTrim(g);var f=lt.test(g);return f||dt.test(g)?li(g.slice(2),f?2:8):ot.test(g)?X:+g}function toPlainObject(g){return copyObject(g,keysIn(g))}function toSafeInteger(g){return g?baseClamp(toInteger(g),-Y,Y):0===g?g:0}function toString(g){return null==g?"":baseToString(g)}var nr=createAssigner((function(g,m){if(isPrototype(m)||isArrayLike(m))copyObject(m,keys(m),g);else for(var f in m)At.call(m,f)&&assignValue(g,f,m[f])})),rr=createAssigner((function(g,m){copyObject(m,keysIn(m),g)})),sr=createAssigner((function(g,m,f,S){copyObject(m,keysIn(m),g,S)})),ar=createAssigner((function(g,m,f,S){copyObject(m,keys(m),g,S)})),or=flatRest(baseAt);function create(g,m){var f=Gi(g);return null==m?f:baseAssign(f,m)}var lr=baseRest((function(g,m){g=St(g);var S=-1,v=m.length,C=v>2?m[2]:f;for(C&&isIterateeCall(m[0],m[1],C)&&(v=1);++S<v;)for(var _=m[S],E=keysIn(_),T=-1,I=E.length;++T<I;){var b=E[T],A=g[b];(A===f||eq(A,Tt[b])&&!At.call(g,b))&&(g[b]=_[b])}return g})),cr=baseRest((function(g){return g.push(f,customDefaultsMerge),apply(pr,f,g)}));function findKey(g,m){return baseFindKey(g,getIteratee(m,3),baseForOwn)}function findLastKey(g,m){return baseFindKey(g,getIteratee(m,3),baseForOwnRight)}function forIn(g,m){return null==g?g:qi(g,getIteratee(m,3),keysIn)}function forInRight(g,m){return null==g?g:zi(g,getIteratee(m,3),keysIn)}function forOwn(g,m){return g&&baseForOwn(g,getIteratee(m,3))}function forOwnRight(g,m){return g&&baseForOwnRight(g,getIteratee(m,3))}function functions(g){return null==g?[]:baseFunctions(g,keys(g))}function functionsIn(g){return null==g?[]:baseFunctions(g,keysIn(g))}function get(g,m,S){var v=null==g?f:baseGet(g,m);return v===f?S:v}function has(g,m){return null!=g&&hasPath(g,m,baseHas)}function hasIn(g,m){return null!=g&&hasPath(g,m,baseHasIn)}var dr=createInverter((function(g,m,f){null!=m&&"function"!=typeof m.toString&&(m=wt.call(m)),g[m]=f}),constant(identity)),hr=createInverter((function(g,m,f){null!=m&&"function"!=typeof m.toString&&(m=wt.call(m)),At.call(g,m)?g[m].push(f):g[m]=[f]}),getIteratee),ur=baseRest(baseInvoke);function keys(g){return isArrayLike(g)?arrayLikeKeys(g):baseKeys(g)}function keysIn(g){return isArrayLike(g)?arrayLikeKeys(g,!0):baseKeysIn(g)}function mapKeys(g,m){var f={};return m=getIteratee(m,3),baseForOwn(g,(function(g,S,v){baseAssignValue(f,m(g,S,v),g)})),f}function mapValues(g,m){var f={};return m=getIteratee(m,3),baseForOwn(g,(function(g,S,v){baseAssignValue(f,S,m(g,S,v))})),f}var gr=createAssigner((function(g,m,f){baseMerge(g,m,f)})),pr=createAssigner((function(g,m,f,S){baseMerge(g,m,f,S)})),mr=flatRest((function(g,m){var f={};if(null==g)return f;var S=!1;m=arrayMap(m,(function(m){return m=castPath(m,g),S||(S=m.length>1),m})),copyObject(g,getAllKeysIn(g),f),S&&(f=baseClone(f,P|R|w,customOmitClone));for(var v=m.length;v--;)baseUnset(f,m[v]);return f}));function omitBy(g,m){return pickBy(g,negate(getIteratee(m)))}var fr=flatRest((function(g,m){return null==g?{}:basePick(g,m)}));function pickBy(g,m){if(null==g)return{};var f=arrayMap(getAllKeysIn(g),(function(g){return[g]}));return m=getIteratee(m),basePickBy(g,f,(function(g,f){return m(g,f[0])}))}function result(g,m,S){var v=-1,C=(m=castPath(m,g)).length;for(C||(C=1,g=f);++v<C;){var _=null==g?f:g[toKey(m[v])];_===f&&(v=C,_=S),g=isFunction(_)?_.call(g):_}return g}function set(g,m,f){return null==g?g:baseSet(g,m,f)}function setWith(g,m,S,v){return v="function"==typeof v?v:f,null==g?g:baseSet(g,m,S,v)}var Sr=createToPairs(keys),vr=createToPairs(keysIn);function transform(g,m,f){var S=zn(g),v=S||Jn(g)||er(g);if(m=getIteratee(m,4),null==f){var C=g&&g.constructor;f=v?S?new C:[]:isObject(g)&&isFunction(C)?Gi(xt(g)):{}}return(v?arrayEach:baseForOwn)(g,(function(g,S,v){return m(f,g,S,v)})),f}function unset(g,m){return null==g||baseUnset(g,m)}function update(g,m,f){return null==g?g:baseUpdate(g,m,castFunction(f))}function updateWith(g,m,S,v){return v="function"==typeof v?v:f,null==g?g:baseUpdate(g,m,castFunction(S),v)}function values(g){return null==g?[]:baseValues(g,keys(g))}function valuesIn(g){return null==g?[]:baseValues(g,keysIn(g))}function clamp(g,m,S){return S===f&&(S=m,m=f),S!==f&&(S=(S=toNumber(S))==S?S:0),m!==f&&(m=(m=toNumber(m))==m?m:0),baseClamp(toNumber(g),m,S)}function inRange(g,m,S){return m=toFinite(m),S===f?(S=m,m=0):S=toFinite(S),baseInRange(g=toNumber(g),m,S)}function random(g,m,S){if(S&&"boolean"!=typeof S&&isIterateeCall(g,m,S)&&(m=S=f),S===f&&("boolean"==typeof m?(S=m,m=f):"boolean"==typeof g&&(S=g,g=f)),g===f&&m===f?(g=0,m=1):(g=toFinite(g),m===f?(m=g,g=0):m=toFinite(m)),g>m){var v=g;g=m,m=v}if(S||g%1||m%1){var C=mi();return di(g+C*(m-g+oi("1e-"+((C+"").length-1))),m)}return baseRandom(g,m)}var yr=createCompounder((function(g,m,f){return m=m.toLowerCase(),g+(f?capitalize(m):m)}));function capitalize(g){return Ar(toString(g).toLowerCase())}function deburr(g){return(g=toString(g))&&g.replace(ut,Ii).replace(Kt,"")}function endsWith(g,m,S){g=toString(g),m=baseToString(m);var v=g.length,C=S=S===f?v:baseClamp(toInteger(S),0,v);return(S-=m.length)>=0&&g.slice(S,C)==m}function escape(g){return(g=toString(g))&&$e.test(g)?g.replace(Be,bi):g}function escapeRegExp(g){return(g=toString(g))&&Ye.test(g)?g.replace(Je,"\\$&"):g}var Cr=createCompounder((function(g,m,f){return g+(f?"-":"")+m.toLowerCase()})),_r=createCompounder((function(g,m,f){return g+(f?" ":"")+m.toLowerCase()})),Er=createCaseFirst("toLowerCase");function pad(g,m,f){g=toString(g);var S=(m=toInteger(m))?stringSize(g):0;if(!m||S>=m)return g;var v=(m-S)/2;return createPadding(Qt(v),f)+g+createPadding(Yt(v),f)}function padEnd(g,m,f){g=toString(g);var S=(m=toInteger(m))?stringSize(g):0;return m&&S<m?g+createPadding(m-S,f):g}function padStart(g,m,f){g=toString(g);var S=(m=toInteger(m))?stringSize(g):0;return m&&S<m?createPadding(m-S,f)+g:g}function parseInt(g,m,f){return f||null==m?m=0:m&&(m=+m),gi(toString(g).replace(Qe,""),m||0)}function repeat(g,m,S){return m=(S?isIterateeCall(g,m,S):m===f)?1:toInteger(m),baseRepeat(toString(g),m)}function replace(){var g=arguments,m=toString(g[0]);return g.length<3?m:m.replace(g[1],g[2])}var Tr=createCompounder((function(g,m,f){return g+(f?"_":"")+m.toLowerCase()}));function split(g,m,S){return S&&"number"!=typeof S&&isIterateeCall(g,m,S)&&(m=S=f),(S=S===f?Z:S>>>0)?(g=toString(g))&&("string"==typeof m||null!=m&&!Xn(m))&&!(m=baseToString(m))&&hasUnicode(g)?castSlice(stringToArray(g),0,S):g.split(m,S):[]}var Ir=createCompounder((function(g,m,f){return g+(f?" ":"")+Ar(m)}));function startsWith(g,m,f){return g=toString(g),f=null==f?0:baseClamp(toInteger(f),0,g.length),m=baseToString(m),g.slice(f,f+m.length)==m}function template(g,m,S){var v=lodash.templateSettings;S&&isIterateeCall(g,m,S)&&(m=f),g=toString(g),m=sr({},m,v,customDefaultsAssignIn);var C,_,E=sr({},m.imports,v.imports,customDefaultsAssignIn),I=keys(E),b=baseValues(E,I),A=0,P=m.interpolate||gt,R="__p += '",w=vt((m.escape||gt).source+"|"+P.source+"|"+(P===We?st:gt).source+"|"+(m.evaluate||gt).source+"|$","g"),M="//# sourceURL="+(At.call(m,"sourceURL")?(m.sourceURL+"").replace(/\s/g," "):"lodash.templateSources["+ ++ei+"]")+"\n";g.replace(w,(function(m,f,S,v,E,T){return S||(S=v),R+=g.slice(A,T).replace(pt,escapeStringChar),f&&(C=!0,R+="' +\n__e("+f+") +\n'"),E&&(_=!0,R+="';\n"+E+";\n__p += '"),S&&(R+="' +\n((__t = ("+S+")) == null ? '' : __t) +\n'"),A=T+m.length,m})),R+="';\n";var D=At.call(m,"variable")&&m.variable;if(D){if(nt.test(D))throw new it(T)}else R="with (obj) {\n"+R+"\n}\n";R=(_?R.replace(Fe,""):R).replace(xe,"$1").replace(Ue,"$1;"),R="function("+(D||"obj")+") {\n"+(D?"":"obj || (obj = {});\n")+"var __t, __p = ''"+(C?", __e = _.escape":"")+(_?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+R+"return __p\n}";var O=Pr((function(){return mt(I,M+"return "+R).apply(f,b)}));if(O.source=R,isError(O))throw O;return O}function toLower(g){return toString(g).toLowerCase()}function toUpper(g){return toString(g).toUpperCase()}function trim(g,m,S){if((g=toString(g))&&(S||m===f))return baseTrim(g);if(!g||!(m=baseToString(m)))return g;var v=stringToArray(g),C=stringToArray(m);return castSlice(v,charsStartIndex(v,C),charsEndIndex(v,C)+1).join("")}function trimEnd(g,m,S){if((g=toString(g))&&(S||m===f))return g.slice(0,trimmedEndIndex(g)+1);if(!g||!(m=baseToString(m)))return g;var v=stringToArray(g);return castSlice(v,0,charsEndIndex(v,stringToArray(m))+1).join("")}function trimStart(g,m,S){if((g=toString(g))&&(S||m===f))return g.replace(Qe,"");if(!g||!(m=baseToString(m)))return g;var v=stringToArray(g);return castSlice(v,charsStartIndex(v,stringToArray(m))).join("")}function truncate(g,m){var S=$,v=G;if(isObject(m)){var C="separator"in m?m.separator:C;S="length"in m?toInteger(m.length):S,v="omission"in m?baseToString(m.omission):v}var _=(g=toString(g)).length;if(hasUnicode(g)){var E=stringToArray(g);_=E.length}if(S>=_)return g;var T=S-stringSize(v);if(T<1)return v;var I=E?castSlice(E,0,T).join(""):g.slice(0,T);if(C===f)return I+v;if(E&&(T+=I.length-T),Xn(C)){if(g.slice(T).search(C)){var b,A=I;for(C.global||(C=vt(C.source,toString(at.exec(C))+"g")),C.lastIndex=0;b=C.exec(A);)var P=b.index;I=I.slice(0,P===f?T:P)}}else if(g.indexOf(baseToString(C),T)!=T){var R=I.lastIndexOf(C);R>-1&&(I=I.slice(0,R))}return I+v}function unescape(g){return(g=toString(g))&&He.test(g)?g.replace(Ve,Ai):g}var br=createCompounder((function(g,m,f){return g+(f?" ":"")+m.toUpperCase()})),Ar=createCaseFirst("toUpperCase");function words(g,m,S){return g=toString(g),(m=S?f:m)===f?hasUnicodeWord(g)?unicodeWords(g):asciiWords(g):g.match(m)||[]}var Pr=baseRest((function(g,m){try{return apply(g,f,m)}catch(g){return isError(g)?g:new it(g)}})),Rr=flatRest((function(g,m){return arrayEach(m,(function(m){m=toKey(m),baseAssignValue(g,m,Fn(g[m],g))})),g}));function cond(g){var m=null==g?0:g.length,f=getIteratee();return g=m?arrayMap(g,(function(g){if("function"!=typeof g[1])throw new Ct(E);return[f(g[0]),g[1]]})):[],baseRest((function(f){for(var S=-1;++S<m;){var v=g[S];if(apply(v[0],this,f))return apply(v[1],this,f)}}))}function conforms(g){return baseConforms(baseClone(g,P))}function constant(g){return function(){return g}}function defaultTo(g,m){return null==g||g!=g?m:g}var wr=createFlow(),Mr=createFlow(!0);function identity(g){return g}function iteratee(g){return baseIteratee("function"==typeof g?g:baseClone(g,P))}function matches(g){return baseMatches(baseClone(g,P))}function matchesProperty(g,m){return baseMatchesProperty(g,baseClone(m,P))}var Dr=baseRest((function(g,m){return function(f){return baseInvoke(f,g,m)}})),Or=baseRest((function(g,m){return function(f){return baseInvoke(g,f,m)}}));function mixin(g,m,f){var S=keys(m),v=baseFunctions(m,S);null!=f||isObject(m)&&(v.length||!S.length)||(f=m,m=g,g=this,v=baseFunctions(m,keys(m)));var C=!(isObject(f)&&"chain"in f&&!f.chain),_=isFunction(g);return arrayEach(v,(function(f){var S=m[f];g[f]=S,_&&(g.prototype[f]=function(){var m=this.__chain__;if(C||m){var f=g(this.__wrapped__);return(f.__actions__=copyArray(this.__actions__)).push({func:S,args:arguments,thisArg:g}),f.__chain__=m,f}return S.apply(g,arrayPush([this.value()],arguments))})})),g}function noConflict(){return hi._===this&&(hi._=Dt),this}function noop(){}function nthArg(g){return g=toInteger(g),baseRest((function(m){return baseNth(m,g)}))}var Nr=createOver(arrayMap),kr=createOver(arrayEvery),Lr=createOver(arraySome);function property(g){return isKey(g)?baseProperty(toKey(g)):basePropertyDeep(g)}function propertyOf(g){return function(m){return null==g?f:baseGet(g,m)}}var Fr=createRange(),xr=createRange(!0);function stubArray(){return[]}function stubFalse(){return!1}function stubObject(){return{}}function stubString(){return""}function stubTrue(){return!0}function times(g,m){if((g=toInteger(g))<1||g>Y)return[];var f=Z,S=di(g,Z);m=getIteratee(m),g-=Z;for(var v=baseTimes(S,m);++f<g;)m(f);return v}function toPath(g){return zn(g)?arrayMap(g,toKey):isSymbol(g)?[g]:copyArray(ln(toString(g)))}function uniqueId(g){var m=++Pt;return toString(g)+m}var Ur=createMathOperation((function(g,m){return g+m}),0),Vr=createRound("ceil"),Br=createMathOperation((function(g,m){return g/m}),1),Hr=createRound("floor");function max(g){return g&&g.length?baseExtremum(g,identity,baseGt):f}function maxBy(g,m){return g&&g.length?baseExtremum(g,getIteratee(m,2),baseGt):f}function mean(g){return baseMean(g,identity)}function meanBy(g,m){return baseMean(g,getIteratee(m,2))}function min(g){return g&&g.length?baseExtremum(g,identity,baseLt):f}function minBy(g,m){return g&&g.length?baseExtremum(g,getIteratee(m,2),baseLt):f}var $r,Gr=createMathOperation((function(g,m){return g*m}),1),jr=createRound("round"),Wr=createMathOperation((function(g,m){return g-m}),0);function sum(g){return g&&g.length?baseSum(g,identity):0}function sumBy(g,m){return g&&g.length?baseSum(g,getIteratee(m,2)):0}return lodash.after=after,lodash.ary=ary,lodash.assign=nr,lodash.assignIn=rr,lodash.assignInWith=sr,lodash.assignWith=ar,lodash.at=or,lodash.before=before,lodash.bind=Fn,lodash.bindAll=Rr,lodash.bindKey=xn,lodash.castArray=castArray,lodash.chain=chain,lodash.chunk=chunk,lodash.compact=compact,lodash.concat=concat,lodash.cond=cond,lodash.conforms=conforms,lodash.constant=constant,lodash.countBy=Pn,lodash.create=create,lodash.curry=curry,lodash.curryRight=curryRight,lodash.debounce=debounce,lodash.defaults=lr,lodash.defaultsDeep=cr,lodash.defer=Un,lodash.delay=Vn,lodash.difference=cn,lodash.differenceBy=dn,lodash.differenceWith=hn,lodash.drop=drop,lodash.dropRight=dropRight,lodash.dropRightWhile=dropRightWhile,lodash.dropWhile=dropWhile,lodash.fill=fill,lodash.filter=filter,lodash.flatMap=flatMap,lodash.flatMapDeep=flatMapDeep,lodash.flatMapDepth=flatMapDepth,lodash.flatten=flatten,lodash.flattenDeep=flattenDeep,lodash.flattenDepth=flattenDepth,lodash.flip=flip,lodash.flow=wr,lodash.flowRight=Mr,lodash.fromPairs=fromPairs,lodash.functions=functions,lodash.functionsIn=functionsIn,lodash.groupBy=Mn,lodash.initial=initial,lodash.intersection=un,lodash.intersectionBy=gn,lodash.intersectionWith=pn,lodash.invert=dr,lodash.invertBy=hr,lodash.invokeMap=Dn,lodash.iteratee=iteratee,lodash.keyBy=On,lodash.keys=keys,lodash.keysIn=keysIn,lodash.map=map,lodash.mapKeys=mapKeys,lodash.mapValues=mapValues,lodash.matches=matches,lodash.matchesProperty=matchesProperty,lodash.memoize=memoize,lodash.merge=gr,lodash.mergeWith=pr,lodash.method=Dr,lodash.methodOf=Or,lodash.mixin=mixin,lodash.negate=negate,lodash.nthArg=nthArg,lodash.omit=mr,lodash.omitBy=omitBy,lodash.once=once,lodash.orderBy=orderBy,lodash.over=Nr,lodash.overArgs=Bn,lodash.overEvery=kr,lodash.overSome=Lr,lodash.partial=Hn,lodash.partialRight=$n,lodash.partition=Nn,lodash.pick=fr,lodash.pickBy=pickBy,lodash.property=property,lodash.propertyOf=propertyOf,lodash.pull=mn,lodash.pullAll=pullAll,lodash.pullAllBy=pullAllBy,lodash.pullAllWith=pullAllWith,lodash.pullAt=fn,lodash.range=Fr,lodash.rangeRight=xr,lodash.rearg=Gn,lodash.reject=reject,lodash.remove=remove,lodash.rest=rest,lodash.reverse=reverse,lodash.sampleSize=sampleSize,lodash.set=set,lodash.setWith=setWith,lodash.shuffle=shuffle,lodash.slice=slice,lodash.sortBy=kn,lodash.sortedUniq=sortedUniq,lodash.sortedUniqBy=sortedUniqBy,lodash.split=split,lodash.spread=spread,lodash.tail=tail,lodash.take=take,lodash.takeRight=takeRight,lodash.takeRightWhile=takeRightWhile,lodash.takeWhile=takeWhile,lodash.tap=tap,lodash.throttle=throttle,lodash.thru=thru,lodash.toArray=toArray,lodash.toPairs=Sr,lodash.toPairsIn=vr,lodash.toPath=toPath,lodash.toPlainObject=toPlainObject,lodash.transform=transform,lodash.unary=unary,lodash.union=Sn,lodash.unionBy=vn,lodash.unionWith=yn,lodash.uniq=uniq,lodash.uniqBy=uniqBy,lodash.uniqWith=uniqWith,lodash.unset=unset,lodash.unzip=unzip,lodash.unzipWith=unzipWith,lodash.update=update,lodash.updateWith=updateWith,lodash.values=values,lodash.valuesIn=valuesIn,lodash.without=Cn,lodash.words=words,lodash.wrap=wrap,lodash.xor=_n,lodash.xorBy=En,lodash.xorWith=Tn,lodash.zip=In,lodash.zipObject=zipObject,lodash.zipObjectDeep=zipObjectDeep,lodash.zipWith=bn,lodash.entries=Sr,lodash.entriesIn=vr,lodash.extend=rr,lodash.extendWith=sr,mixin(lodash,lodash),lodash.add=Ur,lodash.attempt=Pr,lodash.camelCase=yr,lodash.capitalize=capitalize,lodash.ceil=Vr,lodash.clamp=clamp,lodash.clone=clone,lodash.cloneDeep=cloneDeep,lodash.cloneDeepWith=cloneDeepWith,lodash.cloneWith=cloneWith,lodash.conformsTo=conformsTo,lodash.deburr=deburr,lodash.defaultTo=defaultTo,lodash.divide=Br,lodash.endsWith=endsWith,lodash.eq=eq,lodash.escape=escape,lodash.escapeRegExp=escapeRegExp,lodash.every=every,lodash.find=Rn,lodash.findIndex=findIndex,lodash.findKey=findKey,lodash.findLast=wn,lodash.findLastIndex=findLastIndex,lodash.findLastKey=findLastKey,lodash.floor=Hr,lodash.forEach=forEach,lodash.forEachRight=forEachRight,lodash.forIn=forIn,lodash.forInRight=forInRight,lodash.forOwn=forOwn,lodash.forOwnRight=forOwnRight,lodash.get=get,lodash.gt=jn,lodash.gte=Wn,lodash.has=has,lodash.hasIn=hasIn,lodash.head=head,lodash.identity=identity,lodash.includes=includes,lodash.indexOf=indexOf,lodash.inRange=inRange,lodash.invoke=ur,lodash.isArguments=qn,lodash.isArray=zn,lodash.isArrayBuffer=Kn,lodash.isArrayLike=isArrayLike,lodash.isArrayLikeObject=isArrayLikeObject,lodash.isBoolean=isBoolean,lodash.isBuffer=Jn,lodash.isDate=Yn,lodash.isElement=isElement,lodash.isEmpty=isEmpty,lodash.isEqual=isEqual,lodash.isEqualWith=isEqualWith,lodash.isError=isError,lodash.isFinite=isFinite,lodash.isFunction=isFunction,lodash.isInteger=isInteger,lodash.isLength=isLength,lodash.isMap=Qn,lodash.isMatch=isMatch,lodash.isMatchWith=isMatchWith,lodash.isNaN=isNaN,lodash.isNative=isNative,lodash.isNil=isNil,lodash.isNull=isNull,lodash.isNumber=isNumber,lodash.isObject=isObject,lodash.isObjectLike=isObjectLike,lodash.isPlainObject=isPlainObject,lodash.isRegExp=Xn,lodash.isSafeInteger=isSafeInteger,lodash.isSet=Zn,lodash.isString=isString,lodash.isSymbol=isSymbol,lodash.isTypedArray=er,lodash.isUndefined=isUndefined,lodash.isWeakMap=isWeakMap,lodash.isWeakSet=isWeakSet,lodash.join=join,lodash.kebabCase=Cr,lodash.last=last,lodash.lastIndexOf=lastIndexOf,lodash.lowerCase=_r,lodash.lowerFirst=Er,lodash.lt=tr,lodash.lte=ir,lodash.max=max,lodash.maxBy=maxBy,lodash.mean=mean,lodash.meanBy=meanBy,lodash.min=min,lodash.minBy=minBy,lodash.stubArray=stubArray,lodash.stubFalse=stubFalse,lodash.stubObject=stubObject,lodash.stubString=stubString,lodash.stubTrue=stubTrue,lodash.multiply=Gr,lodash.nth=nth,lodash.noConflict=noConflict,lodash.noop=noop,lodash.now=Ln,lodash.pad=pad,lodash.padEnd=padEnd,lodash.padStart=padStart,lodash.parseInt=parseInt,lodash.random=random,lodash.reduce=reduce,lodash.reduceRight=reduceRight,lodash.repeat=repeat,lodash.replace=replace,lodash.result=result,lodash.round=jr,lodash.runInContext=runInContext,lodash.sample=sample,lodash.size=size,lodash.snakeCase=Tr,lodash.some=some,lodash.sortedIndex=sortedIndex,lodash.sortedIndexBy=sortedIndexBy,lodash.sortedIndexOf=sortedIndexOf,lodash.sortedLastIndex=sortedLastIndex,lodash.sortedLastIndexBy=sortedLastIndexBy,lodash.sortedLastIndexOf=sortedLastIndexOf,lodash.startCase=Ir,lodash.startsWith=startsWith,lodash.subtract=Wr,lodash.sum=sum,lodash.sumBy=sumBy,lodash.template=template,lodash.times=times,lodash.toFinite=toFinite,lodash.toInteger=toInteger,lodash.toLength=toLength,lodash.toLower=toLower,lodash.toNumber=toNumber,lodash.toSafeInteger=toSafeInteger,lodash.toString=toString,lodash.toUpper=toUpper,lodash.trim=trim,lodash.trimEnd=trimEnd,lodash.trimStart=trimStart,lodash.truncate=truncate,lodash.unescape=unescape,lodash.uniqueId=uniqueId,lodash.upperCase=br,lodash.upperFirst=Ar,lodash.each=forEach,lodash.eachRight=forEachRight,lodash.first=head,mixin(lodash,($r={},baseForOwn(lodash,(function(g,m){At.call(lodash.prototype,m)||($r[m]=g)})),$r),{chain:!1}),lodash.VERSION=S,arrayEach(["bind","bindKey","curry","curryRight","partial","partialRight"],(function(g){lodash[g].placeholder=lodash})),arrayEach(["drop","take"],(function(g,m){LazyWrapper.prototype[g]=function(S){S=S===f?1:ci(toInteger(S),0);var v=this.__filtered__&&!m?new LazyWrapper(this):this.clone();return v.__filtered__?v.__takeCount__=di(S,v.__takeCount__):v.__views__.push({size:di(S,Z),type:g+(v.__dir__<0?"Right":"")}),v},LazyWrapper.prototype[g+"Right"]=function(m){return this.reverse()[g](m).reverse()}})),arrayEach(["filter","map","takeWhile"],(function(g,m){var f=m+1,S=f==q||f==K;LazyWrapper.prototype[g]=function(g){var m=this.clone();return m.__iteratees__.push({iteratee:getIteratee(g,3),type:f}),m.__filtered__=m.__filtered__||S,m}})),arrayEach(["head","last"],(function(g,m){var f="take"+(m?"Right":"");LazyWrapper.prototype[g]=function(){return this[f](1).value()[0]}})),arrayEach(["initial","tail"],(function(g,m){var f="drop"+(m?"":"Right");LazyWrapper.prototype[g]=function(){return this.__filtered__?new LazyWrapper(this):this[f](1)}})),LazyWrapper.prototype.compact=function(){return this.filter(identity)},LazyWrapper.prototype.find=function(g){return this.filter(g).head()},LazyWrapper.prototype.findLast=function(g){return this.reverse().find(g)},LazyWrapper.prototype.invokeMap=baseRest((function(g,m){return"function"==typeof g?new LazyWrapper(this):this.map((function(f){return baseInvoke(f,g,m)}))})),LazyWrapper.prototype.reject=function(g){return this.filter(negate(getIteratee(g)))},LazyWrapper.prototype.slice=function(g,m){g=toInteger(g);var S=this;return S.__filtered__&&(g>0||m<0)?new LazyWrapper(S):(g<0?S=S.takeRight(-g):g&&(S=S.drop(g)),m!==f&&(S=(m=toInteger(m))<0?S.dropRight(-m):S.take(m-g)),S)},LazyWrapper.prototype.takeRightWhile=function(g){return this.reverse().takeWhile(g).reverse()},LazyWrapper.prototype.toArray=function(){return this.take(Z)},baseForOwn(LazyWrapper.prototype,(function(g,m){var S=/^(?:filter|find|map|reject)|While$/.test(m),v=/^(?:head|last)$/.test(m),C=lodash[v?"take"+("last"==m?"Right":""):m],_=v||/^find/.test(m);C&&(lodash.prototype[m]=function(){var m=this.__wrapped__,E=v?[1]:arguments,T=m instanceof LazyWrapper,I=E[0],b=T||zn(m),interceptor=function(g){var m=C.apply(lodash,arrayPush([g],E));return v&&A?m[0]:m};b&&S&&"function"==typeof I&&1!=I.length&&(T=b=!1);var A=this.__chain__,P=!!this.__actions__.length,R=_&&!A,w=T&&!P;if(!_&&b){m=w?m:new LazyWrapper(this);var M=g.apply(m,E);return M.__actions__.push({func:thru,args:[interceptor],thisArg:f}),new LodashWrapper(M,A)}return R&&w?g.apply(this,E):(M=this.thru(interceptor),R?v?M.value()[0]:M.value():M)})})),arrayEach(["pop","push","shift","sort","splice","unshift"],(function(g){var m=_t[g],f=/^(?:push|sort|unshift)$/.test(g)?"tap":"thru",S=/^(?:pop|shift)$/.test(g);lodash.prototype[g]=function(){var g=arguments;if(S&&!this.__chain__){var v=this.value();return m.apply(zn(v)?v:[],g)}return this[f]((function(f){return m.apply(zn(f)?f:[],g)}))}})),baseForOwn(LazyWrapper.prototype,(function(g,m){var f=lodash[m];if(f){var S=f.name+"";At.call(ki,S)||(ki[S]=[]),ki[S].push({name:m,func:f})}})),ki[createHybrid(f,N).name]=[{name:"wrapper",func:f}],LazyWrapper.prototype.clone=lazyClone,LazyWrapper.prototype.reverse=lazyReverse,LazyWrapper.prototype.value=lazyValue,lodash.prototype.at=An,lodash.prototype.chain=wrapperChain,lodash.prototype.commit=wrapperCommit,lodash.prototype.next=wrapperNext,lodash.prototype.plant=wrapperPlant,lodash.prototype.reverse=wrapperReverse,lodash.prototype.toJSON=lodash.prototype.valueOf=lodash.prototype.value=wrapperValue,lodash.prototype.first=lodash.prototype.head,$t&&(lodash.prototype[$t]=wrapperToIterator),lodash},Ri=Pi();gi?((gi.exports=Ri)._=Ri,ui._=Ri):hi._=Ri}).call(C)})),w=createCommonjsModule((function(g,m){var f=window;!function(m,f){g.exports=f(P,R)}(0,((g,m)=>{var S={},v={exports:S},C=Object.create,_=Object.defineProperty,E=Object.getOwnPropertyDescriptor,T=Object.getOwnPropertyNames,I=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty,__commonJS=(g,m)=>function __require(){return m||(0,g[T(g)[0]])((m={exports:{}}).exports,m),m.exports},__export=(g,m)=>{for(var f in m)_(g,f,{get:m[f],enumerable:!0})},__copyProps=(g,m,f,S)=>{if(m&&"object"==typeof m||"function"==typeof m)for(let v of T(m))b.call(g,v)||v===f||_(g,v,{get:()=>m[v],enumerable:!(S=E(m,v))||S.enumerable});return g},__toESM=(g,m,f)=>(f=null!=g?C(I(g)):{},__copyProps(!m&&g&&g.__esModule?f:_(f,"default",{value:g,enumerable:!0}),g)),__toCommonJS=g=>__copyProps(_({},"__esModule",{value:!0}),g),__decorateClass=(g,m,f,S)=>{for(var v,C=S>1?void 0:S?E(m,f):m,T=g.length-1;T>=0;T--)(v=g[T])&&(C=(S?v(m,f,C):v(C))||C);return S&&C&&_(m,f,C),C},__decorateParam=(g,m)=>(f,S)=>m(f,S,g),A=__commonJS({"../node_modules/axios/lib/helpers/bind.js"(g,m){m.exports=function bind(g,m){return function wrap(){for(var f=new Array(arguments.length),S=0;S<f.length;S++)f[S]=arguments[S];return g.apply(m,f)}}}}),w=__commonJS({"../node_modules/axios/lib/utils.js"(g,m){var f=A(),S=Object.prototype.toString;function isArray4(g){return"[object Array]"===S.call(g)}function isUndefined7(g){return void 0===g}function isBuffer(g){return null!==g&&!isUndefined7(g)&&null!==g.constructor&&!isUndefined7(g.constructor)&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}function isArrayBuffer(g){return"[object ArrayBuffer]"===S.call(g)}function isFormData(g){return"undefined"!=typeof FormData&&g instanceof FormData}function isArrayBufferView(g){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(g):g&&g.buffer&&g.buffer instanceof ArrayBuffer}function isString3(g){return"string"==typeof g}function isNumber4(g){return"number"==typeof g}function isObject4(g){return null!==g&&"object"==typeof g}function isDate2(g){return"[object Date]"===S.call(g)}function isFile(g){return"[object File]"===S.call(g)}function isBlob(g){return"[object Blob]"===S.call(g)}function isFunction3(g){return"[object Function]"===S.call(g)}function isStream(g){return isObject4(g)&&isFunction3(g.pipe)}function isURLSearchParams(g){return"undefined"!=typeof URLSearchParams&&g instanceof URLSearchParams}function trim2(g){return g.replace(/^\s*/,"").replace(/\s*$/,"")}function isStandardBrowserEnv(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach3(g,m){if(null!=g)if("object"!=typeof g&&(g=[g]),isArray4(g))for(var f=0,S=g.length;f<S;f++)m.call(null,g[f],f,g);else for(var v in g)Object.prototype.hasOwnProperty.call(g,v)&&m.call(null,g[v],v,g)}function merge5(){var g={};function assignValue(m,f){"object"==typeof g[f]&&"object"==typeof m?g[f]=merge5(g[f],m):g[f]=m}for(var m=0,f=arguments.length;m<f;m++)forEach3(arguments[m],assignValue);return g}function deepMerge(){var g={};function assignValue(m,f){"object"==typeof g[f]&&"object"==typeof m?g[f]=deepMerge(g[f],m):g[f]="object"==typeof m?deepMerge({},m):m}for(var m=0,f=arguments.length;m<f;m++)forEach3(arguments[m],assignValue);return g}function extend2(g,m,S){return forEach3(m,(function assignValue(m,v){g[v]=S&&"function"==typeof m?f(m,S):m})),g}m.exports={isArray:isArray4,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString3,isNumber:isNumber4,isObject:isObject4,isUndefined:isUndefined7,isDate:isDate2,isFile:isFile,isBlob:isBlob,isFunction:isFunction3,isStream:isStream,isURLSearchParams:isURLSearchParams,isStandardBrowserEnv:isStandardBrowserEnv,forEach:forEach3,merge:merge5,deepMerge:deepMerge,extend:extend2,trim:trim2}}}),M=__commonJS({"../node_modules/axios/lib/helpers/buildURL.js"(g,m){var f=w();function encode(g){return encodeURIComponent(g).replace(/%40/gi,"@").replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}m.exports=function buildURL(g,m,S){if(!m)return g;var v;if(S)v=S(m);else if(f.isURLSearchParams(m))v=m.toString();else{var C=[];f.forEach(m,(function serialize(g,m){null!=g&&(f.isArray(g)?m+="[]":g=[g],f.forEach(g,(function parseValue(g){f.isDate(g)?g=g.toISOString():f.isObject(g)&&(g=JSON.stringify(g)),C.push(encode(m)+"="+encode(g))})))})),v=C.join("&")}if(v){var _=g.indexOf("#");-1!==_&&(g=g.slice(0,_)),g+=(-1===g.indexOf("?")?"?":"&")+v}return g}}}),D=__commonJS({"../node_modules/axios/lib/core/InterceptorManager.js"(g,m){var f=w();function InterceptorManager(){this.handlers=[]}InterceptorManager.prototype.use=function use(g,m){return this.handlers.push({fulfilled:g,rejected:m}),this.handlers.length-1},InterceptorManager.prototype.eject=function eject(g){this.handlers[g]&&(this.handlers[g]=null)},InterceptorManager.prototype.forEach=function forEach3(g){f.forEach(this.handlers,(function forEachHandler(m){null!==m&&g(m)}))},m.exports=InterceptorManager}}),O=__commonJS({"../node_modules/axios/lib/core/transformData.js"(g,m){var f=w();m.exports=function transformData(g,m,S){return f.forEach(S,(function transform(f){g=f(g,m)})),g}}}),N=__commonJS({"../node_modules/axios/lib/cancel/isCancel.js"(g,m){m.exports=function isCancel(g){return!(!g||!g.__CANCEL__)}}}),k=__commonJS({"../node_modules/axios/lib/helpers/normalizeHeaderName.js"(g,m){var f=w();m.exports=function normalizeHeaderName(g,m){f.forEach(g,(function processHeader(f,S){S!==m&&S.toUpperCase()===m.toUpperCase()&&(g[m]=f,delete g[S])}))}}}),L=__commonJS({"../node_modules/axios/lib/core/enhanceError.js"(g,m){m.exports=function enhanceError(g,m,f,S,v){return g.config=m,f&&(g.code=f),g.request=S,g.response=v,g.isAxiosError=!0,g.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},g}}}),F=__commonJS({"../node_modules/axios/lib/core/createError.js"(g,m){var f=L();m.exports=function createError(g,m,S,v,C){var _=new Error(g);return f(_,m,S,v,C)}}}),x=__commonJS({"../node_modules/axios/lib/core/settle.js"(g,m){var f=F();m.exports=function settle(g,m,S){var v=S.config.validateStatus;!v||v(S.status)?g(S):m(f("Request failed with status code "+S.status,S.config,null,S.request,S))}}}),U=__commonJS({"../node_modules/axios/lib/helpers/isAbsoluteURL.js"(g,m){m.exports=function isAbsoluteURL(g){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(g)}}}),V=__commonJS({"../node_modules/axios/lib/helpers/combineURLs.js"(g,m){m.exports=function combineURLs(g,m){return m?g.replace(/\/+$/,"")+"/"+m.replace(/^\/+/,""):g}}}),B=__commonJS({"../node_modules/axios/lib/core/buildFullPath.js"(g,m){var f=U(),S=V();m.exports=function buildFullPath(g,m){return g&&!f(m)?S(g,m):m}}}),H=__commonJS({"../node_modules/axios/lib/helpers/parseHeaders.js"(g,m){var f=w(),S=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"];m.exports=function parseHeaders(g){var m,v,C,_={};return g?(f.forEach(g.split("\n"),(function parser(g){if(C=g.indexOf(":"),m=f.trim(g.substr(0,C)).toLowerCase(),v=f.trim(g.substr(C+1)),m){if(_[m]&&S.indexOf(m)>=0)return;_[m]="set-cookie"===m?(_[m]?_[m]:[]).concat([v]):_[m]?_[m]+", "+v:v}})),_):_}}}),$=__commonJS({"../node_modules/axios/lib/helpers/isValidXss.js"(g,m){m.exports=function isValidXss(g){return/(\b)(on\w+)=|javascript|(<\s*)(\/*)script/gi.test(g)}}}),G=__commonJS({"../node_modules/axios/lib/helpers/isURLSameOrigin.js"(g,m){var f=w(),S=$();m.exports=f.isStandardBrowserEnv()?function standardBrowserEnv(){var g,m=/(msie|trident)/i.test(navigator.userAgent),v=document.createElement("a");function resolveURL(g){var f=g;if(S(g))throw new Error("URL contains XSS injection attempt");return m&&(v.setAttribute("href",f),f=v.href),v.setAttribute("href",f),{href:v.href,protocol:v.protocol?v.protocol.replace(/:$/,""):"",host:v.host,search:v.search?v.search.replace(/^\?/,""):"",hash:v.hash?v.hash.replace(/^#/,""):"",hostname:v.hostname,port:v.port,pathname:"/"===v.pathname.charAt(0)?v.pathname:"/"+v.pathname}}return g=resolveURL(window.location.href),function isURLSameOrigin(m){var S=f.isString(m)?resolveURL(m):m;return S.protocol===g.protocol&&S.host===g.host}}():function nonStandardBrowserEnv(){return function isURLSameOrigin(){return!0}}()}}),j=__commonJS({"../node_modules/axios/lib/helpers/cookies.js"(g,m){var f=w();m.exports=f.isStandardBrowserEnv()?function standardBrowserEnv(){return{write:function write5(g,m,S,v,C,_){var E=[];E.push(g+"="+encodeURIComponent(m)),f.isNumber(S)&&E.push("expires="+new Date(S).toGMTString()),f.isString(v)&&E.push("path="+v),f.isString(C)&&E.push("domain="+C),!0===_&&E.push("secure"),document.cookie=E.join("; ")},read:function read(g){var m=document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)"));return m?decodeURIComponent(m[3]):null},remove:function remove6(g){this.write(g,"",Date.now()-864e5)}}}():function nonStandardBrowserEnv(){return{write:function write5(){},read:function read(){return null},remove:function remove6(){}}}()}}),W=__commonJS({"../node_modules/axios/lib/adapters/xhr.js"(g,m){var f=w(),S=x(),v=M(),C=B(),_=H(),E=G(),T=F();m.exports=function xhrAdapter(g){return new Promise((function dispatchXhrRequest(m,I){var b=g.data,A=g.headers;f.isFormData(b)&&delete A["Content-Type"];var P=new XMLHttpRequest;if(g.auth){var R=g.auth.username||"",w=g.auth.password||"";A.Authorization="Basic "+btoa(R+":"+w)}var M=C(g.baseURL,g.url);if(P.open(g.method.toUpperCase(),v(M,g.params,g.paramsSerializer),!0),P.timeout=g.timeout,P.onreadystatechange=function handleLoad(){if(P&&4===P.readyState&&(0!==P.status||P.responseURL&&0===P.responseURL.indexOf("file:"))){var f="getAllResponseHeaders"in P?_(P.getAllResponseHeaders()):null,v={data:g.responseType&&"text"!==g.responseType?P.response:P.responseText,status:P.status,statusText:P.statusText,headers:f,config:g,request:P};S(m,I,v),P=null}},P.onabort=function handleAbort(){P&&(I(T("Request aborted",g,"ECONNABORTED",P)),P=null)},P.onerror=function handleError(){I(T("Network Error",g,null,P)),P=null},P.ontimeout=function handleTimeout(){var m="timeout of "+g.timeout+"ms exceeded";g.timeoutErrorMessage&&(m=g.timeoutErrorMessage),I(T(m,g,"ECONNABORTED",P)),P=null},f.isStandardBrowserEnv()){var D=j(),O=(g.withCredentials||E(M))&&g.xsrfCookieName?D.read(g.xsrfCookieName):void 0;O&&(A[g.xsrfHeaderName]=O)}if("setRequestHeader"in P&&f.forEach(A,(function setRequestHeader(g,m){void 0===b&&"content-type"===m.toLowerCase()?delete A[m]:P.setRequestHeader(m,g)})),f.isUndefined(g.withCredentials)||(P.withCredentials=!!g.withCredentials),g.responseType)try{P.responseType=g.responseType}catch(m){if("json"!==g.responseType)throw m}"function"==typeof g.onDownloadProgress&&P.addEventListener("progress",g.onDownloadProgress),"function"==typeof g.onUploadProgress&&P.upload&&P.upload.addEventListener("progress",g.onUploadProgress),g.cancelToken&&g.cancelToken.promise.then((function onCanceled(g){P&&(P.abort(),I(g),P=null)})),void 0===b&&(b=null),P.send(b)}))}}}),q=__commonJS({"../node_modules/axios/lib/defaults.js"(g,m){var f=w(),S=k(),v={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset(g,m){!f.isUndefined(g)&&f.isUndefined(g["Content-Type"])&&(g["Content-Type"]=m)}function getDefaultAdapter(){var g;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(g=W()),g}var C={adapter:getDefaultAdapter(),transformRequest:[function transformRequest(g,m){return S(m,"Accept"),S(m,"Content-Type"),f.isFormData(g)||f.isArrayBuffer(g)||f.isBuffer(g)||f.isStream(g)||f.isFile(g)||f.isBlob(g)?g:f.isArrayBufferView(g)?g.buffer:f.isURLSearchParams(g)?(setContentTypeIfUnset(m,"application/x-www-form-urlencoded;charset=utf-8"),g.toString()):f.isObject(g)?(setContentTypeIfUnset(m,"application/json;charset=utf-8"),JSON.stringify(g)):g}],transformResponse:[function transformResponse(g){if("string"==typeof g)try{g=JSON.parse(g)}catch(g){}return g}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,validateStatus:function validateStatus(g){return g>=200&&g<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};f.forEach(["delete","get","head"],(function forEachMethodNoData(g){C.headers[g]={}})),f.forEach(["post","put","patch"],(function forEachMethodWithData(g){C.headers[g]=f.merge(v)})),m.exports=C}}),z=__commonJS({"../node_modules/axios/lib/core/dispatchRequest.js"(g,m){var f=w(),S=O(),v=N(),C=q();function throwIfCancellationRequested(g){g.cancelToken&&g.cancelToken.throwIfRequested()}m.exports=function dispatchRequest(g){return throwIfCancellationRequested(g),g.headers=g.headers||{},g.data=S(g.data,g.headers,g.transformRequest),g.headers=f.merge(g.headers.common||{},g.headers[g.method]||{},g.headers),f.forEach(["delete","get","head","post","put","patch","common"],(function cleanHeaderConfig(m){delete g.headers[m]})),(g.adapter||C.adapter)(g).then((function onAdapterResolution(m){return throwIfCancellationRequested(g),m.data=S(m.data,m.headers,g.transformResponse),m}),(function onAdapterRejection(m){return v(m)||(throwIfCancellationRequested(g),m&&m.response&&(m.response.data=S(m.response.data,m.response.headers,g.transformResponse))),Promise.reject(m)}))}}}),K=__commonJS({"../node_modules/axios/lib/core/mergeConfig.js"(g,m){var f=w();m.exports=function mergeConfig(g,m){m=m||{};var S={},v=["url","method","params","data"],C=["headers","auth","proxy"],_=["baseURL","url","transformRequest","transformResponse","paramsSerializer","timeout","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","maxContentLength","validateStatus","maxRedirects","httpAgent","httpsAgent","cancelToken","socketPath"];f.forEach(v,(function valueFromConfig2(g){void 0!==m[g]&&(S[g]=m[g])})),f.forEach(C,(function mergeDeepProperties(v){f.isObject(m[v])?S[v]=f.deepMerge(g[v],m[v]):void 0!==m[v]?S[v]=m[v]:f.isObject(g[v])?S[v]=f.deepMerge(g[v]):void 0!==g[v]&&(S[v]=g[v])})),f.forEach(_,(function defaultToConfig2(f){void 0!==m[f]?S[f]=m[f]:void 0!==g[f]&&(S[f]=g[f])}));var E=v.concat(C).concat(_),T=Object.keys(m).filter((function filterAxiosKeys(g){return-1===E.indexOf(g)}));return f.forEach(T,(function otherKeysDefaultToConfig2(f){void 0!==m[f]?S[f]=m[f]:void 0!==g[f]&&(S[f]=g[f])})),S}}}),J=__commonJS({"../node_modules/axios/lib/core/Axios.js"(g,m){var f=w(),S=M(),v=D(),C=z(),_=K();function Axios(g){this.defaults=g,this.interceptors={request:new v,response:new v}}Axios.prototype.request=function request(g){"string"==typeof g?(g=arguments[1]||{}).url=arguments[0]:g=g||{},(g=_(this.defaults,g)).method?g.method=g.method.toLowerCase():this.defaults.method?g.method=this.defaults.method.toLowerCase():g.method="get";var m=[C,void 0],f=Promise.resolve(g);for(this.interceptors.request.forEach((function unshiftRequestInterceptors(g){m.unshift(g.fulfilled,g.rejected)})),this.interceptors.response.forEach((function pushResponseInterceptors(g){m.push(g.fulfilled,g.rejected)}));m.length;)f=f.then(m.shift(),m.shift());return f},Axios.prototype.getUri=function getUri(g){return g=_(this.defaults,g),S(g.url,g.params,g.paramsSerializer).replace(/^\?/,"")},f.forEach(["delete","get","head","options"],(function forEachMethodNoData(g){Axios.prototype[g]=function(m,S){return this.request(f.merge(S||{},{method:g,url:m}))}})),f.forEach(["post","put","patch"],(function forEachMethodWithData(g){Axios.prototype[g]=function(m,S,v){return this.request(f.merge(v||{},{method:g,url:m,data:S}))}})),m.exports=Axios}}),Y=__commonJS({"../node_modules/axios/lib/cancel/Cancel.js"(g,m){function Cancel(g){this.message=g}Cancel.prototype.toString=function toString(){return"Cancel"+(this.message?": "+this.message:"")},Cancel.prototype.__CANCEL__=!0,m.exports=Cancel}}),Q=__commonJS({"../node_modules/axios/lib/cancel/CancelToken.js"(g,m){var f=Y();function CancelToken(g){if("function"!=typeof g)throw new TypeError("executor must be a function.");var m;this.promise=new Promise((function promiseExecutor(g){m=g}));var S=this;g((function cancel(g){S.reason||(S.reason=new f(g),m(S.reason))}))}CancelToken.prototype.throwIfRequested=function throwIfRequested(){if(this.reason)throw this.reason},CancelToken.source=function source(){var g;return{token:new CancelToken((function executor(m){g=m})),cancel:g}},m.exports=CancelToken}}),X=__commonJS({"../node_modules/axios/lib/helpers/spread.js"(g,m){m.exports=function spread(g){return function wrap(m){return g.apply(null,m)}}}}),Z=__commonJS({"../node_modules/axios/lib/axios.js"(g,m){var f=w(),S=A(),v=J(),C=K();function createInstance(g){var m=new v(g),C=S(v.prototype.request,m);return f.extend(C,v.prototype,m),f.extend(C,m),C}var _=createInstance(q());_.Axios=v,_.create=function create(g){return createInstance(C(_.defaults,g))},_.Cancel=Y(),_.CancelToken=Q(),_.isCancel=N(),_.all=function all(g){return Promise.all(g)},_.spread=X(),m.exports=_,m.exports.default=_}}),ee=__commonJS({"../node_modules/axios/index.js"(g,m){m.exports=Z()}}),te=__commonJS({"../common/ts/ums/wasm/UMSTranscoder.js"(g){Object.defineProperty(g,"__esModule",{value:!0});var m=function(){return function(g){var m,f;void 0===g&&(g={}),(g=void 0!==g?g:{}).ready=new Promise((function(g,S){m=g,f=S}));var S,v,C=Object.assign({},g),_="./this.program",E=!0,T="";function locateFile(m){return g.locateFile?g.locateFile(m,T):T+m}"undefined"!=typeof document&&document.currentScript&&(T=document.currentScript.src),T=0!==T.indexOf("blob:")?T.substr(0,T.replace(/[?#].*/,"").lastIndexOf("/")+1):"",S=function(g){var m=new XMLHttpRequest;return m.open("GET",g,!1),m.send(null),m.responseText},v=function(g,m,f){var S=new XMLHttpRequest;S.open("GET",g,!0),S.responseType="arraybuffer",S.onload=function(){200==S.status||0==S.status&&S.response?m(S.response):f()},S.onerror=f,S.send(null)};var I,b=g.print||console.log.bind(console),A=g.printErr||console.warn.bind(console);Object.assign(g,C),C=null,g.arguments&&g.arguments,g.thisProgram&&(_=g.thisProgram),g.quit&&g.quit,g.wasmBinary&&(I=g.wasmBinary);var P;g.noExitRuntime;"object"!=typeof WebAssembly&&abort("no native wasm support detected");var R=!1;function assert3(g,m){g||abort(m)}var w,M,D,O,N,k="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function UTF8ArrayToString(g,m,f){for(var S=m+f,v=m;g[v]&&!(v>=S);)++v;if(v-m>16&&g.buffer&&k)return k.decode(g.subarray(m,v));for(var C="";m<v;){var _=g[m++];if(128&_){var E=63&g[m++];if(192!=(224&_)){var T=63&g[m++];if((_=224==(240&_)?(15&_)<<12|E<<6|T:(7&_)<<18|E<<12|T<<6|63&g[m++])<65536)C+=String.fromCharCode(_);else{var I=_-65536;C+=String.fromCharCode(55296|I>>10,56320|1023&I)}}else C+=String.fromCharCode((31&_)<<6|E)}else C+=String.fromCharCode(_)}return C}function UTF8ToString(g,m){return g?UTF8ArrayToString(M,g,m):""}function stringToUTF8Array(g,m,f,S){if(!(S>0))return 0;for(var v=f,C=f+S-1,_=0;_<g.length;++_){var E=g.charCodeAt(_);if(E>=55296&&E<=57343)E=65536+((1023&E)<<10)|1023&g.charCodeAt(++_);if(E<=127){if(f>=C)break;m[f++]=E}else if(E<=2047){if(f+1>=C)break;m[f++]=192|E>>6,m[f++]=128|63&E}else if(E<=65535){if(f+2>=C)break;m[f++]=224|E>>12,m[f++]=128|E>>6&63,m[f++]=128|63&E}else{if(f+3>=C)break;m[f++]=240|E>>18,m[f++]=128|E>>12&63,m[f++]=128|E>>6&63,m[f++]=128|63&E}}return m[f]=0,f-v}function lengthBytesUTF8(g){for(var m=0,f=0;f<g.length;++f){var S=g.charCodeAt(f);S<=127?m++:S<=2047?m+=2:S>=55296&&S<=57343?(m+=4,++f):m+=3}return m}function updateMemoryViews(){var m=P.buffer;g.HEAP8=w=new Int8Array(m),g.HEAP16=new Int16Array(m),g.HEAP32=D=new Int32Array(m),g.HEAPU8=M=new Uint8Array(m),g.HEAPU16=new Uint16Array(m),g.HEAPU32=O=new Uint32Array(m),g.HEAPF32=new Float32Array(m),g.HEAPF64=new Float64Array(m)}var L=[],F=[],x=[];function preRun(){if(g.preRun)for("function"==typeof g.preRun&&(g.preRun=[g.preRun]);g.preRun.length;)addOnPreRun(g.preRun.shift());callRuntimeCallbacks(L)}function initRuntime(){g.noFSInit||X.init.initialized||X.init(),X.ignorePermissions=!1,Y.init(),callRuntimeCallbacks(F)}function postRun(){if(g.postRun)for("function"==typeof g.postRun&&(g.postRun=[g.postRun]);g.postRun.length;)addOnPostRun(g.postRun.shift());callRuntimeCallbacks(x)}function addOnPreRun(g){L.unshift(g)}function addOnInit(g){F.unshift(g)}function addOnPostRun(g){x.unshift(g)}var U=0,V=null;function getUniqueRunDependency(g){return g}function addRunDependency(m){U++,g.monitorRunDependencies&&g.monitorRunDependencies(U)}function removeRunDependency(m){if(U--,g.monitorRunDependencies&&g.monitorRunDependencies(U),0==U&&V){var f=V;V=null,f()}}function abort(m){g.onAbort&&g.onAbort(m),A(m="Aborted("+m+")"),R=!0,m+=". Build with -sASSERTIONS for more info.";var S=new WebAssembly.RuntimeError(m);throw f(S),S}var B,H,$,G="data:application/octet-stream;base64,";function isDataURI(g){return g.startsWith(G)}function getBinary(g){try{if(g==B&&I)return new Uint8Array(I);throw"both async and sync fetching of the wasm failed"}catch(g){abort(g)}}function getBinaryPromise(g){return!I&&E&&"function"==typeof fetch?fetch(g,{credentials:"same-origin"}).then((function(m){if(!m.ok)throw"failed to load wasm binary file at '"+g+"'";return m.arrayBuffer()})).catch((function(){return getBinary(g)})):Promise.resolve().then((function(){return getBinary(g)}))}function instantiateArrayBuffer(g,m,f){return getBinaryPromise(g).then((function(g){return WebAssembly.instantiate(g,m)})).then((function(g){return g})).then(f,(function(g){A("failed to asynchronously prepare wasm: "+g),abort(g)}))}function instantiateAsync(g,m,f,S){return g||"function"!=typeof WebAssembly.instantiateStreaming||isDataURI(m)||"function"!=typeof fetch?instantiateArrayBuffer(m,f,S):fetch(m,{credentials:"same-origin"}).then((function(g){return WebAssembly.instantiateStreaming(g,f).then(S,(function(g){return A("wasm streaming compile failed: "+g),A("falling back to ArrayBuffer instantiation"),instantiateArrayBuffer(m,f,S)}))}))}function createWasm(){var m={a:oe};function receiveInstance(m,f){var S=m.exports;return g.asm=S,P=g.asm.q,updateMemoryViews(),N=g.asm.t,addOnInit(g.asm.r),removeRunDependency(),S}function receiveInstantiationResult(g){receiveInstance(g.instance)}if(addRunDependency(),g.instantiateWasm)try{return g.instantiateWasm(m,receiveInstance)}catch(g){A("Module.instantiateWasm callback failed with error: "+g),f(g)}return instantiateAsync(I,B,m,receiveInstantiationResult).catch(f),{}}function callRuntimeCallbacks(m){for(;m.length>0;)m.shift()(g)}function ___assert_fail(g,m,f,S){abort("Assertion failed: "+UTF8ToString(g)+", at: "+[m?UTF8ToString(m):"unknown filename",f,S?UTF8ToString(S):"unknown function"])}g.locateFile?isDataURI(B="UMSTranscoder.wasm")||(B=locateFile(B)):B=new URL("UMSTranscoder.wasm").href;var j=!0;function __emscripten_get_now_is_monotonic(){return j}function readI53FromI64(g){return O[g>>2]+4294967296*D[g+4>>2]}function __isLeapYear(g){return g%4==0&&(g%100!=0||g%400==0)}var W=[0,31,60,91,121,152,182,213,244,274,305,335],q=[0,31,59,90,120,151,181,212,243,273,304,334];function __yday_from_date(g){return(__isLeapYear(g.getFullYear())?W:q)[g.getMonth()]+g.getDate()-1}function __localtime_js(g,m){var f=new Date(1e3*readI53FromI64(g));D[m>>2]=f.getSeconds(),D[m+4>>2]=f.getMinutes(),D[m+8>>2]=f.getHours(),D[m+12>>2]=f.getDate(),D[m+16>>2]=f.getMonth(),D[m+20>>2]=f.getFullYear()-1900,D[m+24>>2]=f.getDay();var S=0|__yday_from_date(f);D[m+28>>2]=S,D[m+36>>2]=-60*f.getTimezoneOffset();var v=new Date(f.getFullYear(),0,1),C=new Date(f.getFullYear(),6,1).getTimezoneOffset(),_=v.getTimezoneOffset(),E=0|(C!=_&&f.getTimezoneOffset()==Math.min(_,C));D[m+32>>2]=E}function allocateUTF8(g){var m=lengthBytesUTF8(g)+1,f=le(m);return f&&stringToUTF8Array(g,w,f,m),f}function __tzset_js(g,m,f){var S=(new Date).getFullYear(),v=new Date(S,0,1),C=new Date(S,6,1),_=v.getTimezoneOffset(),E=C.getTimezoneOffset(),T=Math.max(_,E);function extractZone(g){var m=g.toTimeString().match(/\(([A-Za-z ]+)\)$/);return m?m[1]:"GMT"}O[g>>2]=60*T,D[m>>2]=Number(_!=E);var I=extractZone(v),b=extractZone(C),A=allocateUTF8(I),P=allocateUTF8(b);E<_?(O[f>>2]=A,O[f+4>>2]=P):(O[f>>2]=P,O[f+4>>2]=A)}function _abort(){abort("")}function _emscripten_date_now(){return Date.now()}function _emscripten_memcpy_big(g,m,f){M.copyWithin(g,m,m+f)}function getHeapMax(){return 2147483648}function emscripten_realloc_buffer(g){var m=P.buffer;try{return P.grow(g-m.byteLength+65535>>>16),updateMemoryViews(),1}catch(g){}}function _emscripten_resize_heap(g){var m=M.length;g>>>=0;var f=getHeapMax();if(g>f)return!1;for(var alignUp=function(g,m){return g+(m-g%m)%m},S=1;S<=4;S*=2){var v=m*(1+.2/S);if(v=Math.min(v,g+100663296),emscripten_realloc_buffer(Math.min(f,alignUp(Math.max(g,v),65536))))return!0}return!1}var z={};function getExecutableName(){return _||"./this.program"}function getEnvStrings(){if(!getEnvStrings.strings){var g={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:getExecutableName()};for(var m in z)void 0===z[m]?delete g[m]:g[m]=z[m];var f=[];for(var m in g)f.push(m+"="+g[m]);getEnvStrings.strings=f}return getEnvStrings.strings}function writeAsciiToMemory(g,m,f){for(var S=0;S<g.length;++S)w[m++>>0]=g.charCodeAt(S);f||(w[m>>0]=0)}var K={isAbs:function(g){return"/"===g.charAt(0)},splitPath:function(g){return/^(\/?|)([\s\S]*?)((?:\.{1,2}|[^\/]+?|)(\.[^.\/]*|))(?:[\/]*)$/.exec(g).slice(1)},normalizeArray:function(g,m){for(var f=0,S=g.length-1;S>=0;S--){var v=g[S];"."===v?g.splice(S,1):".."===v?(g.splice(S,1),f++):f&&(g.splice(S,1),f--)}if(m)for(;f;f--)g.unshift("..");return g},normalize:function(g){var m=K.isAbs(g),f="/"===g.substr(-1);return(g=K.normalizeArray(g.split("/").filter((function(g){return!!g})),!m).join("/"))||m||(g="."),g&&f&&(g+="/"),(m?"/":"")+g},dirname:function(g){var m=K.splitPath(g),f=m[0],S=m[1];return f||S?(S&&(S=S.substr(0,S.length-1)),f+S):"."},basename:function(g){if("/"===g)return"/";var m=(g=(g=K.normalize(g)).replace(/\/$/,"")).lastIndexOf("/");return-1===m?g:g.substr(m+1)},join:function(){var g=Array.prototype.slice.call(arguments);return K.normalize(g.join("/"))},join2:function(g,m){return K.normalize(g+"/"+m)}};function getRandomDevice(){if("object"==typeof crypto&&"function"==typeof crypto.getRandomValues){var g=new Uint8Array(1);return function(){return crypto.getRandomValues(g),g[0]}}return function(){return abort("randomDevice")}}var J={resolve:function(){for(var g="",m=!1,f=arguments.length-1;f>=-1&&!m;f--){var S=f>=0?arguments[f]:X.cwd();if("string"!=typeof S)throw new TypeError("Arguments to path.resolve must be strings");if(!S)return"";g=S+"/"+g,m=K.isAbs(S)}return(m?"/":"")+(g=K.normalizeArray(g.split("/").filter((function(g){return!!g})),!m).join("/"))||"."},relative:function(g,m){function trim2(g){for(var m=0;m<g.length&&""===g[m];m++);for(var f=g.length-1;f>=0&&""===g[f];f--);return m>f?[]:g.slice(m,f-m+1)}g=J.resolve(g).substr(1),m=J.resolve(m).substr(1);for(var f=trim2(g.split("/")),S=trim2(m.split("/")),v=Math.min(f.length,S.length),C=v,_=0;_<v;_++)if(f[_]!==S[_]){C=_;break}var E=[];for(_=C;_<f.length;_++)E.push("..");return(E=E.concat(S.slice(C))).join("/")}};function intArrayFromString(g,m,f){var S=f>0?f:lengthBytesUTF8(g)+1,v=new Array(S),C=stringToUTF8Array(g,v,0,v.length);return m&&(v.length=C),v}var Y={ttys:[],init:function(){},shutdown:function(){},register:function(g,m){Y.ttys[g]={input:[],output:[],ops:m},X.registerDevice(g,Y.stream_ops)},stream_ops:{open:function(g){var m=Y.ttys[g.node.rdev];if(!m)throw new X.ErrnoError(43);g.tty=m,g.seekable=!1},close:function(g){g.tty.ops.fsync(g.tty)},fsync:function(g){g.tty.ops.fsync(g.tty)},read:function(g,m,f,S,v){if(!g.tty||!g.tty.ops.get_char)throw new X.ErrnoError(60);for(var C=0,_=0;_<S;_++){var E;try{E=g.tty.ops.get_char(g.tty)}catch(g){throw new X.ErrnoError(29)}if(void 0===E&&0===C)throw new X.ErrnoError(6);if(null==E)break;C++,m[f+_]=E}return C&&(g.node.timestamp=Date.now()),C},write:function(g,m,f,S,v){if(!g.tty||!g.tty.ops.put_char)throw new X.ErrnoError(60);try{for(var C=0;C<S;C++)g.tty.ops.put_char(g.tty,m[f+C])}catch(g){throw new X.ErrnoError(29)}return S&&(g.node.timestamp=Date.now()),C}},default_tty_ops:{get_char:function(g){if(!g.input.length){var m=null;if("undefined"!=typeof window&&"function"==typeof window.prompt?null!==(m=window.prompt("Input: "))&&(m+="\n"):"function"==typeof readline&&null!==(m=readline())&&(m+="\n"),!m)return null;g.input=intArrayFromString(m,!0)}return g.input.shift()},put_char:function(g,m){null===m||10===m?(b(UTF8ArrayToString(g.output,0)),g.output=[]):0!=m&&g.output.push(m)},fsync:function(g){g.output&&g.output.length>0&&(b(UTF8ArrayToString(g.output,0)),g.output=[])}},default_tty1_ops:{put_char:function(g,m){null===m||10===m?(A(UTF8ArrayToString(g.output,0)),g.output=[]):0!=m&&g.output.push(m)},fsync:function(g){g.output&&g.output.length>0&&(A(UTF8ArrayToString(g.output,0)),g.output=[])}}};function mmapAlloc(g){abort()}var Q={ops_table:null,mount:function(g){return Q.createNode(null,"/",16895,0)},createNode:function(g,m,f,S){if(X.isBlkdev(f)||X.isFIFO(f))throw new X.ErrnoError(63);Q.ops_table||(Q.ops_table={dir:{node:{getattr:Q.node_ops.getattr,setattr:Q.node_ops.setattr,lookup:Q.node_ops.lookup,mknod:Q.node_ops.mknod,rename:Q.node_ops.rename,unlink:Q.node_ops.unlink,rmdir:Q.node_ops.rmdir,readdir:Q.node_ops.readdir,symlink:Q.node_ops.symlink},stream:{llseek:Q.stream_ops.llseek}},file:{node:{getattr:Q.node_ops.getattr,setattr:Q.node_ops.setattr},stream:{llseek:Q.stream_ops.llseek,read:Q.stream_ops.read,write:Q.stream_ops.write,allocate:Q.stream_ops.allocate,mmap:Q.stream_ops.mmap,msync:Q.stream_ops.msync}},link:{node:{getattr:Q.node_ops.getattr,setattr:Q.node_ops.setattr,readlink:Q.node_ops.readlink},stream:{}},chrdev:{node:{getattr:Q.node_ops.getattr,setattr:Q.node_ops.setattr},stream:X.chrdev_stream_ops}});var v=X.createNode(g,m,f,S);return X.isDir(v.mode)?(v.node_ops=Q.ops_table.dir.node,v.stream_ops=Q.ops_table.dir.stream,v.contents={}):X.isFile(v.mode)?(v.node_ops=Q.ops_table.file.node,v.stream_ops=Q.ops_table.file.stream,v.usedBytes=0,v.contents=null):X.isLink(v.mode)?(v.node_ops=Q.ops_table.link.node,v.stream_ops=Q.ops_table.link.stream):X.isChrdev(v.mode)&&(v.node_ops=Q.ops_table.chrdev.node,v.stream_ops=Q.ops_table.chrdev.stream),v.timestamp=Date.now(),g&&(g.contents[m]=v,g.timestamp=v.timestamp),v},getFileDataAsTypedArray:function(g){return g.contents?g.contents.subarray?g.contents.subarray(0,g.usedBytes):new Uint8Array(g.contents):new Uint8Array(0)},expandFileStorage:function(g,m){var f=g.contents?g.contents.length:0;if(!(f>=m)){var S=1048576;m=Math.max(m,f*(f<S?2:1.125)>>>0),0!=f&&(m=Math.max(m,256));var v=g.contents;g.contents=new Uint8Array(m),g.usedBytes>0&&g.contents.set(v.subarray(0,g.usedBytes),0)}},resizeFileStorage:function(g,m){if(g.usedBytes!=m)if(0==m)g.contents=null,g.usedBytes=0;else{var f=g.contents;g.contents=new Uint8Array(m),f&&g.contents.set(f.subarray(0,Math.min(m,g.usedBytes))),g.usedBytes=m}},node_ops:{getattr:function(g){var m={};return m.dev=X.isChrdev(g.mode)?g.id:1,m.ino=g.id,m.mode=g.mode,m.nlink=1,m.uid=0,m.gid=0,m.rdev=g.rdev,X.isDir(g.mode)?m.size=4096:X.isFile(g.mode)?m.size=g.usedBytes:X.isLink(g.mode)?m.size=g.link.length:m.size=0,m.atime=new Date(g.timestamp),m.mtime=new Date(g.timestamp),m.ctime=new Date(g.timestamp),m.blksize=4096,m.blocks=Math.ceil(m.size/m.blksize),m},setattr:function(g,m){void 0!==m.mode&&(g.mode=m.mode),void 0!==m.timestamp&&(g.timestamp=m.timestamp),void 0!==m.size&&Q.resizeFileStorage(g,m.size)},lookup:function(g,m){throw X.genericErrors[44]},mknod:function(g,m,f,S){return Q.createNode(g,m,f,S)},rename:function(g,m,f){if(X.isDir(g.mode)){var S;try{S=X.lookupNode(m,f)}catch(g){}if(S)for(var v in S.contents)throw new X.ErrnoError(55)}delete g.parent.contents[g.name],g.parent.timestamp=Date.now(),g.name=f,m.contents[f]=g,m.timestamp=g.parent.timestamp,g.parent=m},unlink:function(g,m){delete g.contents[m],g.timestamp=Date.now()},rmdir:function(g,m){var f=X.lookupNode(g,m);for(var S in f.contents)throw new X.ErrnoError(55);delete g.contents[m],g.timestamp=Date.now()},readdir:function(g){var m=[".",".."];for(var f in g.contents)g.contents.hasOwnProperty(f)&&m.push(f);return m},symlink:function(g,m,f){var S=Q.createNode(g,m,41471,0);return S.link=f,S},readlink:function(g){if(!X.isLink(g.mode))throw new X.ErrnoError(28);return g.link}},stream_ops:{read:function(g,m,f,S,v){var C=g.node.contents;if(v>=g.node.usedBytes)return 0;var _=Math.min(g.node.usedBytes-v,S);if(_>8&&C.subarray)m.set(C.subarray(v,v+_),f);else for(var E=0;E<_;E++)m[f+E]=C[v+E];return _},write:function(g,m,f,S,v,C){if(m.buffer===w.buffer&&(C=!1),!S)return 0;var _=g.node;if(_.timestamp=Date.now(),m.subarray&&(!_.contents||_.contents.subarray)){if(C)return _.contents=m.subarray(f,f+S),_.usedBytes=S,S;if(0===_.usedBytes&&0===v)return _.contents=m.slice(f,f+S),_.usedBytes=S,S;if(v+S<=_.usedBytes)return _.contents.set(m.subarray(f,f+S),v),S}if(Q.expandFileStorage(_,v+S),_.contents.subarray&&m.subarray)_.contents.set(m.subarray(f,f+S),v);else for(var E=0;E<S;E++)_.contents[v+E]=m[f+E];return _.usedBytes=Math.max(_.usedBytes,v+S),S},llseek:function(g,m,f){var S=m;if(1===f?S+=g.position:2===f&&X.isFile(g.node.mode)&&(S+=g.node.usedBytes),S<0)throw new X.ErrnoError(28);return S},allocate:function(g,m,f){Q.expandFileStorage(g.node,m+f),g.node.usedBytes=Math.max(g.node.usedBytes,m+f)},mmap:function(g,m,f,S,v){if(!X.isFile(g.node.mode))throw new X.ErrnoError(43);var C,_,E=g.node.contents;if(2&v||E.buffer!==w.buffer){if((f>0||f+m<E.length)&&(E=E.subarray?E.subarray(f,f+m):Array.prototype.slice.call(E,f,f+m)),_=!0,!(C=mmapAlloc()))throw new X.ErrnoError(48);w.set(E,C)}else _=!1,C=E.byteOffset;return{ptr:C,allocated:_}},msync:function(g,m,f,S,v){return Q.stream_ops.write(g,m,0,S,f,!1),0}}};function asyncLoad(g,m,f,S){var C=S?"":getUniqueRunDependency("al "+g);v(g,(function(f){assert3(f,'Loading data file "'+g+'" failed (no arrayBuffer).'),m(new Uint8Array(f)),C&&removeRunDependency()}),(function(m){if(!f)throw'Loading data file "'+g+'" failed.';f()})),C&&addRunDependency()}var X={root:null,mounts:[],devices:{},streams:[],nextInode:1,nameTable:null,currentPath:"/",initialized:!1,ignorePermissions:!0,ErrnoError:null,genericErrors:{},filesystems:null,syncFSRequests:0,lookupPath:function(g,m){if(void 0===m&&(m={}),!(g=J.resolve(g)))return{path:"",node:null};var f={follow_mount:!0,recurse_count:0};if((m=Object.assign(f,m)).recurse_count>8)throw new X.ErrnoError(32);for(var S=g.split("/").filter((function(g){return!!g})),v=X.root,C="/",_=0;_<S.length;_++){var E=_===S.length-1;if(E&&m.parent)break;if(v=X.lookupNode(v,S[_]),C=K.join2(C,S[_]),X.isMountpoint(v)&&(!E||E&&m.follow_mount)&&(v=v.mounted.root),!E||m.follow)for(var T=0;X.isLink(v.mode);){var I=X.readlink(C);if(C=J.resolve(K.dirname(C),I),v=X.lookupPath(C,{recurse_count:m.recurse_count+1}).node,T++>40)throw new X.ErrnoError(32)}}return{path:C,node:v}},getPath:function(g){for(var m;;){if(X.isRoot(g)){var f=g.mount.mountpoint;return m?"/"!==f[f.length-1]?f+"/"+m:f+m:f}m=m?g.name+"/"+m:g.name,g=g.parent}},hashName:function(g,m){for(var f=0,S=0;S<m.length;S++)f=(f<<5)-f+m.charCodeAt(S)|0;return(g+f>>>0)%X.nameTable.length},hashAddNode:function(g){var m=X.hashName(g.parent.id,g.name);g.name_next=X.nameTable[m],X.nameTable[m]=g},hashRemoveNode:function(g){var m=X.hashName(g.parent.id,g.name);if(X.nameTable[m]===g)X.nameTable[m]=g.name_next;else for(var f=X.nameTable[m];f;){if(f.name_next===g){f.name_next=g.name_next;break}f=f.name_next}},lookupNode:function(g,m){var f=X.mayLookup(g);if(f)throw new X.ErrnoError(f,g);for(var S=X.hashName(g.id,m),v=X.nameTable[S];v;v=v.name_next){var C=v.name;if(v.parent.id===g.id&&C===m)return v}return X.lookup(g,m)},createNode:function(g,m,f,S){var v=new X.FSNode(g,m,f,S);return X.hashAddNode(v),v},destroyNode:function(g){X.hashRemoveNode(g)},isRoot:function(g){return g===g.parent},isMountpoint:function(g){return!!g.mounted},isFile:function(g){return 32768==(61440&g)},isDir:function(g){return 16384==(61440&g)},isLink:function(g){return 40960==(61440&g)},isChrdev:function(g){return 8192==(61440&g)},isBlkdev:function(g){return 24576==(61440&g)},isFIFO:function(g){return 4096==(61440&g)},isSocket:function(g){return 49152==(49152&g)},flagModes:{r:0,"r+":2,w:577,"w+":578,a:1089,"a+":1090},modeStringToFlags:function(g){var m=X.flagModes[g];if(void 0===m)throw new Error("Unknown file open mode: "+g);return m},flagsToPermissionString:function(g){var m=["r","w","rw"][3&g];return 512&g&&(m+="w"),m},nodePermissions:function(g,m){return X.ignorePermissions||(!m.includes("r")||292&g.mode)&&(!m.includes("w")||146&g.mode)&&(!m.includes("x")||73&g.mode)?0:2},mayLookup:function(g){var m=X.nodePermissions(g,"x");return m||(g.node_ops.lookup?0:2)},mayCreate:function(g,m){try{X.lookupNode(g,m);return 20}catch(g){}return X.nodePermissions(g,"wx")},mayDelete:function(g,m,f){var S;try{S=X.lookupNode(g,m)}catch(g){return g.errno}var v=X.nodePermissions(g,"wx");if(v)return v;if(f){if(!X.isDir(S.mode))return 54;if(X.isRoot(S)||X.getPath(S)===X.cwd())return 10}else if(X.isDir(S.mode))return 31;return 0},mayOpen:function(g,m){return g?X.isLink(g.mode)?32:X.isDir(g.mode)&&("r"!==X.flagsToPermissionString(m)||512&m)?31:X.nodePermissions(g,X.flagsToPermissionString(m)):44},MAX_OPEN_FDS:4096,nextfd:function(g,m){void 0===g&&(g=0),void 0===m&&(m=X.MAX_OPEN_FDS);for(var f=g;f<=m;f++)if(!X.streams[f])return f;throw new X.ErrnoError(33)},getStream:function(g){return X.streams[g]},createStream:function(g,m,f){X.FSStream||(X.FSStream=function(){this.shared={}},X.FSStream.prototype={},Object.defineProperties(X.FSStream.prototype,{object:{get:function(){return this.node},set:function(g){this.node=g}},isRead:{get:function(){return 1!=(2097155&this.flags)}},isWrite:{get:function(){return 0!=(2097155&this.flags)}},isAppend:{get:function(){return 1024&this.flags}},flags:{get:function(){return this.shared.flags},set:function(g){this.shared.flags=g}},position:{get:function(){return this.shared.position},set:function(g){this.shared.position=g}}})),g=Object.assign(new X.FSStream,g);var S=X.nextfd(m,f);return g.fd=S,X.streams[S]=g,g},closeStream:function(g){X.streams[g]=null},chrdev_stream_ops:{open:function(g){var m=X.getDevice(g.node.rdev);g.stream_ops=m.stream_ops,g.stream_ops.open&&g.stream_ops.open(g)},llseek:function(){throw new X.ErrnoError(70)}},major:function(g){return g>>8},minor:function(g){return 255&g},makedev:function(g,m){return g<<8|m},registerDevice:function(g,m){X.devices[g]={stream_ops:m}},getDevice:function(g){return X.devices[g]},getMounts:function(g){for(var m=[],f=[g];f.length;){var S=f.pop();m.push(S),f.push.apply(f,S.mounts)}return m},syncfs:function(g,m){"function"==typeof g&&(m=g,g=!1),X.syncFSRequests++,X.syncFSRequests>1&&A("warning: "+X.syncFSRequests+" FS.syncfs operations in flight at once, probably just doing extra work");var f=X.getMounts(X.root.mount),S=0;function doCallback(g){return X.syncFSRequests--,m(g)}function done(g){if(g)return done.errored?void 0:(done.errored=!0,doCallback(g));++S>=f.length&&doCallback(null)}f.forEach((function(m){if(!m.type.syncfs)return done(null);m.type.syncfs(m,g,done)}))},mount:function(g,m,f){var S,v="/"===f,C=!f;if(v&&X.root)throw new X.ErrnoError(10);if(!v&&!C){var _=X.lookupPath(f,{follow_mount:!1});if(f=_.path,S=_.node,X.isMountpoint(S))throw new X.ErrnoError(10);if(!X.isDir(S.mode))throw new X.ErrnoError(54)}var E={type:g,opts:m,mountpoint:f,mounts:[]},T=g.mount(E);return T.mount=E,E.root=T,v?X.root=T:S&&(S.mounted=E,S.mount&&S.mount.mounts.push(E)),T},unmount:function(g){var m=X.lookupPath(g,{follow_mount:!1});if(!X.isMountpoint(m.node))throw new X.ErrnoError(28);var f=m.node,S=f.mounted,v=X.getMounts(S);Object.keys(X.nameTable).forEach((function(g){for(var m=X.nameTable[g];m;){var f=m.name_next;v.includes(m.mount)&&X.destroyNode(m),m=f}})),f.mounted=null;var C=f.mount.mounts.indexOf(S);f.mount.mounts.splice(C,1)},lookup:function(g,m){return g.node_ops.lookup(g,m)},mknod:function(g,m,f){var S=X.lookupPath(g,{parent:!0}).node,v=K.basename(g);if(!v||"."===v||".."===v)throw new X.ErrnoError(28);var C=X.mayCreate(S,v);if(C)throw new X.ErrnoError(C);if(!S.node_ops.mknod)throw new X.ErrnoError(63);return S.node_ops.mknod(S,v,m,f)},create:function(g,m){return m=void 0!==m?m:438,m&=4095,m|=32768,X.mknod(g,m,0)},mkdir:function(g,m){return m=void 0!==m?m:511,m&=1023,m|=16384,X.mknod(g,m,0)},mkdirTree:function(g,m){for(var f=g.split("/"),S="",v=0;v<f.length;++v)if(f[v]){S+="/"+f[v];try{X.mkdir(S,m)}catch(g){if(20!=g.errno)throw g}}},mkdev:function(g,m,f){return void 0===f&&(f=m,m=438),m|=8192,X.mknod(g,m,f)},symlink:function(g,m){if(!J.resolve(g))throw new X.ErrnoError(44);var f=X.lookupPath(m,{parent:!0}).node;if(!f)throw new X.ErrnoError(44);var S=K.basename(m),v=X.mayCreate(f,S);if(v)throw new X.ErrnoError(v);if(!f.node_ops.symlink)throw new X.ErrnoError(63);return f.node_ops.symlink(f,S,g)},rename:function(g,m){var f,S,v=K.dirname(g),C=K.dirname(m),_=K.basename(g),E=K.basename(m);if(f=X.lookupPath(g,{parent:!0}).node,S=X.lookupPath(m,{parent:!0}).node,!f||!S)throw new X.ErrnoError(44);if(f.mount!==S.mount)throw new X.ErrnoError(75);var T,I=X.lookupNode(f,_),b=J.relative(g,C);if("."!==b.charAt(0))throw new X.ErrnoError(28);if("."!==(b=J.relative(m,v)).charAt(0))throw new X.ErrnoError(55);try{T=X.lookupNode(S,E)}catch(g){}if(I!==T){var A=X.isDir(I.mode),P=X.mayDelete(f,_,A);if(P)throw new X.ErrnoError(P);if(P=T?X.mayDelete(S,E,A):X.mayCreate(S,E))throw new X.ErrnoError(P);if(!f.node_ops.rename)throw new X.ErrnoError(63);if(X.isMountpoint(I)||T&&X.isMountpoint(T))throw new X.ErrnoError(10);if(S!==f&&(P=X.nodePermissions(f,"w")))throw new X.ErrnoError(P);X.hashRemoveNode(I);try{f.node_ops.rename(I,S,E)}catch(g){throw g}finally{X.hashAddNode(I)}}},rmdir:function(g){var m=X.lookupPath(g,{parent:!0}).node,f=K.basename(g),S=X.lookupNode(m,f),v=X.mayDelete(m,f,!0);if(v)throw new X.ErrnoError(v);if(!m.node_ops.rmdir)throw new X.ErrnoError(63);if(X.isMountpoint(S))throw new X.ErrnoError(10);m.node_ops.rmdir(m,f),X.destroyNode(S)},readdir:function(g){var m=X.lookupPath(g,{follow:!0}).node;if(!m.node_ops.readdir)throw new X.ErrnoError(54);return m.node_ops.readdir(m)},unlink:function(g){var m=X.lookupPath(g,{parent:!0}).node;if(!m)throw new X.ErrnoError(44);var f=K.basename(g),S=X.lookupNode(m,f),v=X.mayDelete(m,f,!1);if(v)throw new X.ErrnoError(v);if(!m.node_ops.unlink)throw new X.ErrnoError(63);if(X.isMountpoint(S))throw new X.ErrnoError(10);m.node_ops.unlink(m,f),X.destroyNode(S)},readlink:function(g){var m=X.lookupPath(g).node;if(!m)throw new X.ErrnoError(44);if(!m.node_ops.readlink)throw new X.ErrnoError(28);return J.resolve(X.getPath(m.parent),m.node_ops.readlink(m))},stat:function(g,m){var f=X.lookupPath(g,{follow:!m}).node;if(!f)throw new X.ErrnoError(44);if(!f.node_ops.getattr)throw new X.ErrnoError(63);return f.node_ops.getattr(f)},lstat:function(g){return X.stat(g,!0)},chmod:function(g,m,f){var S;"string"==typeof g?S=X.lookupPath(g,{follow:!f}).node:S=g;if(!S.node_ops.setattr)throw new X.ErrnoError(63);S.node_ops.setattr(S,{mode:4095&m|-4096&S.mode,timestamp:Date.now()})},lchmod:function(g,m){X.chmod(g,m,!0)},fchmod:function(g,m){var f=X.getStream(g);if(!f)throw new X.ErrnoError(8);X.chmod(f.node,m)},chown:function(g,m,f,S){var v;"string"==typeof g?v=X.lookupPath(g,{follow:!S}).node:v=g;if(!v.node_ops.setattr)throw new X.ErrnoError(63);v.node_ops.setattr(v,{timestamp:Date.now()})},lchown:function(g,m,f){X.chown(g,m,f,!0)},fchown:function(g,m,f){var S=X.getStream(g);if(!S)throw new X.ErrnoError(8);X.chown(S.node,m,f)},truncate:function(g,m){if(m<0)throw new X.ErrnoError(28);var f;"string"==typeof g?f=X.lookupPath(g,{follow:!0}).node:f=g;if(!f.node_ops.setattr)throw new X.ErrnoError(63);if(X.isDir(f.mode))throw new X.ErrnoError(31);if(!X.isFile(f.mode))throw new X.ErrnoError(28);var S=X.nodePermissions(f,"w");if(S)throw new X.ErrnoError(S);f.node_ops.setattr(f,{size:m,timestamp:Date.now()})},ftruncate:function(g,m){var f=X.getStream(g);if(!f)throw new X.ErrnoError(8);if(0==(2097155&f.flags))throw new X.ErrnoError(28);X.truncate(f.node,m)},utime:function(g,m,f){var S=X.lookupPath(g,{follow:!0}).node;S.node_ops.setattr(S,{timestamp:Math.max(m,f)})},open:function(m,f,S){if(""===m)throw new X.ErrnoError(44);var v;if(S=void 0===S?438:S,S=64&(f="string"==typeof f?X.modeStringToFlags(f):f)?4095&S|32768:0,"object"==typeof m)v=m;else{m=K.normalize(m);try{v=X.lookupPath(m,{follow:!(131072&f)}).node}catch(g){}}var C=!1;if(64&f)if(v){if(128&f)throw new X.ErrnoError(20)}else v=X.mknod(m,S,0),C=!0;if(!v)throw new X.ErrnoError(44);if(X.isChrdev(v.mode)&&(f&=-513),65536&f&&!X.isDir(v.mode))throw new X.ErrnoError(54);if(!C){var _=X.mayOpen(v,f);if(_)throw new X.ErrnoError(_)}512&f&&!C&&X.truncate(v,0),f&=-131713;var E=X.createStream({node:v,path:X.getPath(v),flags:f,seekable:!0,position:0,stream_ops:v.stream_ops,ungotten:[],error:!1});return E.stream_ops.open&&E.stream_ops.open(E),!g.logReadFiles||1&f||(X.readFiles||(X.readFiles={}),m in X.readFiles||(X.readFiles[m]=1)),E},close:function(g){if(X.isClosed(g))throw new X.ErrnoError(8);g.getdents&&(g.getdents=null);try{g.stream_ops.close&&g.stream_ops.close(g)}catch(g){throw g}finally{X.closeStream(g.fd)}g.fd=null},isClosed:function(g){return null===g.fd},llseek:function(g,m,f){if(X.isClosed(g))throw new X.ErrnoError(8);if(!g.seekable||!g.stream_ops.llseek)throw new X.ErrnoError(70);if(0!=f&&1!=f&&2!=f)throw new X.ErrnoError(28);return g.position=g.stream_ops.llseek(g,m,f),g.ungotten=[],g.position},read:function(g,m,f,S,v){if(S<0||v<0)throw new X.ErrnoError(28);if(X.isClosed(g))throw new X.ErrnoError(8);if(1==(2097155&g.flags))throw new X.ErrnoError(8);if(X.isDir(g.node.mode))throw new X.ErrnoError(31);if(!g.stream_ops.read)throw new X.ErrnoError(28);var C=void 0!==v;if(C){if(!g.seekable)throw new X.ErrnoError(70)}else v=g.position;var _=g.stream_ops.read(g,m,f,S,v);return C||(g.position+=_),_},write:function(g,m,f,S,v,C){if(S<0||v<0)throw new X.ErrnoError(28);if(X.isClosed(g))throw new X.ErrnoError(8);if(0==(2097155&g.flags))throw new X.ErrnoError(8);if(X.isDir(g.node.mode))throw new X.ErrnoError(31);if(!g.stream_ops.write)throw new X.ErrnoError(28);g.seekable&&1024&g.flags&&X.llseek(g,0,2);var _=void 0!==v;if(_){if(!g.seekable)throw new X.ErrnoError(70)}else v=g.position;var E=g.stream_ops.write(g,m,f,S,v,C);return _||(g.position+=E),E},allocate:function(g,m,f){if(X.isClosed(g))throw new X.ErrnoError(8);if(m<0||f<=0)throw new X.ErrnoError(28);if(0==(2097155&g.flags))throw new X.ErrnoError(8);if(!X.isFile(g.node.mode)&&!X.isDir(g.node.mode))throw new X.ErrnoError(43);if(!g.stream_ops.allocate)throw new X.ErrnoError(138);g.stream_ops.allocate(g,m,f)},mmap:function(g,m,f,S,v){if(0!=(2&S)&&0==(2&v)&&2!=(2097155&g.flags))throw new X.ErrnoError(2);if(1==(2097155&g.flags))throw new X.ErrnoError(2);if(!g.stream_ops.mmap)throw new X.ErrnoError(43);return g.stream_ops.mmap(g,m,f,S,v)},msync:function(g,m,f,S,v){return g.stream_ops.msync?g.stream_ops.msync(g,m,f,S,v):0},munmap:function(g){return 0},ioctl:function(g,m,f){if(!g.stream_ops.ioctl)throw new X.ErrnoError(59);return g.stream_ops.ioctl(g,m,f)},readFile:function(g,m){if(void 0===m&&(m={}),m.flags=m.flags||0,m.encoding=m.encoding||"binary","utf8"!==m.encoding&&"binary"!==m.encoding)throw new Error('Invalid encoding type "'+m.encoding+'"');var f,S=X.open(g,m.flags),v=X.stat(g).size,C=new Uint8Array(v);return X.read(S,C,0,v,0),"utf8"===m.encoding?f=UTF8ArrayToString(C,0):"binary"===m.encoding&&(f=C),X.close(S),f},writeFile:function(g,m,f){void 0===f&&(f={}),f.flags=f.flags||577;var S=X.open(g,f.flags,f.mode);if("string"==typeof m){var v=new Uint8Array(lengthBytesUTF8(m)+1),C=stringToUTF8Array(m,v,0,v.length);X.write(S,v,0,C,void 0,f.canOwn)}else{if(!ArrayBuffer.isView(m))throw new Error("Unsupported data type");X.write(S,m,0,m.byteLength,void 0,f.canOwn)}X.close(S)},cwd:function(){return X.currentPath},chdir:function(g){var m=X.lookupPath(g,{follow:!0});if(null===m.node)throw new X.ErrnoError(44);if(!X.isDir(m.node.mode))throw new X.ErrnoError(54);var f=X.nodePermissions(m.node,"x");if(f)throw new X.ErrnoError(f);X.currentPath=m.path},createDefaultDirectories:function(){X.mkdir("/tmp"),X.mkdir("/home"),X.mkdir("/home/web_user")},createDefaultDevices:function(){X.mkdir("/dev"),X.registerDevice(X.makedev(1,3),{read:function(){return 0},write:function(g,m,f,S,v){return S}}),X.mkdev("/dev/null",X.makedev(1,3)),Y.register(X.makedev(5,0),Y.default_tty_ops),Y.register(X.makedev(6,0),Y.default_tty1_ops),X.mkdev("/dev/tty",X.makedev(5,0)),X.mkdev("/dev/tty1",X.makedev(6,0));var g=getRandomDevice();X.createDevice("/dev","random",g),X.createDevice("/dev","urandom",g),X.mkdir("/dev/shm"),X.mkdir("/dev/shm/tmp")},createSpecialDirectories:function(){X.mkdir("/proc");var g=X.mkdir("/proc/self");X.mkdir("/proc/self/fd"),X.mount({mount:function(){var m=X.createNode(g,"fd",16895,73);return m.node_ops={lookup:function(g,m){var f=+m,S=X.getStream(f);if(!S)throw new X.ErrnoError(8);var v={parent:null,mount:{mountpoint:"fake"},node_ops:{readlink:function(){return S.path}}};return v.parent=v,v}},m}},{},"/proc/self/fd")},createStandardStreams:function(){g.stdin?X.createDevice("/dev","stdin",g.stdin):X.symlink("/dev/tty","/dev/stdin"),g.stdout?X.createDevice("/dev","stdout",null,g.stdout):X.symlink("/dev/tty","/dev/stdout"),g.stderr?X.createDevice("/dev","stderr",null,g.stderr):X.symlink("/dev/tty1","/dev/stderr");X.open("/dev/stdin",0),X.open("/dev/stdout",1),X.open("/dev/stderr",1)},ensureErrnoError:function(){X.ErrnoError||(X.ErrnoError=function ErrnoError(g,m){this.name="ErrnoError",this.node=m,this.setErrno=function(g){this.errno=g},this.setErrno(g),this.message="FS error"},X.ErrnoError.prototype=new Error,X.ErrnoError.prototype.constructor=X.ErrnoError,[44].forEach((function(g){X.genericErrors[g]=new X.ErrnoError(g),X.genericErrors[g].stack="<generic error, no stack>"})))},staticInit:function(){X.ensureErrnoError(),X.nameTable=new Array(4096),X.mount(Q,{},"/"),X.createDefaultDirectories(),X.createDefaultDevices(),X.createSpecialDirectories(),X.filesystems={MEMFS:Q}},init:function(m,f,S){X.init.initialized=!0,X.ensureErrnoError(),g.stdin=m||g.stdin,g.stdout=f||g.stdout,g.stderr=S||g.stderr,X.createStandardStreams()},quit:function(){X.init.initialized=!1;for(var g=0;g<X.streams.length;g++){var m=X.streams[g];m&&X.close(m)}},getMode:function(g,m){var f=0;return g&&(f|=365),m&&(f|=146),f},findObject:function(g,m){var f=X.analyzePath(g,m);return f.exists?f.object:null},analyzePath:function(g,m){try{g=(S=X.lookupPath(g,{follow:!m})).path}catch(g){}var f={isRoot:!1,exists:!1,error:0,name:null,path:null,object:null,parentExists:!1,parentPath:null,parentObject:null};try{var S=X.lookupPath(g,{parent:!0});f.parentExists=!0,f.parentPath=S.path,f.parentObject=S.node,f.name=K.basename(g),S=X.lookupPath(g,{follow:!m}),f.exists=!0,f.path=S.path,f.object=S.node,f.name=S.node.name,f.isRoot="/"===S.path}catch(g){f.error=g.errno}return f},createPath:function(g,m,f,S){g="string"==typeof g?g:X.getPath(g);for(var v=m.split("/").reverse();v.length;){var C=v.pop();if(C){var _=K.join2(g,C);try{X.mkdir(_)}catch(g){}g=_}}return _},createFile:function(g,m,f,S,v){var C=K.join2("string"==typeof g?g:X.getPath(g),m),_=X.getMode(S,v);return X.create(C,_)},createDataFile:function(g,m,f,S,v,C){var _=m;g&&(g="string"==typeof g?g:X.getPath(g),_=m?K.join2(g,m):g);var E=X.getMode(S,v),T=X.create(_,E);if(f){if("string"==typeof f){for(var I=new Array(f.length),b=0,A=f.length;b<A;++b)I[b]=f.charCodeAt(b);f=I}X.chmod(T,146|E);var P=X.open(T,577);X.write(P,f,0,f.length,0,C),X.close(P),X.chmod(T,E)}return T},createDevice:function(g,m,f,S){var v=K.join2("string"==typeof g?g:X.getPath(g),m),C=X.getMode(!!f,!!S);X.createDevice.major||(X.createDevice.major=64);var _=X.makedev(X.createDevice.major++,0);return X.registerDevice(_,{open:function(g){g.seekable=!1},close:function(g){S&&S.buffer&&S.buffer.length&&S(10)},read:function(g,m,S,v,C){for(var _=0,E=0;E<v;E++){var T;try{T=f()}catch(g){throw new X.ErrnoError(29)}if(void 0===T&&0===_)throw new X.ErrnoError(6);if(null==T)break;_++,m[S+E]=T}return _&&(g.node.timestamp=Date.now()),_},write:function(g,m,f,v,C){for(var _=0;_<v;_++)try{S(m[f+_])}catch(g){throw new X.ErrnoError(29)}return v&&(g.node.timestamp=Date.now()),_}}),X.mkdev(v,C,_)},forceLoadFile:function(g){if(g.isDevice||g.isFolder||g.link||g.contents)return!0;if("undefined"!=typeof XMLHttpRequest)throw new Error("Lazy loading should have been performed (contents set) in createLazyFile, but it was not. Lazy loading only works in web workers. Use --embed-file or --preload-file in emcc on the main thread.");if(!S)throw new Error("Cannot load without read() or XMLHttpRequest.");try{g.contents=intArrayFromString(S(g.url),!0),g.usedBytes=g.contents.length}catch(g){throw new X.ErrnoError(29)}},createLazyFile:function(g,m,f,S,v){function LazyUint8Array(){this.lengthKnown=!1,this.chunks=[]}if(LazyUint8Array.prototype.get=function LazyUint8Array_get(g){if(!(g>this.length-1||g<0)){var m=g%this.chunkSize,f=g/this.chunkSize|0;return this.getter(f)[m]}},LazyUint8Array.prototype.setDataGetter=function LazyUint8Array_setDataGetter(g){this.getter=g},LazyUint8Array.prototype.cacheLength=function LazyUint8Array_cacheLength(){var g=new XMLHttpRequest;if(g.open("HEAD",f,!1),g.send(null),!(g.status>=200&&g.status<300||304===g.status))throw new Error("Couldn't load "+f+". Status: "+g.status);var m,S=Number(g.getResponseHeader("Content-length")),v=(m=g.getResponseHeader("Accept-Ranges"))&&"bytes"===m,C=(m=g.getResponseHeader("Content-Encoding"))&&"gzip"===m,_=1048576;v||(_=S);var doXHR=function(g,m){if(g>m)throw new Error("invalid range ("+g+", "+m+") or no bytes requested!");if(m>S-1)throw new Error("only "+S+" bytes available! programmer error!");var v=new XMLHttpRequest;if(v.open("GET",f,!1),S!==_&&v.setRequestHeader("Range","bytes="+g+"-"+m),v.responseType="arraybuffer",v.overrideMimeType&&v.overrideMimeType("text/plain; charset=x-user-defined"),v.send(null),!(v.status>=200&&v.status<300||304===v.status))throw new Error("Couldn't load "+f+". Status: "+v.status);return void 0!==v.response?new Uint8Array(v.response||[]):intArrayFromString(v.responseText||"",!0)},E=this;E.setDataGetter((function(g){var m=g*_,f=(g+1)*_-1;if(f=Math.min(f,S-1),void 0===E.chunks[g]&&(E.chunks[g]=doXHR(m,f)),void 0===E.chunks[g])throw new Error("doXHR failed!");return E.chunks[g]})),!C&&S||(_=S=1,S=this.getter(0).length,_=S,b("LazyFiles on gzip forces download of the whole file when length is accessed")),this._length=S,this._chunkSize=_,this.lengthKnown=!0},"undefined"!=typeof XMLHttpRequest)throw"Cannot do synchronous binary XHRs outside webworkers in modern browsers. Use --embed-file or --preload-file in emcc";var C={isDevice:!1,url:f},_=X.createFile(g,m,C,S,v);C.contents?_.contents=C.contents:C.url&&(_.contents=null,_.url=C.url),Object.defineProperties(_,{usedBytes:{get:function(){return this.contents.length}}});var E={};function writeChunks(g,m,f,S,v){var C=g.node.contents;if(v>=C.length)return 0;var _=Math.min(C.length-v,S);if(C.slice)for(var E=0;E<_;E++)m[f+E]=C[v+E];else for(E=0;E<_;E++)m[f+E]=C.get(v+E);return _}return Object.keys(_.stream_ops).forEach((function(g){var m=_.stream_ops[g];E[g]=function forceLoadLazyFile(){return X.forceLoadFile(_),m.apply(null,arguments)}})),E.read=function(g,m,f,S,v){return X.forceLoadFile(_),writeChunks(g,m,f,S,v)},E.mmap=function(g,m,f,S,v){X.forceLoadFile(_);var C=mmapAlloc();if(!C)throw new X.ErrnoError(48);return writeChunks(g,w,C,m,f),{ptr:C,allocated:!0}},_.stream_ops=E,_},createPreloadedFile:function(g,m,f,S,v,C,_,E,T,I){var b=m?J.resolve(K.join2(g,m)):g;function processData(f){function finish(f){I&&I(),E||X.createDataFile(g,m,f,S,v,T),C&&C(),removeRunDependency()}Browser.handledByPreloadPlugin(f,b,finish,(function(){_&&_(),removeRunDependency()}))||finish(f)}addRunDependency(),"string"==typeof f?asyncLoad(f,(function(g){return processData(g)}),_):processData(f)},indexedDB:function(){return window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB},DB_NAME:function(){return"EM_FS_"+window.location.pathname},DB_VERSION:20,DB_STORE_NAME:"FILE_DATA",saveFilesToDB:function(g,m,f){void 0===m&&(m=function(){}),void 0===f&&(f=function(){});var S=X.indexedDB();try{var v=S.open(X.DB_NAME(),X.DB_VERSION)}catch(g){return f(g)}v.onupgradeneeded=function(){b("creating db"),v.result.createObjectStore(X.DB_STORE_NAME)},v.onsuccess=function(){var S=v.result.transaction([X.DB_STORE_NAME],"readwrite"),C=S.objectStore(X.DB_STORE_NAME),_=0,E=0,T=g.length;function finish(){0==E?m():f()}g.forEach((function(g){var m=C.put(X.analyzePath(g).object.contents,g);m.onsuccess=function(){++_+E==T&&finish()},m.onerror=function(){E++,_+E==T&&finish()}})),S.onerror=f},v.onerror=f},loadFilesFromDB:function(g,m,f){void 0===m&&(m=function(){}),void 0===f&&(f=function(){});var S=X.indexedDB();try{var v=S.open(X.DB_NAME(),X.DB_VERSION)}catch(g){return f(g)}v.onupgradeneeded=f,v.onsuccess=function(){var S=v.result;try{var C=S.transaction([X.DB_STORE_NAME],"readonly")}catch(g){return void f(g)}var _=C.objectStore(X.DB_STORE_NAME),E=0,T=0,I=g.length;function finish(){0==T?m():f()}g.forEach((function(g){var m=_.get(g);m.onsuccess=function(){X.analyzePath(g).exists&&X.unlink(g),X.createDataFile(K.dirname(g),K.basename(g),m.result,!0,!0,!0),++E+T==I&&finish()},m.onerror=function(){T++,E+T==I&&finish()}})),C.onerror=f},v.onerror=f}},Z={DEFAULT_POLLMASK:5,calculateAt:function(g,m,f){if(K.isAbs(m))return m;var S;-100===g?S=X.cwd():S=Z.getStreamFromFD(g).path;if(0==m.length){if(!f)throw new X.ErrnoError(44);return S}return K.join2(S,m)},doStat:function(g,m,f){try{var S=g(m)}catch(g){if(g&&g.node&&K.normalize(m)!==K.normalize(X.getPath(g.node)))return-54;throw g}D[f>>2]=S.dev,D[f+8>>2]=S.ino,D[f+12>>2]=S.mode,O[f+16>>2]=S.nlink,D[f+20>>2]=S.uid,D[f+24>>2]=S.gid,D[f+28>>2]=S.rdev,$=[S.size>>>0,(H=S.size,+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[f+40>>2]=$[0],D[f+44>>2]=$[1],D[f+48>>2]=4096,D[f+52>>2]=S.blocks;var v=S.atime.getTime(),C=S.mtime.getTime(),_=S.ctime.getTime();return $=[Math.floor(v/1e3)>>>0,(H=Math.floor(v/1e3),+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[f+56>>2]=$[0],D[f+60>>2]=$[1],O[f+64>>2]=v%1e3*1e3,$=[Math.floor(C/1e3)>>>0,(H=Math.floor(C/1e3),+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[f+72>>2]=$[0],D[f+76>>2]=$[1],O[f+80>>2]=C%1e3*1e3,$=[Math.floor(_/1e3)>>>0,(H=Math.floor(_/1e3),+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[f+88>>2]=$[0],D[f+92>>2]=$[1],O[f+96>>2]=_%1e3*1e3,$=[S.ino>>>0,(H=S.ino,+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[f+104>>2]=$[0],D[f+108>>2]=$[1],0},doMsync:function(g,m,f,S,v){if(!X.isFile(m.node.mode))throw new X.ErrnoError(43);if(2&S)return 0;var C=M.slice(g,g+f);X.msync(m,C,v,f,S)},varargs:void 0,get:function(){return Z.varargs+=4,D[Z.varargs-4>>2]},getStr:function(g){return UTF8ToString(g)},getStreamFromFD:function(g){var m=X.getStream(g);if(!m)throw new X.ErrnoError(8);return m}};function _environ_get(g,m){var f=0;return getEnvStrings().forEach((function(S,v){var C=m+f;O[g+4*v>>2]=C,writeAsciiToMemory(S,C),f+=S.length+1})),0}function _environ_sizes_get(g,m){var f=getEnvStrings();O[g>>2]=f.length;var S=0;return f.forEach((function(g){S+=g.length+1})),O[m>>2]=S,0}function _fd_close(g){try{var m=Z.getStreamFromFD(g);return X.close(m),0}catch(g){if(void 0===X||"ErrnoError"!==g.name)throw g;return g.errno}}function doReadv(g,m,f,S){for(var v=0,C=0;C<f;C++){var _=O[m>>2],E=O[m+4>>2];m+=8;var T=X.read(g,w,_,E,S);if(T<0)return-1;if(v+=T,T<E)break;void 0!==S&&(S+=T)}return v}function _fd_read(g,m,f,S){try{var v=doReadv(Z.getStreamFromFD(g),m,f);return O[S>>2]=v,0}catch(g){if(void 0===X||"ErrnoError"!==g.name)throw g;return g.errno}}function convertI32PairToI53Checked(g,m){return m+2097152>>>0<4194305-!!g?(g>>>0)+4294967296*m:NaN}function _fd_seek(g,m,f,S,v){try{var C=convertI32PairToI53Checked(m,f);if(isNaN(C))return 61;var _=Z.getStreamFromFD(g);return X.llseek(_,C,S),$=[_.position>>>0,(H=_.position,+Math.abs(H)>=1?H>0?(0|Math.min(+Math.floor(H/4294967296),4294967295))>>>0:~~+Math.ceil((H-+(~~H>>>0))/4294967296)>>>0:0)],D[v>>2]=$[0],D[v+4>>2]=$[1],_.getdents&&0===C&&0===S&&(_.getdents=null),0}catch(g){if(void 0===X||"ErrnoError"!==g.name)throw g;return g.errno}}function doWritev(g,m,f,S){for(var v=0,C=0;C<f;C++){var _=O[m>>2],E=O[m+4>>2];m+=8;var T=X.write(g,w,_,E,S);if(T<0)return-1;v+=T,void 0!==S&&(S+=T)}return v}function _fd_write(g,m,f,S){try{var v=doWritev(Z.getStreamFromFD(g),m,f);return O[S>>2]=v,0}catch(g){if(void 0===X||"ErrnoError"!==g.name)throw g;return g.errno}}function __arraySum(g,m){for(var f=0,S=0;S<=m;f+=g[S++]);return f}var ee=[31,29,31,30,31,30,31,31,30,31,30,31],te=[31,28,31,30,31,30,31,31,30,31,30,31];function __addDays(g,m){for(var f=new Date(g.getTime());m>0;){var S=__isLeapYear(f.getFullYear()),v=f.getMonth(),C=(S?ee:te)[v];if(!(m>C-f.getDate()))return f.setDate(f.getDate()+m),f;m-=C-f.getDate()+1,f.setDate(1),v<11?f.setMonth(v+1):(f.setMonth(0),f.setFullYear(f.getFullYear()+1))}return f}function writeArrayToMemory(g,m){w.set(g,m)}function _strftime(g,m,f,S){var v=D[S+40>>2],C={tm_sec:D[S>>2],tm_min:D[S+4>>2],tm_hour:D[S+8>>2],tm_mday:D[S+12>>2],tm_mon:D[S+16>>2],tm_year:D[S+20>>2],tm_wday:D[S+24>>2],tm_yday:D[S+28>>2],tm_isdst:D[S+32>>2],tm_gmtoff:D[S+36>>2],tm_zone:v?UTF8ToString(v):""},_=UTF8ToString(f),E={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var T in E)_=_.replace(new RegExp(T,"g"),E[T]);var I=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],b=["January","February","March","April","May","June","July","August","September","October","November","December"];function leadingSomething(g,m,f){for(var S="number"==typeof g?g.toString():g||"";S.length<m;)S=f[0]+S;return S}function leadingNulls(g,m){return leadingSomething(g,m,"0")}function compareByDay(g,m){function sgn(g){return g<0?-1:g>0?1:0}var f;return 0===(f=sgn(g.getFullYear()-m.getFullYear()))&&0===(f=sgn(g.getMonth()-m.getMonth()))&&(f=sgn(g.getDate()-m.getDate())),f}function getFirstWeekStartDate(g){switch(g.getDay()){case 0:return new Date(g.getFullYear()-1,11,29);case 1:return g;case 2:return new Date(g.getFullYear(),0,3);case 3:return new Date(g.getFullYear(),0,2);case 4:return new Date(g.getFullYear(),0,1);case 5:return new Date(g.getFullYear()-1,11,31);case 6:return new Date(g.getFullYear()-1,11,30)}}function getWeekBasedYear(g){var m=__addDays(new Date(g.tm_year+1900,0,1),g.tm_yday),f=new Date(m.getFullYear(),0,4),S=new Date(m.getFullYear()+1,0,4),v=getFirstWeekStartDate(f),C=getFirstWeekStartDate(S);return compareByDay(v,m)<=0?compareByDay(C,m)<=0?m.getFullYear()+1:m.getFullYear():m.getFullYear()-1}var A={"%a":function(g){return I[g.tm_wday].substring(0,3)},"%A":function(g){return I[g.tm_wday]},"%b":function(g){return b[g.tm_mon].substring(0,3)},"%B":function(g){return b[g.tm_mon]},"%C":function(g){return leadingNulls((g.tm_year+1900)/100|0,2)},"%d":function(g){return leadingNulls(g.tm_mday,2)},"%e":function(g){return leadingSomething(g.tm_mday,2," ")},"%g":function(g){return getWeekBasedYear(g).toString().substring(2)},"%G":function(g){return getWeekBasedYear(g)},"%H":function(g){return leadingNulls(g.tm_hour,2)},"%I":function(g){var m=g.tm_hour;return 0==m?m=12:m>12&&(m-=12),leadingNulls(m,2)},"%j":function(g){return leadingNulls(g.tm_mday+__arraySum(__isLeapYear(g.tm_year+1900)?ee:te,g.tm_mon-1),3)},"%m":function(g){return leadingNulls(g.tm_mon+1,2)},"%M":function(g){return leadingNulls(g.tm_min,2)},"%n":function(){return"\n"},"%p":function(g){return g.tm_hour>=0&&g.tm_hour<12?"AM":"PM"},"%S":function(g){return leadingNulls(g.tm_sec,2)},"%t":function(){return"\t"},"%u":function(g){return g.tm_wday||7},"%U":function(g){var m=g.tm_yday+7-g.tm_wday;return leadingNulls(Math.floor(m/7),2)},"%V":function(g){var m=Math.floor((g.tm_yday+7-(g.tm_wday+6)%7)/7);if((g.tm_wday+371-g.tm_yday-2)%7<=2&&m++,m){if(53==m){var f=(g.tm_wday+371-g.tm_yday)%7;4==f||3==f&&__isLeapYear(g.tm_year)||(m=1)}}else{m=52;var S=(g.tm_wday+7-g.tm_yday-1)%7;(4==S||5==S&&__isLeapYear(g.tm_year%400-1))&&m++}return leadingNulls(m,2)},"%w":function(g){return g.tm_wday},"%W":function(g){var m=g.tm_yday+7-(g.tm_wday+6)%7;return leadingNulls(Math.floor(m/7),2)},"%y":function(g){return(g.tm_year+1900).toString().substring(2)},"%Y":function(g){return g.tm_year+1900},"%z":function(g){var m=g.tm_gmtoff,f=m>=0;return m=(m=Math.abs(m)/60)/60*100+m%60,(f?"+":"-")+String("0000"+m).slice(-4)},"%Z":function(g){return g.tm_zone},"%%":function(){return"%"}};for(var T in _=_.replace(/%%/g,"\0\0"),A)_.includes(T)&&(_=_.replace(new RegExp(T,"g"),A[T](C)));var P=intArrayFromString(_=_.replace(/\0\0/g,"%"),!1);return P.length>m?0:(writeArrayToMemory(P,g),P.length-1)}function _strftime_l(g,m,f,S,v){return _strftime(g,m,f,S)}function uleb128Encode(g,m){g<128?m.push(g):m.push(g%128|128,g>>7)}function sigToWasmTypes(g){for(var m={i:"i32",j:"i32",f:"f32",d:"f64",p:"i32"},f={parameters:[],results:"v"==g[0]?[]:[m[g[0]]]},S=1;S<g.length;++S)f.parameters.push(m[g[S]]),"j"===g[S]&&f.parameters.push("i32");return f}function generateFuncType(g,m){var f=g.slice(0,1),S=g.slice(1),v={i:127,p:127,j:126,f:125,d:124};m.push(96),uleb128Encode(S.length,m);for(var C=0;C<S.length;++C)m.push(v[S[C]]);"v"==f?m.push(0):m.push(1,v[f])}function convertJsFunctionToWasm(g,m){if("function"==typeof WebAssembly.Function)return new WebAssembly.Function(sigToWasmTypes(m),g);var f=[1];generateFuncType(m,f);var S=[0,97,115,109,1,0,0,0,1];uleb128Encode(f.length,S),S.push.apply(S,f),S.push(2,7,1,1,101,1,102,0,0,7,5,1,1,102,0,0);var v=new WebAssembly.Module(new Uint8Array(S));return new WebAssembly.Instance(v,{e:{f:g}}).exports.f}function getWasmTableEntry(g){return N.get(g)}function updateTableMap(g,m){if(ie)for(var f=g;f<g+m;f++){var S=getWasmTableEntry(f);S&&ie.set(S,f)}}var ie=void 0;function getFunctionAddress(g){return ie||(ie=new WeakMap,updateTableMap(0,N.length)),ie.get(g)||0}var ne=[];function getEmptyTableSlot(){if(ne.length)return ne.pop();try{N.grow(1)}catch(g){if(!(g instanceof RangeError))throw g;throw"Unable to grow wasm table. Set ALLOW_TABLE_GROWTH."}return N.length-1}function setWasmTableEntry(g,m){N.set(g,m)}function addFunction(g,m){var f=getFunctionAddress(g);if(f)return f;var S=getEmptyTableSlot();try{setWasmTableEntry(S,g)}catch(f){if(!(f instanceof TypeError))throw f;setWasmTableEntry(S,convertJsFunctionToWasm(g,m))}return ie.set(g,S),S}function removeFunction(g){ie.delete(getWasmTableEntry(g)),ne.push(g)}function allocateUTF8OnStack(g){var m=lengthBytesUTF8(g)+1,f=ce(m);return stringToUTF8Array(g,w,f,m),f}var FSNode=function(g,m,f,S){g||(g=this),this.parent=g,this.mount=g.mount,this.mounted=null,this.id=X.nextInode++,this.name=m,this.mode=f,this.node_ops={},this.stream_ops={},this.rdev=S},re=365,se=146;Object.defineProperties(FSNode.prototype,{read:{get:function(){return(this.mode&re)===re},set:function(g){g?this.mode|=re:this.mode&=~re}},write:{get:function(){return(this.mode&se)===se},set:function(g){g?this.mode|=se:this.mode&=~se}},isFolder:{get:function(){return X.isDir(this.mode)}},isDevice:{get:function(){return X.isChrdev(this.mode)}}}),X.FSNode=FSNode,X.staticInit();var ae,oe={a:___assert_fail,e:__emscripten_get_now_is_monotonic,g:__localtime_js,h:__tzset_js,b:_abort,f:_emscripten_date_now,i:_emscripten_memcpy_big,d:_emscripten_resize_heap,m:_environ_get,n:_environ_sizes_get,o:_fd_close,p:_fd_read,k:_fd_seek,c:_fd_write,j:_strftime,l:_strftime_l},le=(createWasm(),function(){return(le=g.asm.s).apply(null,arguments)}),ce=(g._CreateTranscoder=function(){return(g._CreateTranscoder=g.asm.u).apply(null,arguments)},g._DeleteTranscoder=function(){return(g._DeleteTranscoder=g.asm.v).apply(null,arguments)},g._TranscoderSetDecryptionKey=function(){return(g._TranscoderSetDecryptionKey=g.asm.w).apply(null,arguments)},g._TranscoderAllocateBuffer=function(){return(g._TranscoderAllocateBuffer=g.asm.x).apply(null,arguments)},g._TranscoderConsumeBuffer=function(){return(g._TranscoderConsumeBuffer=g.asm.y).apply(null,arguments)},g._TranscoderRunTurn=function(){return(g._TranscoderRunTurn=g.asm.z).apply(null,arguments)},g.___errno_location=function(){return g.asm.__errno_location.apply(null,arguments)},g.stackAlloc=function(){return(ce=g.asm.A).apply(null,arguments)});function run(){function doRun(){ae||(ae=!0,g.calledRun=!0,R||(initRuntime(),m(g),g.onRuntimeInitialized&&g.onRuntimeInitialized(),postRun()))}U>0||(preRun(),U>0||(g.setStatus?(g.setStatus("Running..."),setTimeout((function(){setTimeout((function(){g.setStatus("")}),1),doRun()}),1)):doRun()))}if(g.UTF8ToString=UTF8ToString,g.addFunction=addFunction,g.removeFunction=removeFunction,g.allocateUTF8OnStack=allocateUTF8OnStack,V=function runCaller(){ae||run(),ae||(V=runCaller)},g.preInit)for("function"==typeof g.preInit&&(g.preInit=[g.preInit]);g.preInit.length>0;)g.preInit.pop()();return run(),g.ready}}();g.default=m}}),ie=__commonJS({"../node_modules/@skype/hydra_player_hls_sdk/hydra_player_hls_sdk_bundle.js"(g,m){var f,S;f=g,S=function(){return g={458:function(g,m,f){var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.LiveStreamStatistic=void 0;var v=f(844),C=f(68),_=f(63),E=f(329),T=function(){function e3(g,m,f){this.name=g,this.stopCrash=m,this.start(f)}return e3.prototype.complete=function(){try{E.assert(this.startTime,"not started",this.stopCrash),E.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(g){if(this.name!==v.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==v.PlayerScenarioType.HlsKeyLoad)throw g}this.duration=Date.now()-this.startTime},e3.prototype.fail=function(g){this.failReason=g,this.complete()},e3.prototype.setDetail=function(g){this.details=g},e3.prototype.getTelemetryEvent=function(){E.assert(this.startTime,"not started",this.stopCrash);var g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g},e3.prototype.getName=function(){return this.name},e3.prototype.getDuration=function(){var g;return null!==(g=this.duration)&&void 0!==g?g:0},e3.prototype.getFailReason=function(){return this.failReason},e3.prototype.getDetails=function(){return this.details},e3.prototype.start=function(g){E.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),g&&(this.details=g)},e3.prototype.updateDetails=function(g,m){if(this.details&&"object"==typeof this.details)for(var f=0;f<g.length;f++)this.details[g[f]]=m[f]},e3}(),I=function(){function e3(g,m,f,S,v){this.config=g,this.logFn=m,this.playerDiagnosticsLog=f,this.playerMetadata=S,this.hydraInitResult=v,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.isCallRecovered=!1,this.isCallInErrorState=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=g.maxPlayerExperimentalEvents||100,E.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e3.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e3.prototype.registerStatsUpdated=function(g){var m=this;this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((function(f){var S,v=f,C=null!==(S=m.playerDiagnosticsLog[f])&&void 0!==S?S:[];if(Array.isArray(C)){C.push(g[v]);var _="memoryLog"===v&&C.length>m.maxPlayerMemoryTraceLogCount,E="memoryLog"!==v&&C.length>m.maxPlayerDiagnosticsCount;(_||E)&&C.splice(0,1)}else m.playerDiagnosticsLog[f]=g[v]}))},e3.prototype.registerEventLoadAttempt=function(g,m){this.registerScenario(g,m)},e3.prototype.registerEventLoadFailed=function(g,m){this.completeScenario(g,m)},e3.prototype.registerEventLoadSucceeded=function(g,m){this.completeScenario(g,void 0,m),g===v.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e3.prototype.registerSdnPluginLoadAttempt=function(g){this.registerScenario(v.PlayerScenarioType.SdnPluginLoad,JSON.stringify(g))},e3.prototype.registerSdnPluginLoadFailed=function(g){this.completeScenario(v.PlayerScenarioType.SdnPluginLoad,g)},e3.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(v.PlayerScenarioType.SdnPluginLoad)},e3.prototype.registerStreamConnectionAttempt=function(g){this.registerScenario(v.PlayerScenarioType.StreamConnection,{streamUrl:g})},e3.prototype.registerStreamConnectionSucceeded=function(g){var m=this.getScenario(v.PlayerScenarioType.StreamConnection);null==m||m.updateDetails(["results"],[E.stringifyObject(g)]),this.completeScenario(v.PlayerScenarioType.StreamConnection)},e3.prototype.registerStreamConnectionFailed=function(g,m){var f=this.getScenario(v.PlayerScenarioType.StreamConnection);null==f||f.updateDetails(["results"],[E.stringifyObject(m)]),this.completeScenario(v.PlayerScenarioType.StreamConnection,g)},e3.prototype.registerSetSourceAttempt=function(g,m,f){var S=g||"";f&&(S={src:g||"",isPrimary:E.stringifyObject(m),reason:f}),this.registerScenario(v.PlayerScenarioType.SetSource,S)},e3.prototype.registerSetSourceSucceeded=function(g,m,f,S){var C=this.getScenario(v.PlayerScenarioType.SetSource);E.assert(C,"no SetSource scenario to update details",this.stopCrash),null==C||C.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[g,E.stringifyObject(m),E.stringifyObject(f),E.stringifyObject(S)]),this.completeScenario(v.PlayerScenarioType.SetSource)},e3.prototype.registerSetSourceFailed=function(g,m,f,S,C){var _=null!=m?m:"Failed to find stream url",T=this.getScenario(v.PlayerScenarioType.SetSource);E.assert(T,"no SetSource scenario to update details",this.stopCrash),null==T||T.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[_,E.stringifyObject(f),E.stringifyObject(S),E.stringifyObject(C)]),this.completeScenario(v.PlayerScenarioType.SetSource,g)},e3.prototype.registerPlayerDestroyed=function(g){this.callDropped=g===_.HydraPlayerDestroyedReason.PlaybackError,this.registerScenario(v.PlayerScenarioType.Destroyed,g),this.completeScenario(v.PlayerScenarioType.Destroyed)},e3.prototype.updateCallRecovered=function(g){this.isCallInErrorState&&g===C.HydraPlayerPlaybackState.Playing&&(this.isCallRecovered=!0,this.isCallInErrorState=!1)},e3.prototype.registerPlaybackStateChanged=function(g){g!==C.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?g!==C.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(v.TelemetryEventType.StateChanged,g),this.updateCallRecovered(g)},e3.prototype.registerHydraInputStateChanged=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.HydraInputStateChanged,g,m)},e3.prototype.registerHydraOutputStateChanged=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.HydraOutputStateChanged,g,m)},e3.prototype.registerPlaybackBuffering=function(g){this.registerPlaybackEvent(v.TelemetryEventType.Buffering,g)},e3.prototype.registerPlaybackError=function(g,m,f){this.registerPlaybackEvent(v.TelemetryEventType.Error,{errorType:g,details:m,errorSource:f})},e3.prototype.registerDownloadBitrateChanged=function(g){this.registerPlaybackEvent(v.TelemetryEventType.BitrateChangedDownload,g)},e3.prototype.registerStreamOptionsConfigured=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.StreamOptionsConfigured,g,m)},e3.prototype.registerPlaybackBitrateChanged=function(g){this.registerPlaybackEvent(v.TelemetryEventType.BitrateChangedPlayback,g)},e3.prototype.registerVolumeChange=function(g){this.registerPlaybackEvent(v.TelemetryEventType.Volume,g)},e3.prototype.getSnapshotReport=function(){var g,m,f=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),v=this.playbackEvents,C={};return this.currentPlayerDiagnosticSnapshot&&(C=this.filterAndPrepareTelemetry()),S(S(S(S(S(S(S(S(S(S(S(S(S({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(f,v)),this.getHydraInternalReport(v)),this.getPlaybackReport(v)),this.getBitrateReport(v)),this.getStreamConnectionReport(f)),this.getSdnReport(f)),this.getSetSourceReport(f)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),C)},e3.prototype.getReport=function(){var g,m,f=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),v=this.playbackEvents;return S(S(S(S(S(S(S(S(S(S(S(S(S({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(f,v)),this.getHydraInternalReport(v)),this.getPlaybackReport(v)),this.getBitrateReport(v)),this.getStreamConnectionReport(f)),this.getSdnReport(f)),this.getSetSourceReport(f)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),this.getPlayerDiagnosticLog())},e3.prototype.getHydraLoadEvent=function(){var g,m,f,S={name:v.PlayerScenarioType.LoadHydra,startTime:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initStartTime)||-1,duration:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initDuration)||0};(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)&&(S.failReason=this.hydraInitResult.errorMsg);var C=this.getHydraRuntimeDownloadDetails();return C&&(S.details=C),S},e3.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var g=[],m=0,f=this.hydraInitResult.runtimeDownloadResults;m<f.length;m++){var S=f[m],v={success:S.success,url:S.url,startTime:S.startTime,duration:S.duration,trackingReference:S.trackingReference,timeTakenToDownloadScript:S.timeTakenToDownloadScript};S.errorMsg&&(v.errorMsg=S.errorMsg),g.push(v)}return E.stringifyObject(g)}return null},e3.prototype.getTotalLoadEvent=function(){var g,m,f,S=this.playerEvents.find((function(g){return g.getName()===v.PlayerScenarioType.LoadPlayer})),C=(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initDuration)||0,_=(null==S?void 0:S.getDuration())||0,E=null==S?void 0:S.getFailReason(),T={name:v.PlayerScenarioType.Load,startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,duration:C+_};return(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)?T.failReason=this.hydraInitResult.errorMsg:E&&(T.failReason=E),T},e3.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e3.prototype.registerPlaybackEvent=function(g,m,f){var S=this.createTelemetryEvent(g,m,f);g===v.TelemetryEventType.Error&&(null==m?void 0:m.errorType)!==C.HydraPlayerPlaybackErrorType.PlaybackRetried&&(S.fatal=!0,this.isCallInErrorState=!0),this.playbackEvents.push(S),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(S)},e3.prototype.getPlayerDiagnosticLog=function(){var g=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var m=this.currentPlayerDiagnosticSnapshot,f=this.playerDiagnosticsLog,v=S(S({},m),f),C={};return Object.keys(v).forEach((function(m){C["player_".concat(m)]=g.prepareForTelemetry(v[m])})),C},e3.prototype.getHydraInitializationReport=function(){var g,m,f,S;return{hydraInit_succeeded:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initSucceeded)||!1,hydraInit_startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,hydraInit_errorMessage:(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)||"",hydraInit_duration:(null===(S=this.hydraInitResult)||void 0===S?void 0:S.initDuration)||0}},e3.prototype.getPlayerInitializationReport=function(g,m){var f=g.find((function(g){return g.name===v.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=f&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-f.startTime:-1)||-1,init_timeLoadToReady:(null!=f&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-f.startTime:-1)||-1,init_timeLoadToPlaying:(null!=f&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-f.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}},e3.prototype.getHydraInternalReport=function(g){var m=g.filter((function(g){return g.eventType===v.TelemetryEventType.HydraInputStateChanged})),f=g.filter((function(g){return g.eventType===v.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(m),hydra_outputStateChangeEvents:this.prepareForTelemetry(f)}},e3.prototype.getPlaybackReport=function(g){var m=g.filter((function(g){return g.eventType===v.TelemetryEventType.StateChanged})),f=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.CanPlayThrough})),S=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Play})),_=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Start})),E=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Playing})),T=null!=f&&null!=S?S.timestamp-f.timestamp:-1,I=null!=S&&null!=_?_.timestamp-S.timestamp:-1,b=null!=_&&null!=E?E.timestamp-_.timestamp:-1,A=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Seeked})),P=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Seeking})),R=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Pause})),w=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Waiting})),M=[v.TelemetryEventType.BitrateChangedDownload,v.TelemetryEventType.BitrateChangedPlayback,v.TelemetryEventType.Error,v.TelemetryEventType.Mute,v.TelemetryEventType.StateChanged,v.TelemetryEventType.Volume,v.TelemetryEventType.StreamOptionsConfigured],D=g.filter((function(g){return g.eventType===v.TelemetryEventType.Error})),O=g.filter((function(g){return g.eventType===v.TelemetryEventType.Volume||g.eventType===v.TelemetryEventType.Mute})),N=g.filter((function(g){return g.eventType===v.TelemetryEventType.StreamOptionsConfigured})),k=g.filter((function(g){return!M.includes(g.eventType)}));return{playback_timeReadyToPlay:T,playback_timePlayToStart:I,playback_timeStartToPlaying:b,playback_bufferingEvents:this.prepareForTelemetry(w),playback_errorEvents:this.prepareForTelemetry(D),playback_pauseEvents:this.prepareForTelemetry(R),playback_otherEvents:this.prepareForTelemetry(k),playback_seekedEvents:this.prepareForTelemetry(A),playback_seekingEvents:this.prepareForTelemetry(P),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(O),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(N)}},e3.prototype.getBitrateReport=function(g){var m,f,C,_,E=g.filter((function(g){return g.eventType===v.TelemetryEventType.BitrateChangedDownload})),T=E.sort((function(g){return Number(g.payload)})),I=E.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(E),bitrate_downloadChangeCount:E.length>0||-1,bitrate_downloadMin:(null===(m=T[0])||void 0===m?void 0:m.payload)||-1,bitrate_downloadMax:(null===(f=T[T.length-1])||void 0===f?void 0:f.payload)||-1}:{},b=g.filter((function(g){return g.eventType===v.TelemetryEventType.BitrateChangedPlayback})),A=b.sort((function(g){return Number(g.payload)})),P=b.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(b),bitrate_playbackChangeCount:b.length>0||-1,bitrate_playbackMin:(null===(C=A[0])||void 0===C?void 0:C.payload)||-1,bitrate_playbackMax:(null===(_=A[A.length-1])||void 0===_?void 0:_.payload)||-1}:{};return S(S({},I),P)},e3.prototype.addNetworkTypeEventListener=function(){var g,m,f,S,v=this;(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)&&(null===(S=null===(f=window.navigator)||void 0===f?void 0:f.connection)||void 0===S||S.addEventListener("change",(function(){v.updateClientNetworkType()})))},e3.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e3.prototype.getClientNetworkType=function(){var g,m,f,S;if(void 0===this.clientNetworkType){var v="Unknown";if(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)switch(null===(S=null===(f=window.navigator)||void 0===f?void 0:f.connection)||void 0===S?void 0:S.type){case"cellular":v="WWAN";break;case"ethernet":v="Wired";break;case"wifi":v="Wireless";break;default:v="Unknown"}this.clientNetworkType=v}return this.clientNetworkType},e3.prototype.getSdnReport=function(g){var m,f,S=g.filter((function(g){return g.name===v.PlayerScenarioType.SdnPluginLoad})),C=S.length>0?S[S.length-1]:void 0;return{sdn_loaded:!(null==C||void 0!==C.failReason),sdn_details:null!==(m=null==C?void 0:C.details)&&void 0!==m?m:"",sdn_error:null!==(f=null==C?void 0:C.failReason)&&void 0!==f?f:"",sdn_events:this.prepareForTelemetry(S)}},e3.prototype.getStreamConnectionReport=function(g){var m=g.filter((function(g){return g.name===v.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(m)}},e3.prototype.getSetSourceReport=function(g){var m=g.filter((function(g){return g.name===v.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(m)}},e3.prototype.registerScenario=function(g,m){var f=this.currentScenarioMap.get(g),S=new T(g,this.stopCrash,m);try{E.assert(null==f,"previous scenario:".concat(E.stringifyObject(f)," is not completed, new scenario:").concat(E.stringifyObject(S)),this.stopCrash)}catch(m){if(g!==v.PlayerScenarioType.LoadHlsFirstFragment&&g!==v.PlayerScenarioType.HlsKeyLoad)throw m}this.currentScenarioMap.set(g,S),this.playerEvents.push(S)},e3.prototype.completeScenario=function(g,m,f){var S=this.currentScenarioMap.get(g);try{E.assert(S,"no scenario to complete",this.stopCrash)}catch(m){if(g!==v.PlayerScenarioType.LoadHlsFirstFragment&&g!==v.PlayerScenarioType.HlsKeyLoad)throw m}m?null==S||S.fail(m):(g!==v.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),f&&(null==S||S.setDetail(f)),null==S||S.complete()),this.currentScenarioMap.delete(g)},e3.prototype.logTelemetryEvent=function(g){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(g))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e3.prototype.filterAndPrepareTelemetry=function(){var g=this,m=new Set;m.add("serviceLatencyCdg"),m.add("endToEndLatencyCdg"),m.add("videoEdgeLatencyCdg");var f={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(S){m.has(S)||(f["player_".concat(S)]=g.prepareForTelemetry(g.currentPlayerDiagnosticSnapshot[S]))})),f},e3.prototype.prepareForTelemetry=function(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?null!=g?g:-1:JSON.stringify(g)},e3.prototype.getScenario=function(g){return this.currentScenarioMap.get(g)},e3.prototype.createTelemetryEvent=function(g,m,f){var S,v,C={eventType:g,timestamp:Date.now(),currentPlayPosition:null!==(v=null===(S=this.currentPlayerDiagnosticSnapshot)||void 0===S?void 0:S.currentPlayPosition)&&void 0!==v?v:-1};return void 0!==m&&(C.payload=this.prepareForTelemetry(m)),C.message=f,C},e3.prototype.registerExperimentalEvent=function(g,m,f){var S=this.createTelemetryEvent(g,m,f);this.experimentalEvents.push(S),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(S)},e3.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e3}();m.LiveStreamStatistic=I},751:function(g,m){var f,S,v,C,_,E;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(E=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",E.HLS="MiddleLaneHttpLiveStreaming",E.Ums="MiddleLaneUltraLowLatency",(_=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",_.PlayerInitializationFailed="PlayerInitializationFailed",_.InvalidStream="InvalidStream",_.SetSourceFailed="SetSourceFailed",(C=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",C.LoadedData="loadeddata",C.LoadedMetadata="loadedmetadata",C.Start="start",C.CanPlayThrough="canplaythrough",C.Play="play",C.Playing="playing",C.Pause="pause",C.Waiting="waiting",C.Seeking="seeking",C.Seeked="seeked",C.Ended="ended",C.Error="error",C.Destroyed="destroyed",C.Initialized="initialized",C.Stalled="stalled",C.VolumeChange="volumechange",C.PlaybackBitrateChanged="playbackbitratechanged",C.DownloadBitrateChanged="downloadbitratechanged",C.HlsKeyLoading="hlsKeyLoading",C.HlsKeyLoaded="hlsKeyLoaded",C.HlsKeyLoadedFailed="hlsKeyLoadedFailed",C.HlsManifestLoading="hlsManifestLoading",C.HlsManifestLoaded="hlsManifestLoaded",C.HlsManifestLoadedFailed="hlsManifestLoadedFailed",C.HlsFirstFragmentLoading="hlsFragLoading",C.HlsFirstFragmentBuffered="hlsFragBuffered",C.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",C.Online="online",C.Offline="offline",C.NetworkChange="networkChange",(v=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",v.NetworkError="NetworkError",v.PlaybackRetried="PlaybackRetried",v.PlaybackError="PlaybackError",v.Unknown="Unknown",(S=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",S.Overflow="Overflow",S.TownHallBasic="TownHall_Basic",S.TownHallPremium="TownHall_Premium",S.TownHall="TownHall",(f=m.HydraPlayerType||(m.HydraPlayerType={}))[f.Hls=1]="Hls",f[f.Ums=2]="Ums"},855:function(g,m,f){var S=this&&this.__createBinding||(Object.create?function(g,m,f,S){void 0===S&&(S=f);var v=Object.getOwnPropertyDescriptor(m,f);v&&!("get"in v?!m.__esModule:v.writable||v.configurable)||(v={enumerable:!0,get:function(){return m[f]}}),Object.defineProperty(g,S,v)}:function(g,m,f,S){void 0===S&&(S=f),g[S]=m[f]}),v=this&&this.__exportStar||function(g,m){for(var f in g)"default"===f||Object.prototype.hasOwnProperty.call(m,f)||S(m,g,f)};Object.defineProperty(m,"__esModule",{value:!0}),v(f(952),m),v(f(751),m)},952:function(g,m,f){var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)},v=this&&this.__awaiter||function(g,m,f,S){return new(f||(f=Promise))((function(v,C){function o2(g){try{l2(S.next(g))}catch(g){C(g)}}function s2(g){try{l2(S.throw(g))}catch(g){C(g)}}function l2(g){var m;g.done?v(g.value):(m=g.value,m instanceof f?m:new f((function(g){g(m)}))).then(o2,s2)}l2((S=S.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function s2(E){return function(T){return function(E){if(f)throw new TypeError("Generator is already executing.");for(;C&&(C=0,E[0]&&(_=0)),_;)try{if(f=1,S&&(v=2&E[0]?S.return:E[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,E[1])).done)return v;switch(S=0,v&&(E=[2&E[0],v.value]),E[0]){case 0:case 1:v=E;break;case 4:return _.label++,{value:E[1],done:!1};case 5:_.label++,S=E[1],E=[0];continue;case 7:E=_.ops.pop(),_.trys.pop();continue;default:if(!((v=(v=_.trys).length>0&&v[v.length-1])||6!==E[0]&&2!==E[0])){_=0;continue}if(3===E[0]&&(!v||E[1]>v[0]&&E[1]<v[3])){_.label=E[1];break}if(6===E[0]&&_.label<v[1]){_.label=v[1],v=E;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(E);break}v[2]&&_.ops.pop(),_.trys.pop();continue}E=m.call(g,_)}catch(g){E=[6,g],S=0}finally{f=v=0}if(5&E[0])throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}([E,T])}}},_=this&&this.__spreadArray||function(g,m,f){if(f||2===arguments.length)for(var S,v=0,C=m.length;v<C;v++)!S&&v in m||(S||(S=Array.prototype.slice.call(m,0,v)),S[v]=m[v]);return g.concat(S||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0}),m.HlsHydraPlayer=m.getSdkVersion=void 0;var E=f(124),T=f(68),I=f(328),b=f(844),A=f(944),P=f(329),R=f(63),w=f(458);m.getSdkVersion=function(){return"4.2410.1"};var M=function(){function e3(g,m){this.playerSettings=g,this.eventHandler=m,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2410.1"}return Object.defineProperty(e3.prototype,"contextWindow",{get:function(){var g;return null===(g=this.container)||void 0===g?void 0:g.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e3.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var g=(0,P.getMajorFromVersion)("4.2410.1");return g&&this.playerSettings.playerRuntimeJsUrls[g]||[]}return this.playerSettings.playerRuntimeJsUrls},e3.prototype.initializeIFrame=function(g){return v(this,void 0,void 0,(function(){var m;return C(this,(function(f){switch(f.label){case 0:return this.container=g,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2410.1",', URLs: "').concat((0,P.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,P.createIFrame)(g,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(m=f.sent()).initResult.initSucceeded&&m.iframe&&(this.iframe=m.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,m.initResult]}}))}))},e3.prototype.setup=function(g){return v(this,void 0,void 0,(function(){var m;return C(this,(function(f){switch(f.label){case 0:return this.spinner=new P.Spinner(g),[4,this.initializeIFrame(g)];case 1:return m=f.sent(),this.telemetryReportHandler=new O(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),m,this.spinner),this.playerInternalEventHandler=new D(this.spinner,this.telemetryReportHandler),m.initSucceeded?[4,this.sendCommand("createHlsHydraPlayer",this.playerSettings,m)]:[3,3];case 2:return f.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(m.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e3.prototype.isIFrameCommunicationActive=function(){var g;return!!(null===(g=this.iframe)||void 0===g?void 0:g.contentWindow)&&!!this.contextWindow},e3.prototype.getFullTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getFullTelemetryReport())||{}},e3.prototype.getSnapshotTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getSnapshotTelemetryReport())||{}},e3.prototype.callPlayerApi=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];return v(this,void 0,void 0,(function(){return C(this,(function(f){switch(f.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,_([g],m,!1))]:[3,2];case 1:case 3:return[2,f.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e3.prototype.dispose=function(){var g;null===(g=this.telemetryReportHandler)||void 0===g||g.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e3.prototype.release=function(){var g;null===(g=this.spinner)||void 0===g||g.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e3.prototype.sendCommand=function(g){for(var m,f,S=[],_=1;_<arguments.length;_++)S[_-1]=arguments[_];return v(this,void 0,void 0,(function(){var v,_,T;return C(this,(function(C){switch(C.label){case 0:if(v={msgType:E.MessageType.Command,name:g,args:S},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(_=this.commandResultsMap.get(g.toString()))&&_.reject(new Error("function ".concat(g," is invoked again, before previous call is completed"))),T=A.defer(),this.commandResultsMap.set(g,T),null===(f=null===(m=this.iframe)||void 0===m?void 0:m.contentWindow)||void 0===f||f.postMessage(v,"*"),[4,T.promise];case 1:return[2,C.sent()]}}))}))},e3.prototype.onMessage=function(g){switch(g.data.msgType){case E.MessageType.PlayerEvent:this.processPlayerEvent(g.data);break;case E.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(g.data);break;case E.MessageType.CommandSuccessResult:this.processCommandSuccessResult(g.data);break;case E.MessageType.CommandFailureResult:this.processCommandFailureResult(g.data)}},e3.prototype.processCommandSuccessResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.resolve(g.result),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processCommandFailureResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.reject(g.error),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processPlayerEvent=function(g){this.eventHandler[g.name].apply(this.eventHandler,g.args)},e3.prototype.processInternalPlayerEvent=function(g){this.playerInternalEventHandler&&this.playerInternalEventHandler[g.name].apply(this,g.args)},e3}();m.HlsHydraPlayer=M;var D=function(){function e3(g,m){this.spinner=g,this.telemetryReportHandler=m}return e3.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e3.prototype.fullTelemetryReportUpdated=function(g){this.telemetryReportHandler.setFullTelemetryReport(g)},e3.prototype.snapshotTelemetryReportUpdated=function(g){this.telemetryReportHandler.setSnapshotTelemetryReport(g)},e3}(),O=function(){function e3(g,m,f,S){var v=this;this.logFn=m,this.spinner=S;var C=new w.LiveStreamStatistic(g,(function(g,m){v.logFn(g,m)}),{perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],statsInterval:[],serviceAvgLatency:[],endToEndAvgLatency:[]},{hydraPlayerSdkVersion:g.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:I.HydraPlayerType.Hls},f);this.fullTelemetryReport=C.getReport(),this.snapshotTelemetryReport=C.getSnapshotReport()}return e3.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e3.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e3.prototype.setFullTelemetryReport=function(g){var m,f,v;this.fullTelemetryReport=S(S({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(f=this.spinner.firstHideTimestamp)&&void 0!==f?f:-1,init_spinnerDuration:null!==(v=this.spinner.firstSpinnerDuration)&&void 0!==v?v:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.setSnapshotTelemetryReport=function(g){var m,f,v;this.snapshotTelemetryReport=S(S({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(f=this.spinner.firstHideTimestamp)&&void 0!==f?f:-1,init_spinnerDuration:null!==(v=this.spinner.firstSpinnerDuration)&&void 0!==v?v:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.addDisposeTelemetry=function(){var g=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=g,this.snapshotTelemetryReport.hydraDisposeTimestamp=g},e3.prototype.updateInitEventsWithDisposeEvent=function(g,m){var f=g.init_allEvents,S=JSON.parse(f);S[S.length-1].name!==b.PlayerScenarioType.Destroyed&&S.push({name:b.PlayerScenarioType.Destroyed,startTime:m,duration:0,details:R.HydraPlayerDestroyedReason.PlayerStopped}),g.init_allEvents=(0,P.stringifyObject)(S)},e3.prototype.updateStateChangeEventsWithDisposeEvent=function(g,m){var f=g.playback_stateChangeEvents,S=JSON.parse(f);S[S.length-1].payload!==T.HydraPlayerPlaybackState.Destroyed&&S.push({eventType:b.TelemetryEventType.StateChanged,timestamp:m,currentPlayPosition:-1,payload:T.HydraPlayerPlaybackState.Destroyed}),g.playback_stateChangeEvents=(0,P.stringifyObject)(S)},e3}()},124:function(g,m){var f;Object.defineProperty(m,"__esModule",{value:!0}),m.MessageType=void 0,(f=m.MessageType||(m.MessageType={})).Command="Command",f.CommandSuccessResult="CommandSuccessResult",f.CommandFailureResult="CommandFailureResult",f.PlayerEvent="PlayerEvent",f.InternalPlayerEvent="InternalPlayerEvent"},63:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraSupportedSDN=m.HydraPlayerDestroyedReason=void 0,(S=m.HydraPlayerDestroyedReason||(m.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",S.PlaybackError="PlaybackError",(f=m.HydraSupportedSDN||(m.HydraSupportedSDN={})).Hive="hive",f.Kollective="kollective",f.Ramp="ramp",f.Peer5="peer5",f.Microsoft="microsoft"},844:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.PlayerScenarioType=m.TelemetryEventType=void 0,(S=m.TelemetryEventType||(m.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",S.StreamOptionsConfigured="StreamOptionsConfigured",S.BitrateChangedPlayback="BitrateChangedPlayback",S.CaptionsToggled="CaptionsToggled",S.Error="Error",S.FullscreenChanged="FullscreenChanged",S.Mute="Mute",S.PotentialMediaFreeze="PotentialMediaFreeze",S.StateChanged="StateChanged",S.HydraInputStateChanged="HydraInputStateChanged",S.HydraOutputStateChanged="HydraOutputStateChanged",S.Volume="Volume",S.Buffering="Buffering",S.LowBufferReserve="LowBufferReserve",S.Online="Online",S.Offline="Offline",S.NetworkChange="NetworkChange",S.HlsEvents="HlsEvents",(f=m.PlayerScenarioType||(m.PlayerScenarioType={})).LoadHydra="LoadHydra",f.LoadHlsScript="LoadHlsScript",f.LoadPlayer="LoadPlayer",f.Load="Load",f.LoadHlsAuthCookie="LoadHlsAuthCookie",f.HlsManifestLoad="HlsManifestLoad",f.HlsKeyLoad="HlsKeyLoad",f.LoadHlsFirstFragment="LoadHlsFirstFragment",f.SetSource="SetSource",f.SdnPluginLoad="SdnPluginLoad",f.ThaPluginLoad="ThaPluginLoad",f.HydraPipelineInitialization="HydraPipelineInitialization",f.Destroyed="Destroyed",f.Setup="Setup",f.StreamConnection="StreamConnection"},328:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=void 0,(S=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",S.Overflow="Overflow",S.TownHallBasic="TownHall_Basic",S.TownHallPremium="TownHall_Premium",S.TownHall="TownHall",(f=m.HydraPlayerType||(m.HydraPlayerType={}))[f.Hls=1]="Hls",f[f.Ums=2]="Ums"},68:function(g,m){var f,S,v,C;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(C=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",C.HLS="MiddleLaneHttpLiveStreaming",C.Ums="MiddleLaneUltraLowLatency",(v=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",v.PlayerInitializationFailed="PlayerInitializationFailed",v.InvalidStream="InvalidStream",v.SetSourceFailed="SetSourceFailed",(S=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",S.LoadedData="loadeddata",S.LoadedMetadata="loadedmetadata",S.Start="start",S.CanPlayThrough="canplaythrough",S.Play="play",S.Playing="playing",S.Pause="pause",S.Waiting="waiting",S.Seeking="seeking",S.Seeked="seeked",S.Ended="ended",S.Error="error",S.Destroyed="destroyed",S.Initialized="initialized",S.Stalled="stalled",S.VolumeChange="volumechange",S.PlaybackBitrateChanged="playbackbitratechanged",S.DownloadBitrateChanged="downloadbitratechanged",S.HlsKeyLoading="hlsKeyLoading",S.HlsKeyLoaded="hlsKeyLoaded",S.HlsKeyLoadedFailed="hlsKeyLoadedFailed",S.HlsManifestLoading="hlsManifestLoading",S.HlsManifestLoaded="hlsManifestLoaded",S.HlsManifestLoadedFailed="hlsManifestLoadedFailed",S.HlsFirstFragmentLoading="hlsFragLoading",S.HlsFirstFragmentBuffered="hlsFragBuffered",S.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",S.Online="online",S.Offline="offline",S.NetworkChange="networkChange",(f=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",f.NetworkError="NetworkError",f.PlaybackRetried="PlaybackRetried",f.PlaybackError="PlaybackError",f.Unknown="Unknown"},944:function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.defer=void 0,m.defer=function(){var g,m;return{promise:new Promise((function(f,S){g=f,m=S})),resolve:g,reject:m}}},329:function(g,m,f){var S=this&&this.__awaiter||function(g,m,f,S){return new(f||(f=Promise))((function(v,C){function o2(g){try{l2(S.next(g))}catch(g){C(g)}}function s2(g){try{l2(S.throw(g))}catch(g){C(g)}}function l2(g){var m;g.done?v(g.value):(m=g.value,m instanceof f?m:new f((function(g){g(m)}))).then(o2,s2)}l2((S=S.apply(g,m||[])).next())}))},v=this&&this.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function s2(E){return function(T){return function(E){if(f)throw new TypeError("Generator is already executing.");for(;C&&(C=0,E[0]&&(_=0)),_;)try{if(f=1,S&&(v=2&E[0]?S.return:E[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,E[1])).done)return v;switch(S=0,v&&(E=[2&E[0],v.value]),E[0]){case 0:case 1:v=E;break;case 4:return _.label++,{value:E[1],done:!1};case 5:_.label++,S=E[1],E=[0];continue;case 7:E=_.ops.pop(),_.trys.pop();continue;default:if(!((v=(v=_.trys).length>0&&v[v.length-1])||6!==E[0]&&2!==E[0])){_=0;continue}if(3===E[0]&&(!v||E[1]>v[0]&&E[1]<v[3])){_.label=E[1];break}if(6===E[0]&&_.label<v[1]){_.label=v[1],v=E;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(E);break}v[2]&&_.ops.pop(),_.trys.pop();continue}E=m.call(g,_)}catch(g){E=[6,g],S=0}finally{f=v=0}if(5&E[0])throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}([E,T])}}};Object.defineProperty(m,"__esModule",{value:!0}),m.createVideoElement=m.createVideoElementDiv=m.showPlayerControls=m.getSdnStats=m.Spinner=m.repeatUntilCancel=m.wait=m.stringifyObject=m.getRandomHexString=m.getPlayerSetting=m.getECSSetting=m.assert=m.createIFrame=m.getMajorFromVersion=void 0;var C=f(63),_=f(328);function s(g,m,f,C,_){return S(this,void 0,void 0,(function(){var E,T,I,b,A=this;return v(this,(function(P){switch(P.label){case 0:return E=100,T=Date.now(),[4,c(f,I={trackingRef:"",timeTakenToDownloadScript:-1},_).catch((function(g){return S(A,void 0,void 0,(function(){var m;return v(this,(function(S){switch(S.label){case 0:return m="Failed to get IFrame source: ".concat(p(g)),C.push({success:!1,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript,errorMsg:m}),C.length>E&&C.shift(),[4,Promise.reject(new Error(m))];case 1:return[2,S.sent()]}}))}))}))];case 1:return b=P.sent(),m.srcdoc=b,g.appendChild(m),[4,new Promise((function(g,S){m.onload=function(){C.push({success:!0,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript}),C.length>E&&C.shift(),g()},m.onerror=function(g){var m="Failed to load HydraPlayer IFrame: ".concat(p(g));C.push({success:!1,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript,errorMsg:m}),C.length>E&&C.shift(),S(new Error(m))}}))];case 2:return P.sent(),[2]}}))}))}function l(g,m){return S(this,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,g(m).catch((function(C){return S(f,void 0,void 0,(function(){var f=this;return v(this,(function(_){switch(_.label){case 0:return 0!=--m?[3,2]:[4,Promise.reject(C)];case 1:case 3:return[2,_.sent()];case 2:return[4,new Promise((function(_){return setTimeout((function(){_(l(g,m).catch((function(g){return S(f,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(new Error("".concat(p(C)).concat(", ",p(g))))];case 1:return[2,m.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return C.sent(),[2]}}))}))}function c(g,m,f){return S(this,void 0,void 0,(function(){var C,_,E,T=this;return v(this,(function(I){switch(I.label){case 0:return C=Date.now(),[4,d(g,m,f).catch((function(g){return S(T,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(g)];case 1:return[2,m.sent()]}}))}))}))];case 1:return _=I.sent(),E="<script> ".concat(_,"<\/script>"),m.timeTakenToDownloadScript=Date.now()-C,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(E,"\n        </body>\n        </html>\n    ")]}}))}))}function d(g,m,f){return S(this,void 0,void 0,(function(){var C,_,E,T=this;return v(this,(function(I){switch(I.label){case 0:return C=function(g,m){var f,S;return m.includes("vz")?null!==(S=g.headers.get("uuid"))&&void 0!==S?S:"":null!==(f=g.headers.get("X-Azure-Ref"))&&void 0!==f?f:""},f?(_=new AbortController,E=setTimeout((function(){_.abort()}),f),[4,fetch(g,{signal:_.signal,cache:"no-cache"}).then((function(f){return S(T,void 0,void 0,(function(){return v(this,(function(S){switch(S.label){case 0:return clearTimeout(E),f.ok?[3,2]:[4,Promise.reject(new Error("".concat(f.status)))];case 1:return[2,S.sent()];case 2:return m.trackingRef=C(f,g),[2,f]}}))}))})).then((function(m){return S(T,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,m.text().then((function(C){return S(f,void 0,void 0,(function(){return v(this,(function(f){switch(f.label){case 0:return C?[2,C]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,f.sent()]}}))}))}))];case 1:return[2,C.sent()]}}))}))}))]):[3,2];case 1:case 3:return[2,I.sent()];case 2:return[4,fetch(g,{cache:"no-cache"}).then((function(f){return S(T,void 0,void 0,(function(){return v(this,(function(S){switch(S.label){case 0:return f.ok?[3,2]:[4,Promise.reject(new Error("".concat(f.status)))];case 1:return[2,S.sent()];case 2:return m.trackingRef=C(f,g),[2,f]}}))}))})).then((function(m){return S(T,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,m.text().then((function(C){return S(f,void 0,void 0,(function(){return v(this,(function(f){switch(f.label){case 0:return C?[2,C]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,f.sent()]}}))}))}))];case 1:return[2,C.sent()]}}))}))}))]}}))}))}function p(g){try{if(!g)return"".concat(g);if(g instanceof Map)return f={},g.forEach((function(g,m){f[m.toString()]=g})),JSON.stringify(f);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}catch(g){return""}var f}function y(g){return S(this,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,new Promise((function(m){return setTimeout(m,g)}))];case 1:return m.sent(),[2]}}))}))}m.getMajorFromVersion=function(g){var m=g.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return m?m[1]:null},m.createIFrame=function(g,m,f,C,_){return void 0===C&&(C=!1),S(this,void 0,void 0,(function(){var E,T,I,b,A=this;return v(this,(function(P){switch(P.label){case 0:return E=[],T=Date.now(),(I=g.ownerDocument.createElement("iframe")).id="player-iframe",C||I.sandbox.add("allow-scripts"),I.allowFullscreen=!0,I.allow="camera; microphone; autoplay",I.style.height="100%",I.style.width="100%",I.style.border="none",b=function(g){return m[g%m.length]},[4,l((function(m){return S(A,void 0,void 0,(function(){var f;return v(this,(function(S){switch(S.label){case 0:return f=b(m),[4,s(g,I,f,E,_)];case 1:return S.sent(),[2]}}))}))}),f).then((function(){return{iframe:I,initResult:{initSucceeded:!0,initStartTime:T,initDuration:Date.now()-T,runtimeDownloadResults:E}}})).catch((function(g){return S(A,void 0,void 0,(function(){var f;return v(this,(function(S){return f="Failed to load Hydra player runtime scripts, src: ",m.forEach((function(g){return f=f.concat(g,", ")})),f+="errors: ".concat(p(g)),[2,{initResult:{initSucceeded:!1,initStartTime:T,initDuration:Date.now()-T,runtimeDownloadResults:E,errorMsg:f}}]}))}))}))];case 1:return[2,P.sent()]}}))}))},m.assert=function(g,m,f){if(void 0===f&&(f=!1),!g){if(!f)throw new Error("Assert failed".concat(void 0!==m?": ".concat(m):""));console.error("Assert failed".concat(void 0!==m?": ".concat(m):""))}},m.getECSSetting=function(g,m,f){var S,v=f,C=null===(S=g.ecsSettings)||void 0===S?void 0:S[m];return typeof C==typeof v&&(v=C),v},m.getPlayerSetting=function(g,m){var f;return void 0!==(null===(f=g.ecsSettings)||void 0===f?void 0:f[m])?g.ecsSettings[m]:g[m]},m.getRandomHexString=function(g){return Array.from(Array(g)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},m.stringifyObject=p,m.wait=y,m.repeatUntilCancel=function(g,m,f,C){var _=!1,E=C||console.log;return E("RepeatUntilCancel starting task: ".concat(g)),S(this,void 0,void 0,(function(){var S,C,T;return v(this,(function(v){switch(v.label){case 0:return _?[3,2]:(S=new Date,m(),C=(new Date).getTime()-S.getTime(),(T=f-C)<0&&(T=f+T%f,E("Skipping execution for ".concat(g,", last execution took: ").concat(C," ms, delayMs: ").concat(f),"warn")),[4,y(T)]);case 1:return v.sent(),[3,0];case 2:return[2]}}))})),function(){E("RepeatUntilCancel stopping task: ".concat(g)),_=!0}};var E=function(){function e3(g){this.container=g,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var m=this.container.ownerDocument.getElementById(this.spinnerId);if(m)return this.spinner=m,void this.show();var f=this.container.ownerDocument.createElement("style");f.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(f),this.container.style.position="relative";var S=this.container.ownerDocument.createElement("div");S.classList.add("ml-player-spinner-container"),this.container.appendChild(S),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,S.appendChild(this.spinner);var v=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");v.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(v);var C=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");C.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(C),this.show()}return Object.defineProperty(e3.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var g=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];g.hideTimestamp||(g.displayDuration=Date.now()-g.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e3.prototype.show=function(){var g=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=g),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:g,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e3.prototype.hide=function(){var g=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=g),this.spinnerInfoHistory.length>0){var m=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];m.hideTimestamp||(m.hideTimestamp=g,m.displayDuration=g-m.showTimestamp)}this.spinner.style.display="none"},e3.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e3}();m.Spinner=E,m.getSdnStats=function(g,m){(null==g?void 0:g.peer5)&&(m.sdnName=g.peer5?C.HydraSupportedSDN.Microsoft:"",m.sdnVersion=g.peer5?g.peer5.version:"","function"==typeof g.peer5.getStats&&(m.sdnStats=g.peer5.getStats(),m.isP2PSdnUsed=g.peer5.getStats().numOfPeers>0))},m.showPlayerControls=function(g){return void 0!==g.allowPlayerControls?g.allowPlayerControls:g.streamingEventType===_.HydraStreamingEventType.TLE},m.createVideoElementDiv=function(g,m,f){f("createVideoElementDiv started");var S=m.ownerDocument.createElement("div");return S.id=g,S.style.position="relative",S.style.width="100%",S.style.height="100%",m.appendChild(S),f("createVideoElementDiv done"),S},m.createVideoElement=function(g,m,f,S,v){v("createVideoElement started");var C=m.ownerDocument.createElement("video");C.controls=S,C.id=g,C.setAttribute("playsinline","");var _=f.videoLang;_&&(C.setAttribute("lang",_),v("createVideoElement: language set to ".concat(_)));for(var E=f.videoElementStyles,T=0;T<E.length;T++)C.classList.add(E[T]);return C.style.width="100%",C.style.height="100%",C.style.position="absolute",C.muted=f.muteVideo,C.addEventListener("contextmenu",(function(g){g.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(g){try{navigator.mediaSession.setActionHandler(g,(function(){}))}catch(g){}})),m.appendChild(C),v("createVideoElement done"),C}}},m={},function r(f){var S=m[f];if(void 0!==S)return S.exports;var v=m[f]={exports:{}};return g[f].call(v.exports,v,v.exports,r),v.exports}(855);var g,m},"object"==typeof g&&"object"==typeof m?m.exports=S():"object"==typeof g?g.hydra_player_hls_sdk=S():f.hydra_player_hls_sdk=S()}}),ne=__commonJS({"../node_modules/@skype/hydra_player_ums_sdk/hydra_player_ums_sdk_bundle.js"(g,m){var f,S;f=g,S=function(){return g={458:function(g,m,f){var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.LiveStreamStatistic=void 0;var v=f(844),C=f(68),_=f(63),E=f(329),T=function(){function e3(g,m,f){this.name=g,this.stopCrash=m,this.start(f)}return e3.prototype.complete=function(){try{E.assert(this.startTime,"not started",this.stopCrash),E.assert(void 0===this.duration,"already completed",this.stopCrash)}catch(g){if(this.name!==v.PlayerScenarioType.LoadHlsFirstFragment&&this.name!==v.PlayerScenarioType.HlsKeyLoad)throw g}this.duration=Date.now()-this.startTime},e3.prototype.fail=function(g){this.failReason=g,this.complete()},e3.prototype.setDetail=function(g){this.details=g},e3.prototype.getTelemetryEvent=function(){E.assert(this.startTime,"not started",this.stopCrash);var g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g},e3.prototype.getName=function(){return this.name},e3.prototype.getDuration=function(){var g;return null!==(g=this.duration)&&void 0!==g?g:0},e3.prototype.getFailReason=function(){return this.failReason},e3.prototype.getDetails=function(){return this.details},e3.prototype.start=function(g){E.assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),g&&(this.details=g)},e3.prototype.updateDetails=function(g,m){if(this.details&&"object"==typeof this.details)for(var f=0;f<g.length;f++)this.details[g[f]]=m[f]},e3}(),I=function(){function e3(g,m,f,S,v){this.config=g,this.logFn=m,this.playerDiagnosticsLog=f,this.playerMetadata=S,this.hydraInitResult=v,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.experimentalEvents=[],this.callSetupSucceeded=!1,this.callDropped=!1,this.isCallRecovered=!1,this.isCallInErrorState=!1,this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxPlayerExperimentalEvents=g.maxPlayerExperimentalEvents||100,E.getECSSetting(this.config,"stopCrash",!1)?this.stopCrash=!1:this.stopCrash=!0,this.config.debugLogging&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}return e3.prototype.getPlayerDiagnosticSnapshot=function(){return this.currentPlayerDiagnosticSnapshot},e3.prototype.registerStatsUpdated=function(g){var m=this;this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((function(f){var S,v=f,C=null!==(S=m.playerDiagnosticsLog[f])&&void 0!==S?S:[];if(Array.isArray(C)){C.push(g[v]);var _="memoryLog"===v&&C.length>m.maxPlayerMemoryTraceLogCount,E="memoryLog"!==v&&C.length>m.maxPlayerDiagnosticsCount;(_||E)&&C.splice(0,1)}else m.playerDiagnosticsLog[f]=g[v]}))},e3.prototype.registerEventLoadAttempt=function(g,m){this.registerScenario(g,m)},e3.prototype.registerEventLoadFailed=function(g,m){this.completeScenario(g,m)},e3.prototype.registerEventLoadSucceeded=function(g,m){this.completeScenario(g,void 0,m),g===v.PlayerScenarioType.LoadPlayer&&(this.callSetupSucceeded=!0)},e3.prototype.registerSdnPluginLoadAttempt=function(g){this.registerScenario(v.PlayerScenarioType.SdnPluginLoad,JSON.stringify(g))},e3.prototype.registerSdnPluginLoadFailed=function(g){this.completeScenario(v.PlayerScenarioType.SdnPluginLoad,g)},e3.prototype.registerSdnPluginLoadSucceeded=function(){this.completeScenario(v.PlayerScenarioType.SdnPluginLoad)},e3.prototype.registerStreamConnectionAttempt=function(g){this.registerScenario(v.PlayerScenarioType.StreamConnection,{streamUrl:g})},e3.prototype.registerStreamConnectionSucceeded=function(g){var m=this.getScenario(v.PlayerScenarioType.StreamConnection);null==m||m.updateDetails(["results"],[E.stringifyObject(g)]),this.completeScenario(v.PlayerScenarioType.StreamConnection)},e3.prototype.registerStreamConnectionFailed=function(g,m){var f=this.getScenario(v.PlayerScenarioType.StreamConnection);null==f||f.updateDetails(["results"],[E.stringifyObject(m)]),this.completeScenario(v.PlayerScenarioType.StreamConnection,g)},e3.prototype.registerSetSourceAttempt=function(g,m,f){var S=g||"";f&&(S={src:g||"",isPrimary:E.stringifyObject(m),reason:f}),this.registerScenario(v.PlayerScenarioType.SetSource,S)},e3.prototype.registerSetSourceSucceeded=function(g,m,f,S){var C=this.getScenario(v.PlayerScenarioType.SetSource);E.assert(C,"no SetSource scenario to update details",this.stopCrash),null==C||C.updateDetails(["src","isPrimary","SwitchingDiagnostics","StepDuration"],[g,E.stringifyObject(m),E.stringifyObject(f),E.stringifyObject(S)]),this.completeScenario(v.PlayerScenarioType.SetSource)},e3.prototype.registerSetSourceFailed=function(g,m,f,S,C){var _=null!=m?m:"Failed to find stream url",T=this.getScenario(v.PlayerScenarioType.SetSource);E.assert(T,"no SetSource scenario to update details",this.stopCrash),null==T||T.updateDetails(["src","isPrimary","SwitchingDiagnostics","stepDuration"],[_,E.stringifyObject(f),E.stringifyObject(S),E.stringifyObject(C)]),this.completeScenario(v.PlayerScenarioType.SetSource,g)},e3.prototype.registerPlayerDestroyed=function(g){this.callDropped=g===_.HydraPlayerDestroyedReason.PlaybackError,this.registerScenario(v.PlayerScenarioType.Destroyed,g),this.completeScenario(v.PlayerScenarioType.Destroyed)},e3.prototype.updateCallRecovered=function(g){this.isCallInErrorState&&g===C.HydraPlayerPlaybackState.Playing&&(this.isCallRecovered=!0,this.isCallInErrorState=!1)},e3.prototype.registerPlaybackStateChanged=function(g){g!==C.HydraPlayerPlaybackState.CanPlayThrough||this.firstReadyStateTimestamp?g!==C.HydraPlayerPlaybackState.Playing||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),this.registerPlaybackEvent(v.TelemetryEventType.StateChanged,g),this.updateCallRecovered(g)},e3.prototype.registerHydraInputStateChanged=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.HydraInputStateChanged,g,m)},e3.prototype.registerHydraOutputStateChanged=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.HydraOutputStateChanged,g,m)},e3.prototype.registerPlaybackBuffering=function(g){this.registerPlaybackEvent(v.TelemetryEventType.Buffering,g)},e3.prototype.registerPlaybackError=function(g,m,f){this.registerPlaybackEvent(v.TelemetryEventType.Error,{errorType:g,details:m,errorSource:f})},e3.prototype.registerDownloadBitrateChanged=function(g){this.registerPlaybackEvent(v.TelemetryEventType.BitrateChangedDownload,g)},e3.prototype.registerStreamOptionsConfigured=function(g,m){this.registerPlaybackEvent(v.TelemetryEventType.StreamOptionsConfigured,g,m)},e3.prototype.registerPlaybackBitrateChanged=function(g){this.registerPlaybackEvent(v.TelemetryEventType.BitrateChangedPlayback,g)},e3.prototype.registerVolumeChange=function(g){this.registerPlaybackEvent(v.TelemetryEventType.Volume,g)},e3.prototype.getSnapshotReport=function(){var g,m,f=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),v=this.playbackEvents,C={};return this.currentPlayerDiagnosticSnapshot&&(C=this.filterAndPrepareTelemetry()),S(S(S(S(S(S(S(S(S(S(S(S(S({isFullReport:!1,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(f,v)),this.getHydraInternalReport(v)),this.getPlaybackReport(v)),this.getBitrateReport(v)),this.getStreamConnectionReport(f)),this.getSdnReport(f)),this.getSetSourceReport(f)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),C)},e3.prototype.getReport=function(){var g,m,f=[this.getTotalLoadEvent(),this.getHydraLoadEvent()].concat(this.playerEvents.map((function(g){return g.getTelemetryEvent()}))),v=this.playbackEvents;return S(S(S(S(S(S(S(S(S(S(S(S(S({isFullReport:!0,configIds:this.config.configIds||"",eTag:this.config.eTag||""},this.getPlayerMetadataReport()),{isIframe:!0,isFullscreenButtonDisabled:!1,telemetryTickMs:null!==(m=null===(g=this.currentPlayerDiagnosticSnapshot)||void 0===g?void 0:g.statsInterval)&&void 0!==m?m:-1}),this.getHydraInitializationReport()),this.getPlayerInitializationReport(f,v)),this.getHydraInternalReport(v)),this.getPlaybackReport(v)),this.getBitrateReport(v)),this.getStreamConnectionReport(f)),this.getSdnReport(f)),this.getSetSourceReport(f)),this.getExperimentalEvents()),{networkType:this.getClientNetworkType(),callSetupSucceeded:this.callSetupSucceeded,callDropped:this.callDropped,callRecovered:this.isCallRecovered}),this.getPlayerDiagnosticLog())},e3.prototype.getHydraLoadEvent=function(){var g,m,f,S={name:v.PlayerScenarioType.LoadHydra,startTime:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initStartTime)||-1,duration:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initDuration)||0};(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)&&(S.failReason=this.hydraInitResult.errorMsg);var C=this.getHydraRuntimeDownloadDetails();return C&&(S.details=C),S},e3.prototype.getHydraRuntimeDownloadDetails=function(){if(this.hydraInitResult){for(var g=[],m=0,f=this.hydraInitResult.runtimeDownloadResults;m<f.length;m++){var S=f[m],v={success:S.success,url:S.url,startTime:S.startTime,duration:S.duration,trackingReference:S.trackingReference,timeTakenToDownloadScript:S.timeTakenToDownloadScript};S.errorMsg&&(v.errorMsg=S.errorMsg),g.push(v)}return E.stringifyObject(g)}return null},e3.prototype.getTotalLoadEvent=function(){var g,m,f,S=this.playerEvents.find((function(g){return g.getName()===v.PlayerScenarioType.LoadPlayer})),C=(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initDuration)||0,_=(null==S?void 0:S.getDuration())||0,E=null==S?void 0:S.getFailReason(),T={name:v.PlayerScenarioType.Load,startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,duration:C+_};return(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)?T.failReason=this.hydraInitResult.errorMsg:E&&(T.failReason=E),T},e3.prototype.getPlayerMetadataReport=function(){return{playerId:this.playerMetadata.playerId||"",traceId:this.playerMetadata.playerId?this.playerMetadata.playerId.replace(/-/g,""):"",hydraPlayerRuntimeVersion:this.playerMetadata.hydraPlayerRuntimeVersion||"",hydraPlayerSdkVersion:this.playerMetadata.hydraPlayerSdkVersion,player_playerType:this.playerMetadata.hydraPlayerType}},e3.prototype.registerPlaybackEvent=function(g,m,f){var S=this.createTelemetryEvent(g,m,f);g===v.TelemetryEventType.Error&&(null==m?void 0:m.errorType)!==C.HydraPlayerPlaybackErrorType.PlaybackRetried&&(S.fatal=!0,this.isCallInErrorState=!0),this.playbackEvents.push(S),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(S)},e3.prototype.getPlayerDiagnosticLog=function(){var g=this;if(!this.currentPlayerDiagnosticSnapshot)return{};var m=this.currentPlayerDiagnosticSnapshot,f=this.playerDiagnosticsLog,v=S(S({},m),f),C={};return Object.keys(v).forEach((function(m){C["player_".concat(m)]=g.prepareForTelemetry(v[m])})),C},e3.prototype.getHydraInitializationReport=function(){var g,m,f,S;return{hydraInit_succeeded:(null===(g=this.hydraInitResult)||void 0===g?void 0:g.initSucceeded)||!1,hydraInit_startTime:(null===(m=this.hydraInitResult)||void 0===m?void 0:m.initStartTime)||-1,hydraInit_errorMessage:(null===(f=this.hydraInitResult)||void 0===f?void 0:f.errorMsg)||"",hydraInit_duration:(null===(S=this.hydraInitResult)||void 0===S?void 0:S.initDuration)||0}},e3.prototype.getPlayerInitializationReport=function(g,m){var f=g.find((function(g){return g.name===v.PlayerScenarioType.Load}));return{init_timeLoadToStreamConnectionEstablished:(null!=f&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-f.startTime:-1)||-1,init_timeLoadToReady:(null!=f&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-f.startTime:-1)||-1,init_timeLoadToPlaying:(null!=f&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-f.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}},e3.prototype.getHydraInternalReport=function(g){var m=g.filter((function(g){return g.eventType===v.TelemetryEventType.HydraInputStateChanged})),f=g.filter((function(g){return g.eventType===v.TelemetryEventType.HydraOutputStateChanged}));return{hydra_inputStateChangeEvents:this.prepareForTelemetry(m),hydra_outputStateChangeEvents:this.prepareForTelemetry(f)}},e3.prototype.getPlaybackReport=function(g){var m=g.filter((function(g){return g.eventType===v.TelemetryEventType.StateChanged})),f=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.CanPlayThrough})),S=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Play})),_=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Start})),E=m.find((function(g){return g.payload===C.HydraPlayerPlaybackState.Playing})),T=null!=f&&null!=S?S.timestamp-f.timestamp:-1,I=null!=S&&null!=_?_.timestamp-S.timestamp:-1,b=null!=_&&null!=E?E.timestamp-_.timestamp:-1,A=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Seeked})),P=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Seeking})),R=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Pause})),w=m.filter((function(g){return g.payload===C.HydraPlayerPlaybackState.Waiting})),M=[v.TelemetryEventType.BitrateChangedDownload,v.TelemetryEventType.BitrateChangedPlayback,v.TelemetryEventType.Error,v.TelemetryEventType.Mute,v.TelemetryEventType.StateChanged,v.TelemetryEventType.Volume,v.TelemetryEventType.StreamOptionsConfigured],D=g.filter((function(g){return g.eventType===v.TelemetryEventType.Error})),O=g.filter((function(g){return g.eventType===v.TelemetryEventType.Volume||g.eventType===v.TelemetryEventType.Mute})),N=g.filter((function(g){return g.eventType===v.TelemetryEventType.StreamOptionsConfigured})),k=g.filter((function(g){return!M.includes(g.eventType)}));return{playback_timeReadyToPlay:T,playback_timePlayToStart:I,playback_timeStartToPlaying:b,playback_bufferingEvents:this.prepareForTelemetry(w),playback_errorEvents:this.prepareForTelemetry(D),playback_pauseEvents:this.prepareForTelemetry(R),playback_otherEvents:this.prepareForTelemetry(k),playback_seekedEvents:this.prepareForTelemetry(A),playback_seekingEvents:this.prepareForTelemetry(P),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(O),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(N)}},e3.prototype.getBitrateReport=function(g){var m,f,C,_,E=g.filter((function(g){return g.eventType===v.TelemetryEventType.BitrateChangedDownload})),T=E.sort((function(g){return Number(g.payload)})),I=E.length>0?{bitrate_downloadChanges:this.prepareForTelemetry(E),bitrate_downloadChangeCount:E.length>0||-1,bitrate_downloadMin:(null===(m=T[0])||void 0===m?void 0:m.payload)||-1,bitrate_downloadMax:(null===(f=T[T.length-1])||void 0===f?void 0:f.payload)||-1}:{},b=g.filter((function(g){return g.eventType===v.TelemetryEventType.BitrateChangedPlayback})),A=b.sort((function(g){return Number(g.payload)})),P=b.length>0?{bitrate_playbackChanges:this.prepareForTelemetry(b),bitrate_playbackChangeCount:b.length>0||-1,bitrate_playbackMin:(null===(C=A[0])||void 0===C?void 0:C.payload)||-1,bitrate_playbackMax:(null===(_=A[A.length-1])||void 0===_?void 0:_.payload)||-1}:{};return S(S({},I),P)},e3.prototype.addNetworkTypeEventListener=function(){var g,m,f,S,v=this;(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)&&(null===(S=null===(f=window.navigator)||void 0===f?void 0:f.connection)||void 0===S||S.addEventListener("change",(function(){v.updateClientNetworkType()})))},e3.prototype.updateClientNetworkType=function(){this.clientNetworkType=void 0,this.getClientNetworkType()},e3.prototype.getClientNetworkType=function(){var g,m,f,S;if(void 0===this.clientNetworkType){var v="Unknown";if(null===(m=null===(g=window.navigator)||void 0===g?void 0:g.connection)||void 0===m?void 0:m.type)switch(null===(S=null===(f=window.navigator)||void 0===f?void 0:f.connection)||void 0===S?void 0:S.type){case"cellular":v="WWAN";break;case"ethernet":v="Wired";break;case"wifi":v="Wireless";break;default:v="Unknown"}this.clientNetworkType=v}return this.clientNetworkType},e3.prototype.getSdnReport=function(g){var m,f,S=g.filter((function(g){return g.name===v.PlayerScenarioType.SdnPluginLoad})),C=S.length>0?S[S.length-1]:void 0;return{sdn_loaded:!(null==C||void 0!==C.failReason),sdn_details:null!==(m=null==C?void 0:C.details)&&void 0!==m?m:"",sdn_error:null!==(f=null==C?void 0:C.failReason)&&void 0!==f?f:"",sdn_events:this.prepareForTelemetry(S)}},e3.prototype.getStreamConnectionReport=function(g){var m=g.filter((function(g){return g.name===v.PlayerScenarioType.StreamConnection}));return{stream_connection_events:this.prepareForTelemetry(m)}},e3.prototype.getSetSourceReport=function(g){var m=g.filter((function(g){return g.name===v.PlayerScenarioType.SetSource}));return{set_source_events:this.prepareForTelemetry(m)}},e3.prototype.registerScenario=function(g,m){var f=this.currentScenarioMap.get(g),S=new T(g,this.stopCrash,m);try{E.assert(null==f,"previous scenario:".concat(E.stringifyObject(f)," is not completed, new scenario:").concat(E.stringifyObject(S)),this.stopCrash)}catch(m){if(g!==v.PlayerScenarioType.LoadHlsFirstFragment&&g!==v.PlayerScenarioType.HlsKeyLoad)throw m}this.currentScenarioMap.set(g,S),this.playerEvents.push(S)},e3.prototype.completeScenario=function(g,m,f){var S=this.currentScenarioMap.get(g);try{E.assert(S,"no scenario to complete",this.stopCrash)}catch(m){if(g!==v.PlayerScenarioType.LoadHlsFirstFragment&&g!==v.PlayerScenarioType.HlsKeyLoad)throw m}m?null==S||S.fail(m):(g!==v.PlayerScenarioType.StreamConnection||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),f&&(null==S||S.setDetail(f)),null==S||S.complete()),this.currentScenarioMap.delete(g)},e3.prototype.logTelemetryEvent=function(g){this.config.debugLogging&&(this.logFn("debug","PlayerTelemetryEvent: ".concat(JSON.stringify(g))),this.logFn("debug","PlayerDiagnosticData: ".concat(JSON.stringify(this.currentPlayerDiagnosticSnapshot))))},e3.prototype.filterAndPrepareTelemetry=function(){var g=this,m=new Set;m.add("serviceLatencyCdg"),m.add("endToEndLatencyCdg"),m.add("videoEdgeLatencyCdg");var f={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((function(S){m.has(S)||(f["player_".concat(S)]=g.prepareForTelemetry(g.currentPlayerDiagnosticSnapshot[S]))})),f},e3.prototype.prepareForTelemetry=function(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?null!=g?g:-1:JSON.stringify(g)},e3.prototype.getScenario=function(g){return this.currentScenarioMap.get(g)},e3.prototype.createTelemetryEvent=function(g,m,f){var S,v,C={eventType:g,timestamp:Date.now(),currentPlayPosition:null!==(v=null===(S=this.currentPlayerDiagnosticSnapshot)||void 0===S?void 0:S.currentPlayPosition)&&void 0!==v?v:-1};return void 0!==m&&(C.payload=this.prepareForTelemetry(m)),C.message=f,C},e3.prototype.registerExperimentalEvent=function(g,m,f){var S=this.createTelemetryEvent(g,m,f);this.experimentalEvents.push(S),this.experimentalEvents.length>this.maxPlayerExperimentalEvents&&this.experimentalEvents.splice(0,1),this.logTelemetryEvent(S)},e3.prototype.getExperimentalEvents=function(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}},e3}();m.LiveStreamStatistic=I},751:function(g,m){var f,S,v,C,_,E;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(E=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",E.HLS="MiddleLaneHttpLiveStreaming",E.Ums="MiddleLaneUltraLowLatency",(_=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",_.PlayerInitializationFailed="PlayerInitializationFailed",_.InvalidStream="InvalidStream",_.SetSourceFailed="SetSourceFailed",(C=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",C.LoadedData="loadeddata",C.LoadedMetadata="loadedmetadata",C.Start="start",C.CanPlayThrough="canplaythrough",C.Play="play",C.Playing="playing",C.Pause="pause",C.Waiting="waiting",C.Seeking="seeking",C.Seeked="seeked",C.Ended="ended",C.Error="error",C.Destroyed="destroyed",C.Initialized="initialized",C.Stalled="stalled",C.VolumeChange="volumechange",C.PlaybackBitrateChanged="playbackbitratechanged",C.DownloadBitrateChanged="downloadbitratechanged",C.HlsKeyLoading="hlsKeyLoading",C.HlsKeyLoaded="hlsKeyLoaded",C.HlsKeyLoadedFailed="hlsKeyLoadedFailed",C.HlsManifestLoading="hlsManifestLoading",C.HlsManifestLoaded="hlsManifestLoaded",C.HlsManifestLoadedFailed="hlsManifestLoadedFailed",C.HlsFirstFragmentLoading="hlsFragLoading",C.HlsFirstFragmentBuffered="hlsFragBuffered",C.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",C.Online="online",C.Offline="offline",C.NetworkChange="networkChange",(v=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",v.NetworkError="NetworkError",v.PlaybackRetried="PlaybackRetried",v.PlaybackError="PlaybackError",v.Unknown="Unknown",(S=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",S.Overflow="Overflow",S.TownHallBasic="TownHall_Basic",S.TownHallPremium="TownHall_Premium",S.TownHall="TownHall",(f=m.HydraPlayerType||(m.HydraPlayerType={}))[f.Hls=1]="Hls",f[f.Ums=2]="Ums"},979:function(g,m,f){var S=this&&this.__createBinding||(Object.create?function(g,m,f,S){void 0===S&&(S=f);var v=Object.getOwnPropertyDescriptor(m,f);v&&!("get"in v?!m.__esModule:v.writable||v.configurable)||(v={enumerable:!0,get:function(){return m[f]}}),Object.defineProperty(g,S,v)}:function(g,m,f,S){void 0===S&&(S=f),g[S]=m[f]}),v=this&&this.__exportStar||function(g,m){for(var f in g)"default"===f||Object.prototype.hasOwnProperty.call(m,f)||S(m,g,f)};Object.defineProperty(m,"__esModule",{value:!0}),v(f(165),m),v(f(751),m)},165:function(g,m,f){var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)},v=this&&this.__awaiter||function(g,m,f,S){return new(f||(f=Promise))((function(v,C){function o2(g){try{l2(S.next(g))}catch(g){C(g)}}function s2(g){try{l2(S.throw(g))}catch(g){C(g)}}function l2(g){var m;g.done?v(g.value):(m=g.value,m instanceof f?m:new f((function(g){g(m)}))).then(o2,s2)}l2((S=S.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function s2(E){return function(T){return function(E){if(f)throw new TypeError("Generator is already executing.");for(;C&&(C=0,E[0]&&(_=0)),_;)try{if(f=1,S&&(v=2&E[0]?S.return:E[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,E[1])).done)return v;switch(S=0,v&&(E=[2&E[0],v.value]),E[0]){case 0:case 1:v=E;break;case 4:return _.label++,{value:E[1],done:!1};case 5:_.label++,S=E[1],E=[0];continue;case 7:E=_.ops.pop(),_.trys.pop();continue;default:if(!((v=(v=_.trys).length>0&&v[v.length-1])||6!==E[0]&&2!==E[0])){_=0;continue}if(3===E[0]&&(!v||E[1]>v[0]&&E[1]<v[3])){_.label=E[1];break}if(6===E[0]&&_.label<v[1]){_.label=v[1],v=E;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(E);break}v[2]&&_.ops.pop(),_.trys.pop();continue}E=m.call(g,_)}catch(g){E=[6,g],S=0}finally{f=v=0}if(5&E[0])throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}([E,T])}}},_=this&&this.__spreadArray||function(g,m,f){if(f||2===arguments.length)for(var S,v=0,C=m.length;v<C;v++)!S&&v in m||(S||(S=Array.prototype.slice.call(m,0,v)),S[v]=m[v]);return g.concat(S||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0}),m.UmsHydraPlayer=m.getSdkVersion=void 0;var E=f(124),T=f(68),I=f(328),b=f(844),A=f(63),P=f(458),R=f(329),w=f(944);m.getSdkVersion=function(){return"4.2410.1"};var M=function(){function e3(g,m){this.playerSettings=g,this.eventHandler=m,this.spinner=null,this.commandResultsMap=new Map,this._onMessage=this.onMessage.bind(this),this.telemetryReportHandler=null,this.playerInternalEventHandler=null,this.playerRuntimeJsUrls=this.getRuntimeJsUrls(),this.playerSettings.hydraPlayerSdkVersion="4.2410.1"}return Object.defineProperty(e3.prototype,"contextWindow",{get:function(){var g;return null===(g=this.container)||void 0===g?void 0:g.ownerDocument.defaultView},enumerable:!1,configurable:!0}),e3.prototype.getRuntimeJsUrls=function(){if(!Array.isArray(this.playerSettings.playerRuntimeJsUrls)){var g=(0,R.getMajorFromVersion)("4.2410.1");return g&&this.playerSettings.playerRuntimeJsUrls[g]||[]}return this.playerSettings.playerRuntimeJsUrls},e3.prototype.initializeIFrame=function(g){return v(this,void 0,void 0,(function(){var m;return C(this,(function(f){switch(f.label){case 0:return this.container=g,0===this.playerRuntimeJsUrls.length?[2,{initSucceeded:!1,initStartTime:Date.now(),initDuration:0,runtimeDownloadResults:[],errorMsg:"No compatible runtime URL provided for version ".concat("4.2410.1",', URLs: "').concat((0,R.stringifyObject)(this.playerSettings.playerRuntimeJsUrls),'"')}]:[4,(0,R.createIFrame)(g,this.playerRuntimeJsUrls,this.playerSettings.maxRetryCountForLoadingResources,this.playerSettings.disableSandbox,this.playerSettings.hydraRuntimeFetchTimeout)];case 1:return(m=f.sent()).initResult.initSucceeded&&m.iframe&&(this.iframe=m.iframe,this.contextWindow.addEventListener("message",this._onMessage)),[2,m.initResult]}}))}))},e3.prototype.setup=function(g){return v(this,void 0,void 0,(function(){var m;return C(this,(function(f){switch(f.label){case 0:return this.spinner=new R.Spinner(g),[4,this.initializeIFrame(g)];case 1:return m=f.sent(),this.telemetryReportHandler=new O(this.playerSettings,this.eventHandler.log.bind(this.eventHandler),m,this.spinner),this.playerInternalEventHandler=new D(this.spinner,this.telemetryReportHandler),m.initSucceeded?[4,this.sendCommand("createUmsHydraPlayer",this.playerSettings,m)]:[3,3];case 2:return f.sent(),[2,!0];case 3:return this.eventHandler.log("error","Failed to setup HydraPlayer: ".concat(m.errorMsg)),this.spinner.hide(),[2,!1]}}))}))},e3.prototype.isIFrameCommunicationActive=function(){var g;return!!(null===(g=this.iframe)||void 0===g?void 0:g.contentWindow)&&!!this.contextWindow},e3.prototype.getFullTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getFullTelemetryReport())||{}},e3.prototype.getSnapshotTelemetryReport=function(){var g;return(null===(g=this.telemetryReportHandler)||void 0===g?void 0:g.getSnapshotTelemetryReport())||{}},e3.prototype.callPlayerApi=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];return v(this,void 0,void 0,(function(){return C(this,(function(f){switch(f.label){case 0:return this.iframe?[4,this.sendCommand.apply(this,_([g],m,!1))]:[3,2];case 1:case 3:return[2,f.sent()];case 2:return[4,Promise.reject(new Error("Hydra IFrame not initialized yet"))]}}))}))},e3.prototype.dispose=function(){var g;null===(g=this.telemetryReportHandler)||void 0===g||g.addDisposeTelemetry(),this.isIFrameCommunicationActive()&&this.sendCommand("disposeHydraPlayer")},e3.prototype.release=function(){var g;null===(g=this.spinner)||void 0===g||g.hide(),this.contextWindow&&this.contextWindow.removeEventListener("message",this._onMessage),this.iframe&&this.container&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe)},e3.prototype.sendCommand=function(g){for(var m,f,S=[],_=1;_<arguments.length;_++)S[_-1]=arguments[_];return v(this,void 0,void 0,(function(){var v,_,T;return C(this,(function(C){switch(C.label){case 0:if(v={msgType:E.MessageType.Command,name:g,args:S},!this.isIFrameCommunicationActive())throw new Error("IFrame MessageAPI communication not active");return void 0!==(_=this.commandResultsMap.get(g.toString()))&&_.reject(new Error("function ".concat(g," is invoked again, before previous call is completed"))),T=w.defer(),this.commandResultsMap.set(g,T),null===(f=null===(m=this.iframe)||void 0===m?void 0:m.contentWindow)||void 0===f||f.postMessage(v,"*"),[4,T.promise];case 1:return[2,C.sent()]}}))}))},e3.prototype.onMessage=function(g){switch(g.data.msgType){case E.MessageType.PlayerEvent:this.processPlayerEvent(g.data);break;case E.MessageType.InternalPlayerEvent:this.processInternalPlayerEvent(g.data);break;case E.MessageType.CommandSuccessResult:this.processCommandSuccessResult(g.data);break;case E.MessageType.CommandFailureResult:this.processCommandFailureResult(g.data)}},e3.prototype.processCommandSuccessResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.resolve(g.result),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processCommandFailureResult=function(g){var m=this.commandResultsMap.get(g.name.toString());void 0!==m&&(m.reject(g.error),this.commandResultsMap.delete(g.name.toString()))},e3.prototype.processPlayerEvent=function(g){this.eventHandler[g.name].apply(this.eventHandler,g.args)},e3.prototype.processInternalPlayerEvent=function(g){this.playerInternalEventHandler&&this.playerInternalEventHandler[g.name].apply(this,g.args)},e3}();m.UmsHydraPlayer=M;var D=function(){function e3(g,m){this.spinner=g,this.telemetryReportHandler=m}return e3.prototype.firstPlayerLoadAttemptDone=function(){this.spinner.hide()},e3.prototype.fullTelemetryReportUpdated=function(g){this.telemetryReportHandler.setFullTelemetryReport(g)},e3.prototype.snapshotTelemetryReportUpdated=function(g){this.telemetryReportHandler.setSnapshotTelemetryReport(g)},e3}(),O=function(){function e3(g,m,f,S){var v=this;this.logFn=m,this.spinner=S;var C=new P.LiveStreamStatistic(g,(function(g,m){v.logFn(g,m)}),{currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]},{hydraPlayerSdkVersion:g.hydraPlayerSdkVersion||"Unknown",hydraPlayerType:I.HydraPlayerType.Ums},f);this.fullTelemetryReport=C.getReport(),this.snapshotTelemetryReport=C.getSnapshotReport()}return e3.prototype.getFullTelemetryReport=function(){return this.fullTelemetryReport},e3.prototype.getSnapshotTelemetryReport=function(){return this.snapshotTelemetryReport},e3.prototype.setFullTelemetryReport=function(g){var m,f,v;this.fullTelemetryReport=S(S({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(f=this.spinner.firstHideTimestamp)&&void 0!==f?f:-1,init_spinnerDuration:null!==(v=this.spinner.firstSpinnerDuration)&&void 0!==v?v:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.setSnapshotTelemetryReport=function(g){var m,f,v;this.snapshotTelemetryReport=S(S({},g),{init_spinnerShowTimestamp:null!==(m=this.spinner.firstShowTimestamp)&&void 0!==m?m:-1,init_spinnerHideTimestamp:null!==(f=this.spinner.firstHideTimestamp)&&void 0!==f?f:-1,init_spinnerDuration:null!==(v=this.spinner.firstSpinnerDuration)&&void 0!==v?v:-1,init_spinnerVisible:this.spinner.isVisible()})},e3.prototype.addDisposeTelemetry=function(){var g=Date.now();try{this.updateInitEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in full telemetry report")}try{this.updateInitEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to init_allEvents telemetry field in snapshot telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.fullTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in full telemetry report")}try{this.updateStateChangeEventsWithDisposeEvent(this.snapshotTelemetryReport,g)}catch(g){this.logFn("warn","Failed to add player destroyed information to playback_stateChangeEvents telemetry field in snapshot telemetry report")}this.fullTelemetryReport.hydraDisposeTimestamp=g,this.snapshotTelemetryReport.hydraDisposeTimestamp=g},e3.prototype.updateInitEventsWithDisposeEvent=function(g,m){var f=g.init_allEvents,S=JSON.parse(f);S[S.length-1].name!==b.PlayerScenarioType.Destroyed&&S.push({name:b.PlayerScenarioType.Destroyed,startTime:m,duration:0,details:A.HydraPlayerDestroyedReason.PlayerStopped}),g.init_allEvents=(0,R.stringifyObject)(S)},e3.prototype.updateStateChangeEventsWithDisposeEvent=function(g,m){var f=g.playback_stateChangeEvents,S=JSON.parse(f);S[S.length-1].payload!==T.HydraPlayerPlaybackState.Destroyed&&S.push({eventType:b.TelemetryEventType.StateChanged,timestamp:m,currentPlayPosition:-1,payload:T.HydraPlayerPlaybackState.Destroyed}),g.playback_stateChangeEvents=(0,R.stringifyObject)(S)},e3}()},124:function(g,m){var f;Object.defineProperty(m,"__esModule",{value:!0}),m.MessageType=void 0,(f=m.MessageType||(m.MessageType={})).Command="Command",f.CommandSuccessResult="CommandSuccessResult",f.CommandFailureResult="CommandFailureResult",f.PlayerEvent="PlayerEvent",f.InternalPlayerEvent="InternalPlayerEvent"},63:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraSupportedSDN=m.HydraPlayerDestroyedReason=void 0,(S=m.HydraPlayerDestroyedReason||(m.HydraPlayerDestroyedReason={})).PlayerStopped="PlayerStopped",S.PlaybackError="PlaybackError",(f=m.HydraSupportedSDN||(m.HydraSupportedSDN={})).Hive="hive",f.Kollective="kollective",f.Ramp="ramp",f.Peer5="peer5",f.Microsoft="microsoft"},844:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.PlayerScenarioType=m.TelemetryEventType=void 0,(S=m.TelemetryEventType||(m.TelemetryEventType={})).BitrateChangedDownload="BitrateChangedDownload",S.StreamOptionsConfigured="StreamOptionsConfigured",S.BitrateChangedPlayback="BitrateChangedPlayback",S.CaptionsToggled="CaptionsToggled",S.Error="Error",S.FullscreenChanged="FullscreenChanged",S.Mute="Mute",S.PotentialMediaFreeze="PotentialMediaFreeze",S.StateChanged="StateChanged",S.HydraInputStateChanged="HydraInputStateChanged",S.HydraOutputStateChanged="HydraOutputStateChanged",S.Volume="Volume",S.Buffering="Buffering",S.LowBufferReserve="LowBufferReserve",S.Online="Online",S.Offline="Offline",S.NetworkChange="NetworkChange",S.HlsEvents="HlsEvents",(f=m.PlayerScenarioType||(m.PlayerScenarioType={})).LoadHydra="LoadHydra",f.LoadHlsScript="LoadHlsScript",f.LoadPlayer="LoadPlayer",f.Load="Load",f.LoadHlsAuthCookie="LoadHlsAuthCookie",f.HlsManifestLoad="HlsManifestLoad",f.HlsKeyLoad="HlsKeyLoad",f.LoadHlsFirstFragment="LoadHlsFirstFragment",f.SetSource="SetSource",f.SdnPluginLoad="SdnPluginLoad",f.ThaPluginLoad="ThaPluginLoad",f.HydraPipelineInitialization="HydraPipelineInitialization",f.Destroyed="Destroyed",f.Setup="Setup",f.StreamConnection="StreamConnection"},328:function(g,m){var f,S;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerType=m.HydraStreamingEventType=void 0,(S=m.HydraStreamingEventType||(m.HydraStreamingEventType={})).TLE="TLE",S.Overflow="Overflow",S.TownHallBasic="TownHall_Basic",S.TownHallPremium="TownHall_Premium",S.TownHall="TownHall",(f=m.HydraPlayerType||(m.HydraPlayerType={}))[f.Hls=1]="Hls",f[f.Ums=2]="Ums"},68:function(g,m){var f,S,v,C;Object.defineProperty(m,"__esModule",{value:!0}),m.HydraPlayerPlaybackErrorType=m.HydraPlayerPlaybackState=m.HydraPlayerSetupErrorType=m.HydraStreamDeliveryPipeline=void 0,(C=m.HydraStreamDeliveryPipeline||(m.HydraStreamDeliveryPipeline={})).AMS="AMS",C.HLS="MiddleLaneHttpLiveStreaming",C.Ums="MiddleLaneUltraLowLatency",(v=m.HydraPlayerSetupErrorType||(m.HydraPlayerSetupErrorType={})).MultiplePlayerLoad="MultiplePlayerLoad",v.PlayerInitializationFailed="PlayerInitializationFailed",v.InvalidStream="InvalidStream",v.SetSourceFailed="SetSourceFailed",(S=m.HydraPlayerPlaybackState||(m.HydraPlayerPlaybackState={})).LoadStart="loadstart",S.LoadedData="loadeddata",S.LoadedMetadata="loadedmetadata",S.Start="start",S.CanPlayThrough="canplaythrough",S.Play="play",S.Playing="playing",S.Pause="pause",S.Waiting="waiting",S.Seeking="seeking",S.Seeked="seeked",S.Ended="ended",S.Error="error",S.Destroyed="destroyed",S.Initialized="initialized",S.Stalled="stalled",S.VolumeChange="volumechange",S.PlaybackBitrateChanged="playbackbitratechanged",S.DownloadBitrateChanged="downloadbitratechanged",S.HlsKeyLoading="hlsKeyLoading",S.HlsKeyLoaded="hlsKeyLoaded",S.HlsKeyLoadedFailed="hlsKeyLoadedFailed",S.HlsManifestLoading="hlsManifestLoading",S.HlsManifestLoaded="hlsManifestLoaded",S.HlsManifestLoadedFailed="hlsManifestLoadedFailed",S.HlsFirstFragmentLoading="hlsFragLoading",S.HlsFirstFragmentBuffered="hlsFragBuffered",S.HlsFirstFragmentLoadFailed="hlsFirstFragmentLoadFailed",S.Online="online",S.Offline="offline",S.NetworkChange="networkChange",(f=m.HydraPlayerPlaybackErrorType||(m.HydraPlayerPlaybackErrorType={})).UnsupportedPlatform="UnsupportedPlatform",f.NetworkError="NetworkError",f.PlaybackRetried="PlaybackRetried",f.PlaybackError="PlaybackError",f.Unknown="Unknown"},944:function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.defer=void 0,m.defer=function(){var g,m;return{promise:new Promise((function(f,S){g=f,m=S})),resolve:g,reject:m}}},329:function(g,m,f){var S=this&&this.__awaiter||function(g,m,f,S){return new(f||(f=Promise))((function(v,C){function o2(g){try{l2(S.next(g))}catch(g){C(g)}}function s2(g){try{l2(S.throw(g))}catch(g){C(g)}}function l2(g){var m;g.done?v(g.value):(m=g.value,m instanceof f?m:new f((function(g){g(m)}))).then(o2,s2)}l2((S=S.apply(g,m||[])).next())}))},v=this&&this.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:s2(0),throw:s2(1),return:s2(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function s2(E){return function(T){return function(E){if(f)throw new TypeError("Generator is already executing.");for(;C&&(C=0,E[0]&&(_=0)),_;)try{if(f=1,S&&(v=2&E[0]?S.return:E[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,E[1])).done)return v;switch(S=0,v&&(E=[2&E[0],v.value]),E[0]){case 0:case 1:v=E;break;case 4:return _.label++,{value:E[1],done:!1};case 5:_.label++,S=E[1],E=[0];continue;case 7:E=_.ops.pop(),_.trys.pop();continue;default:if(!((v=(v=_.trys).length>0&&v[v.length-1])||6!==E[0]&&2!==E[0])){_=0;continue}if(3===E[0]&&(!v||E[1]>v[0]&&E[1]<v[3])){_.label=E[1];break}if(6===E[0]&&_.label<v[1]){_.label=v[1],v=E;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(E);break}v[2]&&_.ops.pop(),_.trys.pop();continue}E=m.call(g,_)}catch(g){E=[6,g],S=0}finally{f=v=0}if(5&E[0])throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}([E,T])}}};Object.defineProperty(m,"__esModule",{value:!0}),m.createVideoElement=m.createVideoElementDiv=m.showPlayerControls=m.getSdnStats=m.Spinner=m.repeatUntilCancel=m.wait=m.stringifyObject=m.getRandomHexString=m.getPlayerSetting=m.getECSSetting=m.assert=m.createIFrame=m.getMajorFromVersion=void 0;var C=f(63),_=f(328);function s(g,m,f,C,_){return S(this,void 0,void 0,(function(){var E,T,I,b,A=this;return v(this,(function(P){switch(P.label){case 0:return E=100,T=Date.now(),[4,c(f,I={trackingRef:"",timeTakenToDownloadScript:-1},_).catch((function(g){return S(A,void 0,void 0,(function(){var m;return v(this,(function(S){switch(S.label){case 0:return m="Failed to get IFrame source: ".concat(p(g)),C.push({success:!1,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript,errorMsg:m}),C.length>E&&C.shift(),[4,Promise.reject(new Error(m))];case 1:return[2,S.sent()]}}))}))}))];case 1:return b=P.sent(),m.srcdoc=b,g.appendChild(m),[4,new Promise((function(g,S){m.onload=function(){C.push({success:!0,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript}),C.length>E&&C.shift(),g()},m.onerror=function(g){var m="Failed to load HydraPlayer IFrame: ".concat(p(g));C.push({success:!1,url:f,startTime:T,duration:Date.now()-T,trackingReference:I.trackingRef,timeTakenToDownloadScript:I.timeTakenToDownloadScript,errorMsg:m}),C.length>E&&C.shift(),S(new Error(m))}}))];case 2:return P.sent(),[2]}}))}))}function l(g,m){return S(this,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,g(m).catch((function(C){return S(f,void 0,void 0,(function(){var f=this;return v(this,(function(_){switch(_.label){case 0:return 0!=--m?[3,2]:[4,Promise.reject(C)];case 1:case 3:return[2,_.sent()];case 2:return[4,new Promise((function(_){return setTimeout((function(){_(l(g,m).catch((function(g){return S(f,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(new Error("".concat(p(C)).concat(", ",p(g))))];case 1:return[2,m.sent()]}}))}))})))}),100)}))]}}))}))}))];case 1:return C.sent(),[2]}}))}))}function c(g,m,f){return S(this,void 0,void 0,(function(){var C,_,E,T=this;return v(this,(function(I){switch(I.label){case 0:return C=Date.now(),[4,d(g,m,f).catch((function(g){return S(T,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,Promise.reject(g)];case 1:return[2,m.sent()]}}))}))}))];case 1:return _=I.sent(),E="<script> ".concat(_,"<\/script>"),m.timeTakenToDownloadScript=Date.now()-C,[2,"\n        <html class style='height: 100%; width: 100%; overflow: hidden'>\n        <head></head>\n        <body class style='height: 100%; width: 100%; margin: 0px'>\n            ".concat(E,"\n        </body>\n        </html>\n    ")]}}))}))}function d(g,m,f){return S(this,void 0,void 0,(function(){var C,_,E,T=this;return v(this,(function(I){switch(I.label){case 0:return C=function(g,m){var f,S;return m.includes("vz")?null!==(S=g.headers.get("uuid"))&&void 0!==S?S:"":null!==(f=g.headers.get("X-Azure-Ref"))&&void 0!==f?f:""},f?(_=new AbortController,E=setTimeout((function(){_.abort()}),f),[4,fetch(g,{signal:_.signal,cache:"no-cache"}).then((function(f){return S(T,void 0,void 0,(function(){return v(this,(function(S){switch(S.label){case 0:return clearTimeout(E),f.ok?[3,2]:[4,Promise.reject(new Error("".concat(f.status)))];case 1:return[2,S.sent()];case 2:return m.trackingRef=C(f,g),[2,f]}}))}))})).then((function(m){return S(T,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,m.text().then((function(C){return S(f,void 0,void 0,(function(){return v(this,(function(f){switch(f.label){case 0:return C?[2,C]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,f.sent()]}}))}))}))];case 1:return[2,C.sent()]}}))}))}))]):[3,2];case 1:case 3:return[2,I.sent()];case 2:return[4,fetch(g,{cache:"no-cache"}).then((function(f){return S(T,void 0,void 0,(function(){return v(this,(function(S){switch(S.label){case 0:return f.ok?[3,2]:[4,Promise.reject(new Error("".concat(f.status)))];case 1:return[2,S.sent()];case 2:return m.trackingRef=C(f,g),[2,f]}}))}))})).then((function(m){return S(T,void 0,void 0,(function(){var f=this;return v(this,(function(C){switch(C.label){case 0:return[4,m.text().then((function(C){return S(f,void 0,void 0,(function(){return v(this,(function(f){switch(f.label){case 0:return C?[2,C]:[3,1];case 1:return[4,Promise.reject(new Error("".concat(m.status,", script ").concat(g," contents are null")))];case 2:return[2,f.sent()]}}))}))}))];case 1:return[2,C.sent()]}}))}))}))]}}))}))}function p(g){try{if(!g)return"".concat(g);if(g instanceof Map)return f={},g.forEach((function(g,m){f[m.toString()]=g})),JSON.stringify(f);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}catch(g){return""}var f}function y(g){return S(this,void 0,void 0,(function(){return v(this,(function(m){switch(m.label){case 0:return[4,new Promise((function(m){return setTimeout(m,g)}))];case 1:return m.sent(),[2]}}))}))}m.getMajorFromVersion=function(g){var m=g.match(/^(\d+)\.\d+\.\d+(-.*)?$/);return m?m[1]:null},m.createIFrame=function(g,m,f,C,_){return void 0===C&&(C=!1),S(this,void 0,void 0,(function(){var E,T,I,b,A=this;return v(this,(function(P){switch(P.label){case 0:return E=[],T=Date.now(),(I=g.ownerDocument.createElement("iframe")).id="player-iframe",C||I.sandbox.add("allow-scripts"),I.allowFullscreen=!0,I.allow="camera; microphone; autoplay",I.style.height="100%",I.style.width="100%",I.style.border="none",b=function(g){return m[g%m.length]},[4,l((function(m){return S(A,void 0,void 0,(function(){var f;return v(this,(function(S){switch(S.label){case 0:return f=b(m),[4,s(g,I,f,E,_)];case 1:return S.sent(),[2]}}))}))}),f).then((function(){return{iframe:I,initResult:{initSucceeded:!0,initStartTime:T,initDuration:Date.now()-T,runtimeDownloadResults:E}}})).catch((function(g){return S(A,void 0,void 0,(function(){var f;return v(this,(function(S){return f="Failed to load Hydra player runtime scripts, src: ",m.forEach((function(g){return f=f.concat(g,", ")})),f+="errors: ".concat(p(g)),[2,{initResult:{initSucceeded:!1,initStartTime:T,initDuration:Date.now()-T,runtimeDownloadResults:E,errorMsg:f}}]}))}))}))];case 1:return[2,P.sent()]}}))}))},m.assert=function(g,m,f){if(void 0===f&&(f=!1),!g){if(!f)throw new Error("Assert failed".concat(void 0!==m?": ".concat(m):""));console.error("Assert failed".concat(void 0!==m?": ".concat(m):""))}},m.getECSSetting=function(g,m,f){var S,v=f,C=null===(S=g.ecsSettings)||void 0===S?void 0:S[m];return typeof C==typeof v&&(v=C),v},m.getPlayerSetting=function(g,m){var f;return void 0!==(null===(f=g.ecsSettings)||void 0===f?void 0:f[m])?g.ecsSettings[m]:g[m]},m.getRandomHexString=function(g){return Array.from(Array(g)).map((function(){return Math.floor(16*Math.random()).toString(16)})).join("")},m.stringifyObject=p,m.wait=y,m.repeatUntilCancel=function(g,m,f,C){var _=!1,E=C||console.log;return E("RepeatUntilCancel starting task: ".concat(g)),S(this,void 0,void 0,(function(){var S,C,T;return v(this,(function(v){switch(v.label){case 0:return _?[3,2]:(S=new Date,m(),C=(new Date).getTime()-S.getTime(),(T=f-C)<0&&(T=f+T%f,E("Skipping execution for ".concat(g,", last execution took: ").concat(C," ms, delayMs: ").concat(f),"warn")),[4,y(T)]);case 1:return v.sent(),[3,0];case 2:return[2]}}))})),function(){E("RepeatUntilCancel stopping task: ".concat(g)),_=!0}};var E=function(){function e3(g){this.container=g,this.spinnerId="hydra-player-spinner",this.firstSpinnerShowTimestamp=null,this.firstSpinnerHideTimestamp=null,this.spinnerInfoHistory=[],this.maxTimestampHistorySize=100;var m=this.container.ownerDocument.getElementById(this.spinnerId);if(m)return this.spinner=m,void this.show();var f=this.container.ownerDocument.createElement("style");f.textContent="\n            .ml-player-spinner-container {\n                width: 100%;\n                height: 100%;\n                display: flex;\n                justify-content: center;\n                align-items: center;\n                position: absolute;\n                pointer-events: none;\n            }\n            .ml-player-spinner {\n                width: 3.6rem;\n                height: 3.6rem;\n                display: block;\n                overflow-clip-margin: content-box;\n                overflow: hidden;\n                animation: ml-player-spinner-outer-rotate 3s linear infinite;\n            }\n            .ml-player-spinner-dark-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(68, 71, 145);\n                stroke-width: 8px;\n            }\n            .ml-player-spinner-light-wheel {\n                fill: none;\n                r: 45%;\n                cx: 50%;\n                cy: 50%;\n                stroke: rgb(127, 133, 245);\n                stroke-width: 8px;\n                stroke-dasharray: 283;\n                stroke-dashoffset: 280;\n                stroke-linecap: round;\n                transform-origin: 50% 50%;\n                animation: ml-player-spinner-inner-rotate 1.5s cubic-bezier(0.33, 0, 0.67, 1) infinite;\n            }\n            @keyframes ml-player-spinner-outer-rotate {\n                0% {\n                    transform: rotate(0deg);\n                }\n                100% {\n                    transform: rotate(360deg);\n                }\n            }\n            @keyframes ml-player-spinner-inner-rotate {\n                0% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                25% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(0deg);\n                }\n                50% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                75% {\n                    stroke-dashoffset: 75;\n                    transform: rotate(45deg);\n                }\n                100% {\n                    stroke-dashoffset: 283;\n                    transform: rotate(360deg);\n                }\n            }\n        ",this.container.ownerDocument.head.appendChild(f),this.container.style.position="relative";var S=this.container.ownerDocument.createElement("div");S.classList.add("ml-player-spinner-container"),this.container.appendChild(S),this.spinner=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","svg"),this.spinner.style.position="absolute",this.spinner.setAttribute("viewBox","0 0 100 100"),this.spinner.classList.add("ml-player-spinner"),this.spinner.id=this.spinnerId,S.appendChild(this.spinner);var v=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");v.classList.add("ml-player-spinner-dark-wheel"),this.spinner.appendChild(v);var C=this.container.ownerDocument.createElementNS("http://www.w3.org/2000/svg","circle");C.classList.add("ml-player-spinner-light-wheel"),this.spinner.appendChild(C),this.show()}return Object.defineProperty(e3.prototype,"firstShowTimestamp",{get:function(){return this.firstSpinnerShowTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstHideTimestamp",{get:function(){return this.firstSpinnerHideTimestamp},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"firstSpinnerDuration",{get:function(){return this.firstSpinnerShowTimestamp?this.firstSpinnerHideTimestamp?this.firstSpinnerHideTimestamp-this.firstSpinnerShowTimestamp:Date.now()-this.firstSpinnerShowTimestamp:null},enumerable:!1,configurable:!0}),Object.defineProperty(e3.prototype,"visibilityHistory",{get:function(){if(this.spinnerInfoHistory.length>0){var g=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];g.hideTimestamp||(g.displayDuration=Date.now()-g.showTimestamp)}return this.spinnerInfoHistory},enumerable:!1,configurable:!0}),e3.prototype.show=function(){var g=Date.now();this.firstSpinnerShowTimestamp||(this.firstSpinnerShowTimestamp=g),(0===this.spinnerInfoHistory.length||this.spinnerInfoHistory[this.spinnerInfoHistory.length-1].hideTimestamp)&&(this.spinnerInfoHistory.push({showTimestamp:g,displayDuration:0}),this.spinnerInfoHistory.length>this.maxTimestampHistorySize&&this.spinnerInfoHistory.splice(0,1)),this.spinner.style.display="block"},e3.prototype.hide=function(){var g=Date.now();if(this.firstSpinnerHideTimestamp||(this.firstSpinnerHideTimestamp=g),this.spinnerInfoHistory.length>0){var m=this.spinnerInfoHistory[this.spinnerInfoHistory.length-1];m.hideTimestamp||(m.hideTimestamp=g,m.displayDuration=g-m.showTimestamp)}this.spinner.style.display="none"},e3.prototype.isVisible=function(){return"none"!==this.spinner.style.display},e3}();m.Spinner=E,m.getSdnStats=function(g,m){(null==g?void 0:g.peer5)&&(m.sdnName=g.peer5?C.HydraSupportedSDN.Microsoft:"",m.sdnVersion=g.peer5?g.peer5.version:"","function"==typeof g.peer5.getStats&&(m.sdnStats=g.peer5.getStats(),m.isP2PSdnUsed=g.peer5.getStats().numOfPeers>0))},m.showPlayerControls=function(g){return void 0!==g.allowPlayerControls?g.allowPlayerControls:g.streamingEventType===_.HydraStreamingEventType.TLE},m.createVideoElementDiv=function(g,m,f){f("createVideoElementDiv started");var S=m.ownerDocument.createElement("div");return S.id=g,S.style.position="relative",S.style.width="100%",S.style.height="100%",m.appendChild(S),f("createVideoElementDiv done"),S},m.createVideoElement=function(g,m,f,S,v){v("createVideoElement started");var C=m.ownerDocument.createElement("video");C.controls=S,C.id=g,C.setAttribute("playsinline","");var _=f.videoLang;_&&(C.setAttribute("lang",_),v("createVideoElement: language set to ".concat(_)));for(var E=f.videoElementStyles,T=0;T<E.length;T++)C.classList.add(E[T]);return C.style.width="100%",C.style.height="100%",C.style.position="absolute",C.muted=f.muteVideo,C.addEventListener("contextmenu",(function(g){g.preventDefault()})),["play","pause","stop","seekbackward","seekforward","seekto","previoustrack","nexttrack"].forEach((function(g){try{navigator.mediaSession.setActionHandler(g,(function(){}))}catch(g){}})),m.appendChild(C),v("createVideoElement done"),C}}},m={},function r(f){var S=m[f];if(void 0!==S)return S.exports;var v=m[f]={exports:{}};return g[f].call(v.exports,v,v.exports,r),v.exports}(979);var g,m},"object"==typeof g&&"object"==typeof m?m.exports=S():"object"==typeof g?g.hydra_player_ums_sdk=S():f.hydra_player_ums_sdk=S()}}),re=__commonJS({"../node_modules/pako/lib/utils/common.js"(g){var m="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;function _has(g,m){return Object.prototype.hasOwnProperty.call(g,m)}g.assign=function(g){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var f=m.shift();if(f){if("object"!=typeof f)throw new TypeError(f+"must be non-object");for(var S in f)_has(f,S)&&(g[S]=f[S])}}return g},g.shrinkBuf=function(g,m){return g.length===m?g:g.subarray?g.subarray(0,m):(g.length=m,g)};var f={arraySet:function(g,m,f,S,v){if(m.subarray&&g.subarray)g.set(m.subarray(f,f+S),v);else for(var C=0;C<S;C++)g[v+C]=m[f+C]},flattenChunks:function(g){var m,f,S,v,C,_;for(S=0,m=0,f=g.length;m<f;m++)S+=g[m].length;for(_=new Uint8Array(S),v=0,m=0,f=g.length;m<f;m++)C=g[m],_.set(C,v),v+=C.length;return _}},S={arraySet:function(g,m,f,S,v){for(var C=0;C<S;C++)g[v+C]=m[f+C]},flattenChunks:function(g){return[].concat.apply([],g)}};g.setTyped=function(m){m?(g.Buf8=Uint8Array,g.Buf16=Uint16Array,g.Buf32=Int32Array,g.assign(g,f)):(g.Buf8=Array,g.Buf16=Array,g.Buf32=Array,g.assign(g,S))},g.setTyped(m)}}),se=__commonJS({"../node_modules/pako/lib/zlib/trees.js"(g){var m=re(),f=4,S=0,v=1,C=2;function zero(g){for(var m=g.length;--m>=0;)g[m]=0}var _=0,E=1,T=2,I=3,b=258,A=29,P=256,R=P+1+A,w=30,M=19,D=2*R+1,O=15,N=16,k=7,L=256,F=16,x=17,U=18,V=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],B=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],H=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],$=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],G=512,j=new Array(2*(R+2));zero(j);var W=new Array(2*w);zero(W);var q=new Array(G);zero(q);var z=new Array(b-I+1);zero(z);var K=new Array(A);zero(K);var J,Y,Q,X=new Array(w);function StaticTreeDesc(g,m,f,S,v){this.static_tree=g,this.extra_bits=m,this.extra_base=f,this.elems=S,this.max_length=v,this.has_stree=g&&g.length}function TreeDesc(g,m){this.dyn_tree=g,this.max_code=0,this.stat_desc=m}function d_code(g){return g<256?q[g]:q[256+(g>>>7)]}function put_short(g,m){g.pending_buf[g.pending++]=255&m,g.pending_buf[g.pending++]=m>>>8&255}function send_bits(g,m,f){g.bi_valid>N-f?(g.bi_buf|=m<<g.bi_valid&65535,put_short(g,g.bi_buf),g.bi_buf=m>>N-g.bi_valid,g.bi_valid+=f-N):(g.bi_buf|=m<<g.bi_valid&65535,g.bi_valid+=f)}function send_code(g,m,f){send_bits(g,f[2*m],f[2*m+1])}function bi_reverse(g,m){var f=0;do{f|=1&g,g>>>=1,f<<=1}while(--m>0);return f>>>1}function bi_flush(g){16===g.bi_valid?(put_short(g,g.bi_buf),g.bi_buf=0,g.bi_valid=0):g.bi_valid>=8&&(g.pending_buf[g.pending++]=255&g.bi_buf,g.bi_buf>>=8,g.bi_valid-=8)}function gen_bitlen(g,m){var f,S,v,C,_,E,T=m.dyn_tree,I=m.max_code,b=m.stat_desc.static_tree,A=m.stat_desc.has_stree,P=m.stat_desc.extra_bits,R=m.stat_desc.extra_base,w=m.stat_desc.max_length,M=0;for(C=0;C<=O;C++)g.bl_count[C]=0;for(T[2*g.heap[g.heap_max]+1]=0,f=g.heap_max+1;f<D;f++)(C=T[2*T[2*(S=g.heap[f])+1]+1]+1)>w&&(C=w,M++),T[2*S+1]=C,S>I||(g.bl_count[C]++,_=0,S>=R&&(_=P[S-R]),E=T[2*S],g.opt_len+=E*(C+_),A&&(g.static_len+=E*(b[2*S+1]+_)));if(0!==M){do{for(C=w-1;0===g.bl_count[C];)C--;g.bl_count[C]--,g.bl_count[C+1]+=2,g.bl_count[w]--,M-=2}while(M>0);for(C=w;0!==C;C--)for(S=g.bl_count[C];0!==S;)(v=g.heap[--f])>I||(T[2*v+1]!==C&&(g.opt_len+=(C-T[2*v+1])*T[2*v],T[2*v+1]=C),S--)}}function gen_codes(g,m,f){var S,v,C=new Array(O+1),_=0;for(S=1;S<=O;S++)C[S]=_=_+f[S-1]<<1;for(v=0;v<=m;v++){var E=g[2*v+1];0!==E&&(g[2*v]=bi_reverse(C[E]++,E))}}function tr_static_init(){var g,m,f,S,v,C=new Array(O+1);for(f=0,S=0;S<A-1;S++)for(K[S]=f,g=0;g<1<<V[S];g++)z[f++]=S;for(z[f-1]=S,v=0,S=0;S<16;S++)for(X[S]=v,g=0;g<1<<B[S];g++)q[v++]=S;for(v>>=7;S<w;S++)for(X[S]=v<<7,g=0;g<1<<B[S]-7;g++)q[256+v++]=S;for(m=0;m<=O;m++)C[m]=0;for(g=0;g<=143;)j[2*g+1]=8,g++,C[8]++;for(;g<=255;)j[2*g+1]=9,g++,C[9]++;for(;g<=279;)j[2*g+1]=7,g++,C[7]++;for(;g<=287;)j[2*g+1]=8,g++,C[8]++;for(gen_codes(j,R+1,C),g=0;g<w;g++)W[2*g+1]=5,W[2*g]=bi_reverse(g,5);J=new StaticTreeDesc(j,V,P+1,R,O),Y=new StaticTreeDesc(W,B,0,w,O),Q=new StaticTreeDesc(new Array(0),H,0,M,k)}function init_block(g){var m;for(m=0;m<R;m++)g.dyn_ltree[2*m]=0;for(m=0;m<w;m++)g.dyn_dtree[2*m]=0;for(m=0;m<M;m++)g.bl_tree[2*m]=0;g.dyn_ltree[2*L]=1,g.opt_len=g.static_len=0,g.last_lit=g.matches=0}function bi_windup(g){g.bi_valid>8?put_short(g,g.bi_buf):g.bi_valid>0&&(g.pending_buf[g.pending++]=g.bi_buf),g.bi_buf=0,g.bi_valid=0}function copy_block(g,f,S,v){bi_windup(g),v&&(put_short(g,S),put_short(g,~S)),m.arraySet(g.pending_buf,g.window,f,S,g.pending),g.pending+=S}function smaller(g,m,f,S){var v=2*m,C=2*f;return g[v]<g[C]||g[v]===g[C]&&S[m]<=S[f]}function pqdownheap(g,m,f){for(var S=g.heap[f],v=f<<1;v<=g.heap_len&&(v<g.heap_len&&smaller(m,g.heap[v+1],g.heap[v],g.depth)&&v++,!smaller(m,S,g.heap[v],g.depth));)g.heap[f]=g.heap[v],f=v,v<<=1;g.heap[f]=S}function compress_block(g,m,f){var S,v,C,_,E=0;if(0!==g.last_lit)do{S=g.pending_buf[g.d_buf+2*E]<<8|g.pending_buf[g.d_buf+2*E+1],v=g.pending_buf[g.l_buf+E],E++,0===S?send_code(g,v,m):(send_code(g,(C=z[v])+P+1,m),0!==(_=V[C])&&send_bits(g,v-=K[C],_),send_code(g,C=d_code(--S),f),0!==(_=B[C])&&send_bits(g,S-=X[C],_))}while(E<g.last_lit);send_code(g,L,m)}function build_tree(g,m){var f,S,v,C=m.dyn_tree,_=m.stat_desc.static_tree,E=m.stat_desc.has_stree,T=m.stat_desc.elems,I=-1;for(g.heap_len=0,g.heap_max=D,f=0;f<T;f++)0!==C[2*f]?(g.heap[++g.heap_len]=I=f,g.depth[f]=0):C[2*f+1]=0;for(;g.heap_len<2;)C[2*(v=g.heap[++g.heap_len]=I<2?++I:0)]=1,g.depth[v]=0,g.opt_len--,E&&(g.static_len-=_[2*v+1]);for(m.max_code=I,f=g.heap_len>>1;f>=1;f--)pqdownheap(g,C,f);v=T;do{f=g.heap[1],g.heap[1]=g.heap[g.heap_len--],pqdownheap(g,C,1),S=g.heap[1],g.heap[--g.heap_max]=f,g.heap[--g.heap_max]=S,C[2*v]=C[2*f]+C[2*S],g.depth[v]=(g.depth[f]>=g.depth[S]?g.depth[f]:g.depth[S])+1,C[2*f+1]=C[2*S+1]=v,g.heap[1]=v++,pqdownheap(g,C,1)}while(g.heap_len>=2);g.heap[--g.heap_max]=g.heap[1],gen_bitlen(g,m),gen_codes(C,I,g.bl_count)}function scan_tree(g,m,f){var S,v,C=-1,_=m[1],E=0,T=7,I=4;for(0===_&&(T=138,I=3),m[2*(f+1)+1]=65535,S=0;S<=f;S++)v=_,_=m[2*(S+1)+1],++E<T&&v===_||(E<I?g.bl_tree[2*v]+=E:0!==v?(v!==C&&g.bl_tree[2*v]++,g.bl_tree[2*F]++):E<=10?g.bl_tree[2*x]++:g.bl_tree[2*U]++,E=0,C=v,0===_?(T=138,I=3):v===_?(T=6,I=3):(T=7,I=4))}function send_tree(g,m,f){var S,v,C=-1,_=m[1],E=0,T=7,I=4;for(0===_&&(T=138,I=3),S=0;S<=f;S++)if(v=_,_=m[2*(S+1)+1],!(++E<T&&v===_)){if(E<I)do{send_code(g,v,g.bl_tree)}while(0!=--E);else 0!==v?(v!==C&&(send_code(g,v,g.bl_tree),E--),send_code(g,F,g.bl_tree),send_bits(g,E-3,2)):E<=10?(send_code(g,x,g.bl_tree),send_bits(g,E-3,3)):(send_code(g,U,g.bl_tree),send_bits(g,E-11,7));E=0,C=v,0===_?(T=138,I=3):v===_?(T=6,I=3):(T=7,I=4)}}function build_bl_tree(g){var m;for(scan_tree(g,g.dyn_ltree,g.l_desc.max_code),scan_tree(g,g.dyn_dtree,g.d_desc.max_code),build_tree(g,g.bl_desc),m=M-1;m>=3&&0===g.bl_tree[2*$[m]+1];m--);return g.opt_len+=3*(m+1)+5+5+4,m}function send_all_trees(g,m,f,S){var v;for(send_bits(g,m-257,5),send_bits(g,f-1,5),send_bits(g,S-4,4),v=0;v<S;v++)send_bits(g,g.bl_tree[2*$[v]+1],3);send_tree(g,g.dyn_ltree,m-1),send_tree(g,g.dyn_dtree,f-1)}function detect_data_type(g){var m,f=4093624447;for(m=0;m<=31;m++,f>>>=1)if(1&f&&0!==g.dyn_ltree[2*m])return S;if(0!==g.dyn_ltree[18]||0!==g.dyn_ltree[20]||0!==g.dyn_ltree[26])return v;for(m=32;m<P;m++)if(0!==g.dyn_ltree[2*m])return v;return S}zero(X);var Z=!1;function _tr_init(g){Z||(tr_static_init(),Z=!0),g.l_desc=new TreeDesc(g.dyn_ltree,J),g.d_desc=new TreeDesc(g.dyn_dtree,Y),g.bl_desc=new TreeDesc(g.bl_tree,Q),g.bi_buf=0,g.bi_valid=0,init_block(g)}function _tr_stored_block(g,m,f,S){send_bits(g,(_<<1)+(S?1:0),3),copy_block(g,m,f,!0)}function _tr_align(g){send_bits(g,E<<1,3),send_code(g,L,j),bi_flush(g)}function _tr_flush_block(g,m,S,v){var _,I,b=0;g.level>0?(g.strm.data_type===C&&(g.strm.data_type=detect_data_type(g)),build_tree(g,g.l_desc),build_tree(g,g.d_desc),b=build_bl_tree(g),_=g.opt_len+3+7>>>3,(I=g.static_len+3+7>>>3)<=_&&(_=I)):_=I=S+5,S+4<=_&&-1!==m?_tr_stored_block(g,m,S,v):g.strategy===f||I===_?(send_bits(g,(E<<1)+(v?1:0),3),compress_block(g,j,W)):(send_bits(g,(T<<1)+(v?1:0),3),send_all_trees(g,g.l_desc.max_code+1,g.d_desc.max_code+1,b+1),compress_block(g,g.dyn_ltree,g.dyn_dtree)),init_block(g),v&&bi_windup(g)}function _tr_tally(g,m,f){return g.pending_buf[g.d_buf+2*g.last_lit]=m>>>8&255,g.pending_buf[g.d_buf+2*g.last_lit+1]=255&m,g.pending_buf[g.l_buf+g.last_lit]=255&f,g.last_lit++,0===m?g.dyn_ltree[2*f]++:(g.matches++,m--,g.dyn_ltree[2*(z[f]+P+1)]++,g.dyn_dtree[2*d_code(m)]++),g.last_lit===g.lit_bufsize-1}g._tr_init=_tr_init,g._tr_stored_block=_tr_stored_block,g._tr_flush_block=_tr_flush_block,g._tr_tally=_tr_tally,g._tr_align=_tr_align}}),ae=__commonJS({"../node_modules/pako/lib/zlib/adler32.js"(g,m){function adler32(g,m,f,S){for(var v=65535&g|0,C=g>>>16&65535|0,_=0;0!==f;){f-=_=f>2e3?2e3:f;do{C=C+(v=v+m[S++]|0)|0}while(--_);v%=65521,C%=65521}return v|C<<16|0}m.exports=adler32}}),oe=__commonJS({"../node_modules/pako/lib/zlib/crc32.js"(g,m){function makeTable(){for(var g,m=[],f=0;f<256;f++){g=f;for(var S=0;S<8;S++)g=1&g?3988292384^g>>>1:g>>>1;m[f]=g}return m}var f=makeTable();function crc32(g,m,S,v){var C=f,_=v+S;g^=-1;for(var E=v;E<_;E++)g=g>>>8^C[255&(g^m[E])];return-1^g}m.exports=crc32}}),le=__commonJS({"../node_modules/pako/lib/zlib/messages.js"(g,m){m.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"}}}),ce=__commonJS({"../node_modules/pako/lib/zlib/deflate.js"(g){var m,f=re(),S=se(),v=ae(),C=oe(),_=le(),E=0,T=1,I=3,b=4,A=5,P=0,R=1,w=-2,M=-3,D=-5,O=-1,N=1,k=2,L=3,F=4,x=0,U=2,V=8,B=9,H=15,$=8,G=256+1+29,j=30,W=19,q=2*G+1,z=15,K=3,J=258,Y=J+K+1,Q=32,X=42,Z=69,ee=73,te=91,ie=103,ne=113,ce=666,de=1,he=2,ue=3,ge=4,pe=3;function err(g,m){return g.msg=_[m],m}function rank(g){return(g<<1)-(g>4?9:0)}function zero(g){for(var m=g.length;--m>=0;)g[m]=0}function flush_pending(g){var m=g.state,S=m.pending;S>g.avail_out&&(S=g.avail_out),0!==S&&(f.arraySet(g.output,m.pending_buf,m.pending_out,S,g.next_out),g.next_out+=S,m.pending_out+=S,g.total_out+=S,g.avail_out-=S,m.pending-=S,0===m.pending&&(m.pending_out=0))}function flush_block_only(g,m){S._tr_flush_block(g,g.block_start>=0?g.block_start:-1,g.strstart-g.block_start,m),g.block_start=g.strstart,flush_pending(g.strm)}function put_byte(g,m){g.pending_buf[g.pending++]=m}function putShortMSB(g,m){g.pending_buf[g.pending++]=m>>>8&255,g.pending_buf[g.pending++]=255&m}function read_buf(g,m,S,_){var E=g.avail_in;return E>_&&(E=_),0===E?0:(g.avail_in-=E,f.arraySet(m,g.input,g.next_in,E,S),1===g.state.wrap?g.adler=v(g.adler,m,E,S):2===g.state.wrap&&(g.adler=C(g.adler,m,E,S)),g.next_in+=E,g.total_in+=E,E)}function longest_match(g,m){var f,S,v=g.max_chain_length,C=g.strstart,_=g.prev_length,E=g.nice_match,T=g.strstart>g.w_size-Y?g.strstart-(g.w_size-Y):0,I=g.window,b=g.w_mask,A=g.prev,P=g.strstart+J,R=I[C+_-1],w=I[C+_];g.prev_length>=g.good_match&&(v>>=2),E>g.lookahead&&(E=g.lookahead);do{if(I[(f=m)+_]===w&&I[f+_-1]===R&&I[f]===I[C]&&I[++f]===I[C+1]){C+=2,f++;do{}while(I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&C<P);if(S=J-(P-C),C=P-J,S>_){if(g.match_start=m,_=S,S>=E)break;R=I[C+_-1],w=I[C+_]}}}while((m=A[m&b])>T&&0!=--v);return _<=g.lookahead?_:g.lookahead}function fill_window(g){var m,S,v,C,_,E=g.w_size;do{if(C=g.window_size-g.lookahead-g.strstart,g.strstart>=E+(E-Y)){f.arraySet(g.window,g.window,E,E,0),g.match_start-=E,g.strstart-=E,g.block_start-=E,m=S=g.hash_size;do{v=g.head[--m],g.head[m]=v>=E?v-E:0}while(--S);m=S=E;do{v=g.prev[--m],g.prev[m]=v>=E?v-E:0}while(--S);C+=E}if(0===g.strm.avail_in)break;if(S=read_buf(g.strm,g.window,g.strstart+g.lookahead,C),g.lookahead+=S,g.lookahead+g.insert>=K)for(_=g.strstart-g.insert,g.ins_h=g.window[_],g.ins_h=(g.ins_h<<g.hash_shift^g.window[_+1])&g.hash_mask;g.insert&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[_+K-1])&g.hash_mask,g.prev[_&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=_,_++,g.insert--,!(g.lookahead+g.insert<K)););}while(g.lookahead<Y&&0!==g.strm.avail_in)}function deflate_stored(g,m){var f=65535;for(f>g.pending_buf_size-5&&(f=g.pending_buf_size-5);;){if(g.lookahead<=1){if(fill_window(g),0===g.lookahead&&m===E)return de;if(0===g.lookahead)break}g.strstart+=g.lookahead,g.lookahead=0;var S=g.block_start+f;if((0===g.strstart||g.strstart>=S)&&(g.lookahead=g.strstart-S,g.strstart=S,flush_block_only(g,!1),0===g.strm.avail_out))return de;if(g.strstart-g.block_start>=g.w_size-Y&&(flush_block_only(g,!1),0===g.strm.avail_out))return de}return g.insert=0,m===b?(flush_block_only(g,!0),0===g.strm.avail_out?ue:ge):(g.strstart>g.block_start&&(flush_block_only(g,!1),g.strm.avail_out),de)}function deflate_fast(g,m){for(var f,v;;){if(g.lookahead<Y){if(fill_window(g),g.lookahead<Y&&m===E)return de;if(0===g.lookahead)break}if(f=0,g.lookahead>=K&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+K-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),0!==f&&g.strstart-f<=g.w_size-Y&&(g.match_length=longest_match(g,f)),g.match_length>=K)if(v=S._tr_tally(g,g.strstart-g.match_start,g.match_length-K),g.lookahead-=g.match_length,g.match_length<=g.max_lazy_match&&g.lookahead>=K){g.match_length--;do{g.strstart++,g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+K-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart}while(0!=--g.match_length);g.strstart++}else g.strstart+=g.match_length,g.match_length=0,g.ins_h=g.window[g.strstart],g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+1])&g.hash_mask;else v=S._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++;if(v&&(flush_block_only(g,!1),0===g.strm.avail_out))return de}return g.insert=g.strstart<K-1?g.strstart:K-1,m===b?(flush_block_only(g,!0),0===g.strm.avail_out?ue:ge):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?de:he}function deflate_slow(g,m){for(var f,v,C;;){if(g.lookahead<Y){if(fill_window(g),g.lookahead<Y&&m===E)return de;if(0===g.lookahead)break}if(f=0,g.lookahead>=K&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+K-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),g.prev_length=g.match_length,g.prev_match=g.match_start,g.match_length=K-1,0!==f&&g.prev_length<g.max_lazy_match&&g.strstart-f<=g.w_size-Y&&(g.match_length=longest_match(g,f),g.match_length<=5&&(g.strategy===N||g.match_length===K&&g.strstart-g.match_start>4096)&&(g.match_length=K-1)),g.prev_length>=K&&g.match_length<=g.prev_length){C=g.strstart+g.lookahead-K,v=S._tr_tally(g,g.strstart-1-g.prev_match,g.prev_length-K),g.lookahead-=g.prev_length-1,g.prev_length-=2;do{++g.strstart<=C&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+K-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart)}while(0!=--g.prev_length);if(g.match_available=0,g.match_length=K-1,g.strstart++,v&&(flush_block_only(g,!1),0===g.strm.avail_out))return de}else if(g.match_available){if((v=S._tr_tally(g,0,g.window[g.strstart-1]))&&flush_block_only(g,!1),g.strstart++,g.lookahead--,0===g.strm.avail_out)return de}else g.match_available=1,g.strstart++,g.lookahead--}return g.match_available&&(v=S._tr_tally(g,0,g.window[g.strstart-1]),g.match_available=0),g.insert=g.strstart<K-1?g.strstart:K-1,m===b?(flush_block_only(g,!0),0===g.strm.avail_out?ue:ge):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?de:he}function deflate_rle(g,m){for(var f,v,C,_,T=g.window;;){if(g.lookahead<=J){if(fill_window(g),g.lookahead<=J&&m===E)return de;if(0===g.lookahead)break}if(g.match_length=0,g.lookahead>=K&&g.strstart>0&&(v=T[C=g.strstart-1])===T[++C]&&v===T[++C]&&v===T[++C]){_=g.strstart+J;do{}while(v===T[++C]&&v===T[++C]&&v===T[++C]&&v===T[++C]&&v===T[++C]&&v===T[++C]&&v===T[++C]&&v===T[++C]&&C<_);g.match_length=J-(_-C),g.match_length>g.lookahead&&(g.match_length=g.lookahead)}if(g.match_length>=K?(f=S._tr_tally(g,1,g.match_length-K),g.lookahead-=g.match_length,g.strstart+=g.match_length,g.match_length=0):(f=S._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++),f&&(flush_block_only(g,!1),0===g.strm.avail_out))return de}return g.insert=0,m===b?(flush_block_only(g,!0),0===g.strm.avail_out?ue:ge):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?de:he}function deflate_huff(g,m){for(var f;;){if(0===g.lookahead&&(fill_window(g),0===g.lookahead)){if(m===E)return de;break}if(g.match_length=0,f=S._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++,f&&(flush_block_only(g,!1),0===g.strm.avail_out))return de}return g.insert=0,m===b?(flush_block_only(g,!0),0===g.strm.avail_out?ue:ge):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?de:he}function Config(g,m,f,S,v){this.good_length=g,this.max_lazy=m,this.nice_length=f,this.max_chain=S,this.func=v}function lm_init(g){g.window_size=2*g.w_size,zero(g.head),g.max_lazy_match=m[g.level].max_lazy,g.good_match=m[g.level].good_length,g.nice_match=m[g.level].nice_length,g.max_chain_length=m[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=K-1,g.match_available=0,g.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=V,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new f.Buf16(2*q),this.dyn_dtree=new f.Buf16(2*(2*j+1)),this.bl_tree=new f.Buf16(2*(2*W+1)),zero(this.dyn_ltree),zero(this.dyn_dtree),zero(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new f.Buf16(z+1),this.heap=new f.Buf16(2*G+1),zero(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new f.Buf16(2*G+1),zero(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(g){var m;return g&&g.state?(g.total_in=g.total_out=0,g.data_type=U,(m=g.state).pending=0,m.pending_out=0,m.wrap<0&&(m.wrap=-m.wrap),m.status=m.wrap?X:ne,g.adler=2===m.wrap?0:1,m.last_flush=E,S._tr_init(m),P):err(g,w)}function deflateReset(g){var m=deflateResetKeep(g);return m===P&&lm_init(g.state),m}function deflateSetHeader(g,m){return g&&g.state?2!==g.state.wrap?w:(g.state.gzhead=m,P):w}function deflateInit2(g,m,S,v,C,_){if(!g)return w;var E=1;if(m===O&&(m=6),v<0?(E=0,v=-v):v>15&&(E=2,v-=16),C<1||C>B||S!==V||v<8||v>15||m<0||m>9||_<0||_>F)return err(g,w);8===v&&(v=9);var T=new DeflateState;return g.state=T,T.strm=g,T.wrap=E,T.gzhead=null,T.w_bits=v,T.w_size=1<<T.w_bits,T.w_mask=T.w_size-1,T.hash_bits=C+7,T.hash_size=1<<T.hash_bits,T.hash_mask=T.hash_size-1,T.hash_shift=~~((T.hash_bits+K-1)/K),T.window=new f.Buf8(2*T.w_size),T.head=new f.Buf16(T.hash_size),T.prev=new f.Buf16(T.w_size),T.lit_bufsize=1<<C+6,T.pending_buf_size=4*T.lit_bufsize,T.pending_buf=new f.Buf8(T.pending_buf_size),T.d_buf=1*T.lit_bufsize,T.l_buf=3*T.lit_bufsize,T.level=m,T.strategy=_,T.method=S,deflateReset(g)}function deflateInit(g,m){return deflateInit2(g,m,V,H,$,x)}function deflate(g,f){var v,_,M,O;if(!g||!g.state||f>A||f<0)return g?err(g,w):w;if(_=g.state,!g.output||!g.input&&0!==g.avail_in||_.status===ce&&f!==b)return err(g,0===g.avail_out?D:w);if(_.strm=g,v=_.last_flush,_.last_flush=f,_.status===X)if(2===_.wrap)g.adler=0,put_byte(_,31),put_byte(_,139),put_byte(_,8),_.gzhead?(put_byte(_,(_.gzhead.text?1:0)+(_.gzhead.hcrc?2:0)+(_.gzhead.extra?4:0)+(_.gzhead.name?8:0)+(_.gzhead.comment?16:0)),put_byte(_,255&_.gzhead.time),put_byte(_,_.gzhead.time>>8&255),put_byte(_,_.gzhead.time>>16&255),put_byte(_,_.gzhead.time>>24&255),put_byte(_,9===_.level?2:_.strategy>=k||_.level<2?4:0),put_byte(_,255&_.gzhead.os),_.gzhead.extra&&_.gzhead.extra.length&&(put_byte(_,255&_.gzhead.extra.length),put_byte(_,_.gzhead.extra.length>>8&255)),_.gzhead.hcrc&&(g.adler=C(g.adler,_.pending_buf,_.pending,0)),_.gzindex=0,_.status=Z):(put_byte(_,0),put_byte(_,0),put_byte(_,0),put_byte(_,0),put_byte(_,0),put_byte(_,9===_.level?2:_.strategy>=k||_.level<2?4:0),put_byte(_,pe),_.status=ne);else{var N=V+(_.w_bits-8<<4)<<8;N|=(_.strategy>=k||_.level<2?0:_.level<6?1:6===_.level?2:3)<<6,0!==_.strstart&&(N|=Q),N+=31-N%31,_.status=ne,putShortMSB(_,N),0!==_.strstart&&(putShortMSB(_,g.adler>>>16),putShortMSB(_,65535&g.adler)),g.adler=1}if(_.status===Z)if(_.gzhead.extra){for(M=_.pending;_.gzindex<(65535&_.gzhead.extra.length)&&(_.pending!==_.pending_buf_size||(_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),flush_pending(g),M=_.pending,_.pending!==_.pending_buf_size));)put_byte(_,255&_.gzhead.extra[_.gzindex]),_.gzindex++;_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),_.gzindex===_.gzhead.extra.length&&(_.gzindex=0,_.status=ee)}else _.status=ee;if(_.status===ee)if(_.gzhead.name){M=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),flush_pending(g),M=_.pending,_.pending===_.pending_buf_size)){O=1;break}O=_.gzindex<_.gzhead.name.length?255&_.gzhead.name.charCodeAt(_.gzindex++):0,put_byte(_,O)}while(0!==O);_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),0===O&&(_.gzindex=0,_.status=te)}else _.status=te;if(_.status===te)if(_.gzhead.comment){M=_.pending;do{if(_.pending===_.pending_buf_size&&(_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),flush_pending(g),M=_.pending,_.pending===_.pending_buf_size)){O=1;break}O=_.gzindex<_.gzhead.comment.length?255&_.gzhead.comment.charCodeAt(_.gzindex++):0,put_byte(_,O)}while(0!==O);_.gzhead.hcrc&&_.pending>M&&(g.adler=C(g.adler,_.pending_buf,_.pending-M,M)),0===O&&(_.status=ie)}else _.status=ie;if(_.status===ie&&(_.gzhead.hcrc?(_.pending+2>_.pending_buf_size&&flush_pending(g),_.pending+2<=_.pending_buf_size&&(put_byte(_,255&g.adler),put_byte(_,g.adler>>8&255),g.adler=0,_.status=ne)):_.status=ne),0!==_.pending){if(flush_pending(g),0===g.avail_out)return _.last_flush=-1,P}else if(0===g.avail_in&&rank(f)<=rank(v)&&f!==b)return err(g,D);if(_.status===ce&&0!==g.avail_in)return err(g,D);if(0!==g.avail_in||0!==_.lookahead||f!==E&&_.status!==ce){var F=_.strategy===k?deflate_huff(_,f):_.strategy===L?deflate_rle(_,f):m[_.level].func(_,f);if(F!==ue&&F!==ge||(_.status=ce),F===de||F===ue)return 0===g.avail_out&&(_.last_flush=-1),P;if(F===he&&(f===T?S._tr_align(_):f!==A&&(S._tr_stored_block(_,0,0,!1),f===I&&(zero(_.head),0===_.lookahead&&(_.strstart=0,_.block_start=0,_.insert=0))),flush_pending(g),0===g.avail_out))return _.last_flush=-1,P}return f!==b?P:_.wrap<=0?R:(2===_.wrap?(put_byte(_,255&g.adler),put_byte(_,g.adler>>8&255),put_byte(_,g.adler>>16&255),put_byte(_,g.adler>>24&255),put_byte(_,255&g.total_in),put_byte(_,g.total_in>>8&255),put_byte(_,g.total_in>>16&255),put_byte(_,g.total_in>>24&255)):(putShortMSB(_,g.adler>>>16),putShortMSB(_,65535&g.adler)),flush_pending(g),_.wrap>0&&(_.wrap=-_.wrap),0!==_.pending?P:R)}function deflateEnd(g){var m;return g&&g.state?(m=g.state.status)!==X&&m!==Z&&m!==ee&&m!==te&&m!==ie&&m!==ne&&m!==ce?err(g,w):(g.state=null,m===ne?err(g,M):P):w}function deflateSetDictionary(g,m){var S,C,_,E,T,I,b,A,R=m.length;if(!g||!g.state)return w;if(2===(E=(S=g.state).wrap)||1===E&&S.status!==X||S.lookahead)return w;for(1===E&&(g.adler=v(g.adler,m,R,0)),S.wrap=0,R>=S.w_size&&(0===E&&(zero(S.head),S.strstart=0,S.block_start=0,S.insert=0),A=new f.Buf8(S.w_size),f.arraySet(A,m,R-S.w_size,S.w_size,0),m=A,R=S.w_size),T=g.avail_in,I=g.next_in,b=g.input,g.avail_in=R,g.next_in=0,g.input=m,fill_window(S);S.lookahead>=K;){C=S.strstart,_=S.lookahead-(K-1);do{S.ins_h=(S.ins_h<<S.hash_shift^S.window[C+K-1])&S.hash_mask,S.prev[C&S.w_mask]=S.head[S.ins_h],S.head[S.ins_h]=C,C++}while(--_);S.strstart=C,S.lookahead=K-1,fill_window(S)}return S.strstart+=S.lookahead,S.block_start=S.strstart,S.insert=S.lookahead,S.lookahead=0,S.match_length=S.prev_length=K-1,S.match_available=0,g.next_in=I,g.input=b,g.avail_in=T,S.wrap=E,P}m=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)],g.deflateInit=deflateInit,g.deflateInit2=deflateInit2,g.deflateReset=deflateReset,g.deflateResetKeep=deflateResetKeep,g.deflateSetHeader=deflateSetHeader,g.deflate=deflate,g.deflateEnd=deflateEnd,g.deflateSetDictionary=deflateSetDictionary,g.deflateInfo="pako deflate (from Nodeca project)"}}),de=__commonJS({"../node_modules/pako/lib/utils/strings.js"(g){var m=re(),f=!0,S=!0;try{String.fromCharCode.apply(null,[0])}catch(g){f=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(g){S=!1}var v,C=new m.Buf8(256);for(v=0;v<256;v++)C[v]=v>=252?6:v>=248?5:v>=240?4:v>=224?3:v>=192?2:1;function buf2binstring(g,v){if(v<65534&&(g.subarray&&S||!g.subarray&&f))return String.fromCharCode.apply(null,m.shrinkBuf(g,v));for(var C="",_=0;_<v;_++)C+=String.fromCharCode(g[_]);return C}C[254]=C[254]=1,g.string2buf=function(g){var f,S,v,C,_,E=g.length,T=0;for(C=0;C<E;C++)55296==(64512&(S=g.charCodeAt(C)))&&C+1<E&&56320==(64512&(v=g.charCodeAt(C+1)))&&(S=65536+(S-55296<<10)+(v-56320),C++),T+=S<128?1:S<2048?2:S<65536?3:4;for(f=new m.Buf8(T),_=0,C=0;_<T;C++)55296==(64512&(S=g.charCodeAt(C)))&&C+1<E&&56320==(64512&(v=g.charCodeAt(C+1)))&&(S=65536+(S-55296<<10)+(v-56320),C++),S<128?f[_++]=S:S<2048?(f[_++]=192|S>>>6,f[_++]=128|63&S):S<65536?(f[_++]=224|S>>>12,f[_++]=128|S>>>6&63,f[_++]=128|63&S):(f[_++]=240|S>>>18,f[_++]=128|S>>>12&63,f[_++]=128|S>>>6&63,f[_++]=128|63&S);return f},g.buf2binstring=function(g){return buf2binstring(g,g.length)},g.binstring2buf=function(g){for(var f=new m.Buf8(g.length),S=0,v=f.length;S<v;S++)f[S]=g.charCodeAt(S);return f},g.buf2string=function(g,m){var f,S,v,_,E=m||g.length,T=new Array(2*E);for(S=0,f=0;f<E;)if((v=g[f++])<128)T[S++]=v;else if((_=C[v])>4)T[S++]=65533,f+=_-1;else{for(v&=2===_?31:3===_?15:7;_>1&&f<E;)v=v<<6|63&g[f++],_--;_>1?T[S++]=65533:v<65536?T[S++]=v:(v-=65536,T[S++]=55296|v>>10&1023,T[S++]=56320|1023&v)}return buf2binstring(T,S)},g.utf8border=function(g,m){var f;for((m=m||g.length)>g.length&&(m=g.length),f=m-1;f>=0&&128==(192&g[f]);)f--;return f<0||0===f?m:f+C[g[f]]>m?f:m}}}),he=__commonJS({"../node_modules/pako/lib/zlib/zstream.js"(g,m){function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}m.exports=ZStream}}),ue=__commonJS({"../node_modules/pako/lib/deflate.js"(g){var m=ce(),f=re(),S=de(),v=le(),C=he(),_=Object.prototype.toString,E=0,T=4,I=0,b=1,A=2,P=-1,R=0,w=8;function Deflate(g){if(!(this instanceof Deflate))return new Deflate(g);this.options=f.assign({level:P,method:w,chunkSize:16384,windowBits:15,memLevel:8,strategy:R,to:""},g||{});var E=this.options;E.raw&&E.windowBits>0?E.windowBits=-E.windowBits:E.gzip&&E.windowBits>0&&E.windowBits<16&&(E.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new C,this.strm.avail_out=0;var T=m.deflateInit2(this.strm,E.level,E.method,E.windowBits,E.memLevel,E.strategy);if(T!==I)throw new Error(v[T]);if(E.header&&m.deflateSetHeader(this.strm,E.header),E.dictionary){var b;if(b="string"==typeof E.dictionary?S.string2buf(E.dictionary):"[object ArrayBuffer]"===_.call(E.dictionary)?new Uint8Array(E.dictionary):E.dictionary,(T=m.deflateSetDictionary(this.strm,b))!==I)throw new Error(v[T]);this._dict_set=!0}}function deflate(g,m){var f=new Deflate(m);if(f.push(g,!0),f.err)throw f.msg||v[f.err];return f.result}function deflateRaw(g,m){return(m=m||{}).raw=!0,deflate(g,m)}function gzip(g,m){return(m=m||{}).gzip=!0,deflate(g,m)}Deflate.prototype.push=function(g,v){var C,P,R=this.strm,w=this.options.chunkSize;if(this.ended)return!1;P=v===~~v?v:!0===v?T:E,"string"==typeof g?R.input=S.string2buf(g):"[object ArrayBuffer]"===_.call(g)?R.input=new Uint8Array(g):R.input=g,R.next_in=0,R.avail_in=R.input.length;do{if(0===R.avail_out&&(R.output=new f.Buf8(w),R.next_out=0,R.avail_out=w),(C=m.deflate(R,P))!==b&&C!==I)return this.onEnd(C),this.ended=!0,!1;0!==R.avail_out&&(0!==R.avail_in||P!==T&&P!==A)||("string"===this.options.to?this.onData(S.buf2binstring(f.shrinkBuf(R.output,R.next_out))):this.onData(f.shrinkBuf(R.output,R.next_out)))}while((R.avail_in>0||0===R.avail_out)&&C!==b);return P===T?(C=m.deflateEnd(this.strm),this.onEnd(C),this.ended=!0,C===I):P!==A||(this.onEnd(I),R.avail_out=0,!0)},Deflate.prototype.onData=function(g){this.chunks.push(g)},Deflate.prototype.onEnd=function(g){g===I&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=f.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},g.Deflate=Deflate,g.deflate=deflate,g.deflateRaw=deflateRaw,g.gzip=gzip}}),ge=__commonJS({"../node_modules/pako/lib/zlib/inffast.js"(g,m){var f=30,S=12;m.exports=function inflate_fast(g,m){var v,C,_,E,T,I,b,A,P,R,w,M,D,O,N,k,L,F,x,U,V,B,H,$,G;v=g.state,C=g.next_in,$=g.input,_=C+(g.avail_in-5),E=g.next_out,G=g.output,T=E-(m-g.avail_out),I=E+(g.avail_out-257),b=v.dmax,A=v.wsize,P=v.whave,R=v.wnext,w=v.window,M=v.hold,D=v.bits,O=v.lencode,N=v.distcode,k=(1<<v.lenbits)-1,L=(1<<v.distbits)-1;e:do{D<15&&(M+=$[C++]<<D,D+=8,M+=$[C++]<<D,D+=8),F=O[M&k];t:for(;;){if(M>>>=x=F>>>24,D-=x,0===(x=F>>>16&255))G[E++]=65535&F;else{if(!(16&x)){if(0==(64&x)){F=O[(65535&F)+(M&(1<<x)-1)];continue t}if(32&x){v.mode=S;break e}g.msg="invalid literal/length code",v.mode=f;break e}U=65535&F,(x&=15)&&(D<x&&(M+=$[C++]<<D,D+=8),U+=M&(1<<x)-1,M>>>=x,D-=x),D<15&&(M+=$[C++]<<D,D+=8,M+=$[C++]<<D,D+=8),F=N[M&L];i:for(;;){if(M>>>=x=F>>>24,D-=x,!(16&(x=F>>>16&255))){if(0==(64&x)){F=N[(65535&F)+(M&(1<<x)-1)];continue i}g.msg="invalid distance code",v.mode=f;break e}if(V=65535&F,D<(x&=15)&&(M+=$[C++]<<D,(D+=8)<x&&(M+=$[C++]<<D,D+=8)),(V+=M&(1<<x)-1)>b){g.msg="invalid distance too far back",v.mode=f;break e}if(M>>>=x,D-=x,V>(x=E-T)){if((x=V-x)>P&&v.sane){g.msg="invalid distance too far back",v.mode=f;break e}if(B=0,H=w,0===R){if(B+=A-x,x<U){U-=x;do{G[E++]=w[B++]}while(--x);B=E-V,H=G}}else if(R<x){if(B+=A+R-x,(x-=R)<U){U-=x;do{G[E++]=w[B++]}while(--x);if(B=0,R<U){U-=x=R;do{G[E++]=w[B++]}while(--x);B=E-V,H=G}}}else if(B+=R-x,x<U){U-=x;do{G[E++]=w[B++]}while(--x);B=E-V,H=G}for(;U>2;)G[E++]=H[B++],G[E++]=H[B++],G[E++]=H[B++],U-=3;U&&(G[E++]=H[B++],U>1&&(G[E++]=H[B++]))}else{B=E-V;do{G[E++]=G[B++],G[E++]=G[B++],G[E++]=G[B++],U-=3}while(U>2);U&&(G[E++]=G[B++],U>1&&(G[E++]=G[B++]))}break}}break}}while(C<_&&E<I);C-=U=D>>3,M&=(1<<(D-=U<<3))-1,g.next_in=C,g.next_out=E,g.avail_in=C<_?_-C+5:5-(C-_),g.avail_out=E<I?I-E+257:257-(E-I),v.hold=M,v.bits=D}}}),pe=__commonJS({"../node_modules/pako/lib/zlib/inftrees.js"(g,m){var f=re(),S=15,v=852,C=592,_=0,E=1,T=2,I=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],b=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],A=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],P=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];m.exports=function inflate_table(g,m,R,w,M,D,O,N){var k,L,F,x,U,V,B,H,$,G=N.bits,j=0,W=0,q=0,z=0,K=0,J=0,Y=0,Q=0,X=0,Z=0,ee=null,te=0,ie=new f.Buf16(S+1),ne=new f.Buf16(S+1),re=null,se=0;for(j=0;j<=S;j++)ie[j]=0;for(W=0;W<w;W++)ie[m[R+W]]++;for(K=G,z=S;z>=1&&0===ie[z];z--);if(K>z&&(K=z),0===z)return M[D++]=20971520,M[D++]=20971520,N.bits=1,0;for(q=1;q<z&&0===ie[q];q++);for(K<q&&(K=q),Q=1,j=1;j<=S;j++)if(Q<<=1,(Q-=ie[j])<0)return-1;if(Q>0&&(g===_||1!==z))return-1;for(ne[1]=0,j=1;j<S;j++)ne[j+1]=ne[j]+ie[j];for(W=0;W<w;W++)0!==m[R+W]&&(O[ne[m[R+W]]++]=W);if(g===_?(ee=re=O,V=19):g===E?(ee=I,te-=257,re=b,se-=257,V=256):(ee=A,re=P,V=-1),Z=0,W=0,j=q,U=D,J=K,Y=0,F=-1,x=(X=1<<K)-1,g===E&&X>v||g===T&&X>C)return 1;for(;;){B=j-Y,O[W]<V?(H=0,$=O[W]):O[W]>V?(H=re[se+O[W]],$=ee[te+O[W]]):(H=96,$=0),k=1<<j-Y,q=L=1<<J;do{M[U+(Z>>Y)+(L-=k)]=B<<24|H<<16|$|0}while(0!==L);for(k=1<<j-1;Z&k;)k>>=1;if(0!==k?(Z&=k-1,Z+=k):Z=0,W++,0==--ie[j]){if(j===z)break;j=m[R+O[W]]}if(j>K&&(Z&x)!==F){for(0===Y&&(Y=K),U+=q,Q=1<<(J=j-Y);J+Y<z&&!((Q-=ie[J+Y])<=0);)J++,Q<<=1;if(X+=1<<J,g===E&&X>v||g===T&&X>C)return 1;M[F=Z&x]=K<<24|J<<16|U-D|0}}return 0!==Z&&(M[U+Z]=j-Y<<24|64<<16|0),N.bits=K,0}}}),me=__commonJS({"../node_modules/pako/lib/zlib/inflate.js"(g){var m=re(),f=ae(),S=oe(),v=ge(),C=pe(),_=0,E=1,T=2,I=4,b=5,A=6,P=0,R=1,w=2,M=-2,D=-3,O=-4,N=-5,k=8,L=1,F=2,x=3,U=4,V=5,B=6,H=7,$=8,G=9,j=10,W=11,q=12,z=13,K=14,J=15,Y=16,Q=17,X=18,Z=19,ee=20,te=21,ie=22,ne=23,se=24,le=25,ce=26,de=27,he=28,ue=29,me=30,fe=31,Se=852,ve=592,ye=15;function zswap32(g){return(g>>>24&255)+(g>>>8&65280)+((65280&g)<<8)+((255&g)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new m.Buf16(320),this.work=new m.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(g){var f;return g&&g.state?(f=g.state,g.total_in=g.total_out=f.total=0,g.msg="",f.wrap&&(g.adler=1&f.wrap),f.mode=L,f.last=0,f.havedict=0,f.dmax=32768,f.head=null,f.hold=0,f.bits=0,f.lencode=f.lendyn=new m.Buf32(Se),f.distcode=f.distdyn=new m.Buf32(ve),f.sane=1,f.back=-1,P):M}function inflateReset(g){var m;return g&&g.state?((m=g.state).wsize=0,m.whave=0,m.wnext=0,inflateResetKeep(g)):M}function inflateReset2(g,m){var f,S;return g&&g.state?(S=g.state,m<0?(f=0,m=-m):(f=1+(m>>4),m<48&&(m&=15)),m&&(m<8||m>15)?M:(null!==S.window&&S.wbits!==m&&(S.window=null),S.wrap=f,S.wbits=m,inflateReset(g))):M}function inflateInit2(g,m){var f,S;return g?(S=new InflateState,g.state=S,S.window=null,(f=inflateReset2(g,m))!==P&&(g.state=null),f):M}function inflateInit(g){return inflateInit2(g,ye)}var Ce,_e,Ee=!0;function fixedtables(g){if(Ee){var f;for(Ce=new m.Buf32(512),_e=new m.Buf32(32),f=0;f<144;)g.lens[f++]=8;for(;f<256;)g.lens[f++]=9;for(;f<280;)g.lens[f++]=7;for(;f<288;)g.lens[f++]=8;for(C(E,g.lens,0,288,Ce,0,g.work,{bits:9}),f=0;f<32;)g.lens[f++]=5;C(T,g.lens,0,32,_e,0,g.work,{bits:5}),Ee=!1}g.lencode=Ce,g.lenbits=9,g.distcode=_e,g.distbits=5}function updatewindow(g,f,S,v){var C,_=g.state;return null===_.window&&(_.wsize=1<<_.wbits,_.wnext=0,_.whave=0,_.window=new m.Buf8(_.wsize)),v>=_.wsize?(m.arraySet(_.window,f,S-_.wsize,_.wsize,0),_.wnext=0,_.whave=_.wsize):((C=_.wsize-_.wnext)>v&&(C=v),m.arraySet(_.window,f,S-v,C,_.wnext),(v-=C)?(m.arraySet(_.window,f,S-v,v,0),_.wnext=v,_.whave=_.wsize):(_.wnext+=C,_.wnext===_.wsize&&(_.wnext=0),_.whave<_.wsize&&(_.whave+=C))),0}function inflate3(g,re){var ae,oe,ge,pe,Se,ve,ye,Ce,_e,Ee,Te,Ie,be,Ae,Pe,Re,we,Me,De,Oe,Ne,ke,Le,Fe,xe=0,Ue=new m.Buf8(4),Ve=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!g||!g.state||!g.output||!g.input&&0!==g.avail_in)return M;(ae=g.state).mode===q&&(ae.mode=z),Se=g.next_out,ge=g.output,ye=g.avail_out,pe=g.next_in,oe=g.input,ve=g.avail_in,Ce=ae.hold,_e=ae.bits,Ee=ve,Te=ye,ke=P;e:for(;;)switch(ae.mode){case L:if(0===ae.wrap){ae.mode=z;break}for(;_e<16;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(2&ae.wrap&&35615===Ce){ae.check=0,Ue[0]=255&Ce,Ue[1]=Ce>>>8&255,ae.check=S(ae.check,Ue,2,0),Ce=0,_e=0,ae.mode=F;break}if(ae.flags=0,ae.head&&(ae.head.done=!1),!(1&ae.wrap)||(((255&Ce)<<8)+(Ce>>8))%31){g.msg="incorrect header check",ae.mode=me;break}if((15&Ce)!==k){g.msg="unknown compression method",ae.mode=me;break}if(_e-=4,Ne=8+(15&(Ce>>>=4)),0===ae.wbits)ae.wbits=Ne;else if(Ne>ae.wbits){g.msg="invalid window size",ae.mode=me;break}ae.dmax=1<<Ne,g.adler=ae.check=1,ae.mode=512&Ce?j:q,Ce=0,_e=0;break;case F:for(;_e<16;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(ae.flags=Ce,(255&ae.flags)!==k){g.msg="unknown compression method",ae.mode=me;break}if(57344&ae.flags){g.msg="unknown header flags set",ae.mode=me;break}ae.head&&(ae.head.text=Ce>>8&1),512&ae.flags&&(Ue[0]=255&Ce,Ue[1]=Ce>>>8&255,ae.check=S(ae.check,Ue,2,0)),Ce=0,_e=0,ae.mode=x;case x:for(;_e<32;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.head&&(ae.head.time=Ce),512&ae.flags&&(Ue[0]=255&Ce,Ue[1]=Ce>>>8&255,Ue[2]=Ce>>>16&255,Ue[3]=Ce>>>24&255,ae.check=S(ae.check,Ue,4,0)),Ce=0,_e=0,ae.mode=U;case U:for(;_e<16;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.head&&(ae.head.xflags=255&Ce,ae.head.os=Ce>>8),512&ae.flags&&(Ue[0]=255&Ce,Ue[1]=Ce>>>8&255,ae.check=S(ae.check,Ue,2,0)),Ce=0,_e=0,ae.mode=V;case V:if(1024&ae.flags){for(;_e<16;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.length=Ce,ae.head&&(ae.head.extra_len=Ce),512&ae.flags&&(Ue[0]=255&Ce,Ue[1]=Ce>>>8&255,ae.check=S(ae.check,Ue,2,0)),Ce=0,_e=0}else ae.head&&(ae.head.extra=null);ae.mode=B;case B:if(1024&ae.flags&&((Ie=ae.length)>ve&&(Ie=ve),Ie&&(ae.head&&(Ne=ae.head.extra_len-ae.length,ae.head.extra||(ae.head.extra=new Array(ae.head.extra_len)),m.arraySet(ae.head.extra,oe,pe,Ie,Ne)),512&ae.flags&&(ae.check=S(ae.check,oe,Ie,pe)),ve-=Ie,pe+=Ie,ae.length-=Ie),ae.length))break e;ae.length=0,ae.mode=H;case H:if(2048&ae.flags){if(0===ve)break e;Ie=0;do{Ne=oe[pe+Ie++],ae.head&&Ne&&ae.length<65536&&(ae.head.name+=String.fromCharCode(Ne))}while(Ne&&Ie<ve);if(512&ae.flags&&(ae.check=S(ae.check,oe,Ie,pe)),ve-=Ie,pe+=Ie,Ne)break e}else ae.head&&(ae.head.name=null);ae.length=0,ae.mode=$;case $:if(4096&ae.flags){if(0===ve)break e;Ie=0;do{Ne=oe[pe+Ie++],ae.head&&Ne&&ae.length<65536&&(ae.head.comment+=String.fromCharCode(Ne))}while(Ne&&Ie<ve);if(512&ae.flags&&(ae.check=S(ae.check,oe,Ie,pe)),ve-=Ie,pe+=Ie,Ne)break e}else ae.head&&(ae.head.comment=null);ae.mode=G;case G:if(512&ae.flags){for(;_e<16;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(Ce!==(65535&ae.check)){g.msg="header crc mismatch",ae.mode=me;break}Ce=0,_e=0}ae.head&&(ae.head.hcrc=ae.flags>>9&1,ae.head.done=!0),g.adler=ae.check=0,ae.mode=q;break;case j:for(;_e<32;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}g.adler=ae.check=zswap32(Ce),Ce=0,_e=0,ae.mode=W;case W:if(0===ae.havedict)return g.next_out=Se,g.avail_out=ye,g.next_in=pe,g.avail_in=ve,ae.hold=Ce,ae.bits=_e,w;g.adler=ae.check=1,ae.mode=q;case q:if(re===b||re===A)break e;case z:if(ae.last){Ce>>>=7&_e,_e-=7&_e,ae.mode=de;break}for(;_e<3;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}switch(ae.last=1&Ce,_e-=1,3&(Ce>>>=1)){case 0:ae.mode=K;break;case 1:if(fixedtables(ae),ae.mode=ee,re===A){Ce>>>=2,_e-=2;break e}break;case 2:ae.mode=Q;break;case 3:g.msg="invalid block type",ae.mode=me}Ce>>>=2,_e-=2;break;case K:for(Ce>>>=7&_e,_e-=7&_e;_e<32;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if((65535&Ce)!=(Ce>>>16^65535)){g.msg="invalid stored block lengths",ae.mode=me;break}if(ae.length=65535&Ce,Ce=0,_e=0,ae.mode=J,re===A)break e;case J:ae.mode=Y;case Y:if(Ie=ae.length){if(Ie>ve&&(Ie=ve),Ie>ye&&(Ie=ye),0===Ie)break e;m.arraySet(ge,oe,pe,Ie,Se),ve-=Ie,pe+=Ie,ye-=Ie,Se+=Ie,ae.length-=Ie;break}ae.mode=q;break;case Q:for(;_e<14;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(ae.nlen=257+(31&Ce),Ce>>>=5,_e-=5,ae.ndist=1+(31&Ce),Ce>>>=5,_e-=5,ae.ncode=4+(15&Ce),Ce>>>=4,_e-=4,ae.nlen>286||ae.ndist>30){g.msg="too many length or distance symbols",ae.mode=me;break}ae.have=0,ae.mode=X;case X:for(;ae.have<ae.ncode;){for(;_e<3;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.lens[Ve[ae.have++]]=7&Ce,Ce>>>=3,_e-=3}for(;ae.have<19;)ae.lens[Ve[ae.have++]]=0;if(ae.lencode=ae.lendyn,ae.lenbits=7,Le={bits:ae.lenbits},ke=C(_,ae.lens,0,19,ae.lencode,0,ae.work,Le),ae.lenbits=Le.bits,ke){g.msg="invalid code lengths set",ae.mode=me;break}ae.have=0,ae.mode=Z;case Z:for(;ae.have<ae.nlen+ae.ndist;){for(;Re=(xe=ae.lencode[Ce&(1<<ae.lenbits)-1])>>>16&255,we=65535&xe,!((Pe=xe>>>24)<=_e);){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(we<16)Ce>>>=Pe,_e-=Pe,ae.lens[ae.have++]=we;else{if(16===we){for(Fe=Pe+2;_e<Fe;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(Ce>>>=Pe,_e-=Pe,0===ae.have){g.msg="invalid bit length repeat",ae.mode=me;break}Ne=ae.lens[ae.have-1],Ie=3+(3&Ce),Ce>>>=2,_e-=2}else if(17===we){for(Fe=Pe+3;_e<Fe;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}_e-=Pe,Ne=0,Ie=3+(7&(Ce>>>=Pe)),Ce>>>=3,_e-=3}else{for(Fe=Pe+7;_e<Fe;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}_e-=Pe,Ne=0,Ie=11+(127&(Ce>>>=Pe)),Ce>>>=7,_e-=7}if(ae.have+Ie>ae.nlen+ae.ndist){g.msg="invalid bit length repeat",ae.mode=me;break}for(;Ie--;)ae.lens[ae.have++]=Ne}}if(ae.mode===me)break;if(0===ae.lens[256]){g.msg="invalid code -- missing end-of-block",ae.mode=me;break}if(ae.lenbits=9,Le={bits:ae.lenbits},ke=C(E,ae.lens,0,ae.nlen,ae.lencode,0,ae.work,Le),ae.lenbits=Le.bits,ke){g.msg="invalid literal/lengths set",ae.mode=me;break}if(ae.distbits=6,ae.distcode=ae.distdyn,Le={bits:ae.distbits},ke=C(T,ae.lens,ae.nlen,ae.ndist,ae.distcode,0,ae.work,Le),ae.distbits=Le.bits,ke){g.msg="invalid distances set",ae.mode=me;break}if(ae.mode=ee,re===A)break e;case ee:ae.mode=te;case te:if(ve>=6&&ye>=258){g.next_out=Se,g.avail_out=ye,g.next_in=pe,g.avail_in=ve,ae.hold=Ce,ae.bits=_e,v(g,Te),Se=g.next_out,ge=g.output,ye=g.avail_out,pe=g.next_in,oe=g.input,ve=g.avail_in,Ce=ae.hold,_e=ae.bits,ae.mode===q&&(ae.back=-1);break}for(ae.back=0;Re=(xe=ae.lencode[Ce&(1<<ae.lenbits)-1])>>>16&255,we=65535&xe,!((Pe=xe>>>24)<=_e);){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(Re&&0==(240&Re)){for(Me=Pe,De=Re,Oe=we;Re=(xe=ae.lencode[Oe+((Ce&(1<<Me+De)-1)>>Me)])>>>16&255,we=65535&xe,!(Me+(Pe=xe>>>24)<=_e);){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}Ce>>>=Me,_e-=Me,ae.back+=Me}if(Ce>>>=Pe,_e-=Pe,ae.back+=Pe,ae.length=we,0===Re){ae.mode=ce;break}if(32&Re){ae.back=-1,ae.mode=q;break}if(64&Re){g.msg="invalid literal/length code",ae.mode=me;break}ae.extra=15&Re,ae.mode=ie;case ie:if(ae.extra){for(Fe=ae.extra;_e<Fe;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.length+=Ce&(1<<ae.extra)-1,Ce>>>=ae.extra,_e-=ae.extra,ae.back+=ae.extra}ae.was=ae.length,ae.mode=ne;case ne:for(;Re=(xe=ae.distcode[Ce&(1<<ae.distbits)-1])>>>16&255,we=65535&xe,!((Pe=xe>>>24)<=_e);){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(0==(240&Re)){for(Me=Pe,De=Re,Oe=we;Re=(xe=ae.distcode[Oe+((Ce&(1<<Me+De)-1)>>Me)])>>>16&255,we=65535&xe,!(Me+(Pe=xe>>>24)<=_e);){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}Ce>>>=Me,_e-=Me,ae.back+=Me}if(Ce>>>=Pe,_e-=Pe,ae.back+=Pe,64&Re){g.msg="invalid distance code",ae.mode=me;break}ae.offset=we,ae.extra=15&Re,ae.mode=se;case se:if(ae.extra){for(Fe=ae.extra;_e<Fe;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}ae.offset+=Ce&(1<<ae.extra)-1,Ce>>>=ae.extra,_e-=ae.extra,ae.back+=ae.extra}if(ae.offset>ae.dmax){g.msg="invalid distance too far back",ae.mode=me;break}ae.mode=le;case le:if(0===ye)break e;if(Ie=Te-ye,ae.offset>Ie){if((Ie=ae.offset-Ie)>ae.whave&&ae.sane){g.msg="invalid distance too far back",ae.mode=me;break}Ie>ae.wnext?(Ie-=ae.wnext,be=ae.wsize-Ie):be=ae.wnext-Ie,Ie>ae.length&&(Ie=ae.length),Ae=ae.window}else Ae=ge,be=Se-ae.offset,Ie=ae.length;Ie>ye&&(Ie=ye),ye-=Ie,ae.length-=Ie;do{ge[Se++]=Ae[be++]}while(--Ie);0===ae.length&&(ae.mode=te);break;case ce:if(0===ye)break e;ge[Se++]=ae.length,ye--,ae.mode=te;break;case de:if(ae.wrap){for(;_e<32;){if(0===ve)break e;ve--,Ce|=oe[pe++]<<_e,_e+=8}if(Te-=ye,g.total_out+=Te,ae.total+=Te,Te&&(g.adler=ae.check=ae.flags?S(ae.check,ge,Te,Se-Te):f(ae.check,ge,Te,Se-Te)),Te=ye,(ae.flags?Ce:zswap32(Ce))!==ae.check){g.msg="incorrect data check",ae.mode=me;break}Ce=0,_e=0}ae.mode=he;case he:if(ae.wrap&&ae.flags){for(;_e<32;){if(0===ve)break e;ve--,Ce+=oe[pe++]<<_e,_e+=8}if(Ce!==(4294967295&ae.total)){g.msg="incorrect length check",ae.mode=me;break}Ce=0,_e=0}ae.mode=ue;case ue:ke=R;break e;case me:ke=D;break e;case fe:return O;default:return M}return g.next_out=Se,g.avail_out=ye,g.next_in=pe,g.avail_in=ve,ae.hold=Ce,ae.bits=_e,(ae.wsize||Te!==g.avail_out&&ae.mode<me&&(ae.mode<de||re!==I))&&updatewindow(g,g.output,g.next_out,Te-g.avail_out),Ee-=g.avail_in,Te-=g.avail_out,g.total_in+=Ee,g.total_out+=Te,ae.total+=Te,ae.wrap&&Te&&(g.adler=ae.check=ae.flags?S(ae.check,ge,Te,g.next_out-Te):f(ae.check,ge,Te,g.next_out-Te)),g.data_type=ae.bits+(ae.last?64:0)+(ae.mode===q?128:0)+(ae.mode===ee||ae.mode===J?256:0),(0===Ee&&0===Te||re===I)&&ke===P&&(ke=N),ke}function inflateEnd(g){if(!g||!g.state)return M;var m=g.state;return m.window&&(m.window=null),g.state=null,P}function inflateGetHeader(g,m){var f;return g&&g.state?0==(2&(f=g.state).wrap)?M:(f.head=m,m.done=!1,P):M}function inflateSetDictionary(g,m){var S,v=m.length;return g&&g.state?0!==(S=g.state).wrap&&S.mode!==W?M:S.mode===W&&f(1,m,v,0)!==S.check?D:updatewindow(g,m,v,v)?(S.mode=fe,O):(S.havedict=1,P):M}g.inflateReset=inflateReset,g.inflateReset2=inflateReset2,g.inflateResetKeep=inflateResetKeep,g.inflateInit=inflateInit,g.inflateInit2=inflateInit2,g.inflate=inflate3,g.inflateEnd=inflateEnd,g.inflateGetHeader=inflateGetHeader,g.inflateSetDictionary=inflateSetDictionary,g.inflateInfo="pako inflate (from Nodeca project)"}}),fe=__commonJS({"../node_modules/pako/lib/zlib/constants.js"(g,m){m.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8}}}),Se=__commonJS({"../node_modules/pako/lib/zlib/gzheader.js"(g,m){function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}m.exports=GZheader}}),ve=__commonJS({"../node_modules/pako/lib/inflate.js"(g){var m=me(),f=re(),S=de(),v=fe(),C=le(),_=he(),E=Se(),T=Object.prototype.toString;function Inflate(g){if(!(this instanceof Inflate))return new Inflate(g);this.options=f.assign({chunkSize:16384,windowBits:0,to:""},g||{});var I=this.options;I.raw&&I.windowBits>=0&&I.windowBits<16&&(I.windowBits=-I.windowBits,0===I.windowBits&&(I.windowBits=-15)),!(I.windowBits>=0&&I.windowBits<16)||g&&g.windowBits||(I.windowBits+=32),I.windowBits>15&&I.windowBits<48&&0==(15&I.windowBits)&&(I.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new _,this.strm.avail_out=0;var b=m.inflateInit2(this.strm,I.windowBits);if(b!==v.Z_OK)throw new Error(C[b]);if(this.header=new E,m.inflateGetHeader(this.strm,this.header),I.dictionary&&("string"==typeof I.dictionary?I.dictionary=S.string2buf(I.dictionary):"[object ArrayBuffer]"===T.call(I.dictionary)&&(I.dictionary=new Uint8Array(I.dictionary)),I.raw&&(b=m.inflateSetDictionary(this.strm,I.dictionary))!==v.Z_OK))throw new Error(C[b])}function inflate3(g,m){var f=new Inflate(m);if(f.push(g,!0),f.err)throw f.msg||C[f.err];return f.result}function inflateRaw(g,m){return(m=m||{}).raw=!0,inflate3(g,m)}Inflate.prototype.push=function(g,C){var _,E,I,b,A,P=this.strm,R=this.options.chunkSize,w=this.options.dictionary,M=!1;if(this.ended)return!1;E=C===~~C?C:!0===C?v.Z_FINISH:v.Z_NO_FLUSH,"string"==typeof g?P.input=S.binstring2buf(g):"[object ArrayBuffer]"===T.call(g)?P.input=new Uint8Array(g):P.input=g,P.next_in=0,P.avail_in=P.input.length;do{if(0===P.avail_out&&(P.output=new f.Buf8(R),P.next_out=0,P.avail_out=R),(_=m.inflate(P,v.Z_NO_FLUSH))===v.Z_NEED_DICT&&w&&(_=m.inflateSetDictionary(this.strm,w)),_===v.Z_BUF_ERROR&&!0===M&&(_=v.Z_OK,M=!1),_!==v.Z_STREAM_END&&_!==v.Z_OK)return this.onEnd(_),this.ended=!0,!1;P.next_out&&(0!==P.avail_out&&_!==v.Z_STREAM_END&&(0!==P.avail_in||E!==v.Z_FINISH&&E!==v.Z_SYNC_FLUSH)||("string"===this.options.to?(I=S.utf8border(P.output,P.next_out),b=P.next_out-I,A=S.buf2string(P.output,I),P.next_out=b,P.avail_out=R-b,b&&f.arraySet(P.output,P.output,I,b,0),this.onData(A)):this.onData(f.shrinkBuf(P.output,P.next_out)))),0===P.avail_in&&0===P.avail_out&&(M=!0)}while((P.avail_in>0||0===P.avail_out)&&_!==v.Z_STREAM_END);return _===v.Z_STREAM_END&&(E=v.Z_FINISH),E===v.Z_FINISH?(_=m.inflateEnd(this.strm),this.onEnd(_),this.ended=!0,_===v.Z_OK):E!==v.Z_SYNC_FLUSH||(this.onEnd(v.Z_OK),P.avail_out=0,!0)},Inflate.prototype.onData=function(g){this.chunks.push(g)},Inflate.prototype.onEnd=function(g){g===v.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=f.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg},g.Inflate=Inflate,g.inflate=inflate3,g.inflateRaw=inflateRaw,g.ungzip=inflate3}}),ye=__commonJS({"../node_modules/pako/index.js"(g,m){var f={};(0,re().assign)(f,ue(),ve(),fe()),m.exports=f}}),Ce=__commonJS({"../node_modules/sdp-transform/lib/grammar.js"(g,m){var f=m.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\S*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(g){return g.encoding?"rtpmap:%d %s/%s/%s":g.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(g){return null!=g.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbXMessage",reg:/^rtcp-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"rtcp-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%d trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(g){return null!=g.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(g){return"extmap:%d"+(g.direction?"/%s":"%v")+(g["encrypt-uri"]?" %s":"%v")+" %s"+(g.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"cryptoscale",reg:/^cryptoscale:(\d*) (client|server) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","flavor","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"cryptoscale:%d %s %s %s %s":"cryptoscale:%d %s %s %s"}},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(g){return null!=g.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m+=null!=g["network-id"]?" network-id %d":"%v",m+=null!=g["network-cost"]?" network-cost %d":"%v"}},{push:"xCandidatesIpv6",reg:/^x-candidate-ipv6:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation"],format:function(g){var m="candidate:%s %d %s %d %s %d typ %s";return m+=null!=g.raddr?" raddr %s rport %d":"%v%v",m+=null!=g.tcptype?" tcptype %s":"%v",null!=g.generation&&(m+=" generation %d"),m}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(g){var m="ssrc:%d";return null!=g.attribute&&(m+=" %s",null!=g.value&&(m+=":%s")),m}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(g){return null!=g.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(g){return g.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(g){return"imageattr:%s %s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(g){return"simulcast:%s %s"+(g.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(g){return"ts-refclk:%s"+(null!=g.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(g){var m="mediaclk:";return m+=null!=g.id?"id=%s %s":"%v%s",m+=null!=g.mediaClockValue?"=%s":"",m+=null!=g.rateNumerator?" rate=%s":"",m+=null!=g.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{name:"xMediaBw",reg:/^x-mediabw:(\S*) send=(\d*);recv=(\d*)/,names:["label","sendBw","receiveBw"],format:"x-mediabw:%s send=%d;recv=%d"},{name:"xSsrcRange",reg:/^x-ssrc-range:(\d*)-(\d*)/,names:["ssrcMin","ssrcMax"],format:"x-ssrc-range:%d-%d"},{name:"xSource",reg:/^x-source:(\S*)/,format:"x-source:%s"},{name:"xSourceStreamId",reg:/^x-source-streamid:(\S*)/,format:"x-source-streamid:%s"},{name:"xCaps",reg:/^x-caps:(\d*) (\S*)/,names:["payloadType","value"],format:"x-caps:%d %s"},{name:"signalingFbXMessage",reg:/^x-signaling-fb:(\*|\d*) x-message ([\S| ]*)/,names:["payload","param"],format:function(g){return"x-signaling-fb:"+("*"===g.payload?"%s":"%d")+" x-message %s"}},{push:"xMediaSettings",reg:/^x-mediasettings:([\S| ]*)/,names:["settings"],format:"x-mediasettings:%s"},{name:"xDataProtocol",reg:/^x-data-protocol:\s?(.*)/,format:"x-data-protocol:%s"},{push:"invalid",names:["value"]}]};Object.keys(f).forEach((function(g){f[g].forEach((function(g){g.reg||(g.reg=/(.*)/),g.format||(g.format="%s")}))}))}}),_e=__commonJS({"../node_modules/sdp-transform/lib/parser.js"(g){var toIntIfInt=function(g){return String(Number(g))===g?Number(g):g},attachProperties=function(g,m,f,S){if(S&&!f)m[S]=toIntIfInt(g[1]);else for(var v=0;v<f.length;v+=1)null!=g[v+1]&&(m[f[v]]=toIntIfInt(g[v+1]))},parseReg=function(g,m,f){var S=g.name&&g.names;g.push&&!m[g.push]?m[g.push]=[]:S&&!m[g.name]&&(m[g.name]={});var v=g.push?{}:S?m[g.name]:m;attachProperties(f.match(g.reg),v,g.names,g.name),g.push&&m[g.push].push(v)},m=Ce(),f=RegExp.prototype.test.bind(/^([a-z])=(.*)/);g.parse=function(g){var S={},v=[],C=S;return g.split(/(\r\n|\r|\n)/).filter(f).forEach((function(g){var f=g[0],S=g.slice(2);"m"===f&&(v.push({rtp:[],fmtp:[]}),C=v[v.length-1]);for(var _=0;_<(m[f]||[]).length;_+=1){var E=m[f][_];if(E.reg.test(S))return parseReg(E,C,S)}})),S.media=v,S};var paramReducer=function(g,m){var f=m.split(/=(.+)/,2);return 2===f.length?g[f[0]]=toIntIfInt(f[1]):1===f.length&&m.length>1&&(g[f[0]]=void 0),g};g.parseParams=function(g){return g.split(/;\s?/).reduce(paramReducer,{})},g.parseFmtpConfig=g.parseParams,g.parsePayloads=function(g){return g.toString().split(" ").map(Number)},g.parseRemoteCandidates=function(g){for(var m=[],f=g.split(" ").map(toIntIfInt),S=0;S<f.length;S+=3)m.push({component:f[S],ip:f[S+1],port:f[S+2]});return m},g.parseImageAttributes=function(g){return g.split(" ").map((function(g){return g.substring(1,g.length-1).split(",").reduce(paramReducer,{})}))},g.parseSimulcastStreamList=function(g){return g.split(";").map((function(g){return g.split(",").map((function(g){var m,f=!1;return"~"!==g[0]?m=toIntIfInt(g):(m=toIntIfInt(g.substring(1,g.length)),f=!0),{scid:m,paused:f}}))}))}}}),Ee=__commonJS({"../node_modules/sdp-transform/lib/writer.js"(g,m){var f=Ce(),S=/%[sdv%]/g,format=function(g){var m=1,f=arguments,v=f.length;return g.replace(S,(function(g){if(m>=v)return g;var S=f[m];switch(m+=1,g){case"%%":return"%";case"%s":return String(S);case"%d":return Number(S);case"%v":return""}}))},makeLine=function(g,m,f){var S=[g+"="+(m.format instanceof Function?m.format(m.push?f:f[m.name]):m.format)];if(m.names)for(var v=0;v<m.names.length;v+=1){var C=m.names[v];m.name?S.push(f[m.name][C]):S.push(f[m.names[v]])}else S.push(f[m.name]);return format.apply(null,S)},v=["v","o","s","i","u","e","p","c","b","t","r","z","a"],C=["i","c","b","a"];m.exports=function(g,m){m=m||{},null==g.version&&(g.version=0),null==g.name&&(g.name=" "),g.media.forEach((function(g){null==g.payloads&&(g.payloads="")}));var S=m.outerOrder||v,_=m.innerOrder||C,E=[];return S.forEach((function(m){f[m].forEach((function(f){f.name in g&&null!=g[f.name]?E.push(makeLine(m,f,g)):f.push in g&&null!=g[f.push]&&g[f.push].forEach((function(g){E.push(makeLine(m,f,g))}))}))})),g.media.forEach((function(g){E.push(makeLine("m",f.m[0],g)),_.forEach((function(m){f[m].forEach((function(f){f.name in g&&null!=g[f.name]?E.push(makeLine(m,f,g)):f.push in g&&null!=g[f.push]&&g[f.push].forEach((function(g){E.push(makeLine(m,f,g))}))}))}))})),E.join("\r\n")+"\r\n"}}}),Te=__commonJS({"../node_modules/sdp-transform/lib/index.js"(g){var m=_e(),f=Ee();g.write=f,g.parse=m.parse,g.parseParams=m.parseParams,g.parseFmtpConfig=m.parseFmtpConfig,g.parsePayloads=m.parsePayloads,g.parseRemoteCandidates=m.parseRemoteCandidates,g.parseImageAttributes=m.parseImageAttributes,g.parseSimulcastStreamList=m.parseSimulcastStreamList}}),Ie=__commonJS({"../skype-calling-utilities/dist/skype-calling-utilities.bundle.js"(g,m){!function webpackUniversalModuleDefinition(f,S){"object"==typeof g&&"object"==typeof m?m.exports=S(R):"object"==typeof g?g["skype-calling-utilities"]=S(R):f["skype-calling-utilities"]=S(f.lodash)}(window,(function(g){return function(){var m={826:function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.EventSourceImpl=void 0;var S=f(467),v=f(582),C=function(){function EventSourceImpl3(g){this.eventLogger=g,this.subscriptions=[]}return EventSourceImpl3.prototype.subscribe=function(g){return new _(this.subscriptions,g)},EventSourceImpl3.prototype.dispose=function(g){this.subscriptions=[]},EventSourceImpl3.prototype.raiseEvents=function(g){var m=this;this.subscriptions.slice().forEach((function(f){var S,C;try{void 0!==f.eventHandler&&g(f.eventHandler)}catch(g){null===(C=null===(S=m.eventLogger)||void 0===S?void 0:S.warn)||void 0===C||C.call(S,"Event handler exception caught!",(0,v.stringifyObject)(g))}}))},EventSourceImpl3}();m.EventSourceImpl=C;var _=function(){function EventSubscriptionImpl3(g,m){this.subscriptions=g,this.eventHandler=m,this.subscriptions.push(this)}return EventSubscriptionImpl3.prototype.dispose=function(){var g=this;(0,S.remove)(this.subscriptions,(function(m){return m===g})),this.eventHandler=void 0},EventSubscriptionImpl3}()},105:function(g,m,f){var S=this&&this.__extends||function(){var extendStatics=function(g,m){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)Object.prototype.hasOwnProperty.call(m,f)&&(g[f]=m[f])})(g,m)};return function(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function __(){this.constructor=g}extendStatics(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}}(),v=this&&this.__spreadArray||function(g,m,f){if(f||2===arguments.length)for(var S,v=0,C=m.length;v<C;v++)!S&&v in m||(S||(S=Array.prototype.slice.call(m,0,v)),S[v]=m[v]);return g.concat(S||Array.prototype.slice.call(m))};Object.defineProperty(m,"__esModule",{value:!0});var C=function(g){function ObservableBase3(m){return g.call(this,m)||this}return S(ObservableBase3,g),ObservableBase3.prototype.changed=function(g,m){return this.subscribe({changed:{skipEventConfig:m,handler:g},on:void 0})},ObservableBase3.prototype.on=function(g,m){return this.subscribe({changed:void 0,on:{name:String(g),handler:this._toEventCallback(m)}})},ObservableBase3.prototype.once=function(g,m,f){var S,v=this,onceSubscription=function(){for(var g=[],C=0;C<arguments.length;C++)g[C]=arguments[C];S.dispose(f),v._toEventCallback(m).apply(void 0,g)};return S=this.on(g,this._fromEventCallback(onceSubscription))},ObservableBase3.prototype.raiseChanged=function(g){var m=this;this.raiseEvents((function(f){if(f.changed){var S=f.changed,v=S.skipEventConfig,C=S.handler;!m.getShouldSkipChangedEvent(g,v)&&C()}}))},ObservableBase3.prototype.event=function(g){var m=this;return{raise:this._fromEventCallback((function(){for(var f=[],S=0;S<arguments.length;S++)f[S]=arguments[S];return m._raiseEventImpl.apply(m,v([String(g)],f,!1))}))}},ObservableBase3.prototype._raiseEventImpl=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];this.raiseEvents((function(f){var S;return f.on&&f.on.name===g&&(S=f.on).handler.apply(S,m)}))},ObservableBase3.prototype._toEventCallback=function(g){return g},ObservableBase3.prototype._fromEventCallback=function(g){return g},ObservableBase3.prototype.getShouldSkipChangedEvent=function(g,m){return(null==g?void 0:g.skipDominantSpeakerUpdatesOnCall)?!!(null==m?void 0:m.skipDominantSpeakerUpdatesOnCall):!!(null==g?void 0:g.skipParticipantsUpdatesOnCall)&&!!(null==m?void 0:m.skipParticipantsUpdatesOnCall)},ObservableBase3}(f(826).EventSourceImpl);m.default=C},869:function(g,m){var f;Object.defineProperty(m,"__esModule",{value:!0}),m.ScreenSharingControlProtocol=void 0,function(g){var m=7,f=3;function encodeMouseEvent(g){if(!g)return new Uint8Array(0);g.buttonType||(g.buttonType=0),g.xPos||(g.xPos=0),g.yPos||(g.yPos=0),g.wheelRotation||(g.wheelRotation=0);var f=new ArrayBuffer(m),S=new DataView(f),v=(3&g.type)<<0,C=(7&g.buttonType)<<2,_=(g.buttonDown?1:0)<<5,E=(g.wheelButtonDown?1:0)<<6,T=0;return S.setUint8(0,1),S.setUint8(1,v|C|_|E|T),S.setUint16(2,g.xPos,!0),S.setUint16(4,g.yPos,!0),S.setUint8(6,g.wheelRotation),new Uint8Array(f)}function encodeKeyboardEvent(g){var m=new ArrayBuffer(f),S=new DataView(m),v=(3&g.codeType)<<0,C=0,_=(g.keyUp?1:0)<<4,E=(g.repeat?1:0)<<5,T=0,I=0;return S.setUint8(0,0),S.setUint8(1,v|C|_|E|T|I),S.setUint8(2,g.code),new Uint8Array(m)}function decodeEventType(g){return g[0]}function decodeMouseEvent(g){if(1!==g[0]||g.length!==m)return null;var f=new DataView(g.buffer),S=f.getUint8(1);return{type:3&S,buttonType:S>>2&7,buttonDown:!!(S>>5&1),wheelButtonDown:!!(S>>6&1),xPos:f.getUint16(2,!0),yPos:f.getUint16(4,!0),wheelRotation:f.getUint8(6)}}function decodeKeyboardEvent(g){if(0!==g[0]||g.length!==f)return null;var m=new DataView(g.buffer),S=m.getUint8(1);return{codeType:3&S,code:m.getUint8(2),repeat:!!(S>>5&1),keyUp:!!(S>>4&1)}}g.encodeMouseEvent=encodeMouseEvent,g.encodeKeyboardEvent=encodeKeyboardEvent,g.decodeEventType=decodeEventType,g.decodeMouseEvent=decodeMouseEvent,g.decodeKeyboardEvent=decodeKeyboardEvent}(f||(m.ScreenSharingControlProtocol=f={}))},582:function(g,m){function getRandomizedTimeout2(g){var m=Math.floor(11*Math.random())+10;return Math.floor(g*(1-m/100))}function isStringBase642(g){if(!g)return!1;try{return atob(g),!0}catch(g){return!1}}function isPromiseLike2(g){return!!g&&"function"==typeof g.then}function stringifyObject2(g){if(!g)return"".concat(g);if(g instanceof Map)return mapToString2(g);var m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}function mapToString2(g){var m={};return g.forEach((function(g,f){m[f.toString()]=g})),JSON.stringify(m)}function stringToBuffer2(g){for(var m=new ArrayBuffer(g.length),f=new Uint8Array(m),S=0;S<g.length;S++)f[S]=g.charCodeAt(S);return f}Object.defineProperty(m,"__esModule",{value:!0}),m.stringToBuffer=m.stringifyObject=m.isPromiseLike=m.isStringBase64=m.getRandomizedTimeout=void 0,m.getRandomizedTimeout=getRandomizedTimeout2,m.isStringBase64=isStringBase642,m.isPromiseLike=isPromiseLike2,m.stringifyObject=stringifyObject2,m.stringToBuffer=stringToBuffer2},289:function(g,m,f){var S=this&&this.__extends||function(){var extendStatics=function(g,m){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)Object.prototype.hasOwnProperty.call(m,f)&&(g[f]=m[f])})(g,m)};return function(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");function __(){this.constructor=g}extendStatics(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}}();Object.defineProperty(m,"__esModule",{value:!0}),m.SlimCoreElectronControlCapturer=void 0;var v=f(105),C=f(869),_=65535,E=3e3,T=250,I=18,b=17,A=16,P=91,R=50,w=30,M=function(g){function SlimCoreElectronControlCapturer3(m,f,S,v){var C,_;void 0===S&&(S=!0),void 0===v&&(v=1);var E=g.call(this)||this;return E._logger=m,E._element=f,E._captureRegionPreserveAspectRatio=S,E._mouseMoveCount=0,E._mouseMoveStartTime=0,E._isMouseDown=!1,E._isMouseOnRenderer=!1,E._captureMode=0,E._pollTimerID=0,E._resizeTimerID=0,E._mouseMoveThrottlingEnabled=!1,E._handleResizeEvents=function(){clearTimeout(E._resizeTimerID),E._resizeTimerID=window.setTimeout((function(){E.updateCaptureRegion()}),T)},E._handleMouseLeave=function(g){!E._isOnScreenContent(g)&&E._isMouseOnRenderer&&(E._raiseCaptureEvent(2),E._logger.info("Mouse leaving render region")),E._isMouseOnRenderer=!1},E._handleMouseEnter=function(g){E._isOnScreenContent(g)&&(E._isMouseOnRenderer=!0,E._raiseCaptureEvent(1),E._logger.info("Mouse entering render region"))},E._handleLosingFocus=function(){E._syncKeyStates(!0)},E._handleClick=function(g){E._isOnScreenContent(g)&&(E._raiseCaptureEvent(0),E._logger.info("Mouse clicked"))},E._handleMouseMove=function(g){if(!E._isOnScreenContent(g)&&E._isMouseOnRenderer)return E._raiseCaptureEvent(2),E._isMouseOnRenderer=!1,void E._logger.info("Mouse leaving render region");if(E._isOnScreenContent(g)&&!E._isMouseOnRenderer&&(E._raiseCaptureEvent(1),E._isMouseOnRenderer=!0,E._logger.info("Mouse entering render region")),2===E._captureMode||3===E._captureMode){if(E._mouseMoveCount++,E._mouseMoveThrottlingEnabled){if(!E._isOnScreenContent(g)||!E._shouldMoveMouse())return}else if(!E._isOnScreenContent(g)||E._mouseMoveCount%2==0)return;var m={type:0};E._normalizeMousePosition(g,m),E._raiseMouseEvent(m)}},E._handleMouseDown=function(g){if((2===E._captureMode||3===E._captureMode)&&E._isOnScreenContent(g)){var m={type:2,buttonType:convertButton(g.button),buttonDown:!0};E._isMouseDown=!0,E._normalizeMousePosition(g,m),E._raiseMouseEvent(m)}},E._handleMouseUp=function(g){if((2===E._captureMode||3===E._captureMode)&&E._isOnScreenContent(g)){var m={type:2,buttonType:convertButton(g.button),buttonDown:!1};E._isMouseDown=!1,E._normalizeMousePosition(g,m),E._raiseMouseEvent(m)}},E._handleKeyDown=function(g){E._raiseKeyboardEvent({codeType:1,code:g.keyCode,repeat:g.repeat,keyUp:!1}),g.stopPropagation(),g.preventDefault()},E._handleKeyUp=function(g){E._raiseKeyboardEvent({codeType:1,code:g.keyCode,repeat:g.repeat,keyUp:!0}),g.stopPropagation(),g.preventDefault()},E._handleWheel=function(g){E._raiseMouseEvent({type:1,wheelRotation:g.deltaY>0?-120:120})},E._handleContextMenu=function(g){g.preventDefault()},E._ensureCanReceiveKeyboardInput(),null===(_=null===(C=E._element.ownerDocument)||void 0===C?void 0:C.defaultView)||void 0===_||_.addEventListener("resize",E._handleResizeEvents,!1),E._captureRegion={left:0,top:0,width:E._element.clientWidth,height:E._element.clientHeight},E._videoSize={width:Math.floor(f.clientHeight*v),height:f.clientHeight},E._origElementSize={width:0,height:0},E._checkElementSize(),E._mouseMoveStartTime=new Date(0).getTime(),E}return S(SlimCoreElectronControlCapturer3,g),Object.defineProperty(SlimCoreElectronControlCapturer3.prototype,"captureMode",{get:function(){return this._captureMode},enumerable:!1,configurable:!0}),Object.defineProperty(SlimCoreElectronControlCapturer3.prototype,"captureRegion",{get:function(){return this._captureRegion},enumerable:!1,configurable:!0}),SlimCoreElectronControlCapturer3.prototype.setMouseMoveThrottlingFeatureFlag=function(g){this._mouseMoveThrottlingEnabled=g},SlimCoreElectronControlCapturer3.prototype.dispose=function(m){var f,S;this._logger.info("dispose causeId: ".concat(m)),window.clearTimeout(this._pollTimerID),null===(S=null===(f=this._element.ownerDocument)||void 0===f?void 0:f.defaultView)||void 0===S||S.removeEventListener("resize",this._handleResizeEvents,!1),g.prototype.dispose.call(this,m)},SlimCoreElectronControlCapturer3.prototype.updateVideoSize=function(g,m){this._videoSize.width=g,this._videoSize.height=m,this.updateCaptureRegion()},SlimCoreElectronControlCapturer3.prototype.updateCaptureRegion=function(){this._captureRegionPreserveAspectRatio?(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientWidth*this._videoSize.height/this._videoSize.width,this._captureRegion.height>this._element.clientHeight?(this._captureRegion.width=this._element.clientHeight*this._videoSize.width/this._videoSize.height,this._captureRegion.height=this._element.clientHeight,this._captureRegion.left=(this._element.clientWidth-this._captureRegion.width)/2,this._captureRegion.top=0):(this._captureRegion.left=0,this._captureRegion.top=(this._element.clientHeight-this._captureRegion.height)/2)):(this._captureRegion.width=this._element.clientWidth,this._captureRegion.height=this._element.clientHeight,this._captureRegion.top=0,this._captureRegion.left=0)},SlimCoreElectronControlCapturer3.prototype.setCaptureMode=function(g){3===this._captureMode&&3!==g&&this._syncKeyStates(!0),this._captureMode=g,0!==g?("none"===this._element.style.pointerEvents&&this._logger.warn("Element pointer-events is 'none', event handlers will not work"),this._element.addEventListener("click",this._handleClick),this._element.addEventListener("pointermove",this._handleMouseMove),this._element.addEventListener("pointerdown",this._handleMouseDown),this._element.addEventListener("pointerup",this._handleMouseUp),this._element.addEventListener("pointerenter",this._handleMouseEnter),this._element.addEventListener("pointerleave",this._handleMouseLeave),3===g?(this._element.addEventListener("wheel",this._handleWheel),this._element.addEventListener("keydown",this._handleKeyDown),this._element.addEventListener("keyup",this._handleKeyUp),this._element.addEventListener("contextmenu",this._handleContextMenu),this._element.addEventListener("blur",this._handleLosingFocus)):(this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))):(this._element.removeEventListener("pointermove",this._handleMouseMove),this._element.removeEventListener("pointerdown",this._handleMouseDown),this._element.removeEventListener("pointerup",this._handleMouseUp),this._element.removeEventListener("pointerenter",this._handleMouseEnter),this._element.removeEventListener("pointerleave",this._handleMouseLeave),this._element.removeEventListener("click",this._handleClick),this._element.removeEventListener("wheel",this._handleWheel),this._element.removeEventListener("keydown",this._handleKeyDown),this._element.removeEventListener("keyup",this._handleKeyUp),this._element.removeEventListener("contextmenu",this._handleContextMenu),this._element.removeEventListener("blur",this._handleLosingFocus))},SlimCoreElectronControlCapturer3.prototype._ensureCanReceiveKeyboardInput=function(){this._element.tabIndex=this._element.tabIndex},SlimCoreElectronControlCapturer3.prototype._checkElementSize=function(){var g=this;this._origElementSize.width===this._element.clientWidth&&this._origElementSize.height===this._element.clientHeight||(this.updateCaptureRegion(),this._origElementSize.width=this._element.clientWidth,this._origElementSize.height=this._element.clientHeight),this._pollTimerID=window.setTimeout((function(){g._checkElementSize()}),E)},SlimCoreElectronControlCapturer3.prototype._raiseMouseEvent=function(g){this.event("mouseControlEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._raiseKeyboardEvent=function(g){this.event("keyboardControlEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._raiseCaptureEvent=function(g){this.event("ctrlCaptureEvent").raise(g)},SlimCoreElectronControlCapturer3.prototype._normalizeMousePosition=function(g,m){m.xPos=(g.offsetX-this._captureRegion.left)/this._captureRegion.width*_,m.yPos=(g.offsetY-this._captureRegion.top)/this._captureRegion.height*_},SlimCoreElectronControlCapturer3.prototype._isOnScreenContent=function(g){var m=this._captureRegion.left,f=this._captureRegion.left+this._captureRegion.width,S=this._captureRegion.top,v=this._captureRegion.top+this._captureRegion.height;return m<=g.offsetX&&g.offsetX<f&&S<=g.offsetY&&g.offsetY<v},SlimCoreElectronControlCapturer3.prototype._shouldMoveMouse=function(){if(this._mouseMoveStartTime){var g=(new Date).getTime(),m=g-this._mouseMoveStartTime;if(this._isMouseDown&&m>=w||!this._isMouseDown&&m>=R)return this._mouseMoveStartTime=g,!0}else this._mouseMoveStartTime=(new Date).getTime();return!1},SlimCoreElectronControlCapturer3.prototype._syncKeyStates=function(g){this._raiseKeyboardEvent({codeType:1,code:b,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:A,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:I,repeat:!1,keyUp:g}),this._raiseKeyboardEvent({codeType:1,code:P,repeat:!1,keyUp:g}),this._logger.info("Synced Key states.")},SlimCoreElectronControlCapturer3.formatMouseEvent=function(g){return C.ScreenSharingControlProtocol.encodeMouseEvent(g)},SlimCoreElectronControlCapturer3.formatKeyboardEvent=function(g){return C.ScreenSharingControlProtocol.encodeKeyboardEvent(g)},SlimCoreElectronControlCapturer3}(v.default);function convertButton(g){switch(g){case 0:return 0;case 2:return 1;case 1:return 2;default:return}}m.SlimCoreElectronControlCapturer=M},467:function(m){m.exports=g}},f={};function __webpack_require__(g){var S=f[g];if(void 0!==S)return S.exports;var v=f[g]={exports:{}};return m[g].call(v.exports,v,v.exports,__webpack_require__),v.exports}return __webpack_require__(289)}()}))}}),be=__commonJS({"../node_modules/synctasks/dist/SyncTasks.js"(g){function fromThenable(g){var m=Defer();return g.then((function(g){m.resolve(g)}),(function(g){m.reject(g)})),m.promise().thenAsync((function(g){return g}))}function isThenable(g){return null!=g&&"function"==typeof g.then}function isCancelable(g){return null!=g&&"function"==typeof g.cancel}function run(m,f){if(!g.config.catchExceptions)return m();try{return m()}catch(g){return f(g)}}Object.defineProperty(g,"__esModule",{value:!0}),g.config={exceptionsToConsole:!0,catchExceptions:!0,traceEnabled:!1,exceptionHandler:void 0,unhandledErrorHandler:function(g){throw g}},g.fromThenable=fromThenable;var m,f,S,v=[],C="undefined"!=typeof setImmediate;function asyncCallback(g){v.push(g),1===v.length&&(C?setImmediate(resolveAsyncCallbacks):setTimeout(resolveAsyncCallbacks,0))}function resolveAsyncCallbacks(){var g=v;v=[];for(var m=0;m<g.length;m++)g[m]()}function all(g){if(0===g.length)return Resolved2([]);var f,S=Defer(),v=g.length,C=Array(g.length);S.onCancel((function(f){g.forEach((function(g){isCancelable(g)&&m.SyncTask.cancelOtherInternal(g,f)}))}));var checkFinish=function(){0==--v&&(void 0!==f?S.reject(f):S.resolve(C))};return g.forEach((function(g,m){isThenable(g)?g.then((function(g){C[m]=g,checkFinish()}),(function(g){void 0===f&&(f=void 0===g||g),checkFinish()})):(C[m]=g,checkFinish())})),S.promise()}function Defer(){return new m.SyncTask}function Resolved2(g){return(new m.SyncTask).resolve(g).promise()}function Rejected(g){return(new m.SyncTask).reject(g).promise()}function race(g){var f=Defer(),S=!1;return f.onCancel((function(f){g.forEach((function(g){isCancelable(g)&&m.SyncTask.cancelOtherInternal(g,f)}))})),g.forEach((function(g){isThenable(g)?g.then((function(g){S||(S=!0,f.resolve(g))}),(function(g){S||(S=!0,f.reject(g))})):S||(S=!0,f.resolve(g))})),f.promise()}function raceTimer(g,m){var f=Defer(),S=setTimeout((function(){f.resolve({timedOut:!0})}),m);return race([g.then((function(g){return clearTimeout(S),{timedOut:!1,result:g}})),f.promise()])}g.asyncCallback=asyncCallback,f=m||(m={}),S=function(){function SyncTask2(){this._completedSuccess=!1,this._completedFail=!1,this._traceEnabled=!1,this._cancelCallbacks=[],this._wasCanceled=!1,this._wasExplicitlyCanceled=!1,this._resolving=!1,this._storedCallbackSets=[],this._mustHandleError=!0}return SyncTask2.prototype._addCallbackSet=function(g,m){var f=this,S=new SyncTask2;return S.onCancel((function(m){g.wasCanceled=!0,g.cancelContext=m,f._cancelInternal(m)})),g.task=S,this._storedCallbackSets.push(g),m?this._mustHandleError=!1:S._mustHandleError=!1,this._resolving||(this._completedSuccess?this._resolveSuccesses():this._completedFail&&this._resolveFailures()),S.promise()},SyncTask2.prototype.onCancel=function(g){return this._completedSuccess||this._completedFail||(this._wasCanceled?g(this._cancelContext):this._cancelCallbacks.push(g)),this},SyncTask2.prototype.then=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m},!0)},SyncTask2.prototype.thenAsync=function(g,m){return this._addCallbackSet({successFunc:g,failFunc:m,asyncCallback:!0},!0)},SyncTask2.prototype.catch=function(g){return this._addCallbackSet({failFunc:g},!0)},SyncTask2.prototype.always=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!0)},SyncTask2.prototype.setTracingEnabled=function(g){return this._traceEnabled=g,this},SyncTask2.prototype.finally=function(g){return this._addCallbackSet({successFunc:g,failFunc:g},!1),this},SyncTask2.prototype.done=function(g){return this._addCallbackSet({successFunc:g},!1),this},SyncTask2.prototype.fail=function(g){return this._addCallbackSet({failFunc:g},!1),this},SyncTask2.prototype.resolve=function(g){return this._checkState(!0),this._completedSuccess=!0,this._storedResolution=g,this._cancelCallbacks=[],this._resolveSuccesses(),this},SyncTask2.prototype.reject=function(g){return this._checkState(!1),this._completedFail=!0,this._storedErrResolution=g,this._cancelCallbacks=[],this._resolveFailures(),SyncTask2._enforceErrorHandled(this),this},SyncTask2.prototype._checkState=function(m){if(this._completedSuccess||this._completedFail){this._completeStack&&console.error(this._completeStack.message,this._completeStack.stack);var f="Failed to "+(m?"resolve":"reject")+": the task is already "+(this._completedSuccess?"resolved":"rejected");throw new Error(f)}(g.config.traceEnabled||this._traceEnabled)&&(this._completeStack=new Error("resolve"))},SyncTask2._enforceErrorHandled=function(m){m._mustHandleError&&(SyncTask2._rejectedTasks.push(m),SyncTask2._enforceErrorHandledTimer||(SyncTask2._enforceErrorHandledTimer=setTimeout((function(){SyncTask2._enforceErrorHandledTimer=void 0;var m=SyncTask2._rejectedTasks;SyncTask2._rejectedTasks=[],m.forEach((function(m,f){m._mustHandleError&&g.config.unhandledErrorHandler(m._storedErrResolution)}))}),0)))},SyncTask2.prototype.cancel=function(g){if(this._wasExplicitlyCanceled)throw new Error("Already Canceled");this._wasExplicitlyCanceled=!0,this._cancelInternal(g)},SyncTask2.prototype._cancelInternal=function(g){var m=this;if(!this._wasCanceled){this._wasCanceled=!0,this._cancelContext=g;var f=this._cancelCallbacks;this._cancelCallbacks=[],f.length>0&&f.forEach((function(g){m._completedSuccess||m._completedFail||g(m._cancelContext)}))}},SyncTask2.cancelOtherInternal=function(g,m){var f=g;f._storedCallbackSets&&f._cancelInternal?f._cancelInternal(m):g.cancel(m)},SyncTask2.prototype.promise=function(){return this},SyncTask2.prototype._resolveSuccesses=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveSuccessCallback(m)})):g._resolveSuccessCallback(m)}))}this._resolving=!1},SyncTask2.prototype._resolveSuccessCallback=function(g){var m=this;g.successFunc?run((function(){var f=g.successFunc(m._storedResolution);isCancelable(f)&&(g.wasCanceled?SyncTask2.cancelOtherInternal(f,g.cancelContext):g.task.onCancel((function(g){return SyncTask2.cancelOtherInternal(f,g)}))),isThenable(f)?f.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(f)}),(function(f){m._handleException(f,"SyncTask caught exception in success block: "+f.toString()),g.task.reject(f)})):g.task.resolve(this._storedResolution)},SyncTask2.prototype._resolveFailures=function(){var g=this;for(this._resolving=!0;this._storedCallbackSets.length;){var m=this._storedCallbackSets;this._storedCallbackSets=[],m.forEach((function(m){m.asyncCallback?asyncCallback((function(){return g._resolveFailureCallback(m)})):g._resolveFailureCallback(m)}))}this._resolving=!1},SyncTask2.prototype._resolveFailureCallback=function(g){var m=this;g.failFunc?run((function(){var f=g.failFunc(m._storedErrResolution);isCancelable(f)&&(g.wasCanceled?SyncTask2.cancelOtherInternal(f,g.cancelContext):g.task.onCancel((function(g){return SyncTask2.cancelOtherInternal(f,g)}))),isThenable(f)?f.then((function(m){g.task.resolve(m)}),(function(m){g.task.reject(m)})):g.task.resolve(f)}),(function(f){m._handleException(f,"SyncTask caught exception in failure block: "+f.toString()),g.task.reject(f)})):g.task.reject(this._storedErrResolution)},SyncTask2.prototype._handleException=function(m,f){g.config.exceptionsToConsole&&console.error(f),g.config.exceptionHandler&&g.config.exceptionHandler(m)},SyncTask2.prototype.toEs6Promise=function(){var g=this;return new Promise((function(m,f){return g.then(m,f)}))},SyncTask2._rejectedTasks=[],SyncTask2}(),f.SyncTask=S,g.all=all,g.Defer=Defer,g.Resolved=Resolved2,g.Rejected=Rejected,g.race=race,g.raceTimer=raceTimer}}),Ae={};__export(Ae,{HttpRequestDispatcherImplementation:()=>ke,generateCauseId:()=>generateCauseId,getOvb:()=>getOvb,getVersion:()=>getTsCallingVersion,pluginlessStackFactory:()=>sI}),v.exports=__toCommonJS(Ae);var Pe=__toESM(ee()),Re=8;function generateCauseId(){const g="abcdef0123456789",m=g.length;let f="";for(let S=0;S<Re;S++)f+=g.charAt(Math.floor(Math.random()*m));return f}function validateCauseId(g){return new RegExp("^[a-f0-9]{8}$").test(g)&&g.length===Re}var we=P,Me=R,De=class _TsCallingLogger{constructor(g,m,f=""){this.ulLogComponent=g,this.ulSafeComponent=m,this._getPrefix=(0,Me.isFunction)(f)?f:()=>f,this.logComponent=we.LogFactory.instance().component(this.ulLogComponent),we.LogFactory.instance().declareComponentSafe(this.ulLogComponent,m)}createChild(g){const m=(0,Me.isFunction)(g)?g:()=>g;return new _TsCallingLogger(this.ulLogComponent,this.ulSafeComponent,(()=>this._getPrefix()?`${this._getPrefix()}/${m()}`:m()))}log(...g){this._apply((g=>this.logComponent.debug2(null,g)),g)}debug(...g){this._apply((g=>this.logComponent.debug4(null,g)),g)}info(...g){this._apply((g=>this.logComponent.debug1(null,g)),g)}warn(...g){this._apply((g=>this.logComponent.warn(null,g)),g)}error(...g){this._apply((g=>this.logComponent.error(null,g)),g)}_apply(g,m=[]){this._addPrefix(m);g(m.map((g=>g instanceof DOMException?g.toString():g)).map((g=>(0,Me.isObject)(g)?JSON.stringify(g):g)).join(", "))}_addPrefix(g){if(g&&g[0]){const m=`${this._getPrefix()} ${g[0]}`;g[0]=m}}},Oe=P;function scrubMriOrOmit(g){return"string"==typeof g?Oe.pii.Mri(g):Oe.pii.Omit(g)}function scrubMriOrOmitList(g){return g.forEach(scrubMriOrOmit)}function mriOrId(g){return g&&Oe.pii.Mri(g)}function getLoggableThreadId(g){const m=_scrubThreadId(g);return m&&m.substr(0,8)}function _scrubThreadId(g){const m="99:";return g&&g.substr(0,3)===m?Oe.pii.Omit(g):g}var Ne=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function getPIISafeObject(g){try{return JSON.parse(JSON.stringify(g,Ne,4))}catch(g){return{error:"failed to parse object"}}}var processStackTrace=g=>{try{return g.split("\n")[0]}catch(g){return"invalid stack"}};function getPrintableObject(g,m=!1){if(null==g)return"void";if(g instanceof Error)return g.toString();if(g instanceof String||g instanceof Number||g instanceof Boolean)return g.toString();try{return g.stack&&(g.stack=processStackTrace(g.stack)),(m?JSON.stringify(g):JSON.stringify(g,Ne,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(m){return`failed to get error information:${g&&"function"==typeof g.toString&&g.toString()} ${g?.response&&JSON.stringify(g.response)}`}}function safeJsonStringify(g){try{return JSON.stringify(g,null,2)}catch(m){return`failed to stringify obj ${g}`}}function truncate(g,m){try{return g.substring(0,length)}catch(m){return g}}function hasValue(g){return g||!1===g||""===g||0===g}function getPIISafeCallInitOptions(g){const m={mediaPeerType:g.mediaPeerType,threadId:getLoggableThreadId(g.threadId)};return hasValue(g.messageId)&&(m.messageId=g.messageId),hasValue(g.enableGroupCallMeetupGeneration)&&(m.enableGroupCallMeetupGeneration=g.enableGroupCallMeetupGeneration),hasValue(g.endpointMetadata)&&(m.endpointMetadata=g.endpointMetadata),hasValue(g.onBehalfOf)&&(m.onBehalfOf=scrubMriOrOmit(g.onBehalfOf)),hasValue(g.onBehalfOfUserDisplayName)&&(m.onBehalfOfUserDisplayName=g.onBehalfOfUserDisplayName),hasValue(g.emergencyContent)&&(m.emergencyContent=g.emergencyContent),hasValue(g.isEmergency)&&(m.isEmergency=g.isEmergency),hasValue(g.broadcastContext)&&(m.broadcastContext=g.broadcastContext),g.meetingInfo&&(m.meetingInfo={tenantId:g.meetingInfo.tenantId,organizerId:scrubMriOrOmit(g.meetingInfo.organizerId)},hasValue(g.meetingInfo.meetingType)&&(m.meetingInfo.meetingType=g.meetingInfo.meetingType),hasValue(g.meetingInfo.replyChainMessageId)&&(m.meetingInfo.replyChainMessageId=g.meetingInfo.replyChainMessageId)),g.transferContext&&(m.transferContext={transferorMri:scrubMriOrOmit(g.transferContext.transferorMri),targetMri:scrubMriOrOmit(g.transferContext.targetMri),context:g.transferContext.context},hasValue(g.transferContext.transferType)&&(m.transferContext.transferType=g.transferContext.transferType)),m}function getRandomizedTimeout(g){const m=Math.floor(11*Math.random())+10;return Math.floor(g*(1-m/100))}function isStringBase64(g){if(!g)return!1;try{return atob(g),!0}catch(g){return!1}}function isPromiseLike(g){return!!g&&"function"==typeof g.then}function stringifyObject(g){if(!g)return`${g}`;if(g instanceof Map)return mapToString(g);const m=g.toString();return m.endsWith("[object Object]")?JSON.stringify(g):m}function mapToString(g){const m={};return g.forEach(((g,f)=>{m[f.toString()]=g})),JSON.stringify(m)}function stringToBuffer(g){const m=new ArrayBuffer(g.length),f=new Uint8Array(m);for(let m=0;m<g.length;m++)f[m]=g.charCodeAt(m);return f}var ke=class{constructor(g){g&&"function"==typeof g.createChild?this.logger=g.createChild("RequestDispatcher"):this.logger=new De("JS.TsCalling.RequestDispatcher",!1)}getRequestOptions(g,m,f,S,v){return{headers:m||{},timeout:S,payload:f||null,responseType:v}}getAsync(g,m){return this.sendRequest(g,m,"GET")}postAsync(g,m){return this.sendRequest(g,m,"POST")}putAsync(g,m){return this.sendRequest(g,m,"PUT")}removeAsync(g,m){return this.sendRequest(g,m,"DELETE")}async sendRequest(g,m={headers:{}},f){const S=this.logger.createChild(`[${m.causeId||generateCauseId()}][Request]`);S.info(`sending, ${f}-${g}`);const v=Date.now();let C;m.headers=m.headers||{},m.headers["content-type"]||(m.headers["content-type"]=m.contentType||"application/json");try{const _=Pe.default.request({url:g,method:f,headers:m.headers||{},timeout:"number"==typeof m.timeout?m.timeout:45e3,data:m.payload||"",responseType:m.responseType||m.dataType||"json",withCredentials:valueOrDefault(m.withCredentials,!1),cancelToken:new Pe.default.CancelToken((g=>{C=g}))});isPromiseLike(m.timeout)&&m.timeout.then((()=>{S.info("Aborting pending request"),C()}),(()=>{S.info("Timeout promise rejected, ignoring")}));const E=await _;return S.info(`success, status=${E.status}`),{response:E.data,request:E.request,duration:Date.now()-v}}catch(g){if(S.info("failed"),Pe.default.isCancel(g))throw S.info(`response=${safeJsonStringify(g.response)}`),{aborted:!0};throw g.response?S.info(`response=${safeJsonStringify(g.response)}`):g.request?S.info(`no response, request=${safeJsonStringify(g.request)}`):S.info(`request not made, error=${safeJsonStringify(g)}`),g||new Error("Request failed")}}};function valueOrDefault(g,m){return void 0!==g?g:m}var Le=R,Fe=R,xe=class{constructor(g){this.eventLogger=g,this.subscriptions=[]}subscribe(g){return new Ue(this.subscriptions,g)}dispose(g){this.subscriptions=[]}raiseEvents(g){this.subscriptions.slice().forEach((m=>{try{void 0!==m.eventHandler&&g(m.eventHandler)}catch(g){this.eventLogger?.warn?.("Event handler exception caught!",stringifyObject(g))}}))}},Ue=class{constructor(g,m){this.subscriptions=g,this.eventHandler=m,this.subscriptions.push(this)}dispose(){(0,Fe.remove)(this.subscriptions,(g=>g===this)),this.eventHandler=void 0}},Ve=class extends xe{constructor(g){super(g)}changed(g,m){return this.subscribe({changed:{skipEventConfig:m,handler:g},on:void 0})}on(g,m){return this.subscribe({changed:void 0,on:{name:String(g),handler:this._toEventCallback(m)}})}once(g,m,f){let S;const onceSubscription=(...g)=>{S.dispose(f),this._toEventCallback(m)(...g)};return S=this.on(g,this._fromEventCallback(onceSubscription)),S}raiseChanged(g){this.raiseEvents((m=>{if(!m.changed)return;const{skipEventConfig:f,handler:S}=m.changed;!this.getShouldSkipChangedEvent(g,f)&&S()}))}event(g){return{raise:this._fromEventCallback(((...m)=>this._raiseEventImpl(String(g),...m)))}}_raiseEventImpl(g,...m){this.raiseEvents((f=>f.on&&f.on.name===g&&f.on.handler(...m)))}_toEventCallback(g){return g}_fromEventCallback(g){return g}getShouldSkipChangedEvent(g,m){return g?.skipDominantSpeakerUpdatesOnCall?!!m?.skipDominantSpeakerUpdatesOnCall:!!g?.skipParticipantsUpdatesOnCall&&!!m?.skipParticipantsUpdatesOnCall}},Be=Ve,He="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01",$e="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time",Ge="http://www.webrtc.org/experiments/rtp-hdrext/video-layers-allocation00",je={MEDIA_STATE:{send:"sendonly",receive:"recvonly",sendReceive:"sendrecv",inactive:"inactive"},MEDIA_DIRECTION:{SEND:"send",RECV:"recv"},MEDIA_DEVICE_KIND:{audioInput:"audioinput",audioOutput:"audiooutput",videoInput:"videoinput",compositeAudio:"compositeAudio",virtualDevice:"virtualDevice"},MEDIA_DEVICE:{camera:"camera",microphone:"microphone",speaker:"speaker",compositeAudio:"compositeAudio",defaultId:"default",communicationsId:"communications",defaultDeviceLabel:"Default",audioIngestDevice:"audioIngestDevice",virtualDevice:"virtualDevice"},MEDIA_ERROR:{constraintNotSatisfiedError:"ConstraintNotSatisfiedError",iceConnectionError:"iceConnectionError",srtpError:"srtpError",permissionDeniedError:"permissionDeniedError",internalError:"internalError",sourceUnavailableError:"SourceUnavailableError",devicesNotFoundError:"DevicesNotFoundError",noDeviceSelected:"noDeviceSelected",noNetworkError:"noNetworkError",incompatibleOffer:"IncompatibleOffer",mediaStreamRequestError:"MediaStreamRequestError",extensionNotFoundError:"ExtensionNotFoundError",sharingCancelledError:"SharingCancelledError",permissionDeniedBySystemError:"PermissionsDeniedBySystem",chromeRuntimeNotDefinedError:"ChromeRuntimeNotDefinedError",mediaStreamRequestTimedOut:"MediaStreamRequestTimedout",unsupportedStream:"UnsupportedStream",webGlRendererError:"WebGlRendererError",audioPlaybackError:"audioPlaybackError",unexpectedClose:"unexpectedClose",incompatibleOriginator:"incompatibleOriginator"},HISTOGRAM_BATCH:{seconds1to3:2,seconds3to5:4,seconds5to8:7,seconds8to15:14,seconds15to60:59,seconds60toMax:1e6},RENEGOTIATION_ERROR:{local:"local",glare:"glare",signaling:"signaling",media:"media",escalation:"escalation"},MSI:{unsubscribe:-1,subscribeAny:-2},MEDIA_LABEL:{audio:"main-audio",video:"main-video",sharing:"applicationsharing-video",data:"data"},MEDIA_TYPE:{audio:"audio",video:"video",sharing:"sharing",data:"x-data",dataChannel:"application"},MODALITY:{audio:"audio",video:"video",sharing:"sharing",data:"data"},TRACK_KIND:{audio:"audio",video:"video"},ICE_TRANSPORT_POLICY:{all:"all",relay:"relay"},RENDERER_TYPE:{video:"video",sharing:"sharing"},CONTENT_TYPE:{SDP:"application/sdp"},ALLOWED_CONTENT_TYPES:{SDP_ONLY:["application/sdp"],SDP_NGC:["application/sdp","application/sdp-ngc-0.5","application/sdp-ngc-1.0"]},STREAMING_STATE:{created:"created",started:"started",active:"active",inactive:"inactive",stopped:"stopped",removed:"removed",failed:"failed"},TIME_INTERVAL:{SEC_1:1},DISPLAY_SOURCE_ID:"display",EMPTY_DEVICE_ID:"0",SYSTEM_AUDIO_SOURCE_ID:"system",MULTIPLE_RECV_STREAMS:"multipleVideoStreams",PROFILES:{udpTlsRtpSavpf:"UDP/TLS/RTP/SAVPF",rtpSavpf:"RTP/SAVPF",rtpSavp:"RTP/SAVP",udpDtlsSctp:"UDP/DTLS/SCTP"},REPORTING_PROFILE:{RT_PROFILE:"REAL_TIME",BE_PROFILE:"BEST_EFFORT",NRT_PROFILE:"NEAR_REAL_TIME"},PAYLOAD_TYPE:{DATA_CHANNEL:"webrtc-datachannel",X_DATA:"127 126",MSRTC_RED:97,MSRTC_CNFB:120},VIDEO_CAPABILITIES:{MAX_FS_PATH:"max-fs",MAX_MBPS_PATH:"max-mbps",MAX_FPS_PATH:"max-fps",MAX_BR_PATH:"max-br",SSRC_PATH:"ssrc",RID_PATH:"rid",KEYFRAME_PATH:"KeyFrame",MAX_WIDTH:"max-width",MAX_HEIGHT:"max-height",VLA_DEBUG:"vla-debug"},TRANSPORT_CC:{EXT_URI:He,MSSDP_ENCODED_URI:He.replace(/\//g,"\\"),ATTRIBUTE:"transport-cc"},ABS_SEND_TIME:{EXT_URI:$e,MSSDP_ENCODED_URI:$e.replace(/\//g,"\\")},VLA:{EXT_URI:Ge,EXT_URI_NON_ADV:Ge+"-non-advertised",DEFAULT_VALUE:10},AUDIO_DECODER:{MUCHv2:{CODEC:{NAME:"x-much2",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:113},SatinFB:{CODEC:{NAME:"SATINFB",RATE:48e3,ENCODING:2},SUBSTITUTION:{NAME:"L16",RATE:48e3,ENCODING:2},PT:109}},MACROBLOCK_SIZE:16,MEDIA_EVENT_FIELDS:{Extensions:["IceConnectionState","IceConnectionStatePrevious","SignalingState","SignalingStatePrevious"],metrics:["ReconnectInProgress","IceConnectedStateTime","ErrorType","ErrorDetail","InitialNegotiationType","InitialNegotiationCompleted"]},RES_TABLE:{SEND:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:416,h:234,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}],RECV:[{w:320,h:180,minBr:2e4,maxBr:175e3},{w:426,h:240,minBr:125e3,maxBr:5e5},{w:640,h:360,minBr:4e5,maxBr:575e3},{w:960,h:540,minBr:5e5,maxBr:1125e3},{w:1280,h:720,minBr:1e6,maxBr:25e5},{w:1920,h:1080,minBr:175e4,maxBr:1e8}]}};function forOwn(g,m){for(const f in g)g.hasOwnProperty(f)&&m(g[f],f)}function forOwnRec(g,m){for(const f in g)g.hasOwnProperty(f)&&("object"==typeof g[f]?forOwnRec(g[f],m):m(g[f],f,g))}function isDefined(g){return null!=g&&!Number.isNaN(g)}function getMinDefined(g,m){return isDefined(m)?isDefined(g)?Math.min(g,m):m:g}function average(g){let m=0;return g.forEach((g=>m+=g)),m/=g.length,m}function remove2(g,m){let f=!1;for(let S=g.length;S-- >0;)m(g[S],S,g)&&(g.splice(S,1),f=!0);return f}function compareArraysBy(g,m,f){const S=[];return g.forEach((g=>{m.some((m=>f(g,m)))||S.push(g)})),0===S.length&&g.length===m.length}function values(g){const m=[];for(const f in g)g.hasOwnProperty(f)&&m.push(g[f]);return m}function assign(g,m){for(const f in m)m.hasOwnProperty(f)&&(g[f]=m[f])}function isEmpty(g){return!Object.keys(g).length}function keys(g){return Object.keys(g)}function shallowClone(g){const m={};return forOwn(g,((g,f)=>{m[f]=g})),m}function deepClone(g){let m;if(!g||"object"!=typeof g)return g;if(g instanceof Date)return m=new Date,m.setTime(g.getTime()),m;if(g instanceof Array){m=[];for(let f=0,S=g.length;f<S;f++)m[f]=deepClone(g[f]);return m}if(g instanceof Object)return m={},forOwn(g,(function(g,f){m[f]=deepClone(g)})),m;throw new Error("Unable to copy: "+stringifyObject(g))}function removeUndefinedFields(g){return Object.keys(g).forEach((m=>{void 0===g[m]&&delete g[m]})),g}function uniqueId(){const segment=()=>Math.floor(65536*(1+Math.random())).toString(16).substring(1);return segment()+segment()+segment()+"4"+segment().substring(1)+"b"+segment().substring(1)+segment()+segment()+segment()}function deepEqual(g,m){let f;const S=typeof g;if(g===m)return!0;if(S!==typeof m||"object"!==S&&"function"!==S)return!1;if(null===g||null===m)return g===m;if(g instanceof Date&&m instanceof Date)return+g==+m;if(g instanceof Map&&m instanceof Map)return compareMaps(g,m);for(f in g)if(!(f in m)||!deepEqual(g[f],m[f]))return!1;for(f in m)if(!(f in g)||!deepEqual(g[f],m[f]))return!1;return!0}function compareMaps(g,m){let f;if(g.size!==m.size)return!1;let S=!0;return g.forEach(((g,v)=>{f=m.get(v),(f!==g||void 0===f&&!m.has(v))&&(S=!1)})),S}function getMaxSubstring(g,m){return m.reduce(((m,f)=>{const S=g.includes(f)?f.length:0;return m.length<S?f:m}),"")}function throwIfNotSupported(g,m){if(-1===m.indexOf(g))throw{detail:`${g} mediaContent.contentType is not supported`,type:je.MEDIA_ERROR.incompatibleOffer}}function throwIfFeatureNotSupported(g,m){g.forEach((g=>{if(""!==g&&-1!==m.findIndex((m=>m===g)))throw{detail:`Required feature '${g}' is not acceptable.`,type:je.MEDIA_ERROR.incompatibleOffer}}))}function getClosestValue(g,m,f,S=0){for(let v=1;v<g.length;v++)if(g[v-1]+S<m&&m<=g[v]+S)return f?g[v]:g[v-1];return g[0]}function isInRange(g,m,f){return m<=g&&g<=f}function getFrom(g,...m){for(const f of m)if(f.hasOwnProperty(g))return f[g]}function subtractFrom(g,m){return g.filter((g=>!m.some((m=>m===g))))}function getLongestCommonContiguousSubstring(g,m){if(g===m)return g;let f=0,S=0,v="";for(let C=0;C<g.length&&!(v.length>g.length-C);C++){let _=C;S-f>v.length&&(v=g.substring(f,S),C=S-1),f=C,S=C;for(let E=0;E<m.length;E++)_<g.length&&m[E]===g[_++]?S=_:(_=C,S-f>v.length&&(v=g.substring(f,S),C=S-1),f=C,S=C)}return v}function levenshteinDistance(g,m){const f=new Array(g.length+1);for(let S=0;S<g.length+1;S++){f[S]=new Array(m.length+1);for(let g=0;g<m.length+1;g++)f[S][g]=0}for(let m=1;m<g.length+1;m++)f[m][0]=m;for(let g=1;g<m.length+1;g++)f[0][g]=g;for(let S=1;S<g.length+1;S++)for(let v=1;v<m.length+1;v++){let C=1;g[S-1]===m[v-1]&&(C=0),f[S][v]=Math.min(f[S-1][v]+1,f[S][v-1]+1,f[S-1][v-1]+C)}return f[g.length][m.length]}function getAverage(g){return 0===g.length?0:g.reduce(((g,m)=>g+m),0)/g.length}function round(g,m=3){return g&&parseFloat(g.toFixed(m))}function scrubDeviceLabelPii(g,m){if(!g)return"";if(g.length<3)return g;const f=[],S=g.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);S&&f.push(S[1]);try{if(m?.length){const S=new RegExp(`(${m.join("|")})`,"gi");let v=S.exec(g);for(;v;)f.push(v[1]),v=S.exec(g)}else f.push("no_keywords")}catch(g){f.push(`Error: ${stringifyObject(g)}`)}return 0===f.length?"unknown":f.join(" ")}function limitArraySize(g,m,f=0){return g&&void 0!==m&&m>-1&&g.length>m&&g.splice(f,g.length-m),g}function arrayLimitedPush(g,m,f,S=0){limitArraySize(g,0===f?0:f-1,S),0!==f&&g.push(m)}function addGetterFields(g,m){const f={};for(const g in m)f[g]={get:m[g],configurable:!1,enumerable:!0};Object.defineProperties(g,f)}function getLast(g){return g?.length>0?g[g.length-1]:void 0}var We=window?.performance?.now&&window?.performance?.timeOrigin?()=>window.performance.now():()=>Date.now();function rebaseTime(g,m,f){if(g?.length>0){const S=[];for(const v of g){const g=deepClone(v);g[m]=g[m]&&g[m]-f,S.push(g)}return S}}function rebaseHistogramTimestamps(g,m){if(!g)return;const f={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]};for(const[S,v]of Object.entries(g))for(const g of v)f[S].push(g-m);return f}function sampleseries(g,m,f=!1){const S=g?.map(m).filter((g=>void 0!==g&&!isNaN(g)&&null!==g&&""!==g&&(!1===f||0!==g)));return S?.length?S.join(","):void 0}function sampleseriesArr(g,m,f){const S=g?.map(m).filter((g=>void 0!==g&&!isNaN(g)&&null!==g&&""!==g)).splice(-f);return S?.length?S:void 0}function clearObj(g,m){const f=[];for(const S of Object.keys(g))m.has(S)||f.push(S);for(const m of f)delete g[m]}function clearMap(g,m){const f=[];for(const S of g.keys())m.has(S)||f.push(S);for(const m of f)g.delete(m)}function convertContextProperty(g){return"object"==typeof g?stringifyObject(g):g}function getPercentilesProviderFromSampleFreqs(g){const m=Object.keys(g).map(Number).sort(((g,m)=>g-m)),f=m.reduce(((m,f)=>m+(g[f]??0)),0);return{getPercentile:S=>{const v=f*S;let C=0;for(const f of m)if(C+=g[f],C>=v)return f}}}var qe=R,ze={numVideoChannelsGvc:({current:g,constraints:m})=>getMaxIncomingStreams(g,m),specCompliantSimulcast:({current:g,constraints:m})=>getMaxSimulcastLayers(g,m),multiviewResolutionLimits:({current:g,constraints:m,logger:f})=>getMaxParticipantResolutions(g,m,f),enableVla:({current:g,settings:m,constraints:f,settingsSuffix:S})=>getVlaEnabledStatus(g,m,f,S),allowRemoteVla:({current:g,settings:m,constraints:f,settingsSuffix:S})=>getVlaEnabledStatus(g,m,f,S),enableNonAdvVla:({current:g,settings:m,constraints:f,settingsSuffix:S})=>getVlaEnabledStatus(g,m,f,S),outgoingVideoLimit:({current:g,constraints:m})=>getOutgoingVideoLimit(g,m)},convertCallConstraintsToSettings=(g,m,f)=>({...buildSettings(g,m,f),...buildSettings(g,m,f,"1on1"),...buildSettings(g,m,f,"Multiparty")}),buildSettings=(g,m,f,S)=>{const v={};for(const C of Object.keys(ze)){const _=`${C}${S??""}`;S&&!isDefined(m[_])||(v[_]=ze[C]({current:m[_],settings:m,constraints:f,settingsSuffix:S,logger:g}))}return v},getMaxIncomingStreams=(g,m)=>getMinDefined(g,m.maxIncomingStreams),getMaxParticipantResolutions=(g,m,f)=>{const S=m.maxParticipantResolutions;if(!S)return g;const v={more:g.more};if(Number.isInteger(S))Object.keys(g).forEach((m=>{v[m]=getMinDefined(S,g[m])}));else{const m=Object.keys(S);if(!m.length)return f.warn(`ignoring invalid value provided for maxParticipantResolutions: ${S}}`),g;m.forEach((m=>{v[m]=getMinDefined(S[m],g[m]||g.more)}))}return v},getMaxSimulcastLayers=(g,m)=>void 0!==m.maxSimulcastLayers||g.allowOverride?{...g,video:getConstrainedSimulcastConfig(g.video,m),sharing:getConstrainedSimulcastConfig(g.sharing,m)}:g,getConstrainedSimulcastConfig=(g,m)=>{const f=g?.layerScaleFactors?.filter((g=>g<=m.maxSimulcastLayers));return f?.length>1?{...g,layerScaleFactors:f}:{...g,enableLocally:!1,allowEnableRemotely:!1}},getOutgoingVideoLimit=(g,m)=>{const{outgoingVideoLimit:f,maxOutgoingResolution:S}=m,v=(0,qe.isNumber)(f),C=getMinDefined(v?f:f?.maxResolution,S),_=getMinDefined(g?.maxResolution,C),E=getMinDefined(g?.maxBitrate,v?void 0:f?.maxBitrate),T=getMinDefined(g?.maxFramerate,v?void 0:f?.maxFramerate);return{...g,maxResolution:_,maxBitrate:E,maxFramerate:T}},getVlaEnabledStatus=(g,m,f,S)=>!((m.specCompliantSimulcast.constraintsDisableVla||m[`specCompliantSimulcast${S}`]?.constraintsDisableVla)&&f.maxSimulcastLayers<2)&&g,Ke=class extends Be{constructor(g){super(g),this.logger=g,this._constraints={},this._callConstraintsTelemetry=[]}get constraints(){return this._constraints}get callConstraintsTelemetry(){return this._callConstraintsTelemetry}addCallConstraintsTelemetryEvent(g,m){const f={timestamp:(new Date).getTime(),type:m,value:g};this._callConstraintsTelemetry.push(f)}setConstraints(g){this.logger.debug("Setting new platform call constraints",JSON.stringify(g)),this._constraints=g,this.addCallConstraintsTelemetryEvent(g,"requested"),this.raiseChanged()}getSettings(g){return convertCallConstraintsToSettings(this.logger,g,this._constraints)}},Je=class _InternalLogger{constructor(g){this._callingLogger=g,this._maybeLog=(g,...m)=>{try{this._callingLogger[g](...m)}catch(g){this._callingLogger.info("[failed to log]",getPrintableObject(g))}}}getPrefix(g,m){let f="";return m&&(f+=`[${m}]`),g&&(f+=`[${g}]`),f}createChild(g,m){return new _InternalLogger(this._callingLogger.createChild(g,m))}createFnLogger(g,m,...f){return new _InternalLogger(this._callingLogger.createChild(this.getPrefix(g,m)+f.join(""),!1))}logSuccess(g){this._maybeLog("info",`success=${g}}`)}logFailure(g){const m=getPrintableObject(g);this._maybeLog("info",`failed=${m}}`)}log(...g){this._maybeLog("log",...g)}debug(...g){this._maybeLog("debug",...g)}info(...g){this._maybeLog("info",...g)}warn(...g){this._maybeLog("warn",...g)}error(...g){this._maybeLog("error",...g)}};function getTsCallingVersion(){return"2024.04.01.32"}function getOvb(){return"143e385e3f140e99c91efc689e9a24fd7f8cba51"}var Ye=R,Qe="0.0";function getBrowserVersion(g,m){let f=[];if(m.some((m=>(f=g.match(m),!!f))),!f||f.length<2)return Qe;const S=f[1]?.replace(/_/g,".");return S||Qe}function getFormFactor(g){const m="136";if(getOsSkuInfo()===m)return"Hololens";if(/hostAudio-Processing/i.test(g))return"RoomAudioProcessing";return/iPhone|iPad|iPod|Android|Mobi/i.test(g)?"Mobile":"Desktop"}function getOsSkuInfo(){const g="os-sku",m=window.external;return m?.getHostEnvironmentValue?JSON.parse(m.getHostEnvironmentValue(g))[g]:"-1"}function getBrowserInfo(){const g="((\\d+\\.?){2,4})",m={name:"Unknown",engine:"Unknown",version:Qe,formFactor:"Unknown"},f=[{name:"WebView2",engine:"Chromium",key:"maglev",masks:[new RegExp(`maglev/${g}`)]},{name:"Edge",engine:"Edge",key:"Edge",masks:[new RegExp(`Edge/${g}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"EdgA",masks:[new RegExp(`Chrome/${g}`)]},{name:"EdgeAnaheim",engine:"Chromium",key:"Edg",masks:[new RegExp(`Edg/${g}`)]},{name:"Chromium",engine:"Chromium",key:"Chromium",masks:[new RegExp(`Chromium/${g}`)]},{name:"Opera",engine:"Chromium",key:"OPR",masks:[new RegExp(`Chrome/${g}`)]},{name:"YandexBrowser",engine:"Chromium",key:"YaBrowser",masks:[new RegExp(`Chrome/${g}`)]},{name:"Electron",engine:"Chromium",key:"Electron",masks:[new RegExp(`Electron/${g}`)]},{name:"CiscoOS",engine:"Chromium",key:"Cisco",masks:[new RegExp(`Chrome/${g}`)]},{name:"ZoomRoom",engine:"Chromium",key:"ZoomRoom",masks:[new RegExp(`Chrome/${g}`)]},{name:"SamsungTV",engine:"Chromium",key:"TeamsSamsungTVBrowser",masks:[new RegExp(`Chrome/${g}`)]},{name:"Chrome",engine:"Chromium",key:"Chrome",masks:[new RegExp(`Chrome/${g}`)]},{name:"Firefox",engine:"Firefox",key:"Firefox",masks:[new RegExp(`Firefox/${g}`)]},{name:"Safari",engine:"Safari",key:"Safari",masks:[new RegExp(`Version/${g}.*?Safari/`)]},{name:"AppleWebView",engine:"Safari",key:"Mac OS X",masks:[new RegExp("(\\d+_\\d+(_\\d+)?).*Mac OS X"),new RegExp("(\\d+_\\d+(_\\d+)?).*")]},{name:"MSIE",engine:"MSIE",key:"Trident",masks:[new RegExp(`MSIE ${g}`),new RegExp(`rv:${g}`)]}],S=navigator.userAgent;let v=m;return f.some((g=>{if(-1!==S.indexOf(g.key)){const m=window.navigator.mediaDevices?.isRemote;return v={name:g.name,engine:m?"ChromiumAVD":g.engine,version:getBrowserVersion(S,g.masks),formFactor:getFormFactor(S)},!0}return!1})),v}function isVdiBrowser(g){return"Electron"===g.name||"WebView2"===g.name}var Xe={src:["//amp.azure.net/libs/amp/2.3.8.4/azuremediaplayer.min.js","https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.js"],css:["https://amsglob0cdnstream13.azureedge.net/1-0-3013-17/bundles/player-skin.min.css","https://statics.teams.cdn.office.net/evergreen-assets/broadcast/video-player.css?v=2"],styles:["azuremediaplayer","amp-stream-skin","amp-big-play-centered"],lang:"en-us",disableFullscreenButton:!1,playerType:0},Ze={src:["https://azuremdncdnhlsendpoint.azureedge.net/hlsjsv115/hls.js","https://vzmdncdnendpoint.azureedge.net/hlsjsv115/hls.js"],css:[],styles:[],lang:"en-us",disableFullscreenButton:!1,muteVideo:!1,playerType:1,useHydraPlayerWebSdk:!1,hydraPlayerWebSdkUrls:["https://afd-middlelane-hlsendpoint-hag2hkd8gjdudres.z01.azurefd.net/hlsrt-3-23195-1/hydra_player_runtime_bundle.js","https://vzmdncdnendpoint.azureedge.net/hlsrt-3-23195-1/hydra_player_runtime_bundle.js"]},et={src:[],css:[],styles:[],playerType:2,useHydraPlayerWebSdk:!1,hydraPlayerWebSdkUrls:[]},tt=class{constructor(g,m,f,S){this.configIds=f,this.logger=S,this.defaultSettings=getSettings(),this.logger.info(`client settings: ${JSON.stringify(m)}`),this.defaultSettings.debug=m?.debug||!1,this.defaultSettings.playerType=m?.playerConfig?.playerType||this.defaultSettings.playerType,m?.playerConfig&&(0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration=m.playerConfig:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration=m.playerConfig:2===this.defaultSettings.playerType&&(this.defaultSettings.umsSettings.liveStreamPlayerConfiguration=m.playerConfig)),(0,Ye.mergeWith)(this.defaultSettings,g,arrayMergeCustomizer),this.logger.info(`applied settings: ${JSON.stringify(this.defaultSettings)}`)}get playerConfig(){return 0===this.defaultSettings.playerType?this.defaultSettings.ampSettings.liveStreamPlayerConfiguration:1===this.defaultSettings.playerType?this.defaultSettings.hlsSettings.liveStreamPlayerConfiguration:2===this.defaultSettings.playerType?this.defaultSettings.umsSettings.liveStreamPlayerConfiguration:null}get config(){return this.defaultSettings}},it=class{constructor(){this.defaultSettings={allowSdnPlugins:!0,capturePlayerLogs:!0,playerType:0,loadType:1,maxPlayerDiagnosticsCount:50,maxPlayerMemoryTraceLogCount:1e3,maxPlayerPlaybackEventCount:50,maxRetryCount:10,playerTelemetryTickMs:1e3,removeEmptyDefaultTextTrack:!0,sendSnapshotTelemetry:!1,sendSnapshotTelemetryEveryMs:1e4,sendInitialTelemetryAfterMs:6e4,sendTelemetry:!0,textTrackKind:"subtitles",maxRetryCountForLoadingResources:5,maxVideoTrackHistoryLogCount:100,ampSettings:{errorCodesEligibleForStreamingUrlSwitch:[4194309,2097564,2097556,2097752,2097753,5242884],liveStreamPlayerConfiguration:Xe,sourceResetTimeoutInMs:1e3,streamingUrlSwitchMaxCount:2,resetStreamingUrlSwitchCount:!1,useBrowserWindowSizeForBitRate:!0,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,collectUserInitiatedSeekEventsTelemetry:!0,maxUserInitiatedSeekEventCount:100},hlsSettings:{liveStreamPlayerConfiguration:Ze,timeoutForSwitchingUrl:9e3,estimateAbsoluteTime:!0,maxAbsoluteTimeOffsetEstimationResultsLogCount:100,playlistInitialSequenceNumber:1,skipNonce:!1,maxStreamConnectionResultsLogCount:100,logHlsJsEvents:!1,logHlsJsEventsEveryMs:5e3,maxPlayerExperimentalEvents:100},umsSettings:{liveStreamPlayerConfiguration:et,playerScriptUrl:"https://wasm-acs-preview-d7e9b5a5hhbmhmbd.z01.azurefd.net/UMSTranscoder2.wasm",allowPlayerTrackSwitch:!1,allowServerTrackSwitch:!0,timeoutForSwitchingUrl:9e3,requireStrictServerTrackSwitch:!1,maxStreamHttpFetchCount:5,maxStreamConnectionResultsLogCount:100,minTargetEdgeLatency:.2,maxEdgeLatencyHistoryLength:300,latencyCompensationThreshold:.5,allowSpeedupLatencyCompensation:!0,conservativeLatencyCompensationSpeedupReset:!0,useHydraAVInterleaver:!1,maxPlayerExperimentalEvents:100}}}getSettings(){return this.defaultSettings}},nt=class extends it{constructor(){super(),this.settings=super.getSettings(),this.settings.loadType=0,this.settings.allowSdnPlugins=!1,this.settings.umsSettings.allowServerTrackSwitch=!1,this.settings.umsSettings.requireStrictServerTrackSwitch=!0,this.settings.umsSettings.minTargetEdgeLatency=.6,this.settings.umsSettings.latencyCompensationThreshold=.9,this.settings.umsSettings.allowSpeedupLatencyCompensation=!1,this.settings.umsSettings.conservativeLatencyCompensationSpeedupReset=!1,this.settings.umsSettings.useHydraAVInterleaver=!0}getSettings(){return this.settings}};function getSettings(){let g;if("Safari"===getBrowserInfo().engine)g=new nt;else g=new it;return g.getSettings()}function arrayMergeCustomizer(g,m){if((0,Ye.isArray)(g))return m.slice()}function isStreamValid(g){return!!g&&!!g.url&&!!g.decryptionToken}function isHlsStreamValid(g,m,f){let S,v;try{S=new URL(g),v=new URL(m.keyDeliveryUrl)}catch(g){return!1}if(!(!!m.keyAuthorizationToken&&g.endsWith("m3u8")))return!1;if(!f)return!0;const C=S.pathname.split("/").filter(Boolean),_=v.pathname.split("/").filter(Boolean),E=C.length,T=_.length;return!(E<2||T<4)&&C[0]===_[3]}function assert(g,m,f){if(!g&&!f)throw new Error("Assert failed"+(void 0!==m?`: ${m}`:""))}function getRandomHexString(g){return Array.from(Array(g)).map((()=>Math.floor(16*Math.random()).toString(16))).join("")}var rt=class{constructor(g,m,f){this.name=g,this.stopCrash=m,this.start(f)}complete(){try{assert(this.startTime,"not started",this.stopCrash),assert(void 0===this.duration,"already completed",this.stopCrash)}catch(g){if("LoadHlsFirstFragment"!==this.name&&"HlsKeyLoad"!==this.name)throw g}this.duration=Date.now()-this.startTime}updateDetails(g,m){if(this.details&&"object"==typeof this.details)for(let f=0;f<g.length;f++)this.details[g[f]]=m[f]}fail(g){this.failReason=g,this.complete()}set detail(g){this.details=g}getTelemetryEvent(){assert(this.startTime,"not started",this.stopCrash);try{assert(void 0!==this.duration,"not completed",this.stopCrash)}catch(g){if("SetSource"!==this.name&&"Load"!==this.name&&"LoadHlsFirstFragment"!==this.name&&"HlsKeyLoad"!==this.name)throw g}const g={name:this.name,startTime:this.startTime,duration:this.duration};return this.failReason&&(g.failReason=this.failReason),this.details&&(g.details=this.details),g}start(g){assert(!this.startTime,"already started",this.stopCrash),this.startTime=Date.now(),this.details=g}},st=class{constructor(g,m,f){this.config=g,this.logger=m,this.playerDiagnosticsLog=f,this.currentScenarioMap=new Map,this.playerEvents=[],this.playbackEvents=[],this.userInitiatedSeekEvents=[],this.experimentalEvents=[],this.clientNetworkType=void 0,this.maxPlayerPlaybackEventCount=g.maxPlayerPlaybackEventCount||5,this.maxPlayerDiagnosticsCount=g.maxPlayerDiagnosticsCount||5,this.maxPlayerMemoryTraceLogCount=g.maxPlayerMemoryTraceLogCount||100,this.maxUserInitiatedSeekEventCount=g.ampSettings?.maxUserInitiatedSeekEventCount||100,this.stopCrash=g.stopCrash||!1,this.config.debug&&(this.playerDiagnosticsLog.memoryLog=[]),this.addNetworkTypeEventListener()}getPlayerDiagnosticSnapshot(){return this.currentPlayerDiagnosticSnapshot}registerStatsUpdated(g){this.currentPlayerDiagnosticSnapshot=g,Object.keys(this.playerDiagnosticsLog).forEach((m=>{const f=m,S=this.playerDiagnosticsLog[m];if(Array.isArray(S)){S.push(g[f]);const m="memoryLog"===f&&S.length>this.maxPlayerMemoryTraceLogCount,v="memoryLog"!==f&&S.length>this.maxPlayerDiagnosticsCount;(m||v)&&S.splice(0,1)}else this.playerDiagnosticsLog[m]=g[f]}))}registerEventLoadAttempt(g,m){this.registerScenario(g,m)}registerEventLoadFailed(g,m){this.completeScenario(g,m)}registerEventLoadSucceeded(g,m){this.completeScenario(g,void 0,m)}registerPlayerLoadAttempt(){this.registerScenario("Load")}registerPlayerLoadSucceeded(g){this.completeScenario("Load",void 0,g)}registerPlayerLoadFailed(g){this.completeScenario("Load",g)}registerPlayerSetupAttempt(){this.registerScenario("Setup")}registerPlayerSetupSucceeded(){this.completeScenario("Setup")}registerPlayerSetupFailed(g){this.completeScenario("Setup",g)}registerStreamConnectionAttempt(g){this.registerScenario("StreamConnection")}registerStreamConnectionSucceeded(){this.completeScenario("StreamConnection")}registerStreamConnectionFailed(g){this.completeScenario("StreamConnection",g)}registerSetSourceAttempt(g,m){let f=g;m&&(f={src:g,reason:m}),this.registerScenario("SetSource",f)}registerSetSourceSucceeded(g,m){this.getScenario("SetSource").updateDetails(["src","SwitchingDiagnostics"],[g,stringifyObject(m)]),this.completeScenario("SetSource")}registerSetSourcedFailed(g,m,f){this.getScenario("SetSource").updateDetails(["src","SwitchingDiagnostics"],[m,stringifyObject(f)]),this.completeScenario("SetSource",g)}registerSdnPluginLoad(g,m,f){this.registerScenario("SdnPluginLoad",g);const S=m?void 0:f;this.completeScenario("SdnPluginLoad",S)}registerPlayerDestroyed(g){this.registerScenario("Destroyed",g),this.completeScenario("Destroyed")}registerPlaybackStateChanged(g,m){let f;if("Ready"!==g||this.firstReadyStateTimestamp?"Playing"!==g||this.firstPlayingStateTimestamp||(this.firstPlayingStateTimestamp=Date.now()):this.firstReadyStateTimestamp=Date.now(),m&&"Buffering"===g){m?f=m.message:this.logger.debug(`Unexpected buffering payload: ${JSON.stringify(m)}`)}this.registerPlaybackEvent("StateChanged",g,f)}registerPlaybackError(g,m){this.registerPlaybackEvent("Error",{errorType:g,details:m})}registerDownloadBitratechanged(g){this.registerPlaybackEvent("BitrateChangedDownload",g)}registerStreamOptionsConfigured(g,m){this.registerPlaybackEvent("StreamOptionsConfigured",this.generateCleanedStreamOption(g),m)}registerPlaybackBitratechanged(g){this.registerPlaybackEvent("BitrateChangedPlayback",g)}registerPotentialMediaFreeze(g){this.registerPlaybackEvent("PotentialMediaFreeze",g)}registerCaptionToggle(g,m,f){const S={isEnabled:g,culture:m,playerTime:f};this.registerPlaybackEvent("CaptionsToggled",S)}registerFullScreenChange(g){this.registerPlaybackEvent("FullscreenChanged",g)}registerMute(g){this.registerPlaybackEvent("Mute",g)}registerVolumeChange(g){this.registerPlaybackEvent("Volume",g)}getExperimentalEvents(){return{playback_experimentalEvents:this.prepareForTelemetry(this.experimentalEvents)}}getUserInitiatedSeekEvents(){return{playback_userInitiatedSeekEvents:this.prepareForTelemetry(this.userInitiatedSeekEvents)}}getSnapshotReport(g={}){const m=this.playerEvents.map((g=>g.getTelemetryEvent())),f=this.playbackEvents;let S={};return this.currentPlayerDiagnosticSnapshot&&(S=this.filterAndPrepareTelemetry()),{isFullReport:!1,configIds:g.configIds||"",playerId:g.playerId||"",correlationId:g.correlationId||"",traceId:g.correlationId?g.correlationId.replace(/-/g,""):"",eTag:g.eTag||"",isFinal:g.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:g.disableFullscreenButton??!1,threadId:g.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:getTsCallingVersion(),...this.getInitializationReport(m,f),...this.getPlaybackReport(f),...this.getBitrateReport(f),...this.getSdnReport(m),...this.getSetSourceReport(m),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(m),callDropped:this.getCallDropped(f),...S}}getReport(g={}){const m=this.playerEvents.map((g=>g.getTelemetryEvent())),f=this.playbackEvents;return{callendReason:g.callendReason,isFullReport:!0,configIds:g.configIds||"",playerId:g.playerId||"",correlationId:g.correlationId||"",traceId:g.correlationId?g.correlationId.replace(/-/g,""):"",eTag:g.eTag||"",isFinal:g.isFinal??!1,isIframe:1===this.config.loadType,isFullscreenButtonDisabled:g.disableFullscreenButton??!1,threadId:g.threadId||"",telemetryTickMs:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.statsInterval?this.currentPlayerDiagnosticSnapshot.statsInterval:-1,tsCallingVersion:getTsCallingVersion(),...this.getInitializationReport(m,f),...this.getPlaybackReport(f),...this.getBitrateReport(f),...this.getSdnReport(m),...this.getSetSourceReport(m),...this.getExperimentalEvents(),...this.getUserInitiatedSeekEvents(),networkType:this.getClientNetworkType(),callSetupSucceeded:this.getCallSetupSucceeded(m),callDropped:this.getCallDropped(f),...this.getPlayerDiagnosticLog()}}registerExperimentalEvent(g,m,f){const S=this.createTelemetryEvent(g,m,f);this.experimentalEvents.push(S),this.logTelemetryEvent(S)}registerUserInitiatedSeek(g){const m=(this.currentPlayerDiagnosticSnapshot?.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1)<g.newCurrentPlayPosition,f={...g,seekForward:m},S=this.createTelemetryEvent("UserInitiatedSeek",f);this.userInitiatedSeekEvents.push(S),this.userInitiatedSeekEvents.length>this.maxUserInitiatedSeekEventCount&&this.userInitiatedSeekEvents.splice(0,1)}createTelemetryEvent(g,m,f){const S={eventType:g,timestamp:Date.now(),currentPlayPosition:this.currentPlayerDiagnosticSnapshot&&this.currentPlayerDiagnosticSnapshot.currentPlayPosition?this.currentPlayerDiagnosticSnapshot.currentPlayPosition:-1};return void 0!==m&&(S.payload=this.prepareForTelemetry(m)),S.message=f,S}registerPlaybackEvent(g,m,f){const S=this.createTelemetryEvent(g,m,f);"Error"===g&&"PlaybackRetried"!==m?.errorType&&(S.fatal=!0),this.playbackEvents.push(S),this.playbackEvents.length>this.maxPlayerPlaybackEventCount&&this.playbackEvents.splice(0,1),this.logTelemetryEvent(S)}getPlayerDiagnosticLog(){if(!this.currentPlayerDiagnosticSnapshot)return{};const g={...this.currentPlayerDiagnosticSnapshot,...this.playerDiagnosticsLog},m={};return Object.keys(g).forEach((f=>{m[`player_${f}`]=this.prepareForTelemetry(g[f])})),m}getCallSetupSucceeded(g){const m=g.find((g=>"Load"===g.name));return!!m&&!m.failReason}getCallDropped(g){return!!g.filter((g=>"Error"===g.eventType)).find((g=>g.fatal))}getInitializationReport(g,m){const f=g.find((g=>"Load"===g.name));return{init_timeLoadToStreamConnectionEstablished:(f&&this.initialStreamConnectionEstablishedTimestamp?this.initialStreamConnectionEstablishedTimestamp-f.startTime:-1)||-1,init_timeLoadToReady:(f&&this.firstReadyStateTimestamp?this.firstReadyStateTimestamp-f.startTime:-1)||-1,init_timeLoadToPlaying:(f&&this.firstPlayingStateTimestamp?this.firstPlayingStateTimestamp-f.startTime:-1)||-1,init_allEvents:this.prepareForTelemetry(g)}}getPlaybackReport(g){const m=g.filter((g=>"StateChanged"===g.eventType)),f=m.find((g=>"Ready"===g.payload)),S=m.find((g=>"Play"===g.payload)),v=m.find((g=>"Start"===g.payload)),C=m.find((g=>"Playing"===g.payload)),_=f&&S?S.timestamp-f.timestamp:-1,E=S&&v?v.timestamp-S.timestamp:-1,T=v&&C?C.timestamp-v.timestamp:-1,I=m.filter((g=>"Seeked"===g.payload)),b=m.filter((g=>"Seeking"===g.payload)),A=m.filter((g=>"Paused"===g.payload)),P=m.filter((g=>"Resume"===g.payload)),R=m.filter((g=>"Buffering"===g.payload)),w=["BitrateChangedDownload","BitrateChangedPlayback","Error","Mute","StateChanged","Volume","StreamOptionsConfigured"],M=g.filter((g=>"Error"===g.eventType)),D=g.filter((g=>"Volume"===g.eventType||"Mute"===g.eventType)),O=g.filter((g=>"StreamOptionsConfigured"===g.eventType)),N=g.filter((g=>!w.includes(g.eventType)));return{playback_timeReadyToPlay:_,playback_timePlayToStart:E,playback_timeStartToPlaying:T,playback_bufferingEvents:this.prepareForTelemetry(R),playback_errorEvents:this.prepareForTelemetry(M),playback_pauseEvents:this.prepareForTelemetry(A),playback_resumeEvents:this.prepareForTelemetry(P),playback_otherEvents:this.prepareForTelemetry(N),playback_seekedEvents:this.prepareForTelemetry(I),playback_seekingEvents:this.prepareForTelemetry(b),playback_stateChangeEvents:this.prepareForTelemetry(m),playback_volumeEvents:this.prepareForTelemetry(D),playback_streamOptionsConfiguredEvents:this.prepareForTelemetry(O)}}generateCleanedStreamOption(g){return{...g,stream:{...g?.stream,decryptionToken:g?.stream?.decryptionToken?"valid":"empty",sdnContext:g?.stream?.sdnContext?"valid":"empty",keyAuthorizationToken:g?.stream?.keyAuthorizationToken?"valid":"empty"},altStream:g?.altStream?{...g?.altStream,decryptionToken:g?.altStream?.decryptionToken?"valid":"empty",sdnContext:g?.altStream?.sdnContext?"valid":"empty",keyAuthorizationToken:g?.stream?.keyAuthorizationToken?"valid":"empty"}:void 0}}getBitrateReport(g){const m=g.filter((g=>"BitrateChangedDownload"===g.eventType)),f=m.sort((g=>Number(g.payload))),S=m.length?{bitrate_downloadChanges:this.prepareForTelemetry(m),bitrate_downloadChangeCount:m.length||-1,bitrate_downloadMin:f[0].payload||-1,bitrate_downloadMax:f[f.length-1].payload||-1}:{},v=g.filter((g=>"BitrateChangedPlayback"===g.eventType)),C=v.sort((g=>Number(g.payload)));return{...S,...v.length?{bitrate_playbackChanges:this.prepareForTelemetry(v),bitrate_playbackChangeCount:v.length||-1,bitrate_playbackMin:C[0].payload||-1,bitrate_playbackMax:C[C.length-1].payload||-1}:{}}}addNetworkTypeEventListener(){window.navigator?.connection?.type&&window.navigator?.connection?.addEventListener("change",(()=>this.updateClientNetworkType()))}updateClientNetworkType(){this.clientNetworkType=void 0,this.getClientNetworkType()}getClientNetworkType(){if(void 0===this.clientNetworkType){let g="Unknown";if(window.navigator?.connection?.type){const m=window.navigator?.connection?.type;switch(m){case"cellular":g="WWAN";break;case"ethernet":g="Wired";break;case"wifi":g="Wireless";break;default:g="Unknown"}}this.clientNetworkType=g}return this.clientNetworkType}getSdnReport(g){const m=g.filter((g=>"SdnPluginLoad"===g.name)),f=m.length?m[m.length-1]:void 0;return{sdn_loaded:!(!f||void 0!==f.failReason),sdn_details:f&&f.details||"",sdn_error:f&&f.failReason||"",sdn_events:this.prepareForTelemetry(m)}}getSetSourceReport(g){const m=g.filter((g=>"SetSource"===g.name));return{set_source_events:this.prepareForTelemetry(m)}}registerScenario(g,m){const f=this.currentScenarioMap.get(g),S=new rt(g,this.stopCrash,m);try{assert(!f,`previous scenario:${stringifyObject(f)} is not completed, new scenario:${stringifyObject(S)}`,this.stopCrash)}catch(m){if("LoadHlsFirstFragment"!==g&&"HlsKeyLoad"!==g)throw m}this.currentScenarioMap.set(g,S),this.playerEvents.push(S)}getScenario(g){return this.currentScenarioMap.get(g)}completeScenario(g,m,f){const S=this.currentScenarioMap.get(g);try{assert(S,"no scenario to complete",this.stopCrash)}catch(m){if("LoadHlsFirstFragment"!==g&&"HlsKeyLoad"!==g)throw m}m?S.fail(m):("StreamConnection"!==g||this.initialStreamConnectionEstablishedTimestamp||(this.initialStreamConnectionEstablishedTimestamp=Date.now()),f&&(S.detail=f),S.complete()),this.currentScenarioMap.delete(g)}logTelemetryEvent(g){this.config.debug&&(this.logger.debug(`PlayerTelemetryEvent: ${JSON.stringify(g)}`),this.logger.debug(`PlayerDiagnosticData: ${JSON.stringify(this.currentPlayerDiagnosticSnapshot)}`))}filterAndPrepareTelemetry(){const g=new Set;g.add("serviceLatencyCdg"),g.add("endToEndLatencyCdg"),g.add("videoEdgeLatencyCdg");const m={};return Object.keys(this.currentPlayerDiagnosticSnapshot).forEach((f=>{g.has(f)||(m[`player_${f}`]=this.prepareForTelemetry(this.currentPlayerDiagnosticSnapshot[f]))})),m}prepareForTelemetry(g){return"boolean"==typeof g?g:"string"==typeof g||void 0===g?g||"":"number"==typeof g?g??-1:JSON.stringify(g)}},at=R;function asap(g){return new Promise((m=>{m(g())}))}function defer(){let g,m;return{promise:new Promise(((f,S)=>{g=f,m=S})),resolve:g,reject:m}}function delay(g){return new Promise((m=>setTimeout(m,g)))}function AmpPlayerF(){const g=AmpDiagnosticProviderF(),m=CaptionsControlToggleProviderF();let f;return(f||(f={})).CaptionFunctionalityNotSupported="CaptionFunctionalityNotSupported",class{constructor(g,m){this.container=g,this.eventsHandler=m,this.videoElementEvents=[],this.playerEvents=[],this.maxMemoryTraceLogCount=1e4,this.videoSourceType="application/dash+xml",this.sdnPluginLoaded=!1,this.statsTimer=-1,this.statsInterval=1e3,this.videoSourceSetAttemptCount=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[]}get contextWindow(){return this.container.ownerDocument.defaultView}configure(g,m,f){this.liveStreamOptions=g,this.playerId=f,m&&(this.configProvider=m,this.statsInterval=m.config.playerTelemetryTickMs||this.statsInterval,this.maxMemoryTraceLogCount=m.config.maxPlayerMemoryTraceLogCount||this.maxMemoryTraceLogCount)}getIceCandidates(){let g=[];try{const m=this.liveStreamOptions.stream.sdnContext||this.liveStreamOptions.altStream?.sdnContext||"",f=JSON.parse(m),S=JSON.parse(f.sdnConfig);if(!S.RTCIceCandidates)throw new Error("RTCIceCandidates not present in SDN Context");g=S.RTCIceCandidates}catch(g){this.log(`getIceCandidates failed: ${JSON.stringify(g.message)}`,"error")}return this.log(`getIceCandidates: ${JSON.stringify(g)}`,"debug"),g}loadPlayerScript(){let g=Promise.resolve("");const m=this.configProvider.playerConfig.nonce,f=this.configProvider.playerConfig.css;for(let S=0;S<f.length;S++)g=g.then((()=>this.retry((()=>this.loadCss(this.container.ownerDocument,f[S],m)))));return g=g.then((()=>this.loadAmpScript())),g}loadAmpScript(){this.log("loadPlayerScript started");let g=Promise.resolve("");const m=this.configProvider.playerConfig?.nonce,f=this.configProvider.playerConfig?.src||[],S=Math.max(2,this.configProvider.config.maxRetryCountForLoadingResources);if(0===f.length)return Promise.reject("AMP Player Src is empty");for(let v=0;v<f.length;++v)g=g.then((()=>this.loadScriptPromise(f,v,m,S)));return g}loadScriptPromise(g,m,f,S,v=""){return this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,g[m],f)),S).then((f=>`${g[m]}: ${f} `.concat(v))).catch((C=>this.retry((()=>this.setScriptByBlob(this.container.ownerDocument,g[m],f)),S).then((f=>`${g[m]}: ${f}`.concat(` ${C} `,` ${v} `))).catch((_=>this.retry((()=>this.setScriptByInnerHtml(this.container.ownerDocument,g[m],f)),1).then((f=>`${g[m]}: ${f}`.concat(` ${C} `,`${_} `,` ${v} `))).catch((C=>{let E=v;return m<g.length&&(E=E.concat(`Failed to load script, nonce: ${f}, src: ${g[m]} index: ${m} `),E=E.concat(`${S} attempts LoadFailure `,`${S} attempts BlobFetchFailure: `,_,", 1 attempt InnerHtmlFailure: ",`${C} `)),Promise.reject(E)}))))))}retry(g,m=this.configProvider.config.maxRetryCountForLoadingResources,f=1,S=200){return g(m).then((g=>`${g}, succeeded on load number: ${f} `)).catch((v=>(this.log(`Error loading resource: ${v} -- ${m} retriesLeft`),0==--m?Promise.reject(`${v}`):new Promise((C=>setTimeout((()=>C(this.retry(g,m,f+1).then((g=>"string"==typeof g?`${g}, succeeded on load number: ${f}`:g)).catch((g=>Promise.reject(`${v}`.concat(", ",g)))))),S))))))}setScriptByLoad(g,m,f){const S=g.createElement("script"),v=this.getElementLoadPromise(S,m);return S.src=m,f&&(S.nonce=f),g.head.appendChild(S),v.then((()=>Promise.resolve("Success: setScriptByLoad")))}setScriptByBlob(g,m,f){return this.safeResponse(m).then((m=>m.blob().then((S=>{if(S){const m=URL.createObjectURL(S);return this.setScriptByLoad(g,m,f).then((()=>Promise.resolve("Success: setScriptByBlob")))}return Promise.reject(`${m.status}, blob is null`)}))))}setScriptByInnerHtml(g,m,f){return this.safeResponse(m).then((m=>m.text().then((S=>{if(S){const m=document.createElement("script");return m.innerHTML=S,f&&!this.configProvider.config.hlsSettings.skipNonce&&(m.nonce=f),g.head.appendChild(m),Promise.resolve("Success: setScriptByInnerHtml")}return Promise.reject(`status code:${m.status}, text is null`)}))))}safeResponse(g){return fetch(g).then((g=>g.ok?g:Promise.reject(`${g.status}`)))}tryLoadSdnPlugin(){return this.sdnPluginLoaded||!this.liveStreamOptions.sdn?Promise.resolve():this.configProvider.config.allowSdnPlugins?(this.log("tryLoadSdnPlugin started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.url,this.configProvider.playerConfig.nonce))).then((()=>{this.log("SDN script loaded"),this.sdnPluginLoaded=!0,this.log("tryLoadSdnPlugin done")}))):(this.log("Loading SDN plugins is not allowed"),Promise.reject("Loading SDN plugins is not allowed"))}createAmp(){this.log("createAmp started"),this.createVideoElement();const f=this.getAmpOptions();if(this.playerInstance=this.contextWindow.amp(this.video.id,f),!this.playerInstance)throw this.log("createAmp failed","error"),new Error("playerInstance is null");"html5"===this.playerInstance.currentTechName()?.toLowerCase()&&this.configProvider.config.ampSettings.estimateAbsoluteTime&&this.isControlsDisabled()?(this.absoluteTimeOffsetEstimator=new lt(this.log.bind(this)),this.diagnosticProvider=new g(this.playerInstance,this.contextWindow,new Date,this.configProvider,this.absoluteTimeOffsetEstimator),this.absoluteTimeOffsetEstimator.setEstimationResultCallback(this.onAbsoluteTimeOffsetEstimation.bind(this))):this.diagnosticProvider=new g(this.playerInstance,this.contextWindow,new Date,this.configProvider);const S={controlsEnabled:!this.isControlsDisabled(),logFn:this.log.bind(this),removeEmptyDefaultTextTrack:this.configProvider.config.removeEmptyDefaultTextTrack};this.diagnosticProvider.setValue("streamingEventType",this.liveStreamOptions.streamingEventType),this.diagnosticProvider.setValue("playerControlsEnabled",!this.isControlsDisabled()),this.captionsControl=new m(this.playerInstance,this,S,this.diagnosticProvider),this.registerPlayerEvents(),this.log("createAmp done")}isControlsDisabled(){return void 0!==this.liveStreamOptions.allowPlayerControls?!this.liveStreamOptions.allowPlayerControls:"Overflow"===this.liveStreamOptions.streamingEventType||"TownHall_Basic"===this.liveStreamOptions.streamingEventType||"TownHall_Premium"===this.liveStreamOptions.streamingEventType||"TownHall"===this.liveStreamOptions.streamingEventType}onAbsoluteTimeOffsetEstimation(g){if(this.diagnosticProvider.appendAbsoluteTimeOffsetEstimation(g),!g.isSuccess){const g=this.addEvent("CaptionFunctionalityNotSupported",{detail:{data:{fatal:!0,details:"absolute time offset estimation failed - captions will fail"}}});this.video.dispatchEvent(g)}}addEvent(g,m){let f={};return m?.detail&&(f={detail:m.detail}),new CustomEvent(g,f)}setSource(g){if(this.log("setSource started"),!this.playerInstance)throw this.log("setSource failed: playerInstance is null","error"),new Error("playerInstance is null");this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1);const m={src:g.url,type:this.videoSourceType,protectionInfo:g.decryptionToken?[{type:"AES",authenticationToken:g.decryptionToken}]:null};this.configureSdnSource(m,g),this.diagnosticProvider.setValue("streamUrl",g.url),this.diagnosticProvider.setValue("streamId",this.getStreamIdFromStreamUrl(g.url)),this.diagnosticProvider.setValue("streamDeliveryPipeline",g.streamDeliveryPipeline||""),this.playerInstance.src([m],this.getTextTracks()),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.setManifestFileURL(g.url+"(format=m3u8-aapl-v4)"),this.log("setSource done")}getStreamIdFromStreamUrl(g){try{const m=new URL(g).pathname;if(m){const g=m.split("/");if(g?.length>1)return g[1]}return this.log(`unable to parse stream ID from stream URL: ${g}`,"warn"),""}catch{return this.log(`cannot parse stream ID from invalid stream URL: ${g}`,"warn"),""}}setPlayTime(g){g&&(this.log(`setPlayerTime: ${g}`),this.playerInstance.currentTime(g))}dispose(){this.log("dispose started"),this.diagnosticProvider&&(this.stopStatsCollection(),this.diagnosticProvider.dispose(),this.diagnosticProvider=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.removePlayerEventListeners(),this.playerInstance.getMemoryLog(!0),this.playerInstance.dispose(),this.playerInstance=null),this.eventsHandler.ampDisposed(),this.video&&(this.removeVideoEventListeners(),this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.absoluteTimeOffsetEstimator&&(this.absoluteTimeOffsetEstimator.stopStreamAbsoluteTimeOffsetRetrieval(),this.absoluteTimeOffsetEstimator=null),this.log("dispose done"),this.eventsHandler=null}updatePlaybackDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}handlePlaybackStopped(){this.isBuffering=!1,this.isPlaying=!1,this.currentVideoPlaybackBitrate=null}showCaptions(g){this.log(`showCaptions: ${g}`),this.captionsControl.showCaptions(g)}addCues(g){g=g.filter((g=>g.text&&0!==g.text.trim().length)),this.captionsControl.addCues(g)}clearCues(){this.captionsControl.clearCues()}captionsToggled(g,m,f){this.log(`captionsToggled: ${g} for culture ${m} at ${f}`),this.eventsHandler.message("captionsToggled").send(g,m,f)}createVideoElement(){this.log("createVideoElement started"),this.video=this.container.ownerDocument.createElement("video"),this.video.id="amp-player",this.video.setAttribute("playsinline","");const g=this.configProvider.playerConfig.lang;g&&(this.video.setAttribute("lang",g),this.log(`createVideoElement: language set to ${g}`));const m=this.configProvider.playerConfig.styles;for(let g=0;g<m.length;g++)this.video.classList.add(m[g]);this.container.appendChild(this.video),this.log("createVideoElement done")}getAmpOptions(){const g=[];this.configProvider.config.debug?g.push({target:"memory",maxMemoryTraceCount:this.maxMemoryTraceLogCount}):g.push({target:"console"});const m={TraceTargets:g,maxLogLevel:this.configProvider.config.debug?3:2},f={techOrder:["azureHtml5JS","html5"],nativeControlsForTouch:!1,autoplay:!0,preload:"auto",controls:!this.isControlsDisabled(),logo:{enabled:!1},height:"100%",width:"100%",traceConfig:m,disableFullscreenButton:this.configProvider.playerConfig?.disableFullscreenButton,staleDataTimeLimitInSec:30,heuristicProfile:this.contextWindow.amp.Player.HeuristicProfile.HighQuality,customPlayerSettings:{customHeuristicSettings:{bandwidthTestWithTimeThresholdDuringLive:!1,windowSizeHeuristics:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useBrowserWindowForWindowSizeRule:this.configProvider.config.ampSettings.useBrowserWindowSizeForBitRate,useVariableFragmentSizeMode:!0}},plugins:{}};return this.initializePluginOptions(f),f}isStreamValid(g){return g&&!!g.url&&!!g.decryptionToken}initializePluginOptions(g){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;const m=this.isStreamValid(this.liveStreamOptions.stream)?this.liveStreamOptions.stream:this.liveStreamOptions.altStream;this.log(`initializePluginOptions, receivedSDNContext: ${JSON.stringify(m?.sdnContext)}`,"info");try{switch(this.liveStreamOptions.sdn.name){case"hive":if(g.plugins={hive:{debugLevel:this.configProvider.config.debug?"debug":"notice",telemetryId:this.playerId}},m&&m.sdnContext)try{const f=JSON.parse(m.sdnContext);if(f.sdnConfig){const m=JSON.parse(f.sdnConfig);m.candidateTopicName="RequestIceCandidates",delete m.RTCIceCandidates,Object.assign(g.plugins.hive,m)}}catch(g){this.log(`initializePluginOptions, failed to parse Hive sdnConfig Json from sdnContext Json, error: ${g}`,"warn")}break;case"kollective":if(m&&m.sdnContext){let f=null,S=null,v=null;try{f=this.parseJson(m.sdnContext,"kollective sdn context")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext Json, error: ${g}`,"error")}if(f){try{S=this.parseJson(f.playbackinfo,"kollective sdn playback info")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext playbackinfo Json, error: ${g}`,"error")}try{v=this.parseJson(f.sdnConfig,"kollective sdn config")}catch(g){this.log(`initializePluginOptions, failed to parse Kollective sdnContext sdnConfig Json, error: ${g}`,"error")}}g.plugins={kollectiveSDN:{playbackInfo:S,sdnConfig:v,reportSessionId:this.playerId}}}break;case"ramp":m&&m.sdnContext&&(g.plugins={RampMOPlugin:this.parseJson(m.sdnContext,"ramp sdn context")},this.configProvider.config.debug&&(g.plugins.RampMOPlugin.verbose=!0));break;case"peer5":m.sdnContext&&(g.plugins={peer5:this.parseJson(m.sdnContext,"peer5 sdn context")})}}catch(g){this.log(`initializePluginOptions failed, error: ${g.message}`,"error")}this.log(`initializePluginOptions, configured plugin options: ${JSON.stringify(g.plugins)}`,"info")}getTextTracks(){const g=[];if(this.isControlsDisabled())g.push({id:"amp-player_default",kind:"captions",label:"default-text-track",src:"",srclang:"en"});else if(this.liveStreamOptions.supportedSubtitleLanguages){const m=this.liveStreamOptions.supportedSubtitleLanguages;for(let f=0;f<m.length;f++)g.push({id:`amp-player_${m[f].culture}`,kind:this.configProvider.config.textTrackKind,label:m[f].name||m[f].culture,src:"",srclang:m[f].culture.substr(0,2)})}return g}configureSdnSource(g,m){if(!this.sdnPluginLoaded||!this.liveStreamOptions.sdn)return;switch(this.liveStreamOptions.sdn.name){case"hive":if(!m.sdnContext){g.sdnList=[];break}try{const f=JSON.parse(m.sdnContext);f.playbackinfo&&(g.sdnList=[{sdnName:"hive",sdnUrl:f.playbackinfo}])}catch(f){g.sdnList=[{sdnName:"hive",sdnUrl:m.sdnContext}]}break;case"kollective":if(!m.sdnContext){g.sdnList=[];break}try{const f=this.parseJson(m.sdnContext,"kollective sdn list context"),S=this.parseJson(f.playbackinfo,"kollective sdn list playback info"),v=this.parseJson(f.sdnConfig,"kollective sdn list sdn config");g.sdnList=[{sdnName:"kollectiveSDN",playbackInfo:S,sdnConfig:v}]}catch(m){return g.sdnList=[],void this.log(`configureSdnSource failed, error: ${m}`,"error")}break;case"ramp":case"peer5":g.sdnList=[];break;default:return}this.log(`configureSdnSource, configured source context: ${JSON.stringify(g)}`,"info")}registerPlayerEvents(){this.registerPlayerEvent(this.contextWindow.amp.eventName.error,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.error)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.canplaythrough,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.canplaythrough)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.play,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.play)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playing,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playing)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.pause,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.pause)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.resume,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.resume)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.start,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.start)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.ended,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.ended)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeking,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeking)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.seeked,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.seeked)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadedmetadata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadedmetadata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.waiting,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.waiting)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.playbackbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.playbackbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.downloadbitratechanged,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.downloadbitratechanged)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.fullscreenchange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.fullscreenchange)})),this.registerPlayerEvent("potentialMediaFreeze",(()=>{this.onAmpEvent("potentialMediaFreeze")})),this.registerPlayerEvent(this.contextWindow.amp.eventName.mute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.mute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.unmute,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.unmute)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.volumechange,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.volumechange)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadeddata,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadeddata)})),this.registerPlayerEvent(this.contextWindow.amp.eventName.loadstart,(()=>{this.onAmpEvent(this.contextWindow.amp.eventName.loadstart)})),Object.values(f).forEach((g=>{this.registerVideoEvent(g,(m=>{this.handleUserExperienceErrorEvent(g,m.detail.data.details,m.detail.data.fatal)}))})),this.configProvider.config.ampSettings.collectUserInitiatedSeekEventsTelemetry&&(this.playerEvents.push("currentTimeChanging"),this.playerInstance.addEventListener("currentTimeChanging",((g,m)=>this.onAmpCurrentTimeChangingEvent(g,m))))}onAmpCurrentTimeChangingEvent(g,m){if("currentTimeChanging"!==g.type||!m.time)return;const f={newCurrentPlayPosition:m.time};this.eventsHandler.message("stateChanged").send("UserInitiatedSeek",f)}registerPlayerEvent(g,m){this.playerEvents.push(g),this.playerInstance.addEventListener(g,m)}registerVideoEvent(g,m){this.videoElementEvents.push({name:g,callback:m}),this.video.addEventListener(g,m)}removePlayerEventListeners(){this.playerEvents.forEach((g=>{this.playerInstance.removeEventListener(g)}))}removeVideoEventListeners(){this.videoElementEvents.forEach((g=>{this.video.removeEventListener(g.name,g.callback)}))}onAmpEvent(g){let m,f;switch(g){case this.contextWindow.amp.eventName.error:f=this.playerInstance.error(),m={currentTime:this.playerInstance.currentTime(),errorCode:f?f.code:0,message:f?f.message:""};break;case this.contextWindow.amp.eventName.canplaythrough:this.initializeStatsColletion();break;case this.contextWindow.amp.eventName.loadedmetadata:this.captionsControl.initialize(),this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.restartStreamAbsoluteTimeOffsetRetrieval();break;case this.contextWindow.amp.eventName.fullscreenchange:m={isFullscreen:this.playerInstance.isFullscreen()};break;case this.contextWindow.amp.eventName.playbackbitratechanged:m={bitrate:this.playerInstance.currentPlaybackBitrate()};break;case this.contextWindow.amp.eventName.downloadbitratechanged:m={bitrate:this.playerInstance.currentDownloadBitrate()};break;case this.contextWindow.amp.eventName.seeked:m={captionsTimestamp:this.isControlsDisabled()?this.playerInstance.currentMediaTime():this.playerInstance.currentTime()};break;case this.contextWindow.amp.eventName.volumechange:m={value:this.playerInstance.volume()}}this.updatePlaybackDiagnostics(),this.updatePlayerState(g),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(g,m)}updatePlayerState(g){this.updatePlayingState(g),this.updateBufferingState(g),this.updateCurrentVideoTrackBitrate(g),g!==this.contextWindow.amp.eventName.ended&&g!==this.contextWindow.amp.eventName.error||this.handlePlaybackStopped()}handleUserExperienceErrorEvent(g,m,f){const S={currentTime:this.video?this.video.currentTime:0,message:m,type:g,errorCode:0,fatal:f};this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(this.contextWindow.amp.eventName.error,S)}updatePlayingState(g){this.isPlaying?g!==this.contextWindow.amp.eventName.pause&&g!==this.contextWindow.amp.eventName.seeking&&g!==this.contextWindow.amp.eventName.ended&&g!==this.contextWindow.amp.eventName.error&&g!==this.contextWindow.amp.eventName.waiting||(this.isPlaying=!1):g===this.contextWindow.amp.eventName.playing&&(this.isPlaying=!0)}updateBufferingState(g){this.isBuffering?(g===this.contextWindow.amp.eventName.pause&&!this.isControlsDisabled()||g===this.contextWindow.amp.eventName.seeking||g===this.contextWindow.amp.eventName.ended||g===this.contextWindow.amp.eventName.error||g===this.contextWindow.amp.eventName.playing)&&(this.isBuffering=!1):(g===this.contextWindow.amp.eventName.waiting||g===this.contextWindow.amp.eventName.pause&&this.isControlsDisabled())&&(this.isBuffering=!0)}updateCurrentVideoTrackBitrate(g){g===this.contextWindow.amp.eventName.playbackbitratechanged&&this.playerInstance.currentPlaybackBitrate()!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=this.playerInstance.currentPlaybackBitrate(),this.updateVideoTrackHistoryStatistic())}initializeStatsColletion(){this.diagnosticProvider.initialize(),this.statsTimer=window.setInterval((()=>{this.eventsHandler&&(this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()))}),this.statsInterval)}stopStatsCollection(){this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),-1!==this.statsTimer&&window.clearInterval(this.statsTimer),this.statsTimer=-1}updateVideoTrackHistoryStatistic(){const g=new Date;if(this.currentVideoPlaybackBitrate){const m=this.diagnosticProvider.getValue("videoTrackHistory"),f=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(m.length>0&&this.currentVideoPlaybackBitrate===m[m.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,m[m.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const S=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),v=f.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));S&&v&&(S.totalDurationInSeconds+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,v.totalDurationInSeconds=Number(S.totalDurationInSeconds.toFixed(0)))}}else{const S=this.playerInstance.videoBufferData();let v=null;S&&S.perceivedBandwidth&&(v=S.perceivedBandwidth),m.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:g.getTime(),trackSwitchMeasuredBandwidth:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredBandwidth():null,trackSwitchMeasuredByteSize:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredVideoDownloadSize():null,trackSwitchPerceivedBandwidth:v,durationInSeconds:0}),this.latestVideoTrackDuration=0,m.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&m.splice(0,1);const C=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));if(!C){const g={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},m={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(g),f.push(m)}}}this.videoTrackHistoryUpdatedTimestamp=g}updateTotalPlayingTimeStatistic(){const g=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=g.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=g,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const g=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=g.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=g;const m=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(m.toFixed(3)))}getPlayerDiagnostics(){const g=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return g.statsInterval=this.statsInterval,this.configProvider.config.debug&&(g.memoryLog=this.playerInstance.getMemoryLog(!0)),g}log(g,m="info"){const f=`${`[AmpPlayer${1===this.configProvider.config.loadType?"IFrame":""}]`}: ${g}`;this.configProvider.config.debug&&console.log(f),this.eventsHandler.message("log").send(m,f)}getElementLoadPromise(g,m){return new Promise(((f,S)=>{g.onload=()=>{f("Element Load success")},g.onerror=()=>{S(`Failed to load script: ${m}`)}}))}loadCss(g,m,f){const S=g.createElement("link"),v=this.getElementLoadPromise(S,m);return S.href=m,S.rel="stylesheet",f&&(S.nonce=f),g.head.appendChild(S),v}parseJson(g,m){try{return JSON.parse(g)}catch(g){throw this.log(`Error parsing JSON for ${m}, error: ${JSON.stringify(g)}`),g}}}}AmpPlayerF();function AmpCommunicationHandlerF(){const g=AmpPlayerF();return class{constructor(m,f){this.pipe=m,this.amp=new g(f,this)}processMessage(g){if("Command"===g.msgType){Promise.resolve().then((()=>this.amp[g.cmd].apply(this.amp,g.args))).then((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,result:JSON.stringify(m)})})).catch((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,error:m})}))}}message(g){return{send:this.fromMessage(((...m)=>{this.sendMessageImpl(g,m)}))}}ampDisposed(){this.pipe.dispose(),this.pipe=null,this.amp=null}fromMessage(g){return g}sendMessageImpl(g,m){this.pipe.sendMsg({msgType:"PlayerNotification",name:g,args:m})}}}var ot=AmpCommunicationHandlerF();function IFrameMessageHandlerF(){function isCmdResult(g){return"CommandResult"===g.msgType}function getErrorString(g){let m="unknown";try{m="string"==typeof g?g:"toString"in g&&0!==g.toString().indexOf("[object")?g.toString():JSON.stringify(g)}catch(m){console.error("Failed to stringify error",g)}return m}return class{constructor(){this.processMsg=this.processMsg.bind(this),window.addEventListener("message",this.processMsg)}sendMsg(g){try{let m=g;isCmdResult(g)&&g.error instanceof Event&&(console.debug("Stringifying error Event before trying to postMessage:",g),m={msgType:g.msgType,cmd:g.cmd,error:`Event: ${getErrorString(g.error)}`}),this.postMessage(m)}catch(m){console.error("Unexpected exception caught from postMessage.\n","message:",g,"\n","exception:",m);const f={msgType:"PlayerNotification",name:"log",args:["error",`Unexpected error with postMessage: ${getErrorString(m)}`]};throw this.postMessage(f),m}}registerObserver(g){this.observer=g}dispose(){window.removeEventListener("message",this.processMsg),this.observer=null}processMsg(g){this.observer.processMessage(g.data)}postMessage(g){window.parent.postMessage(g,"*")}}}function HlsAbsoluteTimeOffsetEstimatorF(){const g=HlsFileParserF();return class{constructor(m){this.playlistFileDownloadPromise=Promise.resolve(),this.playlistFileDownloadRetryWaitTime=250,this.playlistFileDownloadMaxRetryCount=20,this.playlistFileDownloadCancellationFlag=!1,this.logFn=(g,f)=>m(`[HlsAbsoluteTimeOffsetEstimator]: ${g}`,f),this.hlsFileParser=new g(m)}get absoluteTimeOffset(){return this.estimatedAbsoluteTimeOffset}setEstimationResultCallback(g){this.onAbsoluteTimeOffsetEstimation=g}restartStreamAbsoluteTimeOffsetRetrieval(){this.stopStreamAbsoluteTimeOffsetRetrieval().then((()=>this.startStreamAbsoluteTimeOffsetRetrieval()))}setManifestFileURL(g){this.cachedManifestUrl=g}startStreamAbsoluteTimeOffsetRetrieval(){this.playlistFileDownloadPromise=this.retryPlaylistFileDownload((()=>this.estimateStreamTimeFromPlaylist(this.currentManifestUrl))).then((()=>{this.logFn(`Succeeded in downloading playlist files to estimate\n                    absolute stream time offset as: ${this.estimatedAbsoluteTimeOffset}`)})).catch((g=>{this.logFn(`Failed to download playlist files to estimate absolute stream time offset: ${g.message}`,"error")}))}stopStreamAbsoluteTimeOffsetRetrieval(){return this.playlistFileDownloadCancellationFlag=!0,this.playlistFileDownloadPromise.then((()=>{this.playlistFileDownloadCancellationFlag=!1,this.currentManifestUrl=this.cachedManifestUrl,this.cachedManifestUrl=null}))}retryPlaylistFileDownload(g,m=0){let f=Promise.resolve();return f=g().then((()=>(this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!0,absoluteTimeOffsetEstimation:this.absoluteTimeOffset}),Promise.resolve()))).catch((f=>(m++,this.logFn(`Error loading playlist file: ${f} -- attempt ${m}`),this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!1,error:f.message}),m===this.playlistFileDownloadMaxRetryCount?Promise.reject(new Error(`${f} after ${m} attempts`)):this.playlistFileDownloadCancellationFlag?Promise.reject(new Error("cancelling playlist file download")):new Promise((f=>setTimeout((()=>f(this.retryPlaylistFileDownload(g,m))),this.playlistFileDownloadRetryWaitTime)))))),f}estimateStreamTimeFromPlaylist(g){return this.hlsFileParser.getStreamRenditionsUrlsFromManifest(g).then((m=>{if(0===m.audioRenditions.length&&0===m.videoRenditions.length)throw new Error(`Unable to retrieve renditions URLs from manifest: ${g}`);return Promise.all([m.videoRenditions.length>0?this.hlsFileParser.getTextFileContent(m.videoRenditions[0]):Promise.resolve(null),m.audioRenditions.length>0?this.hlsFileParser.getTextFileContent(m.audioRenditions[0]):Promise.resolve(null)])})).then((g=>{let m;for(let f=0;f<g.length;f++){const S=g[f];if(S){this.logFn("Using segment duration and sequence number to calculate absolute time offset","debug");const g=this.hlsFileParser.getHlsFieldByName("SequenceNumber",S);if(0==g.length)throw new Error("Unable to retrieve sequence number from playlist file");const f=this.hlsFileParser.getHlsFieldByName("SegmentDuration",S,10);if(0==f.length)throw new Error("Unable to retrieve segment durations from playlist file");const v=f.map(Number);v.sort(((g,m)=>g-m));const C=v[Math.floor(v.length/2)],_=Number(g[0])*Number(C);m=m?Math.max(m,_):_}}this.estimatedAbsoluteTimeOffset=m}))}}}var lt=HlsAbsoluteTimeOffsetEstimatorF();function HlsFileParserF(){return class{constructor(g){this.fieldNameRegexMap={BaseUrl:/(.*)\/.*/,AudioManifestFile:/#EXT-X-MEDIA:TYPE=AUDIO.*URI=\"(.*)\"/,SequenceNumber:/#EXT-X-MEDIA-SEQUENCE:(\d+)/,SegmentDuration:/#EXTINF:(\d+(\.\d+)?)/},this.logFn=(m,f)=>g(`[HlsFileParser]: ${m}`,f)}getHlsFieldByName(g,m,f=1){const S=[];for(let v=1;v<=f;v++){const f=this.fieldNameRegexMap[g].exec(m);if(!(f&&f.length>0))break;S.push(f[1]),m=m.substring(f.index+f[0].length)}return S}getStreamRenditionsUrlsFromManifest(g){return g?this.getTextFileContent(g).then((m=>{const f={audioRenditions:[],videoRenditions:[]},S=m.split("\n"),v=this.getHlsFieldByName("BaseUrl",g);for(let g=0;g<S.length;g++)if(S[g].includes("#EXT-X-STREAM-INF")){const m=S[g+1];m.includes("http")?f.videoRenditions.push(m):v.length>0&&f.videoRenditions.push(`${v[0]}/${m}`)}else if(S[g].includes("EXT-X-MEDIA:TYPE")){const m=this.getHlsFieldByName("AudioManifestFile",S[g]);if(m.length>0){const g=m[0];g.includes("http")?f.audioRenditions.push(g):v.length>0&&f.audioRenditions.push(`${v[0]}/${g}`)}}return f})).catch((g=>(this.logFn(`Failed to extract stream renditions from manifest, error: ${g.message}`,"error"),{audioRenditions:[],videoRenditions:[]}))):(this.logFn("No manifest URL provided to parse"),Promise.resolve({audioRenditions:[],videoRenditions:[]}))}getTextFileContent(g){const m=fetch(g).then((m=>{if(!m.ok)throw new Error(`http-error ${m.status} when downloading: ${g}`);return m.text()})).catch((g=>(this.logFn(`Error downloading resource: ${g}`,"error"),Promise.reject(g))));return m}}}function AmpDiagnosticProviderF(){return class{constructor(g,m,f,S,v){this.playerInstance=g,this.contextWindow=m,this.streamingStartedTimestamp=f,this.configProvider=S,this.absoluteTimeOffsetEstimator=v,this.currentDiagnosticSnapshot={playerType:0,currentPlayPosition:null,tech:null,perceivedBandwidth:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,avgVideoDownloadLatency:null,avgAudioDownloadLatency:null,avgVideoDownloadBytes:null,avgAudioDownloadBytes:null,avgAudioDownloadBandwidth:null,avgVideoDownloadBandwidth:null,maxVideoDownloadBytes:null,minVideoDownloadBytes:null,videoDownloadSuccessCount:null,audioDownloadSuccessCount:null,videoDownloadFailureCount:null,audioDownloadFailureCount:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,errorCode:null,currentMediaTime:null,currentAbsoluteTime:null,absoluteTimeOffsetEstimationResults:null,estimatedAbsoluteTimeOffset:null,videoDownloadFailures:null,audioDownloadFailures:null,heuristicProfile:null,encryption:null,retryFrequency:null,averageDownloadBitrate:null,totalDownloadedBytes:0,streamId:null,streamUrl:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,retryCount:0,totalPlayingTimeInSeconds:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],memoryLog:null,statsInterval:null},this.videoDownloadLatencies=[],this.audioDownloadLatencies=[],this.audioDownloadBytes=[],this.videoDownloadBytes=[],this.audioDownloadBandwidths=[],this.videoDownloadBandwidths=[],this.videoDownloadSuccessCount=0,this.audioDownloadSuccessCount=0,this.videoDownloadFailureCount=0,this.audioDownloadFailureCount=0,this.audioDownloadFailures=[],this.videoDownloadFailures=[],this.totalDownloadedBytes=0,this.slidingWindowLengthForLatency=5,this.slidingWindowLengthForDownloadBytes=30,this.slidingWindowLengthForDownloadBandwidth=10,this.absoluteTimeOffsetEstimationResults=[],this.downloadFailuresLimit=10,this.onAudioDownloadCompleted=this.onAudioDownloadCompleted.bind(this),this.onAudioDownloadError=this.onAudioDownloadError.bind(this),this.onVideoDownloadCompleted=this.onVideoDownloadCompleted.bind(this),this.onVideoDownloadError=this.onVideoDownloadError.bind(this)}initialize(){this.playerVideoBuffer=this.playerInstance.videoBufferData(),this.playerAudioBuffer=this.playerInstance.audioBufferData(),this.registerForPlayerBufferEvents()}setValue(g,m){this.currentDiagnosticSnapshot[g]=m}getValue(g){return this.currentDiagnosticSnapshot[g]}appendAbsoluteTimeOffsetEstimation(g){this.absoluteTimeOffsetEstimationResults.push(g),this.absoluteTimeOffsetEstimationResults.length>this.configProvider.config.ampSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount&&this.absoluteTimeOffsetEstimationResults.splice(0,1)}getPlayerDiagnosticSnapshot(){if(!this.playerInstance)return null;const g=window.screen,m=this.playerInstance.error(),mean2=g=>{const m=g.slice().sort();return m[Math.floor(m.length/2)]};this.currentDiagnosticSnapshot.errorCode=m&&m.code||0,this.currentDiagnosticSnapshot.currentPlayPosition=this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentMediaTime=this.playerInstance.currentMediaTime()??this.playerInstance.currentTime(),this.currentDiagnosticSnapshot.currentAbsoluteTime=this.getCurrentAbsoluteTime(),this.currentDiagnosticSnapshot.absoluteTimeOffsetEstimationResults=this.absoluteTimeOffsetEstimationResults,this.currentDiagnosticSnapshot.estimatedAbsoluteTimeOffset=this.getCurrentAbsoluteTimeOffset(),this.currentDiagnosticSnapshot.playbackBitrate=this.playerInstance.currentPlaybackBitrate(),this.currentDiagnosticSnapshot.downloadBitrate=this.playerInstance.currentDownloadBitrate(),this.currentDiagnosticSnapshot.audioDownloadBitrate=this.lastAudioDownloadBitrate,this.currentDiagnosticSnapshot.perceivedBandwidth=this.playerVideoBuffer?this.playerVideoBuffer.perceivedBandwidth:0,this.currentDiagnosticSnapshot.tech=this.playerInstance.currentTechName(),this.currentDiagnosticSnapshot.playerVersion=this.playerInstance.getAmpVersion(),this.currentDiagnosticSnapshot.isP2PSdnUsed=this.isP2PSdnUsed(),this.currentDiagnosticSnapshot.sdnName=this.sdnName(),this.currentDiagnosticSnapshot.heuristicProfile=this.playerInstance.currentHeuristicProfile(),this.currentDiagnosticSnapshot.encryption=this.playerInstance.currentProtectionInfo()?this.playerInstance.currentProtectionInfo().type:"",this.currentDiagnosticSnapshot.streamType=this.getStreamType(this.currentDiagnosticSnapshot.streamType),this.currentDiagnosticSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds(),this.currentDiagnosticSnapshot.audioStream=this.getAudioStreamData(),this.currentDiagnosticSnapshot.videoStream=this.getVideoStreamData(),this.currentDiagnosticSnapshot.muted=this.playerInstance.muted(),this.currentDiagnosticSnapshot.volume=this.playerInstance.volume(),this.currentDiagnosticSnapshot.playbackRate=this.playerInstance.playbackRate();const f=this.getPlayerCachedLength(),S=this.getPlayerEdgeLatency();this.currentDiagnosticSnapshot.audioBufferLength=this.playerAudioBuffer?this.playerAudioBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.audioCachedLength=f,this.currentDiagnosticSnapshot.audioEdgeLatency=S,this.currentDiagnosticSnapshot.videoBufferLength=this.playerVideoBuffer?this.playerVideoBuffer.bufferLevel:0,this.currentDiagnosticSnapshot.videoCachedLength=f,this.currentDiagnosticSnapshot.videoEdgeLatency=S,this.currentDiagnosticSnapshot.livePosition=this.getLivePosition(),this.currentDiagnosticSnapshot.mediaHeight=this.playerInstance.videoHeight(),this.currentDiagnosticSnapshot.mediaWidth=this.playerInstance.videoWidth(),this.currentDiagnosticSnapshot.playerHeight=this.playerInstance.height(),this.currentDiagnosticSnapshot.playerWidth=this.playerInstance.width(),this.currentDiagnosticSnapshot.windowHeight=g?g.height:0,this.currentDiagnosticSnapshot.windowWidth=g?g.width:0,this.currentDiagnosticSnapshot.isFullscreen=this.playerInstance.isFullscreen(),this.currentDiagnosticSnapshot.avgAudioDownloadLatency=mean2(this.audioDownloadLatencies),this.currentDiagnosticSnapshot.avgVideoDownloadLatency=mean2(this.videoDownloadLatencies),this.currentDiagnosticSnapshot.avgAudioDownloadBytes=mean2(this.audioDownloadBytes),this.currentDiagnosticSnapshot.avgVideoDownloadBytes=mean2(this.videoDownloadBytes),this.currentDiagnosticSnapshot.maxVideoDownloadBytes=Math.max.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.minVideoDownloadBytes=Math.min.apply(null,this.videoDownloadBytes),this.currentDiagnosticSnapshot.avgAudioDownloadBandwidth=mean2(this.audioDownloadBandwidths),this.currentDiagnosticSnapshot.avgVideoDownloadBandwidth=mean2(this.videoDownloadBandwidths),this.currentDiagnosticSnapshot.audioDownloadFailureCount=this.audioDownloadFailureCount,this.currentDiagnosticSnapshot.audioDownloadSuccessCount=this.audioDownloadSuccessCount,this.currentDiagnosticSnapshot.videoDownloadFailureCount=this.videoDownloadFailureCount,this.currentDiagnosticSnapshot.videoDownloadSuccessCount=this.videoDownloadSuccessCount,this.currentDiagnosticSnapshot.audioDownloadFailures=this.audioDownloadFailures,this.currentDiagnosticSnapshot.videoDownloadFailures=this.videoDownloadFailures,this.currentDiagnosticSnapshot.totalDownloadedBytes=this.totalDownloadedBytes,this.currentDiagnosticSnapshot.retryFrequency=this.getRetryFrequency(),this.currentDiagnosticSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate();const v=this.getDiagnosticWritableField();return Object.keys(v).forEach((g=>{this.currentDiagnosticSnapshot[g]=v[g]})),this.currentDiagnosticSnapshot}getDiagnosticWritableField(){return{streamUrl:this.currentDiagnosticSnapshot.streamUrl,streamId:this.currentDiagnosticSnapshot.streamId,streamingEventType:this.currentDiagnosticSnapshot.streamingEventType,playerControlsEnabled:this.currentDiagnosticSnapshot.playerControlsEnabled,streamDeliveryPipeline:this.currentDiagnosticSnapshot.streamDeliveryPipeline,retryCount:this.currentDiagnosticSnapshot.retryCount,totalPlayingTimeInSeconds:this.currentDiagnosticSnapshot.totalPlayingTimeInSeconds,bufferingRate:this.currentDiagnosticSnapshot.bufferingRate,videoTrackHistory:this.currentDiagnosticSnapshot.videoTrackHistory,videoTrackTotalDurations:this.currentDiagnosticSnapshot.videoTrackTotalDurations}}dispose(){this.unsubscribeFromPlayerBufferEvents()}registerForPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.addEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}unsubscribeFromPlayerBufferEvents(){this.playerVideoBuffer&&(this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onVideoDownloadCompleted),this.playerVideoBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onVideoDownloadError)),this.playerAudioBuffer&&(this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadcompleted,this.onAudioDownloadCompleted),this.playerAudioBuffer.removeEventListener(this.contextWindow.amp.bufferDataEventName.downloadfailed,this.onAudioDownloadError))}isP2PSdnUsed(){return!!this.sdnName()}sdnName(){const g="options_";return this.playerInstance[g]&&this.playerInstance[g].sdn&&this.playerInstance[g].sdn.name}getStreamType(g){let m="";return this.playerInstance&&(m=this.playerInstance.isLive()?"LIVE":"DVR"),""===m||"LIVE"===g&&m!==g?g||"":m}getCurrentAbsoluteTime(){return this.absoluteTimeOffsetEstimator?this.absoluteTimeOffsetEstimator.absoluteTimeOffset?this.absoluteTimeOffsetEstimator.absoluteTimeOffset+this.playerInstance.currentTime():this.playerInstance.currentTime():this.playerInstance.currentAbsoluteTime()??this.playerInstance.currentTime()}getCurrentAbsoluteTimeOffset(){return this.getCurrentAbsoluteTime()-this.playerInstance.currentTime()}getTotalDurationInSeconds(){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(g.toFixed(0))}onVideoDownloadCompleted(){this.videoDownloadSuccessCount++,this.addToList(this.videoDownloadLatencies,this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.videoDownloadBytes,this.playerVideoBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.videoDownloadBandwidths,8*this.playerVideoBuffer.downloadCompleted.totalBytes*1e3/this.playerVideoBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerVideoBuffer.downloadCompleted.totalBytes}onAudioDownloadCompleted(){this.audioDownloadSuccessCount++,this.addToList(this.audioDownloadLatencies,this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForLatency),this.addToList(this.audioDownloadBytes,this.playerAudioBuffer.downloadCompleted.totalBytes,this.slidingWindowLengthForDownloadBytes),this.addToList(this.audioDownloadBandwidths,8*this.playerAudioBuffer.downloadCompleted.totalBytes*1e3/this.playerAudioBuffer.downloadCompleted.totalDownloadMs,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=this.playerAudioBuffer.downloadCompleted.totalBytes;const g=this.playerAudioBuffer.downloadCompleted.mediaDownload.bitrate;g!==this.lastAudioDownloadBitrate&&(this.lastAudioDownloadBitrate=g)}addToList(g,m,f){g.push(m),g.length>f&&g.shift()}onVideoDownloadError(){this.videoDownloadFailureCount++,this.addDownloadFailureInfo(this.playerVideoBuffer.downloadFailed,this.videoDownloadFailures)}onAudioDownloadError(){this.audioDownloadFailureCount++,this.addDownloadFailureInfo(this.playerAudioBuffer.downloadFailed,this.audioDownloadFailures)}addDownloadFailureInfo(g,m){const f={bitrate:g.mediaDownload.bitrate,errorCode:g.code,mediaTime:g.mediaDownload.mediaTime,message:g.message,timestamp:Date.now()};this.addToList(m,f,this.downloadFailuresLimit)}getAudioStreamData(){const g=this.playerInstance.currentAudioStreamList();if(g)try{const m=g.streams[g.enabledIndices[0]];return{bitrate:m.bitrate,codec:m.codec,enabled:m.enabled,name:m.name,language:m.language}}catch(g){return}}getVideoStreamData(){const g=this.playerInstance.currentVideoStreamList();if(g)try{const m=g.streams[g.selectedIndex],f=this.playerInstance.currentPlaybackBitrate(),mapTrackData=g=>({bitrate:g.bitrate,height:g.height,id:g.id,selectable:g.selectable,width:g.width}),S=m.tracks?m.tracks.map(mapTrackData).find((g=>g.bitrate===f)):null;return{codec:m.codec,name:m.name,currentTrack:S}}catch(g){return}}getLivePosition(){const g=this.playerInstance.buffered();if(0===g.length)return 0;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));return m}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.totalDownloadedBytes){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(g>0)return 8*this.totalDownloadedBytes/g}return 0}getRetryFrequency(){const g=this.currentDiagnosticSnapshot.retryCount;if(this.streamingStartedTimestamp&&g){const m=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(m>0)return g/m}return 0}getAverageMeasuredBandwidth(){if(0===this.videoDownloadBandwidths.length)return null;let g=0;for(let m=0;m<this.videoDownloadBandwidths.length;m++)g+=this.videoDownloadBandwidths[m];return g/this.videoDownloadBandwidths.length}getAverageMeasuredVideoDownloadSize(){if(0===this.videoDownloadBytes.length)return null;let g=0;for(let m=0;m<this.videoDownloadBytes.length;m++)g+=this.videoDownloadBytes[m];return g/this.videoDownloadBytes.length}getPlayerCachedLength(){const g=this.playerInstance.buffered();let m=0;for(let f=0;f<g.length;f++)m+=g.end(f)-g.start(f);return m}getPlayerEdgeLatency(){const g=this.playerInstance.buffered();if(0===g.length)return 0;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));return m-this.playerInstance.currentTime()}}}function CaptionsControlToggleProviderF(){return class{constructor(g,m,f,S){this.player=g,this.toggleListener=m,this.config=f,this.diagnosticProvider=S,this.onTextTrackChanged=this.onTextTrackChanged.bind(this),this.isHtml5Tech="html5"===this.player.currentTechName()?.toLowerCase()}dispose(){this.unsubscribeFromTrackEvents(),this.player=null,this.toggleListener=null}initialize(){const g=this.getPlayerTextTracksAsArray();if(!this.config.controlsEnabled&&g.length>0)g[0].mode="showing";else for(let m=0;m<g.length;m++)g[m].mode="disabled";this.subscribeOnTrackEvents()}addCues(g){const m=this.player.getCurrentTextTrack();if(!m)return;const f=this.getCurrentAbsoluteTime()||1,S=this.getCurrentTime(),v=this.config.controlsEnabled?f-S:Math.max(f-S,0),C=this.isHtml5Tech?window.VTTCue:window.vttjs&&window.vttjs.VTTCue||window.VTTCue;for(let f=0;f<g.length;f++){const{start:S,end:_,text:E}=g[f],T=2,I=new C(Number((S-v).toFixed(T)),Number((_-v).toFixed(T)),E);I.size=100,!this.containsCue(m,I)&&m.addCue(I)}}clearCues(){const g=this.player.getCurrentTextTrack();if(g)try{if(g.activeCues&&g.removeCue)for(;g.activeCues.length>0;)g.removeCue(g.activeCues[0]);const m="setCues_";if(g.cues[m]){g.cues_&&(g.cues_.length=0),g.cues[m]([]);const f=Object.getOwnPropertyNames(g.cues);for(let m=0;m<f.length;m++)"length"!==f[m]&&"length_"!==f[m]&&"cues_"!==f[m]&&delete g.cues[f[m]]}}catch(g){this.config.logFn(`[clearCues]: ${g}`,"warn")}}showCaptions(g){this.config.logFn(`[CaptionsControl]: showCaptions(${g})`),g?this.show():this.hide()}hide(){this.previouslyVisibleTextTrack=this.player.getCurrentTextTrack(),this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="disabled"),this.player.captionToggle&&this.player.captionToggle.hide&&this.player.captionToggle.hide(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.hide&&this.player.MoreOptionscaptionSubtitleButton.hide(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.hide&&this.player.MoreOptionscaptionSettingsButton.hide()}show(){this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="showing"),this.player.captionToggle&&this.player.captionToggle.show&&this.player.captionToggle.show(),this.player.MoreOptionscaptionSubtitleButton&&this.player.MoreOptionscaptionSubtitleButton.show&&this.player.MoreOptionscaptionSubtitleButton.show(),this.player.MoreOptionscaptionSettingsButton&&this.player.MoreOptionscaptionSettingsButton.show&&this.player.MoreOptionscaptionSettingsButton.show()}subscribeOnTrackEvents(){const g=this.player.textTracks(),m="addEventListener";g&&g[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}unsubscribeFromTrackEvents(){const g=this.player.textTracks(),m="removeEventListener";g&&g[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.isHtml5Tech&&this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}onTextTrackChanged(){const g=this.player.getCurrentTextTrack();if(!g||!this.currentTextTrack||this.currentTextTrack.label!==g.label||this.currentTextTrack.mode!==g.mode){if(g||this.currentTextTrack){const m=!!g&&"showing"===g.mode,f=this.getCulture(g||this.currentTextTrack),S=this.getCurrentTime();this.toggleListener.captionsToggled(m,f,S),this.config.logFn(`[CaptionsControl]: track changed: culture '${f}', timestamp '${S}'`)}this.currentTextTrack=g}}onAddTrack(g){const m=g?.track;"captions"===m?.kind&&!m.label&&!m.id&&(this.player?.textTracks_?.removeTrack_(m),this.config.logFn("[CaptionsControl]: removing default empty text track"))}getCurrentTime(){return this.isHtml5Tech?this.player.currentTime():(this.config.controlsEnabled?this.player.currentTime():this.player.currentMediaTime())||1}getCurrentAbsoluteTime(){return this.diagnosticProvider.getCurrentAbsoluteTime()}getCulture(g){if(!g)return"";if(g.id){const m=g.id.split("_")[1];if(m)return m}return""}getPlayerTextTracksAsArray(){const g=this.player.textTracks();return g&&g["tracks_"]||[]}containsCue(g,m){return Array.from(g?.cues||[]).some((g=>this.areCueEquals(g,m)))}areCueEquals(g,m){function getCueField(g){return{start:g.start?g.start:g.startTime,end:g.end?g.end:g.endTime,text:g.text}}const f=getCueField(g),S=getCueField(m);return f.start===S.start&&f.end===S.end&&f.text===S.text}}}function initIFrame(){const g=IFrameMessageHandlerF(),m=AmpCommunicationHandlerF(),f=new g,S=new m(f,document.body);f.registerObserver(S)}function buildAmpEmbeddedSrc(){let g=`(${initIFrame.toString()})();`;return g+=AmpPlayerF.toString()+";",g+=IFrameMessageHandlerF.toString()+";",g+=AmpCommunicationHandlerF.toString()+";",g+=CaptionsControlToggleProviderF.toString()+";",g+=AmpDiagnosticProviderF.toString()+";",g+=HlsAbsoluteTimeOffsetEstimatorF.toString()+";",g+=HlsFileParserF.toString()+";",g+="//# sourceURL=TsCallingAmpPlayer.js",g}function HlsPlayerF(){const g=HlsDiagnosticProviderF(),m=CaptionsControlToggleProviderF2(),f=HlsMediaF(),S=Html5MediaF(),v=HlsLatencyProcessorF(),C=HlsLoggerF(),_=HlsFileParserF2(),E={length:0,start:()=>0,end:()=>0},T={toString:function(g){let m="";const f=g.length;for(let S=0;S<f;S++)m+=`[${g.start(S).toFixed(3)}-${g.end(S).toFixed(3)}]`;return m},range:g=>g&&0!==g.length?[g.start(g.length-1),g.end(g.length-1)]:[0,0],prevRange:g=>{if(g&&2===g.length)return[g.start(g.length-2),g.end(g.length-2)]}};let I;var b;return(b=I||(I={})).PlayerStallTimeout="PlayerStallTimeout",b.CaptionFunctionalityNotSupported="CaptionFunctionalityNotSupported",b.LowBufferReserve="LowBufferReserve",class{constructor(g,m){this.container=g,this.eventsHandler=m,this.maxMemoryTraceLogCount=1e4,this.sdnLoaded=!1,this.thaLoaded=!1,this.statsTimer=-1,this.statsInterval=1e3,this.latencyFetchInterval=2e3,this.latencyTimer=-1,this.stallingTimeoutId=-1,this.videoSourceSetAttemptCount=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[],this.lastPlayTime=-1,this.bufferCheckInterval=-1,this.lastBufferWarnTime=-1,this.lastSetSourceTime=-1,this.streamStartTime=new Map,this.streamOffset=new Map,this.isPlayedFromPrimary=!0,this.hlsFileParser=new _(this.log.bind(this))}getCurrentAbsoluteTimeOffset(){return this.getCachedOffset(!1)??(this.media?.getCurrentAbsoluteTimeOffset?.()||0)}getOffsetBasedOfStreamStartTime(g,m){return(m-this.streamStartTime.get(g))/1e3}get contextWindow(){return this.container.ownerDocument.defaultView}getIceCandidates(){throw new Error("Method not implemented.")}configure(g,m,f){this.liveStreamOptions=g,this.configProvider=m,this.playerId=f,this.statsInterval=m.config.playerTelemetryTickMs||this.statsInterval,this.maxMemoryTraceLogCount=m.config.maxPlayerMemoryTraceLogCount||this.maxMemoryTraceLogCount}loadPlayerScript(){const getPlayerSrc=g=>m[g%m.length];this.log("loadPlayerScript started");const g=this.configProvider.playerConfig?.nonce,m=this.configProvider.playerConfig?.src||[],f=m.length;if(0===f)return Promise.reject("HLS Player Src is empty");const S=1,v=S*f,C=2,_=C*f,E=Math.max(2,this.configProvider.config.maxRetryCountForLoadingResources-C-S)*f;return this.retry((m=>{const f=getPlayerSrc(m);return this.setScriptByLoad(this.container.ownerDocument,f,g)}),E).catch((()=>this.retry((m=>{const f=getPlayerSrc(m);return this.setSrciptByBlob(this.container.ownerDocument,f,g)}),_))).catch((f=>this.retry((m=>{const f=getPlayerSrc(m);return this.setScriptByInnerHtml(this.container.ownerDocument,f,g)}),v).then((g=>g=g.concat(`, Previous BlobFetchFailure: ${f}`))).catch((S=>{let C=`Failed to load script, nonce:${g}, src: `;return m.forEach((g=>C=C.concat(g,","))),C=C.concat(` ${E} attempts BlobFetchFailure: `,f,`, ${v} attempts InnerHtmlFailure: `,S),Promise.reject(C)})))).then((g=>(this.log(`loadScript result:${g}`),g)))}tryLoadSdnPlugin(){return this.sdnLoaded||!this.liveStreamOptions.sdn?Promise.resolve():this.configProvider.config.allowSdnPlugins?(this.log("tryLoadSdn started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.url,this.configProvider.playerConfig.nonce))).then((()=>(this.log("SDN script loaded"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.liveStreamOptions.sdn.plugin,this.configProvider.playerConfig?.nonce))).then((()=>{this.log("SDN plugin loaded"),this.sdnLoaded=!0,this.log("tryLoadSdn done")}))))).then((()=>Promise.resolve())).catch((g=>Promise.reject(g)))):(this.log("Loading SDN plugins is not allowed"),Promise.reject(new Error("Loading SDN plugins is not allowed")))}tryLoadThaPlugin(){return this.thaLoaded?Promise.resolve():(this.log("tryLoadTha started"),this.retry((()=>this.setScriptByLoad(this.container.ownerDocument,this.configProvider.config.hlsSettings.thaScript,this.configProvider.playerConfig.nonce))).then((()=>{this.thaLoaded=!0,this.log("THA script loaded")})).then((()=>Promise.resolve())).catch((g=>Promise.reject(g))))}createHls(){if(this.log("createHls started"),this.contextWindow.define=this.tempDefine,this.createVideoElement(),this.contextWindow.Hls.isSupported())this.media=new f(this.video,this.contextWindow,this.log.bind(this),this.getHlsConfig(),this.playerId,this.configProvider);else{if(!this.video.canPlayType("application/vnd.apple.mpegurl")){const g="Your browser cannot support HLS streaming";throw this.log(`Error: ${g}`,"error"),new Error(g)}this.video.autoplay=!0,this.media=new S(this.video,this.log.bind(this),this.configProvider,this.onAbsoluteTimeOffsetEstimation.bind(this))}this.diagnosticProvider=new g(this.media.getPlayer?.(),this.contextWindow,this.video,this.media,new Date,this),this.addCaptionsTracks(this.liveStreamOptions.supportedSubtitleLanguages);const C={controlsEnabled:!this.isControlsDisabled(),logFn:this.log.bind(this),removeEmptyDefaultTextTrack:this.configProvider.config.removeEmptyDefaultTextTrack};this.captionsControl=new m(this.video,this,C,this.diagnosticProvider),this.latencyTraceProcessor=new v(this.video,this.diagnosticProvider,this.log.bind(this)),this.diagnosticProvider.setValue("streamingEventType",this.liveStreamOptions.streamingEventType),this.diagnosticProvider.setValue("playerControlsEnabled",!this.isControlsDisabled()),this.registerMediaEvents(),this.initialState=!0,this.log("createHls done")}isControlsDisabled(){return void 0!==this.liveStreamOptions.allowPlayerControls?!this.liveStreamOptions.allowPlayerControls:"Overflow"===this.liveStreamOptions.streamingEventType||"TownHall_Basic"===this.liveStreamOptions.streamingEventType||"TownHall_Premium"===this.liveStreamOptions.streamingEventType||"TownHall"===this.liveStreamOptions.streamingEventType}setSource(g,m){if(this.log(`setSource started isPrimary:${m}`),!this.media)throw this.log("setSource failed: playerInstance is null","error"),new Error("playerInstance is null");this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1),this.diagnosticProvider.setValue("streamUrl",g.url),this.streamId=this.getStreamIdFromStreamUrl(g.url),this.diagnosticProvider.setValue("streamId",this.streamId),this.diagnosticProvider.setValue("streamDeliveryPipeline",g.streamDeliveryPipeline||""),this.streamOffset.clear(),this.media.setSource(g),this.isPlayedFromPrimary=m,this.lastSetSourceTime=Date.now(),this.latencyTraceProcessor.updateLatencyTraceFileUrl(g.url),this.configureSdnSource(g),this.currentStreamingUrl=g.url,this.enableBufferHealthCheck()}getStallDetectionPolicy(){const g=this.configProvider.config.hlsSettings.stallDetectionPolicy;return{waitAfterSourceSet:g?.waitAfterSourceSet??3e4,waitAfterLastWarning:g?.waitAfterLastWarning??12e4,minimumBufferThreshold:g?.minimumBufferThreshold??4,maximumBufferThreshold:g?.maximumBufferThreshold??44,boundaryThreshold:g?.boundaryThreshold??1,maximumLatency:g?.maximumLatency??60,healthCheckFrequency:g?.healthCheckFrequency??8e3}}enableBufferHealthCheck(){self.clearInterval(this.bufferCheckInterval);const g=this.getStallDetectionPolicy();this.bufferCheckInterval=self.setInterval((()=>{const m=this.diagnosticProvider.getPlayerEdgeLatency();if(this.isLowOnBuffer(m,g)){const f=this.canPerformSwitching(g);f&&(this.lastBufferWarnTime=Date.now(),self.clearTimeout(this.stallingTimeoutId),this.stallingTimeoutId=-1);const S=this.getBuffered(this.video),v=this.diagnosticProvider.getPlayerBufferedLength();this.log(`Sending LowReserve warning latency:${m.toFixed(3)}, currTime:${this.video.currentTime}, buff:${S}, buffLen: ${v}`);const C=this.addEvent("LowBufferReserve",{detail:{data:{shouldSwitch:f,fatal:!0,details:`latency:${m.toFixed(3)}, buff:${S}, currTime:${this.video.currentTime}, buffLen: ${v}, lastBufferWarnTime:${this.lastBufferWarnTime}, lastSetSourceTime:${this.lastSetSourceTime}, video.readyState: ${this.video.readyState}, bufferingRate: ${this.diagnosticProvider.getValue("bufferingRate")}`}}});this.video.dispatchEvent(C)}}),g.healthCheckFrequency)}canPerformSwitching(g){const m=-1===this.lastBufferWarnTime?g.waitAfterSourceSet:g.waitAfterLastWarning;return Date.now()-Math.max(this.lastBufferWarnTime,this.lastSetSourceTime)>m}isLowOnBuffer(g,m){const f=T.range(this.video.buffered),S=Math.round(this.video.currentTime),v=Math.round(f[0]),C=Math.round(f[1]),_=Math.round(C-S);if(S+m.boundaryThreshold<v){const g=T.prevRange(this.video.buffered);if(!g)return!0;const f=Math.round(g[0]),C=Math.round(g[1]);return!(S>=f&&v-C<=m.boundaryThreshold)&&!(S>=f&&C-S>2*m.minimumBufferThreshold)}return _<=m.minimumBufferThreshold||g<0||g>m.maximumLatency||_>m.maximumBufferThreshold}switchStreamingUrl(g,m){if(!this.media)throw this.log(`setSource failed: playerInstance is null isPrimary:${m}`,"error"),new Error("playerInstance is null");const f=this.diagnosticProvider.getPlayerEdgeLatency();!this.isLowOnBuffer(f,this.getStallDetectionPolicy())&&this.video.readyState>2?this.log("Not switching as video is building","warn"):(this.videoSourceSetAttemptCount++,this.videoSourceSetAttemptCount>0&&this.diagnosticProvider.setValue("retryCount",this.videoSourceSetAttemptCount-1),this.latencyTraceProcessor.updateLatencyTraceFileUrl(g.url),this.diagnosticProvider.setValue("streamUrl",g.url),this.lastPlayTime=this.video.currentTime+this.getCurrentAbsoluteTimeOffset(),this.streamId=this.getStreamIdFromStreamUrl(g.url),this.diagnosticProvider.setValue("streamId",this.streamId),this.streamOffset.clear(),this.media.switchStreamingUrl(g),self.clearTimeout(this.stallingTimeoutId),this.stallingTimeoutId=-1,this.isPlayedFromPrimary=m,this.lastSetSourceTime=Date.now(),this.currentStreamingUrl=g.url,this.enableBufferHealthCheck(),this.initialState=!0)}onAbsoluteTimeOffsetEstimation(g){if(!g.isSuccess){const g=this.addEvent("CaptionFunctionalityNotSupported",{detail:{data:{fatal:!0,details:"absolute time offset estimation failed - captions will fail"}}});this.video.dispatchEvent(g)}g.isSuccess&&this.findResumeTime(!1)}getStreamIdFromStreamUrl(g){try{const m=new URL(g).pathname;if(m){const g=m.split("/");if(g?.length>1)return g[1]}return this.log(`unable to parse stream ID from stream URL: ${g}`,"warn"),""}catch{return this.log(`cannot parse stream ID from invalid stream URL: ${g}`,"warn"),""}}setPlayTime(g){g>this.video.currentTime&&(this.log(`setPlayerTime: ${g}`),this.video.currentTime=g)}dispose(){this.log("dispose started"),self.clearInterval(this.bufferCheckInterval),this.contextWindow.navigator.connection?.onchange&&(this.contextWindow.navigator.connection.onchange=null),this.diagnosticProvider&&(this.stopStatsColletion(),this.diagnosticProvider.dispose(),this.diagnosticProvider=null),this.media&&(this.media.destroy(),this.media=null),this.eventsHandler.hlsDisposed(),this.latencyTraceProcessor&&(this.stopLatencyCollection(),this.latencyTraceProcessor=null),this.video?.parentNode&&(this.video.parentNode.removeChild(this.video),this.video=null),this.log("dispose done"),this.eventsHandler=null}updatePlaybackDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}handlePlaybackStopped(){this.isBuffering=!1,this.isPlaying=!1,this.currentVideoPlaybackBitrate=null}showCaptions(g){this.log(`showCaptions: ${g}`),this.captionsControl.showCaptions(g)}addCues(g){this.captionsControl.addCues(g)}clearCues(){this.captionsControl.clearCues()}captionsToggled(g,m,f){this.log(`captionsToggled: ${g} for culture ${m} at ${f}`),this.eventsHandler.message("captionsToggled").send(g,m,f)}getHlsConfig(){const g=this.configProvider.config.debug||!1;let m={autoStartLoad:!1,debug:this.configProvider.config.capturePlayerLogs?new C(this.log.bind(this),g):g,nudgeOffset:.5,nudgeMaxRetry:6,maxBufferLength:60,liveSyncDuration:16,liveMaxLatencyDuration:20,maxLiveSyncPlaybackRate:1.1,fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e3,maxLoadTimeMs:1500,timeoutRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3},errorRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e3,maxLoadTimeMs:1500,timeoutRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3},errorRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e3,maxLoadTimeMs:1500,timeoutRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3},errorRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3}}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:1e3,maxLoadTimeMs:1500,timeoutRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3},errorRetry:{maxNumRetry:3,retryDelayMs:500,maxRetryDelayMs:1e3}}},liveDurationInfinity:!0,startFragPrefetch:!0,stretchShortVideoTrack:!0,lowLatencyMode:!0,abrEwmaDefaultEstimate:26e5};if(this.configProvider.config.hlsSettings.hlsConfig){const g=this.validateHlsConfig(this.contextWindow.Hls.DefaultConfig,this.configProvider.config.hlsSettings.hlsConfig);m=this.deepMerge(m,g),this.log(`Applying HLS config: ${JSON.stringify(m)}`)}return m}validateHlsConfig(g,m){const f=Object.keys(g),S=Object.keys(m).filter((g=>!f.includes(g)));S.length>0&&this.log(`The following invalid properties in the custom HLS config will be ignored: ${S.join(", ")}`);return Object.keys(m).filter((g=>f.includes(g))).reduce(((f,S)=>(f[S]=m[S],"object"==typeof m[S]&&null!==m[S]&&(f[S]=this.validateHlsConfig(g[S],m[S])),f)),{})}deepMerge(g,m){const f=Object.assign({},g);if(this.isObject(g)&&this.isObject(m))for(const S in m)this.isObject(m[S])?S in g?f[S]=this.deepMerge(g[S],m[S]):Object.assign(f,{[S]:m[S]}):Object.assign(f,{[S]:m[S]});return f}isObject(g){return g&&"object"==typeof g&&!Array.isArray(g)}createVideoElement(){this.log("createVideoElement started"),this.video=this.container.ownerDocument.createElement("video"),this.video.controls=!this.isControlsDisabled(),this.video.id="hls-player",this.video.setAttribute("playsinline","");const g=this.configProvider.playerConfig?.lang;g&&(this.video.setAttribute("lang",g),this.log(`createVideoElement: language set to ${g}`));const m=this.configProvider.playerConfig?.styles||[];for(let g=0;g<m.length;g++)this.video.classList.add(m[g]);this.video.style.width="100%",this.video.style.height="100%",this.video.muted=this.configProvider.playerConfig?.muteVideo??!1,this.video.addEventListener("contextmenu",(function(g){g.preventDefault()})),this.container.appendChild(this.video),this.log("createVideoElement done")}addCaptionsTracks(g){this.isControlsDisabled()?(this.log('addCaptionsTracks for "default-text-track"',"info"),this.video.addTextTrack("captions","default-text-track","en")):g&&g.forEach((g=>{this.log(`addCaptionsTracks for ${g.name}`),this.video.addTextTrack(this.configProvider.config.textTrackKind,g.name,g.culture)}))}configureThaPlugin(){if(this.thaLoaded&&this.contextWindow.tha)try{this.contextWindow.tha.configure(this.liveStreamOptions.thaContext)}catch(g){this.log(`configureTha failed with error: ${g}`,"error")}}configureSdnSource(g){if(!this.sdnLoaded||!this.liveStreamOptions.sdn)return;const m=this.liveStreamOptions.sdn.name;if(g?.sdnContext)try{const f=JSON.parse(g.sdnContext);if(f.streamingPlatformEventId){const g=/^19:meeting_/,m=/@thread\.v2$/;f.streamingPlatformEventId=decodeURIComponent(f.streamingPlatformEventId),f.streamingPlatformEventId=f.streamingPlatformEventId.replace(g,"PE:").replace(m,"")}switch(f.RTCIceCandidates&&(f.RTCIceCandidates=f.RTCIceCandidates.map((g=>new RTCIceCandidate(JSON.parse(g))))),m){case"peer5":case"microsoft":this.contextWindow.peer5.configure(f);break;default:return void this.log(`configureSdnSource failed, error: Unknown SDN Name: ${m}`,"error")}}catch(g){this.log(`configureSdnSource failed for ${m}, error: ${g}`,"error")}else this.log(`configureSdnSource failed, error: SDN context for ${m} is null`,"error")}log(g,m="info"){const f=`${`[HlsPlayer${1===this.configProvider.config.loadType?"IFrame":""}]`}: ${g}`;this.configProvider.config.debug&&console.log(f),this.eventsHandler.message("log").send(m,f)}getElementLoadPromise(g,m){return new Promise(((f,S)=>{g.onload=()=>f(),g.onerror=()=>S(`[getElementLoadPromise] Failed to load script: ${m}`)}))}setScriptByLoad(g,m,f){const S=g.createElement("script"),v=this.getElementLoadPromise(S,m);return S.src=m,f&&(S.nonce=f),g.defaultView.define&&(this.tempDefine=g.defaultView.define,g.defaultView.define=null),g.head.appendChild(S),v.then((()=>Promise.resolve("Success: setScriptByLoad")))}setSrciptByBlob(g,m,f){return this.safeResponse(m).then((m=>m.blob().then((S=>{if(S){const m=URL.createObjectURL(S);return this.setScriptByLoad(g,m,f).then((()=>Promise.resolve("Success: setSrciptByBlob")))}return Promise.reject(`${m.status}, blob is null`)}))))}setScriptByInnerHtml(g,m,f){return this.safeResponse(m).then((m=>m.text().then((S=>{if(S){const m=document.createElement("script");return m.innerHTML=S,f&&!this.configProvider.config.hlsSettings.skipNonce&&(m.nonce=f),g.head.appendChild(m),Promise.resolve("Success: setScriptByInnerHtml")}return Promise.reject(`status code:${m.status}, text is null`)}))))}safeResponse(g){return fetch(g).then((g=>g.ok?g:Promise.reject(`${g.status}`)))}retry(g,m=this.configProvider.config.maxRetryCountForLoadingResources,f=200){return g(m).catch((S=>{if(this.log(`Error loading resource: ${S} -- ${m} retriesLeft`),0==--m)return Promise.reject(`${S}`);let v=this.configProvider.config.hlsSettings.switchingPolicy?.minimumRetryDelay??f;return v=Math.max(f,v),new Promise((f=>setTimeout((()=>f(this.retry(g,m).catch((g=>Promise.reject(`${S}`.concat(", ",g)))))),v)))}))}initializeStatsColletion(){this.statsTimer=window.setInterval((()=>{this.updatePlaybackDiagnostics(),this.eventsHandler&&this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics())}),this.statsInterval),this.contextWindow.peer5&&this.configProvider.config.debug&&this.contextWindow.peer5.showStats()}stopStatsColletion(){this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),-1!==this.statsTimer&&window.clearInterval(this.statsTimer),this.statsTimer=-1}initHlsLatencyCollection(){this.latencyTimer=window.setInterval((()=>{this.latencyTraceProcessor.fetchLatencyContent()}),this.latencyFetchInterval)}stopLatencyCollection(){-1!==this.latencyTimer&&window.clearInterval(this.latencyTimer),this.latencyTimer=-1,this.latencyTraceProcessor=-1}updateVideoTrackHistoryStatistic(){const g=new Date;if(this.currentVideoPlaybackBitrate){const m=this.diagnosticProvider.getValue("videoTrackHistory"),f=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(m.length>0&&this.currentVideoPlaybackBitrate===m[m.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,m[m.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const S=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),v=f.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));S&&v&&(S.totalDurationInSeconds+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,v.totalDurationInSeconds=Number(S.totalDurationInSeconds.toFixed(0)))}}else{m.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:g.getTime(),trackSwitchMeasuredBandwidth:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredBandwidth():null,trackSwitchMeasuredByteSize:this.diagnosticProvider?this.diagnosticProvider.getAverageMeasuredVideoDownloadSize():null,trackSwitchPerceivedBandwidth:this.diagnosticProvider?this.diagnosticProvider.getPerceivedBandwidth():null,trackSwitchEstimatedTTFB:this.diagnosticProvider?this.diagnosticProvider.getEstimatedTTFB():null,durationInSeconds:0}),this.latestVideoTrackDuration=0,m.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&m.splice(0,1);const S=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));if(!S){const g={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},m={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(g),f.push(m)}}}this.videoTrackHistoryUpdatedTimestamp=g}updateTotalPlayingTimeStatistic(){const g=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=g.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=g,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const g=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=g.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=g;const m=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(m.toFixed(3)))}getPlayerDiagnostics(){const g=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return g&&(g.statsInterval=this.statsInterval),g}registerMediaEvents(){const g={passive:!0};this.video.addEventListener("seeking",(()=>{this.onHlsEvent("seeking")}),g),this.video.addEventListener("seeked",(()=>{const g=this.diagnosticProvider.getCurrentAbsoluteTime();this.onHlsEvent("seeked",{captionsTimestamp:g})}),g),this.video.addEventListener("pause",(()=>{this.onHlsEvent("pause")}),g),this.video.addEventListener("play",(()=>{this.onHlsEvent("play")}),g),this.video.addEventListener("playing",(()=>{this.onHlsEvent("playing"),this.initialState&&(this.onHlsEvent("start"),this.initialState=!1),-1!==this.stallingTimeoutId&&(self.clearTimeout(this.stallingTimeoutId),this.stallingTimeoutId=-1)}),g),this.video.addEventListener("canplaythrough",(()=>{this.findResumeTime(!0),this.onHlsEvent("canplaythrough")}),g),this.video.addEventListener("loadstart",(()=>{this.onHlsEvent("loadstart")}),g),this.video.addEventListener("loadeddata",(()=>{this.onHlsEvent("loadeddata"),this.video.readyState>=2&&(this.video.play(),this.initializeStatsColletion(),this.initHlsLatencyCollection())}),g),this.video.addEventListener("loadedmetadata",(()=>{this.onHlsEvent("loadedmetadata")}),g),this.video.addEventListener("volumechange",(()=>{this.onHlsEvent("volumechange",{value:this.video.volume})}),g),this.video.addEventListener("waiting",(()=>{const g=`Player stalling at ${this.video.currentTime}, Buffered range: ${this.getBuffered(this.video)}, latency:${this.diagnosticProvider.getPlayerEdgeLatency()}, lastBufferWarnTime:${this.lastBufferWarnTime}, lastSetSourceTime:${this.lastSetSourceTime}, buffLen: ${this.diagnosticProvider.getPlayerBufferedLength()}, video.readyState: ${this.video.readyState}, bufferingRate: ${this.diagnosticProvider.getValue("bufferingRate")}, url:${this.currentStreamingUrl}`;this.onHlsEvent("waiting",{message:g}),this.log(g,"debug"),-1===this.stallingTimeoutId&&(this.stallingTimeoutId=self.setTimeout((()=>this.getSegmentStallDetail().then((g=>this.handleWaitingEvent(g)),(g=>this.handleWaitingEvent(g)))),this.configProvider.config.hlsSettings.timeoutForSwitchingUrl))}),g),this.video.addEventListener("stalled",(()=>{this.onHlsEvent("stalled")}),g),this.video.addEventListener("ended",(()=>{this.video.currentTime=0,this.onHlsEvent("ended")}),g),this.video.addEventListener(this.contextWindow.Hls.Events.LEVEL_SWITCHED,(g=>{this.onHlsEvent("playbackbitratechanged",g.detail),this.onHlsEvent("downloadbitratechanged",g.detail)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorTypes.NETWORK_ERROR,(g=>{this.diagnosticProvider.registerForPlayerFragDownloadEvents(g)}),g),this.video.addEventListener(this.contextWindow.Hls.Events.KEY_LOADING,(g=>{this.onHlsEvent("hlsKeyLoading",g.detail.relurl)}),g),this.video.addEventListener(this.contextWindow.Hls.Events.KEY_LOADED,(()=>{this.onHlsEvent("hlsKeyLoaded")}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.KEY_LOAD_ERROR,(g=>{this.onHlsEvent("hlsKeyLoadedFailed",g.detail.data.error.message)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.KEY_LOAD_TIMEOUT,(g=>{this.onHlsEvent("hlsKeyLoadedFailed",g.detail.data.error.message)}),g),this.video.addEventListener(this.contextWindow.Hls.Events.MANIFEST_LOADING,(()=>{this.onHlsEvent("hlsManifestLoading")}),g),this.video.addEventListener(this.contextWindow.Hls.Events.MANIFEST_LOADED,(()=>{this.onHlsEvent("hlsManifestLoaded")}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.MANIFEST_LOAD_ERROR,(g=>{const m={currentTime:this.video?this.video.currentTime:0,message:g.detail.data.details,type:g.type,errorCode:0,fatal:g.detail.data.fatal,rawData:JSON.stringify(g.detail.data)};this.onHlsEvent("hlsManifestLoadedFailed",m)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT,(g=>{const m={currentTime:this.video?this.video.currentTime:0,message:g.detail.data.details,type:g.type,errorCode:0,fatal:g.detail.data.fatal,rawData:JSON.stringify(g.detail.data)};this.onHlsEvent("hlsManifestLoadedFailed",m)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.MANIFEST_PARSING_ERROR,(g=>{const m={currentTime:this.video?this.video.currentTime:0,message:g.detail.data.details,type:g.type,errorCode:0,fatal:g.detail.data.fatal,rawData:JSON.stringify(g.detail.data)};this.onHlsEvent("hlsManifestLoadedFailed",m)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_ERROR,(g=>{this.onHlsEvent("hlsFirstFragmentLoadFailed",g.detail.data.error.message)}),g),this.video.addEventListener(this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_TIMEOUT,(g=>{this.onHlsEvent("hlsFirstFragmentLoadFailed",g.detail.data.error.message)}),g),this.video.addEventListener(this.contextWindow.Hls.Events.FRAG_LOADING,(()=>{this.onHlsEvent("hlsFragLoading")}),g),this.video.addEventListener(this.contextWindow.Hls.Events.FRAG_BUFFERED,(()=>{this.onHlsEvent("hlsFragBuffered")}),g),Object.keys(this.contextWindow.Hls.ErrorTypes).forEach((m=>{this.video.addEventListener(this.contextWindow.Hls.ErrorTypes[m],(g=>this.emitPlaybackError(g)),g)})),Object.values(I).forEach((m=>{this.video.addEventListener(m,(g=>{this.handleUserExperienceErrorEvent(m,g)}),g)})),this.video.addEventListener(this.contextWindow.Hls.Events.FRAG_LOADED,(g=>{this.diagnosticProvider.registerForPlayerFragDownloadEvents(g)}),g),this.contextWindow.addEventListener("offline",(()=>this.onHlsEvent("offline"))),this.contextWindow.addEventListener("online",(()=>this.onHlsEvent("online"))),this.contextWindow.navigator.connection?.onchange&&(this.contextWindow.navigator.connection.onchange=()=>{const g={effectiveType:this.contextWindow.navigator.connection.effectiveType,rtt:this.contextWindow.navigator.connection.rtt,downlink:this.contextWindow.navigator.connection.downlink,saveData:this.contextWindow.navigator.connection.saveData,latency:this.diagnosticProvider.getPlayerEdgeLatency(),buffLen:this.diagnosticProvider.getPlayerBufferedLength(),lastBufferWarnTime:this.lastBufferWarnTime,lastSetSourceTime:this.lastSetSourceTime,bufferRange:this.getBuffered(this.video),videoState:this.video.readyState,bufferingRate:this.diagnosticProvider.getValue("bufferingRate")};this.onHlsEvent("networkChange",g)})}findResumeTime(g){const m=this.getCachedOffset(g);if(g===this.contextWindow.Hls.isSupported()&&-1!==this.lastPlayTime&&this.video.buffered?.length){const g=this.lastPlayTime;this.lastPlayTime=-1;const f=T.range(this.video.buffered),S=g-m;let v=S;const C=5;if(v<f[0]||v>f[1]+C){let g=0;g=v<f[0]?.9:.7,v=f[0]*g+f[1]*(1-g)}this.log(`lastPlayTime:${g}, newOffset:${m}, computedResumeTime:${S}, buff:${this.getBuffered(this.video)}, resumePlayTime:${v}`),this.setPlayTime(v)}}getCachedOffset(g){if(!this.configProvider.config.hlsSettings.enableOffsetComputeBasedOfStreamTime)return this.media?.getCurrentAbsoluteTimeOffset?.()||0;if(g===this.contextWindow.Hls.isSupported()&&!this.streamOffset.has(this.streamId)){const g=this.contextWindow.Hls.isSupported()&&this.video.buffered.length>0?this.video.buffered.start(0):0,m=Math.max(this.media?.getCurrentAbsoluteTimeOffset?.()||0-g,0),f=Date.now();if(this.streamStartTime.has(this.streamId)||this.streamStartTime.set(this.streamId,f-1e3*m),!this.isPlayedFromPrimary&&2===this.streamStartTime.size){const g=Array.from(this.streamStartTime.keys());for(let m=0;m<g.length;m++)if(g[m]!==this.streamId){const S=g[m],v=this.getOffsetBasedOfStreamStartTime(S,f);this.streamOffset.set(this.streamId,v)}}if(this.isPlayedFromPrimary){const g=this.getOffsetBasedOfStreamStartTime(this.streamId,f);this.streamOffset.set(this.streamId,g)}this.streamOffset.has(this.streamId)||this.streamOffset.set(this.streamId,m)}return this.streamOffset.get(this.streamId)}emitPlaybackError(g){const m=g.type,f=g.detail.data.details,S={currentTime:this.video?this.video.currentTime:0,message:f,type:m,errorCode:0,fatal:g.detail.data.fatal,rawData:JSON.stringify(g.detail.data)};this.diagnosticProvider.setError(f,m),this.onHlsEvent("error",S)}handleUserExperienceErrorEvent(g,m){const f={currentTime:this.video?this.video.currentTime:0,message:m.detail.data.details,type:g,fatal:m.detail.data.fatal,errorCode:0,rawData:JSON.stringify(m.detail.data),shouldSwitch:m.detail.data.shouldSwitch};this.updatePlaybackDiagnostics(),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send("error",f)}onHlsEvent(g,m){if("loadedmetadata"===g)this.captionsControl.initialize();this.updatePlaybackDiagnostics(),this.updatePlayerState(g,m),this.eventsHandler.message("statsUpdated").send(this.getPlayerDiagnostics()),this.eventsHandler.message("stateChanged").send(g,m)}updatePlayerState(g,m){this.updatePlayingState(g,m),this.updateBufferingState(g,m),this.updateCurrentVideoTrackBitrate(g,m),("ended"===g||"error"===g&&m.fatal)&&this.handlePlaybackStopped()}updatePlayingState(g,m){this.isPlaying?("pause"===g||"seeking"===g||"ended"===g||"error"===g&&m.fatal||"waiting"===g)&&(this.isPlaying=!1):"playing"===g&&(this.isPlaying=!0)}updateBufferingState(g,m){this.isBuffering?("pause"===g||"seeking"===g||"ended"===g||"error"===g&&m.fatal||"playing"===g)&&(this.isBuffering=!1):"waiting"===g&&(this.isBuffering=!0)}updateCurrentVideoTrackBitrate(g,m){"playbackbitratechanged"===g&&m.bitrate!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=m.bitrate,this.updateVideoTrackHistoryStatistic())}handleWaitingEvent(g){if(-1!==this.stallingTimeoutId){this.stallingTimeoutId=-1;let m="";try{m=JSON.stringify(g,Object.getOwnPropertyNames(g))}catch(g){m=JSON.stringify(g,Object.getOwnPropertyNames(g))}if(this.shouldSkipRecovery())return;const f=`Player stall timeout at ${this.video.currentTime}, Buffered range: ${this.getBuffered(this.video)}, latency:${this.diagnosticProvider.getPlayerEdgeLatency()}, lastBufferWarnTime:${this.lastBufferWarnTime}, lastSetSourceTime:${this.lastSetSourceTime}, buffLen: ${this.diagnosticProvider.getPlayerBufferedLength()}, stallDetail: ${m}`;this.log(f,"debug");const S=this.addEvent("PlayerStallTimeout",{detail:{data:{fatal:!0,details:f}}});this.video.dispatchEvent(S)}}getPlaylistUrl(){const g=this.media?.getCurrentPlaylistUrl?.();return g?Promise.resolve(g):this.hlsFileParser.getStreamRenditionsUrlsFromManifest(this.currentStreamingUrl).then((g=>0===g.length?Promise.reject(new Error(`Unable to retrieve renditions URLs from manifest: ${this.currentStreamingUrl}`)):Promise.resolve(g[0])))}getLastSegmentInfo(g){return this.hlsFileParser.getTextFileContent(g).then((m=>{if(0===m.length)return Promise.reject(new Error(`Empty playlist, playlistUrl: ${g}`));const f=this.hlsFileParser.getHlsFieldByName("TargetDuration",m);if(1!==f.length||!Number.isInteger(Number(f[0])))return Promise.reject(new Error(`Invalid targetDuration:${f[f.length-1]} from playlistUrl: ${g}`));const S=m.split("\n");let v="";for(let m=S.length-1;m>=0;m--)if(v=S[m],!v.startsWith("#"))return{segmentName:v,playlistUrl:g,targetDuration:Number(f[0])};return Promise.reject(new Error(`Invalid segment: ${v}, playlistUrl: ${g}`))}))}getSegmentStallDetail(){return this.getPlaylistUrl().then((g=>this.getLastSegmentInfo(g))).then((g=>new Promise(((m,f)=>self.setTimeout((()=>{const S=this.media?.getCurrentPlaylistUrl?.()??g.playlistUrl;this.getLastSegmentInfo(S).then((f=>{const S=g.playlistUrl===f.playlistUrl?void 0:g.playlistUrl;m({oldSegmentName:g.segmentName,newSegmentName:f.segmentName,oldPlaylistUrl:S,newPlaylistUrl:f.playlistUrl})}),(g=>f(g)))}),1e3*g.targetDuration)))))}shouldSkipRecovery(){return!this.video||this.video.paused||this.video.ended||0===this.video.playbackRate||this.video.seeking||this.video.readyState>2}getBuffered(g){try{return T.toString(g.buffered)}catch(g){return T.toString(E)}}addEvent(g,m){let f={};return m?.detail&&(f={detail:m.detail}),new CustomEvent(g,f)}stopBufferCheck(){this.configProvider.config.hlsSettings.stopTerminating||(this.log("Stopping Buffer Reserve check","debug"),self.clearInterval(this.bufferCheckInterval))}}}HlsPlayerF();function HlsLoggerF(){return class{constructor(g,m){this.logFn=g,this.enableDebugLogs=m}logMessage(g,m,f){const S=(g??"")+(m??"");this.logFn(`[hls.js] ${S}`,f)}error(g,m){this.logMessage(g,m,"error")}info(g,m){this.logMessage(g,m,"info")}log(g,m){this.logMessage(g,m,"log")}warn(g,m){this.logMessage(g,m,"warn")}debug(g,m){this.enableDebugLogs&&this.logMessage(g,m,"debug")}}}function HlsCommunicationHandlerF(){const g=HlsPlayerF();return class{constructor(m,f){this.pipe=m,this.hls=new g(f,this)}processMessage(g){if("Command"===g.msgType){Promise.resolve().then((()=>this.hls[g.cmd].apply(this.hls,g.args))).then((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,result:JSON.stringify(m)})})).catch((m=>{this.pipe&&this.pipe.sendMsg({msgType:"CommandResult",cmd:g.cmd,error:m})}))}}message(g){return{send:this.fromMessage(((...m)=>{this.sendMessageImpl(g,m)}))}}hlsDisposed(){this.pipe.dispose(),this.pipe=null,this.hls=null}fromMessage(g){return g}sendMessageImpl(g,m){this.pipe.sendMsg({msgType:"PlayerNotification",name:g,args:m})}}}var ct=HlsCommunicationHandlerF();function IFrameMessageHandlerF2(){function isCmdResult(g){return"CommandResult"===g.msgType}function getErrorString(g){let m="unknown";if(!g)return m;try{m="string"==typeof g?g:"toString"in g&&0!==g.toString().indexOf("[object")?g.toString():JSON.stringify(g)}catch(m){console.error("Failed to stringify error",g)}return m}return class{constructor(){this.processMsg=this.processMsg.bind(this),window.addEventListener("message",this.processMsg)}sendMsg(g){try{let m=g;isCmdResult(g)&&g.error instanceof Event&&(console.debug("Stringifying error Event before trying to postMessage:",g),m={msgType:g.msgType,cmd:g.cmd,error:`Event: ${getErrorString(g.error)}`}),this.postMessage(m)}catch(m){console.error("Unexpected exception caught from postMessage.\n","message:",g,"\n","exception:",m);const f={msgType:"PlayerNotification",name:"log",args:["error",`Unexpected error with postMessage: ${getErrorString(m)}`]};throw this.postMessage(f),m}}registerObserver(g){this.observer=g}dispose(){window.removeEventListener("message",this.processMsg),this.observer=null}processMsg(g){this.observer.processMessage(g.data)}postMessage(g){window.parent.postMessage(g,"*")}}}function HlsAbsoluteTimeOffsetEstimatorF2(){const g=HlsFileParserF2();return class{constructor(m,f,S){this.configProvider=f,this.onAbsoluteTimeOffsetEstimation=S,this.playlistFileDownloadPromise=Promise.resolve(),this.playlistFileDownloadRetryWaitTime=250,this.playlistFileDownloadMaxRetryCount=20,this.playlistFileDownloadCancellationFlag=!1,this.logFn=(g,f)=>m(`[HlsAbsoluteTimeOffsetEstimator]: ${g}`,f),this.hlsFileParser=new g(m)}get absoluteTimeOffset(){return this.estimatedAbsoluteTimeOffset}restartStreamAbsoluteTimeOffsetRetrieval(){this.stopStreamAbsoluteTimeOffsetRetrieval().then((()=>this.startStreamAbsoluteTimeOffsetRetrieval()))}setManifestFileURL(g){this.cachedManifestUrl=g}startStreamAbsoluteTimeOffsetRetrieval(){this.playlistFileDownloadPromise=this.retryPlaylistFileDownload((()=>this.estimateStreamTimeFromPlaylist(this.currentManifestUrl))).then((()=>{this.logFn(`Succeeded in downloading playlist files to estimate\n                    absolute stream time offset as: ${this.estimatedAbsoluteTimeOffset}`)})).catch((g=>{this.logFn(`Failed to download playlist files to estimate absolute stream time offset: ${g.message}`,"error")}))}stopStreamAbsoluteTimeOffsetRetrieval(){return this.playlistFileDownloadCancellationFlag=!0,this.playlistFileDownloadPromise.then((()=>{this.playlistFileDownloadCancellationFlag=!1,this.currentManifestUrl=this.cachedManifestUrl,this.cachedManifestUrl=null}))}retryPlaylistFileDownload(g,m=0){let f=Promise.resolve();return f=g().then((()=>(this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!0,absoluteTimeOffsetEstimation:this.absoluteTimeOffset}),Promise.resolve()))).catch((f=>(m++,this.logFn(`Error loading playlist file: ${f} -- attempt ${m}`),this.onAbsoluteTimeOffsetEstimation&&this.onAbsoluteTimeOffsetEstimation({timestamp:Date.now(),retries:m,isSuccess:!1,error:f.message}),m===this.playlistFileDownloadMaxRetryCount?Promise.reject(new Error(`${f} after ${m} attempts`)):this.playlistFileDownloadCancellationFlag?Promise.reject(new Error("cancelling playlist file download")):new Promise((f=>setTimeout((()=>f(this.retryPlaylistFileDownload(g,m))),this.playlistFileDownloadRetryWaitTime)))))),f}estimateStreamTimeFromPlaylist(g){return this.hlsFileParser.getStreamRenditionsUrlsFromManifest(g).then((m=>{if(0===m.length)throw new Error(`Unable to retrieve renditions URLs from manifest: ${g}`);return this.hlsFileParser.getTextFileContent(m[0])})).then((g=>{const m=this.hlsFileParser.getHlsFieldByName("ProgramStartDate",g);if(m.length>0)this.logFn("Using program start date to calculate absolute time offset","debug"),this.estimatedAbsoluteTimeOffset=new Date(m[0]).getTime()/1e3;else{this.logFn("Using segment duration and sequence number to calculate absolute time offset","debug");const m=this.hlsFileParser.getHlsFieldByName("SequenceNumber",g);if(0==m.length)throw new Error("Unable to retrieve sequence number from playlist file");const f=this.hlsFileParser.getHlsFieldByName("SegmentDuration",g,10);if(0==f.length)throw new Error("Unable to retrieve segment durations from playlist file");const S=f.map(Number);S.sort(((g,m)=>g-m));const v=S[Math.floor(S.length/2)];this.estimatedAbsoluteTimeOffset=(Number(m[0])-this.configProvider.config.hlsSettings.playlistInitialSequenceNumber)*Number(v)}}))}}}function HlsFileParserF2(){return class{constructor(g){this.fieldNameRegexMap={BaseUrl:/(.*)\/.*/,SequenceNumber:/#EXT-X-MEDIA-SEQUENCE:(\d+)/,SegmentDuration:/#EXTINF:(\d+(\.\d+)?)/,ProgramStartDate:/#EXT-X-PROGRAM-DATE-TIME:(.*)/,TargetDuration:/#EXT-X-TARGETDURATION:(\d+)/},this.logFn=(m,f)=>g(`[HlsFileParser]: ${m}`,f)}getHlsFieldByName(g,m,f=1){const S=[];for(let v=1;v<=f;v++){const f=this.fieldNameRegexMap[g].exec(m);if(!(f&&f.length>0))break;S.push(f[1]),m=m.substring(f.index+f[0].length)}return S}getStreamRenditionsUrlsFromManifest(g){return g?this.getTextFileContent(g).then((m=>{const f=[],S=m.split("\n"),v=this.getHlsFieldByName("BaseUrl",g);for(let g=0;g<S.length;g++)if(S[g].includes("#EXT-X-STREAM-INF")){const m=S[g+1];m.includes("http")?f.push(m):v.length>0&&f.push(`${v[0]}/${m}`)}return f})).catch((g=>(this.logFn(`Failed to extract stream renditions from manifest, error: ${g.message}`,"error"),[]))):(this.logFn("No manifest URL provided to parse"),Promise.resolve([]))}getTextFileContent(g){const m=fetch(g).then((m=>{if(!m.ok)throw new Error(`http-error ${m.status} when downloading: ${g}`);return m.text()})).catch((g=>(this.logFn(`Error downloading resource: ${g}`,"error"),Promise.reject(g))));return m}}}function HlsDiagnosticProviderF(){return class{constructor(g,m,f,S,v,C){this.playerInstance=g,this.contextWindow=m,this.video=f,this.media=S,this.streamingStartedTimestamp=v,this.hlsPlayer=C,this.videoDownloadLatencies=[],this.audioDownloadLatencies=[],this.audioDownloadBytes=[],this.videoDownloadBytes=[],this.audioDownloadBandwidths=[],this.videoDownloadBandwidths=[],this.videoDownloadSuccessCount=0,this.audioDownloadSuccessCount=0,this.videoDownloadFailureCount=0,this.audioDownloadFailureCount=0,this.audioDownloadFailures=[],this.videoDownloadFailures=[],this.totalDownloadedBytes=0,this.slidingWindowLengthForLatency=10,this.slidingWindowLengthForDownloadBytes=10,this.slidingWindowLengthForDownloadBandwidth=10,this.downloadFailuresLimit=10,this.currentSnapshot={playerType:1,currentPlayPosition:null,currentAbsoluteTime:null,absoluteTimeOffsetEstimationResults:null,videoReadyState:null,tech:null,perceivedBandwidth:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,avgVideoDownloadLatency:null,avgAudioDownloadLatency:null,avgVideoDownloadBytes:null,avgAudioDownloadBytes:null,avgAudioDownloadBandwidth:null,avgVideoDownloadBandwidth:null,maxVideoDownloadBytes:null,minVideoDownloadBytes:null,videoDownloadSuccessCount:null,audioDownloadSuccessCount:null,videoDownloadFailureCount:null,audioDownloadFailureCount:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,errorCode:null,errorMessage:null,errorType:null,videoDownloadFailures:null,audioDownloadFailures:null,heuristicProfile:null,encryption:null,sdnVersion:null,sdnStats:null,corruptedVideoFrames:null,creationTime:null,droppedVideoFrames:null,totalVideoFrames:null,errorMSRequestIds:null,errorUuids:null,successMSRequestIds:null,successUuids:null,streamConnectionResults:null,hlsJsEvents:null,serviceAvgLatency:null,endToEndAvgLatency:null,serviceLatencyCdg:null,endToEndLatencyCdg:null,videoEdgeLatencyCdg:null,endToEndLatencyPerMinute:null,serviceLatencyPerMinute:null,retryFrequency:null,averageDownloadBitrate:null,totalDownloadedBytes:0,estimatedDownloadTTFB:null,streamUrl:null,streamId:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,retryCount:0,totalPlayingTimeInSeconds:0,originNodeChangeCount:0,deliveryNodeChangeCount:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],estimatedAbsoluteTimeOffset:null,memoryLog:null,statsInterval:null,originNodeFqdn:null,deliveryNodeFqdn:null},this.onAudioDownloadCompleted=this.onAudioDownloadCompleted.bind(this),this.onAudioDownloadError=this.onAudioDownloadError.bind(this),this.onVideoDownloadCompleted=this.onVideoDownloadCompleted.bind(this),this.onVideoDownloadError=this.onVideoDownloadError.bind(this)}getDiagnosticWritableField(){return{streamUrl:this.currentSnapshot.streamUrl,streamId:this.currentSnapshot.streamId,streamingEventType:this.currentSnapshot.streamingEventType,playerControlsEnabled:this.currentSnapshot.playerControlsEnabled,streamDeliveryPipeline:this.currentSnapshot.streamDeliveryPipeline,serviceLatencyCdg:this.currentSnapshot.serviceLatencyCdg,endToEndLatencyCdg:this.currentSnapshot.endToEndLatencyCdg,serviceAvgLatency:this.currentSnapshot.serviceAvgLatency,endToEndAvgLatency:this.currentSnapshot.endToEndAvgLatency,videoEdgeLatencyCdg:this.currentSnapshot.videoEdgeLatencyCdg,endToEndLatencyPerMinute:this.currentSnapshot.endToEndLatencyPerMinute,serviceLatencyPerMinute:this.currentSnapshot.serviceLatencyPerMinute,retryCount:this.currentSnapshot.retryCount,totalPlayingTimeInSeconds:this.currentSnapshot.totalPlayingTimeInSeconds,bufferingRate:this.currentSnapshot.bufferingRate,videoTrackHistory:this.currentSnapshot.videoTrackHistory,videoTrackTotalDurations:this.currentSnapshot.videoTrackTotalDurations}}getPlayerDiagnosticSnapshot(){const g=window.screen,mean2=g=>{const m=g.slice().sort(((g,m)=>g-m));return m[Math.floor(m.length/2)]},m=this.video.getVideoPlaybackQuality();this.currentSnapshot.errorCode=0,this.currentSnapshot.errorMessage=this.errorMessage,this.currentSnapshot.errorType=this.errorType,this.currentSnapshot.currentPlayPosition=this.video.currentTime,this.currentSnapshot.currentAbsoluteTime=this.getCurrentAbsoluteTime(),this.currentSnapshot.absoluteTimeOffsetEstimationResults=this.media.getAbsoluteTimeOffsetEstimationResults?.(),this.currentSnapshot.playbackBitrate=-1!==this.playerInstance?.currentLevel?this.playerInstance?.levels[this.playerInstance.currentLevel].bitrate:void 0,this.currentSnapshot.downloadBitrate=this.downloadBitrate,this.currentSnapshot.perceivedBandwidth=this.playerInstance?.bandwidthEstimate,this.currentSnapshot.tech=this.playerInstance?"hls":"html5",this.currentSnapshot.playerVersion=this.contextWindow.Hls.version,this.currentSnapshot.isP2PSdnUsed=!!this.contextWindow.peer5&&this.contextWindow.peer5.getStats().numOfPeers>0,this.currentSnapshot.sdnName=this.contextWindow.peer5?"microsoft":void 0,this.currentSnapshot.sdnStats=this.contextWindow.peer5?.getStats(),this.currentSnapshot.sdnVersion=this.contextWindow.peer5?.version,this.currentSnapshot.heuristicProfile="HighQuality",this.currentSnapshot.encryption=void 0,this.currentSnapshot.streamType=this.getStreamType(this.currentSnapshot.streamType),this.currentSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds(),this.currentSnapshot.audioStream=this.getAudioStreamData(),this.currentSnapshot.videoStream=this.getVideoStreamData(),this.currentSnapshot.muted=this.video.muted,this.currentSnapshot.volume=this.video.volume,this.currentSnapshot.playbackRate=this.video.playbackRate,this.currentSnapshot.videoReadyState=this.video.readyState;const f=this.getPlayerBufferedLength(),S=this.getPlayerCachedLength(),v=this.getPlayerEdgeLatency();this.currentSnapshot.audioBufferLength=f,this.currentSnapshot.audioCachedLength=S,this.currentSnapshot.audioEdgeLatency=v,this.currentSnapshot.videoBufferLength=f,this.currentSnapshot.videoCachedLength=S,this.currentSnapshot.videoEdgeLatency=v,this.currentSnapshot.livePosition=this.getLivePosition(),this.currentSnapshot.mediaHeight=this.video.videoHeight,this.currentSnapshot.mediaWidth=this.video.videoWidth,this.currentSnapshot.playerHeight=this.video.offsetHeight,this.currentSnapshot.playerWidth=this.video.offsetWidth,this.currentSnapshot.windowHeight=g?g.height:0,this.currentSnapshot.windowWidth=g?g.width:0,this.currentSnapshot.isFullscreen=document.fullscreenElement===this.video,this.currentSnapshot.avgAudioDownloadLatency=mean2(this.audioDownloadLatencies),this.currentSnapshot.avgVideoDownloadLatency=mean2(this.videoDownloadLatencies),this.currentSnapshot.avgAudioDownloadBytes=mean2(this.audioDownloadBytes),this.currentSnapshot.avgVideoDownloadBytes=mean2(this.videoDownloadBytes),this.currentSnapshot.maxVideoDownloadBytes=Math.max.apply(null,this.videoDownloadBytes),this.currentSnapshot.minVideoDownloadBytes=Math.min.apply(null,this.videoDownloadBytes),this.currentSnapshot.avgAudioDownloadBandwidth=mean2(this.audioDownloadBandwidths),this.currentSnapshot.avgVideoDownloadBandwidth=mean2(this.videoDownloadBandwidths),this.currentSnapshot.audioDownloadFailureCount=this.audioDownloadFailureCount,this.currentSnapshot.audioDownloadSuccessCount=this.audioDownloadSuccessCount,this.currentSnapshot.videoDownloadFailureCount=this.videoDownloadFailureCount,this.currentSnapshot.videoDownloadSuccessCount=this.videoDownloadSuccessCount,this.currentSnapshot.audioDownloadFailures=this.audioDownloadFailures,this.currentSnapshot.videoDownloadFailures=this.videoDownloadFailures,this.currentSnapshot.corruptedVideoFrames=m.corruptedVideoFrames,this.currentSnapshot.creationTime=m.creationTime,this.currentSnapshot.droppedVideoFrames=m.droppedVideoFrames,this.currentSnapshot.totalVideoFrames=m.totalVideoFrames,this.currentSnapshot.errorMSRequestIds=this.media.getMSErrorRequestIds?.(),this.currentSnapshot.errorUuids=this.media.getErrorUuids?.(),this.currentSnapshot.successMSRequestIds=this.media.getMSSuccessRequestIds?.(),this.currentSnapshot.successUuids=this.media.getSuccessUuids?.(),this.currentSnapshot.retryFrequency=this.getRetryFrequency(),this.currentSnapshot.totalDownloadedBytes=this.totalDownloadedBytes,this.currentSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate(),this.currentSnapshot.estimatedDownloadTTFB=this.getEstimatedTTFB(),this.currentSnapshot.streamConnectionResults=this.media.getStreamConnectionResults?.(),this.currentSnapshot.hlsJsEvents=this.media.getHlsEvents?.(),this.currentSnapshot.deliveryNodeFqdn=this.media.getDeliveryNodeFQDN?.(),this.currentSnapshot.estimatedAbsoluteTimeOffset=this.hlsPlayer.getCurrentAbsoluteTimeOffset();const C=this.getDiagnosticWritableField();return Object.keys(C).forEach((g=>{this.currentSnapshot[g]=C[g]})),this.currentSnapshot}getStreamType(g){let m="";if(this.playerInstance&&-1!==this.playerInstance?.currentLevel){const g=this.playerInstance.levels[this.playerInstance.currentLevel].details;m=g.live?"LIVE":g.type}return""===m||"LIVE"===g&&m!==g?g||"":m}setError(g,m){this.errorMessage=g,this.errorType=m}dispose(){}registerForPlayerFragDownloadEvents(g){const m=g.detail.data;if(m.details===this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_ERROR){const f=g.detail.bitrate;switch(m.frag.type){case"audio":this.onAudioDownloadError(m.frag.duration,m.details,m.type,f);break;case"main":this.onVideoDownloadError(m.frag.duration,m.details,m.type,f)}}else if(g.type===this.contextWindow.Hls.Events.FRAG_LOADED)switch(m.frag.type){case"audio":this.onAudioDownloadCompleted(m.frag.stats.loading.end-m.frag.stats.loading.start,m.frag.stats.total);break;case"main":this.onVideoDownloadCompleted(m.frag.stats.loading.end-m.frag.stats.loading.start,m.frag.stats.total,m.frag.level)}}getTotalDurationInSeconds(){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(g.toFixed(3))}onVideoDownloadCompleted(g,m,f){this.videoDownloadSuccessCount++,this.addToList(this.videoDownloadLatencies,g,this.slidingWindowLengthForLatency),this.addToList(this.videoDownloadBytes,m,this.slidingWindowLengthForDownloadBytes),this.addToList(this.videoDownloadBandwidths,8*m*1e3/g,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=m,this.downloadBitrate=f?this.playerInstance?.levels[f]?.bitrate:void 0}onAudioDownloadCompleted(g,m){this.audioDownloadSuccessCount++,this.addToList(this.audioDownloadLatencies,g,this.slidingWindowLengthForLatency),this.addToList(this.audioDownloadBytes,m,this.slidingWindowLengthForDownloadBytes),this.addToList(this.audioDownloadBandwidths,8*m*1e3/g,this.slidingWindowLengthForDownloadBandwidth),this.totalDownloadedBytes+=m}addToList(g,m,f){g.push(m),g.length>f&&g.shift()}onVideoDownloadError(g,m,f,S){this.videoDownloadFailureCount++,this.addDownloadFailureInfo(g,m,f,this.videoDownloadFailures,S)}onAudioDownloadError(g,m,f,S){this.audioDownloadFailureCount++,this.addDownloadFailureInfo(g,m,f,this.audioDownloadFailures,S)}addDownloadFailureInfo(g,m,f,S,v){const C={bitrate:v,errorCode:0,mediaTime:g,message:m,type:f,timestamp:Date.now()};this.addToList(S,C,this.downloadFailuresLimit)}getAudioStreamData(){if(this.playerInstance&&-1!==this.playerInstance?.currentLevel)try{const g=this.playerInstance.levels[this.playerInstance.currentLevel];return{bitrate:g.bitrate,codec:g.audioCodec,enabled:!0,name:g.audioCodec,language:void 0}}catch(g){return}}getVideoStreamData(){if(this.playerInstance&&-1!==this.playerInstance?.currentLevel)try{const g=this.playerInstance.levels[this.playerInstance.currentLevel];return{codec:g.videoCodec,name:g.videoCodec,currentTrack:{bitrate:g.bitrate,height:g.height,id:g.videoCodec,selectable:!0,width:g.width}}}catch(g){return}}getCurrentAbsoluteTime(){const g=this.hlsPlayer.getCurrentAbsoluteTimeOffset();return g?this.video.currentTime+g:this.video.currentTime}setValue(g,m){this.currentSnapshot[g]=m}getValue(g){return this.currentSnapshot[g]}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.totalDownloadedBytes){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(g>0)return 8*this.totalDownloadedBytes/g}return 0}getRetryFrequency(){const g=this.currentSnapshot.retryCount;if(this.streamingStartedTimestamp&&g){const m=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(m>0)return g/m}return 0}getPerceivedBandwidth(){return this.playerInstance?this.playerInstance.bandwidthEstimate:null}getAverageMeasuredBandwidth(){if(0===this.videoDownloadBandwidths.length)return null;let g=0;for(let m=0;m<this.videoDownloadBandwidths.length;m++)g+=this.videoDownloadBandwidths[m];return g/this.videoDownloadBandwidths.length}getAverageMeasuredVideoDownloadSize(){if(0===this.videoDownloadBytes.length)return null;let g=0;for(let m=0;m<this.videoDownloadBytes.length;m++)g+=this.videoDownloadBytes[m];return g/this.videoDownloadBytes.length}getEstimatedTTFB(){return this.playerInstance?this.playerInstance.ttfbEstimate:null}getPlayerBufferedLength(){const g=this.video.buffered,m=this.video.currentTime;let f=0;for(let S=0;S<g.length;S++)g.start(S)<=m&&m<g.end(S)?f+=g.end(S)-m:m<g.start(S)&&(f+=g.end(S)-g.start(S));return f}getPlayerCachedLength(){const g=this.video.buffered;let m=0;for(let f=0;f<g.length;f++)m+=g.end(f)-g.start(f);return m}getPlayerEdgeLatency(){if(this.playerInstance)return this.playerInstance.latency;const g=this.video.buffered;if(0===g.length)return-1;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));const f=4;return Math.round(Math.max(m-this.video.currentTime,0))+f}getLivePosition(){const g=this.video.buffered;if(0===g.length)return 0;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));return m}}}function CaptionsControlToggleProviderF2(){return class{constructor(g,m,f,S){this.media=g,this.toggleListener=m,this.config=f,this.diagnosticProvider=S,this.previouslyVisibleTextTrack=null,this.onTextTrackChanged=this.onTextTrackChanged.bind(this)}dispose(){this.unsubscribeFromTrackEvents(),this.media=null,this.toggleListener=null}initialize(){const g=this.getTextTracks();if(!this.config.controlsEnabled&&g.length>0)g[g.length-1].mode="showing";else for(let m=0;m<g.length;m++)g[m].mode="disabled";this.subscribeOnTrackEvents()}addCues(g){const m=this.getCurrentTextTrack();if(!m)return;const f=this.getCurrentAbsoluteTime(),S=this.getCurrentTime(),v=Math.max(f-S,0);for(let f=0;f<g.length;f++){const{start:S,end:C,text:_}=g[f];this.config.logFn(`Cue received: start: ${S}, end: ${C}, text: ${_}`,"debug");const E=2,T=Number((S-v).toFixed(E)),I=Number((C-v).toFixed(E)),b=new VTTCue(T,I,_);this.config.logFn(`Adjusted cue received: start: ${b.startTime}, end: ${b.endTime}, text: ${b.text}`,"debug"),this.containsCue(m,b)||m.addCue(b)}}clearCues(){const removeAllCues=g=>{if(g&&g.cues)for(;g.cues.length;)g.removeCue(g.cues[0])};removeAllCues(this.previouslyVisibleTextTrack),removeAllCues(this.currentTextTrack)}getTextTracks(){return this.media.textTracks}getCurrentTime(){return this.media.currentTime}getCurrentAbsoluteTime(){return this.diagnosticProvider?this.diagnosticProvider.getCurrentAbsoluteTime():this.getCurrentTime()}getCurrentTextTrack(){const g=this.getTextTracks();for(let m=0;g&&m<g.length;m++)if("showing"===g[m].mode)return g[m];return null}showCaptions(g){this.config.logFn(`[CaptionsControl]: showCaptions(${g})`),g?this.show():this.hide()}hide(){this.previouslyVisibleTextTrack=this.getCurrentTextTrack(),this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="disabled")}show(){this.previouslyVisibleTextTrack&&(this.previouslyVisibleTextTrack.mode="showing")}subscribeOnTrackEvents(){const g=this.getTextTracks(),m="addEventListener";g?.[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}unsubscribeFromTrackEvents(){const g=this.getTextTracks(),m="removeEventListener";g?.[m]&&(this.config.controlsEnabled&&g[m]("change",this.onTextTrackChanged),this.config.removeEmptyDefaultTextTrack&&g[m]("addtrack",this.onAddTrack.bind(this)))}onTextTrackChanged(){const g=this.getCurrentTextTrack();if(!g||!this.currentTextTrack||this.currentTextTrack.label!==g.label||this.currentTextTrack.mode!==g.mode){if(g||this.currentTextTrack){const m=!!g&&"showing"===g.mode,f=this.getCulture(g||this.currentTextTrack),S=this.getCurrentTime();this.toggleListener.captionsToggled(m,f,S),this.config.logFn(`[CaptionsControl]: track changed: culture '${f}', timestamp '${S}'`)}this.currentTextTrack=g}}onAddTrack(g){const m=g?.track;"captions"===m?.kind&&!m.label&&!m.id&&(this.media?.textTracks_?.removeTrack_(m),this.config.logFn("[CaptionsControl]: removing default empty text track"))}getCulture(g){if(g?.id){const m=g.id.split("_")[1];if(m)return m}else if(g?.language)return g.language;return""}containsCue(g,m){return Array.from(g?.cues||[]).some((g=>this.areCueEquals(g,m)))}areCueEquals(g,m){return g.startTime===m.startTime&&g.endTime===m.endTime&&g.text===m.text}}}function Html5MediaF(){const g=HlsAbsoluteTimeOffsetEstimatorF2();return class{constructor(m,f,S,v){this.element=m,this.logFn=f,this.configProvider=S,this.onAbsoluteTimeOffsetEstimation=v,this.absoluteTimeOffsetEstimationResults=[];const C={passive:!0};this._dispatchError=this._dispatchError.bind(this),this._onLoadedMetadata=this._onLoadedMetadata.bind(this),this.element.addEventListener("error",this._dispatchError,C),this.element.addEventListener("loadedmetadata",this._onLoadedMetadata,C),this.logFn("Created Html5Media"),this.configProvider.config.hlsSettings.estimateAbsoluteTime&&(this.absoluteTimeOffsetEstimator=new g(this.logFn,S,this._onAbsoluteTimeOffsetEstimation.bind(this)))}get averageTargetDuration(){return 0}get tech(){return"NativeHls"}getCurrentAbsoluteTimeOffset(){return this.absoluteTimeOffsetEstimator?.absoluteTimeOffset}getAbsoluteTimeOffsetEstimationResults(){return this.absoluteTimeOffsetEstimationResults}setSource(g){this.element.src=g.url,this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.setManifestFileURL(g.url),this.logFn("Set Source completed")}destroy(){this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.stopStreamAbsoluteTimeOffsetRetrieval(),this.element.removeEventListener("error",this._dispatchError),this.logFn("Destroyed Html5Media")}switchStreamingUrl(g){this.logFn(`Switching streaming url from HTML5Media at now:${Date.now()} currTime:${this.element.currentTime}`,"warn"),this.setSource(g)}_addEvent(g,m){let f={};return m?.detail&&(f={detail:m.detail}),new CustomEvent(g,f)}_onLoadedMetadata(){this.absoluteTimeOffsetEstimator&&this.absoluteTimeOffsetEstimator.restartStreamAbsoluteTimeOffsetRetrieval()}_onAbsoluteTimeOffsetEstimation(g){this.absoluteTimeOffsetEstimationResults.push(g),this.absoluteTimeOffsetEstimationResults.length>this.configProvider.config.hlsSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount&&this.absoluteTimeOffsetEstimationResults.splice(0,1),this.onAbsoluteTimeOffsetEstimation(g)}_dispatchError(g){let m;const f=g.target,S=f?.error;switch(S?.code){case S?.MEDIA_ERR_ABORTED:m="Media playback aborted";break;case S?.MEDIA_ERR_NETWORK:m="Media download failed part-way due to a network error";break;case S?.MEDIA_ERR_DECODE:m="Media playback aborted due to a corruption problem or because the\n                        media used features your browser did not support.";break;case S?.MEDIA_ERR_SRC_NOT_SUPPORTED:m="Media could not be loaded, either because the server or network failed\n                        or because the format is not supported.";break;default:m="Unknown error occurred."}this.logFn(`Html5Media received ${S?.message} errCode: ${S?.code}`,"error");const v=this._addEvent("networkError",{detail:{data:{fatal:!0,details:`${m} errCode:${S?.code}`},bitrate:void 0}});this.element.dispatchEvent(v)}}}function HlsMediaF(){return class{constructor(g,m,f,S,v,C){this.element=g,this.contextWindow=m,this.logFn=f,this.hlsConfig=S,this.playerId=v,this.configProvider=C,this.recoverDecodingErrorDate=0,this.recoverSwapAudioCodecDate=0,this.errorMSRequestIds=[],this.errorUuids=[],this.hlsEvents=[],this.aggregatedHlsEvents={},this.successMSRequestIds=[],this.successUuids=[],this.streamConnectionResults=[],this.initialSegmentPresentationTimeInSeconds=0,this.lastHlsJsEventUpdateTime=(new Date).getTime(),this.seenSegmentLoading=!1,this.seenSegmentLoaded=!1,this.seenKeyLoading=!1,this.seenKeyLoaded=!1,this._create=this._create.bind(this),this._play=this._play.bind(this),this._pause=this._pause.bind(this),this._assign=this._assign.bind(this),this._handleError=this._handleError.bind(this),this.hlsConfig.xhrSetup=(g,m)=>{-1!==m.indexOf("keydelivery")&&(g.withCredentials=!0);const f=this.getRandomHexString(16),S="00-"+this.playerId?.replace(/-/g,"")+"-"+f+"-01";-1===m.indexOf("keydelivery")&&-1===m.indexOf("media.m3u8")||g.setRequestHeader("traceparent",S),g.onerror=()=>{!this.streamDetails||m!==this.streamDetails.url&&-1===m.indexOf("keydelivery")||this.appendStreamConnectionResult({isSuccess:!1,timestamp:(new Date).getTime(),url:m,error:g.statusText,errorCode:g.status,traceparent:S,spanId:f})},g.onload=()=>{!this.streamDetails||m!==this.streamDetails.url&&-1===m.indexOf("keydelivery")||(g.status>=200&&g.status<=299?(this.appendStreamConnectionResult({isSuccess:!0,timestamp:(new Date).getTime(),url:m,redirectUrl:g.responseURL,traceparent:S,spanId:f}),this.streamConnectionResponseUrl=g.responseURL):this.appendStreamConnectionResult({isSuccess:!1,timestamp:(new Date).getTime(),url:m,error:g.statusText,errorCode:g.status,traceparent:S,spanId:f}))}},this._create()}appendStreamConnectionResult(g){this.streamConnectionResults.push(g),this.streamConnectionResults.length>this.configProvider.config.hlsSettings.maxStreamConnectionResultsLogCount&&this.streamConnectionResults.splice(0,1)}get averageTargetDuration(){return this.player?.levels[this.player?.currentLevel]?.details?.averagetargetduration||0}get tech(){return"Hls"}getPlayer(){return this.player}getMSErrorRequestIds(){return this.errorMSRequestIds}getErrorUuids(){return this.errorUuids}getMSSuccessRequestIds(){return this.successMSRequestIds}getSuccessUuids(){return this.successUuids}getStreamConnectionResults(){return this.streamConnectionResults}getHlsEvents(){return this.hlsEvents}getDeliveryNodeFQDN(){try{return new URL(this.streamConnectionResponseUrl).hostname}catch{return""}}setSource(g){if(-1===g.url.indexOf("m3u8"))throw new Error(`Invalid stream ${g.url}`);this.player.loadSource(g.url),this.streamDetails=g,this.seenSegmentLoaded=!1,this.seenSegmentLoading=!1,this.seenKeyLoaded=!1,this.seenKeyLoading=!1,this.logFn("Set Source completed")}destroy(){this.player&&(this.logFn("destroying HlsMedia"),this.player.destroy(),this.player=null)}switchStreamingUrl(g){this.logFn(`Switching streaming url from HlsMedia at now:${Date.now()} currTime:${this.element.currentTime}`,"warn"),this.destroy(),this._create(),this.setSource(g)}getCurrentPlaylistUrl(){const g=this.player?.levels[this.player.currentLevel]?.url;return g?.[g?.length-1]}_create(){this.player=new this.contextWindow.Hls(this.hlsConfig),this.events=this.contextWindow.Hls.Events,Object.keys(this.events).forEach((g=>{this.player.on(this.events[g],((...m)=>{this._assign(this.events[g],m)}))})),this.player.attachMedia(this.element),this.logFn("Created HlsMedia")}_play(){this.player&&(this.logFn("Started Playing"),this.player.startLoad())}_pause(){this.player&&(this.logFn("Paused Playing"),this.player.stopLoad())}_logHlsEvent(g,m){if(!this.configProvider.config.hlsSettings.logHlsJsEvents)return;if(g===this.contextWindow.Hls.Events.ERROR){const f=m[1].details,{fatal:S}=m[1];g=f+(S?":Fatal":":NonFatal")}this.aggregatedHlsEvents[g]||(this.aggregatedHlsEvents[g]=0),this.aggregatedHlsEvents[g]++;const f=(new Date).getTime();if(f-this.lastHlsJsEventUpdateTime>=this.configProvider.config.hlsSettings.logHlsJsEventsEveryMs){const g={timestamp:f,aggregatedEvents:this.aggregatedHlsEvents};this.hlsEvents.push(g),this.aggregatedHlsEvents={},this.lastHlsJsEventUpdateTime=f}}_logRequestId(g,m){if(!m[1])return;const f=m[1].networkDetails;if(f&&this.configProvider.config.hlsSettings.enableUuidTrace){const m=f.getResponseHeader("uuid");m&&(g===this.contextWindow.Hls.Events.ERROR?this.errorUuids.push(m):this.successUuids.push(m));const S=f.getResponseHeader("x-ms-request-id");S&&(g===this.contextWindow.Hls.Events.ERROR?this.errorMSRequestIds.push(S):this.successMSRequestIds.push(S))}}_assign(g,m){switch(this._logHlsEvent(g,m),this._logRequestId(g,m),g){case this.contextWindow.Hls.Events.ERROR:this._handleError(m);break;case this.contextWindow.Hls.Events.MEDIA_ATTACHED:this.logFn(`video and hls.js are now bound together ! Event:${g}`);break;case this.contextWindow.Hls.Events.MANIFEST_PARSED:this.logFn(`Starting HLS load Event:${g}`),this._play();break;case this.contextWindow.Hls.Events.LEVEL_SWITCHED:this.element.dispatchEvent(this._addEvent(g,{detail:{bitrate:this.player.levels[m[1].level].bitrate}}));break;case this.contextWindow.Hls.Events.FRAG_LOADED:this.element.dispatchEvent(this._addEvent(g,{detail:{data:m[1]}}));break;case this.contextWindow.Hls.Events.INIT_PTS_FOUND:this.initialSegmentPresentationTimeInSeconds=m[1].initPTS;break;case this.contextWindow.Hls.Events.KEY_LOADING:this.seenKeyLoading||(this.seenKeyLoading=!0,this.element.dispatchEvent(this._addEvent(g,{detail:{relurl:m[1].frag.relurl}})));break;case this.contextWindow.Hls.Events.KEY_LOADED:this.seenKeyLoaded||(this.seenKeyLoaded=!0,this.element.dispatchEvent(this._addEvent(g)));break;case this.contextWindow.Hls.Events.MANIFEST_LOADING:case this.contextWindow.Hls.Events.MANIFEST_LOADED:this.element.dispatchEvent(this._addEvent(g));break;case this.contextWindow.Hls.Events.FRAG_LOADING:const f=m[1].frag;f&&"initSegment"!==f.sn&&Number.isInteger(Number(f.sn))&&!this.seenSegmentLoading&&(this.seenSegmentLoading=!0,this.element.dispatchEvent(this._addEvent(g)));break;case this.contextWindow.Hls.Events.FRAG_BUFFERED:const S=m[1].frag;S&&"initSegment"!==S.sn&&Number.isInteger(Number(S.sn))&&!this.seenSegmentLoaded&&(this.logFn(`Starting HLS load Event:${g}`),this.seenSegmentLoaded=!0,this.element.dispatchEvent(this._addEvent(g)))}}_addEvent(g,m){let f={};return m?.detail&&(f={detail:m.detail}),new CustomEvent(g,f)}getCurrentAbsoluteTimeOffset(){return this.initialSegmentPresentationTimeInSeconds}_handleError(g){const m=g[1].type,f=g[1].fatal,S=g[1].details;this.logFn(`\nHLS Error type: ${m}\n details: ${S}\n fatal: ${f}\n rawData: ${JSON.stringify(g)}`,"error");const v=-1!==this.player.currentLevel?this.player.levels[this.player.currentLevel].bitrate:void 0;if(f){const C=this._addEvent(m,{detail:{data:g[1]}});switch(m){case this.contextWindow.Hls.ErrorTypes.MEDIA_ERROR:this.handleMediaError(C);break;case this.contextWindow.Hls.ErrorTypes.NETWORK_ERROR:console.error(`Network error type:${m} fatal:${f}`),S===this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_ERROR||S===this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_TIMEOUT?(g[1].fatal=!1,this.player.startLoad(this.element.currentTime),this.element.dispatchEvent(this._addEvent(S,{detail:{data:g[1],bitrate:v}}))):S===this.contextWindow.Hls.ErrorDetails.MANIFEST_PARSING_ERROR||S===this.contextWindow.Hls.ErrorDetails.MANIFEST_LOAD_ERROR||S===this.contextWindow.Hls.ErrorDetails.MANIFEST_LOAD_TIMEOUT||S===this.contextWindow.Hls.ErrorDetails.KEY_LOAD_TIMEOUT?this.element.dispatchEvent(this._addEvent(S,{detail:{data:g[1]}})):this.element.dispatchEvent(this._addEvent(m,{detail:{data:g[1],bitrate:v}}));break;default:this.element.dispatchEvent(C)}}else{const f=g[1].details,S=this._addEvent(m,{detail:{data:g[1],bitrate:v}});switch(f){case this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_ERROR||this.contextWindow.Hls.ErrorDetails.FRAG_LOAD_TIMEOUT:this.element.dispatchEvent(S),this.seenSegmentLoading&&!this.seenSegmentLoaded&&this.element.dispatchEvent(this._addEvent(f,{detail:{data:g[1]}}));break;case this.contextWindow.Hls.ErrorDetails.KEY_LOAD_ERROR:this.seenKeyLoaded||(this.seenKeyLoading=!1,this.element.dispatchEvent(this._addEvent(f,{detail:{data:g[1]}})))}}}handleMediaError(g){const m=Date.now();!this.recoverDecodingErrorDate||m-this.recoverDecodingErrorDate>3e3?(this.logFn(`Attempting to recover from media error at ${m}, currenTime:${this.element.currentTime}`,"warn"),this.recoverDecodingErrorDate=m,this.player.recoverMediaError()):!this.recoverSwapAudioCodecDate||m-this.recoverSwapAudioCodecDate>3e3?(this.recoverSwapAudioCodecDate=m,this.logFn(`Attempting to swap Audio Codec and recover from media error at ${m}, currenTime:${this.element.currentTime}`,"warn"),this.player.swapAudioCodec(),this.player.recoverMediaError()):(this.logFn(`Cannot recover, last media error recovery failed at ${m}, currenTime:${this.element.currentTime}`,"error"),this.element.dispatchEvent(g))}getRandomHexString(g){return Array.from(Array(g)).map((()=>Math.floor(16*Math.random()).toString(16))).join("")}}}function HlsLatencyProcessorF(){return class{constructor(g,m,f){this.video=g,this.diagnosticProvider=m,this.logFn=f,this.maxLatencyHistoryStore=1800,this.serviceLatencyHistory=[],this.endToEndLatencyHistory=[],this.endToEndLatencyPerMinute=[],this.serviceLatencyPerMinute=[],this.totalVideoBufferHistory=[],this.calculateQuartile=(g,m)=>{const f=(g.length-1)*m,S=Math.floor(f),v=f-S;return void 0!==g[S+1]?g[S]+v*(g[S+1]-g[S]):g[S]},this.logFn("Created HLS Latency tracker")}updateLatencyTraceFileUrl(g){const m=g.lastIndexOf("/");let f=g.substring(m);const S=g.substring(0,m);f.length>0&&f.includes("m3u8")?(f=f.includes("path")?"/?path=LatencyTrace.txt":"/LatencyTrace.txt",this.latencyTraceUrl=S+f,this.logFn(`Latency Trace file Url: ${this.latencyTraceUrl}`)):(this.latencyTraceUrl="",this.logFn("Latency Trace file Url is empty","warn"))}fetchLatencyContent(){""!==this.latencyTraceUrl?fetch(this.latencyTraceUrl).then((g=>{if(!g.ok)throw new Error("Latency fetch network response was not OK");return g.json()})).then((g=>this.processLatencyTrace(g))).catch((g=>{this.logFn(`[fetchLatencyContent]: Failed to fetch latency trace file: ${g}`,"error")})):this.logFn("[fetchLatencyContent]: Failed to fetch latency trace file, latencyTraceUrl is empty","warn")}processLatencyTrace(g){if(g&&0==Object.keys(g).length)this.logFn("[processLatencyTrace]: latency trace file empty","warn");else try{let m=[];if(m=void 0!==g.latency_trace.hops?g.latency_trace.hops:g.latency_trace,m.length<2)throw new Error("latency trace file format incorrect");const f=m[1].timestamp-m[0].timestamp,S=Date.now()-m[0].timestamp;this.serviceLatencyHistory.length>=this.maxLatencyHistoryStore&&this.serviceLatencyHistory.shift(),this.serviceLatencyHistory.push(f),this.endToEndLatencyHistory.length>=this.maxLatencyHistoryStore&&this.endToEndLatencyHistory.shift(),this.endToEndLatencyHistory.push(S),this.updateLatencyDiagnostics(S,f)}catch(g){const m=JSON.stringify(g);this.logFn(`[processLatencyTrace]: Failed to parse latency trace Json: ${m}`,"error")}}updateLatencyDiagnostics(g,m){this.updateVideoBufferHistory();const f=this.calculatePercentile(this.serviceLatencyHistory),S=this.calculatePercentile(this.endToEndLatencyHistory),v=this.calculatePercentile(this.totalVideoBufferHistory);this.diagnosticProvider.setValue("serviceAvgLatency",Math.round(this.serviceLatencyHistory.reduce(((g,m)=>g+m))/this.serviceLatencyHistory.length)),this.diagnosticProvider.setValue("serviceLatencyCdg",f),this.diagnosticProvider.setValue("endToEndAvgLatency",Math.round(this.endToEndLatencyHistory.reduce(((g,m)=>g+m))/this.endToEndLatencyHistory.length)),this.diagnosticProvider.setValue("endToEndLatencyCdg",S),this.diagnosticProvider.setValue("videoEdgeLatencyCdg",v),this.updateEndToEndLatencyPerMinute(g,this.endToEndLatencyPerMinute,"endToEndLatencyPerMinute"),this.updateEndToEndLatencyPerMinute(m,this.serviceLatencyPerMinute,"serviceLatencyPerMinute")}calculatePercentile(g){const m=[],f=[10,20,30,40,50,60,70,80,90,100],S=g.sort(((g,m)=>g-m));return f.forEach((g=>{const f=g/100,v=this.calculateQuartile(S,f);m.push({percentile:g,value:Math.round(v)})})),m}updateEndToEndLatencyPerMinute(g,m,f){if(0===m.length){const f={timestamp:Date.now(),min:g,max:g,count:1};m.push(f)}else{let f=m[m.length-1];30==f.count?(f={timestamp:Date.now(),min:g,max:g,count:1},m.push(f)):(g<=f.min&&(f.min=g),g>f.max&&(f.max=g),f.count++)}this.diagnosticProvider.setValue(f,m)}updateVideoBufferHistory(){const g=this.video.buffered;if(0===g.length)return;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));this.totalVideoBufferHistory.length>=this.maxLatencyHistoryStore&&this.totalVideoBufferHistory.shift(),this.totalVideoBufferHistory.push(m-this.video.currentTime)}}}function initIFrame2(){const g=IFrameMessageHandlerF2(),m=HlsCommunicationHandlerF(),f=new g,S=new m(f,document.body);f.registerObserver(S)}function buildHlsEmbeddedSrc(){let g=`(${initIFrame2.toString()})();`;return g+=HlsPlayerF.toString()+";",g+=IFrameMessageHandlerF2.toString()+";",g+=HlsCommunicationHandlerF.toString()+";",g+=CaptionsControlToggleProviderF2.toString()+";",g+=HlsLoggerF.toString()+";",g+=HlsDiagnosticProviderF.toString()+";",g+=HlsMediaF.toString()+";",g+=Html5MediaF.toString()+";",g+=HlsLatencyProcessorF.toString()+";",g+=HlsAbsoluteTimeOffsetEstimatorF2.toString()+";",g+=HlsFileParserF2.toString()+";",g+="//# sourceURL=TsCallingHlsPlayer.js",g}var dt=class{sendMsg(g){this.peer.onMsg(g)}registerObserver(g){this.observer=g}onMsg(g){this.observer&&this.observer.processMessage(g)}connect(g){this.peer=g}dispose(){this.peer=null,this.observer=null}},ht=class{constructor(g){this.container=g}get contextWindow(){return this.container.ownerDocument.defaultView}sendMsg(g){this.iframe?.contentWindow?.postMessage(g,"*")}registerObserver(g){this.observer=g}dispose(){this.contextWindow&&this.contextWindow.removeEventListener("message",this.processMsg),this.iframe&&this.container.hasChildNodes()&&this.container.removeChild(this.iframe),this.iframe=null}initializeAmpIframe(g){const m=this.initializeIframe();return this.setAmpIframeContent(g),this.finalizeIframe(m)}initializeHlsIframe(g){const m=this.initializeIframe();return this.setHlsIframeContent(g),this.finalizeIframe(m)}initializeIframe(){const g=defer();return this.iframe=this.container.ownerDocument.createElement("iframe"),this.iframe.id="player-iframe",this.iframe.sandbox.add("allow-scripts"),this.iframe.allowFullscreen=!0,this.iframe.allow="camera; microphone; autoplay",this.iframe.style.height="100%",this.iframe.style.width="100%",this.iframe.style.border="none",this.iframe.onload=()=>{g.resolve()},this.iframe.onerror=()=>{g.reject("iframe load failed")},g}finalizeIframe(g){return this.container.appendChild(this.iframe),this.processMsg=this.processMsg.bind(this),this.contextWindow.addEventListener("message",this.processMsg),g.promise}processMsg(g){if("null"===g.origin&&g.source===this.iframe.contentWindow&&this.observer)if("RequestIceCandidates"===g.data)this.observer.processMessage({msgType:"Command",cmd:"getIceCandidates",args:[]});else this.observer.processMessage(g.data)}setAmpIframeContent(g){const m=buildAmpEmbeddedSrc(),f=`\n            <html class style='height: 100%; width: 100%; overflow: hidden'>\n            <head></head>\n            <body class style='height: 100%; width: 100%; margin: 0px'>\n                ${g?`<script nonce='${g}'> ${m}<\/script>`:`<script> ${m}<\/script>`}\n            </body>\n            </html>\n        `;this.iframe.srcdoc=f}setHlsIframeContent(g){const m=buildHlsEmbeddedSrc(),f=`\n            <html class style='height: 100%; width: 100%; overflow: hidden'>\n            <head></head>\n            <body class style='height: 100%; width: 100%; margin: 0px'>\n                ${g?`<script nonce='${g}'> ${m}<\/script>`:`<script> ${m}<\/script>`}\n            </body>\n            </html>\n        `;this.iframe.srcdoc=f}};async function setupAmpAndBuildPipe(g,m,f){if(0===m){const m=new dt,f=new dt;return m.connect(f),f.connect(m),f.registerObserver(new ot(f,g)),m}if(1===m){const m=new ht(g);return await m.initializeAmpIframe(f),m}throw new Error(`Unsupported communication type ${m}`)}async function setupHlsAndBuildPipe(g,m,f){if(0===m){const m=new dt,f=new dt;return m.connect(f),f.connect(m),f.registerObserver(new ct(f,g)),m}if(1===m){const m=new ht(g);return await m.initializeHlsIframe(f),m}throw new Error(`Unsupported communication type ${m}`)}var ut=class extends Ve{constructor(g){super(g),this.logger=g,this.resultsMap=new Map,this.on("log",((g,m)=>{this.logger[g](m)}))}async initialize(g,m,f,S,v){const C={config:f.config,playerConfig:f.playerConfig},_=f.playerConfig?.nonce||"";this.pipe=0===v?await setupAmpAndBuildPipe(g,f.config.loadType,_):await setupHlsAndBuildPipe(g,f.config.loadType,_),this.pipe.registerObserver(this),await this.message("configure").send(m,C,S)}message(g){return{send:this.fromMessage(((...m)=>this.sendMessageImpl(g,...m)))}}dispose(){super.dispose(),this.pipe.sendMsg(this.buildMsg("dispose")),this.pipe.dispose()}processMessage(g){let m,f;switch(g.msgType){case"CommandResult":m=this.getDeferred(g.cmd.toString()),m&&(g.error?(m.reject(g.error),this.logger.warn(`remote command failed: ${String(g.cmd)}, ${g.error}`)):g.result?m.resolve(g.result):m.resolve(),this.processCommandResult(g),this.resultsMap.delete(g.cmd.toString()));break;case"PlayerNotification":f=this.event(g.name),f.raise.apply(f,g.args);break;case"Command":this.processCommand(g).catch((m=>this.logger.warn(`error while processing command: ${JSON.stringify(g)}: ${m}`)));break;default:this.logger.warn(`unexpected message received: ${JSON.stringify(g)}`)}}async processCommand(g){if("getIceCandidates"===g.cmd.toString())await this.message("getIceCandidates").send();else this.logger.warn(`unsupported command received: ${JSON.stringify(g)}`)}processCommandResult(g){if("getIceCandidates"===g.cmd.toString())this.pipe.sendMsg({topic:"RequestIceCandidates",candidates:g.result});else this.logger.debug(`ignoring command result for: ${JSON.stringify(g)}`)}fromMessage(g){return g}sendMessageImpl(g,...m){return this.pipe.sendMsg(this.buildMsg(g,m)),this.waitForCompletion(g.toString())}buildMsg(g,m){return{msgType:"Command",cmd:g,args:m}}getDeferred(g){return this.resultsMap.get(g)}waitForCompletion(g){const m=this.getDeferred(g);m&&m.reject(new Error(`function ${g} is invoked again, before previous call is completed`));const f=defer();return this.resultsMap.set(g,f),f.promise}},gt=class extends Ve{constructor(g,m){super(),this.player=g,this.logger=m,this.playerSubs=[],this.subscribeForPlayerEvents()}get isRendering(){return!!this.player&&this.player.isRendering()}get streamSize(){return this.player?this.player.getStreamSize():{width:0,height:0}}get rendererType(){return 0}get frameType(){return-1}dispose(){this.stopPlayer(),super.dispose()}captions(){return this.player.getCaptionsControl()}getStats(){throw new Error("Method not implemented.")}setScalingMode(g,m){throw new Error("Method not implemented.")}captureFrame(g,m){throw new Error("Method not implemented.")}stopPlayer(){const g=this.player;this.player=null,g&&(this.logger.info("stopPlayer"),this.unsubscribeFromPlayerEvents(),g.stop())}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("fullscreenToggled",(g=>this.onFullScreenToggled(g)))),this.playerSubs.push(this.player.on("captionsToggled",((g,m,f)=>this.onCaptionsToggled(g,m,f))))}unsubscribeFromPlayerEvents(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onFullScreenToggled(g){this.event("fullScreenToggled").raise(g)}onCaptionsToggled(g,m,f){this.logger.info(`Turned captions ${g?"ON":"OFF"} for culture [${m}] at player time [${f}]`),this.event("captionsToggled").raise(g,m,f)}},pt=class{constructor(g,m){this.player=g,this.availableCultures=m,this.selectedCulture="",this.disposable=this.player.on("captionsToggled",((g,m,f)=>{this.selectedCulture=g?m:""}))}async addCues(g){await this.player.message("addCues").send(g)}async clearCues(){await this.player.message("clearCues").send()}async showCaptions(g){await this.player.message("showCaptions").send(g)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.disposable.dispose(),this.player=null}};function generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(g=>{const m=16*Math.random()|0;return("x"===g?m:3&m|8).toString(16)}))}var mt=[2097152,2097552,2097556,2097557,2097564,2097652,2097654,2097655,2097656,2097752,3145728,4194305,4194306,4194307,4194308,4194309,5242880,5242881,5242882,5242884,5242885,5242886],ft=2097753,St=class extends Ve{constructor(g,m,f){super(),this.logger=g,this.liveStreamStatistic=m,this.configProvider=f,this.playerState="Destroyed",this.retryCount=0,this.captionsTimestamp=0,this.isSwitchStreamingUrlOngoing=!1,this.streamingUrlSwitchCount=0,this.isPlaybackUnsupported=!1,this.id=generateGuid(),this.logger.info(`AmpLiveStreamPlayer created: ID: ${this.id}`)}get playerId(){return this.id}async configure(g){if(!isStreamValid(g.stream)&&!isStreamValid(g.altStream))return void this.logger.error("Invalid Live Stream configuration provided: no valid primary or alternative stream");this.logger.info("Live Stream configuration provided"),this.liveStreamOptions=g;const m=isStreamValid(g.stream)?g.stream:g.altStream;if(this.playerInstance&&!this.isPlaybackUnsupported){try{await this.playerInstance.message("configure").send(g)}catch(g){const m=stringifyObject(g);this.logger.error(`configure failed: ${m}`)}await this.handleStreamInfoUpdate(m)}else this.selectedStreamDetails=m}async loadPlayer(g){if(this.playerInstance)return this.logger.error("playerLoadFailed: cannot load a player while current one is still active"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(!this.liveStreamOptions||!this.selectedStreamDetails||!isStreamValid(this.selectedStreamDetails))return this.logger.error("playerLoadFailed: empty/invalid primary and alternate stream info configured"),{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:"empty/invalid primary and alternate stream info configured"}};let m;this.playerInstance=new ut(this.logger.createChild("AmpPlayerWrapper")),this.playerInstance.on("stateChanged",((g,m)=>this.ampStateChanged(g,m))),this.playerInstance.on("captionsToggled",((g,m,f)=>this.captionsToggled(g,m,f))),this.playerInstance.on("statsUpdated",(g=>this.liveStreamStatistic.registerStatsUpdated(g))),await this.playerInstance.initialize(g,this.liveStreamOptions,this.configProvider,this.id,0),this.liveStreamStatistic.registerPlayerLoadAttempt(),this.loadSucceeded=!1,this.srcLoadPromise||(this.srcLoadPromise=this.playerInstance.message("loadPlayerScript").send());try{m=await this.srcLoadPromise}catch(g){const m=stringifyObject(g);return this.logger.error(`playerLoadFailed: player scripts load failed: ${m}`),this.liveStreamStatistic.registerPlayerLoadFailed(`${m}`),this.srcLoadPromise=null,{setupSucceeded:!1,playerSetupError:{errorType:"PlayerScriptLoadFailed",errorMessage:m}}}await this.tryLoadSdnPlugin();try{await this.playerInstance.message("createAmp").send()}catch(g){const f=stringifyObject(g);return this.logger.error(`playerLoadFailed: createAmp failed: ${f}`),this.liveStreamStatistic.registerPlayerLoadFailed(`playerLoadFailed ${f}, script load: ${m}`),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:f}}}try{return await this.setPlayerSource(this.selectedStreamDetails),this.loadSucceeded=!0,this.logger.info(`loadPlayer succeeded: ${this.loadSucceeded}`),this.liveStreamStatistic.registerPlayerLoadSucceeded(m),this.playerState="Initialized",{setupSucceeded:this.loadSucceeded}}catch(g){const f=stringifyObject(g);return this.loadSucceeded=!1,this.logger.error(`loadPlayer succeeded: ${this.loadSucceeded}: setSource failed: ${f}`),this.liveStreamStatistic.registerPlayerLoadFailed(`setPlayerSource failed; script load: ${m}`),{setupSucceeded:this.loadSucceeded,playerSetupError:{errorType:"SetSourceFailed",errorMessage:f}}}}getRenderer(){return!this.renderer&&this.playerInstance&&(this.renderer=new gt(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.destroy("PlayerStopped")}getPlaybackState(){return this.playerState}getCaptionsTimestamp(){return this.captionsTimestamp}getCaptionsControl(){if(!this.captionsControl&&this.playerInstance){const g=this.liveStreamOptions.supportedSubtitleLanguages?this.liveStreamOptions.supportedSubtitleLanguages.map((g=>g.culture)):[];this.captionsControl=new pt(this.playerInstance,g)}return this.captionsControl}getStreamSize(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g?{width:g.mediaWidth,height:g.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}ampStateChanged(g,m){switch(g){case"error":return this.handlePlaybackError(m);case"canplaythrough":return this.onCanplaythrough();case"play":return this.onPlay();case"playing":return this.onPlaying();case"pause":return this.onPause();case"resume":return this.onResume();case"start":return this.onStart();case"ended":return this.onEnded();case"seeking":return this.onSeeking();case"seeked":return this.onSeeked(m);case"loadedmetadata":return this.onMetadataLoaded();case"waiting":return this.onWaiting();case"playbackbitratechanged":return this.onPlaybackBitrateChanged(m);case"downloadbitratechanged":return this.onDownloadBitrateChanged(m);case"fullscreenchange":return this.onFullscreenChange(m);case"potentialMediaFreeze":return this.onPotentialMediaFreeze();case"mute":return this.onMute();case"unmute":return this.onUnmute();case"volumechange":return this.onVolumeChange(m);case"loadstart":return this.onLoadStart();case"loadeddata":return this.onLoadedData();case"UserInitiatedSeek":return this.onUserInitiatedSeek(m);default:this.logger.warn(`Unknown amp event ${g}`)}}onUserInitiatedSeek(g){this.liveStreamStatistic.registerUserInitiatedSeek(g)}captionsToggled(g,m,f){this.event("captionsToggled").raise(g,m,f),this.liveStreamStatistic.registerCaptionToggle(g,m,f)}async tryLoadSdnPlugin(){if(this.sdnPluginLoadPromise)return void this.raiseSdnPluginSkippedEvent("SDN plugin already loaded");if(!this.liveStreamOptions.sdn)return void this.raiseSdnPluginSkippedEvent("No SDNs configured in liveStreamOptions");if(!this.configProvider.config.allowSdnPlugins)return void this.raiseSdnPluginSkippedEvent("Client configured to not allow SDN plugins");switch(this.liveStreamOptions.sdn.name){case"hive":case"kollective":case"ramp":case"peer5":break;default:return this.logger.warn(`unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`),void this.liveStreamStatistic.registerSdnPluginLoad(this.liveStreamOptions.sdn.name,!1,`Unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`)}let g;try{this.sdnPluginLoadPromise=this.playerInstance.message("tryLoadSdnPlugin").send(),await this.sdnPluginLoadPromise}catch(m){g=stringifyObject(m),this.sdnPluginLoadPromise=void 0,this.logger.error(`loadSdnPlugin failed: ${g}`),this.event("sdnPluginLoadFailed").raise(g)}this.liveStreamStatistic.registerSdnPluginLoad(this.liveStreamOptions.sdn.name,!!this.sdnPluginLoadPromise,g)}raiseSdnPluginSkippedEvent(g){this.logger.warn(`skipping SDN plugin load: ${g}`),this.event("sdnPluginLoadSkipped").raise(g)}async setPlayerSource(g){if(!g)throw this.logger.error("setPlayerSource: streamDetails is undefined"),new Error("setPlayerSource: streamDetails is undefined");if(!this.playerInstance)throw this.logger.error("setPlayerSource: playerInstance is null"),new Error("playerInstance is null");this.logger.info(`setPlayerSource: AMP source set to: [${g.url}]`),this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;try{this.logger.info("setPlayerSource: src changed"),this.selectedStreamDetails=g,this.liveStreamStatistic.registerSetSourceAttempt(g.url),await this.playerInstance.message("setSource").send(g),this.liveStreamStatistic.registerSetSourceSucceeded()}catch(g){const m=stringifyObject(g);throw this.logger.error(`setPlayerSource: failed with error [${m}]`),this.liveStreamStatistic.registerSetSourcedFailed(m),g}}async handleStreamInfoUpdate(g){this.loadSucceeded&&g.url!==this.selectedStreamDetails.url?await this.setPlayerSource(g):this.loadSucceeded&&this.playerInstance&&this.getCurrentTime()>0&&this.setPlaybackState("Start")}async switchStreamingUrl(g,m){if(this.streamingUrlSwitchCount>=this.configProvider.config.ampSettings.streamingUrlSwitchMaxCount||!(0,at.includes)(this.configProvider.config.ampSettings.errorCodesEligibleForStreamingUrlSwitch,g)&&!m)return!1;const f=this.selectedStreamDetails.url===this.liveStreamOptions.stream?.url,S=f?this.liveStreamOptions.altStream:this.liveStreamOptions.stream;return isStreamValid(S)?(this.isSwitchStreamingUrlOngoing=!0,this.streamingUrlSwitchCount++,this.setPlayerSource(S).then((()=>!0)).catch((()=>!1))):(this.logger.error(`Stream to switch (${f?"alternative":"primary"}) is not valid`),!1)}destroy(g){this.srcLoadPromise=null,this.sdnPluginLoadPromise=null,this.renderer&&(this.renderer.dispose(),this.renderer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.liveStreamStatistic.registerPlayerDestroyed(g),this.playerInstance.dispose(),this.playerInstance=null,this.setPlaybackState("Destroyed"))}getCurrentTime(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g&&g.currentPlayPosition||0}onCanplaythrough(){this.setPlaybackState("Ready")}onPlay(){(this.retryCount>0||this.lastKnownPlayTime)&&(this.logger.info(`Playing after retry count ${this.retryCount}, Setting current time to ${this.lastKnownPlayTime}`),this.playerInstance.message("setPlayTime").send(this.lastKnownPlayTime),this.retryCount=0,this.lastKnownPlayTime=void 0),this.setPlaybackState("Play")}onPlaying(){this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onResume(){this.setPlaybackState("Resume")}onStart(){this.logger.info(`Playback started, retry count: ${this.retryCount}`),this.setPlaybackState("Start"),this.isSwitchStreamingUrlOngoing&&(this.logger.info(`Playback started, switch count: ${this.streamingUrlSwitchCount}`),this.event("urlSwitched").raise(this.selectedStreamDetails===this.liveStreamOptions.altStream),this.isSwitchStreamingUrlOngoing=!1)}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(g){this.captionsTimestamp=g.captionsTimestamp,this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(){this.setPlaybackState("Buffering")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}setPlaybackState(g){this.playerState=g,this.logger.debug(`playback state changed: ${g}`),this.liveStreamStatistic.registerPlaybackStateChanged(g),this.event("playbackStateChanged").raise()}onPlaybackBitrateChanged(g){this.liveStreamStatistic.registerPlaybackBitratechanged(g.bitrate)}onDownloadBitrateChanged(g){this.liveStreamStatistic.registerDownloadBitratechanged(g.bitrate)}onFullscreenChange(g){this.logger.debug(`fullscreenchange, isFullscreen=${g.isFullscreen}`),this.event("fullscreenToggled").raise(g.isFullscreen),this.liveStreamStatistic.registerFullScreenChange(g.isFullscreen)}onPotentialMediaFreeze(){this.logger.warn("Player detected a potential media freeze"),this.liveStreamStatistic.registerPotentialMediaFreeze()}onMute(){this.liveStreamStatistic.registerMute(!0)}onUnmute(){this.liveStreamStatistic.registerMute(!1)}onVolumeChange(g){this.liveStreamStatistic.registerVolumeChange(g.value)}stringifyPlayerError(g){return JSON.stringify(g,(function(g,m){return"errorCode"===g?m.toString(16):m}))}async handlePlaybackError(g){const m=4194307;this.playerState="Error";const f=this.stringifyPlayerError(g);if(this.logger.info(`Playback error ${f}`),!g.errorCode&&null==g.fatal)return void this.logger.error("onError: error details are not available");if((g.errorCode&m)===m)return this.isPlaybackUnsupported=!0,this.raisePlaybackError("UnsupportedPlatform",f),void this.destroy("PlaybackError");this.lastKnownPlayTime=this.getCurrentTime()||this.lastKnownPlayTime;const S=g.errorCode,v=268435455&S;if(this.logger.error(`onError: errorCode: 0x${S.toString(16)}, errorCodeExcludingTech: 0x${v.toString(16)}, message: ${g.message}`),this.retryCount<this.configProvider.config.maxRetryCount&&(!1===g.fatal||-1!==(0,at.indexOf)(mt,v)))setTimeout((async()=>{this.logger.info(`Retry loading stream because of error code: 0x${S.toString(16)}`),this.retryCount++,this.raisePlaybackError("PlaybackRetried",f),this.setPlayerSource(this.selectedStreamDetails)}),this.configProvider.config.ampSettings.sourceResetTimeoutInMs);else{await this.switchStreamingUrl(v,g.fatal)?this.configProvider.config.ampSettings.resetStreamingUrlSwitchCount&&(this.streamingUrlSwitchCount=0):(v===ft||g.message?.includes(ft.toString(16))?this.raisePlaybackError("NetworkError",f):this.raisePlaybackError("PlaybackError",f),this.destroy("PlaybackError"))}}raisePlaybackError(g,m){this.liveStreamStatistic.registerPlaybackError(g,m),this.event("playbackError").raise(g,m)}},vt=class{constructor(g){this.ENABLE_LAST_MODIFIED_CHECK=!0,this.MAX_PLAYLIST_UPDATE_DELAY=8e3,this.TIME_TO_LIVE=3e4,this.PROBING_INTERVAL=6e5,this.GAP_BETWEEN_LIVE_CHECK=5500,this.maxPlaylistUpdateDelay=g?.maxPlaylistUpdateDelay??this.MAX_PLAYLIST_UPDATE_DELAY,this.enableLastModifiedCheck=g?.enableLastModifiedCheck??this.ENABLE_LAST_MODIFIED_CHECK,this.ttl=g?.timeToLive??this.TIME_TO_LIVE,this.probingInterval=g?.probingInterval??this.PROBING_INTERVAL}GetProbingPolicy(){return{timeToLive:this.ttl,probingInterval:this.probingInterval}}IsAlive(g){return this.getContent(g).then((m=>{let f=m.contentName;try{new URL(f)}catch(m){f=g.substring(0,g.lastIndexOf("/")+1).concat(f)}return this.getContent(f).then((g=>{try{const m=g.contentName,f=g.lastModified,S=Date.parse(f),v=g.date,C=Date.parse(v),_=Math.max(C-S,0),E=this.enableLastModifiedCheck&&_<=this.maxPlaylistUpdateDelay||!this.enableLastModifiedCheck;return Promise.resolve(this.getProbingResult(E,_,m))}catch(g){return Promise.resolve(this.getFailedProbingResult(`${g}`))}}))})).catch((g=>Promise.resolve(this.getFailedProbingResult(`Failed on silent probing: ${g}`))))}EnsureAlive(g){const m=Date.now();return this.IsAlive(g).then((f=>f.isSuccess?new Promise((S=>{self.setTimeout((()=>this.IsAlive(g).then((g=>{const v=g.isSuccess&&g.segmentName!==f.segmentName,C=Date.now()-m,_=v?void 0:`newResult.isSuccess:${g.isSuccess}, IsSegmentUpdated:${g.segmentName!==f.segmentName}`;S({oldResult:f,newResult:g,isSuccess:v,rtt:C,errorMsg:_})})).catch((g=>S({oldResult:f,isSuccess:!1,errorMsg:` Failed on active probing: ${stringifyObject(g)}`})))),this.GAP_BETWEEN_LIVE_CHECK)})):Promise.resolve({isSuccess:!1,oldResult:f,errorMsg:"Old Result Failed"})))}getContent(g){return fetch(g).then((g=>g.ok?g.text().then((m=>{if(!m)return Promise.reject(`Empty content: ${m}`);const f=m.split("\n");for(let m=f.length-1;m>=0;m--){const S=f[m];if(""!==S&&!S.startsWith("#"))return{contentName:S,date:g.headers.get("Date"),lastModified:g.headers.get("Last-Modified")}}return Promise.reject(`Failed to find content: ${f}`)})):Promise.reject(`Invalid response: ${g.status}`))).catch((m=>Promise.reject(stringifyObject(m).concat(`, url: ${g}`))))}getFailedProbingResult(g){return{isSuccess:!1,errorMsg:g,lastProbeTime:Date.now()}}getProbingResult(g,m,f){return{isSuccess:g,timeSinceLastPlaylistUpdate:m,segmentName:f,lastProbeTime:Date.now()}}},yt=class{constructor(g,m){this.outcome=0,this.selectedCount=0,this.successCount=0,this.isPrimary=!1,this.isVerizon=!1,this.lastPlayDuration=void 0,this.backOffDelay=0,this.totalProbingFailures=0,this.isLogged=!0,this.isActiveProbingOngoing=!1,this.isPrimary=g,this.isVerizon=m}SetMetadata(g){this.hlsLiveStreamMetadata=g}GetMetadata(){return this.hlsLiveStreamMetadata}SetLastStrategy(g){this.lastStrategy=g}GetLastStrategy(){return this.lastStrategy}SetBackOffDelay(g){this.backOffDelay=g}GetBackOffDelay(){return this.backOffDelay}SetActiveProbingIsOngoing(g){this.isActiveProbingOngoing=g}IsActiveProbingOngoing(){return this.isActiveProbingOngoing}SetActiveProbingResult(g){if(this.SetActiveProbingIsOngoing(!1),g.isSuccess){const m=this.activeProbingResult?.isSuccess?this.activeProbingResult?.rtt:void 0;if(m){const f=.7,S=m*f+g.rtt*(1-f);g.rtt=Math.ceil(S)}}else this.totalProbingFailures++;this.activeProbingResult=g}GetActiveProbingResult(){return this.activeProbingResult}SetSilentProbingResult(g){this.silentProbingResult=g,g.isSuccess||this.totalProbingFailures++}GetSilentProbingResult(){return this.silentProbingResult}GetLastProbeTime(){if(this.activeProbingResult?.isSuccess)return this.activeProbingResult.newResult.lastProbeTime}GetLastRtt(){if(this.activeProbingResult?.isSuccess)return this.activeProbingResult?.rtt}GetSelectedCount(){return this.selectedCount}GetOwnKey(){return this.getKey(this.isPrimary,this.isVerizon)}GetNextCandidateKey(){return this.getKey(!this.isPrimary,!this.isVerizon)}GetMediaUrl(){return this.GetMetadata().url}GetSuccessRate(){return 0===this.selectedCount?1:this.successCount/this.selectedCount}GetLastPlayDuration(){return this.lastPlayDuration||3!==this.outcome||(this.lastPlayDuration=Date.now()-this.lastSelectedTimestamp),this.lastPlayDuration}IsPrimary(){return this.isPrimary}IsVerizon(){return this.isVerizon}IncrementSelectedCount(){return this.isLogged=!1,this.lastSelectedTimestamp=Date.now(),this.lastPlayDuration=void 0,this.outcome=1,++this.selectedCount}GetOutCome(){return this.outcome}GetLastSelectedTime(){return this.lastSelectedTimestamp}RecordSuccess(){return 1===this.outcome?(this.outcome=3,++this.successCount):this.successCount}RecordSwitching(){this.lastPlayDuration=Date.now()-this.lastSelectedTimestamp,1===this.outcome&&(this.outcome=2)}IsLogged(){return this.isLogged}static compare(g,m){const f=g.GetSuccessRate(),S=m.GetSuccessRate(),v=g.GetLastSelectedTime(),C=m.GetLastSelectedTime(),_=g.GetOutCome(),E=m.GetOutCome(),T=g.IsVerizon(),I=m.IsVerizon(),b=g.IsPrimary(),A=m.IsPrimary(),P=g.GetLastRtt()??Number.MAX_VALUE,R=m.GetLastRtt()??Number.MAX_VALUE,w=g.GetLastProbeTime()??Number.MIN_VALUE,M=m.GetLastProbeTime()??Number.MIN_VALUE;return g.isPrimary&&!m.isPrimary?-1:!g.isPrimary&&m.isPrimary?1:f>S?-1:f<S?1:2!==_&&2===E?-1:2===_&&2!==E?1:P<R?-1:P>R||w<M?1:w>M||g.totalProbingFailures<m.totalProbingFailures?-1:g.totalProbingFailures>m.totalProbingFailures?1:v<C?-1:v>C?1:T&&!I?-1:!T&&I?1:b&&!A?-1:+!(b||!A)}TogglePrimary(){this.isPrimary=!this.isPrimary}GetDiagnostics(){return this.isLogged=!0,{key:this.GetOwnKey(),strategy:Ct[this.lastStrategy],outcome:_t[this.GetOutCome()],lastSelectedTimestamp:this.GetLastSelectedTime(),retryDelay:this.GetBackOffDelay(),totalProbeFailures:this.totalProbingFailures,successRate:this.GetSuccessRate(),selectedCount:this.selectedCount,lastPlayDurationInMs:this.GetLastPlayDuration(),silentProbingResult:this.GetSilentProbingResult(),activeProbingResult:this.GetActiveProbingResult()}}getKey(g,m){return g.toString().concat(":",m.toString()).toLowerCase()}},Ct=(g=>(g[g.RANDOM=0]="RANDOM",g[g.SMART=1]="SMART",g[g.FAIR=2]="FAIR",g[g.ECS=3]="ECS",g[g.HEALTH=4]="HEALTH",g[g.PROBE=5]="PROBE",g[g.PRIMARY=6]="PRIMARY",g))(Ct||{}),_t=(g=>(g[g.Init=0]="Init",g[g.Pending=1]="Pending",g[g.Error=2]="Error",g[g.Success=3]="Success",g))(_t||{}),Et=class{constructor(g){this.MAX_RETRY_DELAY=8e3,this.SELECTION_PENDING_SUCCESS=8,this.USE_DELAY_THRESHOLD=3e5,this.VERIFY_NEW_JOIN=!1,this.DISABLE_PROBING=!1,this.DEFAULT_RETRY_DELAY=300,this.ACTIVE_PROBING_NOT_STARTED=-1,this.DEFAULT_TIME_TO_LIVE=3e4,this.STRICT_VERIFY_FOR_URL=!1,this.lastChosenKey=void 0,this.coordinateCache=new Map,this.next=0,this.randomOrder=[],this.fairOrder=[],this.selectionPendingSuccess=0,this.totalProbeFailures=0,this.coordinatesHealthProber=null,this.urlToKey=new Map,this.coordinateSelectionCount=0,this.switchingPolicy=g,this.ecsSwitchingOrder=g?.ecsOrder?.map((g=>g.toLowerCase()))??[],this.maxSelectionPendingSuccess=g?.maxSelectionPendingSuccess??this.SELECTION_PENDING_SUCCESS,this.switchingStrategy=Ct[g?.strategy?.toUpperCase()]??6,this.isPrimaryPreferred=6===this.switchingStrategy,this.maxRetryDelay=g?.maxRetryDelay??this.MAX_RETRY_DELAY,this.useDelayThreshold=g?.useDelayThreshold??this.USE_DELAY_THRESHOLD,this.verifyNewJoin=g?.verifyNewJoin??this.VERIFY_NEW_JOIN,this.disableActiveProbing=g?.disableProbing??this.DISABLE_PROBING,this.probeInterval=this.ACTIVE_PROBING_NOT_STARTED,this.strictVerifyForUrl=g?.strictVerifyForUrl??this.STRICT_VERIFY_FOR_URL,this.retryDelay=void 0,this.coordinatesHealthProber=new vt(g?.probingPolicy),this.startActiveProbing()}UpdateCandidates(g){let m=this.updateMetadata(g?.altStream,!1);return m+=this.updateMetadata(g?.stream,!0),m&&this.forceProbing(),m}GetCoordinates(){this.coordinateSelectionCount++;const g=this.switchingPolicy?.minimumRetryDelay??this.DEFAULT_RETRY_DELAY;return this.internalGetCoordinates(g).then((g=>{const m=g[0];let f=50;return g[1]&&(this.retryDelay?this.retryDelay*=2:this.retryDelay=this.switchingPolicy?.minimumRetryDelay??this.DEFAULT_RETRY_DELAY,f=Math.min(this.retryDelay,this.maxRetryDelay)),m.SetBackOffDelay(f),console.log(`Success strategy:${m.GetLastStrategy()}, picked:${m.GetOwnKey()}, delay:${f}, timeSinceLastPlaylistUpdate:${m.GetSilentProbingResult()?.timeSinceLastPlaylistUpdate}`),m}))}GetSwitchCount(){return Math.max(this.coordinateSelectionCount-1,0)}GetSwitchDetails(){return[this.next,this.selectionPendingSuccess]}GetSize(){return this.isECSOptionsProvided()?this.ecsSwitchingOrder.length:this.coordinateCache.size}RecordSuccess(){this.selectionPendingSuccess=0,this.retryDelay=void 0,this.coordinateCache.get(this.lastChosenKey).RecordSuccess()}GetDiagnostics(){const g=this.lastChosenKey?this.coordinateCache.get(this.lastChosenKey):void 0,m=g?.GetDiagnostics(),f=[];this.coordinateCache.forEach((g=>{g.IsLogged()||f.push(g.GetDiagnostics())}));const S={coordinateSelectionCount:this.coordinateSelectionCount,totalTries:this.next,totalProbeFailures:this.totalProbeFailures,selectionPendingSuccess:this.selectionPendingSuccess};return{winner:m,losers:f,cacheSize:this.GetSize(),stats:S}}StopActiveProbing(){this.probeInterval!==this.ACTIVE_PROBING_NOT_STARTED&&(self.clearInterval(this.probeInterval),this.probeInterval=this.ACTIVE_PROBING_NOT_STARTED)}internalGetCoordinates(g){const isExhausted=()=>this.maxSelectionPendingSuccess<this.selectionPendingSuccess;if(isExhausted()&&void 0===this.lastChosenKey&&(this.selectionPendingSuccess=0),isExhausted()){return this.coordinateCache.get(this.lastChosenKey).RecordSwitching(),this.lastChosenKey=void 0,Promise.reject(`selectionPendingSuccess:${this.selectionPendingSuccess}, maxSelectionPendingSuccess:${this.maxSelectionPendingSuccess}`)}let m=!1;if(this.lastChosenKey){const g=this.coordinateCache.get(this.lastChosenKey);g.RecordSwitching(),m=this.shouldUseDelay(g)}const f=this.getNextKey(),S=f[0],v=this.coordinateCache.get(S);return v.SetLastStrategy(f[1]),this.lastChosenKey=S,this.fairOrder.length!==this.coordinateCache.size&&this.updateFairOrder(),v.IncrementSelectedCount(),this.next++,this.selectionPendingSuccess++,this.shouldVerify()?this.coordinatesHealthProber.IsAlive(v.GetMediaUrl()).then((f=>{if(v.SetSilentProbingResult(f),f.isSuccess)return[v,m];{this.totalProbeFailures++;const m=Math.min(4*g,this.maxRetryDelay);return console.error(`Silent Probing Failed, used strategy:${v.GetLastStrategy()}, picked:${S}, error: ${f.errorMsg}, retrying in ${g} ms`),new Promise(((f,S)=>setTimeout((()=>this.internalGetCoordinates(m).then((g=>f(g))).catch((g=>S(g)))),g)))}})):Promise.resolve([v,m])}getNextKey(){const g=this.internalGetNextKey();if(5!==g[1]&&this.selectionPendingSuccess>=1){const g=this.getMostRecentProbedKey();if(g){const m=this.coordinateCache.get(g);if(m?.IsPrimary()||!this.isPrimaryPreferred||this.selectionPendingSuccess>=4)return[g,5]}}return g}internalGetNextKey(){if(this.isRandomPreferred())return this.getNextRandomKey();if(this.isPrimaryPreferred)return this.getNextPrimaryKey();if(2===this.switchingStrategy)return this.getNextFairKey();if(1===this.switchingStrategy)return this.getNextSmartKey();if(4===this.switchingStrategy)return this.getNextHealthKey();if(5===this.switchingStrategy)return this.getNextProbeKey();if(this.isECSOptionsProvided())return this.getNextECSKey();throw new Error(`Invalid Switching Strategy:${this.switchingStrategy}, ecsOrder:${this.ecsSwitchingOrder}`)}getNextPrimaryKey(){return this.selectionPendingSuccess<4?this.getNextRandomKey():this.getNextSmartKey()}updateMetadata(g,m){if(!g)return 0;let f=0;const S=g.hlsUrls?g.hlsUrls:g.url;if(S&&Array.isArray(S)){const v=S?.length||0;for(let C=0;C<v;C++){const v=0===C;this.storeCandidates(S[C],g,m,v)&&f++}}else"string"==typeof S&&this.storeCandidates(S,g,m,!0)&&f++;return f}storeCandidates(g,m,f,S,v=!1){if(!isHlsStreamValid(g,m,this.strictVerifyForUrl))return!1;const C=new yt(f,S),_=C.GetOwnKey();let E=!1;const T=this.urlToKey.get(g),I=this.coordinateCache.get(_)?.GetMediaUrl();if((T||I)&&(T!==_||g!==I))return!v&&this.handleRoleChange(_,T,g,m,f,S);if(!(T===_||void 0===T))return!1;if(this.urlToKey.set(g,_),!this.coordinateCache.has(_)){const f={url:g,sdnContext:m.sdnContext,keyDeliveryUrl:m.keyDeliveryUrl,keyAuthorizationToken:m.keyAuthorizationToken,streamDeliveryPipeline:m.streamDeliveryPipeline};C.SetMetadata(f),this.coordinateCache.set(_,C),this.addToRandom(C,_),E=!0}const b=this.coordinateCache.get(_).GetMetadata().sdnContext,A=m.sdnContext?.trim();return A&&b!==A&&(this.coordinateCache.get(_).GetMetadata().sdnContext=A),E}addToRandom(g,m){!g.IsPrimary()&&this.isPrimaryPreferred||(this.randomOrder.push(m),this.randomOrder=this.shuffleArray(this.randomOrder))}handleRoleChange(g,m,f,S,v,C){const _=this.coordinateCache.get(g);if(_&&m){const f=this.coordinateCache.get(m);return _.TogglePrimary(),f.TogglePrimary(),this.coordinateCache.set(m,_),this.coordinateCache.set(g,f),this.urlToKey.set(f.GetMediaUrl(),g),this.urlToKey.set(_.GetMediaUrl(),m),this.lastChosenKey=this.lastChosenKey===m?g:this.lastChosenKey,this.updateFairOrder(),!1}if(m){const f=this.coordinateCache.get(m);return f.TogglePrimary(),this.coordinateCache.delete(m),this.coordinateCache.set(g,f),this.randomOrder=this.randomOrder.filter((f=>f!==m&&f!==g)),this.addToRandom(f,g),this.urlToKey.set(f.GetMediaUrl(),g),this.lastChosenKey=this.lastChosenKey===m?g:this.lastChosenKey,this.updateFairOrder(),!1}if(_){_.TogglePrimary();const m=_.GetOwnKey();return this.coordinateCache.delete(g),this.coordinateCache.set(m,_),this.randomOrder=this.randomOrder.filter((f=>f!==g&&f!==m)),this.addToRandom(_,m),this.urlToKey.set(_.GetMediaUrl(),m),this.lastChosenKey=this.lastChosenKey===g?m:this.lastChosenKey,this.updateFairOrder(),this.storeCandidates(f,S,v,C,!0)}return!1}isConflict(g){return this.lastChosenKey===g&&this.GetSize()>1&&(!this.isPrimaryPreferred||Array.from(this.coordinateCache.values()).filter((g=>g.IsPrimary())).length>1)}getNextRandomKey(g){const m=this.randomOrder.length;if(0===m&&this.GetSize()>0)return[this.shuffleArray(Array.from(this.coordinateCache.keys()))[0],0];if(4===(g=g??0))return[this.randomOrder[this.next%m],0];let f=null;if(this.isECSOptionsProvided()){const g=Math.floor(Math.random()*this.ecsSwitchingOrder.length);f=[this.ecsSwitchingOrder[g],3]}else f=[this.randomOrder[this.next%m],0];return this.isConflict(f[0])||!this.coordinateCache.has(f[0])?(this.next++,this.getNextRandomKey(++g)):f}getNextFairKey(){const g=this.fairOrder[this.next%this.fairOrder.length];return this.isConflict(g)?(this.next++,this.getNextFairKey()):[g,2]}getNextSmartKey(){if(!this.lastChosenKey)return this.getNextRandomKey();const g=this.coordinateCache.get(this.lastChosenKey),m=g.GetNextCandidateKey();return 3!==g.GetOutCome()&&1===g.GetLastStrategy()||!this.coordinateCache.has(m)?this.getNextFairKey():!this.isECSOptionsProvided()||this.ecsSwitchingOrder.includes(m)?[m,1]:this.getNextFairKey()}getNextECSKey(){for(let g=0;g<this.ecsSwitchingOrder.length;g++){const m=this.ecsSwitchingOrder[this.next+g%this.ecsSwitchingOrder.length];if(!this.isConflict(m)&&this.coordinateCache.has(m))return[m,3]}return this.getNextSmartKey()}getNextHealthKey(){const g=Array.from(this.coordinateCache.values()).sort(yt.compare);for(let m=0;m<g.length;m++){const f=g[m].GetOwnKey();if(!(this.isConflict(f)||this.isECSOptionsProvided()&&!this.ecsSwitchingOrder.includes(f)))return[f,4]}return this.getNextSmartKey()}shuffleArray(g){for(let m=g.length-1;m>0;m--){const f=Math.floor(Math.random()*(m+1));[g[m],g[f]]=[g[f],g[m]]}return g}isRandomPreferred(){return(0===this.switchingStrategy||0===this.next||this.GetSize()<3)&&5!==this.switchingStrategy}updateFairOrder(){if(!this.lastChosenKey)return;const update=g=>{this.shouldUpdateFair(g)&&this.fairOrder.push(g)},g=this.coordinateCache.get(this.lastChosenKey);let m=[];m=this.isPrimaryPreferred?[new yt(g.IsPrimary(),!g.IsVerizon()).GetOwnKey(),new yt(g.IsPrimary(),g.IsVerizon()).GetOwnKey(),new yt(!g.IsPrimary(),!g.IsVerizon()).GetOwnKey(),new yt(!g.IsPrimary(),g.IsVerizon()).GetOwnKey()]:[g.GetNextCandidateKey(),new yt(!g.IsPrimary(),g.IsVerizon()).GetOwnKey(),new yt(g.IsPrimary(),!g.IsVerizon()).GetOwnKey(),this.lastChosenKey];for(let g=0;g<m.length;g++)update(m[g])}shouldUpdateFair(g){return this.coordinateCache.has(g)&&!this.fairOrder.includes(g)&&(!this.isECSOptionsProvided()||this.ecsSwitchingOrder.includes(g))}shouldVerify(){return this.switchingPolicy?.probingPolicy&&(this.verifyNewJoin||this.next>1)}shouldUseDelay(g){return 2===g.GetOutCome()||Date.now()-g.GetLastSelectedTime()<=this.useDelayThreshold}async forceProbing(){const g=[],m=Array.from(this.coordinateCache.values());for(let f=0;f<m.length;f++){const S=m[f];if(S.IsActiveProbingOngoing())continue;S.SetActiveProbingIsOngoing(!0);const v=S.GetMediaUrl();g.push(this.coordinatesHealthProber.EnsureAlive(v).then((g=>{g.isSuccess||this.totalProbeFailures++,S.SetActiveProbingResult(g)})))}try{await Promise.all(g)}catch(g){}}startActiveProbing(){if(this.disableActiveProbing)return;const g=this.coordinatesHealthProber.GetProbingPolicy()?.probingInterval??6e5;self.clearInterval(this.probeInterval),this.probeInterval=self.setInterval((()=>this.forceProbing()),g)}getNextProbeKey(){const g=this.getSortedCoordinateDetails((()=>!0));for(let m=0;m<g.length;m++){const f=g[m].GetOwnKey();if(!(this.isConflict(f)&&g.length>1))return[f,5]}return this.getNextSmartKey()}isECSOptionsProvided(){return this.ecsSwitchingOrder.length>0}getSortedCoordinateDetails(g){if(this.disableActiveProbing)return[];this.forceProbing();let isPresentInECSOptions=()=>!0;this.isECSOptionsProvided()&&(isPresentInECSOptions=g=>this.ecsSwitchingOrder.includes(g.GetOwnKey()));const m=this.coordinatesHealthProber.GetProbingPolicy()?.timeToLive??3e4;return Array.from(this.coordinateCache.values()).filter((g=>Number.isInteger(g.GetLastProbeTime())&&Number.isInteger(g.GetLastRtt())&&g.GetOwnKey()!==this.lastChosenKey)).filter(g).filter(isPresentInECSOptions).sort(((g,f)=>{const S=f.GetLastProbeTime()-g.GetLastProbeTime();return Math.abs(S)<=m?g.GetLastRtt()-f.GetLastRtt():S}))}getMostRecentProbedKey(){const g=this.getSortedCoordinateDetails((g=>{const m=g.GetLastProbeTime();if(m){const g=this.coordinatesHealthProber.GetProbingPolicy().timeToLive??this.DEFAULT_TIME_TO_LIVE,f=Date.now();if(Math.max(f-m,0)<=g)return!0}return!1}));return g?.[0]?.GetOwnKey()}},Tt=class extends Ve{constructor(g,m,f){super(),this.logger=g,this.liveStreamStatistic=m,this.configProvider=f,this.playerState="Destroyed",this.captionsTimestamp=0,this.isSwitchStreamingUrlOngoing=!1,this.isDisposed=!1,this.streamingCoordinatesSelector=new Et(this.configProvider.config.hlsSettings.switchingPolicy),this.id=generateGuid(),this.logger.info(`HlsLiveStreamPlayer created: ID: ${this.id}`)}get playerId(){return this.id}async configure(g){this.liveStreamOptions={...g};const m=this.streamingCoordinatesSelector.UpdateCandidates(this.liveStreamOptions);m>0&&(this.logger.info(`Live Stream configuration provided ${m} new Coordinates`),this.liveStreamStatistic.registerStreamOptionsConfigured(g,`{NewCoordinatesCount: ${m}}`)),this.playerInstance?.message("configureThaPlugin").send()}async loadPlayer(g){const m=`LoadPlayer for isDisposed:${this.isDisposed}`;if(this.isDisposed=!1,this.playerInstance)return this.logger.error("playerLoadFailed: cannot load a player while current one is still active"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(0===this.streamingCoordinatesSelector.GetSize()){this.logger.error("playerLoadFailed: empty/invalid primary and alternate stream info configured");const g=this.getRedactedStreamOptions(this.liveStreamOptions?.stream),m=this.getRedactedStreamOptions(this.liveStreamOptions?.altStream);return{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:`empty/invalid primary and alternate stream info configured liveStreamOptions: primary: ${stringifyObject(g)}, altStream: ${stringifyObject(m)}`}}}let f;this.playerInstance=new ut(this.logger.createChild("PlayerWrapper")),this.playerInstance.on("stateChanged",((g,m)=>this.hlsStateChanged(g,m))),this.playerInstance.on("captionsToggled",((g,m,f)=>this.captionsToggled(g,m,f))),this.playerInstance.on("statsUpdated",(g=>this.liveStreamStatistic.registerStatsUpdated(g))),await this.playerInstance.initialize(g,this.liveStreamOptions,this.configProvider,this.id,1),this.liveStreamStatistic.registerEventLoadAttempt("Load"),this.liveStreamStatistic.registerEventLoadAttempt("LoadHlsScript"),this.srcLoadPromise||(this.srcLoadPromise=this.playerInstance.message("loadPlayerScript").send());try{f=await this.srcLoadPromise}catch(g){const m=stringifyObject(g);return this.logger.error(`playerLoadFailed: player scripts load failed: ${m}`),this.liveStreamStatistic.registerEventLoadFailed("LoadHlsScript",`${m}`),this.liveStreamStatistic.registerEventLoadFailed("Load","Player Load failed"),this.srcLoadPromise=null,{setupSucceeded:!1,playerSetupError:{errorType:"PlayerScriptLoadFailed",errorMessage:m}}}this.liveStreamStatistic.registerEventLoadSucceeded("LoadHlsScript",f),await this.tryLoadSdnPlugin();try{await this.playerInstance.message("createHls").send()}catch(g){const m=stringifyObject(g);return this.logger.error(`playerLoadFailed ${m}`),this.liveStreamStatistic.registerEventLoadFailed("Load",`playerLoadFailed ${m}`),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:m}}}try{return await this.setPlayerSource(m,!1),this.liveStreamStatistic.registerEventLoadSucceeded("Load"),this.playerState="Initialized",this.logger.info("setPlayerSource succeeded"),this.loadAndConfigureThaPlugin(),{setupSucceeded:!0}}catch(g){const m=stringifyObject(g);return this.logger.error(`setPlayerSource failed ${m}`),this.liveStreamStatistic.registerEventLoadFailed("Load","setPlayerSource failed"),{setupSucceeded:!1,playerSetupError:{errorType:"SetSourceFailed",errorMessage:`failed to set player source error: ${m}`}}}}getRedactedStreamOptions(g){return g?{url:g?.hlsUrls??g?.url,keydeliveryurl:g?.keyDeliveryUrl,streamDeliveryPipeline:g?.streamDeliveryPipeline,sdnContext:g?.sdnContext?"valid":"empty",keyAuthoizationToken:g?.keyAuthorizationToken?"valid":"empty"}:{}}getRenderer(){return!this.renderer&&this.playerInstance&&(this.renderer=new gt(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.destroy("PlayerStopped")}getPlaybackState(){return this.playerState}getCaptionsTimestamp(){return this.captionsTimestamp}getCaptionsControl(){if(!this.captionsControl&&this.playerInstance){const g=this.liveStreamOptions.supportedSubtitleLanguages?this.liveStreamOptions.supportedSubtitleLanguages.map((g=>g.culture)):["en","es"];this.captionsControl=new pt(this.playerInstance,g)}return this.captionsControl}getStreamSize(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g?{width:g.mediaWidth,height:g.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}hlsStateChanged(g,m){switch(g){case"error":return this.handlePlaybackError(m);case"canplaythrough":return this.onCanplaythrough();case"play":return this.onPlay();case"playing":return this.onPlaying();case"pause":return this.onPause();case"start":return this.onStart();case"ended":return this.onEnded();case"seeking":return this.onSeeking();case"seeked":return this.onSeeked(m);case"loadedmetadata":return this.onMetadataLoaded();case"waiting":return this.onWaiting(m);case"stalled":return this.onStalled();case"playbackbitratechanged":return this.onPlaybackBitrateChanged(m);case"downloadbitratechanged":return this.onDownloadBitrateChanged(m);case"volumechange":return this.onVolumeChange(m);case"loadstart":return this.onLoadStart();case"loadeddata":return this.onLoadedData();case"skippingSegment":return this.onSkippingSegment(m);case"hlsKeyLoading":return this.onHlsKeyLoading(m);case"hlsKeyLoaded":return this.onHlsKeyLoaded();case"hlsKeyLoadedFailed":return this.onHlsKeyLoadedFailed(m);case"hlsManifestLoading":return this.onManifestLoading();case"hlsManifestLoaded":return this.onManifestLoaded();case"hlsManifestLoadedFailed":return this.onManifestLoadedFailed(m);case"hlsFragLoading":return this.onFirstFragLoading();case"hlsFragBuffered":return this.onFirstFragLoaded();case"hlsFirstFragmentLoadFailed":return this.onFirstFragLoadFailed(m);case"online":return this.liveStreamStatistic.registerExperimentalEvent("Online");case"offline":return this.liveStreamStatistic.registerExperimentalEvent("Offline");case"networkChange":return this.liveStreamStatistic.registerExperimentalEvent("NetworkChange",m);default:this.logger.warn(`Unknown hls event ${g}`)}}async handlePlaybackError(g){this.playerState="Error";const m=stringifyObject(g);if(this.logger.info(`Playback error ${m}`),!g.message)return this.logger.error("onError: error details are not available"),this.raisePlaybackError("Unknown",m),void this.destroy("PlaybackError");const f="LowBufferReserve"===g.type;if(f){const m=!this.configProvider.config.hlsSettings.stallDetectionPolicy||!g.shouldSwitch;if(this.liveStreamStatistic.registerExperimentalEvent("LowBufferReserve",g.message,`shouldSkipSwitching: ${m}`),m)return Promise.resolve()}if(g.fatal){await this.playerInstance.message("stopBufferCheck").send();try{await this.setPlayerSource(`Error: ${g.message}`,!0),f||this.raisePlaybackError("PlaybackRetried",m)}catch(f){this.handleSwitchingFailure(g,m,f)}}}handleSwitchingFailure(g,m,f){const S=f||m;switch(this.logger.error(`FATAL switching URL error: ${S}, Destroying player`),g.type){case"networkError":this.raisePlaybackError("NetworkError",m);break;case"mediaError":case"keySystemError":case"muxError":this.raisePlaybackError("PlaybackError",m);break;default:this.raisePlaybackError("Unknown",m)}this.destroy("PlaybackError")}raisePlaybackError(g,m){this.liveStreamStatistic.registerPlaybackError(g,m),this.configProvider.config.hlsSettings.stopTerminating&&"PlaybackRetried"!==g||this.event("playbackError").raise(g,m)}captionsToggled(g,m,f){this.event("captionsToggled").raise(g,m,f),this.liveStreamStatistic.registerCaptionToggle(g,m,f)}async tryLoadSdnPlugin(){if(this.sdnPluginLoadPromise)return void this.raiseSdnPluginSkippedEvent("SDN plugin already loaded");if(!this.liveStreamOptions.sdn)return void this.raiseSdnPluginSkippedEvent("No SDNs configured in liveStreamOptions");if(this.liveStreamOptions.sdn&&!this.liveStreamOptions.sdn.url)return void this.raiseSdnPluginSkippedEvent("No SDN script configured in liveStreamOptions");if(!this.configProvider.config.allowSdnPlugins)return void this.raiseSdnPluginSkippedEvent("Client configured to not allow SDN plugins");switch(this.liveStreamOptions.sdn.name){case"peer5":case"microsoft":break;default:return void this.logger.warn(`unsupported SDN provider: ${this.liveStreamOptions.sdn.name}`)}let g;this.liveStreamStatistic.registerEventLoadAttempt("SdnPluginLoad",this.liveStreamOptions.sdn.name);try{this.sdnPluginLoadPromise=this.playerInstance.message("tryLoadSdnPlugin").send(),await this.sdnPluginLoadPromise,this.liveStreamStatistic.registerEventLoadSucceeded("SdnPluginLoad")}catch(m){g=stringifyObject(m),this.sdnPluginLoadPromise=void 0,this.logger.error(`loadSdnPlugin failed: ${g}`),this.liveStreamStatistic.registerEventLoadFailed("SdnPluginLoad",`loadSdnPlugin failed: ${g}`),this.event("sdnPluginLoadFailed").raise(g)}}loadAndConfigureThaPlugin(){this.tryLoadThaPlugin().then((()=>{this.playerInstance.message("configureThaPlugin").send()})).catch((g=>{this.logger.info(`tryLoadThaPlugin failed: ${stringifyObject(g)}`)}))}async tryLoadThaPlugin(){if(this.thaPluginLoadPromise)return this.logger.info("THA plugin already loaded"),Promise.reject(new Error("THA plugin already loaded"));if(this.liveStreamOptions.streamingEventType&&"TownHall_Premium"!==this.liveStreamOptions.streamingEventType)return this.logger.warn(`THA is allowed only for Town Hall Premium meetings and not for ${this.liveStreamOptions.streamingEventType}`),Promise.reject(new Error(`THA is allowed only for Town Hall Premium meetings and not for ${this.liveStreamOptions.streamingEventType}`));if(!this.liveStreamOptions.thaContext)return this.logger.warn("THA context is not present"),Promise.reject(new Error("THA context is not present"));if(!this.configProvider.config.hlsSettings.thaScript)return this.logger.warn("No THA script configured"),Promise.reject(new Error("No THA script configured"));let g;this.liveStreamStatistic.registerEventLoadAttempt("ThaPluginLoad",this.configProvider.config.hlsSettings.thaScript);try{this.thaPluginLoadPromise=this.playerInstance.message("tryLoadThaPlugin").send(),await this.thaPluginLoadPromise,this.liveStreamStatistic.registerEventLoadSucceeded("ThaPluginLoad")}catch(m){g=stringifyObject(m),this.thaPluginLoadPromise=void 0,this.logger.error(`THA plugin load failed: ${g}`),this.liveStreamStatistic.registerEventLoadFailed("ThaPluginLoad",g)}}raiseSdnPluginSkippedEvent(g){this.logger.warn(`skipping SDN plugin load: ${g}`),this.event("sdnPluginLoadSkipped").raise(g)}async internalSetSource(g,m){try{return await this.playerInstance.message(g).send(m.GetMetadata(),m.IsPrimary()),Promise.resolve()}catch(f){return Promise.reject(`Failing inside playerInstance.message:${g}, url:${m.GetMediaUrl()}, e:${f}`)}}async setPlayerSource(g,m){if(!this.playerInstance)return this.logger.error("setPlayerSource: playerInstance is null"),Promise.reject("setPlayerSource: playerInstance is null");this.liveStreamStatistic.registerSetSourceAttempt(void 0,g);let f=!1;return this.logger.info(`ENTRY setPlayerSource reason:${g}, switchCount:${this.streamingCoordinatesSelector.GetSwitchCount()}`),this.streamingCoordinatesSelector.GetCoordinates().then((S=>{const v=S.GetMetadata(),C=S.GetBackOffDelay(),_=S.GetMediaUrl();return this.retry((()=>this.setAuthCookieRequest(v)),C).then((()=>{const g=m?"switchStreamingUrl":"setSource";return new Promise(((m,f)=>{self.setTimeout((()=>this.internalSetSource(g,S).then((g=>m(g)),(g=>f(g)))),C)}))})).then((()=>(this.isSwitchStreamingUrlOngoing=m,this.liveStreamStatistic.registerSetSourceSucceeded(_,this.streamingCoordinatesSelector.GetDiagnostics()),this.logger.info(`EXIT setPlayerSource reason:${g}, switchCount:${this.streamingCoordinatesSelector.GetSwitchCount()}, backOffDelay:${C}, url:${_}, SUCCESS`),Promise.resolve()))).catch((S=>{f=!0;const v=stringifyObject(S);return this.liveStreamStatistic.registerSetSourcedFailed(v,_,this.streamingCoordinatesSelector.GetDiagnostics()),this.logger.error(`EXIT setPlayerSource reason:${g}, switchCount:${this.streamingCoordinatesSelector.GetSwitchCount()}, switchDetails:${this.streamingCoordinatesSelector.GetSwitchDetails()}, backOffDelay:${C}, url: ${_}, Retriable error:[${v}]`),this.setPlayerSource(`Retry from setPlayerSource, ${v}`,m)}))})).catch((m=>{if(!f){const f=stringifyObject(m);this.liveStreamStatistic.registerSetSourcedFailed(f,"Failed to find valid URL",this.streamingCoordinatesSelector.GetDiagnostics()),this.logger.error(`EXIT setPlayerSource reason:${g}, switchCount:${this.streamingCoordinatesSelector.GetSwitchCount()}, switchDetails:${this.streamingCoordinatesSelector.GetSwitchDetails()}, FATAL error:[${f}]`)}return Promise.reject(m)}))}async setAuthCookieRequest(g){const m=getRandomHexString(16),f="00-"+this.id.replace(/-/g,"")+"-"+m+"-01";try{g.keyDeliveryUrl&&g.keyAuthorizationToken&&(this.liveStreamStatistic.registerEventLoadAttempt("LoadHlsAuthCookie"),await fetch(g.keyDeliveryUrl,{method:"post",credentials:"include",headers:{"Content-Type":"application/json",traceparent:f},body:JSON.stringify({keyAuthorizationToken:g.keyAuthorizationToken})}).then((g=>g.ok?(this.liveStreamStatistic.registerEventLoadSucceeded("LoadHlsAuthCookie"),Promise.resolve()):Promise.reject(new Error(`Unexpected KeyDelivery response status ${g.status}`)))))}catch(S){return this.liveStreamStatistic.registerEventLoadFailed("LoadHlsAuthCookie",`Setting authorization cookie failed ${S}`),Promise.reject(new Error(`Setting authorization cookie failed ${S} for ${g.keyDeliveryUrl} spanId: ${m} traceparent: ${f}`))}}retry(g,m,f=4,S=!1){return g(f).catch((v=>0==--f?Promise.reject(`${v}`):new Promise((C=>setTimeout((()=>C(this.retry(g,Math.max(m,200),f,S).catch((g=>S?Promise.reject(`${v}`.concat(", ",g)):Promise.reject(g))))),m)))))}destroy(g){this.configProvider.config.hlsSettings.stopTerminating&&"PlaybackError"===g?this.streamingCoordinatesSelector.StopActiveProbing():(this.isDisposed=!0,this.srcLoadPromise=null,this.sdnPluginLoadPromise=null,this.renderer&&(this.renderer.dispose(),this.renderer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null),this.playerInstance&&(this.liveStreamStatistic.registerPlayerDestroyed(g),this.playerInstance.dispose(),this.playerInstance=null,this.streamingCoordinatesSelector.StopActiveProbing(),this.setPlaybackState("Destroyed")))}onCanplaythrough(){this.setPlaybackState("Ready")}onPlay(){this.setPlaybackState("Play")}onPlaying(){this.streamingCoordinatesSelector.RecordSuccess(),this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onStart(){this.logger.info("Playback started"),this.setPlaybackState("Start"),this.isSwitchStreamingUrlOngoing&&(this.logger.info(`Playback started, switch count: ${this.streamingCoordinatesSelector.GetSwitchCount()}`),this.event("urlSwitched").raise(!0),this.isSwitchStreamingUrlOngoing=!1)}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(g){this.captionsTimestamp=g.captionsTimestamp,this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(g){this.setPlaybackState("Buffering",g)}onStalled(){this.setPlaybackState("Stalled")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}onSkippingSegment(g){this.setPlaybackState("SkippingSegment"),this.liveStreamStatistic.registerPotentialMediaFreeze(g)}setPlaybackState(g,m){this.playerState=g,this.logger.debug(`playback state changed: ${g}`),this.liveStreamStatistic.registerPlaybackStateChanged(g,m),this.event("playbackStateChanged").raise()}onVolumeChange(g){this.liveStreamStatistic.registerVolumeChange(g.value)}onPlaybackBitrateChanged(g){this.liveStreamStatistic.registerPlaybackBitratechanged(g.bitrate)}onDownloadBitrateChanged(g){this.liveStreamStatistic.registerDownloadBitratechanged(g.bitrate)}onManifestLoading(){this.liveStreamStatistic.registerEventLoadAttempt("HlsManifestLoad")}onManifestLoaded(){this.liveStreamStatistic.registerEventLoadSucceeded("HlsManifestLoad")}onManifestLoadedFailed(g){this.liveStreamStatistic.registerEventLoadFailed("HlsManifestLoad",g.message),this.handlePlaybackError(g)}onHlsKeyLoading(g){this.liveStreamStatistic.registerEventLoadAttempt("HlsKeyLoad",g)}onHlsKeyLoaded(){this.liveStreamStatistic.registerEventLoadSucceeded("HlsKeyLoad")}onHlsKeyLoadedFailed(g){this.liveStreamStatistic.registerEventLoadFailed("HlsKeyLoad",g)}onFirstFragLoading(){this.liveStreamStatistic.registerEventLoadAttempt("LoadHlsFirstFragment")}onFirstFragLoaded(){this.liveStreamStatistic.registerEventLoadSucceeded("LoadHlsFirstFragment")}onFirstFragLoadFailed(g){this.liveStreamStatistic.registerEventLoadFailed("LoadHlsFirstFragment",g)}},It=class{constructor(g,m,f){this.video=m,this.streamingStartedTimestamp=f,this.currentSnapshot={playerType:2,traceId:null,currentPlayPosition:null,playerHeight:null,playerWidth:null,mediaHeight:null,mediaWidth:null,windowHeight:null,windowWidth:null,videoStream:null,audioStream:null,totalDurationInSeconds:null,videoBufferLength:null,videoCachedLength:null,audioBufferLength:null,audioCachedLength:null,videoEdgeLatency:null,audioEdgeLatency:null,playbackRate:null,playbackBitrate:null,downloadBitrate:null,audioDownloadBitrate:null,audioPlaybackBitrate:null,isFullscreen:null,streamType:null,playerVersion:null,isP2PSdnUsed:null,sdnName:null,livePosition:null,muted:null,volume:null,retryFrequency:null,averageDownloadBitrate:null,initialStreamConnectionHttpRetryCount:0,initialStreamConnectionEstablished:!1,streamConnectionResults:[],originNodeFqdn:null,deliveryNodeFqdn:null,videoReadyState:null,minEdgeLatencyInInterval:null,maxEdgeLatencyInInterval:null,avgEdgeLatencyInInterval:null,edgeLatencyVariationInInterval:null,playerEdgeLatencyHistoryInterval:null,targetEdgeLatency:null,serverBufferStartTime:null,serverBufferEndTime:null,lastUploadedTime:null,serverQueueAvailability:null,bufferEndDelay:null,mediaDelay:null,estimatedSpeedup:null,appliedSpeedup:null,speedupIncreaseAppliedCount:0,speedupResetCount:0,minResolutionSelectedCount:0,resolutionIncreaseCount:0,maxResolutionSelectedCount:0,inputStreamState:0,inputChunkCount:0,inputByteCount:0,inputBitrate:0,outputStreamState:0,outputChunkCount:0,outputByteCount:0,playerQueueSize:0,mp4StreamHydraErrorMessage:null,recentHopLatencyMetrics:null,overallHopLatencyMetrics:null,serviceAvgLatency:null,endToEndAvgLatency:null,serviceLatencyCdg:null,endToEndLatencyCdg:null,videoEdgeLatencyCdg:null,streamUrl:null,streamId:null,streamingEventType:null,playerControlsEnabled:null,streamDeliveryPipeline:null,totalDownloadedBytes:0,retryCount:0,totalPlayingTimeInSeconds:0,originNodeChangeCount:0,deliveryNodeChangeCount:0,bufferingRate:0,videoTrackHistory:[],videoTrackTotalDurations:[],memoryLog:null,statsInterval:null},this.setValue("traceId",g.replace(/-/g,""))}setValue(g,m){this.currentSnapshot[g]=m}getValue(g){return this.currentSnapshot[g]}getPlayerDiagnosticSnapshot(){this.currentSnapshot.currentPlayPosition=this.video.currentTime,this.currentSnapshot.windowHeight=window.screen?window.screen.height:0,this.currentSnapshot.windowWidth=window.screen?window.screen.width:0,this.currentSnapshot.playerHeight=this.video.offsetHeight,this.currentSnapshot.playerWidth=this.video.offsetWidth,this.currentSnapshot.mediaHeight=this.video.videoHeight,this.currentSnapshot.mediaWidth=this.video.videoWidth,this.currentSnapshot.isFullscreen=document.fullscreenElement===this.video,this.currentSnapshot.streamType="LIVE",this.currentSnapshot.muted=this.video.muted,this.currentSnapshot.volume=this.video.volume,this.currentSnapshot.isP2PSdnUsed=!1,this.currentSnapshot.videoReadyState=this.video.readyState,this.currentSnapshot.playbackRate=this.video.playbackRate,this.currentSnapshot.totalDurationInSeconds=this.getTotalDurationInSeconds();const g=this.getPlayerBufferedLength(),m=this.getPlayerCachedLength(),f=this.getPlayerEdgeLatency();return this.currentSnapshot.videoBufferLength=g,this.currentSnapshot.audioBufferLength=g,this.currentSnapshot.videoCachedLength=m,this.currentSnapshot.audioCachedLength=m,this.currentSnapshot.videoEdgeLatency=f,this.currentSnapshot.audioEdgeLatency=f,this.currentSnapshot.livePosition=this.getLivePosition(),this.currentSnapshot.retryFrequency=this.getRetryFrequency(),this.currentSnapshot.averageDownloadBitrate=this.getAverageDownloadBitrate(),this.currentSnapshot}getTotalDurationInSeconds(){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;return Number(g.toFixed(0))}getPlayerBufferedLength(){const g=this.video.buffered,m=this.video.currentTime;let f=0;for(let S=0;S<g.length;S++)g.start(S)<=m&&m<g.end(S)?f+=g.end(S)-m:m<g.start(S)&&(f+=g.end(S)-g.start(S));return f}getPlayerCachedLength(){const g=this.video.buffered;let m=0;for(let f=0;f<g.length;f++)m+=g.end(f)-g.start(f);return m}getPlayerEdgeLatency(){const g=this.video.buffered;if(0===g.length)return 0;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));return m-this.video.currentTime}getLivePosition(){const g=this.video.buffered;if(0===g.length)return 0;let m=g.end(0);for(let f=1;f<g.length;f++)m=Math.max(m,g.end(f));return m}getRetryFrequency(){const g=this.currentSnapshot.retryCount;if(this.streamingStartedTimestamp&&g){const m=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/6e4;if(m>0)return g/m}return 0}getAverageDownloadBitrate(){if(this.streamingStartedTimestamp&&this.currentSnapshot.totalDownloadedBytes){const g=((new Date).getTime()-this.streamingStartedTimestamp.getTime())/1e3;if(g>0)return 8*this.currentSnapshot.totalDownloadedBytes/g}return 0}dispose(){}},bt=class extends Ve{constructor(g,m){super(m),this.logger=m,this.playerSubs=[],this.isRendering=!1,this.player=g,this.subscribeForPlayerEvents()}get streamSize(){return this.player?this.player.getStreamSize():{width:0,height:0}}get rendererType(){return 0}get frameType(){return-1}dumpVideoSourceImages(){throw new Error("Method not implemented.")}cameraAutoControl(g){throw new Error("Method not implemented.")}getCameraManualControlStates(g){throw new Error("Method not implemented.")}setCameraManualControlStates(g){throw new Error("Method not implemented.")}enumerateCameraManualControls(){throw new Error("Method not implemented.")}captions(){return this.player.getCaptionsControl()}dispose(){this.stopPlayer(),super.dispose()}getStats(){throw new Error("Method not implemented.")}setScalingMode(g,m){throw new Error("Method not implemented.")}captureFrame(g,m){throw new Error("Method not implemented.")}stopPlayer(){this.player&&(this.logger.info("stopping UMS player"),this.player.stop(),this.unsubscribeFromPlayerEvents(),this.player=null)}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("playbackStateChanged",(()=>this.onPlaybackStateChanged())))}unsubscribeFromPlayerEvents(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onPlaybackStateChanged(){switch(this.player.getPlaybackState()){case"Playing":this.isRendering=!0,this.raiseChanged();break;case"Error":case"Ended":case"Destroyed":this.isRendering=!1,this.raiseChanged()}}},At=__toESM(te());async function Mp4Stream(g,m,f,S,v){return new Pt(await(0,At.default)({locateFile:()=>new URL(g).toString()}),m,f,S,v)}var Pt=class{constructor(g,m,f,S,v){this._wasm=g,this._stat=m,this._onMessage=f,this._onLatencyTrace=S,this._useInterleaver=v,this.initWasmTranscoder()}async setupStream(g){for(console.assert(!this._reader),this._reader=g.getReader();!this._streamMimeType;)if(await this.processOneInputChunk(),this._inputDone)throw new Error("Unexpected input UMS stream end");const m=this._streamMimeType;return this._streamMimeType=null,m}setDecryptionKey(g,m){const f=this._wasm.allocateUTF8OnStack(g),S=this._wasm.stackAlloc(m.byteLength);this._wasm.HEAPU8.set(new Uint8Array(m),S),this._wasm._TranscoderSetDecryptionKey(f,S,m.byteLength)}async read(){for(;!(this._outArray||this._inputDone||this._streamMimeType||this._fatalError);)await this.processOneInputChunk();if(this._fatalError)return{value:null,done:null,event:{name:"Error",details:this._fatalError}};if(this._streamMimeType){const g={name:"Restart",mime:this._streamMimeType};return this._streamMimeType=null,{value:null,done:null,event:g}}const g={value:this._outArray,done:this._inputDone,event:null};return this._outArray=null,g}close(){clearInterval(this._intervalId),this._wasm._DeleteTranscoder(),this._streamReadyFunPtr&&this._wasm.removeFunction(this._streamReadyFunPtr),this._outputFunPtr&&this._wasm.removeFunction(this._outputFunPtr),this._fatalErrorFunPtr&&this._wasm.removeFunction(this._fatalErrorFunPtr),this._umsMessageFunPtr&&this._wasm.removeFunction(this._umsMessageFunPtr),this._latencyTraceFunPtr&&this._wasm.removeFunction(this._latencyTraceFunPtr),!this._inputDone&&this._reader&&(this._reader.cancel(),null!==this._stat&&this._stat.onInputStreamCancelled())}initWasmTranscoder(){this._streamReadyFunPtr=this._wasm.addFunction((g=>{this._streamMimeType=this._wasm.UTF8ToString(g),this._outArray=null}),"vi"),this._outputFunPtr=this._wasm.addFunction(((g,m)=>{console.assert(m>=2),console.assert(m%2==0);let f=0;const S=new Uint32Array(this._wasm.HEAPU8.buffer,g,m);for(let g=1;g<S.length;g+=2)f+=S[g];null!==this._stat&&null!==this._stat.onOutputChunk&&this._stat.onOutputChunk(f);let v=0;if(this._outArray){const g=new Uint8Array(this._outArray.length+f);g.set(this._outArray,0),v=this._outArray.length,this._outArray=g}else this._outArray=new Uint8Array(f);for(let g=1;g<S.length;g+=2){const m=S[g-1],f=S[g],C=new Uint8Array(this._wasm.HEAPU8.buffer,m,f);this._outArray.set(C,v),v+=f}}),"vii"),this._fatalErrorFunPtr=this._wasm.addFunction((g=>{this._fatalError=this._wasm.UTF8ToString(g)}),"vi"),this._umsMessageFunPtr=this._wasm.addFunction((g=>{this._onMessage(this._wasm.UTF8ToString(g))}),"vi"),this._latencyTraceFunPtr=this._wasm.addFunction((g=>{this._onLatencyTrace(this._wasm.UTF8ToString(g))}),"vi"),this._wasm._CreateTranscoder(this._streamReadyFunPtr,this._outputFunPtr,this._fatalErrorFunPtr,this._umsMessageFunPtr,this._latencyTraceFunPtr,this._useInterleaver),this._intervalId=window.setInterval((()=>this._wasm._TranscoderRunTurn(50)),50)}async processOneInputChunk(){const{done:g,value:m}=await this._reader.read();if(m){null!==this._stat&&null!==this._stat.onInputChunk&&this._stat.onInputChunk(m.length);const g=this._wasm._TranscoderAllocateBuffer(m.length);new Uint8Array(this._wasm.HEAPU8.buffer,g,m.length).set(m),this._wasm._TranscoderConsumeBuffer(g,m.length)}g&&(this._inputDone=!0,null!==this._stat&&this._stat.onInputStreamDone())}},Rt=class{constructor(g,m,f,S){this.logger=g,this.configProvider=m,this.diagnosticProvider=f,this.trackSwitchFun=S,this.edgeLatencyHistoryLength=15,this.edgeLatencyHistory=[],this.varEdgeLatency=0,this.boundedAvgEdgeLatency=0,this.targetEdgeLatencyEstimatorTimer=null,this.maxSpeedup=.5,this.edgeLatencyMaxTarget=2,this.speedGranularity=.08,this.dempferTickCount=10,this.needSpeedupTickCount=0,this.playbackAdjusterTimer=null,this.pipelineId=0,this.connectionId=0,this.tracks=[],this.currentVideoTrack=0,this.desiredVideoTrack=0,this.sortedVideoTracks=[],this.paranoiacAlertThreshold=1.5,this.alertMode=!1,this.resolutionReviseTimeout=5e3,this.resolutionReviseTime=this.resolutionReviseTimeout,this.resolutionAdjusterTimer=null,this.targetEdgeLatency=this.configProvider.config.umsSettings.minTargetEdgeLatency}get videoTargetEdgeLatency(){return this.targetEdgeLatency}start(g,m,f){this.streamUrl=m,this.correlationId=f,this.video=g,this.runTargetEdgeLatencyEstimator(),this.runPlaybackSpeedAdjuster(),this.configProvider.config.umsSettings.allowPlayerTrackSwitch&&this.runVideoResolutionAdjuster()}runTargetEdgeLatencyEstimator(){let g=0;this.targetEdgeLatencyEstimatorTimer=window.setInterval((()=>{let m=this.edgeLatencyHistory.length>0?this.edgeLatencyHistory[0]:0,f=this.edgeLatencyHistory.length>0?this.edgeLatencyHistory[0]:0,S=0;for(const g of this.edgeLatencyHistory)m=Math.min(m,g),f=Math.max(f,g),S+=g/this.edgeLatencyHistory.length;if(this.varEdgeLatency=f-m,this.video.buffered.length>0){const g=this.diagnosticProvider.getPlayerEdgeLatency();g&&(this.boundedAvgEdgeLatency=this.boundedAvgEdgeLatency>g?g:.99*this.boundedAvgEdgeLatency+.01*g)}const v=this.configProvider.config.umsSettings.minTargetEdgeLatency+this.varEdgeLatency;this.targetEdgeLatency=v>this.targetEdgeLatency?v:.1*v+.9*this.targetEdgeLatency,this.diagnosticProvider.setValue("minEdgeLatencyInInterval",Number(m.toFixed(3))),this.diagnosticProvider.setValue("maxEdgeLatencyInInterval",Number(f.toFixed(3))),this.diagnosticProvider.setValue("avgEdgeLatencyInInterval",Number(S.toFixed(3))),this.diagnosticProvider.setValue("edgeLatencyVariationInInterval",Number(this.varEdgeLatency.toFixed(3))),this.diagnosticProvider.setValue("targetEdgeLatency",Number(this.targetEdgeLatency.toFixed(3)));const C=this.diagnosticProvider.getValue("inputByteCount");if(!isNaN(C)){const m=C-g;g=C;let f=8*m/1e6*2;f<0&&(f=0),this.diagnosticProvider.setValue("inputBitrate",Number(f.toFixed(3)))}}),500)}runPlaybackSpeedAdjuster(){this.playbackAdjusterTimer=window.setInterval((()=>{if(this.configProvider.config.umsSettings.allowSpeedupLatencyCompensation?this.speedupLatencyCompensation():this.conservativeLatencyCompensation(),this.video.buffered.length>0){const g=this.diagnosticProvider.getPlayerEdgeLatency();if(g)for(this.edgeLatencyHistory.push(g);this.edgeLatencyHistory.length>this.edgeLatencyHistoryLength;)this.edgeLatencyHistory.shift()}this.configProvider.config.umsSettings.allowPlayerTrackSwitch&&this.checkVideoResolutionAlert()}),50)}speedupLatencyCompensation(){if(this.video.buffered.length>0){const g=this.diagnosticProvider.getPlayerEdgeLatency();if(g)if(g>this.targetEdgeLatency){const m=Math.min(g-this.targetEdgeLatency,this.edgeLatencyMaxTarget)*this.maxSpeedup/this.edgeLatencyMaxTarget;this.diagnosticProvider.setValue("estimatedSpeedup",Number(m.toFixed(3)));const f=m+1;if(Math.abs(f-this.video.playbackRate)>this.speedGranularity){let g=!1;if(f>this.video.playbackRate?(++this.needSpeedupTickCount,g=this.needSpeedupTickCount>this.dempferTickCount):(this.needSpeedupTickCount=0,g=!0),g){if(this.logger.info(`[speedupLatencyCompensation]: Change playback rate from: ${this.video.playbackRate.toFixed(3)} to:\n                                ${f.toFixed(3)}`),f>this.video.playbackRate){this.logger.info("[speedupLatencyCompensation]: Speedup applied");const g=this.diagnosticProvider.getValue("speedupIncreaseAppliedCount");this.diagnosticProvider.setValue("speedupIncreaseAppliedCount",g+1)}this.video.playbackRate=f,this.diagnosticProvider.setValue("appliedSpeedup",Number(m.toFixed(3)))}else this.diagnosticProvider.setValue("appliedSpeedup",0)}else this.diagnosticProvider.setValue("appliedSpeedup",0)}else if(this.needSpeedupTickCount=0,this.diagnosticProvider.setValue("appliedSpeedup",0),1!==this.video.playbackRate){this.video.playbackRate=1,this.logger.info("[speedupLatencyCompensation]: Target player edge latency reached");const g=this.diagnosticProvider.getValue("speedupResetCount");this.diagnosticProvider.setValue("speedupResetCount",g+1)}}}conservativeLatencyCompensation(){if(this.video.buffered.length>0){const g=this.diagnosticProvider.getPlayerEdgeLatency();if(g)if(g>this.targetEdgeLatency&&this.boundedAvgEdgeLatency>this.targetEdgeLatency){this.boundedAvgEdgeLatency=0,this.video.playbackRate<=1.05&&(this.video.playbackRate=1.2,this.diagnosticProvider.setValue("estimatedSpeedup",.2),this.diagnosticProvider.setValue("appliedSpeedup",.2));const m=this.diagnosticProvider.getValue("speedupIncreaseAppliedCount");this.diagnosticProvider.setValue("speedupIncreaseAppliedCount",m+1),this.logger.info(`[conservativeLatencyCompensation]: Conservative latency compensation in progress, latency ${g.toFixed(3)},\n                        speed ${this.video.playbackRate.toFixed(3)}`)}else if(this.video.playbackRate>1&&g<this.configProvider.config.umsSettings.minTargetEdgeLatency+this.varEdgeLatency&&this.configProvider.config.umsSettings.conservativeLatencyCompensationSpeedupReset){this.video.playbackRate=1,this.diagnosticProvider.setValue("estimatedSpeedup",0),this.diagnosticProvider.setValue("appliedSpeedup",0);const m=this.diagnosticProvider.getValue("speedupResetCount");this.diagnosticProvider.setValue("speedupResetCount",m+1),this.logger.info(`[conservativeLatencyCompensation]: Conservative latency compensation completed, latency ${g.toFixed(3)},\n                        speed ${this.video.playbackRate.toFixed(3)}`)}}}checkVideoResolutionAlert(){if(!(this.alertMode||this.sortedVideoTracks.length<2)&&this.targetEdgeLatency>this.paranoiacAlertThreshold){this.logger.info("[checkVideoResolutionAlert]: Network quality alert, switching to the minimal quality"),this.selectVideoTrack(this.sortedVideoTracks[0].track_id),this.alertMode=!0,this.resolutionReviseTime=this.resolutionReviseTimeout;const g=this.diagnosticProvider.getValue("minResolutionSelectedCount");this.diagnosticProvider.setValue("minResolutionSelectedCount",g+1)}}runVideoResolutionAdjuster(){const g=.5;let m=0,f=0;this.resolutionAdjusterTimer=window.setInterval((()=>{if(0===this.resolutionReviseTime||this.sortedVideoTracks.length<2)return;if(this.resolutionReviseTime=this.resolutionReviseTime>1e3?this.resolutionReviseTime-1e3:0,0!==this.resolutionReviseTime)return;if(this.targetEdgeLatency>g)return this.logger.info("[runVideoResolutionAdjuster]: Resolution increase supressed,\n                    network quality is not enough"),void(this.resolutionReviseTime=this.resolutionReviseTimeout);const S=this.sortedVideoTracks.findIndex((g=>g.track_id===this.currentVideoTrack));S>=0&&S<this.sortedVideoTracks.length-1&&(this.selectVideoTrack(this.sortedVideoTracks[S+1].track_id),this.alertMode=!1,this.diagnosticProvider.setValue("resolutionIncreaseCount",++m),S===this.sortedVideoTracks.length-2?(this.logger.info("[runVideoResolutionAdjuster]: Max resolution selected"),this.resolutionReviseTime=0,this.diagnosticProvider.setValue("maxResolutionSelectedCount",++f)):(this.logger.info("[runVideoResolutionAdjuster]: Resolution increased"),this.resolutionReviseTime=this.resolutionReviseTimeout))}),500)}onUmsMessage(g){const m=JSON.parse(g);if("track_list"===m.type)this.pipelineId=m.pid,this.connectionId=m.cid,this.tracks=m.tracks,this.tracks.sort(((g,m)=>g.track_id<m.track_id?-1:1)),this.sortedVideoTracks=this.tracks.filter((g=>"Video"===g.modality)),this.sortedVideoTracks.sort(((g,m)=>g.bitrate<m.bitrate?-1:1));else if("track_selected"===m.type){this.connectionId=m.cid;const g=this.tracks.find((g=>g.track_id===m.track_id));g&&("Video"===g.modality?(this.currentVideoTrack=g.track_id,this.diagnosticProvider.setValue("downloadBitrate",g.bitrate),this.diagnosticProvider.setValue("videoStream",{name:g.title,codec:null,currentTrack:{bitrate:g.bitrate}}),this.trackSwitchFun(g.bitrate)):"Audio"===g.modality&&(this.diagnosticProvider.setValue("audioDownloadBitrate",g.bitrate),this.diagnosticProvider.setValue("audioStream",{name:g.title,codec:null,bitrate:g.bitrate})))}else if("connection_status"===m.type){const g=m.recorder_start_time/1e6,f=m.recorder_end_time/1e6,S=m.uploaded_time/1e6;this.diagnosticProvider.setValue("serverBufferStartTime",Number(g.toFixed(3))),this.diagnosticProvider.setValue("serverBufferEndTime",Number(f.toFixed(3))),this.diagnosticProvider.setValue("lastUploadedTime",Number(S.toFixed(3))),this.diagnosticProvider.setValue("serverQueueAvailability",m.queue_availability);const v=f-S;if(this.diagnosticProvider.setValue("bufferEndDelay",Number(v.toFixed(3))),this.video.buffered.length>0){const g=f-S+(this.diagnosticProvider.getLivePosition()-this.video.currentTime);this.diagnosticProvider.setValue("mediaDelay",Number(g.toFixed(3)))}}}async selectVideoTrack(g){g!==this.currentVideoTrack&&g!==this.desiredVideoTrack&&(this.desiredVideoTrack=g,await this.requestTrack(this.desiredVideoTrack))}async requestTrack(g){const m=this.getRandomHexString(16),f="00-"+this.correlationId.replace(/-/g,"")+"-"+m+"-01",S={control:{type:"select_video_track",pid:this.pipelineId,cid:this.connectionId,track_id:g}},v=await this.postData(this.streamUrl,S,f);if(200!==v.status){this.logger.warn(`[requestTrack]: select_video_track failed: ${v}`);const g=this.diagnosticProvider.getValue("streamConnectionResults");g.push({isSuccess:!1,timestamp:(new Date).getTime(),traceparent:f,spanId:m,errorCode:v.status,error:v.statusText,url:this.streamUrl}),this.diagnosticProvider.setValue("streamConnectionResults",g)}}postData(g="",m={},f){return fetch(g,{method:"POST",mode:"no-cors",cache:"no-cache",headers:{"Content-Type":"application/json",traceparent:f},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(m)})}getRandomHexString(g){return Array.from(Array(g)).map((()=>Math.floor(16*Math.random()).toString(16))).join("")}reset(){this.edgeLatencyHistory=[],this.targetEdgeLatency=this.configProvider.config.umsSettings.minTargetEdgeLatency,this.varEdgeLatency=0,this.boundedAvgEdgeLatency=0,this.needSpeedupTickCount=0,this.connectionId=0,this.tracks=[],this.currentVideoTrack=0,this.desiredVideoTrack=0,this.sortedVideoTracks=[],this.alertMode=!1,this.resolutionReviseTime=this.resolutionReviseTimeout,window.clearInterval(this.targetEdgeLatencyEstimatorTimer),window.clearInterval(this.playbackAdjusterTimer),window.clearInterval(this.resolutionAdjusterTimer)}},wt=class{constructor(g,m,f){this.logger=g,this.diagnosticProvider=m,this.recentHopLatenciesHistory=[],this.overallHopLatencies=[],this.overallHopJitters=[],this.endToEndLatencyHistory=[],this.serviceLatencyHistory=[],this.overallHopLatencyDeltas=[],this.numLatencyTraces=0,this.maxHopLatenciesHistorySize=10,this.maxLatencyHistoryStore=3600,this.calculateQuartile=(g,m)=>{const f=(g.length-1)*m,S=Math.floor(f),v=f-S;return void 0!==g[S+1]?g[S]+v*(g[S+1]-g[S]):g[S]}}processLatencyTrace(g){try{const m=[],f=[],S=JSON.parse(g),v=S.latency_trace.length;for(let g=0;g<v;g++){const{instance_id:f,pipeline_id:v}=S.latency_trace[g];m.push({instanceId:f,pipelineId:v})}JSON.stringify(m)!==JSON.stringify(this.currentLatencyTracePath)&&(this.logger.warn(`[processLatencyTrace] New latency trace path found ${JSON.stringify(m)}`),this.currentLatencyTracePath=m,this.recentHopLatenciesHistory=[],this.overallHopLatencies=[],this.overallHopJitters=[],this.overallHopLatencyDeltas=[],this.numLatencyTraces=0),this.numLatencyTraces++,this.serviceLatencyHistory.push(S.latency_trace[2].timestamp-S.latency_trace[0].timestamp);for(let g=0;g<v;g++){const m=S.latency_trace[g];if(g===v-1&&(this.endToEndLatencyHistory.length>=this.maxLatencyHistoryStore&&this.endToEndLatencyHistory.shift(),this.endToEndLatencyHistory.push(m.timestamp-S.latency_trace[0].timestamp)),g>0){const v=m.timestamp-S.latency_trace[g-1].timestamp;if(f.push(v),this.overallHopLatencies.length>g-1?this.overallHopLatencies[g-1]=(this.overallHopLatencies[g-1]*(this.numLatencyTraces-1)+v)/this.numLatencyTraces:this.overallHopLatencies[g-1]=v,this.numLatencyTraces>=2){const m=v-this.recentHopLatenciesHistory[this.recentHopLatenciesHistory.length-1][g-1];this.overallHopJitters.length>g-1?this.overallHopJitters[g-1]=(this.overallHopJitters[g-1]*(this.numLatencyTraces-2)+Math.abs(m))/(this.numLatencyTraces-1):this.overallHopJitters[g-1]=Math.abs(m),this.overallHopLatencyDeltas.length>g-1?this.overallHopLatencyDeltas[g-1]=(this.overallHopLatencyDeltas[g-1]*(this.numLatencyTraces-2)+m)/(this.numLatencyTraces-1):this.overallHopLatencyDeltas[g-1]=m}}}for(this.recentHopLatenciesHistory.push(f);this.recentHopLatenciesHistory.length>this.maxHopLatenciesHistorySize;)this.recentHopLatenciesHistory.shift();this.updateDiagnostics()}catch(g){const m=JSON.stringify(g);this.logger.warn(`[processLatencyTrace]: Failed to parse latency trace Json: ${m}`)}}updateDiagnostics(){const g=[];for(let m=0;m<this.recentHopLatenciesHistory[0].length;m++){let f,S,v,C;for(let g=0;g<this.recentHopLatenciesHistory.length;g++){const _=this.recentHopLatenciesHistory[g][m];if(f?f+=_/this.recentHopLatenciesHistory.length:f=_/this.recentHopLatenciesHistory.length,g>0){const g=_-C;S?S+=Math.abs(g)/(this.recentHopLatenciesHistory.length-1):S=Math.abs(g)/(this.recentHopLatenciesHistory.length-1),v?v+=g/(this.recentHopLatenciesHistory.length-1):v=g/(this.recentHopLatenciesHistory.length-1)}C=_}g.push({previousNode:{instanceId:this.currentLatencyTracePath[m].instanceId,pipelineId:this.currentLatencyTracePath[m].pipelineId},currentNode:{instanceId:this.currentLatencyTracePath[m+1].instanceId,pipelineId:this.currentLatencyTracePath[m+1].pipelineId},averageLatency:Number(f.toFixed(0)),averageJitter:Number(S.toFixed(0)),averageLatencyDelta:Number(v.toFixed(0))})}const m=[];let f=0,S=0;for(let g=0;g<this.overallHopLatencies.length;g++)m.push({previousNode:{instanceId:this.currentLatencyTracePath[g].instanceId,pipelineId:this.currentLatencyTracePath[g].pipelineId},currentNode:{instanceId:this.currentLatencyTracePath[g+1].instanceId,pipelineId:this.currentLatencyTracePath[g+1].pipelineId},averageLatency:Number(this.overallHopLatencies[g].toFixed(0)),averageJitter:Number(this.overallHopJitters[g].toFixed(0)),averageLatencyDelta:Number(this.overallHopLatencyDeltas[g].toFixed(0))}),g!==this.overallHopLatencies.length-1&&(f+=this.overallHopLatencies[g]),S+=this.overallHopLatencies[g];this.updateLatencyCdg(),this.diagnosticProvider.setValue("recentHopLatencyMetrics",g),this.diagnosticProvider.setValue("overallHopLatencyMetrics",m),this.diagnosticProvider.setValue("videoEdgeLatencyCdg",null),this.diagnosticProvider.setValue("serviceAvgLatency",Number(f.toFixed(0))),this.diagnosticProvider.setValue("endToEndAvgLatency",Number(S.toFixed(0)))}updateLatencyCdg(){const g=this.calculatePercentile(this.endToEndLatencyHistory),m=this.calculatePercentile(this.serviceLatencyHistory);this.diagnosticProvider.setValue("endToEndLatencyCdg",g),this.diagnosticProvider.setValue("serviceLatencyCdg",m)}calculatePercentile(g){const m=[],f=[10,20,30,40,50,60,70,80,90,100],S=g.sort(((g,m)=>g-m));return f.forEach((g=>{const f=g/100,v=this.calculateQuartile(S,f);m.push({percentile:g,value:Math.round(v)})})),m}},Mt=class extends Ve{constructor(g,m,f,S,v){super(g),this.logger=g,this.liveStreamStatistic=m,this.configProvider=f,this.sendTelemetry=S,this.sendSnapshotTelemetry=v,this.playbackStopRequested=!0,this.initialStreamConnectionEstablished=!1,this.retryCount=0,this.lastPlaybackError=null,this.videoElementEvents=[],this.isSwitchStreamingUrlOngoing=!1,this.streamConnectionResults=[],this.maxRetryCount=10,this.totalDownloadedMediaBytes=0,this.totalBufferingTime=0,this.isBuffering=!1,this.totalPlayingTime=0,this.isPlaying=!1,this.videoTrackTotalDurations=[],this.updateDiagnosticsTimer=-1,this.sendSnapshotTelemetryTimer=-1,this.initialStatsTimer=-1,this.updateDiagnosticsIntervalMs=f.config.playerTelemetryTickMs||1e3,this.id=generateGuid(),this.logger.info(`UmsLiveStreamPlayer created: ID: ${this.id}`)}get tracks(){return this.videoAdjuster?.sortedVideoTracks||[]}get playerId(){return this.id}async configure(g){this.streamOptions=g,g.stream&&g.stream.url?(this.logger.info("[configure]: Valid Live Stream configuration provided: Configuring with primary stream"),this.selectedStreamInfo=g.stream):g.altStream&&g.altStream.url?(this.logger.info("[configure]: Valid Live Stream configuration provided: Configuring with backup stream"),this.selectedStreamInfo=g.altStream):this.logger.info("[configure]: Invalid Live Stream configuration provided")}selectVideoTrack(g){return this.logger.info(`[selectVideoTrack]: setting track to ${g}`),this.videoAdjuster.selectVideoTrack(g)}async loadPlayer(g){if(this.video)return this.logger.error("[loadPlayer]: Player already started - not reloading player"),{setupSucceeded:!1,playerSetupError:{errorType:"MultiplePlayerLoad",errorMessage:"cannot load a player while current one is still active"}};if(!this.selectedStreamInfo)return this.logger.error("[loadPlayer]: Failed to load player: live stream not selected yet"),{setupSucceeded:!1,playerSetupError:{errorType:"InvalidStream",errorMessage:"no valid stream configured"}};this.liveStreamStatistic.registerPlayerLoadAttempt(),this.container=g;try{await this.initializePlayer()}catch(g){const m=stringifyObject(g);return this.liveStreamStatistic.registerPlayerLoadFailed("PlayerInitializationFailed"),{setupSucceeded:!1,playerSetupError:{errorType:"PlayerInitializationFailed",errorMessage:m}}}return this.initialStatsTimer=window.setTimeout((()=>{clearTimeout(this.initialStatsTimer),this.logger.debug(`[loadPlayer]: Initial telemetry sent after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry?.(!1),this.initialStatsTimer=null}),this.configProvider.config.sendInitialTelemetryAfterMs),this.liveStreamStatistic.registerPlayerLoadSucceeded(),{setupSucceeded:!0}}async initializePlayer(){this.createVideoElement(),this.diagnosticProvider=new It(this.id,this.video,new Date),this.startGatheringDiagnostics(),this.videoAdjuster=new Rt(this.logger,this.configProvider,this.diagnosticProvider,(g=>this.onVideoTrackSwitch(g))),this.latencyTraceProcessor=new wt(this.logger,this.diagnosticProvider,this.video),await this.setupPlayer()}async setupPlayer(){this.liveStreamStatistic.registerPlayerSetupAttempt(),this.logger.info(`[setupPlayer]: Attempting to setup stream, URL: ${this.selectedStreamInfo.url}`);try{await this.preparePlayback()}catch(g){const m=stringifyObject(g);throw this.logger.error(`[setupPlayer]: Failed to prepare playback: ${m}`),g}this.setPlaybackState("Initialized"),this.liveStreamStatistic.registerPlayerSetupSucceeded()}createVideoElement(){this.logger.info("[createVideoElement]: Creating video element in container"),this.video=this.container.ownerDocument.createElement("video"),this.video.id="ums-player",this.video.autoplay=!0,this.video.style.width="100%",this.video.style.height="100%",this.video.setAttribute("playsinline","true"),this.container.appendChild(this.video)}async preparePlayback(){this.playbackStopRequested=!1,this.resetHydraStreamTelemetry(),this.diagnosticProvider.setValue("outputStreamState",1|this.diagnosticProvider.getValue("outputStreamState"));try{this.mp4StreamInstance=await Mp4Stream(this.configProvider.config.umsSettings.playerScriptUrl,{onInputChunk:g=>this.updateMp4StreamStats(!1,g),onOutputChunk:g=>this.updateMp4StreamStats(!0,g),onInputStreamDone:()=>this.diagnosticProvider.setValue("inputStreamState",4|this.diagnosticProvider.getValue("inputStreamState")),onInputStreamCancelled:()=>this.diagnosticProvider.setValue("inputStreamState",8|this.diagnosticProvider.getValue("inputStreamState"))},(g=>this.videoAdjuster.onUmsMessage(g)),(g=>this.latencyTraceProcessor.processLatencyTrace(g)),this.configProvider.config.umsSettings.useHydraAVInterleaver)}catch(g){const m=stringifyObject(g);throw this.logger.error(`[preparePlayback]: MP4 stream initialization failed: ${m}`),this.liveStreamStatistic.registerPlayerSetupFailed("PlayerInitializationFailed"),new Error(`MP4 stream initialization failed: ${m}`)}if(this.diagnosticProvider.setValue("outputStreamState",2|this.diagnosticProvider.getValue("outputStreamState")),this.selectedStreamInfo.decryptionKey&&this.selectedStreamInfo.decryptionKey.id&&this.selectedStreamInfo.decryptionKey.value){const g=Uint8Array.from(atob(this.selectedStreamInfo.decryptionKey.value),(g=>g.charCodeAt(0)));this.mp4StreamInstance.setDecryptionKey(this.selectedStreamInfo.decryptionKey.id,g)}else this.logger.warn("[preparePlayback]: No decryption key set for Mp4Stream");return this.setSource(),!0}resetHydraStreamTelemetry(){this.diagnosticProvider.setValue("inputStreamState",0),this.diagnosticProvider.setValue("inputChunkCount",0),this.diagnosticProvider.setValue("inputByteCount",0),this.diagnosticProvider.setValue("outputStreamState",0),this.diagnosticProvider.setValue("outputChunkCount",0),this.diagnosticProvider.setValue("outputByteCount",0)}setSource(){this.liveStreamStatistic.registerSetSourceAttempt();const g=new MediaSource;g.addEventListener("sourceopen",(g=>this.sourceOpen(g))),this.video.src=URL.createObjectURL(g),this.liveStreamStatistic.registerSetSourceSucceeded()}updateMp4StreamStats(g,m){g?(this.diagnosticProvider.setValue("outputChunkCount",this.diagnosticProvider.getValue("outputChunkCount")+1),this.diagnosticProvider.setValue("outputByteCount",this.diagnosticProvider.getValue("outputByteCount")+m)):(this.diagnosticProvider.setValue("inputChunkCount",this.diagnosticProvider.getValue("inputChunkCount")+1),this.diagnosticProvider.setValue("inputByteCount",this.diagnosticProvider.getValue("inputByteCount")+m),this.totalDownloadedMediaBytes+=m,this.diagnosticProvider.setValue("totalDownloadedBytes",this.totalDownloadedMediaBytes))}async sourceOpen(g){try{URL.revokeObjectURL(this.video.src),this.registerEvents(),this.diagnosticProvider.setValue("streamUrl",this.selectedStreamInfo.url),this.diagnosticProvider.setValue("streamId",this.getStreamIdFromStreamUrl(this.selectedStreamInfo.url)),this.diagnosticProvider.setValue("streamDeliveryPipeline",this.selectedStreamInfo.streamDeliveryPipeline||""),this.diagnosticProvider.setValue("inputStreamState",1|this.diagnosticProvider.getValue("inputStreamState"));let m=`${this.selectedStreamInfo.url}/?ums&ccid=${this.id}`;this.configProvider.config.umsSettings.allowServerTrackSwitch||(m+="&no_auto_track"),this.configProvider.config.umsSettings.requireStrictServerTrackSwitch&&(m+="&strict_track_change"),this.liveStreamStatistic.registerStreamConnectionAttempt(this.selectedStreamInfo.url);const f=await this.fetchStream(m,this.configProvider.config.umsSettings.maxStreamHttpFetchCount-1);this.liveStreamStatistic.registerStreamConnectionSucceeded();const S=new URL(f.url);this.diagnosticProvider.setValue("deliveryNodeFqdn",S.hostname),this.diagnosticProvider.setValue("inputStreamState",2|this.diagnosticProvider.getValue("inputStreamState")),this.videoAdjuster.start(this.video,`${S}?ccid=${this.id}`,this.id);const v=await this.mp4StreamInstance.setupStream(f.body);await this.startStream(g.target,v)}catch(g){const m=stringifyObject(g);this.logger.error(`[sourceOpen]: Error while reading from stream: ${m}`),this.setPlaybackState("Error"),await this.retryStreaming(m)}}async fetchStream(g,m){const f=this.getRandomHexString(16),S="00-"+this.id.replace(/-/g,"")+"-"+f+"-01";let v=0;try{this.logger.info(`[fetchStream]: Attempting to connect to stream, stream URL: ${g}, attempts left afterwards: ${m}`);const C=await fetch(g,{headers:{traceparent:S}});if(C.ok)return this.initialStreamConnectionEstablished||(this.diagnosticProvider.setValue("initialStreamConnectionEstablished",!0),this.logger.info(`[fetchStream]: Connection to stream has been established for the first time, stream URL: ${g}`),this.initialStreamConnectionEstablished=!0),this.updateStreamConnectionResultsDiagnostics({isSuccess:!0,timestamp:(new Date).getTime(),traceparent:S,spanId:f,url:g,redirectUrl:C.url}),C;throw v=C.status,new Error(`Fetch failed with HTTP status code: ${v}, status text: ${C.statusText}`)}catch(C){const _=stringifyObject(C);if(this.updateStreamConnectionResultsDiagnostics({isSuccess:!1,timestamp:(new Date).getTime(),error:_,errorCode:v,traceparent:S,spanId:f,url:g}),this.initialStreamConnectionEstablished||this.diagnosticProvider.setValue("initialStreamConnectionHttpRetryCount",this.diagnosticProvider.getValue("initialStreamConnectionHttpRetryCount")+1),0===m)throw this.logger.error(`[fetchStream]: No more retries left to fetch stream URL ${g}`),this.liveStreamStatistic.registerStreamConnectionFailed(_),new Error(`No more retries left to fetch stream, last retry failure: ${_}`);return await this.fetchStream(g,m-1)}}updateStreamConnectionResultsDiagnostics(g){this.streamConnectionResults.push(g),this.streamConnectionResults.length>this.configProvider.config.umsSettings.maxStreamConnectionResultsLogCount&&this.streamConnectionResults.splice(0,1),this.diagnosticProvider.setValue("streamConnectionResults",this.streamConnectionResults)}getStreamIdFromStreamUrl(g){try{const m=new URL(g).pathname;if(m){const g=m.split("/");if(g?.length>1)return g[3]}return this.logger.warn(`[getStreamIdFromStreamUrl]: unable to parse stream ID from stream URL: ${g}`),""}catch{return this.logger.warn(`[getStreamIdFromStreamUrl]: cannot parse stream ID from invalid stream URL: ${g}`),""}}getRandomHexString(g){return Array.from(Array(g)).map((()=>Math.floor(16*Math.random()).toString(16))).join("")}async startStream(g,m){this.logger.info("[startStream]: Attempting to start stream");const f=[],S=this.createSourceBuffer(g,m,f);await this.readStream(g,S,f)}async readStream(g,m,f){for(this.logger.info("[readStream]: Reading from stream to play on player");!this.playbackStopRequested;){if(this.lastPlaybackError)throw this.lastPlaybackError;try{const S=await this.mp4StreamInstance.read();if(S.event)if("Restart"===S.event.name)this.logger.info("[readStream]: Mp4Stream restart detected due to new track");else if("Error"===S.event.name)throw this.logger.error(`[readStream]: Mp4Stream Hydra error detected: ${S.event.details}`),this.diagnosticProvider.setValue("mp4StreamHydraErrorMessage",S.event.details),new Error(`Mp4Stream Hydra error detected: ${S.event.details}`);if(S.value&&(f.push(S.value),this.diagnosticProvider.setValue("playerQueueSize",f.length),this.processPlayerQueue(f,m)),S.done){g.endOfStream(),this.diagnosticProvider.setValue("outputStreamState",8|this.diagnosticProvider.getValue("outputStreamState"));break}}catch(g){throw this.diagnosticProvider.setValue("outputStreamState",32|this.diagnosticProvider.getValue("outputStreamState")),g}}}createSourceBuffer(g,m,f){let S=m,v=MediaSource.isTypeSupported(S);if(!v&&m.match(/,opus"$/)){const g=m.replace(/,opus"$/,'"');MediaSource.isTypeSupported(g)&&(v=!0,S=g,this.logger.warn("[createSourceBuffer]: Switched to video-only mode"))}if(!v)throw new Error(`Unsupported mime type '${S}'`);const C=g.addSourceBuffer(S);return C.onupdateend=()=>this.processPlayerQueue(f,C),C.mode="segments",this.diagnosticProvider.setValue("outputStreamState",4|this.diagnosticProvider.getValue("outputStreamState")),C}processPlayerQueue(g,m){for(;!this.playbackStopRequested;){if(this.video.paused){if(this.video.playbackRate>1){this.video.playbackRate=1,this.diagnosticProvider.setValue("estimatedSpeedup",0),this.diagnosticProvider.setValue("appliedSpeedup",0);const g=this.diagnosticProvider.getValue("speedupResetCount");this.diagnosticProvider.setValue("speedupResetCount",g+1)}if(this.video.play().catch((g=>this.logger.warn(`[processPlayerQueue]: Playback resume failed with error: ${g.message}`))),this.video.buffered.length>0){const g=this.diagnosticProvider.getPlayerEdgeLatency();if(g>this.videoAdjuster.videoTargetEdgeLatency){const m=this.diagnosticProvider.getLivePosition();this.logger.info(`[processPlayerQueue]: Playback resumed, seeking from ${this.video.currentTime} to ${m.toFixed(3)}\n                            due to high edge latency: ${g}, relative to target edge latency: ${this.videoAdjuster.videoTargetEdgeLatency}`),this.video.currentTime=m}else this.logger.info("[processPlayerQueue]: Playback resumed successfully")}}if(m.updating)break;if(!(g.length>0)){const g=25,f=10,S=this.video.buffered,v=this.video.currentTime;for(let C=0;C<S.length;++C)if(v-S.start(C)>g+f){this.logger.info(`[processPlayerQueue]: Processing player queue:\n                            Cut played ${S.start(C)}..${v-g}`),m.remove(S.start(C),v-g);break}break}m.appendBuffer(g.shift()),this.diagnosticProvider.setValue("playerQueueSize",g.length)}}getRenderer(){return!this.renderer&&this.video&&(this.renderer=new bt(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}stop(){this.logger.info("[stop]: Stopping player"),this.endPlayback("PlayerStopped")}getPlaybackState(){return this.playbackState}getCaptionsTimestamp(){return this.video?this.video.currentTime:0}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}getStreamSize(){const g=this.liveStreamStatistic.getPlayerDiagnosticSnapshot();return g?{width:g.mediaWidth,height:g.mediaHeight}:{width:0,height:0}}startGatheringDiagnostics(){-1===this.updateDiagnosticsTimer&&-1===this.sendSnapshotTelemetryTimer?(this.logger.debug("[startGatheringDiagnostics]: diagnostics gathering started"),this.updateDiagnosticsTimer=window.setInterval((()=>{const g=this.getPlayerDiagnostics();this.logger.debug(`[startGatheringDiagnostics]: updating diagnostics: ${JSON.stringify(g)}`),this.updateDiagnostics(),this.liveStreamStatistic.registerStatsUpdated(g)}),this.updateDiagnosticsIntervalMs),this.configProvider.config.sendSnapshotTelemetry&&(this.sendSnapshotTelemetryTimer=window.setInterval((()=>{this.sendSnapshotTelemetry?.()}),this.configProvider.config.sendSnapshotTelemetryEveryMs))):this.logger.warn("[startGatheringDiagnostics]: diagnostics gathering already started - not starting again")}stopGatheringDiagnostics(){this.logger.debug("[stopGatheringDiagnostics]: diagnostics gathering stopped"),this.updateDiagnostics(),this.liveStreamStatistic.registerStatsUpdated(this.getPlayerDiagnostics()),-1!==this.updateDiagnosticsTimer&&clearInterval(this.updateDiagnosticsTimer),-1!==this.sendSnapshotTelemetryTimer&&clearInterval(this.sendSnapshotTelemetryTimer),this.updateDiagnosticsTimer=-1,this.sendSnapshotTelemetryTimer=-1}updateVideoTrackHistoryStatistic(){const g=new Date;if(this.currentVideoPlaybackBitrate){const m=this.diagnosticProvider.getValue("videoTrackHistory"),f=this.diagnosticProvider.getValue("videoTrackTotalDurations");if(m.length>0&&this.currentVideoPlaybackBitrate===m[m.length-1].trackPlaybackBitrate){if(this.videoTrackHistoryUpdatedTimestamp){this.latestVideoTrackDuration+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,m[m.length-1].durationInSeconds=Number(this.latestVideoTrackDuration.toFixed(0));const S=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate)),v=f.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));S&&v&&(S.totalDurationInSeconds+=(g.getTime()-this.videoTrackHistoryUpdatedTimestamp.getTime())/1e3,v.totalDurationInSeconds=Number(S.totalDurationInSeconds.toFixed(0)))}}else{m.push({trackPlaybackBitrate:this.currentVideoPlaybackBitrate,trackSwitchTimestamp:g.getTime(),durationInSeconds:0}),this.latestVideoTrackDuration=0,m.length>this.configProvider.config.maxVideoTrackHistoryLogCount&&m.splice(0,1);const S=this.videoTrackTotalDurations.find((g=>g.trackPlaybackBitrate===this.currentVideoPlaybackBitrate));if(!S){const g={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0},m={trackPlaybackBitrate:this.currentVideoPlaybackBitrate,totalDurationInSeconds:0};this.videoTrackTotalDurations.push(g),f.push(m)}}}this.videoTrackHistoryUpdatedTimestamp=g}updateTotalPlayingTimeStatistic(){const g=new Date;this.isPlaying&&this.totalPlayingTimeUpdatedTimestamp&&(this.totalPlayingTime+=g.getTime()-this.totalPlayingTimeUpdatedTimestamp.getTime()),this.totalPlayingTimeUpdatedTimestamp=g,this.diagnosticProvider.setValue("totalPlayingTimeInSeconds",Number((this.totalPlayingTime/1e3).toFixed(0)))}updateBufferingRateStatistic(){const g=new Date;this.isBuffering&&this.bufferingRateStatUpdatedTimestamp&&(this.totalBufferingTime+=g.getTime()-this.bufferingRateStatUpdatedTimestamp.getTime()),this.bufferingRateStatUpdatedTimestamp=g;const m=this.totalPlayingTime>0||this.totalBufferingTime>0?this.totalBufferingTime/(this.totalPlayingTime+this.totalBufferingTime):0;this.diagnosticProvider.setValue("bufferingRate",Number(m.toFixed(3)))}getPlayerDiagnostics(){const g=this.diagnosticProvider.getPlayerDiagnosticSnapshot();return g.statsInterval=this.updateDiagnosticsIntervalMs,g}registerEvents(){this.registerPlayerEvent("error",(()=>{this.handlePlaybackEvent("error")})),this.registerPlayerEvent("canplaythrough",(()=>{this.handlePlaybackEvent("canplaythrough")})),this.registerPlayerEvent("play",(()=>{this.handlePlaybackEvent("play")})),this.registerPlayerEvent("playing",(()=>{this.handlePlaybackEvent("playing")})),this.registerPlayerEvent("pause",(()=>{this.handlePlaybackEvent("pause")})),this.registerPlayerEvent("ended",(()=>{this.handlePlaybackEvent("ended")})),this.registerPlayerEvent("seeking",(()=>{this.handlePlaybackEvent("seeking")})),this.registerPlayerEvent("seeked",(()=>{this.handlePlaybackEvent("seeked")})),this.registerPlayerEvent("loadedmetadata",(()=>{this.handlePlaybackEvent("loadedmetadata")})),this.registerPlayerEvent("waiting",(()=>{this.handlePlaybackEvent("waiting")})),this.registerPlayerEvent("loadeddata",(()=>{this.handlePlaybackEvent("loadeddata")})),this.registerPlayerEvent("loadstart",(()=>{this.handlePlaybackEvent("loadstart")}))}registerPlayerEvent(g,m){this.videoElementEvents.push({name:g,callback:m}),this.video.addEventListener(g,m)}removeEventListeners(){this.video&&this.videoElementEvents.forEach((g=>{this.video.removeEventListener(g.name,g.callback)})),this.videoElementEvents=[]}handlePlaybackEvent(g){switch(g){case"error":this.handlePlaybackError();break;case"canplaythrough":this.onCanPlayThrough();break;case"play":this.onPlay();break;case"playing":this.onPlaying();break;case"pause":this.onPause();break;case"ended":this.onEnded();break;case"seeking":this.onSeeking();break;case"seeked":this.onSeeked();break;case"loadedmetadata":this.onMetadataLoaded();break;case"waiting":this.onWaiting();break;case"loadstart":this.onLoadStart();break;case"loadeddata":this.onLoadedData();break;default:return void this.logger.debug(`[handlePlaybackEvent]: Unhandled HTMLVideoElement event ${g}`)}this.updateDiagnostics(),this.checkPlayingState(g),this.checkBufferingState(g),"ended"!==g&&"error"!==g||this.resetPlaybackDiagnosticHelperFields();const m=this.getPlayerDiagnostics();this.logger.debug(`[handlePlaybackEvent]: updating diagnostics: ${JSON.stringify(m)}`),this.liveStreamStatistic.registerStatsUpdated(m)}onVideoTrackSwitch(g){this.updateVideoTrackHistoryStatistic(),this.checkCurrentVideoTrackBitrate(g)}checkPlayingState(g){this.isPlaying?"pause"!==g&&"seeking"!==g&&"ended"!==g&&"error"!==g&&"waiting"!==g||(this.isPlaying=!1):"playing"===g&&(this.isPlaying=!0)}checkBufferingState(g){this.isBuffering?"pause"!==g&&"seeking"!==g&&"ended"!==g&&"error"!==g&&"playing"!==g||(this.isBuffering=!1):"waiting"===g&&(this.isBuffering=!0)}checkCurrentVideoTrackBitrate(g){g&&g!==this.currentVideoPlaybackBitrate&&(this.currentVideoPlaybackBitrate=g,this.updateVideoTrackHistoryStatistic())}updateDiagnostics(){this.updateTotalPlayingTimeStatistic(),this.updateBufferingRateStatistic(),this.updateVideoTrackHistoryStatistic()}resetPlaybackDiagnosticHelperFields(){this.isBuffering=!1,this.bufferingRateStatUpdatedTimestamp=null,this.isPlaying=!1,this.totalPlayingTimeUpdatedTimestamp=null,this.currentVideoPlaybackBitrate=null,this.videoTrackHistoryUpdatedTimestamp=null}onCanPlayThrough(){this.setPlaybackState("Ready"),this.retryCount>0&&(this.logger.info(`[onCanPlayThrough]: Playing stream after retry count ${this.retryCount}`),this.retryCount=0),!0===this.isSwitchStreamingUrlOngoing&&(this.logger.info("[onCanPlayThrough]: Streaming URL was switched successfully to start playback"),this.event("urlSwitched").raise(!0),this.isSwitchStreamingUrlOngoing=!1)}onPlay(){this.setPlaybackState("Play")}onPlaying(){this.setPlaybackState("Playing")}onPause(){this.setPlaybackState("Paused")}onEnded(){this.setPlaybackState("Ended")}onSeeking(){this.setPlaybackState("Seeking")}onSeeked(){this.setPlaybackState("Seeked")}onMetadataLoaded(){this.setPlaybackState("LoadedMetadata")}onWaiting(){this.setPlaybackState("Buffering")}onLoadedData(){this.setPlaybackState("LoadedData")}onLoadStart(){this.setPlaybackState("LoadStart")}handlePlaybackError(){this.lastPlaybackError=this.video.error;const g=stringifyObject(this.lastPlaybackError);this.logger.warn(`[handlePlaybackError]: Playback error: ${g}`)}async retryStreaming(g){this.playbackStopRequested||(this.retryCount<this.maxRetryCount?(this.endPlayback(),this.logger.info(`[retryStreaming]: Retrying to connect to stream after playback error: ${g}`),await this.switchStream(g)||(this.raisePlaybackError("PlaybackError",`Failed to switch streams after latest playback error: ${g}`),this.endPlayback("PlaybackError"))):(this.logger.warn("[retryStreaming]: Hit retry max - destroying player"),this.raisePlaybackError("PlaybackError",`Hit stream retry max after latest playback error: ${g}`),this.endPlayback("PlaybackError")))}async switchStream(g){const m=this.streamOptions.stream&&this.selectedStreamInfo.url===this.streamOptions.stream.url,f=m?this.streamOptions.altStream:this.streamOptions.stream;if(!f)return this.logger.error(`[switchStream]: Stream to switch (${m?"alternative":"primary"}) is not valid`),!1;this.selectedStreamInfo=f,this.retryCount++,this.diagnosticProvider.setValue("retryCount",this.retryCount),this.raisePlaybackError("PlaybackRetried",g),this.isSwitchStreamingUrlOngoing=!0;try{return await this.setupPlayer(),!0}catch{return this.logger.error(`[switchStream]: Failed to setup player with stream to switch (${m?"alternative":"primary"})`),!1}}setPlaybackState(g){this.logger.debug(`[setPlaybackState]: Playback state changed: ${g}`),this.playbackState=g,this.liveStreamStatistic.registerPlaybackStateChanged(g),this.event("playbackStateChanged").raise()}raisePlaybackError(g,m){this.liveStreamStatistic.registerPlaybackError(g,m),this.event("playbackError").raise(g,m)}getCaptionsControl(){throw new Error("Method not implemented.")}endPlayback(g){this.logger.info("[endPlayback]: End playback"),this.playbackStopRequested=!0,this.lastPlaybackError=null,this.removeEventListeners(),this.mp4StreamInstance&&(this.mp4StreamInstance.close(),this.diagnosticProvider.setValue("outputStreamState",16|this.diagnosticProvider.getValue("outputStreamState")),this.mp4StreamInstance=null),g&&(this.video&&(this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.initialStatsTimer&&(clearTimeout(this.initialStatsTimer),this.initialStatsTimer=null),this.diagnosticProvider&&this.stopGatheringDiagnostics(),this.liveStreamStatistic.registerPlayerDestroyed(g),this.setPlaybackState("Destroyed"),this.configProvider.config.sendTelemetry&&this.sendTelemetry?.(!0)),this.videoAdjuster&&this.videoAdjuster.reset()}},Dt=class extends Ve{constructor(g,m){super(),this.logger=g,this.telemetryLogger=m,this.playbackState="Destroyed",this.playerSubs=[],this.isFinalTelemetrySent=!1,this.captionsTimestamp=0}initialize(g,m,f,S){this.getTelemetryReportFn=g,this.getSnapshotTelemetryReportFn=m,this.disposePlayerFn=f,this.releaseFn=S}startTelemetryGathering(){this.statsSub=window.setTimeout((async()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs);let g,m=!1;1===this.configProvider.playerConfig.playerType?(m=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetry||!1,g=this.configProvider.config.hydraPlayerHlsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs):(m=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetry||!1,g=this.configProvider.config.hydraPlayerUmsSettings?.ecsSettings?.sendSnapshotTelemetryEveryMs),g||(g=this.configProvider.config.sendSnapshotTelemetryEveryMs),m&&(this.diagSub=window.setInterval((async()=>{this.sendSnapshotTelemetry()}),g))}stop(){this.clearPlayerEventSubscribers(),this.destroyPlayer()}destroyPlayer(){this.renderer&&(this.renderer.dispose(),this.renderer=null),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.disposePlayerFn(),this.sendFinalTelemetry(),this.releaseFn()}getPlaybackState(){return this.playbackState}getCaptionsTimestamp(){return this.captionsTimestamp}sendFinalTelemetry(){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0))}sendTelemetry(g){if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const m={...this.getTelemetryReportFn(),isFinal:g,threadId:this.threadId,tsCallingVersion:getTsCallingVersion(),correlationId:this.streamOptions.correlationId};this.logger.debug("generated live stream report: ",m),this.telemetryLogger.sendEvent({eventName:"live_events",props:m})}else this.logger.info("telemetry not sent")}sendSnapshotTelemetry(){if(this.telemetryLogger){const g={...this.getSnapshotTelemetryReportFn(),isFinal:!1,threadId:this.threadId,tsCallingVersion:getTsCallingVersion(),correlationId:this.streamOptions.correlationId};this.logger.debug("sending snapshot telemetry: ",g),this.telemetryLogger.sendEvent({eventName:"live_events",props:g})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set")}clearPlayerEventSubscribers(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onPlaybackSeeked(g){this.captionsTimestamp=g}onUrlSwitched(g){this.event("urlSwitched").raise(g)}onSdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}onSdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}onPlaybackStarted(){this.event("playbackStarted").raise()}},Ot=__toESM(ie()),Nt=class extends Dt{constructor(g,m,f){super(g,f),this.eventHandler=new kt,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=m;const S=this.createHydraPlayerSettings(m);this.hydraPlayer=new Ot.HlsHydraPlayer(S,this.eventHandler)}async configure(g){if(this.streamOptions=g,this.threadId=g.threadId,this.playerLoaded){const m=this.createHydraStreamOptions(g);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",m)}}async loadPlayer(g){if(!await this.hydraPlayer.setup(g))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const g=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",g)}else this.logger.warn("No stream options configured before Hydra player loaded");const m=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return m.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(m)}onCaptionsToggled(g,m,f){this.captionsControl&&this.captionsControl.toggleCaptions(g,m),this.event("captionsToggled").raise(g,m,f)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){if(!this.captionsControl&&this.hydraPlayer){const g=this.streamOptions?.supportedSubtitleLanguages?this.streamOptions.supportedSubtitleLanguages.map((g=>g.culture)):["en","es"];this.captionsControl=new Lt(this.hydraPlayer,g)}return this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(g=>{this.onPlaybackStateChanged(g)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(g=>{this.onPlaybackSeeked(g)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("captionsToggled",((g,m,f)=>{this.onCaptionsToggled(g,m,f)}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(g=>{this.onStatsUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("log",((g,m)=>{this.onLog(g,m)})))}createHydraPlayerSettings(g){return{hlsJsSources:g.playerConfig?.src,hydraRuntimeFetchTimeout:g.playerConfig?.hydraRuntimeFetchTimeout,capturePlayerLogs:g.config.capturePlayerLogs,allowSdnPlugins:g.config.allowSdnPlugins,debugLogging:g.config.debug??!1,muteVideo:g.playerConfig?.muteVideo??!1,videoLang:g.playerConfig?.lang,videoElementStyles:g.playerConfig?.styles,maxPlayerDiagnosticsCount:g.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:g.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:g.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:g.config.hlsSettings.maxPlayerExperimentalEvents,maxRetryCount:g.config.maxRetryCount,playerTelemetryTickMs:g.config.playerTelemetryTickMs,removeEmptyDefaultTextTrack:g.config.removeEmptyDefaultTextTrack,maxRetryCountForLoadingResources:g.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:g.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:g.config.hlsSettings.maxStreamConnectionResultsLogCount,maxAbsoluteTimeOffsetEstimationResultsLogCount:g.config.hlsSettings.maxAbsoluteTimeOffsetEstimationResultsLogCount,skipNonce:g.config.hlsSettings.skipNonce,configIds:g.configIds,estimateAbsoluteTime:g.config.hlsSettings.estimateAbsoluteTime,playlistInitialSequenceNumber:g.config.hlsSettings.playlistInitialSequenceNumber,timeoutForSwitchingUrl:g.config.hlsSettings.timeoutForSwitchingUrl,hlsConfig:g.config.hlsSettings.hlsConfig,logHlsJsEvents:g.config.hlsSettings.logHlsJsEvents,logHlsJsEventsEveryMs:g.config.hlsSettings.logHlsJsEventsEveryMs,switchingPolicy:g.config.hydraPlayerHlsSettings?.ecsSettings?.switchingPolicy,enableUuidTrace:g.config.hlsSettings.enableUuidTrace,thaScript:g.config.hlsSettings.thaScript,enableOffsetComputeBasedOfStreamTime:g.config.hlsSettings.enableOffsetComputeBasedOfStreamTime,stopCrash:g.config.stopCrash,stopTerminating:g.config.hlsSettings.stopTerminating,stallDetectionPolicy:g.config.hydraPlayerHlsSettings?.ecsSettings?.stallDetectionPolicy,playerRuntimeJsUrls:g.config.hydraPlayerHlsSettings?.runtimeUrls??g.playerConfig.hydraPlayerWebSdkUrls,ecsSettings:g.config.hydraPlayerHlsSettings?.ecsSettings}}createHydraStreamOptions(g){let m=Ot.HydraStreamingEventType.TLE;return m=g.streamingEventType?this.convertStreamingEventType(g.streamingEventType):g.overflow?Ot.HydraStreamingEventType.Overflow:Ot.HydraStreamingEventType.TLE,{stream:{urls:g.stream.hlsUrls?g.stream.hlsUrls:[g.stream.url],keyAuthorizationToken:g.stream.keyAuthorizationToken,keyDeliveryUrl:g.stream.keyDeliveryUrl,sdnContext:g.stream.sdnContext,streamDeliveryPipeline:g.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.stream.streamDeliveryPipeline):void 0},altStream:g.altStream?{urls:g.altStream.hlsUrls?g.altStream.hlsUrls:[g.altStream.url],keyAuthorizationToken:g.altStream.keyAuthorizationToken,keyDeliveryUrl:g.altStream.keyDeliveryUrl,sdnContext:g.altStream.sdnContext,streamDeliveryPipeline:g.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.altStream.streamDeliveryPipeline):void 0}:void 0,supportedSubtitleLanguages:g.supportedSubtitleLanguages,streamingEventType:m,allowPlayerControls:g.allowPlayerControls,sdn:g.sdn?{name:g.sdn.name,url:g.sdn.url,plugin:g.sdn.plugin}:void 0,thaContext:g.thaContext?{eventId:g.thaContext.eventId,organizer:{userId:g.thaContext.organizer?.userId,tenantId:g.thaContext.organizer?.tenantId},attendee:{userId:g.thaContext.attendee?.userId,tenantId:g.thaContext.attendee?.tenantId},coOrganizers:g.thaContext.coOrganizers}:void 0}}convertStreamDeliveryPipeline(g){switch(g){case"AMS":return Ot.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Ot.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Ot.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${g} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(g){switch(g){case"TLE":return Ot.HydraStreamingEventType.TLE;case"Overflow":return Ot.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Ot.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Ot.HydraStreamingEventType.TownHallPremium;case"TownHall":return Ot.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${g} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(g){return{setupSucceeded:g.setupSucceeded,playerSetupError:g.playerSetupError?{errorType:this.convertHydraPlayerSetupError(g.playerSetupError.errorType),errorMessage:g.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(g){switch(g){case Ot.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Ot.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Ot.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Ot.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new gt(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(g){this.playerStats=g}getStats(){return this.playerStats}onLog(g,m){this.logger[g](m)}onPlaybackStateChanged(g){try{this.playbackState=this.convertHydraPlaybackState(g),this.event("playbackStateChanged").raise()}catch(g){this.logger.warn(`Not handling playback state changed event: ${stringifyObject(g)}`)}}convertHydraPlaybackState(g){switch(g){case Ot.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Ot.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Ot.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Ot.HydraPlayerPlaybackState.Start:return"Start";case Ot.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Ot.HydraPlayerPlaybackState.Play:return"Play";case Ot.HydraPlayerPlaybackState.Playing:return"Playing";case Ot.HydraPlayerPlaybackState.Pause:return"Paused";case Ot.HydraPlayerPlaybackState.Waiting:return"Buffering";case Ot.HydraPlayerPlaybackState.Seeking:return"Seeking";case Ot.HydraPlayerPlaybackState.Seeked:return"Seeked";case Ot.HydraPlayerPlaybackState.Ended:return"Ended";case Ot.HydraPlayerPlaybackState.Error:return"Error";case Ot.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Ot.HydraPlayerPlaybackState.Initialized:return"Initialized";case Ot.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${g} to PlaybackState`)}}onPlaybackError(g,m){try{const f=this.convertHydraPlaybackErrorType(g);this.event("playbackError").raise(f,m)}catch(g){this.logger.warn(`Not handling playback error event: ${stringifyObject(g)}`)}}convertHydraPlaybackErrorType(g){switch(g){case Ot.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Ot.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Ot.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Ot.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Ot.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${g} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null),this.captionsControl&&(this.captionsControl.dispose(),this.captionsControl=null)}},kt=class extends Ve{constructor(){super()}playbackStateChanged(g){this.event("playbackStateChanged").raise(g)}playbackSeeked(g){this.event("playbackSeeked").raise(g)}log(g,m){this.event("log").raise(g,m)}playbackError(g,m){this.event("playbackError").raise(g,m)}captionsToggled(g,m,f){this.event("captionsToggled").raise(g,m,f)}urlSwitched(g){this.event("urlSwitched").raise(g)}sdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}sdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}statsUpdated(g){this.event("statsUpdated").raise(g)}playbackStarted(){this.event("playbackStarted").raise()}},Lt=class{constructor(g,m){this.hydraPlayer=g,this.availableCultures=m,this.selectedCulture=""}async addCues(g){const m=this.convertCues(g);await this.hydraPlayer.callPlayerApi("addHydraPlayerCues",m)}convertCues(g){const m=[];return g.forEach((g=>{m.push({start:g.start,end:g.end,text:g.text})})),m}async clearCues(){await this.hydraPlayer.callPlayerApi("clearHydraPlayerCues")}async showCaptions(g){await this.hydraPlayer.callPlayerApi("showHydraPlayerCaptions",g)}getSelectedCulture(){return this.selectedCulture}getAvailableCultures(){return this.availableCultures}dispose(){this.hydraPlayer=null}toggleCaptions(g,m){this.selectedCulture=g?m:""}},Ft=__toESM(ne()),xt=class extends Dt{constructor(g,m,f){super(g,f),this.eventHandler=new Vt,this.playerLoaded=!1,this.initialize(this.getTelemetryReport.bind(this),this.getSnapshotTelemetryReport.bind(this),this.disposePlayer.bind(this),this.releasePlayer.bind(this)),this.addPlayerEventSubscribers(),this.configProvider=m;const S=this.createHydraPlayerSettings(m);this.hydraPlayer=new Ft.UmsHydraPlayer(S,this.eventHandler)}async configure(g){if(this.streamOptions=g,this.threadId=g.threadId,this.playerLoaded){const m=this.createHydraStreamOptions(g);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",m)}}async loadPlayer(g){if(!await this.hydraPlayer.setup(g))return{setupSucceeded:!1,playerSetupError:{errorType:"HydraRuntimeLoadFailed",errorMessage:"Failed to create IFrame with Hydra runtime script"}};if(this.streamOptions){const g=this.createHydraStreamOptions(this.streamOptions);await this.hydraPlayer.callPlayerApi("configureHydraPlayer",g)}else this.logger.warn("No stream options configured before Hydra player loaded");const m=await this.hydraPlayer.callPlayerApi("loadHydraPlayer");return m.setupSucceeded&&(this.playerLoaded=!0,this.startTelemetryGathering()),this.getHydraPlayerSetupResult(m)}getTelemetryReport(){return this.hydraPlayer?.getFullTelemetryReport()}getSnapshotTelemetryReport(){return this.hydraPlayer?.getSnapshotTelemetryReport()}getCaptionsControl(){return!this.captionsControl&&this.hydraPlayer&&(this.captionsControl=new Ut(this.hydraPlayer,this.logger.createChild("CaptionsControl"))),this.captionsControl}addPlayerEventSubscribers(){this.playerSubs.push(this.eventHandler.on("playbackStateChanged",(g=>{this.onPlaybackStateChanged(g)}))),this.playerSubs.push(this.eventHandler.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.eventHandler.on("playbackSeeked",(g=>{this.onPlaybackSeeked(g)}))),this.playerSubs.push(this.eventHandler.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.eventHandler.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.eventHandler.on("playbackStarted",(()=>{this.onPlaybackStarted()}))),this.playerSubs.push(this.eventHandler.on("statsUpdated",(g=>{this.onStatsUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("trackListUpdated",(g=>{this.onTrackListUpdated(g)}))),this.playerSubs.push(this.eventHandler.on("trackSelected",(g=>{this.onTrackSelected(g)}))),this.playerSubs.push(this.eventHandler.on("log",((g,m)=>{this.onLog(g,m)})))}onTrackListUpdated(g){const m=stringifyObject(g);this.logger.info(`[onTrackListUpdated]: Track list updated to: ${m}`)}onTrackSelected(g){const m=stringifyObject(g);this.logger.info(`[onTrackSelected]: Track selected: ${m}`)}createHydraPlayerSettings(g){return{hydraRuntimeFetchTimeout:g.playerConfig?.hydraRuntimeFetchTimeout,allowSdnPlugins:g.config.allowSdnPlugins,debugLogging:g.config.debug??!1,muteVideo:g.playerConfig?.muteVideo??!1,videoLang:g.playerConfig?.lang,videoElementStyles:g.playerConfig?.styles,maxPlayerDiagnosticsCount:g.config.maxPlayerDiagnosticsCount,maxPlayerMemoryTraceLogCount:g.config.maxPlayerMemoryTraceLogCount,maxPlayerPlaybackEventCount:g.config.maxPlayerPlaybackEventCount,maxPlayerExperimentalEvents:g.config.umsSettings.maxPlayerExperimentalEvents,maxRetryCount:g.config.maxRetryCount,playerTelemetryTickMs:g.config.playerTelemetryTickMs,maxRetryCountForLoadingResources:g.config.maxRetryCountForLoadingResources,maxVideoTrackHistoryLogCount:g.config.maxVideoTrackHistoryLogCount,maxStreamConnectionResultsLogCount:g.config.umsSettings.maxStreamConnectionResultsLogCount,configIds:g.configIds,timeoutForSwitchingUrl:g.config.umsSettings.timeoutForSwitchingUrl,minTargetEdgeLatency:g.config.umsSettings.minTargetEdgeLatency,latencyCompensationThreshold:g.config.umsSettings.latencyCompensationThreshold,maxEdgeLatencyHistoryLength:g.config.umsSettings.maxEdgeLatencyHistoryLength,switchingPolicy:g.config.umsSettings.switchingPolicy?this.convertSwitchingPolicy(g.config.umsSettings.switchingPolicy):void 0,enableUuidTrace:g.config.umsSettings.enableUuidTrace,thaScript:g.config.umsSettings.thaScript,stopCrash:g.config.stopCrash,stopTerminating:g.config.umsSettings.stopTerminating,stallDetectionPolicy:this.convertStallDetectionPolicy(g.config.umsSettings.stallDetectionPolicy),playerRuntimeJsUrls:g.config.hydraPlayerUmsSettings?.runtimeUrls??g.playerConfig.hydraPlayerWebSdkUrls,ecsSettings:g.config.hydraPlayerUmsSettings?.ecsSettings}}createHydraStreamOptions(g){let m=Ft.HydraStreamingEventType.TLE;return m=g.streamingEventType?this.convertStreamingEventType(g.streamingEventType):g.overflow?Ft.HydraStreamingEventType.Overflow:Ft.HydraStreamingEventType.TLE,{stream:{urls:[g.stream.url],decryptionKey:g.stream.decryptionKey,sdnContext:g.stream.sdnContext,streamDeliveryPipeline:g.stream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.stream.streamDeliveryPipeline):void 0},altStream:g.altStream?{urls:[g.altStream.url],decryptionKey:g.altStream.decryptionKey,sdnContext:g.altStream.sdnContext,streamDeliveryPipeline:g.altStream.streamDeliveryPipeline?this.convertStreamDeliveryPipeline(g.altStream.streamDeliveryPipeline):void 0}:void 0,streamingEventType:m,allowPlayerControls:g.allowPlayerControls,sdn:g.sdn?{name:g.sdn.name,url:g.sdn.url,plugin:g.sdn.plugin}:void 0,thaContext:g.thaContext?{eventId:g.thaContext.eventId,organizer:{userId:g.thaContext.organizer?.userId,tenantId:g.thaContext.organizer?.tenantId},attendee:{userId:g.thaContext.attendee?.userId,tenantId:g.thaContext.attendee?.tenantId},coOrganizers:g.thaContext.coOrganizers}:void 0}}convertSwitchingPolicy(g){return{strategy:g.strategy,maxSelectionPendingSuccess:g.maxSelectionPendingSuccess,maxRetryDelay:g.maxRetryDelay,minimumRetryDelay:g.minimumRetryDelay,ecsOrder:g.ecsOrder,useDelayThreshold:g.useDelayThreshold,verifyNewJoin:g.verifyNewJoin,probingPolicy:g.probingPolicy?this.convertProbingPolicy(g.probingPolicy):void 0,disableProbing:g.disableProbing,strictVerifyForUrl:g.strictVerifyForUrl}}convertStallDetectionPolicy(g){if(g)return{waitAfterLastWarning:g.waitAfterLastWarning,waitAfterSourceSet:g.waitAfterSourceSet,minimumBufferThreshold:g.minimumBufferThreshold,maximumBufferThreshold:g.maximumBufferThreshold,boundaryThreshold:g.boundaryThreshold,maximumLatency:g.maximumLatency,healthCheckFrequency:g.healthCheckFrequency}}convertProbingPolicy(g){return{enableNameCheck:g.enableNameCheck,enableLastModifiedCheck:g.enableLastModifiedCheck,maxPlaylistUpdateDelay:g.maxPlaylistUpdateDelay,timeToLive:g.timeToLive,probingInterval:g.probingInterval}}convertStreamDeliveryPipeline(g){switch(g){case"AMS":return Ft.HydraStreamDeliveryPipeline.AMS;case"MiddleLaneHttpLiveStreaming":return Ft.HydraStreamDeliveryPipeline.HLS;case"MiddleLaneUltraLowLatency":return Ft.HydraStreamDeliveryPipeline.Ums;default:throw new Error(`Unable to convert StreamDeliveryPipeline ${g} to HydraStreamDeliveryPipeline`)}}convertStreamingEventType(g){switch(g){case"TLE":return Ft.HydraStreamingEventType.TLE;case"Overflow":return Ft.HydraStreamingEventType.Overflow;case"TownHall_Basic":return Ft.HydraStreamingEventType.TownHallBasic;case"TownHall_Premium":return Ft.HydraStreamingEventType.TownHallPremium;case"TownHall":return Ft.HydraStreamingEventType.TownHall;default:throw new Error(`Unable to convert StreamingEventType ${g} to HydraStreamingEventType`)}}getHydraPlayerSetupResult(g){return{setupSucceeded:g.setupSucceeded,playerSetupError:g.playerSetupError?{errorType:this.convertHydraPlayerSetupError(g.playerSetupError.errorType),errorMessage:g.playerSetupError.errorMessage}:void 0}}convertHydraPlayerSetupError(g){switch(g){case Ft.HydraPlayerSetupErrorType.InvalidStream:return"InvalidStream";case Ft.HydraPlayerSetupErrorType.MultiplePlayerLoad:return"MultiplePlayerLoad";case Ft.HydraPlayerSetupErrorType.PlayerInitializationFailed:return"PlayerInitializationFailed";case Ft.HydraPlayerSetupErrorType.SetSourceFailed:return"SetSourceFailed";default:return}}getRenderer(){return!this.renderer&&this.hydraPlayer&&(this.renderer=new gt(this,this.logger.createChild("LiveStreamRenderer"))),this.renderer}onStatsUpdated(g){this.playerStats=g}getStats(){return this.playerStats}onLog(g,m){this.logger[g](m)}onPlaybackStateChanged(g){try{this.playbackState=this.convertHydraPlaybackState(g),this.event("playbackStateChanged").raise()}catch(g){this.logger.warn(`Not handling playback state changed event: ${stringifyObject(g)}`)}}convertHydraPlaybackState(g){switch(g){case Ft.HydraPlayerPlaybackState.LoadStart:return"LoadStart";case Ft.HydraPlayerPlaybackState.LoadedData:return"LoadedData";case Ft.HydraPlayerPlaybackState.LoadedMetadata:return"LoadedMetadata";case Ft.HydraPlayerPlaybackState.Start:return"Start";case Ft.HydraPlayerPlaybackState.CanPlayThrough:return"Ready";case Ft.HydraPlayerPlaybackState.Play:return"Play";case Ft.HydraPlayerPlaybackState.Playing:return"Playing";case Ft.HydraPlayerPlaybackState.Pause:return"Paused";case Ft.HydraPlayerPlaybackState.Waiting:return"Buffering";case Ft.HydraPlayerPlaybackState.Seeking:return"Seeking";case Ft.HydraPlayerPlaybackState.Seeked:return"Seeked";case Ft.HydraPlayerPlaybackState.Ended:return"Ended";case Ft.HydraPlayerPlaybackState.Error:return"Error";case Ft.HydraPlayerPlaybackState.Destroyed:return"Destroyed";case Ft.HydraPlayerPlaybackState.Initialized:return"Initialized";case Ft.HydraPlayerPlaybackState.Stalled:return"Stalled";default:throw new Error(`Unable to convert HydraPlayerPlaybackState ${g} to PlaybackState`)}}onPlaybackError(g,m){try{const f=this.convertHydraPlaybackErrorType(g);this.event("playbackError").raise(f,m)}catch(g){this.logger.warn(`Not handling playback error event: ${stringifyObject(g)}`)}}convertHydraPlaybackErrorType(g){switch(g){case Ft.HydraPlayerPlaybackErrorType.UnsupportedPlatform:return"UnsupportedPlatform";case Ft.HydraPlayerPlaybackErrorType.NetworkError:return"NetworkError";case Ft.HydraPlayerPlaybackErrorType.PlaybackRetried:return"PlaybackRetried";case Ft.HydraPlayerPlaybackErrorType.PlaybackError:return"PlaybackError";case Ft.HydraPlayerPlaybackErrorType.Unknown:return"Unknown";default:throw new Error(`Unable to convert HydraPlayerPlaybackErrorType ${g} to PlaybackErrorType`)}}getStreamSize(){return this.playerStats?{width:this.playerStats.mediaWidth,height:this.playerStats.mediaHeight}:{width:0,height:0}}isRendering(){const g=this.getStreamSize();return g.width>0&&g.height>0}disposePlayer(){this.hydraPlayer?.dispose()}releasePlayer(){this.hydraPlayer&&(this.hydraPlayer.release(),this.hydraPlayer=null)}},Ut=class{constructor(g,m){this.hydraPlayer=g,this.logger=m}async addCues(g){this.logger.warn("[addCues]: not implemented for UMS player")}async clearCues(){this.logger.warn("[clearCues]: not implemented for UMS player")}async showCaptions(g){await this.hydraPlayer.callPlayerApi("toggleHydraPlayerCaptions",g)}getSelectedCulture(){return this.logger.warn("[getSelectedCulture]: not implemented for UMS player"),""}getAvailableCultures(){return this.logger.warn("[getAvailableCultures]: not implemented for UMS player"),[]}dispose(){this.hydraPlayer=null}async selectTextTrack(g){await this.hydraPlayer.callPlayerApi("selectHydraPlayerTextTrack",g)}},Vt=class extends Ve{constructor(){super()}playbackStateChanged(g){this.event("playbackStateChanged").raise(g)}playbackSeeked(g){this.event("playbackSeeked").raise(g)}log(g,m){this.event("log").raise(g,m)}playbackError(g,m){this.event("playbackError").raise(g,m)}trackListUpdated(g){this.event("trackListUpdated").raise(g)}trackSelected(g){this.event("trackSelected").raise(g)}urlSwitched(g){this.event("urlSwitched").raise(g)}sdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}sdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}statsUpdated(g){this.event("statsUpdated").raise(g)}playbackStarted(){this.event("playbackStarted").raise()}},Bt=class extends Ve{constructor(g,m,f){super(),this.configProvider=g,this.logger=m,this.getTelemetryLogger=f,this.isAvailable=!0,this._isStreaming=!1,this.playerSubs=[],this.isFinalTelemetrySent=!1,this.telemetryLogger=this.getTelemetryLogger(),1===this.configProvider.playerConfig.playerType?this.configProvider.playerConfig.useHydraPlayerWebSdk?this.player=new Nt(this.logger.createChild("HlsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):(this.initializeTelemetry(),this.player=new Tt(this.logger.createChild("HlsLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)):2===this.configProvider.playerConfig.playerType?this.configProvider.playerConfig.useHydraPlayerWebSdk?this.player=new xt(this.logger.createChild("UmsHydraLiveStreamPlayer"),this.configProvider,this.telemetryLogger):(this.initializeTelemetry(),this.player=new Mt(this.logger.createChild("UmsLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)):(this.initializeTelemetry(),this.player=new St(this.logger.createChild("AmpLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider)),this.subscribeForPlayerEvents()}get isStreaming(){return this._isStreaming}isActive(){return this.isAvailable&&this.isStreaming}async start(g,m){await this.setOptions(m),this.isFinalTelemetrySent=!1;const f=await this.player.loadPlayer(g);if(!f.setupSucceeded){this.player.stop(),this.logger.error("playerLoadFailed");const g=JSON.stringify(f.playerSetupError);throw this.sendFinalTelemetry(g),new Error(g)}return this._isStreaming=!0,this.liveStreamStatistic&&(this.statsSub=window.setTimeout((()=>{clearTimeout(this.statsSub),this.logger.debug(`initial telemetry report after ${this.configProvider.config.sendInitialTelemetryAfterMs} ms`),this.sendTelemetry(!1)}),this.configProvider.config.sendInitialTelemetryAfterMs),this.configProvider.config.sendSnapshotTelemetry&&(this.diagSub=window.setInterval((()=>{this.sendSnapshotTelemetry()}),this.configProvider.config.sendSnapshotTelemetryEveryMs))),this.player.getRenderer()}initializeTelemetry(){if(1===this.configProvider.playerConfig.playerType){const g={perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],statsInterval:[],serviceAvgLatency:[],endToEndAvgLatency:[]};this.liveStreamStatistic=new st(this.configProvider.config,this.logger.createChild("LiveStreamStatistic"),g)}else if(2===this.configProvider.playerConfig.playerType){const g={currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]};this.liveStreamStatistic=new st(this.configProvider.config,this.logger.createChild("UmsLiveStreamStatistic"),g)}else{const g={perceivedBandwidth:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[],playbackRate:[],currentPlayPosition:[],currentMediaTime:[],statsInterval:[]};this.liveStreamStatistic=new st(this.configProvider.config,this.logger.createChild("LiveStreamStatistic"),g)}}async stop(){}async setOptions(g){return void 0!==g.overflow&&(g.streamingEventType||(g.streamingEventType=g.overflow?"Overflow":"TLE"),delete g.overflow),this.options=g,this.player.configure(g)}getStats(){return this.liveStreamStatistic?this.liveStreamStatistic.getPlayerDiagnosticSnapshot():this.player?.getStats?.()}dispose(){this.unsubscribeFromPlayerEvents(),this.player.stop(),this.statsSub&&(clearTimeout(this.statsSub),this.statsSub=null),this.diagSub&&(clearInterval(this.diagSub),this.diagSub=null),this.logger.debug("stopping live event"),this.sendFinalTelemetry("graceful disposed"),super.dispose()}sendFinalTelemetry(g){this.isFinalTelemetrySent||(this.isFinalTelemetrySent=!0,this.sendTelemetry(!0,g))}sendTelemetry(g,m){if(this.liveStreamStatistic)if(this.configProvider.config.sendTelemetry&&this.telemetryLogger){const f={configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:g,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton,callendReason:m},S=this.liveStreamStatistic?.getReport(f);this.logger.debug("generated live stream report",S),this.telemetryLogger.sendEvent({eventName:"live_events",props:S})}else this.logger.info("telemetry not sent");else this.logger.info("telemetry not tracked in ILiveStream object")}sendSnapshotTelemetry(){if(this.liveStreamStatistic)if(this.telemetryLogger){const g=this.liveStreamStatistic.getSnapshotReport({configIds:this.configProvider.configIds,playerId:this.player.playerId,correlationId:this.options?.correlationId,eTag:this.configProvider.etag,isFinal:!1,threadId:this.options?.threadId,disableFullscreenButton:this.configProvider.playerConfig.disableFullscreenButton});this.logger.debug("sending snapshot telemetry: ",g),this.telemetryLogger.sendEvent({eventName:"live_events",props:g})}else this.logger.error("snapshot telemetry not sent, telemetryLogger is not set");else this.logger.info("telemetry not tracked in ILiveStream object")}subscribeForPlayerEvents(){this.playerSubs.push(this.player.on("playbackStateChanged",(()=>{this.onPlaybackStateChanged()}))),this.playerSubs.push(this.player.on("playbackError",((g,m)=>{this.onPlaybackError(g,m)}))),this.playerSubs.push(this.player.on("urlSwitched",(g=>{this.onUrlSwitched(g)}))),this.playerSubs.push(this.player.on("sdnPluginLoadSkipped",(g=>{this.onSdnPluginLoadSkipped(g)}))),this.playerSubs.push(this.player.on("sdnPluginLoadFailed",(g=>{this.onSdnPluginLoadFailed(g)}))),this.playerSubs.push(this.player.on("playbackStarted",(()=>{this.onPlaybackStarted()})))}unsubscribeFromPlayerEvents(){for(const g of this.playerSubs)g.dispose();this.playerSubs=[]}onPlaybackStarted(){this.event("playbackStarted").raise()}onPlaybackStateChanged(){const g=this.player.getPlaybackState();switch(g){case"Start":this.event("playbackStarted").raise();break;case"Ended":this.event("playbackNotLive").raise(),this.sendFinalTelemetry("playback ended");break;case"Seeked":this.event("playbackSeeked").raise(this.player.getCaptionsTimestamp());break;default:this.logger.debug(`playbackStateChanged: ${g}`)}this.event("playbackStateChanged").raise(this.player.getPlaybackState())}onPlaybackError(g,m){this.event("error").raise(g,m)}onUrlSwitched(g){this.event("urlSwitched").raise(g)}onSdnPluginLoadSkipped(g){this.event("sdnPluginLoadSkipped").raise(g)}onSdnPluginLoadFailed(g){this.event("sdnPluginLoadFailed").raise(g)}},Ht=class{constructor(g,m,f){this.ecsConfig=g,this.logger=m,this.getTelemetryLogger=f}configure(g){this.configuration=g}async initialize(){const g="MDN_MIDDLELANE_TEAMS",m="liveStream",f=this.ecsConfig.getString(g,m);let S={};try{S=JSON.parse(f)}catch(f){this.logger.warn(`failed to parse ECS configuration for ${g}/${m}`)}const v=this.ecsConfig.getString("ConfigIDs",g);this._configProvider=new tt(S,this.configuration,v,this.logger.createChild("LiveStreamConfigProvider"))}createLiveStream(){return new Bt(this._configProvider,this.logger.createChild("LiveStream"),this.getTelemetryLogger)}dispose(){}},$t=class extends Ve{constructor(){super(...arguments),this.isAudioOutputSelectionSupported=!1}createAudioPlayer(){return null}createAudioRenderer(){return null}getRawDeviceMediaStream(g){return null}askDevicePermission(){return Promise.resolve({audio:!1,video:!1})}getPermissionState(g){return"granted"}enumerateDevicesAsync(){return Promise.resolve([])}getPreferredCamera(){return null}selectDevices(){}getSelectedDevices(){return{}}createPreview(){return Promise.resolve(new Gt)}createPreviewRenderer(){return Promise.resolve(new Gt)}createScreenSharingPreviewRenderer(){return Promise.resolve(new Gt)}getDeviceNameAsync(){return Promise.resolve("")}setDeviceEffectsAsync(){return Promise.resolve()}getDeviceEffectsCapabilityAsync(){return Promise.resolve(0)}setBackgroundImageAsync(){return Promise.resolve()}getImagePropertyAsync(){return Promise.resolve({width:0,height:0,uri:" "})}getMicrophoneGeometryArrayInfoAsync(g){return Promise.resolve({})}transformImageAsync(){return Promise.resolve(!1)}sendMessageDeviceVideoEffectsAsync(){return Promise.resolve({code:0})}sendMessageDeviceVideoExtensibilityAsync(){return Promise.resolve({code:0,type:"Error",response:{details:"The API has not been implemented."}})}setVideoCaptureConfigAsync(){return Promise.resolve()}captureVideoFrameWithoutEffectsAsync(){return Promise.resolve(new ImageData(0,0))}setAudioProcessingFlags(g){}getSpeakerVolume(){return Promise.resolve(0)}getSpeakerSystemVolume(){return Promise.resolve(0)}setSpeakerVolume(g){return Promise.resolve()}setSpeakerSystemVolume(g){return Promise.resolve()}unmuteMicrophone(){return Promise.resolve()}unmuteSpeaker(){return Promise.resolve()}getNrgLevelsForDeviceTuner(g){return Promise.resolve(0)}setAudioEffectsAsync(){return Promise.resolve()}getAudioFeatureCapability(g){return Promise.resolve(0)}getMicrophoneVolume(){return Promise.resolve(0)}setMicrophoneVolume(g){return Promise.resolve()}setDeviceTelemetryData(g,m,f,S=0){return Promise.resolve()}getSpeakerDeviceDomIdAsync(g,m){return Promise.reject()}getSourceFormats(g){return Promise.resolve([])}enableShellSharing(){return Promise.resolve()}disableShellSharing(){return Promise.resolve()}enableParticipantCameras(){return Promise.resolve()}startAudioLoopbackDevice(g){return Promise.resolve()}async dispose(g){return Promise.resolve()}},Gt=class extends Ve{constructor(){super(...arguments),this.isRendering=!1,this.streamSize={width:0,height:0},this.rendererType=-1,this.frameType=-1}captureFrame(){return Promise.resolve(new jt)}getStats(){return Promise.resolve({framesDropped:0,framesTotal:0})}setScalingMode(){return Promise.resolve()}dumpVideoSourceImages(){return Promise.resolve(0)}cameraAutoControl(g){return Promise.resolve(!1)}getCameraManualControlStates(g){return Promise.resolve([])}setCameraManualControlStates(g){return Promise.resolve([])}enumerateCameraManualControls(){return Promise.resolve([])}dispose(){}},jt=class extends Ve{getSize(){return{width:0,height:0}}isMirrored(){return!1}},Wt='"rtcmedia"';function getRelayCredentials(g){return{expires:g.expires,username:g.username,password:g.password,realm:g.realm}}var qt=class{constructor(){this.reports={}}watch(g){const m={time:Date.now(),duration:-1};return this.reports[g]&&(g=`${g}_last`),this.reports[g]=m,{end:g=>{g?m.error=g:m.duration=Date.now()-m.time}}}getReports(){return this.reports}},zt="configFetch",Kt="skypeTokenFetch",Jt="trapTokenFetch",Yt=class{constructor(g){this.updateRelaysPromise=null,this.trapTokens={},this.relaysOverride=[],this.timers=new qt,this.context=g,this.logger=g.logger.createChild("RM"),this.request=g.request}initialize(g){this.configProvider=g,this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync(!0))}setRelayOverride(g){this.relaysOverride=g}setDefaultRelayConfig(g){this.config??(this.config=g)}async queryRelaysAsync(g={}){if(this.logger.info("query relays"),this.relaysOverride.length>0)return this.relaysOverride;this.updateRelaysPromise||(this.updateRelaysPromise=this.updateRelaysFromConfigAsync());const m=await this.updateRelaysPromise;return m?"turn"===g.relayType?m.Turn:g.isRemoteClientLync?m.Lync:m.Skype:[]}getStats(){return this.timers.getReports()}updateRelaysFromConfigAsync(g=!1){const m=this.getConfigAsync().then((()=>this.updateRelaysAsync())).then((g=>(this.updateRelaysPromise=m,g))).catch((m=>(this.updateRelaysPromise=null,g?this.logger.warn("failed to retrieve relays",stringifyObject(m)):this.logger.error("failed to retrieve relays",stringifyObject(m)),null)));return m}refreshRelaysFromConfig(){this.request.isOnline()?this.updateRelaysFromConfigAsync():(this.updateRelaysPromise=null,this.logger.warn("not refreshing relays due to no network connection"))}updateRelaysAsync(){const g=this.config.Service.tokenUrl;let m;const fetchTrapTokenThroughProvider=async()=>(m=this.timers.watch(Jt),this.context.trapTokenCredentialsProvider()),fetchTrapTokenDirectly=async()=>{const f=this.timers.watch(Kt);let S="";try{S=this.configProvider?.config.useNewTokenApi?await this.context.newTokenProvider():await this.context.tokenProvider(),this.logger.info(`skypeToken fetched with newApi=${this.configProvider?.config.useNewTokenApi}`)}catch(g){throw f.end(stringifyObject(g)),g}f.end(),m=this.timers.watch(Jt);return(await this.request.get(g,{headers:{"X-Skypetoken":S,"api-version":2}})).response},f=this.context.trapTokenCredentialsProvider?fetchTrapTokenThroughProvider:fetchTrapTokenDirectly;return this.logger.info("Fetch TRAP token "+(this.context.trapTokenCredentialsProvider?"with provider":"directly")),f().then((g=>{m.end();let f=0;const S=this.config.Token.earlyRefreshMinutes,v=this.config.Token.earlyRefreshPercentage;this.storeTrapTokens(g),f=Math.max(g.expires-60*S,g.expires*v/100),setTimeout(this.refreshRelaysFromConfig.bind(this),1e3*f);const C=this.config.Relay.Turn.realm?this.config.Relay.Turn.realm:Wt,_=getRelayCredentials(this.getTrapToken(C)),E={Skype:[{addresses:this.config.Relay.Skype.addresses,fqdns:this.config.Relay.Skype.fqdns,tcpPort:this.config.Relay.Skype.tcpPort,udpPort:this.config.Relay.Skype.udpPort,type:"msturn",..._}],Lync:[{addresses:this.config.Relay.Lync.addresses,fqdns:this.config.Relay.Lync.fqdns,tcpPort:this.config.Relay.Lync.tcpPort,udpPort:this.config.Relay.Lync.udpPort,type:"msturn",..._}],Turn:[{addresses:this.config.Relay.Turn.addresses,fqdns:this.config.Relay.Turn.fqdns,tcpPort:this.config.Relay.Turn.tcpPort,udpPort:this.config.Relay.Turn.udpPort,tlsPort:this.config.Relay.Turn.tlsPort,type:"turn",..._}]};return this.logger.info("relays from trap",E),E})).catch((g=>{throw m&&m.end(stringifyObject(g)),g}))}storeTrapTokens(g){if(!g||!g.tokens)return void this.logger.error("failed to get tokens from trap response");const m={};g.tokens.forEach((f=>{m[f.realm]={expires:g.expires,username:f.username,password:f.password,realm:f.realm}})),this.trapTokens=m}getTrapToken(g){if("string"==typeof g){const m=g.replace(/^"|"$/g,""),f=`"${m}"`,S=this.trapTokens[f]||this.trapTokens[m];if(S)return S}throw new Error(`token for relay not found, realm: ${g}`)}async getConfigAsync(){this.logger.info("retrieving configuration");const g=this.timers.watch(zt);try{const m=await this.context.configProvider();g.end(),this.logger.info("retrieved configuration:",m),m&&(this.config=m),this.logger.info("applied configuration:",this.config)}catch(m){this.logger.warn("failed to retrieve configuration",stringifyObject(m)),g.end(stringifyObject(m))}}};function build(g){return new Yt(g)}var Qt={CALL_SETUP_NATIVE:"skypecosi_concore_native_ts_calling_call_setup_session",CALL_IN_CALL_NATIVE:"skypecosi_concore_native_ts_calling_in_call_session",REGISTRY_WEB:"skypecosi_concore_web_ts_calling_registry",REGISTRY_NATIVE:"skypecosi_concore_native_ts_calling_registry"},Xt={PARK:"*11",SHARED_LINE:"*12",SERVER_HOLD:"*13",CALL_PARK:"*14"},Zt={totalParticipants:0,preheatedParticipants:0,lobbyParticipants:0,totalPresenters:0,requestingAttentionPresenters:0,totalAttendees:0,requestingAttentionAttendees:0,overflowAttendees:0},ei=P,ti=150,ii=30,ni=class{constructor(g,m,f,S,v){this.eventName=g,this.eventStartTime=m,this.type=f,this.causeId=S,this.status="Pending",this.eventStartTimestamp=(new Date).getTime(),this.data=[],"Event"===this.type&&delete this.status,v&&this.data.push(v)}set variant(g){this.eventVariant=g}recordSuccess(g,m){this.recordResult("Success",g,m)}recordFailure(g,m){this.recordResult("Failure",g,m)}recordTimeout(g,m){this.recordResult("Timeout",g,m)}addData(g){this.data.push(g)}isPending(){return"Pending"===this.status}getEvent(){const g={start:this.eventStartTime,duration:this.duration,status:this.status,result:this.result,causeId:this.causeId,resultCauseId:this.resultCauseId,variant:this.eventVariant,data:this.data.map((g=>this.prepareData(g,!0))).filter((g=>!!g))};return"Event"===this.type&&delete g.status,g.data.length||delete g.data,g.causeId||delete g.causeId,g.resultCauseId||delete g.resultCauseId,g.result||delete g.result,g.variant||delete g.variant,{[this.eventName]:g}}recordResult(g,m,f){this.status=g,this.result=this.prepareData(m),this.causeId!==f&&(this.resultCauseId=f),this.duration=(new Date).getTime()-this.eventStartTimestamp}prepareData(g,m=!1){if(null==g)return"";if("string"==typeof g)return scrubMriOrOmit(g);if("number"==typeof g||"boolean"==typeof g)return String(g);if("function"==typeof g)return"";if(g instanceof Error)return g.toString();try{return Object.keys(g).length?m?g:getPIISafeObject(g):""}catch(g){return"invalid"}}},ri=class{constructor(g,m,f,S){this.logger=g,this.startTime=m,this.maxEventsExceeded=f,this.perfModule=S,this.recordedEvents=[],this.ipcStats=[],this.ongoingOperations={}}recordEvent(g,m,f=generateCauseId()){this.logger.debug("Event:",g,ei.pii.Omit(m));const S=new ni(g,this.getEventStartTime(),"Event",f,m);return this.pushToRecordedEvents(S),S}recordOperationSuccess(g,m=null,f,S,v){this.logger.info("Event success:",S,g,ei.pii.Omit(f),ei.pii.Omit(m)),this.recordOperationResult(g,m,"Success",f,S,v)}recordOperationFailure(g,m,f,S,v){this.logger.info("Event failure:",g,ei.pii.Omit(f),m),this.recordOperationResult(g,m,"Failure",f,S,v)}recordOperationTimeout(g,m,f,S,v){this.logger.info("Event timeout:",g,ei.pii.Omit(f),m),this.recordOperationResult(g,m,"Timeout",f,S,v)}maybeRecordOperationSuccess(g,m=null,f,S,v){this.hasOngoingEvent(g,f)&&this.recordOperationSuccess(g,m,f,S,v)}maybeRecordOperationFailure(g,m,f,S,v){this.hasOngoingEvent(g,f)&&this.recordOperationFailure(g,m,f,S,v)}maybeRecordOperationTimeout(g,m,f,S,v){this.hasOngoingEvent(g,f)&&this.recordOperationTimeout(g,m,f,S,v)}recordOperationResult(g,m,f,S,v,C){this.hasOngoingEvent(g,S)||this.recordOperation(g,v,S);let _=this.ongoingOperations[g];switch(S&&(_=_[S]),C&&_.addData(C),f){case"Success":_.recordSuccess(m,v);break;case"Failure":_.recordFailure(m,v);break;case"Timeout":_.recordTimeout(m,v);break;default:this.logger.error("Unknown operation record state in record operation result.")}S?delete this.ongoingOperations[g][S]:delete this.ongoingOperations[g]}recordOperation(g,m,f,S){this.logger.debug("Event create:",m,g,ei.pii.Omit(f),S);const v=new ni(g,this.getEventStartTime(),"Operation",m,S);return this.ongoingOperations[g]||(this.ongoingOperations[g]={}),f?this.ongoingOperations[g][f]=v:this.ongoingOperations[g]=v,this.pushToRecordedEvents(v),v}setOperationVariant(g,m,f){let S;S=f?this.ongoingOperations[g][f]:this.ongoingOperations[g],S?S.variant=m:this.logger.error(`Could not find operation ${g} to set variant ${m}`)}updateOperationData(g,m,f,S){try{if(!this.ongoingOperations[g])return void this.recordEvent(g,m,f);S?this.ongoingOperations[g][S]&&this.ongoingOperations[g][S].addData(m):this.ongoingOperations[g].addData(m)}catch(m){return void this.logger.info(`Unable to update operation: ${g} data`)}}pushToRecordedEvents(g){if(this.maxEventsExceeded&&this.maxEventsExceeded()&&this.recordedEvents.shift(),this.recordedEvents.push(g),this.perfModule&&this.ipcStats.length<=ii){const g=this.perfModule.getIpcStats();g&&this.ipcStats.push({ingestionTime:this.getEventStartTime(),stats:g})}}hasOngoingEvent(g,m){return this.ongoingOperations[g]?!(m&&!this.ongoingOperations[g][m])||(this.logger.warn(`Unable to find event for name\\id ${g}\\${ei.pii.Omit(m)}`),!1):(this.logger.warn(`Unable to find event for name ${g}`),!1)}getEventStartTime(){return(new Date).getTime()-this.startTime}getEventTimestampBag(g,m){const f=m?[m.getEvent()]:this.recordedEvents.filter((m=>!g||!m.isPending())).map((g=>g.getEvent())),S=JSON.stringify({eventStart:this.startTime,events:f});return this.logger.info(`Call eventTimestampBag ${ei.pii.Omit(S)}`),S}getIPCStats(){return 0!==this.ipcStats.length?JSON.stringify(this.ipcStats):""}removeRecordedEvent(g){const m=this.recordedEvents.indexOf(g);m>-1&&this.recordedEvents.splice(m,1)}},si=class extends ri{constructor(g,m){super(g,m,(()=>this.recordedEvents.length>ti)),this.getHostName=()=>{try{return"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>"}catch(g){return"unknown"}},this.tsCallingVersion=getTsCallingVersion(),this.logger=g.createChild("CallRegistryTelemetry")}setClientType(g){this.clientType=g}setEndpointId(g){this.endpointId=g}setSkypeId(g){this.skypeId=scrubMriOrOmit(g)}setApplicationType(g){this.applicationType=g}setRing(g){this.ring=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setAcsResourceId(g){this.acsResourceId=g}setRegion(g){this.region=g}setPartition(g){this.partition=g}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{EndpointId:getValue2(this.endpointId),SkypeId:getValue2(this.skypeId),ApplicationType:getValue2(this.applicationType),Ring:getValue2(this.ring),TenantId:getValue2(this.tenantId),userHexCID:getValue2(this.userHexCID),AcsResourceId:getValue2(this.acsResourceId),Region:getValue2(this.region),Partition:getValue2(this.partition),TsCallingVersion:getValue2(this.tsCallingVersion),HostName:this.getHostName(),EventTimestampBag:this.getEventTimestampBag(g,m),DiagnosticInfo:this.callEndDiagnosticInfo,ClientType:getValue2(this.clientType)}}removeNonPendingOperations(){this.recordedEvents=this.recordedEvents.filter((g=>g.isPending()))}},ai=class extends ri{constructor(g,m,f){super(g,m,(()=>this.inCallMode&&this.recordedEvents.length>ti),f),this.inCallMode=!1,this.tsCallingVersion=getTsCallingVersion(),this.logger=g.createChild("CallTelemetry")}setClientType(g){this.clientType=g}setCallId(g){this.currentCallId&&(this.previousCallId=this.currentCallId),this.currentCallId=g}setConsultativeCallId(g){this.consultativeCallId=g}setEndpointId(g){this.endpointId=g}setParticipantId(g){this.participantId=g}setPreheatFlags(g){this.preheatFlags=g}setCallOrigin(g){this.origin=g}setGroupId(g){this.groupId=g}setThreadId(g){this.threadId=g}setBackroomThreadId(g){this.backroomThreadId=g}setComplianceRecordingContentLength(g){this.complianceRecordingContentLength=g}setMesageId(g){this.messageId=g}setSkypeId(g){this.skypeId=scrubMriOrOmit(g)}setApplicationType(g){this.applicationType=g}setRing(g){this.ring=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setAcsResourceId(g){this.acsResourceId=g}setRegion(g){this.region=g}setPartition(g){this.partition=g}setFailureType(g){this.failureType=g}setIsCast(g){this.isCast=g?"True":"False"}setIsHuddleGroupCall(g){this.isHuddleGroupCall=g?"True":"False"}setIsEmergency(g){this.isEmergency=g?"True":"False"}setRole(g){this.isAnonymous="admin"===g?"False":"True"}setCallType(g){this.callType=g}setConversationType(g){this.conversationType=g}setDirection(g){this.direction=g}setSelfParticipantRole(g){this.selfParticipantRole=g}setTerminationState(g){this.terminationState=g}setTerminationReason(g){this.terminationReason=g}setCallEndDiagnosticInfo(g){this.callEndDiagnosticInfo=g}setStackConfig(g){this.stackConfig=g}setJoinedFrom(g){this.joinedFrom=g}setMeetingCode(g){this.meetingCode=g}setMeetingUrl(g){this.meetingUrl=g}setHasMeetingRegistrationId(g){this.hasMeetingRegistrationId=g?"True":"False"}setHasParticipantPin(g){this.hasParticipantPin=g?"True":"False"}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.currentCallId),PreviousCorrelationId:getValue2(this.previousCallId),ConsultativeCallId:getValue2(this.consultativeCallId),EndpointId:getValue2(this.endpointId),SkypeId:getValue2(this.skypeId),ParticipantId:getValue2(this.participantId),PreheatFlags:getValue2(this.preheatFlags),CallType:getValue2(this.callType),ConversationType:getValue2(this.conversationType),Direction:getValue2(this.direction),Origin:getValue2(this.origin),SelfParticipantRole:getValue2(this.selfParticipantRole),IsAnonymous:getValue2(this.isAnonymous),GroupId:scrubMriOrOmit(getValue2(this.groupId)),ThreadId:getLoggableThreadId(getValue2(this.threadId)),MessageId:getValue2(this.messageId),ApplicationType:getValue2(this.applicationType),Ring:getValue2(this.ring),TenantId:getValue2(this.tenantId),userHexCID:getValue2(this.userHexCID),AcsResourceId:getValue2(this.acsResourceId),Region:getValue2(this.region),Partition:getValue2(this.partition),FailureType:getValue2(this.failureType),IsCast:getValue2(this.isCast),IsHuddleGroupCall:getValue2(this.isHuddleGroupCall),IsEmergency:getValue2(this.isEmergency),TsCallingVersion:getValue2(this.tsCallingVersion),TerminationState:getValue2(this.terminationState),TerminationReason:getValue2(this.terminationReason),StackConfig:getValue2(this.stackConfig),EventTimestampBag:this.getEventTimestampBag(g,m),HostName:this.getHostName(),DiagnosticInfo:this.callEndDiagnosticInfo,JoinedFrom:this.joinedFrom,MeetingCode:this.meetingCode,MeetingUrl:this.meetingUrl,HasMeetingRegistrationId:this.hasMeetingRegistrationId,HasParticipantPin:this.hasParticipantPin,IPCStats:this.getIPCStats(),ComplianceRecordingContentLength:getValue2(this.complianceRecordingContentLength),BackroomThreadId:getLoggableThreadId(getValue2(this.backroomThreadId)),ClientType:getValue2(this.clientType)}}switchToInCallTelemetry(){this.recordedEvents=this.recordedEvents.filter((g=>g.isPending())),this.inCallMode=!0}getHostName(){try{return location.host}catch(g){return"unknown"}}},getEndpointInformationForTelemetry=g=>Array.isArray(g)?g.map((g=>({endpointId:g.endpointId,participantId:g.participantId}))):null,calculateJoinedFromForTelemetry=(g,m,f,S,v)=>{if(g){if(g.meetingUrl)return"MeetingUrl";if(g.meetingCode)return"MeetingCode"}return m||f?"ThreadContext":S?"GroupId":v?"Awareness":""};function sanitizeMeetingCode(g,m,f){if(!g)return f.info(`sanitizeMeetingCode[${m}] empty / undefined meeting code parameter`),g;let S=g.replace(/\s/g,"");return S=S.replace(/-/g,""),f.info(`sanitizeMeetingCode[${m}] meetingCode: ${g}, sanitizedMeetingCode: ${S}`),S}function getMeetingCodeFromMeetingUrl(g,m,f){if(!g)return f.info(`getMeetingCodeFromMeetingUrl[${m}] empty / undefined meeting Url parameter`),g;const S=new URL(g);let v="";if(S&&S.pathname&&S.pathname.split("/").length>=2){const g=S.pathname.split("/");"meet"===g[g.length-2]&&(v=g[g.length-1])}return f.info(`getMeetingCodeFromMeetingUrl[${m}] meetingUrl: ${g}, meetingUrlObject: ${safeJsonStringify(S)}, meetingCode: ${v}`),v}function compareMeetingData(g,m,f,S){const v=sanitizeMeetingCode(g&&g.meetingCode||"",f,S),C=sanitizeMeetingCode(m&&m.meetingCode||"",f,S),definedAndEqual=(g,m)=>!!g&&!!m&&g===m;if(definedAndEqual(v,C))return!0;let _=getMeetingCodeFromMeetingUrl(g&&g.meetingUrl||"",f,S);_=sanitizeMeetingCode(_,f,S);let E=getMeetingCodeFromMeetingUrl(m&&m.meetingUrl||"",f,S);if(E=sanitizeMeetingCode(E,f,S),definedAndEqual(_,E))return!0;if(definedAndEqual(_,C)||definedAndEqual(E,v))return!0;if(g&&g.meetingUrl&&m&&m.meetingUrl){const f=new URL(g.meetingUrl),S=new URL(m.meetingUrl);if(f.hostname===S.hostname&&f.pathname===S.pathname)return!0}return!1}function noop(){}var oi={CODE:{SUCCESS:0,MEDIA_ERROR:410,CLIENT_ERROR_CODE:499,UNKNOWN_ERROR:497},SUB_CODE:{VDI_DISCONNECTED:3e3,ACTION_NOT_ALLOWED:3548,ABANDONED:4990,ENDED_BY_REMOTE_ENDPOINT:5028,BEACON:4521,UNKNOWN_FAILURE:3545}},li=4294967294,ci="_operationIdValue_",di="_causeIdValue_",hi="_callStartOptionsValue_",ui="_clientReasonValue_";function callOperation(g,m){return operationDecorator(0,g,m)}function participantOperation(g,m){return operationDecorator(1,g,m)}var operationId=(g,m,f)=>{if(g[m][ci])throw new Error("can not specify more than one operation id");g[m][ci]=f},causeId=(g,m,f)=>{if(g[m][di])throw new Error("can not specify more than one cause id");g[m][di]=f},callStartOptions=(g,m,f)=>{if(g[m][hi])throw new Error("can not specify options more than once");g[m][hi]=f},reason=(g,m,f)=>{if(g[m][ui])throw new Error("can not specify reason more than once");g[m][ui]=f},operationDecorator=(g,m,f)=>(S,v,C)=>{const _=C.value,E=S[v]?.[ci],T=S[v]?.[di],I=S[v]?.[hi],b=S[v]?.[ui],A=f?.type||"Async";return C.value=function(...S){const v=this;let C=generateCauseId();void 0!==T&&(S[T]&&validateCauseId(S[T])?C=S[T]:S[T]=C);let P,R=void 0!==E?S[E]:void 0;if(void 0!==R)if(Array.isArray(R))try{const g=R.map((g=>g.toString())).sort().concat().toString();R=getStringHash(g).toString()}catch{const g=`[${R}]${m} failed in array parsing in operationDecorator`,f={terminatedReason:32,terminatedReasonCode:oi.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:oi.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(f)}else if(R&&"object"==typeof R)try{let g=JSON.stringify(R);f&&f.operationIdKey&&R.hasOwnProperty(f.operationIdKey)&&(g=R[f.operationIdKey]),R=g}catch{const g=`[${R}]${m} failed in object parsing in operationDecorator`,f={terminatedReason:32,terminatedReasonCode:oi.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:oi.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(f)}void 0!==b&&S[b]&&(P=S[b]);const w=getOperationHandler(v,g);if(w.logOperation(C,m),f&&f.singular&&w.hasPendingOperation(m))return w.logOperation(C,m,"Not allowed, pending operation exists"),Promise.reject(60);if(f&&f.idempotencyLevel&&w.getRecord(m)>0)switch(w.logOperation(C,m,`Called multiple times, handling operation according to specified policy: idempotency=${f.idempotencyLevel}`),f.idempotencyLevel){case"NoOp":return Promise.resolve();case"Error":return Promise.reject(60)}try{void 0!==I&&S[I]&&v.processCallStartOptions(S[I],C)}catch{const g=`${m} failed in processCallStartOptions`,f={terminatedReason:32,terminatedReasonCode:oi.CODE.UNKNOWN_ERROR,terminatedReasonSubCode:oi.SUB_CODE.UNKNOWN_FAILURE,errorMessage:g};return Promise.reject(f)}const M=!(!f||!f.convertError),execute=()=>"Chained"===A?w.executeChained(_.bind(this,...S),m,R,C,M,P,f):"Sync"===A?w.executeSync(_.bind(this,...S),m,R,C,M,P):w.execute(_.bind(this,...S),m,R,C,M,P,f);if("StartCall"!==m&&"JoinCall"!==m||w.hasPendingOperation("_CallStartOrJoinInitiated")||w.createPendingOperation("_CallStartOrJoinInitiated").catch(noop),f&&f.triggerAttach&&(w.hasPendingOperation("_ElectronSlimcoreReady")||w.createPendingOperation("_ElectronSlimcoreReady").catch(noop)),f&&"Sync"!==f.type){const g=f&&f.waitFor;if(Array.isArray(g))return Promise.all(g.map((g=>g&&w.hasPendingOperation(g)&&w.waitForOperation(g,void 0,C)))).then(execute,execute);if(g&&w.hasPendingOperation(g))return w.waitForOperation(g,void 0,C).then(execute,execute)}return execute()},C},getOperationHandler=(g,m)=>{if(0===m)return g._callOperationHandler;if(1===m)return g._participantOperationHandler;throw new Error("Unsupported operation handler type!")};function getStringHash(g){let m=0;for(let f=0;f<g.length;f++){m=(m<<5)-m+g.charCodeAt(f),m|=0}return m}var gi=class{constructor(g){this._disposed=!1,this._logger=g.createChild("[ASYNC]"),this._endOperationDeferred=defer(),this._endOperationDeferred.promise.catch((g=>{this._logger.info("Rejected all operations")})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._deferredOperationsWithCauseId={},this._logger=g}registerPromise(g,m){let f=!1;const always=()=>{f=!0};m.then(always,always);const S=this._endOperationDeferred.promise.catch((m=>{if(!f)throw new Error(`Operation ${g} did not complete, reason:${m}`)}));return Promise.race([S,m])}updateOperationId(g,m){this._logger.info(`updateOperationId ${g} ${m}`),Object.keys(this._deferredOperationsWithOperationId).forEach((f=>{f&&this._deferredOperationsWithOperationId[f]&&(this._logger.info(`_deferredOperationsWithOperationId ${f}`),Object.keys(this._deferredOperationsWithOperationId[f]).forEach((S=>{S&&this._deferredOperationsWithOperationId[f][S]&&(this._logger.info(`_deferredOperationsWithOperationId ${S} ${m}`),S===g&&(this._deferredOperationsWithOperationId[f][m]=this._deferredOperationsWithOperationId[f][S],delete this._deferredOperationsWithOperationId[f][S]))})))})),Object.keys(this._deferredOperationsWithCauseId).forEach((f=>{f&&this._deferredOperationsWithCauseId[f]&&(this._logger.info(`_deferredOperationsWithCauseId ${f}`),Object.keys(this._deferredOperationsWithCauseId[f]).forEach((S=>{S&&this._deferredOperationsWithCauseId[f][S]&&(this._logger.info(`_deferredOperationsWithCauseId ${S} ${m}`),S===g&&(this._deferredOperationsWithOperationId[f][m]=this._deferredOperationsWithOperationId[f][S],delete this._deferredOperationsWithOperationId[f][S]))})))}))}createPendingOperation(g,m,f=generateCauseId(),S={}){const v=defer();v.promise.catch(noop);const C=this.getOperationInfoForLogging(f,g,m);let _;if(this._logger.info(`${C}[creating...]`),this._disposed)return this._logger.info(`${C}[create failed, call is disposed]`),Promise.reject(60);if(m){if(this._deferredOperationsWithOperationId[g]||(this._deferredOperationsWithOperationId[g]={}),this._deferredOperationsWithOperationId[g][m])return this._logger.warn(`${C} Deferred operation with given name and operation id is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${g}/${scrubMriOrOmit(m)}`));this._deferredOperationsWithOperationId[g][m]={deferred:v,causeId:f},this._deferredOperationsWithCauseId[f]||(this._deferredOperationsWithCauseId[f]={}),this._deferredOperationsWithCauseId[f][m]={deferred:v,options:S,operationName:g},_=this._endOperationDeferred.promise.catch((f=>{if(this.hasPendingOperationWithOperationId(g,m))throw new Error(`Operation ${g} ${m} did not complete, reason:${f}`)}))}else{if(this._deferredOperations[g])return this._logger.warn(`${C} Deferred operation with given name is already defined`),Promise.reject(new Error(`Deferred operation with given name is already defined:${g}`));this._deferredOperationsWithCauseId[f]||(this._deferredOperationsWithCauseId[f]={}),this._deferredOperationsWithCauseId[f][""]={deferred:v,options:S,operationName:g},this._deferredOperations[g]={deferred:v,causeId:f},_=this._endOperationDeferred.promise.catch((m=>{if(this.hasPendingOperation(g))throw new Error(`Operation ${g} did not complete, reason:${m}`)}))}return Promise.race([_,v.promise])}hasPendingOperation(g){return!!this._deferredOperations[g]}hasAtleastOneOfPendingOperation(g){for(const m of g)if(this.hasPendingOperation(m))return!0;return!1}hasPendingOperationWithOperationId(g,m){return!(!m||!this._deferredOperationsWithOperationId[g])&&!!this._deferredOperationsWithOperationId[g][m]}hasPendingOperationWithCauseId(g,m){const f=m||"";return this._deferredOperationsWithCauseId[g]&&!!this._deferredOperationsWithCauseId[g][f]}getPendingOperationWithCauseId(g,m){return this.hasPendingOperationWithCauseId(g,m)?this._deferredOperationsWithCauseId[g][m].deferred.promise:Promise.reject(`[${g}][${m}]: getPendingOperationWithCauseId for given causeId, operationId`)}resolveOperationWithCauseId(g,m,f){const S=m||"";if(this.hasPendingOperationWithCauseId(g,S)){const m=this._deferredOperationsWithCauseId[g][S],v=m.deferred.promise;return m.deferred.resolve(f),this._logger.info(`[${g}][${S}] resolved, result=${getPrintableObject(f)||"void"}`),delete this._deferredOperationsWithCauseId[g][S],v}return Promise.reject(`[${g}][${S}] resolveOperationWithCauseId failed, operation not found`)}rejectOperationWithCauseId(g,m,f){const S=m||"";if(this.hasPendingOperationWithCauseId(g,S)){const m=this._deferredOperationsWithCauseId[g][S],v=m.deferred.promise;return v.catch(noop),m.deferred.reject(f),this._logger.info(`[${g}][${S}] rejected, result=${getPrintableObject(f)||"void"}`),delete this._deferredOperationsWithCauseId[g][S],v}return Promise.reject(`[${g}][${S}] rejectOperationWithCauseId failed, operation not found`)}maybeResolveOperationWithCauseId(g,m,f){this.hasPendingOperationWithCauseId(g,m)?this.resolveOperationWithCauseId(g,m,f).catch((m=>{this._logger.info(`${g}maybeResolveOperationWithCauseId failed, reason=${getPrintableObject(m)}`)})):this._logger.info(`${g}maybeResolveOperationWithCauseId ignored, operation does not exist`)}maybeRejectOperationWithCauseId(g,m,f){this.hasPendingOperationWithCauseId(g,m)?this.rejectOperationWithCauseId(g,m,f).catch(noop):this._logger.info(`${g}maybeRejectOperationWithCauseId ignored, operation does not exist`)}getPendingOperation(g,m,f=generateCauseId()){return!m&&this._deferredOperations[g]?this._deferredOperations[g].deferred.promise:m&&this._deferredOperationsWithOperationId[g]&&this._deferredOperationsWithOperationId[g][m]?this._deferredOperationsWithOperationId[g][m].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(f,g,m)}: Deferred operation with given name and operation does not exist`)}waitForOperation(g,m,f=generateCauseId()){return m&&this.hasPendingOperationWithOperationId(g,m)?this._deferredOperationsWithOperationId[g][m].deferred.promise:this.hasPendingOperation(g)?this._deferredOperations[g].deferred.promise:Promise.reject(`${this.getOperationInfoForLogging(f,g,m)}failed=wait failed, operation not found`)}resolveOperation(g,m,f,S=generateCauseId(),v=!1){if(!g)return Promise.reject("Unable to resolve deferred operation with empty name");if(f&&this.hasPendingOperationWithOperationId(g,f)){const S=this._deferredOperationsWithOperationId[g][f],C=S.deferred.promise;return S.deferred.resolve(m),this._logger.info(`${this.getOperationInfoForLogging(S.causeId,g,f)}resolved, result=${getPrintableObject(m)||"void"}`),v||delete this._deferredOperationsWithOperationId[g][f],C}if(this.hasPendingOperation(g)){const S=this._deferredOperations[g],C=this._deferredOperations[g].deferred.promise;return this._deferredOperations[g].deferred.resolve(m),this._logger.info(`${this.getOperationInfoForLogging(S.causeId,g,f)}resolved, result=${getPrintableObject(m)||"void"}`),v||delete this._deferredOperations[g],C}return Promise.reject(`${this.getOperationInfoForLogging(S,g,f)}failed=resolve failed, operation not found`)}rejectOperation(g,m,f,S=generateCauseId()){if(!g)return Promise.reject("Unable to reject deferred operation with empty name");if(f&&this.hasPendingOperationWithOperationId(g,f)){const S=this._deferredOperationsWithOperationId[g][f],v=S.deferred.promise;return v.catch(noop),S.deferred.reject(m),this._logger.info(`${this.getOperationInfoForLogging(S.causeId,g,f)}rejected, reason=${getPrintableObject(m)||"void"}`),delete this._deferredOperationsWithOperationId[g][f],v}if(this.hasPendingOperation(g)){const S=this._deferredOperations[g],v=S.deferred.promise;return v.catch(noop),S.deferred.reject(m),this._logger.info(`${this.getOperationInfoForLogging(S.causeId,g,f)}rejected, reason=${getPrintableObject(m)||"void"}`),delete this._deferredOperations[g],v}return Promise.reject(`${this.getOperationInfoForLogging(S,g,f)}failed=reject failed, operation not found`)}maybeResolveOperation(g,m,f,S=generateCauseId()){const v=this.getOperationInfoForLogging(S,g,f);f&&this.hasPendingOperationWithOperationId(g,f)||this.hasPendingOperation(g)?this.resolveOperation(g,m,f,S).catch((g=>{this._logger.info(`${v}maybeResolveOperation failed, reason=${getPrintableObject(g)}`)})):this._logger.info(`${v}maybeResolveOperation ignored, operation does not exist`)}maybeResolveOperations(g,m,f,S=generateCauseId()){for(const v of g)this.maybeResolveOperation(v,m,f,S)}maybeRejectOperation(g,m,f,S=generateCauseId()){const v=this.getOperationInfoForLogging(S,g,f);f&&this.hasPendingOperationWithOperationId(g,f)||this.hasPendingOperation(g)?this.rejectOperation(g,m,f,S).catch(noop):this._logger.info(`${v}maybeRejectOperation ignored, operation does not exist`)}maybeRejectOperations(g,m,f,S=generateCauseId()){for(const v of g)this.maybeRejectOperation(v,m,f,S)}rejectPendingOperations(g,m=generateCauseId()){this._disposed=!0,this._logger.info(`[${m}]rejectPendingOperations=${JSON.stringify(g)}`),Object.keys(this._deferredOperations).forEach((f=>{this.maybeRejectOperation(f,g,void 0,m),this._deferredOperationsWithOperationId[m]&&delete this._deferredOperationsWithOperationId[m][""]})),Object.keys(this._deferredOperationsWithOperationId).forEach((f=>{Object.keys(this._deferredOperationsWithOperationId[f]).forEach((S=>{this.maybeRejectOperation(f,g,S,m),this._deferredOperationsWithOperationId[m]&&delete this._deferredOperationsWithOperationId[m][S]}))})),this._deferredOperations={},this._deferredOperationsWithOperationId={},this._endOperationDeferred.reject(g)}maybeRejectPendingOperationsWithPredicate(g,m=generateCauseId(),f){this._logger.info(`[${m}]rejectPendingOperationsWithPredicate`),Object.keys(this._deferredOperationsWithCauseId).forEach((m=>{Object.keys(this._deferredOperationsWithCauseId[m]).forEach((S=>{const v=this._deferredOperationsWithCauseId[m][S];v&&f(v.operationName,v.options)&&(this.maybeRejectOperation(v.operationName,g,S),this.maybeRejectOperationWithCauseId(m,S,g))}))}))}getOperationInfoForLogging(g,m,f=""){return`[${g}][${m}]${f?`[${scrubMriOrOmit(f)}]`:""}`}},pi=R,mi=class{constructor(g){this._logger=g,this._promise=Promise.resolve(void 0),this._actionQueue=[]}chainPromise(g,m,f=generateCauseId(),S=!1){const v=Date.now(),C=(("function"==typeof m?m():m)||"").toString();this._actionQueue.push(C),this._logger.info(`[${f}][${C}]enqueueing, queue=[${this._actionQueue}], reset=${S}`);const removeFromQueue=()=>{this._actionQueue=this._actionQueue.filter((g=>g!==C))};return S&&this.reset(f),this._promise=this._promise.catch(pi.noop).then((()=>{const m=Date.now()-v;return this._logger.info(`[${f}][${C}]begin, delayMs=${m}`),g()})),this._promise.then((()=>{removeFromQueue();const g=Date.now()-v;this._logger.info(`[${f}][${C}]success, durationMs=${g}`)}),(g=>{removeFromQueue();const m=Date.now()-v;this._logger.warn(`[${f}][${C}]failed=${safeJsonStringify(g)}, durationMs=${m}`)})),this._promise}reset(g){this._logger.info(`[${g}] resetting`),this._promise=Promise.resolve(void 0)}};function isTransactionEnd(g){return!(!g||!g.code)}function getRejectTransactionEnd(g,m){let f;return f=isTransactionEnd(g)?g:{code:499,subCode:void 0!==m?m:0,phrase:"string"==typeof g?g:getPrintableObject(g)},f}function getSuccessTransactionEnd(){return{code:0}}var fi=class{constructor(){this.msElapsed=0,this.isPaused=!1,this._startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this._startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this._startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this._startTime,this.durationInMinutes=()=>{const g=this.duration()/6e4;return Math.ceil(g)},this.durationInSeconds=()=>{const g=this.duration()/1e3;return Math.ceil(g)}}get startTime(){return this._startTime}};function build2(){return new fi}var Si=class extends gi{constructor(g,m,f,S,v){super(g),this.callTelemetry=m,this._ecsConfig=f,this._publishCallback=S,this._preconditionFunction=v,this._record={},this.logSuccess=(g,m,f)=>{this._logger.info(`${g} execution succeeded, result=${m?this.stringifyForLogging(m):"void"}, time=${f.duration()}`)},this.logFailure=(g,m,f)=>{this._logger.info(`${g} execution failed, reason=${this.stringifyForLogging(m)}, time=${f.duration()}`)},this.logTimeout=(g,m,f)=>{this._logger.info(`${g} execution timed out, reason=${this.stringifyForLogging(m)}, time=${f.duration()}`)},this.stringifyForLogging=g=>{let m;if(g instanceof Error)m=g.toString()||"Unknown Error";else try{m=JSON.stringify(g)}catch(g){m="Unable to stringify data"}return m},this.convertToTransactionEndIfErrorOrString=(g,m,f)=>{if(this._logger.info(`ecsEnableErrorConversion in operationHandler is: ${this._ecsConfig&&this._ecsConfig.enableErrorConversion}`),m&&this._ecsConfig&&this._ecsConfig.enableErrorConversion&&("string"==typeof g||g instanceof Error)){const m=getRejectTransactionEnd(g);return this._logger.info(`${f} Error converted from ${g} to ${getPrintableObject(m)}`),m}return g},this._logger=g.createChild("[Operation]"),this._chainedPromise=new mi(this._logger.createChild("[Chained]"))}resetOperationChain(g){this._chainedPromise.reset(g)}executeSync(g,m,f,S=generateCauseId(),v,C){const _=this.getOperationInfoForLogging(S,m,f),E=build2();this._logger.info(`${_}API calledSync`);const T=this.callTelemetry.recordOperation(m,S,f,C);let I;try{this._setRecord(m),I=g(),T.recordSuccess(I,S),this.logSuccess(_,I,E)}catch(g){const m=this.convertToTransactionEndIfErrorOrString(g,v,_);T.recordFailure(m,S),this.logFailure(_,m,E)}return I}async executeChained(g,m,f,S=generateCauseId(),v,C,_){return this.checkPendingOperationAndExecute(g,!0,m,f,S,v,C,_)}async execute(g,m,f,S=generateCauseId(),v,C,_){return this.checkPendingOperationAndExecute(g,!1,m,f,S,v,C,_)}logOperation(g,m,...f){const S=f.length&&f.map((g=>this.stringifyForLogging(scrubMriOrOmit(g))));this._logger.info(`[${g}][${m}]API called, ${S?`with args=${S}`:""}`)}rejectPendingOperations(g,m=generateCauseId(),f){if(f){for(const g of Object.keys(this._deferredOperations))this.callTelemetry.maybeRecordOperationFailure(g,f,void 0,m);for(const g of Object.keys(this._deferredOperationsWithOperationId))for(const S of Object.keys(this._deferredOperationsWithOperationId[g]))this.callTelemetry.maybeRecordOperationFailure(g,f,S,m)}super.rejectPendingOperations(g,m)}maybeRejectOperations(g,m,f,S=generateCauseId(),v){if(v)for(const m of g)this.callTelemetry.maybeRecordOperationFailure(m,v,void 0,S);super.maybeRejectOperations(g,m,f,S)}checkPendingOperationAndExecute(g,m,f,S,v=generateCauseId(),C,_,E){const T=this.getOperationInfoForLogging(v,f,S);let I=null,b=null;return this.hasPendingOperationWithOperationId(f,S)||this.hasPendingOperation(f)?(this._logger.info(`${T}already pending, returning existing operation`),I=this.waitForOperation(f,S,v)):b=this.createPendingOperation(f,S,v,E),m?(this._logger.info(`${T}chained`),this._chainedPromise.chainPromise((()=>I||this.executeInternal(b,v,g,f,S,C,_,E)),f,v)):I||this.executeInternal(b,v,g,f,S,C,_,E)}_setRecord(g){this._record.hasOwnProperty(g)||(this._record[g]=0),this._record[g]+=1}getRecord(g){return this._record[g]}_recordTelemetryTimeoutAndPublish(g,m,f,S,v,C,_){const E=g||60;return window.setTimeout((()=>{if(!this._publishCallback)return void this._logger.warn(`${v} is marked to publish telemetry but no publish callback is defined.`);if(!this.hasPendingOperationWithOperationId(S,_)&&!this.hasPendingOperation(S))return;const g=new Error(`${v} execution did not complete before telemetry timeout of ${E}s.`);this.logTimeout(v,g,C),this.callTelemetry.maybeRecordOperationTimeout(S,g,_,f),this._publishCallback(m),this.callTelemetry.removeRecordedEvent(m)}),1e3*E)}_instantTelemetryPublish(g,m){this._publishCallback?(this._publishCallback(m),this.callTelemetry.removeRecordedEvent(m)):this._logger.warn(`${g} is marked to publish telemetry but no publish callback is defined.`)}parseInstantTelemetryParameters(g){let m,f=!1;return g&&(f=g.enableInstantTelemetry,m=g.telemetryTimeout),[f,m]}async executeInternal(g,m,f,S,v,C,_,E){const T=this.getOperationInfoForLogging(m,S,v);this._logger.info(`${T} executing operation...`);const I=build2(),b=this.callTelemetry.recordOperation(S,m,v,_),[A,P]=this.parseInstantTelemetryParameters(E);try{let g;this._setRecord(S),A&&(g=this._recordTelemetryTimeoutAndPublish(P,b,m,S,T,I,v)),E?.preconditionTags?.length&&this._preconditionFunction&&this._preconditionFunction(S,E.preconditionTags);const C=await f();g&&clearTimeout(g),this.callTelemetry.maybeRecordOperationSuccess(S,C,v),this.logSuccess(T,C,I),this.maybeResolveOperation(S,C,v,m)}catch(g){const f=this.convertToTransactionEndIfErrorOrString(g,C,T);this.callTelemetry.maybeRecordOperationFailure(S,f,v),this.logFailure(T,f,I),this.maybeRejectOperation(S,f,v,m)}return A&&this._instantTelemetryPublish(T,b),g}getEcsConfig(){return this._ecsConfig}},vi={Cancel:487,Reject:603,NoNgcEndpoint:480,Forbidden:403,PreconditionFailed:412,Success:0,CallRedirected:302,BadRequest:400,NotFound:404,NotAcceptable:406,Timeout:408,Conflict:409,MediaError:410,ConfParticipantCountLimitReached:413,CallAccepted:450,CallForwarded:451,CallForwardedToVoicemail:452,P2pRejectCall:453,P2pFallbackForScreensharing:460,P2pFallbackDueToGroupCall:461,CallLegEndedOnService:470,CallDoesNotExist:481,NotAcceptableHere:488,NetworkError:490,GlareError:491,SkypeTokenError:495,LocalHttpStackError:496,UnknownError:497,LocalError:498,InternalServerError:500,CallModalityFailure:580,ServiceUnavailable:503},yi={Success:0,CallRedirectedSuccess:3020,InsufficientCapabilities:5204,PolicyRestriction:5448,UserBlocked:10005,MaxLobbyParticipantLimitReached:5807,MaxParticipantLimitReached:5808,MaxParticipantLimitReached2:5817,SharingStolenError:10029,DowngradeToStreamingClient:3099,MediaDropDuringConnect:3100,MediaDropAfterConnect:3101,MediaAnswerProcessingError:3102,MediaFinalAnswerProcessingError:3103,MediaOfferTimeout:3104,MediaFinalAnswerTimeout:3105,MediaOfferNull:3106,MediaAudioDeviceError:3107,MediaRenegotiationError:3108,MediaPermissionError:3109,MediaUnknownError:3110,MediaOfferProcessingError:3111,MediaWhiteListingIssue:3112,MediaMuteMicrophoneError:3113,MediaMuteSpeakerError:3114,MediaUnmuteMicrophoneError:3115,MediaUnmuteSpeakerError:3115,AttachActionFailed:4103,AttachFailed:4105,PreheatedCallTimedout:4113,RemovedFromConversation:5e3,DeniedInLobby:5854,RemovedFromCall:5300,TimedOutInLobby:5855,AnonymousJoinDisabledByPolicy:5723,B2bJoinDisabledByPolicy:5724,NoLobbyForBroadcastJoin:5354,NotAllowedDueToInformationBarrier:5810,TeamParkPolicyDisabled:10193,BroadcastLimitReached:800100},Ci={[vi.Success]:1,[vi.Cancel]:12,[vi.Reject]:10,[vi.NoNgcEndpoint]:2,[vi.Timeout]:6,[vi.CallAccepted]:30,[vi.CallRedirected]:75,[vi.NotFound]:24,[vi.CallDoesNotExist]:46,[vi.NotAcceptable]:5,[vi.BadRequest]:5,[vi.MediaError]:4,[vi.ConfParticipantCountLimitReached]:59,[vi.CallModalityFailure]:4,[vi.NetworkError]:3,[vi.LocalHttpStackError]:31,[vi.LocalError]:25,[vi.CallForwarded]:27,[vi.CallForwardedToVoicemail]:28,[vi.SkypeTokenError]:29,[vi.InternalServerError]:7,[vi.Conflict]:7,[vi.GlareError]:7,[vi.CallLegEndedOnService]:7,[vi.NotAcceptableHere]:26,[vi.UnknownError]:32,[vi.Forbidden]:8,[vi.PreconditionFailed]:65},_i={9401:33,9422:33,6102:1,6423:14,9402:14,9432:14,6519:3,9403:15,9410:36,9411:37,1e3:2,9407:17,13430:18,6009:19,10484:19,10604:19,10404:19,10420:19,10403:20,17401:20,10408:9,10486:11,10600:11,10686:11,10487:21,10500:3,10501:3,10502:3,10503:3,10504:3,10480:22,10482:22,10603:10,13406:23,13416:23},Ei={500:39,403:41,404:42,480:40},Ti={INCOMING_SKYPE_NGC_CALL:107,INCOMING_SKYPE_NGC_GVC_CALL:109,INCOMING_PSTN_NGC_CALL:111,INCOMING_SCREENSHARE_WITH_CHAT:119,INCOMING_TFL_TFW_CALL:126},Ii={SHARED_LINE_CALL_RECORD:121,SHARED_LINE_V2_CALL_RECORD:123,MEETING_STARTED_NOTIFICATION:128},bi={LOG_UPLOAD_EVENT:120},Ai={Unknown:"CallEndReasonUnknown",MediaError:"CallEndReasonMediaError",MediaOfferTimeout:"CallEndReasonMediaOfferTimeout",MediaFinalAnswerTimeout:"CallEndReasonMediaFinalAnswerTimeout",MediaAnswerError:"CallEndReasonMediaAnswerError",MediaFinalAnswerError:"CallEndReasonFinalAnswerError",MediaPermissionError:"CallEndReasonMediaPermissionError",MediaRenegotiationError:"CallEndReasonRenegotiationError",MediaDropDuringConnect:"CallEndReasonMediaDropDuringConnectError",MediaDropAfterConnect:"CallEndReasonMediaDropAfterConnectError",MediaOfferProcessingError:"CallEndReasonMediaOfferProcessingError",DowngradeToStreamingClient:"DowngradeToStreamingClient",IncompatibleOffer:"CallEndReasonIncompatibleOffer",MediaWhiteListingIssue:"MediaWhitelistingIssue",AudioDeviceError:"CallEndReasonAudioDeviceError",AttachFailed:"CallEndReasonAttachFailed",BadNotificationPayload:"CallEndReasonBadNotificationPayload",RetargetNotSupported:"RetargetNotSupported",CallEndReasonLocalUserInitiated:"CallEndReasonLocalUserInitiated",EndedByRemoteEndpoint:"EndedByRemoteEndpoint",CallEndReasonRedirected:"CallEndReasonRedirected",CallEndReasonVDIdisconnect:"CallEndReasonVDIdisconnect"},Pi=(g=>(g.GetSignalingMediaTypes="GetSignalingMediaTypes",g.CallStart="CallStart",g.WaitForAnswer="WaitForAnswer",g.WaitForConnect="WaitForConnect",g.Accept="Accept",g))(Pi||{}),Ri=(g=>(g.InitializeMediaSession="InitializeMediaSession",g.UpdateMediaModalities="UpdateMediaModalities",g.CreateOffer="CreateOffer",g.CreateAnswer="CreateAnswer",g.ProcessAnswer="ProcessAnswer",g.GetSignalingMediaTypes="GetSignalingMediaTypes",g.MuteUnmute="MuteUnmute",g.MuteUnmuteSpeakers="MuteUnmuteSpeakers",g.StartVideoSafe="StartVideoSafe",g.CompleteNegotiation="CompleteNegotiation",g.MuteInput="MuteInput",g.MuteOutput="MuteOutput",g.UnmuteInput="UnmuteInput",g.UnmuteOutput="UnmuteOutput",g.handleEndpointStatesForAccept="handleEndpointStatesForAccept",g))(Ri||{}),wi=(g=>(g.InitializeMediaSession="InitializeMediaSession",g.ProcessOffer="ProcessOffer",g.ProcessOfferedModalities="ProcessOfferedModalities",g.TrySendingProvisionalAnswer="TrySendingProvisionalAnswer",g))(wi||{}),Mi=R,Di=__toESM(R),Oi=__toESM(R),Ni=__toESM(ye()),ki={Success:"Success",ExpectedError:"ExpectedError",UnexpectedClientError:"UnexpectedClientError",UnexpectedServerError:"UnexpectedServerError"},Li={INCOMING_MESSAGE_ORIGIN:{TROUTER:"Trouter",BROKER:"Broker"},INVITATION_TYPE:{NUDGE:"nudge"},KNOWN_PAYLOAD_ENCODINGS:{GZIP:!0},WEBRTC_NOTIFICATION_TYPE:{CONTROL_VIDEO_STREAMING:"ControlVideoStreaming",DOMINANT_SPEAKER_INFO:"DominantSpeakerInfo",CSRC_INFO:"CsrcInfo"},PARTICIPANT_AUDIO_STATE:{CONNECTING:"Connecting",RINGING:"Ringing",CONNECTED:"Connected",OTHER:"Other"},HEADERS:{MESSAGE_ID:"X-Microsoft-Skype-Message-ID",ORIGINAL_MESSAGE_ID:"X-Microsoft-Skype-Original-Message-ID",CONTENT_ENCODING:"X-Microsoft-Skype-Content-Encoding",CORRELATION_ID:"X-Microsoft-Skype-Chain-ID",CONTENT_SHARING_CORRELATION_ID:"X-Microsoft-Skype-ContentSharing-Chain-ID",CLIENT_USER_AGENT:"X-Microsoft-Skype-Client",SKYPE_TOKEN:"X-Skypetoken",AUTHORIZATION:"Authorization",BEARER_KEYWORD:"Bearer",AAD_KEYWORD:"Aad",CAE_KEYWORD:"Cae",SKYPE_KEYWORD:"Skype",CACHE_SKYPE_TOKEN:"X-CacheSkypeToken",AUTHENTICATE:"www-authenticate",TOKEN_MIGRATION:"X-MS-Migration",BROKER_USE_BATCHING_HEADER_NAME:"X-UseBatching",PARTICIPANT_ID:"X-Microsoft-Skype-Participant-ID",CONTENT_TYPE:"Content-Type",RING:"MS-Teams-Ring",REGION:"MS-Teams-Region",PARTITION:"MS-Teams-Partition"},KNOWN_BOTS:{VOICEMAIL_BOT_ID:"28:14524421-25b4-403a-a0f7-e62d4379cabc"},HTTP_STACK_ERROR:{NONE:0,CANNOT_CONNECT:7,REQUEST_TIMEOUT:10,ATTEMPT_TIMEOUT:30,REQUEST_ABORTED:16,ATTEMPT_ABORTED:31,ABORTED_OTHER_ATTEMPT_SUCCESSFUL:32},HTTP_STATUS_CODES:{UNKNOWN:0,OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,NOT_FOUND:404,FORBIDDEN:403,PRECONDITION_FAILED:412,UNPROCESSABLE_ENTITY:422,NETWORK_ERROR:490,SKYPE_TOKEN_ERROR:495,OFFLINE:496,TIMEOUT:498,ABORTED:498,OTHER:499,INTERNAL_SERVER_ERROR:500,CONFLICT:409,BAD_GATEWAY:502,SERVICE_UNAVAILABLE:503,GATEWAY_TIMEOUT:504},CALL_END_SKYPE_TOKEN_ERROR:{code:495,subCode:4507,phrase:"CallEndReasonSkypeTokenFetchError",resultCategories:[ki.UnexpectedClientError]},CALL_END_TOKEN_ERROR:{code:499,subCode:3119,phrase:"CallEndReasonTokenFetchError",resultCategories:[ki.UnexpectedClientError]},CALL_END_UNSUPPORTED_TOKEN_ERROR:{code:499,subCode:3126,phrase:"CallEndReasonUnsupportedTokenError",resultCategories:[ki.UnexpectedClientError]},CALL_END_LOCAL_HTTP_STACK_ERROR:{code:496,subCode:4520,phrase:"LocalHTTPStackError",resultCategories:[ki.UnexpectedClientError]},CALL_END_UNKNOWN_ERROR:{code:497,subCode:3121,phrase:"CallEndReasonUnknownError",resultCategories:[ki.UnexpectedClientError]},CALL_END_NETWORK_ERROR:{code:490,subCode:4502,phrase:"CallEndReasonNetworkError",resultCategories:[ki.UnexpectedClientError]},CALL_END_LOCAL_DECLINE:{code:486,subCode:4508,phrase:"LocalDecline",resultCategories:[ki.Success]},RESOURCE_NOT_FOUND_ERROR:{code:404,subCode:404,phrase:"ResourceNotFound",resultCategories:[ki.ExpectedError]},CALL_STATUS:{IDLE:"Idle",RINGING:"Ringing",CONNECTING:"Connecting",CONNECTED:"Connected",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly",LOCAL_TERMINATED:"LocalTerminated",REMOTE_TERMINATED:"RemoteTerminated"},MEDIA_TYPES:{AUDIO:"Audio",VIDEO:"Video",SCREEN_SHARER:"ScreenSharer",SCREEN_VIEWER:"ScreenViewer"},MUTE_SCOPE:{MYSELF:"Myself",EVERYONE_ELSE:"EveryoneElse",SPECIFIED_PARTICIPANTS:"SpecifiedParticipants"},URL_BASE:{CALLAGENT:"callAgent"},LINKS:{HANGUP:"hangup",MEDIA_REJECTION:"mediaRejection",MEDIA_ANSWER:"mediaAnswer",MEDIA_RENEGOTIATION:"mediaRenegotiation",ACCEPT:"accept",ATTACH:"attach",REJECT:"reject",REDIRECT:"redirect",REPLACE:"replace",TRANSFER:"transfer",NEW_OFFER:"newOffer",TRANSFER_ACCEPTANCE:"transferAcceptance",TRANSFER_COMPLETION:"transferCompletion",CONVERSATION_CONTROLLER:"conversationController",ADD_PARTICIPANT:"addParticipant",ADD_PARTICIPANTS_AND_MODALITY:"addParticipantsAndModality",LEAVE:"leave",NOTIFICATION_LINKS:"notificationLinks",REMOVE_PARTICIPANT:"removeParticipant",KEEPALIVE:"keepAlive",ADD_MODALITY:"AddModality",REMOVE_MODALITY:"RemoveModality",CONTENT_SHARING_CONTROLLER:"contentSharingController",CONTENT_SHARING_TAKE_CONTROL:"contentSharingTakeControl",CONTENT_SHARING_UPDATE_SESSION_STATE:"contentSharingUpdateSessionState",CONTENT_SHARING_UPDATE_PARTICIPANT_STATE:"contentSharingUpdateParticipantState",CONTENT_SHARING_NOTIFICATION_LINKS:"contentSharingNotificationLinks",CONTENT_SHARING_LEAVE:"contentSharingLeave",MUTE:"mute",UNMUTE:"unmute",ADMIT:"admit",ADMIT_ALL:"admitAll",CONTROL_VIDEO_STREAMING:"controlVideoStreaming",APPLY_CHANNEL_PARAMETERS:"applyChannelParameters",UPDATE_ENDPOINT_STATE:"updateEndpointState",UPDATE_ENDPOINT_METADATA:"updateEndpointMetadata",LMC_NOTIFICATION_LINKS:"lmcNotificationLinks",UPDATE_PARTICIPANT_ROLE:"updateParticipantRole",PUBLISH_STATE:"publishState",REMOVE_STATE:"removeState",UPDATE_MEETING_SETTINGS:"updateMeetingSettings",SEARCH_PARTICIPANTS:"searchParticipants",GET_ALL_PARTICIPANTS:"getAllParticipants",PARK:"park",UNPARK:"unpark",UPDATE_MEETING_LIVE_STATE:"updateMeetingLiveState",UPDATE_MEETING_GROUPS:"updateMeetingGroups",SET_MEETING_LAYOUT:"setMeetingLayout",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"updateParticipantInterpretationState",JOIN_MEETING_GROUP:"joinMeetingGroup",LEAVE_MEETING_GROUP:"leaveMeetingGroup",SEND_MESSAGE:"sendMessage",UPDATE_PARTICIPANTS_PROPERTIES:"updateParticipantsProperties",UPDATE_MEDIA_DESCRIPTIONS:"updateMediaDescriptions",UPDATE_MEETING_STATES:"updateMeetingStates"},CONTENT_TYPE:{JSON:"application/json",SDP:"application/sdp"},TROUTER_EVENT_TYPE:{SKYPE_SKYPE_CALL:107,LYNC_SKYPE_CALL:105},MISC:{CONVERSATION:"conversation",LOBBY_CALL_CONTROLLER:"lobby",LOBBY_PARTICIPANT_STATE:"lobby"},SIGNALING_FSM_STATE:{IDLE:"Idle",INCOMING:"Incoming",WAITING_CALL_ACCEPTANCE_ACK:"WaitingCallAcceptanceAck",OUTGOING:"Outgoing",CONNECTED:"Connected",OUTGOING_FOR_ROSTER_ONLY:"OutgoingForRosterOnly",CONNECTED_FOR_ROSTER_ONLY:"ConnectedForRosterOnly"},MEDIA_RENEGOTIATION_FSM_STATE:{IDLE:"Idle",CALL_CONNECTED:"Connected",INCOMING_RENEGOTIATION:"IncomingRenegotiation",OUTGOING_RENEGOTIATION:"OutgoingRenegotiation",RENEGOTIATION_GLARE:"RenegotiationGlare"},CONTENT_SHARING_FSM_STATE:{IDLE:"Idle",CONTENT_SHARING_START_INITIATED:"ContentSharingStartInitiated",CONTENT_SHARING_JOIN_INITIATED:"ContentSharingJoinInitiated",CONTENT_SHARING_LEAVE_INITIATED:"ContentSharingLeaveInitiated",CONTENT_SHARING_DELETE_INITIATED:"ContentSharingDeleteInitiated",CONTENT_SHARING_CONNECTED:"ContentSharingConnected"},TIMEOUT_OPERATIONS:{ADD_PARTICIPANT:"AddParticipant",NUDGE_PARTICIPANT:"NudgeParticipant",REMOVE_PARTICIPANT:"RemoveParticipant",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT:"Admit",CALL_REDIRECT:"CallRedirect",CALL_ME_BACK:"CallMeBack",INCOMING_CALL_ESTABLISHMENT:"IncomingCallEstablishment",OUTGOING_CALL_ESTABLISHMENT:"OutgoingCallEstablishment",MEDIA_ANSWER:"MediaAnswer",MEDIA_ANSWER_ACKNOWLEDGEMENT:"MediaAnswerAcknowledgement",ADD_MODALITY:"AddModality",UNMUTE:"Unmute",UPDATE_MEETING_ROLE:"UpdateMeetingRole",MAX_PREAHEATED_TIMEOUT:"MaxPreheateadTimeout",PARK_COMPLETION:"ParkCompletion",UNPARK_COMPLETION:"UnparkCompletion",UPDATE_MEETING_LIVE_STATE_COMPLETION:"UpdateMeetingLiveStateCompletion",UPDATE_MEETING_GROUPS_COMPLETION:"UpgradeMeetingGroupsCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"UpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"UpdateParticipantsPropertiesCompletion",JOIN_MEETING_GROUP_COMPLETION:"JoinMeetingGroupCompletion",LEAVE_MEETING_GROUP_COMPLETION:"LeaveMeetingGroupCompletion",SET_MEETING_LAYOUT_COMPLETION:"SetMeetingLayoutCompletion",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",DISABLE_PREHEAT_ASYNC_TIMEOUT:"DisablePreheatAsyncTimeout",UPDATE_MEETING_STATES_COMPLETION:"UpdateMeetingStatesCompletion"},TIMEOUT_VALUES_IN_SECONDS:{ADD_PARTICIPANT_TIMEOUT:130,REMOVE_PARTICIPANT_TIMEOUT:60,INCOMING_CALL_ESTABLISHMENT_TIMEOUT:75,OUTGOING_CALL_ESTABLISHMENT_TIMEOUT:90,MEDIA_ANSWER_TIMEOUT:35,MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT:15,ADD_MODALITY_TIMEOUT:65,UNMUTE_TIMEOUT:35,ADMIT_PARTICIPANT_TIMEOUT:30,ADMIT_TIMEOUT:60,UPDATE_MEETING_ROLE_TIMEOUT:15,NUDGE_PARTICIPANT_TIMEOUT:60,CALL_ME_BACK_TIMEOUT:120,MAX_PREAHEATED_TIMEOUT:90,PARK_COMPLETION_TIMEOUT:45,UNPARK_COMPLETION_TIMEOUT:45,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:45,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:45,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT:45,UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT:45,JOIN_MEETING_GROUP_COMPLETION_TIMEOUT:45,LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT:45,CONVERSATION_KEEP_ALIVE_TIMEOUT:2700,TOKEN_REQUIRED_TIMEOUT:20,SEND_MESSAGE_COMPLETION_TIMEOUT:15,DISABLE_PREHEAT_TIMEOUT:45,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:45},CALL_END_CODE:{REJECT:603,SUCCESS:0,CALL_REDIRECTED:302,CANCEL:487,TIMEOUT:408,SERVICE_UNAVAILABLE:500,BAD_REQUEST:406,NO_NGC_ENDPOINT:480,P2P_FALLBACK_FOR_SCREENSHARING:460,CONFLICT:409,MEDIA_ERROR:410,CONF_PARTICIPANT_COUNT_LIMIT_REACHED:413,CALL_DOES_NOT_EXIST:481,CALL_ACCEPTED:450,CALL_FORWARDED:451,CALL_FORWARDED_TO_VOICEMAIL:452,P2P_REJECT_CALL:453,P2P_FALLBACK_DUE_TO_GROUPCALL:461,CALL_LEG_ENDED_ON_SERVICE:470,NOT_ACCEPTABLE_HERE:488,NETWORK_ERROR:490,UNKNOWN_ERROR:497,LOCAL_ERROR:498,CALL_MODALITY_FAILURE:580,ATC_CONTROLLER_FAILURE:581,CVA_CONTROLLER_FAILURE:586,GLARE_ERROR:491,NOT_FOUND:404,SKYPE_TOKEN_ERROR:495,LOCAL_HTTP_STACK_ERROR:496,HTTP_OTHER_ERROR:499,DECODING_FAILED:407,NOT_AUTHORIZED:403,BAD_SERVICE_RESPONSE:400},CALL_END_SUB_CODE:{SUCCESS:0,CALL_REDIRECTED_SUCCESS:3020,DOWNGRADE_TO_STREAMING_CLIENT:3099,MEDIA_DROP_DURING_CONNECT:3100,MEDIA_DROP_AFTER_CONNECT:3101,MEDIA_ANSWER_PROCESSING_ERROR:3102,MEDIA_FINAL_ANSWER_PROCESSING_ERROR:3103,MEDIA_OFFER_TIMEOUT:3104,MEDIA_FINAL_ANSWER_TIMEOUT:3105,MEDIA_OFFER_NULL:3106,MEDIA_AUDIO_DEVICE_ERROR:3107,MEDIA_RENEGOTIATION_ERROR:3108,MEDIA_PERMISSION_ERROR:3109,MEDIA_UNKNOWN_ERROR:3110,MEDIA_OFFER_PROCESSING_ERROR:3111,MEDIA_WHITELISTING_ISSUE:3112,MEDIA_MUTE_MICROPHONE_ERROR:3114,MEDIA_MUTE_SPEAKER_ERROR:3115,MEDIA_UNMUTE_MICROPHONE_ERROR:3116,MEDIA_UNMUTE_SPEAKER_ERROR:3117,MEDIA_GLARE_ERROR:3118,CONVERSATION_TERMINATION_UNKNOWN_ERROR:3121,CONVERSATION_NOTIFICATION_TIMEOUT:3125,CALL_NOT_ATTEMPTED:4500,CONV_URL_NOT_SET:4501,FAILED_TO_REACH_SERVICE:4502,PLACE_CALL_FAILED:4503,ATTACH_CALL_FAILED:4504,BAD_NOTIFICATION_PAYLOAD:4505,CALL_ESTABLISHMENT_TIMEOUT:4506,SKYPE_TOKEN_ERROR:4507,CONVERSATION_RESOLUTION_CONFLICT:5704,CALL_PARTICIPANT_REMOVAL_TIMEOUT:4507,UNMUTE_REQUEST_TIMEOUT:4509,UNMUTE_REQUEST_REJECTED:4510,CONFLICT_IN_NG:4090,CONFLICT_WITH_P2P:4091,CONVERSATION_END_RECEIVED_FROM_SERVICE:4100,TRANSFER_COMPLETE_TIMEOUT:4101,ATTACH_TO_NON_EXISTENT_CALL:4102,ATTACH_ACTION_FAILED:4103,ATTACH_FAILED:4105,CONVERSATION_ESTABLISHMENT_FAILED:4106,BEFORE_CONNECT:4107,AFTER_CONNECT:4108,AFTER_ACCEPT:4109,TROUTER_CONNECTION_DROPPED:4111,DUE_TO_CALL_ASSIMILATION:4112,PREHEATED_CALL_TIMEDOUT:4113,UNPARK_COMPLETION_TIMEOUT:4114,PARK_COMPLETION_TIMEOUT:4115,UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:4116,UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:4117,SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:4118,UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:4119,JOIN_MEETING_GROUP_TIMEOUT:4120,LEAVE_MEETING_GROUP_TIMEOUT:4121,UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:4122,UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:4123,MISSING_REQUEST_URI:4511,LOCAL_HTTP_STACK_ERROR:4520,BEACON:4521,CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:5014,UNABLE_TO_GENERATE_MEETUP_ID:5015,UPDATE_MEETING_ROLE_REJECTED:5651,UPDATE_MEETING_ROLE_TIMEOUT:5652,PUBLISH_STATE_LINK_MISSING:5653,PUBLISH_STATE_INVALID_CONTENT:5654,PUBLISH_STATE_INVALID_SERVICE_RESPONSE:5655,REMOVE_STATE_LINK_MISSING:5656,REMOVE_STATE_MISSING_ARGUMENTS:5657,UPDATE_MEETING_SETTINGS_LINK_MISSING:5658,UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS:5659,ADMIT_ALL_LINK_MISSING:5660,ADMIT_TIMEOUT:5661,CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE:5670,ROSTER_HANDLING_INVALID_SERVICE_RESPONSE:5671,SEARCH_PARTICIPANTS_LINK_MISSING:5672,SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5673,GET_ALL_PARTICIPANTS_LINK_MISSING:5674,GET_ALL_PARTICIPANTS_INVALID_SCOPE:5675,GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE:5676,PARK_UNPARK_TYPE_MISSING:5680,PARK_UNPARK_V2_DISABLED:5682,UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING:5683,DISABLE_PREHEAT_TIMEOUT:5684,CALL_ENDED_BY_PLATFORM_AGENT:7e3},CALL_END_PHRASE:{UNKNOWN:"CallEndReasonUnknown",MEDIA_ERROR:"CallEndReasonMediaError",MEDIA_OFFER_TIMEOUT:"CallEndReasonMediaOfferTimeout",MEDIA_FINAL_ANSWER_TIMEOUT:"CallEndReasonMediaFinalAnswerTimeout",MEDIA_ANSWER_ERROR:"CallEndReasonMediaAnswerError",MEDIA_FINAL_ANSWER_ERROR:"CallEndReasonFinalAnswerError",MEDIA_PERMISSION_ERROR:"CallEndReasonMediaPermissionError",MEDIA_RENEGOTIATION_ERROR:"CallEndReasonRenegotiationError",MEDIA_DROP_DURING_CONNECT:"CallEndReasonMediaDropDuringConnectError",MEDIA_DROP_AFTER_CONNECT:"CallEndReasonMediaDropAfterConnectError",MEDIA_OFFER_PROCESSING_ERROR:"CallEndReasonMediaOfferProcessingError",MEDIA_WHITELISTING_ISSUE:"MediaWhitelistingIssue",AUDIO_ERROR:"CallEndReasonAudioDeviceError",CONVERSATION_NOTIFICATION_TIMEOUT:"ConversationNotificationTimeout",BAD_NOTIFICATION_PAYLOAD:"BadCallNotificationPayload",NETWORK_ERROR:"CallEndReasonNetworkError",LOCAL_USER_INITIATED:"CallEndReasonLocalUserInitiated",REMOTE_USER_INITIATED:"CallEndReasonRemoteUserInitiated",ESTABLISHMENT_TIMEOUT:"CallEndReasonEstablishmentTimeout",PARTICIPANT_REMOVAL_TIMEOUT:"CallParticipantRemovalTimeout",LOCAL_ERROR:"CallEndReasonLocalError",CALL_UPDATE_ERROR:"CallEndReasonCallUpdateError",CALL_REDIRECT_IS_NOT_ALLOWED:"CallRedirectisNotAllowed",P2P_FORK_CONNECTED:"CallEndReasonP2pForkConnected",P2P_FORK_FORWARDED:"CallEndReasonP2pForkForwarded",P2P_FORK_FORWARDED_TO_VOICEMAIL:"CallEndReasonP2pForkForwardedToVoiceMail",P2P_FALLBACK_FOR_SCREENSHARING:"CallEndReasonP2pFallbackForScreensharing",P2P_FALLBACK_FOR_GROUPCALL:"CallEndReasonP2pFallbackForGroupCall",P2P_FALLBACK_FOR_CALL_ASSIMILATION:"CallEndReasonP2pFallbackForCallAssimilation",P2P_FALLBACK_FOR_TRANSLATION:"CallEndReasonP2pFallbackForCallTranslation",P2P_FORK_REJECTED:"CallEndReasonP2pForkRejected",TROUTER_CONNECTION_DROPPED:"CallEndReasonTrouterConnectionDropped",REMOVED_FROM_CALL:"CallEndReasonRemovedFromCall",TRANSFER_COMPLETION_TIMEOUT:"CallEndReasonTransferCompletionTimeout",CALL_DOES_NOT_EXIST:"CallEndReasonCallDoesNotExist",ATTACH_ACTION_FAILED:"CallEndReasonAttachActionFailed",ATTACH_FAILED:"CallEndReasonAttachFailed",CONVERSATION_ESTABLISHMENT_FAILED:"CallEndReasonConversationEstablishmentFailed",CONV_END_FROM_SERVICE:"CallEndReasonConversationEndReceivedFromService",CONV_END_FROM_SERVICE_WITH_ERROR:"CallEndReasonConversationEndReceivedFromServiceWithError",SERVICE_ERROR:"CallEndReasonServiceError",CONFLICT:"CallEndReasonConflict",CALL_ALREADY_IN_P2P:"CallEndReasonCallAlreadyExistsInP2p",CONV_END_NO_MODALITY:"ConversationEndNoModalityConnected",CONV_END_FOR_ALL_INITIATED:"ConversationEndForAllInitiated",RENEGOTIATION_IN_PROGRESS:"NegotiationIsInProgress",ADD_PARTICIPANT_URL_MISSING:"AddParticipantUrlMissing",ADMIT_PARTICIPANT_URL_MISSING:"AdmitParticipantUrlMissing",ADMIT_ALL_URL_MISSING:"AdmitAllUrlMissing",UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING:"UpdateParticipantInterpretationStateUrlMissing",UPDATE_PARTICIPANTS_PROPERTIES_URL_MISSING:"UpdateParticipantsPropertiesUrlMissing",ADMIT_TIMEOUT:"AdmitTimeout",UNABLE_TO_GENERATE_MEETUP_ID:"Unable to generate GroupChat meetup id.",ENDED_BY_PMA:"Call ended by media agent.",OWNERSHIP_RESOLUTION_CONFLICT:"Conversation cannot be created due to a failure to resolve ownership.",CONVERSATION_ENDED_NO_NEW_OWNER_FOUND:"This conversation has ended since we were unable to determine a potential host for the group call.",UNMUTE_REQUEST_TIMEOUT:"UnmuteRequestTimeout",UNMUTE_REQUEST_REJECTED:"UnmuteRequestRejected",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",UPDATE_MEETING_ROLE_REJECTED:"Update meeting role operation failed due to insufficient privileges.",PARK_REQUEST_FAILED:"Park Request Failed",PARK_COMPLETION_TIMEOUT:"ParkCompletionTimeout",PARK_COMPLETION_FAILED:"ParkCompletionFailed",UNPARK_REQUEST_FAILED:"UnparkFailed",UNPARK_COMPLETION_TIMEOUT:"UnparkCompletionTimeout",UNPARK_COMPLETION_FAILED:"UnparkCompletionFailed",BAD_SERVICE_RESPONSE:"BadServiceResponse",UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT:"UpdateMeetingLiveStateCompletionTimeout",UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT:"UpdateMeetingGroupsCompletionTimeout",SET_MEETING_LAYOUT_COMPLETION_TIMEOUT:"SetMeetingLayoutCompletionTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationTimeout",JOIN_MEETING_GROUP_TIMEOUT:"JoinMeetingGroupTimeout",LEAVE_MEETING_GROUP_TIMEOUT:"LeaveMeetingGroupTimeout",DOWNGRADE_TO_STREAMING_CLIENT:"DowngradeToStreamingClient",MESSAGE_STATUS_WITH_FAILURE_COUNT:"NotZeroFailureCount",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",DISABLE_PREHEAT_TIMEOUT:"DisablePreheatTimeout",UPDATE_MEETING_STATES_COMPLETION_TIMEOUT:"UpdateMeetingStatesCompletionTimeout"},TRANSACTION_END_CODE:{SUCCESS:0},URL_DEFAULTS:{UPLOAD_LOG_URL:"https://api.cc.skype.com/cc/v1/uploadlog/"},SUCCESS_TRANSACTION_END:{code:0,resultCategories:[ki.Success]},VALIDATION:{VALIDATION_FAILED:6e3,NULL_OR_EMPTY:6001}},Fi={REQUEST_TIMEOUT:{status:Li.HTTP_STATUS_CODES.TIMEOUT,statusText:"Request timed out",readyState:0,response:Li.HTTP_STACK_ERROR.REQUEST_TIMEOUT},ATTEMPT_TIMEOUT:{status:Li.HTTP_STATUS_CODES.TIMEOUT,statusText:"Attempt timed out",readyState:0,response:Li.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT},REQUEST_ABORTED:{status:Li.HTTP_STATUS_CODES.ABORTED,statusText:"Request Aborted",readyState:0,response:Li.HTTP_STACK_ERROR.REQUEST_ABORTED},ATTEMPT_ABORTED:{status:Li.HTTP_STATUS_CODES.ABORTED,statusText:"Attempt Aborted",readyState:0,response:Li.HTTP_STACK_ERROR.ATTEMPT_ABORTED}},xi={MEDIA_ACKNOWLEDGEMENT:"/call/mediaAcknowledgement/",MEDIA_REJECTION:"/call/rejection/",ACKNOWLEDGEMENT:"/call/acknowledgement/",MEDIA_RENEGOTIATION:"/call/mediaRenegotiation/",REPLACE:"/call/replacement/",PROGRESS:"/call/progress/",MEDIA_ANSWER:"/call/mediaAnswer/",NEW_MEDIA_OFFER:"/call/newMediaOffer/",REDIRECTION:"/call/redirection/",BALANCE_UPDATE:"/call/balanceUpdate/",ACCEPT:"/call/acceptance/",CONTROL_VIDEO_STREAMING:"/call/controlVideoStreaming/",DOMINANT_SPEAKER_INFO:"/call/dominantSpeakerInfo/",CSRC_INFO:"/call/csrcInfo/",END:"/call/end/",RETARGET_COMPLETION:"/call/retargetCompletion/",TRANSFER:"/call/transfer/",TRANSFER_ACCEPTANCE:"/call/transferAcceptance/",TRANSFER_COMPLETION:"/call/transferCompletion/",PARK_COMPLETION:"/call/holdCompletion/",UNPARK_COMPLETION:"/call/resumeCompletion/",UPDATE_MEDIA_DESCRIPTIONS:"/call/updateMediaDescriptions"},Ui={CONV_END:"/conversation/conversationEnd/",CONV_UPDATE:"/conversation/conversationUpdate/",CONV_LOCAL_PARTICIPANT_UPDATE:"/conversation/localParticipantUpdate/",CONV_ROSTER_UPDATE:"/conversation/rosterUpdate/",CONV_ADD_PARTICIPANT_SUCCESS:"/conversation/addParticipantSuccess/",CONV_ADD_PARTICIPANT_FAILURE:"/conversation/addParticipantFailure/",CONV_NUDGE_PARTICIPANT_SUCCESS:"/conversation/nudgeParticipantSuccess/",CONV_NUDGE_PARTICIPANT_FAILURE:"/conversation/nudgeParticipantFailure/",CONV_ADMIT_PARTICIPANT_SUCCESS:"/conversation/admitParticipantSuccess/",CONV_ADMIT_PARTICIPANT_FAILURE:"/conversation/admitParticipantFailure/",CONV_ADMIT_ALL_STATUS:"/conversation/admitAllStatus/",CONV_REMOVE_PARTICIPANT_SUCCESS:"/conversation/removeParticipantSuccess/",CONV_REMOVE_PARTICIPANT_FAILURE:"/conversation/removeParticipantFailure/",CONV_ADD_MODALITY_SUCCESS:"/conversation/addModalitySuccess/",CONV_ADD_MODALITY_FAILURE:"/conversation/addModalityFailure/",CONV_CONTENT_SHARING_UPDATE:"/conversation/contentSharingUpdate/",CONV_CONTENT_SHARING_END:"/conversation/contentSharingEnd/",CONV_BROADCAST_UPDATE:"/conversation/broadcastUpdate/",CONV_CONFIRM_UNMUTE:"/conversation/confirmUnmute/",CONV_UNMUTE_SUCCESS:"/conversation/unmuteSuccess/",CONV_UNMUTE_FAILURE:"/conversation/unmuteFailure/",UPDATE_MEETING_LIVE_STATE_STATUS:"/conversation/updateMeetingLiveStateStatus/",UPDATE_MEETING_GROUPS_STATUS:"/conversation/updateMeetingGroupsStatus/",SET_MEETING_LAYOUT_STATUS:"/conversation/setMeetingLayoutStatus/",UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS:"/conversation/updateParticipantInterpretationStateStatus/",UPDATE_PARTICIPANT_PROPERTIES_STATUS:"/conversation/updateParticipantPropertiesStatus/",JOIN_MEETING_GROUP_STATUS:"/conversation/joinMeetingGroupStatus/",LEAVE_MEETING_GROUP_STATUS:"/conversation/leaveMeetingGroupStatus/",RECEIVE_MESSAGE:"/conversation/receiveMessage/",SEND_MESSAGE_STATUS:"/conversation/sendMessageStatus/",DISABLE_PREHEAT_ASYNC_STATUS:"/conversation/disablePreheatAsyncStatus/",UPDATE_MEETING_STATES_STATUS:"/conversation/updateMeetingStatesStatus/"},Vi={...xi,...Ui},Bi={CALL_NOTIFICATION:"callNotification",MEDIA_ANSWER:"mediaAnswer",MEDIA_ACKNOWLEDGEMENT:"mediaAcknowledgement",CALL_ACCEPTANCE:"callAcceptance",CALL_END:"callEnd",CALL_PROGRESS:"callProgress",CALL_ACCEPTANCE_ACKNOWLEDGEMENT:"callAcceptanceAcknowledgement",MEDIA_NEGOTIATION:"mediaNegotiation",MEDIA_NEGOTIATION_FAILURE:"mediaNegotiationFailure",BALANCE_UPDATE:"balanceUpdate",RETARGET_COMPLETED:"retargetCompleted",CALL_TRANSFER:"callTransfer",TRANSFER_COMPLETION:"transferCompletion",TRANSFER_ACCEPTANCE:"transferAcceptance",PARK_COMPLETION:"holdCompletion",UNPARK_COMPLETION:"resumeCompletion",UPDATE_MEETING_LIVE_STATE_RESPONSE:"updateMeetingLiveStateResponse",UPDATE_MEETING_GROUPS_RESPONSE:"updateMeetingGroupsResponse",SET_MEETING_LAYOUT_RESPONSE:"setMeetingLayoutResponse",UPDATE_MEETING_STATES_RESPONSE:"updateMeetingStatesResponse"},Hi=Li,$i=__toESM(R),Gi=class _HttpHeaderImpl{constructor(g){this.headers={},g&&Object.keys(g).forEach((m=>{this.headers[this.getLowerCaseName(m)]=g[m]}))}isEmpty(){return $i.isEmpty(this.headers)}set(g,m){this.headers[this.getLowerCaseName(g)]=m}get(g,m){return m?_HttpHeaderImpl.getHeaderValue(this.headers,g)||m:_HttpHeaderImpl.getHeaderValue(this.headers,g)}delete(g){delete this.headers[g],delete this.headers[g.toLowerCase()]}hasOwnPropertyCaseInsensitive(g){return Object.keys(this.headers).filter((function(m){return m.toUpperCase()===g.toUpperCase()})).length>0}getAll(){return this.headers}getLowerCaseName(g){return _HttpHeaderImpl.useLowerCaseHeaders?g.toLowerCase():g}static getHeaderValue(g,m){return g.hasOwnProperty(m)?g[m]:g.hasOwnProperty(m.toLowerCase())?g[m.toLowerCase()]:void 0}};function get(g,m,f=causeId2()){return assertNotNullOrEmpty(m,"trailingPath cannot be null"),assertNotNull(g,"signalingSession cannot be null"),assertNotNull(g.baseMessagingChannelUrl,"messaging channel url is not set"),`${g.baseMessagingChannelUrl}${Hi.URL_BASE.CALLAGENT}/${g.sessionId}/${f}${m}`}function getIdFromUrl(g){const m=g.match(new RegExp(`/${escapeRegExp(Hi.URL_BASE.CALLAGENT)}/+([^/]+)`,"i"));return m?m[1]:null}function clientSupportedTokenTypes(g){let m=1;return g.callingServiceSupportsAADTokens&&(m|=4),g.callingServiceSupportsCAETokens&&(m|=8),m}function parseServiceTokenTypes(g){const m=g.toLowerCase(),f='token_types="',S=m.indexOf(f);if(-1===S)return[];const v=m.indexOf('"',S+f.length);if(-1===v)return[];const C=m.substring(S+f.length,v).trim();if(""===C)return[];return C.split(" ")}function is1to1Mri(g){return!!g.match(/^8:/)}function stripMri(g){return g.replace(/^\d+:/,"")}function causeId2(){return newGuid().substr(0,8)}function newMessageId(g){return g&&/^[a-z0-9]{8}$/.test(g)?g+newGuid().substr(8):newGuid()}function newGuid(){const g="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx",m="0123456789abcdef";let f="",S=0,v=0;for(;v<36;){const C=g[v];switch(S=v%8==0?4294967295*Math.random()|0:S>>4,C){case"x":f+=m[15&S];break;case"y":f+=m[3&S|8];break;case"4":case"-":f+=C}v++}return f}function assert2(g,m){if(!g)throw new Error("Assert failed"+(void 0!==m?`:${m}`:""))}function assertNotNullOrEmpty(g,m){if(!g||g instanceof String&&""===g||g instanceof Array&&0===g.length)throw new Error("AssertNotNullOrEmpty failed. "+(void 0!==m?`: ${m}`:""))}function assertNotNull(g,m){if(!g)throw new Error("AssertNotNull failed. "+(void 0!==m?`: ${m}`:""))}function assertCallEndReason(g){if(assertNotNullOrEmpty(g,"callEndReason cannot be null or empty"),void 0===g.code||void 0===g.subCode||void 0===g.phrase||g.code<0||g.subCode<0||" "===g.phrase)throw new Error(`callEndReason must specify code, subCode and phrase. Invalid reason : ${getPrintableObject(g)}`)}function getMediaTypes(g){assertNotNull(g,"MediaTypes passed cannot be null");const m=[],f=Hi.MEDIA_TYPES;for(const S of Object.keys(f))arrayContains(g,f[S])&&m.push(f[S]);return m}function getLinksPayload(g,m){const f={};for(const S of Object.values(m)){const m=S.split("/");f[m[m.length-2]]=get(g,S)}return f}function stringEndsWith(g,m){return g.length>=m.length&&g.indexOf(m,g.length-m.length)>-1}function arrayContains(g,m){const f=m.toString().toLowerCase();return g.map((g=>g.toString().toLowerCase())).indexOf(f)>-1}function tryAddNewKeyToHashTable(g,m,f){return!g.hasOwnProperty(m)&&(g[m]=f,!0)}function tryRemoveKeyFromHashTable(g,m){return!!g.hasOwnProperty(m)&&(delete g[m],!0)}function escapeRegExp(g){return g.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function tryParse(g){let m=null;try{return m=JSON.parse(g),"object"==typeof m?m:null}catch(g){return null}}function getErrorForXHRFailure(g,m){if(!g)return{telemetryEndSubCode:Hi.CALL_END_CODE.UNKNOWN_ERROR,error:Hi.CALL_END_UNKNOWN_ERROR};let f;if("object"==typeof g.response)f=g.response;else try{f=JSON.parse(g.response)}catch(g){}if(g.skypeTokenError)return{telemetryEndSubCode:Hi.CALL_END_CODE.SKYPE_TOKEN_ERROR,error:Hi.CALL_END_SKYPE_TOKEN_ERROR};if(g.tokenError)return{telemetryEndSubCode:Hi.CALL_END_CODE.HTTP_OTHER_ERROR,error:Hi.CALL_END_TOKEN_ERROR};if(f&&(f.operationFailure||f.broadcastOperationFailure)){const g=f.operationFailure||f.broadcastOperationFailure;return{telemetryEndSubCode:g.code,error:g}}return f&&f.code?{telemetryEndSubCode:f.code,error:f}:isNaN(g.status)||g.status!==Hi.CALL_END_CODE.NOT_FOUND?!isNaN(g.status)&&g.status?{telemetryEndSubCode:g.status,error:{code:g.status,subCode:isNaN(g.response)?0:g.response,phrase:g.statusText,resultCategories:[ki.UnexpectedClientError]}}:!isNaN(g.response)&&g.response?{telemetryEndSubCode:0,error:{code:0,subCode:g.response,phrase:g.statusText,resultCategories:[ki.UnexpectedClientError]}}:{telemetryEndSubCode:Hi.CALL_END_CODE.NETWORK_ERROR,error:Hi.CALL_END_NETWORK_ERROR}:{telemetryEndSubCode:Hi.CALL_END_CODE.NOT_FOUND,error:Hi.RESOURCE_NOT_FOUND_ERROR}}function isDuplicateMessage(g,m){if(g&&!g.isEmpty()&&m){const f=g.get(Hi.HEADERS.ORIGINAL_MESSAGE_ID),S=g.get(Hi.HEADERS.MESSAGE_ID);if(S&&arrayContains(m,S)||f&&arrayContains(m,f))return!0;m.length>9&&m.shift(),m.push(f||S)}return!1}function extractMessageIdFromMessage(g){const m="unknown";return g.headers?g.headers.get(Hi.HEADERS.ORIGINAL_MESSAGE_ID,m):m}function extractCauseIdFromMessage(g){try{return g.headers.get(Hi.HEADERS.ORIGINAL_MESSAGE_ID).replace("-","").substr(0,8)}catch(g){return causeId2()}}function cacheMessageResult(g,m,f){if(g&&m){const S=g.get(Hi.HEADERS.ORIGINAL_MESSAGE_ID)||g.get(Hi.HEADERS.MESSAGE_ID)||null;S&&(m[S]=f)}}function getMessageResultFromCache(g,m){if(g){return m[g.get(Hi.HEADERS.ORIGINAL_MESSAGE_ID)||g.get(Hi.HEADERS.MESSAGE_ID)||null]||null}return null}function isEncodedMessage(g){return g&&g.hasOwnPropertyCaseInsensitive(Hi.HEADERS.CONTENT_ENCODING)}function isMessageEncodingSupported(g){return g&&Hi.KNOWN_PAYLOAD_ENCODINGS.hasOwnProperty(g.get(Hi.HEADERS.CONTENT_ENCODING).toUpperCase())}function parseRawHttpMessage(g){const m=g.split(/\r?\n\r?\n/),f=m[0].split(/\r?\n/),S=m[1].split(/\r?\n/),v=f.shift().split(" "),C=v[0],_=v[1]||"",E=new Gi;for(const g of f)try{const[m,f]=g.split(":").map((g=>Oi.trim(g)));E.set(m,f)}catch(m){throw new Error(`Malformed header: ${g+m}`)}return{url:_,headers:E,method:C,body:S.join("")}}function decodeMessage(g){const m=atob(g);return Ni.inflate(m,{to:"string"})}function defer2(){let g,m,f=!0;return{isPending:()=>f,promise:new Promise(((f,S)=>{g=f,m=S})),resolve:m=>{f&&(g(m),f=!1)},reject:g=>{f&&(m(g),f=!1)}}}function isTrouterAndNavigatorConnected(g){let m=!1;try{if(m=g&&2===g.state(),navigator.onLine&&m)return 3;if(!navigator.onLine&&m)return 2;if(navigator.onLine&&!m)return 1}catch{}return 0}function isRetryable(g){return[Hi.HTTP_STATUS_CODES.UNKNOWN,Hi.HTTP_STATUS_CODES.UNAUTHORIZED,Hi.HTTP_STATUS_CODES.NETWORK_ERROR,Hi.HTTP_STATUS_CODES.OFFLINE,Hi.HTTP_STATUS_CODES.TIMEOUT,Hi.HTTP_STATUS_CODES.INTERNAL_SERVER_ERROR,Hi.HTTP_STATUS_CODES.BAD_GATEWAY,Hi.HTTP_STATUS_CODES.SERVICE_UNAVAILABLE,Hi.HTTP_STATUS_CODES.GATEWAY_TIMEOUT].indexOf(g)>=0}function convertStringToTokenType(g,m){switch(g){case Hi.HEADERS.CAE_KEYWORD.toLowerCase():return 8;case Hi.HEADERS.AAD_KEYWORD.toLowerCase():return 4;case Hi.HEADERS.SKYPE_KEYWORD.toLowerCase():return 1;default:return m?.info("unexpected: unrecognized token type ${tokenType}"),null}}function getAuthHeadersTokenTypes(g,m,f,S,v){if(!m)return 1;const{callingServiceSupportsAADTokens:C,callingServiceSupportsCAETokens:_,supportMissingTokenTypesInResponse:E,useSkypeTokenWhenNoAuthenticateHeader:T}=g,I=v?.authenticationHeaders;S?.info(`[getAuthHeadersTokenTypes] UnauthorizedResponse=${f} and authHeaders=${I}`);let b=null;if(!I&&f)T?(S?.info("[getAuthHeadersTokenTypes] no www-authenticate header received, fallback to skype token"),b=1):(S?.info("[getAuthHeadersTokenTypes] Service has not provided www-authenticate headers. use client supported tokens"),b=clientSupportedTokenTypes(g));else if(I||f){if(I&&f)for(const m of I){const f=parseServiceTokenTypes(m);if(E&&0===f.length)S?.info("[getAuthHeadersTokenTypes] Service has www-authenticate header, but no token types. Use client supported tokens"),b=clientSupportedTokenTypes(g);else for(const g of f){const m=convertStringToTokenType(g.toLowerCase(),S);_&&8===m&&(b|=8),C&&4===m&&(b|=4),1===m&&(b|=1)}}}else S?.info("[getAuthHeadersTokenTypes] first time requesting token, request client supported token types"),b=clientSupportedTokenTypes(g);return b}function getRequestTypeAsString(g){switch(g){case 0:return"GET";case 1:return"POST";case 2:return"PUT";case 3:return"DELETE"}}function extractWwwauthenticateHeaders(g){let m={};if(g){const f=Gi.getHeaderValue(g,Hi.HEADERS.AUTHENTICATE);f&&(m={authenticationHeaders:[f]})}return m}function getTokenMetadata(g,m,f,S,v=!1,C,_){_?.createChild("[utils.ts]");const E={verb:getRequestTypeAsString(f),path:S.url},T=JSON.stringify(E),I=extractWwwauthenticateHeaders(C),b=getAuthHeadersTokenTypes(g,m,v,_,I);return _?.info(`[getTokenMetadata] return token type=${b}, factoJson=${T}, headers=${I?.authenticationHeaders}`),{tokenType:b,factorsJson:T,requestMetadataJson:I,isUnauthorized:v}}function epochTimeInSecRoundedDown(){return Math.floor(Date.now()/1e3)}function millieSecondsToSeconds(g){return g/1e3}function secondsToMillieSeconds(g){return 1e3*g}function getRequestToken(g){const m=Gi.getHeaderValue(g,Hi.HEADERS.SKYPE_TOKEN);if(m)return m;const f=Gi.getHeaderValue(g,Hi.HEADERS.AUTHORIZATION);if(f){const g=f.split(" ");if(2===g.length)return g[1]}}function getParkTypeName(g){switch(g){case"none":return"None";case"teamPark":return"TeamPark";case"callPark":return"CallParkV2";case"serverHold":return"ServerHold";case"serverHoldV2":return"MusicOnHoldV2";case"sharedLinePark":return"SharedLinePark";case"sharedLineParkV2":return"SharedLineAppearanceV2";default:return"UnknownType"}}function getPluginlessStateTypeFromWire(g){switch(g){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishType to PublishStateType."}}function getPluginlessStateType(g){switch(g){case"raiseHands":return"raiseHands";case"ufd":return"ufd";case"attendeeModalitiesUnrestricted":return"attendeeModalitiesUnrestricted";case"attendeeAudioRestricted":return"attendeeAudioRestricted";case"attendeeVideoRestricted":return"attendeeVideoRestricted";case"attendeeVideoUnrestricted":return"attendeeVideoUnrestricted";case"spotlight":return"spotlight";case"weatherPerson":return"weatherPerson";case"sharingLayoutType":return"sharingLayoutType";case"manageBreakoutRooms":return"manageBreakoutRooms";case"togetherMode":return"togetherMode";case"consentToRecording":return"consentToRecording";case"denyConsentToRecording":return"denyConsentToRecording";case"clientMediaUfd":return"clientMediaUfd";case"serverMediaUfd":return"serverMediaUfd";default:throw"Invalid state type when converting PublishStateType to PublishType."}}var ji=class _Participant{static isInLobby(g,m){for(const f of g)if(f.endpointId===m&&f.isLobby)return!0;return!1}static isParticipantServerMuted(g){for(const m of g)if(m.mediaStreams&&!m.mappedTo)for(const g of m.mediaStreams)if("audio"===g.type&&!0===g.serverMuted)return!0;return!1}static fromWireParticipant(g){return assertNotNull(g,"invalid wireParticipant"),assertNotNullOrEmpty(g.id,"participant must have valid Id"),new _Participant({id:g.id,displayName:g.displayName,languageId:g.languageId,acceptedBy:g.acceptedBy})}static getPluginlessStateTypeFromWire(g){return getPluginlessStateTypeFromWire(g)}static findOrCreateTypeState(g,m){let f=m.typeStates.findIndex((m=>m.type===g));if(-1===f){const S={participantStates:[],type:g};m.typeStates.push(S),f=m.typeStates.length-1}return f}static processPublishedStates(g,m){const f={typeStates:[]};f.typeStates=[];const S=g;return Di.forEach(S,(g=>{const S=this.findOrCreateTypeState(this.getPluginlessStateTypeFromWire(g.stateType),f),v={id:m,publishedState:{content:g.content,stateId:g.stateId,typeRank:g.typeRank}};f.typeStates[S].participantStates.push(v)})),f}static fromRosterEndpoints(g){let m=[],f=!1,S=!1,v=!1,C=!1;return m=Object.keys(g).map((m=>{let _,E,T=[],I=!1,b=0;if(g[m].call&&(f=!0,T=g[m].call.mediaStreams||null,b=g[m].call.serverMuteVersion||0,E=g[m].call.appliedInteractivityLevel||"unknown"),g[m].lobby&&(I=!0,S=!0,T=g[m].lobby.mediaStreams||null),g[m].broadcast?.sessionInformation&&(_=g[m].broadcast.sessionInformation.role||null),g[m].mappedParticipant&&(v=!0,T=g[m].mappedParticipant.mediaStreams||null),!g[m].capabilities&&g[m].endpointCapabilities){const f=g[m].endpointCapabilities;g[m].capabilities={implicitCallback:16&f?"enabled":"disabled",cloudAudioVideoConference:1&f?"enabled":"disabled",cloudScreenSharing:2&f?"enabled":"disabled",hostlessConference:4&f?"enabled":"disabled",autoJoinOnConflict:32&f?"enabled":"disabled",serverMuteUnmute:64&f?"enabled":"disabled",supportsCompressedServicePayload:128&f?"enabled":"disabled",cloudMerge:8&f?"enabled":"disabled"}}return C=C||!!g[m].streamLobby||!!g[m].stream,{endpointId:m,participantId:g[m].participantId||null,clientVersion:g[m].clientVersion||null,endpointMetadata:g[m].endpointMetadata||null,originalId:g[m].originalId||null,contentSharing:g[m].contentSharing||null,capabilities:g[m].capabilities||null,endpointType:g[m].endpointType||"default",deviceType:g[m].deviceType||void 0,clientEndpointCapabilities:g[m].clientEndpointCapabilities||void 0,mediaStreams:T,serverMuteVersion:b,broadcastMeetingRole:_,isLobby:I,endpointState:g[m].endpointState||null,publishedStates:g[m].publishedStates||null,callLinks:g[m].callLinks||null,appliedInteractivityLevel:E||"unknown",mappedTo:g[m].mappedTo||null,meetingGroupDetails:g[m].meetingGroupDetails,streamInformation:g[m].streamInformation,propertyBag:g[m].propertyBag,streamLobby:g[m].streamLobby,stream:g[m].stream}})),{endpointDetails:m,participantHasCallModality:f,participantIsInLobby:S,participantHasMappedEndpoint:v,participantHasStreamEndpoint:C}}static fromRoster(g,m=!1){assertNotNull(g,`invalid rosterParticipant ${JSON.stringify(g)}`),assertNotNullOrEmpty(g.details.id,"participant must have valid Id");const f=g.endpoints||{},S=this.fromRosterEndpoints(f),v=S.endpointDetails,C=S.participantHasCallModality,_=S.participantHasMappedEndpoint,E=S.participantHasStreamEndpoint;let T=S.participantIsInLobby;return C||T||_||m||E?(C&&(T=!1),new _Participant({id:g.details.id,displayName:g.details.displayName,version:g.version||0,propertyBag:g.details.propertyBag||null,languageId:g.details.languageId,role:g.role||"",tenantId:g.details.tenantId||"",endpointDetails:v||[],acceptedBy:g.acceptedBy||"",isLobby:T,meetingRole:g.meetingRole,advancedMeetingRole:g.advancedMeetingRole,participantType:g.details.participantType,publishedStates:g.publishedStates||null,isIdentityMasked:g.details.isIdentityMasked,nonMaskedId:g.details.nonMaskedId||"",nonMaskedObjectId:g.details.nonMaskedObjectId||"",nonMaskedDisplayName:g.details.nonMaskedDisplayName||"",maskedIdSeqNumber:g.details.maskedIdSeqNumber||0,maskedId:g.details.maskedId||""})):null}static fromRosterSearchResults(g){assertNotNull(g,`invalid rosterParticipant ${JSON.stringify(g)}`),assertNotNullOrEmpty(g.details.id,"participant must have valid Id");const m=g.endpoints,f=this.fromRosterEndpoints(m),S=f.endpointDetails,v=f.participantHasCallModality,C=f.participantIsInLobby,_=f.participantHasMappedEndpoint;let E=0;return v?E=3:C?E=10:_&&(E=3),{id:g.details.id,state:E,tenantId:g.details.tenantId||"",displayName:g.details.displayName,role:g.role||"",meetingRole:g.meetingRole,advancedMeetingRole:g.advancedMeetingRole,participantType:g.details.participantType,isServerMuted:this.isParticipantServerMuted(S),publishedStates:this.processPublishedStates(g.publishedStates,g.details.id),endpoints:S||[],isIdentityMasked:g.details.isIdentityMasked,nonMaskedId:g.details.nonMaskedId||"",nonMaskedDisplayName:g.details.nonMaskedDisplayName||"",nonMaskedObjectId:g.details.nonMaskedObjectId||"",maskedIdSeqNumber:g.details.maskedIdSeqNumber||0,maskedId:g.details.maskedId||""}}constructor(g){this.id=g.id,this.displayName=g.displayName||"",this.version=g.version,this.propertyBag=g.propertyBag,this.languageId=g.languageId||null,this.endpointDetails=g.endpointDetails||[],this.acceptedBy=g.acceptedBy,this.role=g.role,this.tenantId=g.tenantId,this.isLobby=g.isLobby,this.meetingRole=g.meetingRole,this.advancedMeetingRole=g.advancedMeetingRole,this.participantType=g.participantType,this.publishedStates=g.publishedStates,this.isIdentityMasked=g.isIdentityMasked,this.nonMaskedId=g.nonMaskedId,this.nonMaskedDisplayName=g.nonMaskedDisplayName,this.nonMaskedObjectId=g.nonMaskedObjectId,this.maskedIdSeqNumber=g.maskedIdSeqNumber,this.maskedId=g.maskedId}},Wi={HANDLE_MEDIA_ACKNOWLEDGEMENT:"HandleMediaAcknowledgement",HANDLE_MEDIA_NEGOTIATION_FAILURE:"HandleMediaNegotiationFailure",HANDLE_MEDIA_ANSWER:"HandleMediaAnswer",HANDLE_MEDIA_ANSWER_FAILED:"HandleMediaAnswerFailed",HANDLE_MEDIA_OFFER:"HandleMediaOffer",REJECT_RENEGOTIATION:"RejectRenegotiation",HANDLE_RETARGET_COMPLETED:"HandleRetargetCompleted",HANDLE_MEDIA_ANSWER_TIMEOUT:"HandleMediaAnswerTimeout",HANDLE_MEDIA_ACKNOWLEDGEMENT_TIMEOUT:"HandleMediaAcknowledgementTimeout",ACCEPT_RENEGOTIATION:"AcceptRenegotiation",START_RENEGOTIATION:"StartRenegotiation",MEDIA_FSM_STATE_CHANGED:"MediaFsmStateChanged",ADD_MODALITY_TIMEOUT:"AddModalityTimeout",ADD_PARTICIPANT:"AddParticipant",ADD_PARTICIPANT_TIMEOUT:"AddParticipantTimeout",ADD_PARTICIPANT_WITH_REPLACES:"AddParticipantWithReplaces",ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT:"AddParticipantWithReplacesTimeout",ADD_PARTICIPANTS_AND_MODALITY:"AddParticipantsAndModality",ADMIT_PARTICIPANT:"AdmitParticipant",ADMIT_PARTICIPANT_TIMEOUT:"AdmitParticipantTimeout",ADMIT:"Admit",ADMIT_TIMEOUT:"AdmitTimeout",ADMIT_FAILURE:"AdmitFailure",ADMIT_SUCCESS:"AdmitSuccess",CALL_ME_BACK:"CallMeBack",CALL_ME_BACK_TIMEOUT:"CallMeBackTimeout",REMOVE_PARTICIPANT:"RemoveParticipant",REMOVE_PARTICIPANT_OTHERS:"RemoveParticipantOthers",REMOVE_PARTICIPANT_SPECIFIED:"RemoveParticipantSpecified",REMOVE_PARTICIPANT_TIMEOUT:"RemoveParticipantTimeout",HANDLE_ADD_PARTICIPANT_SUCCESS:"HandleAddParticipantSuccess",HANDLE_ADD_PARTICIPANT_FAILURE:"HandleAddParticipantFailure",HANDLE_ADMIT_PARTICIPANT_SUCCESS:"HandleAdmitParticipantSuccess",HANDLE_ADMIT_PARTICIPANT_FAILURE:"HandleAdmitParticipantFailure",HANDLE_ADD_PARTICIPANT_MODALITY_FAILURE:"HandleAddParticipantModalityFailure",HANDLE_REMOVE_PARTICIPANT_SUCCESS:"HandleRemoveParticipantSuccess",HANDLE_REMOVE_PARTICIPANT_FAILURE:"HandleRemoveParticipantFailure",HANDLE_ROSTER_UPDATE:"HandleRosterUpdate",HANDLE_ROSTER_UPDATE_FAIL:"HandleRosterUpdateFail",HANDLE_CONVERSATION_UPDATE:"HandleConversationUpdate",HANDLE_LOCAL_PARTICIPANT_UPDATE:"HandleLocalParticipantUpdate",SET_SUBJECT:"SetSubject",SET_JOINED_FROM:"SetJoinedFrom",SET_DEVICETYPE:"SetDeviceType",GET_EMERGENCY_CONTENT:"GetEmergencyContent",SET_MULTIPARTY:"SetMultiparty",SET_GROUPID:"SetGroupId",SET_THREADID:"SetThreadId",SET_CALLOPTIONS:"SetCallOptions",SET_TRANSFER_CONTEXT:"SetTransferContext",START_CALL:"StartCall",JOIN_CALL:"JoinCall",JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:"JoinConversationWithoutCallModality",HANDLE_INCOMING_CALL:"HandleIncomingCall",END_CALL:"EndCall",END_WITH_BEACON:"EndWithBeacon",CONFLICTED_CALL:"ConflictedCall",SET_PROVISIONAL_ANSWER:"SetProvisionalAnswer",SET_PROVISIONAL_ANSWER_FAILED:"SetProvisionalAnswerFailed",ACCEPT_CALL:"AcceptCall",ACCEPT_CALL_FAILED:"AcceptCallFailed",HANDLE_CALL_ACCEPTANCE_ACK:"HandleCallAcceptanceAck",HANDLE_CALL_ACCEPTANCE:"HandleCallAcceptance",HANDLE_CALL_ACCEPTANCE_SYNC:"HandleCallAcceptanceSync",HANDLE_CALL_ACCEPTANCE_FAILED:"HandleCallAcceptanceFailed",HANDLE_CALL_ESTABLISHMENT_TIMEOUT:"HandleCallEstablishmentTimeout",HANDLE_CALL_END:"HandleCallEnd",HANDLE_CALL_PROGRESS:"HandleCallProgress",TROUTER_URL_CHANGED:"TrouterUrlChanged",TROUTER_STATE_CHANGED:"TrouterStateChanged",TROUTER_URL_CHANGED_TO_INVALID:"TrouterUrlChangedToInvalid",TROUTER_URL_UPDATE_FAILED:"TrouterUrlUpdateFailed",ADD_CONTENT_SHARING_MODALITY:"AddContentSharingModality",ACCEPTED_BEFORE_RINGING:"AcceptedBeforeRinging",LEAVE_CONTENT_SHARING:"LeaveContentSharing",DELETE_CONTENT_SHARING:"DeleteContentSharing",TAKE_CONTROL_CONTENT_SHARING:"TakeControlContentSharing",UPDATE_SESSION_STATE_CONTENT_SHARING:"UpdateSessionStateContentSharing",JOIN_CONTENT_SHARING:"JoinContentSharing",UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:"UpdateParticipantStateContentSharing",HANDLE_CONTENT_SHARING_UPDATE:"HandleContentSharingUpdate",HANDLE_CONTENT_SHARING_END:"HandleContentSharingEnd",CONTENT_SHARING_START_FROM_ROSTER:"ContentSharingStartFromRoster",CONTENT_SHARING_END_FROM_ROSTER:"ContentSharingEndFromRoster",HANDLE_ADD_MODALITY_SUCCESS:"HandleAddModalitySuccess",HANDLE_ADD_MODALITY_FAILURE:"HandleAddModalityFailure",ADD_BROADCAST_MODALITY:"AddBroadcastModality",UPDATE_BROADCAST_DETAILS:"UpdateBroadcastDetails",WAITING_FOR_ADD_BROADCAST_MODALITY_COMPLETION:"WaitingForAddBroadcastModalityCompletion",MUTE:"Mute",NUDGE_PARTICIPANT_TIMEOUT:"NudgeParticipantTimeout",UNMUTE:"Unmute",UNMUTE_TIMEOUT:"UnmuteTimeout",HANDLE_UNMUTE_CONFIRM:"HandleUnmuteConfirm",HANDLE_UNMUTE_SUCCESS:"HandleUnmuteSuccess",HANDLE_UNMUTE_FAILURE:"HandleUnmuteFailure",APPROVE_UNMUTE:"ApproveUnmute",REJECT_UNMUTE:"RejectUnmute",HANDLE_CONTROL_VIDEO_STREAMING:"HandleControlVideoStreaming",HANDLE_DOMINANT_SPEAKER_CHANGED_COUNT:"HandleDominantSpeakerChangedCount",HANDLE_CSRC_INFO:"HandleCsrcInfo",SEND_WEBRTC_MEDIA_NOTIFICATION:"SendWebRtcMediaNotification",HANDLE_BALANCE_UPDATE:"HandleBalanceUpdate",TRANSFER_CALL:"TransferCall",PARK_CALL:"ParkCall",CALL_REDIRECT:"CallRedirect",CALL_REDIRECT_REQUEST_FAILED:"CallRedirectRequestFailed",TRANSFER_COMPLETION_FAILED:"TransferCompletionFailed",TRANSFER_REQUEST_RECEIVED:"TransferRequestReceived",HANDLE_PARK_REQUESTED:"HandleParkRequested",HANDLE_SERVER_HOLD:"HandleServerHold",DUPLICATE_MESSAGE_IGNORED:"DuplicateMessageIgnored",CORRELATION_ID_UPDATED:"CorrelationIdUpdated",UNKNOWN_MESSAGE_TYPE:"UnkownMessageType",FAILED_TO_HANDLE_MESSAGE:"FailedToHandleMessage",CONNECTIVITY_CHANGED:"ConnectivityChanged",TROUTER_DECODE_PAYLOAD_FAILURE:"TrouterDecodePayloadFailure",UPDATE_ENDPOINT_STATE:"UpdateEndpointState",UPDATE_ENDPOINT_STATE_SUCCESS:"UpdateEndpointStateSuccess",UPDATE_ENDPOINT_STATE_FAILURE:"UpdateEndpointStateFailure",BROKER_DECODE_PAYLOAD_FAILURE:"BrokerDecodePayloadFailure",BROKER_SUBSCRIPTION_TIMEOUT:"BrokerSubscriptionTimeout",BROKER_SUBSCRIPTION_SUCCESSFUL:"BrokerSubscriptionSuccessful",BROKER_SUBSCRIPTION_FAILED:"BrokerSubscriptionFailed",FAILED_TO_HANDLE_TROUTER_MESSAGE:"FailedToHandleTrouterMessage",FAILED_TO_HANDLE_BROKER_MESSAGE:"FailedToHandleBrokerMessage",BROKER_DISABLED_SUBSCRIBE_URL_PRESENT:"BrokerDisabledSubscribeUrlPresent",CONNECTED:"Connected",IN_LOBBY:"InLobby",STAGING:"Staging",MESSAGE_MISSING_BODY:"MessageMissingBody",BROADCAST_STATE_CHANGED:"BroadcastStateChanged",HANDLE_CALL_NOTIFICATION:"HandleCallNotification",HANDLE_INCOMING_CALL_REPLACEMENT:"HandleIncomingCallReplacement",HANDLE_PSTN_BALANCE_UPDATE:"HandlePstnBalanceUpdate",IGNORE_OLD_ROSTER:"IgnoreOldRoster",HANDLE_MEDIA_ACK:"HandleMediaAck",HANDLE_MEDIA_PROVISIONAL_ACK:"HandleMediaProvisionalAck",UPDATE_CALL_STATUS:"UpdateCallStatus",SEND_ATTACH:"SendAttach",REQUEST_NEW_OFFER:"RequestNewOffer",HANDLE_NEW_OFFER:"HandleNewOffer",UPDATE_CONVERSATION_LINKS:"UpdateConversationLinks",UPDATE_CONVERSATION_LINKS_SUCCESS:"UpdateConversationLinksSuccess",UPDATE_CONVERSATION_LINKS_FAILED:"UpdateConversationLinksFailed",PROCESS_INITIAL_OFFER:"ProcessInitialOffer",SEND_PROGRESS:"SendProgress",SEND_PROGRESS_FAILED:"SendProgressFailed",PROCESS_CALL_ACCEPTANCE:"ProcessCallAcceptance",ACCEPTANCE_USER_IN_LOBBY:"AcceptanceUserInLobby",REJECT_INCOMING_CALL:"RejectIncomingCall",SEND_KEEP_ALIVE:"SendKeepAlive",SEND_KEEP_ALIVE_FAILED:"SendKeepAliveFailed",SEND_CONVERSATION_KEEP_ALIVE_FAILED:"SendConversationKeepAliveFailed",START_AUDIO:"StartAudio",STOP_AUDIO:"StopAudio",UPDATE_MEETING_ROLE:"UpdateMeetingRole",UPDATE_MEETING_ROLE_TIMEOUT:"UpdateMeetingRoleTimeout",PREHEAT_ENABLING:"EnablingPreheat",PREHEAT_DISABLING:"DisablingPreheat",PREHEAT_DISABLED:"PreheatDisabled",TRANSFER_REQUEST_SENT:"TransferRequestSent",CALL_REDIRECT_REQUEST_SENT:"CallRedirectRequestSent",TRANSFER_REQUEST_FAILED:"TransferRequestFailed",SEND_ACCEPT_TRANSFER:"SendAcceptTransfer",SEND_ACCEPT_TRANSFER_FAIL:"SendAcceptTransferFail",WAITING_FOR_TRANSFER_COMPLETION:"WaitingForTransferCompletion",WAITING_FOR_TRANSFER_COMPLETION_FAIL:"WaitingForTransferCompletionFail",WAITING_FOR_TRANSFER_ACCEPTANCE_FAIL:"WaitingForTransferAcceptanceFail",WAITING_FOR_TRANSFER_ACCEPTANCE:"WaitingForTransferAcceptance",TRANSFER_COMPLETED:"TransferCompleted",SEND_COMPLETE_TRANSFER:"SendCompleteTransfer",SEND_COMPLETE_TRANSFER_FAILED:"SendCompleteTransferFailed",PICKUP_CODE_SET:"PickupCodeSet",ADD_PARTICIPANT_WITH_PICKUP_CODE:"AddParticipantWithPickupCode",ADD_PARTICIPANT_WITH_PICKUP_CODE_TIMEOUT:"AddParticipantWithPickupCodeTimeout",PUBLISH_STATE:"PublishState",PUBLISH_STATE_FAILURE:"PublishStateFailure",REMOVE_STATE:"RemoveState",REMOVE_STATE_FAILURE:"RemoveStateFailure",UPDATE_MEETING_SETTINGS:"UpdateMeetingSettings",UPDATE_MEETING_SETTINGS_FAILURE:"UpdateMeetingSettingsFailure",UPDATE_ENDPOINT_METADATA_SUCCESS:"UpdateEndpointMetadataSuccess",UPDATE_ENDPOINT_METADATA_FAILURE:"UpdateEndpointMetadataFailure",SEARCH_PARTICIPANTS:"SearchParticipants",GET_ALL_PARTICIPANTS:"GetAllParticipants",SEARCH_PARTICIPANTS_FAILURE:"SearchParticipantsFailure",GET_ALL_PARTICIPANTS_FAILURE:"GetAllParticipantsFailure",PARK_REQUEST:"SendParkRequest",PARK_REQUEST_FAILED:"ParkRequestFailed",WAITING_FOR_PARK_COMPLETION:"WaitingForParkCompletion",WAITING_FOR_PARK_COMPLETION_TIMEOUT:"WaitingForParkCompletionTimeout",PARK_COMPLETED:"ParkCompleted",PARK_FAILED:"ParkFailed",SEND_UNPARK_REQUEST:"SendUnparkRequest",UNPARK_REQUEST_FAILED:"UnparkRequestFailed",WAITING_FOR_UNPARK_COMPLETION:"WaitingForUnparkCompletion",WAITING_FOR_UNPARK_COMPLETION_TIMEOUT:"WaitingForUnparkCompletionTimeout",UNPARK_COMPLETED:"UnparkCompleted",UNPARK_FAILED:"UnparkFailed",UPDATE_MEETING_LIVE_STATE:"UpdateMeetingLiveState",WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION:"WaitingForUpdateMeetingLiveStateCompletion",UPDATE_MEETING_LIVE_STATE_REQUEST_FAILED:"UpdateMeetingLiveStateRequestFailed",UPDATE_MEETING_LIVE_STATE_RESPONSE_FAILURE:"UpdateMeetingLiveStateResponseFailure",UPDATE_MEETING_LIVE_STATE_RESPONSE_SUCCESS:"UpdateMeetingLiveStateResponseSuccess",UPDATE_MEETING_GROUPS:"UpdateMeetingGroups",UPDATE_PARTICIPANT_INTERPRETATION_STATE:"UpdateParticipantInterpretationState",UPDATE_PARTICIPANTS_PROPERTIES:"UpdateParticipantsProperties",JOIN_MEETING_GROUP:"JoinMeetingGroup",LEAVE_MEETING_GROUP:"LeaveMeetingGroup",INCOMING_PROXIED_MESSAGES:"incomingProxiedMessages",WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION:"WaitingForUpdateMeetingGroupsCompletion",UPDATE_MEETING_GROUPS_REQUEST_FAILED:"UpdateMeetingGroupsRequestFailed",UPDATE_MEETING_GROUPS_REQUEST_COMPLETED:"UpdateMeetingGroupsRequestCompleted",UPDATE_MEETING_GROUPS_RESPONSE_FAILURE:"UpdateMeetingGroupsRequestFailure",UPDATE_MEETING_GROUPS_RESPONSE_SUCCESS:"UpdateMeetingGroupsResponseSuccess",SET_MEETING_LAYOUT:"SetMeetingLayout",WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION:"WaitingForSetMeetingLayoutCompletion",SET_MEETING_LAYOUT_REQUEST_FAILED:"SetMeetingLayoutRequestFailed",SET_MEETING_LAYOUT_RESPONSE_FAILURE:"SetMeetingLayoutResponseFailure",SET_MEETING_LAYOUT_RESPONSE_SUCCESS:"SetMeetingLayoutResponseSuccess",WAITING_FOR_UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION:"WaitingForUpdateParticipantInterpretationStateCompletion",UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT:"UpdateParticipantInterpretationStateTimeout",UPDATE_PARTICIPANT_INTERPRETATION_STATE_REQUEST_FAILED:"UpdateParticipantInterpretationStateRequestFailed",UPDATE_PARTICIPANT_INTERPRETATION_STATE_REQUEST_COMPLETED:"UpdateParticipantInterpretationStateRequestCompleted",UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_FAILED:"UpdateParticipantInterpretationStateResponseFailed",UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_COMPLETED:"UpdateParticipantInterpretationStateResponseCompleted",WAITING_FOR_UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION:"WaitingForUpdateParticipantsPropertiesCompletion",UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT:"UpdateParticipantsPropertiesTimeout",UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED:"UpdateParticipantsPropertiesResponseFailed",UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_COMPLETED:"UpdateParticipantsPropertiesResponseCompleted",WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION:"WaitingForJoinMeetingGroupCompletion",JOIN_MEETING_GROUP_REQUEST_FAILED:"JoinMeetingGroupRequestFailed",JOIN_MEETING_GROUP_REQUEST_COMPLETED:"JoinMeetingGroupRequestCompleted",JOIN_MEETING_GROUP_RESPONSE_FAILED:"JoinMeetingGroupRequestFailed",JOIN_MEETING_GROUP_RESPONSE_COMPLETED:"JoinMeetingGroupRequestCompleted",WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION:"WaitingForLeaveMeetingGroupCompletion",LEAVE_MEETING_GROUP_REQUEST_FAILED:"LeaveMeetingGroupRequestFailed",LEAVE_MEETING_GROUP_REQUEST_COMPLETED:"LeaveMeetingGroupRequestCompleted",LEAVE_MEETING_GROUP_RESPONSE_FAILED:"LeaveMeetingGroupRequestFailed",LEAVE_MEETING_GROUP_RESPONSE_COMPLETED:"LeaveMeetingGroupRequestCompleted",SUBSCRIBE_URL_FOUND:"SubscribeUrlFound",SUBSCRIBE_URL_MISSING:"SubscribeUrlMissing",SEND_MESSAGE_COMPLETION:"SendMessageCompletion",SEND_MESSAGE_TIMEOUT:"SendMessageTimeout",DISABLE_PREHEAT_SUCCEEDED:"DiablePreheatSucceeded",ASYNC_DISABLE_PREHEAT_SUCCEEDED:"AsyncDisablePreheatSucceeded",DISABLE_PREHEAT_FAILED:"DiablePreheatFailed",ASYNC_DISABLE_PREHEAT_FAILED:"AsyncDiablePreheatFailed",ASYNC_DISABLE_PREHEAT_TIMEOUT:"AsyncDiablePreheatTimeout",DISABLE_PREHEAT_RESPONSE_RECEIVED:"DisablePreheatResponseReceived",SET_STREAM_INFORMATION_RECEIVED:"StreamInformationReceived",UPDATE_MEDIA_DESCRIPTIONS:"UpdateMediaDescriptions",UPDATE_MEDIA_DESCRIPTIONS_FAILED:"UpdateMediaDescriptionsFailed",NUDGE_TO_JOIN_REALTIME:"NudgeToJoinAsRealtime",UPDATE_MEETING_STATES:"UpdateMeetingStates",WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION:"WaitingForUpdateMeetingStatesCompletion",UPDATE_MEETING_STATES_RESPONSE_SUCCESS:"UpdateMeetingStatesResponseSuccess",UPDATE_MEETING_STATES_RESPONSE_FAILURE:"UpdateMeetingStatesResponseFailure"},qi={SEND_MEDIA_ANSWER:{name:"SendMediaAnswer",controller:0},START_RENEGOTIATION:{name:"StartRenegotiation",controller:0},SEND_MEDIA_ACKNOWLEDGEMENT:{name:"SendMediaAcknowledgement",controller:0},SEND_MEDIA_REJECTION:{name:"SendMediaRejection",controller:0},ADD_PARTICIPANT:{name:"AddParticipant",controller:1},ADD_PARTICIPANT_WITH_REPLACES:{name:"AddParticipantWithReplaces",controller:1},NUDGE_PARTICIPANT:{name:"NudgeParticipant",controller:1},REMOVE_PARTICIPANT_NONE:{name:"RemoveParticipant",controller:1},REMOVE_PARTICIPANT_OTHERS:{name:"RemoveParticipantOthers",controller:1},REMOVE_PARTICIPANT_SPECIFIED:{name:"RemoveParticipantSpecified",controller:1},ADMIT_PARTICIPANT:{name:"AdmitParticipant",controller:1},ADMIT:{name:"Admit",controller:1},BROKER_SUBSCRIBE:{name:"BrokerSubscribe",controller:2},CALL_ME_BACK:{name:"CallMeBack",controller:1},SEND_ACCEPTANCE:{name:"SendAcceptance",controller:0},SEND_ACCEPTANCE_ACKNOWLEDGEMENT:{name:"SendAcceptanceAcknowledgement",controller:0},END_CALL:{name:"EndCall",controller:1},CANCEL_CALL:{name:"CancelCall",controller:1},REJECT_CALL:{name:"RejectCall",controller:0},JOIN_CONVERSATION:{name:"JoinConversation",controller:1},JOIN_CONVERSATION_WITHOUT_CALL_MODALITY:{name:"JoinConversationWithoutCallModality",controller:1},LEAVE_CONVERSATION:{name:"LeaveConversation",controller:1},DELETE_CONVERSATION:{name:"DeleteConversation",controller:1},START_CALL:{name:"StartCall",controller:1},PLACE_NUDGE_CALL:{name:"PlaceNudgeCall",controller:5},UPDATE_CONVERSATION_LINKS:{name:"UpdateConversationLinks",controller:1},SEND_CONVERSATION_KEEP_ALIVE:{name:"SendConversationKeepAlive",controller:1},SEND_CALL_ATTACH:{name:"SendCallAttach",controller:0},SEND_CALL_PROGRESS:{name:"SendCallProgress",controller:0},SEND_KEEP_ALIVE:{name:"SendKeepAlive",controller:0},ADD_CONTENT_SHARING_MODALITY:{name:"AddContentSharingModality",controller:1},DELETE_CONTENT_SHARING:{name:"DeleteContentSharing",controller:3},TAKE_CONTROL_CONTENT_SHARING:{name:"TakeControlContentSharing",controller:3},UPDATE_SESSION_STATE_CONTENT_SHARING:{name:"UpdateSessionStateContentSharing",controller:3},JOIN_CONTENT_SHARING:{name:"JoinContentSharing",controller:3},UPDATE_PARTICIPANT_STATE_CONTENT_SHARING:{name:"UpdateParticipantStateContentSharing",controller:3},UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS:{name:"UpdateContentSharingNotificationLinks",controller:3},MUTE_ALL:{name:"MuteAll",controller:1},MUTE_ALL_SYNC:{name:"MuteAllSync",controller:1},MUTE_SPECIFIED:{name:"MuteSpecified",controller:1},MUTE_SPECIFIED_SYNC:{name:"MuteSpecifiedSync",controller:1},MUTE_MYSELF:{name:"MuteMyself",controller:1},UNMUTE:{name:"Unmute",controller:1},UNMUTE_SYNC:{name:"UnmuteMyselfSync",controller:1},SEND_CONTROL_VIDEO_STREAMING:{name:"SendControlVideoStreaming",controller:0},SEND_APPLY_CHANNEL_PARAMETERS:{name:"SendApplyChannelParameters",controller:0},APPROVE_UNMUTE:{name:"ApproveUnmute",controller:5},REJECT_UNMUTE:{name:"RejectUnmute",controller:5},SEND_CALL_REDIRECT_REQUEST:{name:"SendCallRedirectRequest",controller:0},SEND_TRANSFER_REQUEST:{name:"SendTransferRequest",controller:0},SEND_PARK_REQUEST:{name:"SendParkRequest",controller:0},SEND_SHARED_LINE_PARK_REQUEST:{name:"SharedLinePark",controller:0},SEND_SERVER_HOLD_REQUEST:{name:"ServerHoldRequest",controller:0},PARK_REQUEST:{name:"ParkRequest",controller:0},SEND_UNPARK_REQUEST:{name:"UnparkRequest",controller:0},TRANSFER_ACCEPTANCE:{name:"TransferAcceptance",controller:0},TRANSFER_COMPLETION:{name:"TransferCompletion",controller:0},TRANSFER_COMPLETION_FAILED:{name:"TransferCompletionFailed",controller:0},UPDATE_ENDPOINT_STATE:{name:"UpdateEndpointState",controller:1},DISABLE_PREHEAT:{name:"DisablePreheat",controller:5},REQUEST_NEW_OFFER:{name:"RequestNewOffer",controller:0},UPDATE_ENDPOINT_METADATA:{name:"UpdateEndpointMetadata",controller:1},UPDATE_MEETING_ROLE_ATTENDEE:{name:"UpdateMeetingRoleToAttendee",controller:1},UPDATE_MEETING_ROLE_PRESENTER:{name:"UpdateMeetingRoleToPresenter",controller:1},UPDATE_MEETING_ROLE_ORGANIZER:{name:"UpdateMeetingRoleToOrganizer",controller:1},ADD_PARTICIPANT_WITH_PICKUP_CODE:{name:"AddParticipantWithPickupCode",controller:1},PUBLISH_STATE:{name:"PublishState",controller:1},REMOVE_STATE:{name:"RemoveState",controller:1},UPDATE_MEETING_SETTINGS:{name:"UpdateMeetingSettings",controller:1},ADD_PARTICIPANTS_AND_MODALITY:{name:"AddParticipantsAndModality",controller:1},ADD_BROADCAST_MODALITY:{name:"AddBroadcastModality",controller:1},SEARCH_PARTICIPANTS:{name:"SearchParticipants",controller:1},GET_ALL_PARTICIPANTS:{name:"GetAllParticipants",controller:1},UPDATE_MEETING_LIVE_STATE:{name:"UpdateMeetingLiveState",controller:1},UPDATE_MEETING_GROUPS:{name:"UpdateMeetingGroups",controller:1},SET_MEETING_LAYOUT:{name:"SetMeetingLayout",controller:1},UPDATE_PARTICIPANT_INTERPRETATION_STATE:{name:"UpdateParticipantInterpretationState",controller:1},JOIN_MEETING_GROUP:{name:"JoinMeetingGroup",controller:1},LEAVE_MEETING_GROUP:{name:"LeaveMeetingGroup",controller:1},SEND_PROXIED_MESSAGE:{name:"SendProxiedMessage",controller:1},UPDATE_PARTICIPANTS_PROPERTIES:{name:"UpdateParticipantsProperties",controller:1},UPDATE_MEDIA_DESCRIPTIONS:{name:"UpdateMediaDescriptions",controller:0},UPDATE_MEETING_STATES:{name:"UpdateMeetingStates",controller:1}},zi={EVENT_SOURCE:{TROUTER:"Trouter",BROKER:"Broker",UDP:"UDP",LOCAL:"Local"},SOURCE:{NGC_SOURCE:"SkypeConcore"},EVENT_TYPE:{CONVERSATION_CALL_MODALITY:"skypecosi_concore_web_csa_conversation_callmodality",CONVERSATION_CONTENT_SHARING:"skypecosi_concore_web_csa_conversation_contentsharing",CONVERSATION_HTTP_REQUEST:"skypecosi_concore_web_csa_conversation_httprequest",CONVERSATION_TOKEN:"skypecosi_concore_web_csa_conversation_token"},EXTENSIONS:{DATA_VERSION:"DataVersion",DIRECTION:"Direction",CONTENT_SHARING_DIRECTION:"ContentSharingDirection",CONNECTED_DURATION_IN_MS:"ConnectedDurationInMsecs",PREHEATED_CALL_SETUP_DURATION_IN_S:"PreheatedCallSetupDurationInSeconds",CALL_CANCELATION_DURATION_IN_S:"CallCancelationDurationInSeconds",IS_PREHEATED:"IsPreheated",TIME_TO_RING_IN_MS:"TimeToRingInMsecs",CALL_TERMINATING_END:"CallTerminatingEnd",NETWORK_REQUESTS_PENDING:"NetworkRequestsPending",NETWORK_REQUESTS_COMPLETED:"NetworkRequestsCompleted",LOCAL_OPERATIONS_PERFORMED:"LocalOperationsPerformed",TROUTER_WAIT_OPERATIONS:"TrouterWaitOperations",CALL_START_TIME:"CallStartTime",CALL_END_TIME:"CallEndTime",IS_GROUP_CALL:"IsGroupCall",IS_HOSTLESS_CALL:"IsHostLessCall",IS_CAST_CALL:"IsCastCall",IS_HUDDLE_GROUP_CALL:"IsHuddleGroupCall",IS_MEETUP_CALL:"IsMeetupCall",IS_ON_BEHALF_OF_CALL:"IsOnBehalfOfCall",IS_SDP_IN_CALL_NOTIFICATION:"SdpInCallNotification",CALL_END_CODE:"Code",CALL_END_SUB_CODE:"SubCode",CALL_PHRASE:"Phrase",CALL_END_RESULT_CATEGORIES:"ResultCategories",CALL_END_CAUSE_ID:"CauseId",CONTENT_SHARING_END_CODE:"ContentSharingEndReasonServiceCode",CONTENT_SHARING_END_SUB_CODE:"ContentSharingEndReasonServiceSubCode",CONVERSATION_SERVICE_URL:"ConversationServiceUrl",CONTENT_SHARING_SERVICE_URL:"ContentSharingServiceUrl",MEETING_INFO:"MeetingInfo",JOINED_FROM:"JoinedFrom",RESULT_VALUE:"ResultValue",RESULT_DETAIL:"ResultDetail",RESULT_CAUSE_ID:"ResultCauseId",RESULT_CODE:"ResultCode",LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS:"LocalOfferAnswerGenerationTimestamps",SELF_PARTICIPANT_ROLE:"SelfParticipantRole",SCENARIO:"Scenario",CALLER_TYPE:"Caller_Type",CALLEE_TYPE:"Callee_Type",CALL_TYPE:"Call_Type",TEST_CONTEXT_ID:"Test_Context_Id",OUTGOING_MODALITIES:"Outgoing_Modalities",INCOMING_MODALITIES:"Incoming_Modalities",OFFERED_MODALITIES:"CallOfferredModalities",ANSWERED_MODALITIES:"CallAnsweredModalities",VBSS_OPERATIONS:"VBSS_Operations",CHANGING_CORRELATION_ID_NEW_ID:"ChangingCorrelationId_NewId",CHANGING_CORRELATION_ID_OLD_ID:"ChangingCorrelationId_OldId",MESSAGING_CHANNEL:"MessagingChannel",EVENT_TIMESTAMP_BAG:"EventTimestampBag",ROSTER_UPDATES_BAG:"RosterUpdatesBag",NETWORK_REQUESTS_BAG:"NetworkRequestBag",CLIENT_INFORMATION:"ClientInformation",ECS_ETAG:"EcsEtag",APPLICATION_TYPE:"ApplicationType",RING:"Ring",TENANT_ID:"TenantId",USER_HEX_CID:"UserHexCID",ACS_RESOURCE_ID:"AcsResourceId",REGION:"Region",PARTITION:"Partition",CALL_END_CLIENT_SUB_CODE:"CallEventCallEndClientSubCode",CALL_END_CLIENT_PHRASE:"CallEventCallEndClientPhrase",MEETING_CODE:"MeetingCode",MEETING_URL:"MeetingJoinUrl",BROADCAST_MEETING_ROLE:"BroadcastMeetingRole",MEETING_ROLE:"MeetingRole",ADVANCED_MEETING_ROLE:"AdvancedMeetingRole",PARTICIPANT_TYPE:"ParticipantType",AUDIO_ONLY_WATERMARK:"ClientSupportsAudioOnlyWatermark",CLIENT_SUPPORT_WATERMARK:"ClientSupportsWatermark",TARGET_APPLICATION_TYPE:"TargetApplicationType",IS_REINVITELESS:"IsReinviteless",CLIENT_TYPE:"ClientType"},MESSAGING_CHANNEL:{TROUTER:"Trouter",BROKER:"Broker"},SIGNALING_CONFIG:"JsCsaConfig",SIGNALING_CONFIG_FLAGS:{BROKER_OUTGOING_ENABLED:"BrokerOutgoingEnabled",BROKER_INCOMING_ENABLED:"BrokerIncomingEnabled",BROKER_REQUEST_BATCHING_ENABLED:"BrokerRequestBatchingEnabled",BROKER_EXCLUSIVELY_ENABLED:"BrokerExclusivelyEnabled",SUPPORTS_COMPRESSED_PAYLOAD:"SupportsCompressedPayload",SYNC_TROUTER_RESPONSE:"SyncTrouterResponse",SERVER_MUTE_UNMUTE:"serverMuteUnmute",HANDLE_OFFER_FROM_NOTIFICATION:"handleMediaOfferFromPushNotification",HANDLE_NEW_OFFER_REQUEST:"handleNewOfferRequest",SEND_PROGRESS_FROM_CC:"sendProgressFromCC",HANDLE_UNMUTE_MUTE_FROM_RESPONSE:"handleUnmuteMuteFromResponse",INTERNAL_HTTP_DISPATCHER:"internalHttpDispatcher",ENABLE_TOKEN_CACHE:"enableTokenCache",ENABLE_TOKEN_PREFETCH:"enableTokenPrefetch",REQUEST_HEDGING:"requestHedging",SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION:"supportMediaRetargetWhileIncomingRenegotiation",ENABLE_ERROR_CODE_IMPROVEMENTS_FOR_NETWORK_FAILURES:"enableErrorCodeImprovementsForNetworkFailures",ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL:"enableCallEstablishmentTimeoutsForStartJoinCall",ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API:"enableTokenCacheForGenericTokenAPI"},CONTEXT_ID:{CORRELATION_ID:"CorrelationId",SHARED_CORRELATION_ID:"SharedCorrelationId",SIGNALING_SESSION_ID:"SignalingSessionId",GROUP_ID:"GroupId",THREAD_ID:"ThreadId",TEAMS_MESSAGEID:"TeamsMessageId",TEAMS_MEETINGINFO:"TeamsMeetingInfo",ENDPOINT_ID:"EndpointId",PARTICIPANT_ID:"ParticipantId",DATA_VERSION:"DataVersion",CONTENT_SHARING_ID:"ContentSharingSessionId",CONTENT_SHARING_CORRELATION_ID:"ContentSharingCorrelationId"},CALL_TERMINATING_END:{LOCAL:"Local",REMOTE:"Remote"},RESULT_VALUE:{SUCCESS:"Success",FAILURE:"Failure"},DIRECTION:{INCOMING:"Incoming",OUTGOING:"Outgoing"},ROLE:{CALLER:"caller",CALLEE:"callee",JOIN:"join",JOIN_FOR_ROSTER_ONLY:"joinForRosterOnly",PREHEAT:"preheat"},VBSS_OPERATION:{START:"Start",STOP:"Stop",REJECTED:"Rejected",REMOTE_START:"RemoteStart",TIMEOUT:"Timeout",CALL_END:"CallEnd"},LOCAL_OFFER_ANSWER_OPERATIONS:{INITIAL_OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",INITIAL_OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",FINAL_ANSWER_PROCESSING_STARTED:"FinalAnswerProcessingStarted",FINAL_ANSWER_PROCESSING_ENDED:"FinalAnswerProcessingEnded",PROVISIONAL_ANSWER_PROCESSING_STARTED:"ProvisonalAnswerProcessingStarted",PROVISIONAL_ANSWER_PROCESSING_ENDED:"ProvisonalAnswerProcessingEnded",NEGOTIATION_COMPLETED:"NegotiationCompleted",INITIAL_OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",INITIAL_OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",FINAL_ANSWER_GENERATION_STARTED:"FinalAnswerGenerationStarted",FINAL_ANSWER_GENERATION_ENDED:"FinalAnswerGenerationEnded",PROVISIONAL_ANSWER_GENERATION_STARTED:"ProvisionalAnswerGenerationStarted",PROVISIONAL_ANSWER_GENERATION_ENDED:"ProvisionalAnswerGenerationEnded",RENEGOTIATION_OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",RENEGOTIATION_OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",RENEGOTIATION_ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",RENEGOTIATION_ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",RENEGOTIATION_OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",RENEGOTIATION_OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",RENEGOTIATION_ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",RENEGOTIATION_ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"},TROUTER_WAIT_OPERATION:{STARTED:"Started",ENDED:"Ended",FAILED:"Failed"},TOKEN_TELEMETRY_EVENT:{TOKEN_TELEMETRY:"TokenTelemetry"}};function setDefaultsForSignalingConfig(g){const m=!0,f="enabled",S=!1,v=!1,C=!0,_=!0,E=!0,T=!1,I=!1,b=!0,A=!0,P=!0,R=!0,w=!0,M=!1,D=!1,O=!1,N=!1,k=!1,L=!0,F=!1,x=!0,U=!0,V=3,B=4e3,H=!1,$=!1,G=!1,j=!1,W={conversationKeepAliveTimeoutSec:2700,promotionUnmuteTimeoutSec:1e4},q=!1,z=!1,K=!1,J=!1,Y=3600,Q=86400,X=30,Z=!1,ee=!0,te=!0,ie=60,ne="https://calling.teams.microsoft.com",re=!0,se=!1,ae=!1,oe=!1,le=!1,ce=!1,de=!1,he=0,ue=0,ge=!1,pe=!1,me=!1,fe=!1;g.cloudScreenSharingFlag="disabled"===g.cloudScreenSharingFlag?g.cloudScreenSharingFlag:f,g.isWebRtcEnabled="undefined"==typeof RTCIceGatherer,g.shouldServiceSendNGCUpgradeMessages=setDefault(g.shouldServiceSendNGCUpgradeMessages,C),g.isGVCOutgoingEnabled=setDefault(g.isGVCOutgoingEnabled,m),g.supportsCompressedServicePayload=setDefault(g.supportsCompressedServicePayload,_),g.supportsSynchronousTrouterResponse=setDefault(g.supportsSynchronousTrouterResponse,E),g.supportsHostlessGroupCalls=setDefault(g.supportsHostlessGroupCalls,b),g.doHostlessCalling=setDefault(g.doHostlessCalling,S),g.brokerExclusively=setDefault(g.brokerExclusively,M),g.brokerEnabledOutgoing=setDefault(g.brokerEnabledOutgoing,P),g.brokerEnabledIncoming=setDefault(g.brokerEnabledIncoming,R),g.brokerRequestBatching=setDefault(g.brokerRequestBatching,w),g.handleMediaOfferFromPushNotification=setDefault(g.handleMediaOfferFromPushNotification,L),g.handleNewOfferRequest=setDefault(g.handleNewOfferRequest,D),g.autoJoinOnConflict=setDefault(g.autoJoinOnConflict,A),g.endConflictedCall=setDefault(g.endConflictedCall,T),g.autoResolveConflictedCall=setDefault(g.autoResolveConflictedCall,I),g.shouldServiceSendCallEventMessages=setDefault(g.shouldServiceSendCallEventMessages,v),g.handleUnmuteMuteFromResponse=setDefault(g.handleUnmuteMuteFromResponse,F),g.forceTrouterReconnectOnNetworkOnline=setDefault(g.forceTrouterReconnectOnNetworkOnline,x),g.attemptHttpRequestWithCachedSkypetoken=setDefault(g.attemptHttpRequestWithCachedSkypetoken,U),g.useInternalHttpDispatcher=setDefault(g.useInternalHttpDispatcher,O),g.enableTokenCache=setDefault(g.enableTokenCache,N),g.enableTokenPrefetch=setDefault(g.enableTokenPrefetch,k),g.hedgeDelayMs=setDefault(g.hedgeDelayMs,B),g.hedgeMaxParallelAttempts=setDefault(g.hedgeMaxParallelAttempts,V),g.useInternalHttpDispatcher&&(g.httpRequestDispatcher=new ke(g.logger)),g.enableQuickSendAcceptanceAck=setDefault(g.enableQuickSendAcceptanceAck,H),g.supportMediaRetargetWhileIncomingRenegotiation=setDefault(g.supportMediaRetargetWhileIncomingRenegotiation,$),g.callingServiceSupportsAADTokens=setDefault(g.callingServiceSupportsAADTokens,q),g.callingServiceSupportsCAETokens=setDefault(g.callingServiceSupportsCAETokens,z),g.aadTokenExpirationTimeInSeconds=setDefault(g.aadTokenExpirationTimeInSeconds,Y),g.caeTokenExpirationTimeInSeconds=setDefault(g.caeTokenExpirationTimeInSeconds,Q),g.disableTokenMigrationHeader=setDefault(g.disableTokenMigrationHeader,K),g.enablePublishTokenTelemetry=setDefault(g.enablePublishTokenTelemetry,J),g.forceClearExpiredTokens=setDefault(g.forceClearExpiredTokens,Z),g.enableRefreshToken=setDefault(g.enableRefreshToken,ee),g.refreshTimeBeforeTokenTimeoutInSeconds=setDefault(g.refreshTimeBeforeTokenTimeoutInSeconds,X),g.enableCallEstablishmentTimeoutsForStartJoinCall=setDefault(g.enableCallEstablishmentTimeoutsForStartJoinCall,G),g.csaTimeoutConfiguration=mergeObjects(g.csaTimeoutConfiguration,W),g.reportPreviousErrorsForTimeout=setDefault(g.reportPreviousErrorsForTimeout,oe),g.callingTokenLogicalUrl=setDefault(g.callingTokenLogicalUrl,ne),g.enableAsyncDisablePreheat=setDefault(g.enableAsyncDisablePreheat,le),g.forceLowercaseHttpHeaders=setDefault(g.forceLowercaseHttpHeaders,ce),g.enableResolveScreenSharingWhenNegotiationComplete=setDefault(g.enableResolveScreenSharingWhenNegotiationComplete,de),g.maxReinvitelessMediaForVideoForWeb=setDefault(g.maxReinvitelessMediaForVideoForWeb,he),g.maxReinvitelessMediaForVBSSForWeb=setDefault(g.maxReinvitelessMediaForVBSSForWeb,ue),g.enableRefreshTokenRetry=setDefault(g.enableRefreshTokenRetry,te),g.enableRefreshTokenRetryInSeconds=setDefault(g.enableRefreshTokenRetryInSeconds,ie),g.enableConversationTypeUpdateOnCallEnd=setDefault(g.enableConversationTypeUpdateOnCallEnd,j),g.supportMissingTokenTypesInResponse=setDefault(g.supportMissingTokenTypesInResponse,re),g.useSkypeTokenWhenNoAuthenticateHeader=setDefault(g.useSkypeTokenWhenNoAuthenticateHeader,se),g.enableAutoPromotion=setDefault(g.enableAutoPromotion,ge),g.enableBatchedSendMessageStatus=setDefault(g.enableBatchedSendMessageStatus,me),g.enableBatchedReceiveMessage=setDefault(g.enableBatchedReceiveMessage,pe),g.enableAddParticipantEnhancements=setDefault(g.enableAddParticipantEnhancements,fe),g.enableTokenCacheForGenericTokenAPI=setDefault(g.enableTokenCacheForGenericTokenAPI,ae)}function setDefault(g,m){return null==g?m:g}function mergeObjects(g,m){return(m||g)&&{...m,...g}}var Ki=class{constructor(){this.skypeTokenContext={},this.aadTokenContext={},this.caeTokenContext={}}getTokenContext(g){return 4===g?this.aadTokenContext:8===g?this.caeTokenContext:1===g?this.skypeTokenContext:void 0}getTokenExpiry(g,m){return 4===g?this.aadTokenContext?.expiryTime:8===g?this.caeTokenContext?.expiryTime:1===g?this.skypeTokenContext?.expiryTime:(m.info("[getTokenExpiry] unrecognized token type, return Number.MAX_VALUE"),Number.MAX_VALUE)}getToken(g,m,f,S){return 8&g&&this.caeTokenContext?.token&&this.caeTokenContext.token!==S?{token:this.caeTokenContext.token,tokenType:8}:4&g&&this.aadTokenContext?.token&&this.aadTokenContext.token!==S?{token:this.aadTokenContext.token,tokenType:4}:1&g&&this.skypeTokenContext?.token&&this.skypeTokenContext.token!==S?{token:this.skypeTokenContext.token,tokenType:1}:(f.info("[getToken] no cached token found of token type: ${tokenType}"),null)}setToken(g,m,f,S){switch(g){case 4:this.aadTokenContext.factorsJson=f,this.aadTokenContext.tokenType=g,this.aadTokenContext.token=m,this.aadTokenContext.expiryTime=S;break;case 1:this.skypeTokenContext.factorsJson=f,this.skypeTokenContext.tokenType=g,this.skypeTokenContext.token=m,this.skypeTokenContext.expiryTime=S;break;case 8:this.caeTokenContext.factorsJson=f,this.caeTokenContext.tokenType=g,this.caeTokenContext.token=m,this.caeTokenContext.expiryTime=S;break;default:throw new Error(`Invalid tokenType ${g}`)}}clearExpiredTokens(g){const m=Math.round(Date.now()/1e3);this.caeTokenContext?.expiryTime<=m&&(this.resetToken(8),g?.info("[cacheTokenManager] reset expired cae token")),this.aadTokenContext?.expiryTime<=m&&(this.resetToken(4),g?.info("[cacheTokenManager] reset expired aad token")),this.skypeTokenContext?.expiryTime<=m&&(this.resetToken(1),g?.info("[cacheTokenManager] reset expired skype token"))}resetToken(g){8===g?this.caeTokenContext={}:4===g?this.aadTokenContext={}:1===g&&(this.skypeTokenContext={})}},Ji=class{constructor(g){this.timers={},this.startTimer=(g,m,f,S)=>{this.logger.info(`startTimer called for :  ${g}`);const v=window.setTimeout(m,1e3*f),C=S?`${g}${S}`:g;this.timers[C]=v},this.stopTimer=(g,m)=>{this.logger.info(`stopTimer called for : ${g}`);const f=m?`${g}${m}`:g;this.timers.hasOwnProperty(f)&&(clearTimeout(this.timers[f]),delete this.timers[f])},this.dispose=()=>{this.logger.info("timeoutManager :: dispose"),Object.keys(this.timers).forEach((g=>{this.stopTimer(g)}))},this.logger=g}},Yi=3600,Qi=class{constructor(g,m,f,S){this.tokenProvider=m,this.tokenCachingEnabled=!1,this.enableTokenCacheForGenericTokenAPI=!1,this.cachedToken="",this.lastTokenType=1,this.lastToken="",this.clientSupportsGenericTokenAPI=!1,this.stopTimerFlag=!1,this.tokensPromiseMap={},this.logger=g.createChild("TokenManager"),f&&this.updateTokenSettings(f),this.cacheTimers=new Ji(g),this.cacheTokenManager=new Ki,this.telemetryManager=S,this.nextRefreshTimePointInSeconds=Number.MAX_VALUE}deletePromisesByTriggeredByRefresh(g,m){if(this.tokensPromiseMap[g]){const f=this.tokensPromiseMap[g];for(let S=f.length-1;S>=0;S--)f[S]?.tokenRequestOptions.triggeredByRefresh===m&&this.tokensPromiseMap[g].splice(S,1)}}startTokenRefreshTimer(g){const m="startTokenRefreshTimer";if(!this.enableRefreshToken)return void this.logger.info("[startTokenRefreshTimer] token refresh is disabled");if(this.stopTimerFlag)return this.logger.info("[startTokenRefreshTimer] stopTimerFlag=true so cancel timer"),void this.cacheTimers.dispose();this.logger.info(`[startTokenRefreshTimer] starting token refresh timer timeToStartInMilliseconds=${g}`);const f=epochTimeInSecRoundedDown(),S=millieSecondsToSeconds(g),v=f+S;this.nextRefreshTimePointInSeconds===Number.MAX_VALUE||this.nextRefreshTimePointInSeconds<f||v<this.nextRefreshTimePointInSeconds?(this.logger.info("[startTokenRefreshTimer] cancelling current refresh timer to create new one with shorter time"),this.cacheTimers.stopTimer(m),this.nextRefreshTimePointInSeconds=v,this.logger.info(`[startTokenRefreshTimer] start new timer with timeout=${S} at time=${f}`),this.cacheTimers.startTimer(m,(()=>{this.nextRefreshTimePointInSeconds=Number.MAX_VALUE,this.refreshToken()}),S)):this.logger.info("[startTokenRefreshTimer] no need to set a new refresh timer")}async refreshTokenWithContext(g){const m={triggeredByRefresh:!0},f=newGuid(),S={causeId:f},v=Date.now();let C,_,E,T=2;this.logger.info(`[${f}][refreshTokenWithContext] refreshing token tokenType=${g.tokenType} factorsJson=${g.factorsJson}`);try{const m=this.onTokenRequired({factorsJson:g.factorsJson,tokenType:g.tokenType,requestMetadataJson:S,invalidToken:void 0,isUnauthorized:void 0,triggeredByRefresh:!0}),v=await this.timeoutPromiseRace(m,this.enableRefreshTokenRetryInSeconds,"ActiveRefresh Token Timeout");C=Date.now(),E=v?.causeId,this.lastTokenType=v?.tokenType,T=1,C=Date.now(),this.logger.info(`[${f}][refreshTokenWithContext] refresh token success for factorsJson ${g.factorsJson} and tokenType ${g.tokenType}`)}catch(m){_=m,E=_?.causeId,m?.ActiveRefreshTimeOut?(this.logger.info(`[${f}][refreshTokenWithContext] refresh token timeout, UI did not respond with token in time ${getPrintableObject(m)}`),T=5):(this.logger.info(`[${f}][refreshTokenWithContext] failed to refresh token, UI did not respond with token ${getPrintableObject(m)}`),T=2),C=Date.now(),this.deletePromisesByTriggeredByRefresh(g.factorsJson,!0)}finally{m&&(m.requestCauseId=f,m.responseCauseId=E,m.supportTokenApi=this.clientSupportsGenericTokenAPI,m.requestTokenFactors=g.factorsJson,m.tokenRequestTime=v,m.tokenResponseTime=C,m.tokenRequestStatus=T,m.requestTokenType=g.tokenType,m.foundInCache=!1,m.responseTokenType=g.tokenType,m.errorCode=_?.errorCode,m.errorSubCode=_?.errorSubCode,this.sendTokenTelemetry(m))}}refreshToken(){const g=this.cacheTokenManager.getTokenContext(4),m=this.cacheTokenManager.getTokenContext(8),f=this.cacheTokenManager.getTokenContext(1);if(!this.clientSupportsGenericTokenAPI)return void this.logger.info("[refreshToken] new Token Api is not spported");if(!g&&!m&&!f)return void this.logger.info("[refreshToken] no cached tokens available to refresh");const S=epochTimeInSecRoundedDown()+this.refreshTimeBeforeTokenTimeoutInSeconds;let v=Number.MAX_VALUE,C=!1;if(g)if(g.expiryTime>S){const m=g?.expiryTime-S;m<v&&(v=m)}else g.expiryTime<=S&&(this.refreshTokenWithContext(g),C=!0);if(m)if(m.expiryTime>S){const g=m?.expiryTime-S;g<v&&(v=g)}else m.expiryTime<=S&&(this.refreshTokenWithContext(m),C=!0);if(f)if(f.expiryTime>S){const g=f?.expiryTime-S;g<v&&(v=g)}else f.expiryTime<=S&&(this.refreshTokenWithContext(f),C=!0);C&&this.enableRefreshTokenRetry&&this.enableRefreshTokenRetryInSeconds>0&&this.enableRefreshTokenRetryInSeconds<v&&(v=this.enableRefreshTokenRetryInSeconds),v>=0&&v!==Number.MAX_VALUE&&this.startTokenRefreshTimer(secondsToMillieSeconds(v))}async getTokenWithTokenType(g,m=!1,f,S){this.logger.info(`[${g}][getTokenWithTokenType] call with factorJson=${f?.factorsJson} and request tokenType ${f?.tokenType}`);const{factorsJson:v,requestMetadataJson:C,invalidToken:_,isUnauthorized:E}=f||{},T=Date.now(),I=f?.tokenType;let b,A,P,R=2;this.clearExpiredTokens(),this.startTokenRefreshTimer(1);try{if(m)this.invalidateCachedTokenWithTokenType(I,_,v);else if(this.enableTokenCacheForGenericTokenAPI){const m=this.cacheTokenManager.getToken(I,v,this.logger,_);if(m?.token)return this.logger.info(`[${g}][getTokenWithTokenType] returning cached token for factorsJson ${v} and request tokenType ${I}, response tokenType ${m.tokenType}`),R=3,b=Date.now(),this.lastTokenType=m.tokenType,m}this.logger.info(`[${g}][getTokenWithTokenType] fetching new token for factorsJson ${v} and tokenType ${I}`);const f=C||{};f.causeId=g;const S=this.onTokenRequired({factorsJson:v,tokenType:I,requestMetadataJson:f,invalidToken:_,isUnauthorized:E,triggeredByRefresh:!1}),T=await this.timeoutPromiseRace(S,Hi.TIMEOUT_VALUES_IN_SECONDS.TOKEN_REQUIRED_TIMEOUT,"Token not received from UI in time");return b=Date.now(),P=T?.causeId,this.lastTokenType=T?.tokenType,R=1,this.logger.info(`[${g}][getTokenWithTokenType] fetching new token success for factorsJson ${v} and tokenType ${I}`),T}catch(m){throw this.logger.info(`[${g}][getTokenWithTokenType] failed to fetch token ${getPrintableObject(m)}`),A=m,P=A?.causeId,A.timeOut&&(R=4),this.deletePromisesByTriggeredByRefresh(v,!1),m}finally{const m=S?.tokenTelemetryData;m&&(m.requestCauseId=g,m.responseCauseId=P,m.supportTokenApi=this.clientSupportsGenericTokenAPI,m.requestTokenFactors=f?.factorsJson,m.tokenRequestTime=T,m.tokenResponseTime=b,m.tokenRequestStatus=R,m.requestTokenType=f?.tokenType,m.foundInCache=3===R,m.responseTokenType=this.lastTokenType,m.timeToResponse=b?b-T:b,m.errorCode=A?.errorCode,m.errorSubCode=A?.errorSubCode)}}async onTokenRequired(g){const{factorsJson:m,tokenType:f,requestMetadataJson:S,invalidToken:v,isUnauthorized:C,triggeredByRefresh:_}=g;if(this.logger.info(`[onTokenRequired] factorsJson=${m} tokenType=${f}`),!f)return this.logger.info(`[onTokenRequired] factorsJson=${m} with no token type`),Promise.reject({errorCode:Hi.HTTP_STATUS_CODES.UNAUTHORIZED,errorSubCode:0,causeId:S?.causeId});if(this.tokensPromiseMap[m]&&!_)for(const g of this.tokensPromiseMap[m])if(g.tokenRequestOptions.tokenType===f)return this.logger.info(`[onTokenRequired] factorsJson=${m} and tokenType ${f} has pending request`),g.defered.promise;this.tokensPromiseMap[m]||(this.tokensPromiseMap[m]=[]);const E=defer();return this.tokensPromiseMap[m].push({tokenRequestOptions:g,defered:E}),this.tokenCallback({factorsJson:m,tokenType:f,requestMetadataJson:S,invalidToken:v,isUnauthorized:C}),E.promise}setTokenCaching(g,m){this.tokenCachingEnabled!==g&&(this.logger.info(`[authTokenManager]setTokenCaching=${g}`),this.tokenCachingEnabled=g)}setTokenCachingForGenericTokenAPI(g,m){this.enableTokenCacheForGenericTokenAPI!==g&&(this.logger.info(`[authTokenManager]setTokenCachingForGenericTokenAPI=${g}`),this.enableTokenCacheForGenericTokenAPI=g)}calculateTokenExpiry(g,m,f){const{factorsJson:S,tokenType:v}=m;let C=f-epochTimeInSecRoundedDown(),_=C,E=f;if(C&&C>0&&C>this.refreshTimeBeforeTokenTimeoutInSeconds){switch(v){case 4:C>this.aadTokenExpirationTimeInSeconds&&(C=this.aadTokenExpirationTimeInSeconds);break;case 8:C>this.caeTokenExpirationTimeInSeconds&&(C=this.caeTokenExpirationTimeInSeconds);break;default:C>Yi&&(C=Yi)}_=C-this.refreshTimeBeforeTokenTimeoutInSeconds,E=_+epochTimeInSecRoundedDown()}return this.logger.info(`[${g}][calculateTokenExpiry] calculate expiry to ${E} tokenType=${v} factorsJson=${S}`),E}addToCache(g,m,f,S){this.clearExpiredTokens(),this.cacheTokenManager.setToken(g,m,f,S)}clearExpiredTokens(){this.forceClearExpiredTokens&&this.cacheTokenManager.clearExpiredTokens(this.logger)}async getToken(g,m=!1,f,S){if(this.clientSupportsGenericTokenAPI){this.logger.info(`[${g}][getToken] callingTokenAPI is enabled so using new API to fetch it`);const{token:v}=await this.getTokenWithTokenType(g,m,f,S);return v}const v=Date.now();let C,_,E=2;try{if(m&&this.invalidateCachedToken(g),this.cachedToken&&this.tokenCachingEnabled)return this.logger.info(`[${g}][getToken] returning cached token`),E=3,Promise.resolve(this.cachedToken);this.logger.info(`[${g}][getToken] fetching new token`);const f=await this.tokenProvider();return C=Date.now(),f?(this.tokenCachingEnabled&&(this.cachedToken=f),E=1,this.lastToken=f,this.lastTokenType=1,this.logger.info(`[${g}][getToken] fetching new token success`),f):(this.logger.info(`[${g}][getToken] received empty token`),Promise.reject("Received empty token"))}catch(m){throw this.logger.info(`[${g}][getToken] failed to fetch token=${getPrintableObject(m)}`),_=m,this.cachedToken="",m}finally{const m=S?.tokenTelemetryData;m&&(m.requestCauseId=g,m.supportTokenApi=this.clientSupportsGenericTokenAPI,m.requestTokenFactors=f?.factorsJson,m.tokenRequestTime=v,m.tokenResponseTime=C,m.tokenRequestStatus=E,m.requestTokenType=f?.tokenType,m.foundInCache=3===E,m.responseTokenType=this.lastTokenType,m.timeToResponse=C?C-v:C,m.errorCode=_?.errorCode,m.errorSubCode=_?.errorSubCode)}}invalidateCachedToken(g){this.cachedToken&&(this.logger.info(`[${g}][invalidateCachedToken]`),this.cachedToken="")}invalidateCachedTokenWithTokenType(g,m,f){8===g&&this.cacheTokenManager.getToken(8,f,this.logger)?.token===m&&(this.cacheTimers.stopTimer(f,g.toString()),this.cacheTokenManager.resetToken(8)),4===g&&this.cacheTokenManager.getToken(4,f,this.logger)?.token===m&&(this.cacheTimers.stopTimer(f,g.toString()),this.cacheTokenManager.resetToken(4)),1===g&&this.cacheTokenManager.getToken(1,f,this.logger)?.token===m&&(this.cacheTimers.stopTimer(f,g.toString()),this.cacheTokenManager.resetToken(1))}getLastToken(g){return this.logger.info(`[${g}][getLastToken]`),this.lastToken}getLastTokenWithTokenType(g,m,f){return this.logger.info(`[${g}][getLastTokenWithTokenType] with Token Type: ${m}`),this.cacheTokenManager.getToken(m,f,this.logger)?.token}async timeoutPromiseRace(g,m,f){let S;const v=new Promise(((g,v)=>{S=window.setTimeout((()=>{v({phrase:f,ActiveRefreshTimeOut:!0})}),secondsToMillieSeconds(m))}));return Promise.race([g.then((g=>(clearTimeout(S),g))),v])}getLastTokenType(g){return this.logger.info(`[${g}][getLastTokenType] lastTokenType=${this.lastTokenType}`),this.lastTokenType}updateTokenSettings(g){const{clientSupportsGenericTokenAPI:m,aadTokenExpirationTimeInSeconds:f,caeTokenExpirationTimeInSeconds:S,refreshTimeBeforeTokenTimeoutInSeconds:v,enablePublishTokenTelemetry:C,enableRefreshToken:_,forceClearExpiredTokens:E,enableRefreshTokenRetry:T,enableRefreshTokenRetryInSeconds:I}=g;this.logger.info(`updateTokenSettings ${JSON.stringify(g)}`),this.clientSupportsGenericTokenAPI=m??this.clientSupportsGenericTokenAPI,this.aadTokenExpirationTimeInSeconds=f??this.aadTokenExpirationTimeInSeconds,this.caeTokenExpirationTimeInSeconds=S??this.caeTokenExpirationTimeInSeconds,this.refreshTimeBeforeTokenTimeoutInSeconds=v??this.refreshTimeBeforeTokenTimeoutInSeconds,this.enablePublishTokenTelemetry=C??this.enablePublishTokenTelemetry,this.forceClearExpiredTokens=E??this.forceClearExpiredTokens,this.enableRefreshToken=_??this.enableRefreshToken,this.enableRefreshTokenRetry=T??this.enableRefreshTokenRetry,this.enableRefreshTokenRetryInSeconds=I??this.enableRefreshTokenRetryInSeconds}updateToken(g,m,f,S,v){if(this.logger.info(`[${S}][updateToken] UI replies a token with factorsJson=${g} updateMetadata=${JSON.stringify(m)} tokenExpirySecSinceEpoch?=${v}`),m.error){this.logger.info(`[${S}][updateToken] UI replies with error ${m.error} for factorsJson ${g}`);for(const f of this.tokensPromiseMap[g])f.tokenRequestOptions.requestMetadataJson.causeId===S&&f.defered.reject({phrase:m.error?.phrase,errorCode:m.error?.code,errorSubCode:m.error?.subCode,causeId:S});return}if(!f){this.logger.info(`[${S}][updateToken] received empty token`);for(const m of this.tokensPromiseMap[g])m.tokenRequestOptions.requestMetadataJson.causeId===S&&m.defered.reject({phrase:"Received empty token",causeId:S});return}if(v>epochTimeInSecRoundedDown()&&this.enableTokenCacheForGenericTokenAPI){this.logger.info(`[${S}][updateToken] caching Token with tokenType=${m.tokenType}`);const C={factorsJson:g,tokenType:m.tokenType,invalidToken:f};this.addToCache(m.tokenType,f,g,this.calculateTokenExpiry(S,C,v))}if(!this.tokensPromiseMap[g]){this.logger.warn(`[updateToken]: UI try to update token with invalid factorsJson=${g}`);const f={responseCauseId:S,supportTokenApi:this.clientSupportsGenericTokenAPI,requestTokenFactors:g,tokenResponseTime:Date.now(),tokenRequestStatus:6,responseTokenType:m.tokenType};return void this.sendTokenTelemetry(f)}if(this.tokensPromiseMap[g]){const v=this.tokensPromiseMap[g];for(let C=v.length-1;C>=0;C--)(v[C]?.tokenRequestOptions.tokenType&m.tokenType)>0&&(v[C].defered.resolve({token:f,tokenType:m.tokenType,causeId:S}),this.tokensPromiseMap[g].splice(C,1))}if(this.logger.info(`[${S}][updateToken] resolved and upateToken with factorsJson=${g} tokenType=${m.tokenType}`),0===this.tokensPromiseMap[g].length&&delete this.tokensPromiseMap[g],4!==m.tokenType&&8!==m.tokenType&&1!==m.tokenType)return;if(Object.keys(this.tokensPromiseMap).length>0)for(const v of Object.values(this.tokensPromiseMap))for(let C=v.length-1;C>=0;C--){const _=v[C];_.tokenRequestOptions.factorsJson!==g&&(_.tokenRequestOptions.tokenType&m.tokenType)>0&&!_.tokenRequestOptions.isUnauthorized&&(_.defered.resolve({token:f,tokenType:m.tokenType,causeId:S}),v.splice(C,1))}for(const g of Object.keys(this.tokensPromiseMap))0===this.tokensPromiseMap[g].length&&delete this.tokensPromiseMap[g];const C=v-epochTimeInSecRoundedDown();this.startTokenRefreshTimer(C>=0?secondsToMillieSeconds(C):0)}setTokenRequiredCallBack(g){this.tokenCallback=g}setDisableTimerFlag(g){this.logger.info(`[setDisableTimerFlag] set disableTimerFlag to ${g}`),this.stopTimerFlag=g}sendTokenTelemetry(g){if(!this.enablePublishTokenTelemetry)return;const m={};m[zi.TOKEN_TELEMETRY_EVENT.TOKEN_TELEMETRY]=JSON.stringify(g),this.telemetryManager?(this.logger.info("[sendTokenTelemetry] sending refresh token telemetry:",m),this.telemetryManager.sendEvent(zi.EVENT_TYPE.CONVERSATION_TOKEN,m)):this.logger.warn("[sendTokenTelemetry] telemetryManager is undefined, cannot send token telemetry")}dispose(){this.cacheTimers&&this.cacheTimers.dispose()}},Xi={build:(g,m,f,S)=>new Qi(g,m,f,S)},Zi=class{constructor(g){this.piiScrubber=this.getPiiScrubber(g)}scrubParticipantsList(g){const m=[];return Array.isArray(g)&&g.forEach((g=>m.push(this.scrubMriOrOmit(g)))),m}scrubMriOrOmit(g){return"string"==typeof g?this.piiScrubber.mri(g):this.piiScrubber.omit(g)}static scrubDisplayNamesFromResponse(g){const m=/"displayName": "[a-z]+"/gi;return safeJsonStringify(g).replace(m,'"displayName": "(redacted)"')}getPiiScrubber(g){return g&&"function"==typeof g.omit&&"function"==typeof g.mri?g:{omit:()=>"<pii:omit/>",mri:()=>"<pii:mri/>"}}},en=__toESM(R);function getMediaLabel(g){switch(g){case 0:return"main-audio";case 1:return"main-video";case 2:return"applicationsharing-video";case 3:return"data"}throw new Error("Invalid media type")}function mapMediaTypeStringToMediaType(g){switch(g){case"audio":return 0;case"video":return 1;case"applicationsharing-video":return 2;case"data":return 3;default:return}}function hasParticipantLegId(g,m){return g.endpoints?.endpointDetails?.some((g=>g.participantId===m))??!1}function findParticipantUsingParticipantLegId(g,m){return g.participants.find((g=>hasParticipantLegId(g,m)))}function hasStagingGroup(g){return!!g?.meetingGroupDetails?.groups&&Object.keys(g.meetingGroupDetails.groups).some((g=>"stagingGroup"===g))}function getSourceIdForMediaType(g,m){let f=-1;try{if(g.endpoints)e:for(const S of g.endpoints.endpointDetails)if(null!==S&&void 0!==S.mediaStreams){for(const g of S.mediaStreams)if(mapMediaTypeStringToMediaType(g.type)===m){f=g.sourceId;break e}}else f=li}catch(g){return-1}return f}function getSourceId(g,m,f){if(!g||!g.endpoints)return-1;const S=g.endpoints.endpointDetails.find((g=>g?.participantId===m));if(!S)return getSourceIdForMediaType(g,f);if(!S.mediaStreams)return getSourceIdForMediaType(g,f);const v=S.mediaStreams.find((({type:g})=>mapMediaTypeStringToMediaType(g)===f));return v?v.sourceId:-1}function getParticipantIdForSourceId(g,m,f){try{if(!g.endpoints)return;for(const S of g.endpoints.endpointDetails)if(S?.mediaStreams)for(const g of S.mediaStreams)if(f===g.sourceId&&mapMediaTypeStringToMediaType(g.type)===m)return S.participantId??null;return}catch(g){return}}function isScreenSharerStream(g){return"sendonly"===g.direction&&"applicationsharing-video"===g.label}function getSharingParticipantLeg(g){if(g.endpoints?.endpointDetails)return 1===g.endpoints.endpointDetails.length?g.endpoints.endpointDetails[0].participantId:g.endpoints.endpointDetails.find((g=>g?.mediaStreams?.some(isScreenSharerStream)))?.participantId}function processTransactionResponse(g){let m={};if(g.stateId)m.result=g.stateId;else if(g.results){const{results:f}=g;1===f.length&&f[0].stateId&&(m.result=f[0].stateId);const S={};g.results.forEach((g=>{const{result:f}=g,v=getParticipantId(g);(void 0===m.code||f.code>m.code)&&(m.code=f.code,m.subCode=f.subCode),S[v]=g})),m.result=JSON.stringify(S)}else g.result&&(m={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode,resultCategories:g.result.resultCategories},g.additionalDetail&&(m.result=g.additionalDetail));return m}function getParticipantId(g){return g.participantId||g.participant&&g.participant.id}var tn=class{constructor(g,m){this.broadcastContext=null,this.broadcastControllerUrl="",this.broadcastCallbackUrl="",this.broadcastState=null,this.setContext=(g=null)=>{this.logger.info("BroadcastSession :: set broadcast context",g),this.broadcastContext=g},this.getContext=()=>(this.logger.info("BroadcastSession :: get broadcast context",this.broadcastContext||null),this.broadcastContext||null),this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>"[Broadcast]"))}handleBroadcastStateChanged(g){const m=g.body;this.broadcastState=m;const f=extractCauseIdFromMessage(g);this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.BROADCAST_STATE_CHANGED,g),this.logger.info(`[${f}] broadcast state changed=${this.broadcastState}`),this.updateBroadcastMetadata(f)}updateBroadcastCallbackUrl(g){const m=get(this.signalingSession,Vi.CONV_BROADCAST_UPDATE);this.broadcastCallbackUrl!==m&&(this.broadcastCallbackUrl=m,this.logger.info(`[${g}] broadcast callback url changed=${this.broadcastCallbackUrl}`),this.updateBroadcastMetadata(g))}handleBroadcastDetailsChanged(g,m){this.signalingSession.telemetryHelper.recordEvent(Wi.UPDATE_BROADCAST_DETAILS,{causeId:m}),g.activeModalities&&g.activeModalities.broadcast&&g.activeModalities.broadcast.controller!==this.broadcastControllerUrl&&(this.broadcastControllerUrl=g.activeModalities.broadcast.controller,this.broadcastAdditionalData=g.activeModalities.broadcast,this.logger.info(`[${m}] broadcast controller changed=${this.broadcastControllerUrl}`),this.signalingSessionCallback.onBroadcastMeetingConnected(Hi.SUCCESS_TRANSACTION_END,m),this.updateBroadcastMetadata(m)),!this.broadcastControllerUrl||g.activeModalities&&g.activeModalities.broadcast||(this.broadcastControllerUrl="",this.broadcastContext=null,this.logger.info(`[${m}] broadcast controller changed=${this.broadcastControllerUrl}`),this.updateBroadcastMetadata(m),this.signalingSessionCallback.onBroadcastMeetingEnded(Hi.SUCCESS_TRANSACTION_END,m))}handleAddBroadcastModalitySuccess(g,m){this.logger.info(`[${m}][handleAddBroadcastModalitySuccess]`)}handleAddBroadcastModalityFailure(g,m){this.logger.info(`[${m}][handleAddBroadcastModalityFailure]`);const f={...g.modalityFailure.broadcast};this.signalingSessionCallback.onBroadcastMeetingEnded(f,m)}updateBroadcastMetadata(g){const m={broadcastControllerUrl:this.broadcastControllerUrl,broadcastStateCallbackUrl:this.broadcastCallbackUrl,broadcastState:this.broadcastState,broadcastAdditionalData:this.broadcastAdditionalData};this.logger.info(`[${g}] update broadcast metadata=${m}`),this.signalingSessionCallback.onBroadcastMeetingUpdated&&this.signalingSessionCallback.onBroadcastMeetingUpdated(m,g)}},nn=class{static build(g,m){return new rn(g,m)}},rn=class{constructor(g,m){this.ontimeout=g,this.name=m}start(g){if(void 0!==this.timeoutId)throw new Error(`Timer ${this.name} already started`);return this.timeoutId=window.setTimeout((()=>this.ontimeout()),g),this}stop(){if(void 0===this.timeoutId)throw new Error(`Timer ${this.name} is not defined`);clearTimeout(this.timeoutId),this.timeoutId=void 0}},sn="http://broker.invalid/",an=30,on=5,ln=1,cn=class{constructor(g){this._signalingSession=g,this.baseUrl=sn,this.currentSubscriptionUrl=null,this._currentSubscriptionTimeoutInSec=an,this._subscribers=[],this._disposed=!1,this._reportedResultCount=0,this._subscriptionRetryBackoffInSec=on,this._notifySubscribers=g=>{this._logger.info("_notifySubscribers"),Promise.resolve().then((()=>{g.split(",").forEach((g=>{const m=parseRawHttpMessage(decodeMessage(g));let f=m.body;isEncodedMessage(m.headers)&&isMessageEncodingSupported(m.headers)&&(f=decodeMessage(f));const S={url:m.url,body:JSON.parse(f),headers:m.headers};this._logger.info("message length=",f.length,"n. of subscribers",this._subscribers.length),this._subscribers.forEach((g=>g(S)))}))})).catch((g=>{this._logger.error("_notifySubscribers, failed to decode message",g),this._signalingSession.telemetryHelper.recordEvent(Wi.BROKER_DECODE_PAYLOAD_FAILURE)}))},this._subscribeToBroker=(g,m)=>{if(this._disposed)return void this._logger.warn("_subscribeToBroker, disposed, ignore subscription");const f=causeId2();this._logger.info("_subscribeToBroker, url: ",g,",timeout in sec",m),this.currentSubscriptionUrl=g,this._currentSubscriptionTimeoutInSec=m,this._clearAllPendingTimeouts(),this._setSubscriptionTimeout(m),this._signalingSession.http.sendGetRequest({url:this.currentSubscriptionUrl,requestName:qi.BROKER_SUBSCRIBE.name,customHeaders:this._getBrokerRequestHeaders(f),payload:null,skipHttpTelemetry:!this._reportSubscriptionInTelemetry(),causeId:causeId2(),operationType:"BrokerSubscribe"}).then(this._handleSubscriptionSuccess).catch(this._handleSubscriptionFailure)},this._clearAllPendingTimeouts=()=>{this._cancelRequestTimer&&(this._cancelRequestTimer.stop(),this._cancelRequestTimer=null),this._retryRequestTimer&&(this._retryRequestTimer.stop(),this._retryRequestTimer=null)},this._abortPendingRequest=()=>{this._signalingSession.http.cancelRequestIfPending(qi.BROKER_SUBSCRIBE.name,causeId2())},this._setSubscriptionTimeout=g=>{this._cancelRequestTimer=nn.build((()=>{this._disposed||(this._signalingSession.http.hasPendingRequest(qi.BROKER_SUBSCRIBE.name)?(this._logger.warn("timeout subscription"),this._signalingSession.telemetryHelper.recordEvent(Wi.BROKER_SUBSCRIPTION_TIMEOUT),this._signalingSession.http.cancelRequestIfPending(qi.BROKER_SUBSCRIBE.name,causeId2())):this._logger.error("Unable to resolve timeout deferred, it is not defined!"))}),"TIMEOUT").start(1e3*g)},this._handleSubscriptionSuccess=g=>{if(this._disposed)this._logger.warn("_handleSubscriptionSuccess, disposed, ignore subscription success");else if(this._reportSubscriptionInTelemetry(g)&&this._signalingSession.telemetryHelper.recordEvent(Wi.BROKER_SUBSCRIPTION_SUCCESSFUL),g&&g.response){const m=g.response;this._logger.info("_handleSubscriptionSuccess, response",m),m.message&&this._notifySubscribers(m.message);const f=m.nextSubscribeUrl||this.currentSubscriptionUrl,S=m.expirationTimeInSec||this._currentSubscriptionTimeoutInSec;this._subscribeToBroker(f,S)}else this._logger.info("_handleSubscriptionSuccess, empty response")},this._handleSubscriptionFailure=g=>{if(this._disposed)return void this._logger.warn("_handleSubscriptionFailure, disposed, ignore subscription");if(g.status>=400&&g.status<500&&401!==g.status&&this.isNotNetworkErrors(g.status))return void this._logger.warn(`_handleSubscriptionFailure, received status ${g.status}, stop subscribing`);const m=getPrintableObject(g);this._logger.error("_handleSubscriptionFailure failed, re-subscribing",m),this._reportSubscriptionInTelemetry()&&this._signalingSession.telemetryHelper.recordEvent(Wi.BROKER_SUBSCRIPTION_FAILED),this._retryRequestTimer=nn.build((()=>{this._subscribeToBroker(this.currentSubscriptionUrl,this._currentSubscriptionTimeoutInSec)}),"RETRY").start(1e3*this._subscriptionRetryBackoffInSec)},this._reportSubscriptionInTelemetry=g=>(this._reportedResultCount++,this._reportedResultCount<=ln),this._getBrokerRequestHeaders=g=>{const m=new Gi;return m.set(Hi.HEADERS.CONTENT_TYPE,Hi.CONTENT_TYPE.JSON),this._signalingSession.signalingAgentConfig.brokerRequestBatching&&m.set(Hi.HEADERS.BROKER_USE_BATCHING_HEADER_NAME,"1"),m},this._logger=this._signalingSession.logger.createChild("Broker"),this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration?.brokerRetryBackOffInSec&&(this._subscriptionRetryBackoffInSec=this._signalingSession.signalingAgentConfig.csaTimeoutConfiguration.brokerRetryBackOffInSec)}subscribeToBroker(g){this._logger.info("subscribeToBroker called."),this._abortPendingRequest(),this._clearAllPendingTimeouts(),this._subscribeToBroker(g,this._currentSubscriptionTimeoutInSec)}onBrokerMessage(g){this._logger.info("onBrokerMessage callback added"),this._subscribers.push(g)}dispose(){this._disposed=!0,this._logger.info("dispose"),this._subscribers=[],this._clearAllPendingTimeouts(),this._abortPendingRequest()}isNotNetworkErrors(g){return 490!==g&&496!==g&&498!==g&&499!==g}},dn=class{constructor(g){this.requests={},this.logger=g}clear(g,m){const f=m||{code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((m=>{try{const S=parseInt(m,10);Object.keys(this.requests[S]).forEach((m=>{this.rejectOperation(S,m,g,f)}))}catch(g){this.logger.warn(`CallOperations: clear error = ${g}`)}}))}hasOperation(g,m){return this.requests.hasOwnProperty(g.valueOf())&&this.requests[g.valueOf()].hasOwnProperty(m)}getAllOperations(){return this.requests}getOperation(g,m){return this.hasOperation(g,m)?this.requests[g.valueOf()][m]:null}setOperation(g,m,f){return!this.hasOperation(g,m)&&(this.hasOwnProperty(g.valueOf())||(this.requests[g.valueOf()]={}),this.requests[g.valueOf()][m]=f,!0)}rejectOperation(g,m,f,S){if(this.hasOperation(g,m)){const f=g.valueOf(),v=this.requests[f][m].promise;delete this.requests[f][m],v.reject(S)}}resolveOperation(g,m,f,S){if(this.hasOperation(g,m)){const S=g.valueOf(),v=this.requests[S][m].promise;delete this.requests[S][m],v.resolve(f)}}},hn=class{constructor(g){this.logger=g,this.localRequests=new dn(g)}dispose(g,m,f){this.logger.info(`[${f}][dispose]`),this.rejectAllPendingOperations(g,m)}hasPendingOperation(g,m,f){return this.logger.info(`[${f}][hasPendingOperation] ${g} ${scrubMriOrOmit(m)}}`),this.localRequests.hasOperation(g,m)}rejectPendingOperation(g,m,f,S,v){this.logger.info(`[${v}][rejectPendingOperation] ${g} ${m} reason: ${f} endCode: ${S}`),this.localRequests.rejectOperation(g,m,f,S)}resolvePendingOperation(g,m,f,S){this.logger.info(`[${S}][resolvePendingOperation]: ${scrubMriOrOmit(m)}`),this.localRequests.resolveOperation(g,m,f,S)}setPendingOperation(g,m,f,S){return this.logger.info(`[${S}][setPendingOperation] ${g} value: ${f}`),this.localRequests.setOperation(g,m,f)}rejectAllPendingOperations(g,m){this.logger.info("rejectLocalQueuedOperations"),this.localRequests.clear(g,m)}};function getPayload(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"content cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[]},contentSharing:{identifier:m.contentIdentifier,subject:m.subject,sessionState:m.sessionState,sequenceNumber:m.sequenceNumber,links:{sessionUpdate:get(g,Vi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Vi.CONV_CONTENT_SHARING_END)}},links:{addModalitySuccess:get(g,Vi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Vi.CONV_ADD_MODALITY_FAILURE)}}}}function getPayload2(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{contentSharing:{links:{sessionUpdate:get(g,Vi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Vi.CONV_CONTENT_SHARING_END)}},participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload3(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{contentSharingTransactionEnd:m,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload4(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload5(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},links:{sessionUpdate:get(g,Vi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Vi.CONV_CONTENT_SHARING_END)}}}}function getPayload6(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}function getPayload7(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"sessionState cannot be null"),assertNotNull(f,"sequenceNumber cannot be null"),{payload:{sessionUpdateSequenceNumber:f,sessionState:m,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}}}}var un=class{constructor(){this.msElapsed=0,this.isPaused=!1,this.startTime=(new Date).getTime(),this.pause=()=>{this.isPaused||(this.msElapsed+=(new Date).getTime()-this.startTime,this.isPaused=!0)},this.resume=()=>{this.isPaused&&(this.isPaused=!1,this.startTime=(new Date).getTime())},this.duration=()=>this.isPaused?this.msElapsed:this.msElapsed+(new Date).getTime()-this.startTime,this.durationInMinutes=()=>{const g=this.duration()/6e4;return Math.ceil(g)},this.durationInSeconds=()=>{const g=this.duration()/1e3;return Math.ceil(g)}}};function build3(){return new un}var gn=class{constructor(g,m,f,S){this.signalingSession=g,this.correlationId=m,this.sessionId=null,this.fsmState=Hi.CONTENT_SHARING_FSM_STATE.IDLE,this.addSessionPromise=null,this.removeSessionPromise=null,this.confirmInRosterPromise=null,this.links={},this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.disposed=!1,this.isPresenter=!1,this.FSM_STATES=Hi.CONTENT_SHARING_FSM_STATE,this.logger=g.logger.createChild((()=>`[${this.fsmState}][cs=${this.sessionId}][cc=${this.correlationId}]`)),f&&(this.sessionId=f),S&&(this.links=S)}start(g,m,f,S){if(this.logger.info(`[${S}][start]`),assertNotNullOrEmpty(g,"Correct addModality url is not provided"),!this.checkState("start",this.FSM_STATES.IDLE,this.addSessionPromise))return Promise.reject(null);this.addSessionPromise=f,this.confirmInRosterPromise=defer2(),this.fsmState=this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.addTelemetryOperation(qi.ADD_CONTENT_SHARING_MODALITY.name,{causeId:S});const v=new Gi;return v.set(Hi.HEADERS.CONTENT_SHARING_CORRELATION_ID,this.correlationId),this.signalingSession.http.sendPostRequest({url:g,payload:getPayload(this.signalingSession,m),requestName:qi.ADD_CONTENT_SHARING_MODALITY.name,customHeaders:v,onceTrouterReady:()=>{this.startContentSharingTimer(S)},causeId:S}).then((()=>{this.disposed||(this.presenterMri=this.signalingSession.participantManager.localParticipant.id,this.isPresenter=!0)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${S}][start] error: ${getPrintableObject(m)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise(getPrintableObject(g),m.error)),Promise.reject(null)}))}delete(g,m){this.logger.info(`[${m}][delete]`);let f=!1;if(this.fsmState===this.FSM_STATES.IDLE)return this.logger.info(`[${m}][delete] skipped because state is already ${this.fsmState}`),g.resolve(),Promise.resolve();if(this.fsmState===this.FSM_STATES.CONTENT_SHARING_START_INITIATED)f=!0,this.rejectPendingPromise("Session delete called before start was finished");else if(!this.checkState("delete",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return Promise.reject(null);f||assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER],"Correct controller url is not set"),this.removeSessionPromise=g,this.fsmState=this.FSM_STATES.CONTENT_SHARING_DELETE_INITIATED;const S=build3(),v=this.addTelemetryOperation(qi.DELETE_CONTENT_SHARING.name,{causeId:m});return(f?Promise.resolve(void 0):this.signalingSession.http.sendDeleteRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER],requestName:qi.DELETE_CONTENT_SHARING.name,payload:getPayload3(this.signalingSession,{code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED}),causeId:m})).then((()=>{if(!this.disposed){const g={success:!0,duration:S.duration()};f&&(g.skipReason="Session delete called before start was finished"),this.updateTelemetryOperation(v,g),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][delete] error: ${getPrintableObject(f)}`),!this.disposed){const g={success:!1,duration:S.duration()};this.updateTelemetryOperation(v,g),this.fsmState=this.FSM_STATES.IDLE,this.resolvePendingPromise()}return Promise.reject(null)}))}join(g,m){if(this.logger.info(`[${m}][join]`),assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER],"Correct joinContentSharing url is not provided"),!this.checkState("join",this.FSM_STATES.IDLE,g))return;this.lastUpdateSequenceNumber=-1,this.nextClientSequenceNumberToUse=1,this.addSessionPromise=g,this.fsmState=this.FSM_STATES.CONTENT_SHARING_JOIN_INITIATED;const f=build3(),S=this.addTelemetryOperation(qi.JOIN_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER],payload:getPayload2(this.signalingSession),requestName:qi.JOIN_CONTENT_SHARING.name,causeId:m}).then((g=>{if(!this.disposed){const m={success:!0,duration:f.duration()};this.updateTelemetryOperation(S,m),this.processStartOrJoinSuccess(g.response),this.resolvePendingPromise(g.response)}})).catch((g=>{const v=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][join] error: ${getPrintableObject(v)}`),!this.disposed){const m={success:!1,duration:f.duration()};this.updateTelemetryOperation(S,m);const C=v.error;this.rejectPendingPromise(getPrintableObject(g),C)}}))}takeControl(g,m){if(this.logger.info(`[${m}][takeControl]`),assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_TAKE_CONTROL],"correct contentSharingTakeControl url is not provided"),!this.checkState("takeControl",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return;const f=build3(),S=this.addTelemetryOperation(qi.TAKE_CONTROL_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_TAKE_CONTROL],payload:getPayload4(this.signalingSession),requestName:qi.TAKE_CONTROL_CONTENT_SHARING.name,withoutTrouter:!0,causeId:m}).then((m=>{if(!this.disposed){const v={success:!0,duration:f.duration()};this.updateTelemetryOperation(S,v);const C={contentIdentifier:m.response.identifier,presenter:m.response.presenter.id,subject:m.response.subject||null,sessionState:m.response.sessionState||null};g.resolve(C)}})).catch((v=>{const C=getErrorForXHRFailure(v,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][takeControl] error: ${getPrintableObject(C)}`),!this.disposed){const m={success:!1,duration:f.duration()};this.updateTelemetryOperation(S,m);const _=new Error(getPrintableObject(v));_.endCode=C.error,g.reject(_)}}))}updateSessionState(g,m,f){if(this.logger.info(`[${f}][updateSessionState]`),assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],"Correct sendUpdateSessionState url is not provided"),!this.checkState("updateSessionState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,m))return;const S=build3(),v=this.addTelemetryOperation(qi.UPDATE_SESSION_STATE_CONTENT_SHARING.name,{causeId:f});this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE],payload:getPayload7(this.signalingSession,g,this.nextClientSequenceNumberToUse++),requestName:qi.UPDATE_SESSION_STATE_CONTENT_SHARING.name,causeId:f}).then((()=>{if(!this.disposed){const g={success:!0,duration:S.duration()};this.updateTelemetryOperation(v,g),m.resolve()}})).catch((g=>{const C=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${f}][updateSessionState] error: ${getPrintableObject(C)}`),!this.disposed){const f={success:!1,duration:S.duration()};this.updateTelemetryOperation(v,f);const _=new Error(getPrintableObject(g));_.endCode=C.error,m.reject(_)}}))}updateParticipantState(g,m){if(this.logger.info(`[${m}][updateParticipantState]`),assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],"correct confirmContentSharingView url is not provided"),!this.checkState("updateParticipantState",this.FSM_STATES.CONTENT_SHARING_CONNECTED,g))return;const f=build3(),S=this.addTelemetryOperation(qi.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,{causeId:m});this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE],payload:getPayload6(this.signalingSession),requestName:qi.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING.name,withoutTrouter:!0,causeId:m}).then((()=>{if(!this.disposed){const m={success:!0,duration:f.duration()};this.updateTelemetryOperation(S,m),g.resolve()}})).catch((v=>{const C=getErrorForXHRFailure(v,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${m}][updateParticipantState] error: ${getPrintableObject(C)}`),!this.disposed){const m={success:!1,duration:f.duration()};this.updateTelemetryOperation(S,m);const _=new Error(getPrintableObject(v));_.endCode=C.error,g.reject(_)}}))}updateNotificationLinks(g){if(this.logger.info(`[${g}][updateNotificationLinks]`),assertNotNullOrEmpty(this.links[Hi.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],"correct notificationLinks url is not provided"),!this.checkState("updateState",this.FSM_STATES.CONTENT_SHARING_CONNECTED))return;const m=build3(),f=this.addTelemetryOperation(qi.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,{causeId:g});this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS],payload:getPayload5(this.signalingSession),requestName:qi.UPDATE_CONTENT_SHARING_NOTIFICATION_LINKS.name,withoutTrouter:!0,causeId:g}).then((()=>{if(!this.disposed){const g={success:!0,duration:m.duration()};this.updateTelemetryOperation(f,g)}})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${g}][updateNotificationLinks] error: ${getPrintableObject(v)}`),!this.disposed){const g={success:!1,duration:m.duration()};this.updateTelemetryOperation(f,g)}}))}confirmInRoster(){this.confirmInRosterPromise&&this.confirmInRosterPromise.isPending&&(this.logger.info("Confirmed in roster"),this.confirmInRosterPromise.resolve())}handleAddModalitySuccess(g,m){return this.logger.info(`[${m}][handleAddModalitySuccess]`),this.checkState("handleAddModalitySuccess",this.FSM_STATES.CONTENT_SHARING_START_INITIATED)?g.modalitySuccess&&g.modalitySuccess.contentSharing?(this.addTelemetryOperation(Wi.HANDLE_ADD_MODALITY_SUCCESS,{causeId:m}),this.processStartOrJoinSuccess(g.modalitySuccess.contentSharing),this.confirmInRosterPromise.promise.then((()=>{delete this.confirmInRosterPromise,this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_MODALITY),this.resolvePendingPromise(g.modalitySuccess.contentSharing)})),!0):(this.addTelemetryOperation(Wi.HANDLE_ADD_MODALITY_SUCCESS,{causeId:m,skipReason:"no content sharing blob"}),this.logger.info(`[${m}][handleAddModalitySuccess] ignored because modalitySuccess was missing or did not contain content sharing blob`),!1):(this.logger.info(`[${m}][handleAddModalitySuccess] ignored because session is not waiting to start`),!1)}handleAddModalityFailure(g,m){this.logger.info(`[${m}][handleAddModalityFailure]`);if(!this.checkState("handleAddModalityFailure",[this.FSM_STATES.CONTENT_SHARING_START_INITIATED,this.FSM_STATES.CONTENT_SHARING_CONNECTED]))return!1;if(!g.modalityFailure||!g.modalityFailure.contentSharing)return this.addTelemetryOperation(Wi.HANDLE_ADD_MODALITY_FAILURE,{causeId:m,skipReason:"no content sharing blob"}),!1;const f=g.modalityFailure.contentSharing;this.addTelemetryOperation(Wi.HANDLE_ADD_MODALITY_FAILURE,{reason:f,causeId:m});const S={...f};return this.sendTelemetryData(S),this.rejectPendingPromise(S.phrase,S),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_MODALITY),!0}handleStartFromRoster(g,m){this.logger.info(`[${m}][handleStartFromRoster]`),this.addTelemetryOperation(Wi.CONTENT_SHARING_START_FROM_ROSTER,{causeId:m})}handleStopFromRoster(g,m){this.logger.info(`[${m}][handleStopFromRoster]`),this.addTelemetryOperation(Wi.CONTENT_SHARING_END_FROM_ROSTER,{causeId:m}),this.sendTelemetryData(g)}handleStop(g,m){if(this.logger.info(`[${m}][handleStop]`),this.isSelfInitiatedAction(g))return this.logger.info(`[${m}][handleStop]handleStop skipped because session was ended by self`),!1;const f={...g.contentSharingTransactionEnd};return this.addTelemetryOperation(Wi.HANDLE_CONTENT_SHARING_END,{causeId:m}),this.sendTelemetryData(f),!0}handleUpdate(g,m){return this.logger.info(`[${m}][handleUpdate]`),g.sequenceNumber<=this.lastUpdateSequenceNumber?(this.logger.info(`handleUpdate skipped because of old sequence number: last received ${this.lastUpdateSequenceNumber}, update contained ${g.sequenceNumber}`),this.addTelemetryOperation(Wi.HANDLE_CONTENT_SHARING_UPDATE,{causeId:m,skipReason:"old sequence number"}),!1):(this.lastUpdateSequenceNumber=g.sequenceNumber,this.isPresenter=g.presenter.id===this.signalingSession.participantManager.localParticipant.id,this.addTelemetryOperation(Wi.HANDLE_CONTENT_SHARING_UPDATE,{causeId:m}),!0)}dispose(g,m){this.logger.info(`[${m}][dispose]`),this.disposed=!0,this.rejectPendingPromise("call ended",g||{code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED}),this.addTelemetryOperation(Wi.HANDLE_CALL_END,{causeId:m}),this.sendTelemetryData(g)}rejectPendingPromise(g,m){this.logger.info("rejectPendingPromise");const f=new Error(g);m&&(f.endCode=m),this.removeSessionPromise&&(this.removeSessionPromise.reject(f),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.reject(f),this.addSessionPromise=null)}resolvePendingPromise(g){this.logger.info("resolvePendingPromise");let m=null;g&&(m={sessionId:g.sessionId,correlationId:g.contentSharingCorrelationId,contentIdentifier:g.identifier,presenter:g.presenter.id,subject:g.subject||null,sessionState:g.sessionState||null}),this.removeSessionPromise&&(this.removeSessionPromise.resolve(m),this.removeSessionPromise=null),this.addSessionPromise&&(this.addSessionPromise.resolve(m),this.addSessionPromise=null)}processStartOrJoinSuccess(g){this.logger.info("processStartOrJoinSuccess"),this.sessionId=g.sessionId,this.fsmState=this.FSM_STATES.CONTENT_SHARING_CONNECTED,this.lastUpdateSequenceNumber=-1,this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER]=g.links.contentSharingController,this.links[Hi.LINKS.CONTENT_SHARING_TAKE_CONTROL]=g.links.takeControl,this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_SESSION_STATE]=g.links.updateSessionState,this.links[Hi.LINKS.CONTENT_SHARING_UPDATE_PARTICIPANT_STATE]=g.links.sync,this.links[Hi.LINKS.CONTENT_SHARING_NOTIFICATION_LINKS]=g.links.notificationLinks,this.links[Hi.LINKS.CONTENT_SHARING_LEAVE]=g.links.leave}checkState(g,m,f){let S;if(S="string"==typeof m?this.fsmState===m:m.indexOf(this.fsmState)>-1,S)return!0;{const S=`${g} requires state ${m}, but state is ${this.fsmState}`;return this.logger.error(S),f&&f.reject(S),!1}}isSelfInitiatedAction(g){return g.presenter.participantId===this.signalingSession.participantManager.localParticipant.participantId}startContentSharingTimer(g){this.logger.info("startContentSharingTimer"),this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.ADD_MODALITY,(()=>{this.addTelemetryOperation(Wi.ADD_MODALITY_TIMEOUT,{causeId:g}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_MODALITY),this.rejectPendingPromise("timed out waiting for ContentSharing to start",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT})}),Hi.TIMEOUT_VALUES_IN_SECONDS.ADD_MODALITY_TIMEOUT)}addTelemetryOperation(g,m){return this.signalingSession.telemetryHelper.addContentSharingOperation(this.correlationId,g,m)}updateTelemetryOperation(g,m){this.signalingSession.telemetryHelper.updateContentSharingOperation(this.correlationId,g,m)}sendTelemetryData(g){this.signalingSession.telemetryHelper.sendContentSharingTelemetryData(this.correlationId,this.signalingSession.sessionId,this.isPresenter,g,this.links[Hi.LINKS.CONTENT_SHARING_CONTROLLER],this.sessionId)}},pn=class{constructor(g,m){this.contentSharingToStartCallWith=null,this.contentSharingSessions={},this.DEFAULT_STOP_REASON={code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.REMOTE_USER_INITIATED},this.DEFAULT_STOP_ID="8:unknown",this.deleteContentSharingAsync=(g,m)=>{this.logger.info(`[${m}][deleteContentSharingAsync]`);const f=defer2();let S=this.contentSharingSessions[g];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===g&&(S=this.pendingSessionToStart),S){const always=()=>{this.contentSharingSessions[g]&&delete this.contentSharingSessions[g]};S.delete(f,m).then(always,always)}else this.rejectBecauseOfMissingSession(g,f);return f.promise},this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>"[ContentSharingManager]")),this.lastProcessedSequenceNumber=-1,this.lastProcessedSequenceNumberForParticipant={}}startContentSharingAsync(g,m,f,S,v,C,_){if(this.logger.info(`startContentSharingAsync called for: ${g}`),this.pendingSessionToStart){const g="There is already a ContentSharing session start pending";return this.logger.error(g),Promise.reject(new Error(g))}const E={contentIdentifier:g,subject:f||null,sessionState:m||null,sequenceNumber:1},T=defer2(),I=new gn(this.signalingSession,_||newGuid());return this.pendingSessionToStart=I,v?(this.logger.info("Call connected, send content sharing request out immediately"),I.start(S,E,T,C)):(this.logger.info("Content sharing is to be started when startOutgoingCall is called"),I.addSessionPromise=T,I.fsmState=Hi.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED,this.contentSharingToStartCallWith=E),T.promise.then((()=>{this.contentSharingSessions.hasOwnProperty(I.correlationId)||(this.contentSharingSessions[I.correlationId]=I),this.pendingSessionToStart=null})).catch((()=>{this.pendingSessionToStart=null})),T.promise}joinContentSharingAsync(g,m){this.logger.info(`[${m}][joinContentSharingAsync]`);const f=defer2(),S=this.contentSharingSessions[g];return S?S.join(f,m):this.rejectBecauseOfMissingSession(g,f),f.promise}updateContentSharingSessionStateAsync(g,m,f){this.logger.info(`[${f}][updateContentSharingSessionStateAsync][sessionState=${JSON.stringify(m)}]`);const S=defer2(),v=this.contentSharingSessions[g];return v?v.updateSessionState(m,S,f):this.rejectBecauseOfMissingSession(g,S),S.promise}takeContentSharingControlAsync(g,m){this.logger.info(`[${m}][takeContentSharingControlAsync]`);const f=defer2(),S=this.contentSharingSessions[g];return S?S.takeControl(f,m):this.rejectBecauseOfMissingSession(g,f),f.promise}updateContentSharingParticipantStateAsync(g,m){this.logger.info(`[${m}][updateContentSharingParticipantStateAsync]`);const f=defer2(),S=this.contentSharingSessions[g];return S?S.updateParticipantState(f,m):this.rejectBecauseOfMissingSession(g,f),f.promise}updateContentSharingNotificationLinksAsync(g){this.logger.info(`[${g}][updateContentSharingNotificationLinksAsync]`);for(const m of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(m)){const f=this.contentSharingSessions[m];f&&f.updateNotificationLinks(g)}}getContentSharingInfoToStartSharing(){if(this.contentSharingToStartCallWith){const g=this.pendingSessionToStart,m=Hi.CONTENT_SHARING_FSM_STATE.CONTENT_SHARING_START_INITIATED;g&&g.fsmState===m||(this.contentSharingToStartCallWith=null,this.pendingSessionToStart=null)}return this.contentSharingToStartCallWith}dispose(g,m){this.logger.info(`[${m}][dispose]`);for(const f of Object.keys(this.contentSharingSessions))if(this.contentSharingSessions.hasOwnProperty(f)){const S=this.contentSharingSessions[f];S&&S.dispose(g,m)}}handleContentSharingUpdate(g){const m=g.body,f=extractCauseIdFromMessage(g),S=this.contentSharingSessions[m.contentSharingCorrelationId];S?S.handleUpdate(m,f)&&this.signalingSessionCallback.onContentSharingUpdated({sessionId:m.sessionId,correlationId:m.contentSharingCorrelationId,contentIdentifier:m.identifier,presenter:m.presenter.id,subject:m.subject||null,sessionState:m.sessionState||null},f):this.logger.info(`[${f}][handleContentSharingUpdate][failed][reason=no session with correlation ID ${m.correlationId}]`)}handleAddModalitySuccess(g,m){this.logger.info(`[${m}][handleAddModalitySuccess]`);const f=this.pendingSessionToStart;f?f.handleAddModalitySuccess(g,m):this.logger.info(`[${m}][handleAddModalitySuccess]Ignoring handleAddModalitySuccess because not waiting for one`)}handleAddModalityFailure(g,m){this.logger.info(`[${m}][handleAddModalityFailure]`);const f=this.pendingSessionToStart;f?f.handleAddModalityFailure(g,m):this.logger.info(`[${m}][handleAddModalityFailure]Ignoring handleAddModalityFailure because not waiting for one`)}handleIncomingContentSharingFromRoster(g,m,f){if(this.logger.info(`[${f}] handleIncomingContentSharingFromRoster: isFullRoster ${m} content ${getPrintableObject(g)}`),("MultiPartyEndpoint"===g.type||m)&&this.lastProcessedSequenceNumber>g.sequenceNumber)return void this.logger.info(`[${f}] handleIncomingContentSharingFromRoster invalid roster current sequenceNumber ${g.sequenceNumber} lastProcessedSequenceNumber ${this.lastProcessedSequenceNumber}`);const{sessionsWithPresenters:S,sessionsWithoutPresenters:v}=this.parseContentSharingSessionsFromRoster(g);this.startSessionsFromRoster(S,f),this.stopSessionsFromRoster(v,f),this.lastProcessedSequenceNumber=g.sequenceNumber}handleContentSharingEnd(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info("handleContentSharingEnd : ",getPrintableObject(m));const S=this.contentSharingSessions[m.contentSharingCorrelationId];if(!S)return void this.logger.info("Ignoring contentSharingEnd since there is no corresponding sharing ongoing");if(!S.handleStop(m,f))return;const v={...m.contentSharingTransactionEnd};this.raiseContentSharingStopped(m.contentSharingCorrelationId,f,m.presenter.id,v)}parseContentSharingSessionsFromRoster(g){const m={},f={},S=new Set;for(const f of Object.keys(g.participants)){const v=g.participants[f];if("Delta"===g.type&&this.lastProcessedSequenceNumberForParticipant.hasOwnProperty(f)&&v.version<=this.lastProcessedSequenceNumberForParticipant[f])continue;if(v.version=v.version||-1,this.lastProcessedSequenceNumberForParticipant[f]=v.version,S.add(v.details.id),!v.endpoints)continue;const C=this.signalingSession.participantManager.localParticipant.participantId;for(const g of Object.keys(v.endpoints)){const f=v.endpoints[g],S=f?.contentSharing?.sessionInformation;"presenter"===S?.role&&(m[S.contentSharingCorrelationId]={presenterId:v.details.id,sessionInfo:S,selfEndpointIsPresenter:f.participantId===C})}}for(const g of Object.keys(this.contentSharingSessions))!m[g]&&S.has(this.contentSharingSessions[g].presenterMri)&&(f[g]=this.contentSharingSessions[g]);return{sessionsWithPresenters:m,sessionsWithoutPresenters:f}}stopSessionsFromRoster(g,m){this.logger.info(`[${m}][stopSessionsFromRoster]`);for(const f of Object.keys(g))this.logger.info(`[${m}][stopSessionsFromRoster] stopping session with correlationId ${f}`),this.stopSession(g[f],m)}stopSession(g,m){this.logger.info(`[${m}][stopSession] Stopping session ${g.sessionId}`),g.handleStopFromRoster(this.DEFAULT_STOP_REASON,m),this.raiseContentSharingStopped(g.correlationId,m)}startSessionsFromRoster(g,m){this.logger.info(`[${m}][startSessionsFromRoster]`);for(const f of Object.keys(g)){this.logger.info(`[${m}][startSessionsFromRoster]`);const S=this.contentSharingSessions[f],v=g[f];if(this.pendingSessionToStart&&this.pendingSessionToStart.correlationId===f?this.pendingSessionToStart.confirmInRoster():S&&S.confirmInRoster(),S)S&&(this.contentSharingSessions[f].presenterMri=v.presenterId,this.logger.info(`[${m}][startSessionsFromRoster]Session ${f} is already present locally`));else{if(v.selfEndpointIsPresenter){this.logger.info(`[${m}][startSessionsFromRoster]This endpoint is presenting, dont fire callback`);continue}this.logger.info(`[${m}][startSessionsFromRoster]New sharing session found. Raising ContentSharingStarted`);this.raiseContentSharingStarted(v.presenterId,v.sessionInfo,m).handleStartFromRoster(v.presenterId,m)}}}raiseContentSharingStopped(g,m,f,S){this.logger.info(`[${m}][raiseContentSharingStopped]`),this.signalingSessionCallback.onContentSharingStopped({sessionId:this.contentSharingSessions[g].sessionId,correlationId:g,endedBy:f||this.DEFAULT_STOP_ID,reason:S||this.DEFAULT_STOP_REASON},m),delete this.contentSharingSessions[g]}raiseContentSharingStarted(g,m,f){this.logger.info(`[${f}][raiseContentSharingStarted]`);const S=new gn(this.signalingSession,m.contentSharingCorrelationId,m.contentSharingSessionId,{[Hi.LINKS.CONTENT_SHARING_CONTROLLER]:m.contentSharingController});S.presenterMri=g,this.contentSharingSessions[S.correlationId]=S;const v={sessionId:m.contentSharingSessionId,correlationId:m.contentSharingCorrelationId,contentIdentifier:m.identifier,presenter:g,subject:m.subject||null,sessionState:m.sessionState||null};return this.signalingSessionCallback.onContentSharingStarted(v,f),S}rejectBecauseOfMissingSession(g,m){const f=`There is no ContentSharing session with the correlation ID ${g}`;this.logger.error(f),m&&m.reject(new Error(f))}},mn={Default:{retryIntervalsMs:[200,1e3,5e3],maxRequestAttempts:4,perRequestTimeoutMs:45e3,perAttemptTimeoutMs:15e3,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4,hedgeDelayMs:4e3},BrokerSubscribe:{retryIntervalsMs:[100,200,500],maxRequestAttempts:4,perRequestTimeoutMs:3e4,perAttemptTimeoutMs:3e4,perRequestTimeoutWithHedgingMs:45e3,perAttemptTimeoutWithHedgingMs:3e4}},fn={CallSetup:{requestHedgingCapability:["disabled"],hedgeDelayMs:4e3},Other:{requestHedgingCapability:["disabled"]},BrokerSubscribe:{requestHedgingCapability:["disabled"]}},Sn="HttpRequestDispatcherFactory";function reportTokenTelemetryData(g,m,f){m?.signalingSession?m.signalingSession.telemetryHelper?.addTokenTelemetry(g,m?.tokenTelemetryData):f?.info("[reportTokenTelemetryData] signaling session is not available, cannot send token telemetry")}function get2(g,m){const{signalingSession:f,operation:S,causeId:v,data:C,customHeaders:_={},forceFetchToken:E,tokenRequestOptions:T}=g;if(f.disposed)return Promise.reject("Session already disposed");const handleFailure=g=>{const m="string"==typeof g?new Error(g):g;throw f.signalingAgent.clientSupportsGenericTokenAPI?m.tokenError=!0:m.skypeTokenError=!0,m};let I=!1;const b={signalingSession:f,tokenTelemetryData:{}};return f.signalingAgent.authTokenManager.getToken(v,E,T,b).catch((S=>(reportTokenTelemetryData(g.requestId,b,m),!E&&isAppOnline(f)&&f.signalingAgentConfig.attemptHttpRequestWithCachedSkypetoken&&f.signalingAgent.authTokenManager.getLastToken(v)?(I=!0,Promise.resolve(f.signalingAgent.authTokenManager.getLastToken(v))):(m?.info(`[${v}] getToken failed with error ${S}`),handleFailure(S))))).then((E=>{if(f.disposed)throw new Error("token returned too late. Object is already disposed");reportTokenTelemetryData(g.requestId,b,m);const T=new Gi;if(T.set(Hi.HEADERS.CORRELATION_ID,f.correlationId),T.set(Hi.HEADERS.MESSAGE_ID,newMessageId(v)),T.set(Hi.HEADERS.CLIENT_USER_AGENT,f.signalingAgentConfig.clientInformation),f.signalingAgent.clientSupportsGenericTokenAPI){const g=f.signalingAgent.authTokenManager.getLastTokenType(v);switch(f.signalingAgentConfig.disableTokenMigrationHeader||T.set(Hi.HEADERS.TOKEN_MIGRATION,"True"),g){case 8:case 4:T.set(Hi.HEADERS.AUTHORIZATION,`${Hi.HEADERS.BEARER_KEYWORD} ${E}`),T.delete(Hi.HEADERS.SKYPE_TOKEN);break;case 1:T.set(Hi.HEADERS.SKYPE_TOKEN,E),T.delete(Hi.HEADERS.AUTHORIZATION);break;default:throw new Error(`Error in RequestBuilder. TokenType ${g} is not supported`)}}else T.set(Hi.HEADERS.SKYPE_TOKEN,E);const A=f.participantManager.localParticipant;A&&(A.ring&&T.set(Hi.HEADERS.RING,A.ring),A.region&&T.set(Hi.HEADERS.REGION,A.region),A.partition&&T.set(Hi.HEADERS.PARTITION,A.partition));const P=C&&C.payload?JSON.stringify(C.payload):null,R={headers:{...T?.getAll(),..._},payload:P,usedCachedSkypetoken:I,reporting:{serviceName:S?`${Sn}-${S}`:Sn}};return f.telemetryHelper.addNetworkOperationStarted(S),R})).catch(handleFailure)}function isAppOnline(g){const m=isTrouterAndNavigatorConnected(g.signalingAgentConfig.trouterServiceProvider);return 3===m||1===m}var vn=500,yn=1e4,Cn=4,_n=3e3,En=3;function build4(g){return new Tn(g.causeId,g.logger,g.dispatcher,g.requestType,g.url,g.request,g.attemptFailureCallback,g.authRequiredCallback,g.settings)}var Tn=class{constructor(g,m,f,S,v,C,_,E,T){this.causeId=g,this.logger=m,this.dispatcher=f,this.requestType=S,this.url=v,this.request=C,this.onRequestFailed=_,this.authRequiredCallback=E,this.settings=T,this.requestsSent=0,this.otherAttemptSuccessful=!1,this.pendingAttempts=[],this.hedgeDelayMs=_n,this.hedgeMaxParallelAttempts=En,this.stopStandardRetryTimer=()=>{this.standardRetryTimer&&(this.standardRetryTimer.stop(),this.standardRetryTimer=null)},this.stopHedgeTimer=()=>{this.hedgeTimer&&(this.hedgeTimer.stop(),this.hedgeTimer=null)},this.stopAttemptTimeoutTimer=g=>{try{g.timeoutTimer&&(g.timeoutTimer.stop(),this.logger.info("attempt timer stopped"))}catch(g){this.logger.info(`stopAttemptTimeoutTimer error ${g}`)}},this.stopRequestTimer=()=>{try{this.requestTimer&&(this.requestTimer.stop(),this.logger.info("Request timer stopped"))}catch(g){this.logger.info(`stopRequestTimer error ${g}`)}this.requestTimer=null},this.canScheduleNextAttempt=()=>{if(this.stackError===Hi.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful||this.requestsSent>=this.settings.maxRequestAttempts)return this.logger.info(`canScheduleNextAttempt stack error ${this.stackError} otherAttemptSuccessful ${this.otherAttemptSuccessful} exceeded max attempt ${this.requestsSent>=this.settings.maxRequestAttempts}`),!1;if(this.settings.enableRequestHedging){const g=this.pendingAttempts.length<this.hedgeMaxParallelAttempts;return g||this.logger.info(`canScheduleNextAttempt enableRequestHedging attempts sent: ${this.pendingAttempts.length} max attempts: ${this.hedgeMaxParallelAttempts}`),g}{const g=this.requestsSent<this.settings.retryIntervalsMs.length;return g||this.logger.info(`canScheduleNextAttempt attempts sent: ${this.requestsSent} max attempts: ${this.settings.retryIntervalsMs.length}`),g}},this.scheduleNextRequest=g=>{this.settings.enableRequestHedging?(this.logger.info("scheduleNextRequest with hedging"),this.hedgeTimer=nn.build((()=>{this.attempt(),this.canScheduleNextAttempt()&&this.scheduleNextRequest(!1)}),"HEDGE").start(this.getNextDelay(g))):(this.logger.info("scheduleNextRequest with retry"),this.standardRetryTimer=nn.build((()=>{this.attempt()}),"RETRY").start(this.getNextDelay(g)))},this.standardizeFailedRequest=(g,m)=>{let f;const S=this.logger.createChild("[standardizeFailedRequest]");try{if(this.stackError===Hi.HTTP_STACK_ERROR.REQUEST_TIMEOUT)S.info("request timed out"),f=Fi.REQUEST_TIMEOUT;else if(this.stackError===Hi.HTTP_STACK_ERROR.REQUEST_ABORTED)S.info("request aborted"),f=Fi.REQUEST_ABORTED;else if(m&&m.status===Hi.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT)S.info("request attempt timed out"),f=Fi.ATTEMPT_TIMEOUT;else if(m&&[Hi.HTTP_STACK_ERROR.ATTEMPT_ABORTED,Hi.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL].indexOf(m.status)>-1)S.info("request attempt aborted"),f=Fi.ATTEMPT_ABORTED;else if(g){if(S.info(`request ${safeJsonStringify(g)}`),"function"==typeof XMLHttpRequest&&g instanceof XMLHttpRequest)f=g;else if("function"==typeof XMLHttpRequest&&g&&g.request instanceof XMLHttpRequest){const m=g;f={response:{...m?.request?.response,headers:m.response?.headers},status:m.request.status,statusText:m.request.statusText,readyState:m.request.readyState}}else g.status||g.statusCode||g.response?f={response:g.response,status:[void 0,null,""].indexOf(g.status)>-1?g.statusCode:g.status,statusText:g.statusText,readyState:g.readyState}:(S.info("Local http stack error"),f={response:Hi.CALL_END_SUB_CODE.LOCAL_HTTP_STACK_ERROR,status:Hi.CALL_END_CODE.LOCAL_HTTP_STACK_ERROR,statusText:"LocalHTTPStackError",readyState:g.readyState||0});this.isBrowserOffline()&&0===f.status&&4===f.readyState&&(S.info("offline"),f={response:Hi.HTTP_STACK_ERROR.CANNOT_CONNECT,status:Hi.HTTP_STATUS_CODES.OFFLINE,statusText:"offline",readyState:f.readyState}),g.response&&g.response.message&&(g.response.message.operationFailure||g.response.message.broadcastOperationFailure)?f={response:g.response.message}:!g.response&&g.body&&g.body.operationFailure&&(f={response:g.body})}else S.info("no response"),f={response:Hi.HTTP_STACK_ERROR.NONE,status:Hi.HTTP_STATUS_CODES.OTHER,statusText:"Empty Response",readyState:0}}catch(g){S.info(`Failed to handle error ${g}`),f={response:"",status:Hi.HTTP_STATUS_CODES.OTHER,statusText:"FailedToHandleError",readyState:0}}return f},this.hasPendingAttempts=()=>this.pendingAttempts.some((g=>g.pending)),this.getRequestFromStatus=g=>g&&g.request&&g.request.status||0,this.isBrowserOffline=()=>navigator&&!1===navigator.onLine,this.logger=m.createChild(`[${this.causeId}][Dispatcher]`),this.logger.info(`created request, url=${v}`),!isNaN(this.settings.hedgeDelayMs)&&this.settings.hedgeDelayMs>=vn&&this.settings.hedgeDelayMs<=yn&&(this.hedgeDelayMs=this.settings.hedgeDelayMs),!isNaN(this.settings.hedgeMaxParallelAttempts)&&this.settings.hedgeMaxParallelAttempts>=0&&this.settings.hedgeMaxParallelAttempts<=Cn&&(this.hedgeMaxParallelAttempts=this.settings.hedgeMaxParallelAttempts),(isNaN(this.settings.perAttemptTimeoutMs)||this.settings.perAttemptTimeoutMs<=0)&&(this.settings.perAttemptTimeoutMs=15e3),(isNaN(this.settings.perRequestTimeoutMs)||this.settings.perRequestTimeoutMs<=0)&&(this.settings.perRequestTimeoutMs=45e3),(isNaN(this.settings.maxRequestAttempts)||this.settings.maxRequestAttempts<=0)&&(this.settings.maxRequestAttempts=4),(isNaN(this.settings.perRequestTimeoutWithHedgingMs)||this.settings.perRequestTimeoutWithHedgingMs<=0)&&(this.settings.perRequestTimeoutWithHedgingMs=45e3),(isNaN(this.settings.perAttemptTimeoutWithHedgingMs)||this.settings.perAttemptTimeoutWithHedgingMs<=0)&&(this.settings.perAttemptTimeoutWithHedgingMs=3e4)}sendRequest(){this.stackError=Hi.HTTP_STACK_ERROR.NONE;const timeoutCallback=()=>{this.stackError=Hi.HTTP_STACK_ERROR.REQUEST_TIMEOUT,this.cancelAllAttempts(Hi.HTTP_STACK_ERROR.REQUEST_TIMEOUT)};return this.logger.info("send api called"),this.requestTimer=nn.build(timeoutCallback,"REQUEST_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perRequestTimeoutWithHedgingMs:this.settings.perRequestTimeoutMs),new Promise(((g,m)=>{this.resolve=g,this.reject=m,this.scheduleNextRequest(!0)}))}cancelRequest(){this.logger.info("cancelRequest"),this.stackError=Hi.HTTP_STACK_ERROR.REQUEST_ABORTED,this.cancelAllAttempts(Hi.HTTP_STACK_ERROR.ATTEMPT_ABORTED)}cancelOtherAttempts(g){this.pendingAttempts.splice(g-1,1),this.cancelAllAttempts(Hi.HTTP_STACK_ERROR.ABORTED_OTHER_ATTEMPT_SUCCESSFUL)}cancelAllAttempts(g){this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.pendingAttempts.forEach((m=>{m.status=g,m.cancelDeferred.resolve(),this.stopAttemptTimeoutTimer(m)})),this.stopRequestTimer()}getRequestMethod(g){switch(g){case 0:return this.dispatcher.getAsync.bind(this.dispatcher);case 1:return this.dispatcher.postAsync.bind(this.dispatcher);case 2:return this.dispatcher.putAsync.bind(this.dispatcher);case 3:return this.dispatcher.removeAsync.bind(this.dispatcher);default:return null}}async queueAttempt(g){const m=g&&this.isNotRetryable(g);if(this.logger.info("queueAttempt"),m||!this.canScheduleNextAttempt())return this.logger.info(`unable to retry isNotRetryable ${m} ${JSON.stringify(g)}`),this.stopHedgeTimer(),this.stopRequestTimer(),void(this.hasPendingAttempts()||(this.settings.reportPreviousErrorsForTimeout&&g===Fi.ATTEMPT_TIMEOUT&&this.previousAttempt?this.reject(this.previousAttempt):this.reject(g)));if(this.isAuthFailedStatus(g)){this.logger.info("auth failed"),this.stopHedgeTimer(),this.stopStandardRetryTimer(),this.stopRequestTimer();try{const m=g?.response?.headers,f=getRequestToken(this.request?.headers),S=await this.authRequiredCallback(m,f);this.request=S}catch(m){return void this.reject(g)}}this.previousAttempt=g,this.hedgeTimer?this.logger.info("scheduleNextRequest ignored as there's already active hedge timer"):this.scheduleNextRequest(!1)}attempt(){if(this.logger.info("attempt to send request"),this.stackError===Hi.HTTP_STACK_ERROR.REQUEST_ABORTED||this.otherAttemptSuccessful)return;const g=(new Date).getTime();this.requestsSent++;const m=this.requestsSent,f=defer2();this.request.timeout=f.promise;const S={cancelDeferred:f,status:Hi.HTTP_STACK_ERROR.NONE,timeoutTimer:null,pending:!0},timeoutRequest=()=>{S.status=Hi.HTTP_STACK_ERROR.ATTEMPT_TIMEOUT,S.cancelDeferred.resolve()},v=nn.build(timeoutRequest,"ATTEMPT_TIMEOUT").start(this.settings.enableRequestHedging?this.settings.perAttemptTimeoutWithHedgingMs:this.settings.perAttemptTimeoutMs);S.timeoutTimer=v,this.pendingAttempts.push(S);this.getRequestMethod(this.requestType)(this.url,this.request).then((f=>{if(this.logger.info(`attempt successful, request response=${Zi.scrubDisplayNamesFromResponse(f)} status=${this.getRequestFromStatus(f)}`),this.otherAttemptSuccessful)throw"Other attempt succesful";if(this.stackError===Hi.HTTP_STACK_ERROR.REQUEST_ABORTED)throw"Session disposed";if(!f)throw"Invalid response";S.pending=!1,this.otherAttemptSuccessful=!0,this.stopRequestTimer(),this.stopHedgeTimer(),this.stopAttemptTimeoutTimer(S),this.cancelOtherAttempts(m),this.resolve({success:!0,request:f.request,response:f.response,attempt:this.requestsSent,attemptStartTimestamp:g,attemptResponseTimestamp:(new Date).getTime()})})).catch((m=>{S.pending=!1,this.stopAttemptTimeoutTimer(S);const f=this.standardizeFailedRequest(m,S);this.logger.info(`attempt failed, request: ${safeJsonStringify(m)} status=${f.status}`),this.onRequestFailed({abandoned:this.otherAttemptSuccessful,success:!1,request:f,attempt:this.requestsSent,attemptStartTimestamp:g,attemptResponseTimestamp:(new Date).getTime()}),this.queueAttempt(f)}))}getNextDelay(g){let m;if(g)m=0;else if(this.settings.enableRequestHedging)m=this.hedgeDelayMs;else{if(!(this.requestsSent<=this.settings.retryIntervalsMs.length))throw"Unable to get next delay";m=this.settings.retryIntervalsMs[this.requestsSent-1]}return this.logger.info(`next delay= ${m} ms`),m}isRequestWithStatus(g,m){return!!g&&m.indexOf(g.status)>-1}isNotRetryable(g){return!isRetryable(g&&g.status)}isAuthFailedStatus(g){return this.isRequestWithStatus(g,[Hi.HTTP_STATUS_CODES.UNAUTHORIZED])}},In={1:"POST",0:"GET",2:"PUT",3:"DELETE"},bn=class{constructor(g,m){this.signalingSession=g,this.callStartTime=m,this.pendingRequests={},this.sendGetRequest=g=>this.sendRequest(0,g),this.sendPostRequest=g=>this.sendRequest(1,g),this.sendPutRequest=g=>this.sendRequest(2,g),this.sendDeleteRequest=g=>this.sendRequest(3,g),this.cancelRequestIfPending=(g,m,f,S)=>{this.logger.info(`[${m}][cancelRequestIfPending]`),this.pendingRequests[g]?f?this.hasPendingRequest(g,f)&&this.cancelRequest(g,f,m,S):Object.keys(this.pendingRequests[g]).forEach((f=>this.cancelRequest(g,f,m,S))):this.logger.info(`[${m}][cancelRequestIfPending]no pending request with name=${g}`)},this.cancelAllRequests=g=>{this.logger.info(`[${g}][cancelAllRequests]`);const m=[];return Object.keys(this.pendingRequests).forEach((f=>{Object.keys(this.pendingRequests[f]).forEach((S=>{m.push(this.cancelRequest(f,S,g))}))})),Promise.all(m).catch((()=>{}))},this.hasPendingRequest=(g,m)=>!!this.pendingRequests[g]&&Boolean(m?this.pendingRequests[g][m]:this.pendingRequests[g]),this.cancelRequest=(g,m,f,S)=>{try{return this.pendingRequests[g][m].dispatcher&&this.pendingRequests[g][m].dispatcher.cancelRequest(),this.pendingRequests[g][m].aborted=!0,this.pendingRequests[g][m].errorDetails=S,this.logger.info(`[${f}][cancelRequest]Request=${g} aborted ${S?`with errorDetails ${JSON.stringify(S)}`:""}`),this.pendingRequests[g][m].requestPromise.catch((()=>{}))}catch(S){return this.logger.warn(`[${f}][cancelRequest]Unable to cancel request=${g}, requestId=${m}`),Promise.resolve()}},this.buildRequestTelemetry=(g,m,f,S)=>({name:`${In[g]}-${m.requestName}`,url:m.url,eventStart:f-this.callStartTime,trouterReady:-1,requestReady:-1,status:-1,attempts:[],rtt:-1,uid:m.requestId,causeId:m.causeId,requestDispatcherConfig:S,enableRequestHedging:this.shouldEnableRequestHedging(S)}),this.addPendingRequest=g=>(this.pendingRequests[g.requestName]||(this.pendingRequests[g.requestName]={}),this.pendingRequests[g.requestName][g.requestId]={dispatcher:null,requestPromise:null,aborted:!1},this.pendingRequests[g.requestName][g.requestId]),this.sendRequest=(g,m)=>{if(!m.url){this.logger.error(m.requestName,"Link does not exist");const g={code:Hi.CALL_END_CODE.HTTP_OTHER_ERROR,subCode:Hi.CALL_END_SUB_CODE.MISSING_REQUEST_URI,phrase:`Link does not exist for requestName: ${m.requestName}.`};return Promise.reject(g)}m.requestId||(m.requestId=newGuid()),m.causeId||(m.causeId=causeId2());const f=this.logger.createChild(`[${m.causeId}][${m.requestName}]`);f.info("[scheduled]");const S=this.getInternalHttpDispatcherConfig(m.requestName,m.operationType);let v;m.skipHttpTelemetry||(m.skipHttpTelemetry=!1);const C=build3(),_=(new Date).getTime(),E=[],T=this.buildRequestTelemetry(g,m,_,S),updateRequestTelemetry=()=>{this.signalingSession.disposed?this.logger.info("Unable to record telemetry, session disposed"):this.signalingSession.telemetryHelper.updateNetworkRequest(T)},deleteRequestTelemetry=()=>{this.signalingSession.telemetryHelper.deleteNetworkRequest(T)};updateRequestTelemetry();const logRequestAttempt=(g,S)=>{if(!g||!g.request)return void this.logger.warn(m.requestName,"missing request details, unable to record for telemetry!");f.info(`[finished][status=${g.request.status}][statusText=${g.request.statusText}][retryCount=${g.attempt}]`);const v={status:g.request.status,start:g.attemptStartTimestamp-_,end:g.attemptResponseTimestamp-_,online:isTrouterAndNavigatorConnected(this.signalingSession.signalingAgentConfig.trouterServiceProvider)};g.abandoned&&(v.abandoned=!0),g.request.statusText&&(v.statusText=g.request.statusText),(S||-1===T.status)&&(T.status=g.request.status),T.attempts.push(v),updateRequestTelemetry()};if(this.hasPendingRequest(m.requestName,m.requestId))return this.logger.warn(m.requestName,m.requestId,"is already pending request!!"),this.pendingRequests[m.requestName][m.requestId].requestPromise;v=this.addPendingRequest(m);const recordTelemetryAndCleanup=(g,S,v,_)=>{if(g&&m.skipHttpTelemetry)return this.logger.info("Skipping telemetry"),void deleteRequestTelemetry();f.info(`[steps=${E}]`),this.pendingRequests[m.requestName][m.requestId].aborted&&(T.aborted=!0),this.hasPendingRequest(m.requestName,m.requestId)?(delete this.pendingRequests[S][v],Object.keys(this.pendingRequests[S]).length||delete this.pendingRequests[S]):this.logger.warn("Unable to clean up!"),this.signalingSession.disposed||(_&&(T.error=_),T.rtt=C.duration(),this.signalingSession.telemetryHelper.addNetworkOperationCompleted(m.requestName,g,C.duration()),updateRequestTelemetry(),this.signalingSession.telemetryHelper.sendHttpTelemetryData(T.uid))},checkIfNotDisposed=g=>(...S)=>{if(this.signalingSession.disposed){const g=`[${m.causeId}][${m.requestName}][failed][reason=Session disposed]`;throw f.info("[failed][reason=Session disposed]"),new Error(g)}if(this.hasPendingRequest(m.requestName,m.requestId)&&this.pendingRequests[m.requestName][m.requestId].aborted){let g;const S=`[${m.causeId}][${m.requestName}][failed][reason=request already aborted]`,v=this.pendingRequests[m.requestName][m.requestId].errorDetails;throw v?(g=v,g.phrase=S):g=S,f.info(`${S}`),new Error(JSON.stringify(g))}return g(...S)},I=checkIfNotDisposed((()=>(E.push("[waitForTrouter]"),m.withoutTrouter?Promise.resolve():this.signalingSession.ensureMessageChannelReady(m.requestName)))),b=checkIfNotDisposed((()=>(E.push("[trouterReady]"),T.trouterReady=C.duration(),m.onceTrouterReady&&m.onceTrouterReady(),updateRequestTelemetry(),Promise.resolve()))),A=checkIfNotDisposed((()=>{const f=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,S=getTokenMetadata(this.signalingSession.signalingAgentConfig,f,g,m,!1,void 0,this.logger);return E.push("[buildRequest]"),get2({signalingSession:this.signalingSession,operation:m.requestName,data:m.payload,customHeaders:m.customHeaders?.getAll(),causeId:m.causeId,tokenRequestOptions:S,requestId:m.requestId},this.logger)})),P=checkIfNotDisposed((g=>{E.push("[failedToBuildRequestOptions]");const m={request:{status:Hi.HTTP_STATUS_CODES.OTHER,statusText:"Local error"},attempt:1,success:!1,attemptResponseTimestamp:(new Date).getTime(),attemptStartTimestamp:(new Date).getTime()};return g&&(g.skypeTokenError?m.request={status:Hi.HTTP_STATUS_CODES.SKYPE_TOKEN_ERROR,statusText:"Failed to fetch skypetoken"}:g.tokenError&&(m.request={status:Hi.HTTP_STATUS_CODES.OTHER,statusText:"Failed to fetch token"})),logRequestAttempt(m,!1),Promise.reject(g)})),R=checkIfNotDisposed((g=>(E.push("[requestBuilt]"),T.requestReady=C.duration(),g.usedCachedSkypetoken&&(T.usedCachedSkypetoken=g.usedCachedSkypetoken),updateRequestTelemetry(),Promise.resolve(g)))),authRequiredCallback=(f,S)=>{E.push("[authRequired]");const v=this.signalingSession.signalingAgent.clientSupportsGenericTokenAPI,C=getTokenMetadata(this.signalingSession.signalingAgentConfig,v,g,m,!0,f,this.logger);return C.invalidToken=S,get2({signalingSession:this.signalingSession,operation:m.requestName,data:m.payload,customHeaders:m.customHeaders?.getAll(),causeId:m.causeId,forceFetchToken:!0,tokenRequestOptions:C,requestId:m.requestId},this.logger)},w=checkIfNotDisposed((f=>{E.push("[sendRequest]");const C={...S,enableRequestHedging:this.shouldEnableRequestHedging(S),hedgeDelayMs:S.hedgeDelayMs,hedgeMaxParallelAttempts:this.signalingSession.signalingAgentConfig.hedgeMaxParallelAttempts,retryIntervalsMs:m.disableRetry||!S.retryIntervalsMs?[]:S.retryIntervalsMs,reportPreviousErrorsForTimeout:this.signalingSession.signalingAgentConfig.reportPreviousErrorsForTimeout},_=build4({logger:this.logger,causeId:m.causeId,dispatcher:this.signalingSession.signalingAgentConfig.httpRequestDispatcher,url:m.url,request:f,requestType:g,authRequiredCallback:authRequiredCallback,attemptFailureCallback:g=>{logRequestAttempt(g,!1)},settings:C});return v.dispatcher=_,updateRequestTelemetry(),_.sendRequest()})),M=checkIfNotDisposed((async g=>(logRequestAttempt(g,!0),f.info("[success]"),recordTelemetryAndCleanup(!0,m.requestName,m.requestId),g))),onFailure=g=>{const S=getPrintableObject(g);return recordTelemetryAndCleanup(!1,m.requestName,m.requestId,S),!g||g.readyState||g.status?f.info(`[failed][reason=${S}]`):f.info(`[failed][offline][reason=${S}]`),Promise.reject(g)},D=Promise.resolve().then(I).then(b).then(A).catch(P).then(R).then(w).then(M).catch(onFailure);return v.requestPromise=D,D},this.logger=this.signalingSession.logger.createChild("[HTTP]")}getInternalHttpDispatcherConfig(g,m="Other"){let f={...mn.Default,...fn[m],...mn[g]};return this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap&&(f={...f,...this.signalingSession.signalingAgentConfig.operationTypeHttpDispatcherConfigMap[m]}),this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap&&(f={...f,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap.Default,...this.signalingSession.signalingAgentConfig.requestTypeHttpDispatcherConfigMap[g]}),this.logger.info(`getInternalHttpDispatcherConfig request type: ${g} config: ${safeJsonStringify(f)}`),f}shouldEnableRequestHedging(g){return!!(this.signalingSession.getMeetingInfo()&&g.requestHedgingCapability.indexOf("enabledForMeetings")>-1)||(!this.signalingSession.multiParty&&g.requestHedgingCapability.indexOf("enabledForP2PCalls")>-1||(!!(this.signalingSession.multiParty&&g.requestHedgingCapability.indexOf("enabledForGroupCalls")>-1)||g.requestHedgingCapability.indexOf("enabled")>-1))}};function getPayload8(g,m,f){assertNotNull(g,"signalingSession cannot be null");let S=[];f&&(S=getMediaTypes(f),g.telemetryHelper.addOutgoingModalities(S));const v=causeId2();return{payload:{mediaNegotiation:{callModalities:S,sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},links:{mediaAnswer:get(g,Vi.MEDIA_ANSWER,v),rejection:get(g,Vi.MEDIA_REJECTION,v)},mediaContent:m}}}}function getPayload9(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{mediaNegotiationFailure:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},code:m.code,subCode:m.subCode,phrase:m.phrase},debugContent:{callId:g.correlationId,endpointId:g.participantManager.localParticipant.endpointId}}}}function getPayload10(g,m,f){assertNotNull(g,"signalingSession cannot be null");let S=[];return f&&(S=getMediaTypes(f),g.telemetryHelper.addOutgoingModalities(S)),{payload:{mediaAnswer:{callModalities:S,sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},links:{mediaAcknowledgement:get(g,Vi.MEDIA_ACKNOWLEDGEMENT)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m},debugContent:{callId:g.correlationId,endpointId:g.participantManager.localParticipant.endpointId}}}}var An=class{constructor(g,m,f){this.telemetryHelper=f,this.vbssInitiated=!1,this.disposed=!1,this.fsmState=Hi.MEDIA_RENEGOTIATION_FSM_STATE.IDLE,this.fsmStateCauseId="",this.links={},this.renegotiationOffersSeenSoFar=[],this.isOutgoingRenegotiationInProgress=()=>this.fsmState===Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION||this.fsmState===Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.isIncomingRenegotiationInProgress=()=>this.fsmState===Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION||this.fsmState===Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,this.acceptRenegotiationAsync=(g,m,f)=>{this.logger.info(`[${f}][acceptRenegotiationAsync][mediaTypes=${m}]`),this.signalingSession.telemetryHelper.recordEvent(Wi.ACCEPT_RENEGOTIATION,{mediaTypes:m,causeId:f}),assertNotNullOrEmpty(this.links[Hi.LINKS.MEDIA_ANSWER],"MediaAnswer link not set");const S=defer2();switch(this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,f);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,f);break;default:return this.logger.info(`[${f}][acceptRenegotiationAsync]there is no incoming media renegotiation offer to accept`),S.reject(new Error("there is no incoming media renegotiation offer to accept")),S.promise}const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT,this.handleMediaAnswerAcknowledgmentTimeout.bind(this,f),Hi.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_ACKNOWLEDGEMENT_TIMEOUT)};return this.signalingSession.http.sendPostRequest({url:this.links[Hi.LINKS.MEDIA_ANSWER],payload:getPayload10(this.signalingSession,g,m),requestName:qi.SEND_MEDIA_ANSWER.name,onceTrouterReady:onceTrouterReady,causeId:f}).then((g=>{S.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${f}][acceptRenegotiationAsync] error: ${getPrintableObject(m)}`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),S.reject(new Error(`acceptRenegotiationAsync failed because : ${getPrintableObject(g)}`))})),S.promise},this.startRenegotiationAsync=(g,m,f,S)=>{this.logger.info(`[${S}][startRenegotiationAsync][mediaTypes=${f}]`),this.signalingSession.telemetryHelper.recordEvent(Wi.START_RENEGOTIATION,{causeId:S,mediaTypes:f}),assertNotNullOrEmpty(m,"MediaRenegotiation link not set");const v=defer2();switch(this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,S);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:case Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.logger.info(`[${S}][startRenegotiationAsync][failed] can only be performed with no current outstanding renegotiations, previous negotiation causeId=${this.fsmStateCauseId}`),this.signalingSessionCallback.onMediaRenegotiationRejection(this.getGlareError(),S),Promise.resolve(null);default:return this.logger.info(`[${S}][startRenegotiationAsync][failed] can only be performed on an established call`),v.reject(new Error("media renegotiation can only be performed on an established call")),v.promise}const C=f&&arrayContains(f,Hi.MEDIA_TYPES.SCREEN_SHARER);C?(this.vbssInitiated=!0,this.signalingSession.telemetryHelper.addVbssOperations(zi.VBSS_OPERATION.START)):!C&&this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(zi.VBSS_OPERATION.STOP));const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER,this.handleMediaAnswerTimeout.bind(this),Hi.TIMEOUT_VALUES_IN_SECONDS.MEDIA_ANSWER_TIMEOUT)};return this.signalingSession.http.sendPostRequest({url:m,payload:getPayload8(this.signalingSession,g,f),requestName:qi.START_RENEGOTIATION.name,onceTrouterReady:onceTrouterReady,causeId:S}).then((g=>{v.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);if(this.logger.info(`[${S}][startRenegotiationAsync] error: ${getPrintableObject(m)}`),!this.disposed){switch(this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,S);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,S)}this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER)}v.reject(new Error(`startRenegotiationAsync failed because : ${getPrintableObject(g)}`))})),v.promise},this.handleMediaAcknowledgment=(g,m)=>{this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ACKNOWLEDGEMENT,{causeId:m}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT),this.signalingSession.saveMediaControllerLinksIfAny(g),this.signalingSession.saveUpdatedCallLinksIfAny(g),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!0,m)},this.onCallConnected=g=>{this.logger.info("onCallConnected"),this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,g)},this.handleMediaNegotiationFailure=g=>{const m=extractCauseIdFromMessage(g);this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_MEDIA_NEGOTIATION_FAILURE,g),this.handleMediaNegotiationFailureInternal(g.body.mediaNegotiationFailure,g.origin,m)},this.handleMediaAnswer=(g,m)=>{switch(this.logger.info(`[${m}][handleMediaAnswer]`),this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ANSWER,{causeId:m}),this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,m);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,m);break;default:return}this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER);let f=[];g.mediaAnswer.callModalities&&g.mediaAnswer.callModalities.length>0&&(f=getMediaTypes(g.mediaAnswer.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(f));const S={provisional:!1,renegotiation:!0,mediaTypes:f,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(g.mediaAnswer.mediaContent),mediaContent:g.mediaAnswer.mediaContent};this.signalingSession.http.sendPostRequest({url:g.mediaAnswer.links.mediaAcknowledgement,payload:null,requestName:qi.SEND_MEDIA_ACKNOWLEDGEMENT.name,causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${m}][handleMediaAnswer] error: ${getPrintableObject(f)}`),this.signalingSession.disposed||this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ANSWER_FAILED,{causeId:m})})),this.signalingSessionCallback.onAnswer(S,m)},this.handleMediaNegotiationOffer=g=>{const m=g.body,f=g.headers,S=extractCauseIdFromMessage(g);this.logger.info(`[${S}][handleMediaNegotiationOffer]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_MEDIA_OFFER,g);const v=isDuplicateMessage(f,this.renegotiationOffersSeenSoFar);switch(this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE,S),this.raiseMediaRenegotiationOffer(m,S);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,S),this.raiseMediaRenegotiationOffer(m,S);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:if(this.signalingSession&&this.signalingSession.signalingAgentConfig&&this.signalingSession.signalingAgentConfig.supportMediaRetargetWhileIncomingRenegotiation){this.raiseMediaRenegotiationOffer(m,S);break}this.rejectAndLog(S,v,m);break;default:this.rejectAndLog(S,v,m)}},this.rejectRenegotiationAsync=(g,m)=>{this.logger.info(`[${m}][rejectRenegotiationAsync]`),this.signalingSession.telemetryHelper.recordEvent(Wi.REJECT_RENEGOTIATION,{rejectionData:g,causeId:m}),assertNotNullOrEmpty(this.links[Hi.LINKS.MEDIA_REJECTION],"MediaRejection link not set");const f=g||{code:Hi.CALL_END_CODE.NOT_ACCEPTABLE_HERE,subCode:Hi.CALL_END_SUB_CODE.MEDIA_ANSWER_PROCESSING_ERROR,phrase:Hi.CALL_END_PHRASE.MEDIA_ANSWER_ERROR};switch(this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION:return this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,m),this.rejectMediaRenegotiation(this.links[Hi.LINKS.MEDIA_REJECTION],f,m);case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:return this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION,m),this.rejectMediaRenegotiation(this.links[Hi.LINKS.MEDIA_REJECTION],f,m);default:return this.logger.error(`[${m}][rejectRenegotiationAsync][failed] There is no incoming media renegotiation offer to reject`),Promise.resolve(null)}},this.handleRetargetCompleted=g=>{const m=g.body.retargetCompleted,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleRetargetCompleted][details=${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_RETARGET_COMPLETED,g,getPIISafeObject(m)),0===m.code?this.signalingSessionCallback.onReTargetCompletedSuccess(f):this.signalingSessionCallback.onReTargetCompletedFailure(m,f)},this.dispose=()=>{this.logger.info("mediaRenegotiationManager :: dispose"),this.disposed=!0},this.getGlareError=()=>({code:Hi.CALL_END_CODE.GLARE_ERROR,subCode:Hi.CALL_END_SUB_CODE.MEDIA_GLARE_ERROR,phrase:Hi.CALL_END_PHRASE.RENEGOTIATION_IN_PROGRESS,previousNegotiationCauseId:this.fsmStateCauseId}),this.handleMediaNegotiationFailureInternal=(g,m,f)=>{switch(this.logger.info(`[${f}][handleMediaNegotiationFailureInternal][failureData=${getPIISafeObject(g)}]`),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.fsmState){case Hi.MEDIA_RENEGOTIATION_FSM_STATE.OUTGOING_RENEGOTIATION:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.CALL_CONNECTED,f);break;case Hi.MEDIA_RENEGOTIATION_FSM_STATE.RENEGOTIATION_GLARE:this.setFsmState(Hi.MEDIA_RENEGOTIATION_FSM_STATE.INCOMING_RENEGOTIATION,f);break;default:return}this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(zi.VBSS_OPERATION.REJECTED)),this.signalingSession.telemetryHelper.addIncomingModalities(["Rejected"]),this.signalingSessionCallback.onMediaRenegotiationRejection({code:g.code,subCode:g.subCode,phrase:g.phrase},f)},this.signalingSession=g,this.signalingSessionCallback=m,this.logger=g.logger.createChild((()=>`[RenegotiationManager][${this.fsmState}][stateCauseId=${this.fsmStateCauseId}]`))}rejectAndLog(g,m,f){this.logger.error(`[${g}][handleMediaNegotiationOffer] Cannot handle the incoming mediaRenegotiation offer in present callstate. Either call not connected or renegotiation in progress. isDuplicateOffer=${m}`),m||this.rejectMediaRenegotiation(f.mediaNegotiation.links.rejection,this.getGlareError(),g)}setFsmState(g,m){this.fsmState=g,this.fsmStateCauseId=m,this.logger.info(`[setFsmState]state=${g}`),this.telemetryHelper.recordEvent(Wi.MEDIA_FSM_STATE_CHANGED,{state:g,causeId:m})}raiseMediaRenegotiationOffer(g,m){this.logger.info(`[${m}][raiseMediaRenegotiationOffer]`),this.links[Hi.LINKS.MEDIA_ANSWER]=g.mediaNegotiation.links.mediaAnswer,this.links[Hi.LINKS.MEDIA_REJECTION]=g.mediaNegotiation.links.rejection;let f=[];g.mediaNegotiation.callModalities&&g.mediaNegotiation.callModalities.length>0&&(f=getMediaTypes(g.mediaNegotiation.callModalities),this.signalingSession.telemetryHelper.addIncomingModalities(f),arrayContains(f,Hi.MEDIA_TYPES.SCREEN_SHARER)&&this.signalingSession.telemetryHelper.addVbssOperations(zi.VBSS_OPERATION.REMOTE_START));const S={mediaTypes:f,remoteParticipantId:this.signalingSession.getParticipantIdForOfferAnswer(g.mediaNegotiation.mediaContent),mediaContent:g.mediaNegotiation.mediaContent,renegotiation:!0};this.signalingSessionCallback.onOffer(S,m)}rejectMediaRenegotiation(g,m,f){this.logger.info(`[${f}][rejectMediaRenegotiation][rejectionData=${getPIISafeObject(m)}]`);const S=defer2();return this.signalingSession.http.sendPostRequest({url:g,payload:getPayload9(this.signalingSession,m),requestName:qi.SEND_MEDIA_REJECTION.name,causeId:f}).then((g=>{S.resolve(g.response)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${f}][rejectMediaRenegotiation] error: ${getPrintableObject(m)}`),S.reject(new Error(`rejectMediaRenegotiation failed because : ${getPrintableObject(g)}`))})),S.promise}handleMediaAnswerTimeout(g){this.logger.info(`[${g}][handleMediaAnswerTimeout]`),this.vbssInitiated&&(this.vbssInitiated=!1,this.signalingSession.telemetryHelper.addVbssOperations(zi.VBSS_OPERATION.TIMEOUT)),this.signalingSession.telemetryHelper.addIncomingModalities(["Timeout"]),this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ANSWER_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER),this.handleMediaNegotiationFailureInternal({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.MEDIA_FINAL_ANSWER_TIMEOUT,phrase:Hi.CALL_END_PHRASE.MEDIA_FINAL_ANSWER_TIMEOUT},zi.EVENT_SOURCE.LOCAL,g)}handleMediaAnswerAcknowledgmentTimeout(g){this.logger.info(`[${g}][handleMediaAnswerAcknowledgmentTimeout]`),this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ACKNOWLEDGEMENT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MEDIA_ANSWER_ACKNOWLEDGEMENT);const m={reason:"timed out waiting for Media Answer Acknowledgement"};this.signalingSessionCallback.onMediaAcknowledgementFailure(!0,m,g)}},Pn=__toESM(R),Rn=class{constructor(){this.requests={}}clear(g,m){const f=m||{code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED};Object.keys(this.requests).forEach((m=>{this.rejectOperation(m,g,f)}))}hasOperation(g){return this.requests.hasOwnProperty(g)}getAllOperations(){return this.requests}getOperation(g){return this.hasOperation(g)?this.requests[g]:null}setOperation(g,m){return!this.hasOperation(g)&&(this.requests[g]=m,!0)}rejectOperation(g,m,f){const S=new Error(m);if(f&&(S.endCode=f),this.hasOperation(g)){const m=this.requests[g].promise;delete this.requests[g],m.reject(S)}}resolveOperation(g,m){if(this.hasOperation(g)){const f=this.requests[g].promise;delete this.requests[g],f.resolve(m)}}},wn=class{constructor(g){this.logger=g,this.localAddParticipantRequests=new Rn,this.localAdmitParticipantRequests=new Rn,this.localCallMeBackRequests=new Rn,this.localRemoveParticipantEndpointRequests=new Rn,this.localRemoveParticipantRequests=new Rn,this.localUpdateParticipantInterpretationStateRequest=new Rn,this.participantIdMriMap=new Map}dispose(g,m,f){this.logger.info(`[${f}][dispose]`),this.rejectAllPendingOperations(g,m)}getAllPendingOperations(g,m){this.logger.info(`[${m}][getAllPendingOperations] ${g}`);const f=this.getOperationTable(g);return f?f.getAllOperations():null}getPendingOperation(g,m,f){this.logger.info(`[${f}][getPendingOperation] ${g} ${m}`);const S=this.getOperationTable(g);return S?S.getOperation(m):null}getRnlMri(g,m){this.logger.info(`[${m}][getRnlMri] ${g}`);for(const m of g)if(this.participantIdMriMap.has(m))return this.participantIdMriMap.get(m);return""}hasPendingOperation(g,m,f){this.logger.info(`[${f}][hasPendingOperation] ${g} ${scrubMriOrOmit(m)}`);const S=this.getOperationTable(g);return!!S&&S.hasOperation(m)}rejectPendingOperation(g,m,f,S,v){this.logger.info(`[${v}][rejectPendingOperation] ${g} ${scrubMriOrOmit(m)} reason: ${f}`);const C=this.getOperationTable(g);C&&C.rejectOperation(m,f,S)}resolvePendingOperation(g,m,f,S){this.logger.info(`[${S}][resolvePendingOperation]: ${scrubMriOrOmit(m)}`);const v=this.getOperationTable(g);v&&v.resolveOperation(m,f)}setPendingOperation(g,m,f,S){this.logger.info(`[${S}][setPendingOperation] ${g} ${scrubMriOrOmit(m)} value: ${f}`);const v=this.getOperationTable(g);if(!v)return!1;if(0===g){const g=f&&f.participant&&f.participant.participantId;g&&this.participantIdMriMap.set(g,m)}return v.setOperation(m,f)}setParticipantIdToMriMapping(g,m,f,S){S?(this.logger.info(`[${f}][setParticipantIdMriMap] ${mriOrId(g)}: ${scrubMriOrOmit(m)} clear mapping.`),this.participantIdMriMap.delete(g)):g&&m&&(this.logger.info(`[${f}][setParticipantIdMriMap] ${mriOrId(g)}: ${scrubMriOrOmit(m)}`),this.participantIdMriMap.set(g,m))}getOperationTable(g){switch(g){case 0:return this.localAddParticipantRequests;case 1:return this.localAdmitParticipantRequests;case 2:return this.localCallMeBackRequests;case 4:return this.localRemoveParticipantEndpointRequests;case 3:return this.localRemoveParticipantRequests;case 5:return this.localUpdateParticipantInterpretationStateRequest;default:return null}}rejectAllPendingOperations(g,m){this.logger.info("rejectLocalQueuedOperations"),this.localAddParticipantRequests.clear(g,m),this.localAdmitParticipantRequests.clear(g,m),this.localCallMeBackRequests.clear(g,m),this.localRemoveParticipantRequests.clear(g,m),this.localRemoveParticipantEndpointRequests.clear(g,m),this.localUpdateParticipantInterpretationStateRequest.clear(g,m)}};function getPayload11(g,m,f,S){assertNotNull(g,"signalingSession cannot be null");const v=f.groupId?{id:f.groupId}:null,C=f.threadId?{threadId:f.threadId,messageId:f.messageId||null}:null;let _=[],E={};m&&m.length>0?(_=m.map((m=>({id:m.nonMaskedId?m.nonMaskedId:m.id,assertedId:m.assertedId,displayName:m.displayName,participantId:m.participantId,replacementDetails:3===f.replacementType?g.getReplacementDetailsByParticipantLegOfCall(f.callIdToReplace,m.id,m.replacementParticipantId):void 0}))),E={addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE)}):E={addModalitySuccess:get(g,Vi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Vi.CONV_ADD_MODALITY_FAILURE)};const T={payload:{disableUnmute:f&&f.disableUnmute,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:_},participantInvitationData:f.additionalData,replacementDetails:3===f.replacementType?void 0:S,groupContext:v,groupChat:C,links:E}};return f&&f.alternateId&&(T.payload.participants.from.alternateId=f.alternateId),f?.clientScenario&&(T.payload.debugContent={clientScenario:f.clientScenario}),T}function getPayload12(g,m,f,S){assertNotNull(g,"signalingSession cannot be null");const v=m.map((g=>(assertNotNull(g,"remoteParticipant cannot be null"),{id:g.id,assertedId:g.assertedId,displayName:g.displayName,participantId:g.participantId})));return{payload:{disableUnmute:f&&f.disableUnmute,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,alternateId:f?f.alternateId:null},to:v},participantInvitationData:f.additionalData,replacementDetails:S,links:{addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE)},debugContent:{clientScenario:f.clientScenario}}}}function getPayload13(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[{id:m.id,displayName:m.displayName}]},links:{admitFailure:get(g,Vi.CONV_ADMIT_PARTICIPANT_FAILURE),admitSuccess:get(g,Vi.CONV_ADMIT_PARTICIPANT_SUCCESS)},debugContent:{causeId:f}}}}function getPayload14(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}function getPayload15(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"muteScope be null"),assertNotNull(f,"participantList cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:m,muteParticipants:f,mediaTypes:["audio"]}}}function getPayload16(g,m,f,S,v,C){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const _=g.groupId?{id:g.groupId}:null,E=S?{threadId:S,messageId:v||null}:null,T=[];return m.forEach((g=>{const m={id:g};T.push(m)})),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},invitationType:Hi.INVITATION_TYPE.NUDGE,to:T},participantInvitationData:C,groupContext:_,groupChat:E,links:{nudgeParticipantSuccess:get(g,Vi.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:get(g,Vi.CONV_NUDGE_PARTICIPANT_FAILURE)}}}}function getPayload17(g,m,f){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const S=[];return m.forEach((g=>{const m={id:g};S.push(m)})),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},invitationType:Hi.INVITATION_TYPE.NUDGE,to:S},participantInvitationData:f,links:{nudgeParticipantSuccess:get(g,Vi.CONV_NUDGE_PARTICIPANT_SUCCESS),nudgeParticipantFailure:get(g,Vi.CONV_NUDGE_PARTICIPANT_FAILURE),addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE)}}}}function getPayload18(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{transactionEnd:m}}}function getPayload19(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:f,toEndpoints:[{id:m.id,endpointId:m.endpointId}]},links:{removeParticipantSuccess:get(g,Vi.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:get(g,Vi.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function getPayload20(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"remoteParticipant cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},to:[{id:m.id,displayName:m.displayName}]},links:{removeParticipantSuccess:get(g,Vi.CONV_REMOVE_PARTICIPANT_SUCCESS),removeParticipantFailure:get(g,Vi.CONV_REMOVE_PARTICIPANT_FAILURE)}}}}function getPayload21(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaTypes:["audio"]}}}function getPayload22(g,m,f,S=""){assertNotNull(f&&"specified"===f,"Only non-null non-empty scope of 'specified' is supported."),assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"participantsIds cannot be null");const v=[];return m.forEach((g=>{const m={id:g,meetingRole:S};v.push(m)})),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:f,to:v}}}function getUpdateParticipantInterpretationStatePayload(g,m,f){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"options cannot be null");return{payload:{from:{id:g.participantManager.localParticipant.id},to:m,links:{updateParticipantInterpretationStateStatus:get(g,Vi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS)},operationId:f}}}var Mn=__toESM(R),Dn=class{constructor(g,m){this.participantManager=g,this.logger=m,this.setStaleCheckForFullRoster=g=>{this.checkStaleRosterFromFull=g},this.handleRosterUpdate=(g,m,f,S)=>{if("Delta"===g.type||"MultiPartyEndpoint"===g.type){if(void 0===g.sequenceNumber&&(g.sequenceNumber=this.lastRosterUpdateSeqNumber),this.logger.info(`[${S}][handleRosterUpdate][sequenceNumber=${g.sequenceNumber}]`),this.rostersInLifetime.add(g.sequenceNumber),"Delta"===g.type)this.logger.info(`[${S}][handleRosterUpdate], RosterType: Delta, isFullRoster: ${f}`),this.handleDeltaRoster(g,f,m,S);else{if(this.logger.info(`[${S}][handleRosterUpdate], RosterType: MultiPartyEndpoint`),this.isRosterStale(g,S))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Wi.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:g.sequenceNumber,causeId:S}),void this.logger.info(`[${S}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const f of Object.keys(g.participants)){const v=ji.fromRoster(g.participants[f]);this.handleRosterParticipant(v,m,S)}this.checkForRemovedParticipants(m,g.participants,S),this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,S)}if(g.sequenceNumber>this.lastRosterUpdateSeqNumber){this.checkStaleRosterFromFull&&this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,S),this.lastRosterUpdateSeqNumber=g.sequenceNumber,this.firstRosterUpdateSeqNumber<0&&(this.firstRosterUpdateSeqNumber=this.lastRosterUpdateSeqNumber);const m=Object.keys(g.participants||0).length;this.participantCountInFirstRoster<0&&(this.participantCountInFirstRoster=m),this.maxConcurrentParticipantsDuringLeg=Math.max(this.maxConcurrentParticipantsDuringLeg,m)}this.recordTelemetry(g,f,S),this.participantManager.signalingSessionCallback.onRosterHandlingComplete()}else this.logger.warn(`[${S}][handleRosterUpdate][sequenceNumber=${g.sequenceNumber}] invalid roster type ${g.type}`)},this.isRosterStaleFromFull=(g,m)=>!!this.checkStaleRosterFromFull&&(this.logger.info(`[${m}][isRosterStale] ${g.sequenceNumber<this.lastFullRosterSeqNumber}`),g.sequenceNumber<this.lastFullRosterSeqNumber),this.isRosterStale=(g,m)=>(this.logger.info(`[${m}][isRosterStale] ${g.sequenceNumber<this.lastRosterUpdateSeqNumber}`),g.sequenceNumber<this.lastRosterUpdateSeqNumber),this.updateLocalParticipantFromSubscribe=(g,m)=>{this.logger.info(`[${m}][updateLocalParticipantFromSubscribe]`),this.updateLocalParticipant(g,m)},this.handleParticipantAcceptedBy=(g,m,f)=>{const S=m.hasOwnProperty(g.id),v=g.id===g.acceptedBy.id;this.logger.info(`[${f}][RosterManager::handleParticipantAcceptedBy] oldParticipantInRoster: ${S}`);this.participantManager.participantOperationHandler.setParticipantIdToMriMapping(g.participantId,g.id,f,!0),S&&!v&&this.handleRemovedDeltaRosterParticipant(new ji({id:g.id}),this.lastRosterUpdateSeqNumber,m,f)},this.lastRosterUpdateSeqNumber=-1,this.lastFullRosterSeqNumber=-1,this.firstRosterUpdateSeqNumber=-1,this.tombstoneSequence=new Map,this.latestRosterVersionForActiveParticipants=new Map,this.rostersInLifetime=new Set,this.maxConcurrentParticipantsDuringLeg=-1,this.participantCountInFirstRoster=-1,this.checkStaleRosterFromFull=!1}recordTelemetry(g,m,f){const S={participantCountInLastRoster:Object.keys(g.participants||0).length,participantCountInFirstRoster:this.participantCountInFirstRoster,sequenceNumberOfLastRoster:this.lastRosterUpdateSeqNumber,sequenceNumberOfLastFullRoster:this.lastFullRosterSeqNumber,sequenceNumberOfFirstRoster:this.firstRosterUpdateSeqNumber,rosterType:g.type,isFullRoster:m,maxConcurrentParticipantsDuringLeg:this.maxConcurrentParticipantsDuringLeg,totalParticipantsDuringLifetimeOfLeg:this.tombstoneSequence.size+this.latestRosterVersionForActiveParticipants.size,countOfMissingNotifications:this.getMissingNotificiations()};this.logger.info(`[recordTelemetry] data ${JSON.stringify(S,null,4)}`),this.participantManager.signalingSession.telemetryHelper.recordRosterEvent(S,Wi.HANDLE_ROSTER_UPDATE,f)}getMissingNotificiations(){const g=this.lastRosterUpdateSeqNumber-this.firstRosterUpdateSeqNumber+1-this.rostersInLifetime.size;return g>0?g:0}isParticipantRosterStale(g,m){if(this.logger.info(`[isParticipantRosterStale], rosterParticipantVersion ${m}`),m){if(this.tombstoneSequence.has(g))return m<=this.tombstoneSequence.get(g);if(this.latestRosterVersionForActiveParticipants.has(g))return m<=this.latestRosterVersionForActiveParticipants.get(g)}return!1}handleDeltaRoster(g,m,f,S){if(this.logger.info(`[${S}][handleDeltaRoster] isFullRoster ${m}`),this.isRosterStaleFromFull(g,S))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Wi.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,lastFullRosterSeqNumber:this.lastFullRosterSeqNumber,sequenceNumber:g.sequenceNumber,causeId:S}),void this.logger.info(`[${S}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled full roster ${this.lastFullRosterSeqNumber}`);if(m){if(!this.checkStaleRosterFromFull&&this.isRosterStale(g,S))return this.participantManager.signalingSession.telemetryHelper.recordEvent(Wi.IGNORE_OLD_ROSTER,{lastRosterUpdateSeqNumber:this.lastRosterUpdateSeqNumber,sequenceNumber:g.sequenceNumber,causeId:S}),void this.logger.info(`[${S}][handleRosterUpdate] Ignoring old roster update: received ${g.sequenceNumber}, but already handled ${this.lastRosterUpdateSeqNumber}`);for(const m of Object.keys(f))if(!(g.participants.hasOwnProperty(m)||this.checkStaleRosterFromFull&&this.isParticipantRosterStale(m,g.sequenceNumber))){const v=new ji({id:m});this.logger.info(`[${S}][handleRosterUpdate] participant missing from delta, full roster`),this.handleRemovedDeltaRosterParticipant(v,g.sequenceNumber,f,S)}this.lastFullRosterSeqNumber=g.sequenceNumber}else if(!g||!g.participants)return void this.logger.warn(`[${S}][handleRosterUpdate] participants blob empty in delta roster`);for(const m of Object.keys(g.participants)){const v=g.participants[m];if(!this.isParticipantRosterStale(m,v.version)){let g=ji.fromRoster(v);v.state&&"active"===v.state?(this.logger.info(`[${S}][handleDeltaRoster] participant active`),this.handleRosterParticipant(g,f,S),this.tombstoneSequence.has(m)&&this.tombstoneSequence.delete(m),this.latestRosterVersionForActiveParticipants.set(m,v.version)):v.state&&"inactive"===v.state?(g=g||new ji({id:v.details.id}),this.logger.info(`[${S}][handleDeltaRoster] participant inactive`),this.handleRemovedDeltaRosterParticipant(g,v.version,f,S)):this.logger.info(`[${S}][handleDeltaRoster] unexpected participant state ${v.state}`)}}this.handleRemoveParticipantRequests(this.getActiveParticipants(g.participants),S),this.checkStaleRosterFromFull||this.participantManager.signalingSessionCallback.onParticipantCountsUpdated(g.participantCounts,S)}getRnlMri(g,m){const f=this.participantManager.participantOperationHandler;if(g){const S=this.getRnlParticipantIdsFromRoster(g,m);return f.getRnlMri(S,m)}return""}handleRemovedDeltaRosterParticipant(g,m,f,S){const v=g.id,C=this.getRnlMri(g,S);let _="";f.hasOwnProperty(v)?_=v:f.hasOwnProperty(C)&&(_=C),_&&this.handleRemovedParticipant(f,_,S),this.tombstoneSequence.set(v,m),this.latestRosterVersionForActiveParticipants.has(v)&&this.latestRosterVersionForActiveParticipants.delete(v)}handleRemovedParticipant(g,m,f){const S=this.participantManager.signalingSessionCallback,v=this.participantManager.signalingSession;!1!==g[m]&&(tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,m),this.logger.info(`[${f}][handleRemovedParticipant] ${scrubMriOrOmit(m)} removed from roster`),S.onParticipantRemoved({id:m},f),v.clearParticipantCallLinks(m))}getActiveParticipants(g){const m={};for(const f of Object.keys(g))"inactive"!==g[f].state&&(m[f]=g[f]);return m}handleRosterParticipant(g,m,f){if(!g)return void this.logger.info(`[handleRosterParticipant][${f}] rosterParticipant processing skipped because null.`);if(g.id===this.participantManager.localParticipant.id){this.updateLocalParticipant(g,f);const m=this.getLocalEndpoint(),S=!(!m?.stream&&!m?.streamLobby),v=0===this.participantManager.signalingSession.callMode;return this.logger.info(`[handleRosterParticipant][${f}] isStreaming:${S} isInitialMode:${v}`),void(S&&v?this.participantManager.signalingSession.configureStreamingMode(f):S||this.participantManager.signalingSession.setRealTimeState(1,f))}const S=this.participantManager.participantOperationHandler,v=this.participantManager.signalingSession,C=this.participantManager.signalingSessionCallback,_=g.id,E=this.getRnlMri(g,f),T=this.getRnlParticipantIdsFromRoster(g,f);v.remoteCaller&&-1!==T.indexOf(v.remoteCaller.participantId)&&(g.displayName=v.remoteCaller.displayName),tryAddNewKeyToHashTable(this.participantManager.connectedRemoteParticipantIds,g.id,!0);const I=m.hasOwnProperty(g.id),b=m.hasOwnProperty(E);(I||b)&&(m[g.id]=!1),S.hasPendingOperation(0,g.id,f)&&this.isParticipantInCall(g)?(this.logger.info(`participant ${scrubMriOrOmit(g.id)} appears in roster. Resolving AddParticipant request`),v.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,g.id),S.resolvePendingOperation(0,g.id,g,f)):E&&S.hasPendingOperation(0,E,f)&&this.isParticipantInCall(g)?(this.logger.info(`RNL participant ${scrubMriOrOmit(E)} appears in roster. Resolving AddParticipant request`),v.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,E),S.resolvePendingOperation(0,E,g,f)):S.hasPendingOperation(1,g.id,f)&&this.isParticipantInCall(g)&&(this.logger.info(`participant: ${scrubMriOrOmit(g.id)} appears in roster. Resolving AdmitParticipant request`),v.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),S.resolvePendingOperation(1,g.id,g,f));for(const m of g.endpointDetails)S.hasPendingOperation(0,m.participantId,f)&&this.isParticipantInCall(g)&&(this.logger.info(`participant ${scrubMriOrOmit(g.id)} appears in roster. Resolving AddParticipant request`),v.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,m.participantId),S.resolvePendingOperation(0,m.participantId,g,f));I?(this.logger.info(`participantIds=[${T}] updated ${scrubMriOrOmit(g.id)}`),C.onParticipantUpdated(g,f),v.setParticipantCallLinks(g)):b?(this.logger.info(`RNL participant participantIds=[${T}] removed old ${scrubMriOrOmit(E)} and added new ${scrubMriOrOmit(_)}`),C.onParticipantRemoved({id:E},f,!0),v.clearParticipantCallLinks(E),C.onParticipantJoined(g,f),v.setParticipantCallLinks(g)):S.hasPendingOperation(3,g.id,f)?this.logger.info(`participantIds=[${T}] ignored ${scrubMriOrOmit(g.id)}`):(this.logger.info(`participantIds=[${T}] joined ${scrubMriOrOmit(g.id)}`),C.onParticipantJoined(g,f),v.setParticipantCallLinks(g))}getLocalEndpoint(){return Mn.find(this.participantManager.localParticipant.endpointDetails,(g=>this.participantManager.localParticipant.endpointId===g.endpointId))}getRnlParticipantIdsFromRoster(g,m){const f=[];for(const m of g.endpointDetails)f.push(m.participantId);return this.logger.info(`[${m}][getRnlParticipantIdsFromRoster] ${JSON.stringify(f)}`),f}isParticipantInCall(g){return g.endpointDetails&&g.endpointDetails[0]&&!g.endpointDetails[0].isLobby}updateLocalParticipant(g,m){const f=this.participantManager.localParticipant,S=this.participantManager.signalingSession,v=this.participantManager.signalingSessionCallback;this.logger.info(`[${m}][updateLocalParticipant]`);let C=!1;if(g&&g.endpointDetails){const _=Mn.find(g.endpointDetails,(g=>f.endpointId===g.endpointId)),E=Mn.find(f.endpointDetails,(g=>f.endpointId===g.endpointId));C=hasStagingGroup(_),!_||!_.isLobby||E&&E.isLobby?!_||_.isLobby||E&&!E.isLobby||(C?S.telemetryHelper.recordEvent(Wi.STAGING,{causeId:m}):S.telemetryHelper.recordEvent(Wi.CONNECTED,{causeId:m})):S.telemetryHelper.recordEvent(Wi.IN_LOBBY,{causeId:m}),_?.broadcastMeetingRole&&f&&f.broadcastMeetingRole!==_.broadcastMeetingRole&&(f.broadcastMeetingRole=_.broadcastMeetingRole,S.telemetryHelper.setBroadcastMeetingRole(_.broadcastMeetingRole)),v.onMeetingGroupDetailsUpdated(_&&_.meetingGroupDetails,m)}g?.meetingRole&&S.telemetryHelper.setMeetingRole(g.meetingRole),g?.advancedMeetingRole&&S.telemetryHelper.setAdvancedMeetingRole(g.advancedMeetingRole),g?.participantType&&S.telemetryHelper.setParticipantType(g.participantType),g&&(f.endpointDetails=g.endpointDetails||[],f.acceptedBy=g.acceptedBy,f.role=g.role,f.meetingRole=g.meetingRole,f.advancedMeetingRole=g.advancedMeetingRole,f.participantType=g.participantType,f.tenantId=g.tenantId,f.isLobby=g.isLobby,f.publishedStates=g.publishedStates,f.isStaging=C,f.version=g.version,f.propertyBag=g.propertyBag,f.isIdentityMasked=g.isIdentityMasked,f.maskedIdSeqNumber=g.maskedIdSeqNumber,f.maskedId=g.maskedId,this.participantManager.localParticipant.fromRoster=!0,v.onSelfParticipantUpdated(f,m))}checkForRemovedParticipants(g,m,f){const S=this.participantManager.signalingSessionCallback,v=this.participantManager.signalingSession,C=this.participantManager.participantOperationHandler;this.logger.info(`[${f}][checkForRemovedParticipants]`);for(const m of Object.keys(g))g.hasOwnProperty(m)&&!1!==g[m]&&!C.hasPendingOperation(0,m,f)&&(tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,m),this.logger.info(`[${f}][checkForRemovedParticipants] ${scrubMriOrOmit(m)} removed from roster`),S.onParticipantRemoved({id:m},f),v.clearParticipantCallLinks(m));this.handleRemoveParticipantRequests(m,f)}handleRemoveParticipantRequests(g,m){const f=this.participantManager.signalingSession,S=this.participantManager.participantOperationHandler;this.logger.info(`handleRemoveParticipantRequests [${m}] dynamicRosterParticipants`);const v=[];Object.keys(g).forEach((m=>{const f=ji.fromRoster(g[m]);f&&f.endpointDetails&&f.endpointDetails.forEach((g=>{g.originalId&&v.push(g.originalId)}))}));const C=S.getAllPendingOperations(3,m);for(const _ of Object.keys(C))-1!==v.indexOf(_)||g.hasOwnProperty(_)||(this.logger.info(`[${m}][handleRemoveParticipantRequests] ${scrubMriOrOmit(_)} no longer appears in roster. Resolving RemoveParticipant request`),tryRemoveKeyFromHashTable(this.participantManager.connectedRemoteParticipantIds,_),f.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,_),S.resolvePendingOperation(3,_,{id:_},m))}},On=class{constructor(g,m,f){this.connectedRemoteParticipantIds={},this.disposed=!1,this.unmuteApprovalLinks={},this.setLocalParticipantId=(g,m)=>{g&&(this.logger.info(`[${m}][setLocalParticipantId][participantId=${g}]`),this.localParticipant.participantId=g,this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId))},this.setStaleCheckForFullRoster=g=>{this.rosterManager.setStaleCheckForFullRoster(g)},this.admitParticipantAsync=(g,m,f)=>{const S=`[${f}][admitParticipantAsync]`;this.logger.info(`${S}${this.piiUtils.scrubMriOrOmit(g.id)}`);const v=defer2();return this.participantOperationHandler.hasPendingOperation(1,g.id,f)?(this.logger.info(`${S}there is an existing pending request to admit the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),v.reject(new Error("there is an existing pending request to admit the participant"))):(this.participantOperationHandler.setPendingOperation(1,g.id,{participant:g,promise:v,causeId:f},f),this.sendNetworkRequestForAdmittingParticipant(g,m,f)),v.promise},this.addParticipantsAsync=(g,m,f,S,v)=>{const C=`[${v}][addParticipantsAsync]`,_=g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)));this.logger.info(`${C} remoteParticipantsIds: ${_}`);const E=[],T=[];return g.forEach((g=>{const m=defer2(),f=3===S.replacementType?g.participantId:g.id;this.connectedRemoteParticipantIds.hasOwnProperty(g.id)?(this.logger.info(`${C}the given participant is already connected to the call ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(0,f,v)?(this.logger.info(`${C}there is an existing pending request to add the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("there is an existing pending request to add the participant"))):(g.participantId||(g.participantId=newGuid(),this.logger.info(`participantId created ${g.participantId}`)),this.participantOperationHandler.setPendingOperation(0,f,{participant:g,promise:m,causeId:v},v),E.push(g)),T.push(m.promise)})),f&&this.sendNetworkRequestForAddingParticipant(E,m,S,v),T},this.nudgeParticipantsAsync=(g,m,f,S,v,C,_,E)=>(this.logger.info(`[${S}][nudgeParticipantAsync] ${this.piiUtils.scrubParticipantsList(g)}`),f?this.sendNetworkRequestForNudgingParticipants(g,m,S,v,C,_,E):Promise.reject(`[${S}][nudgeParticipantAsync] Call not started`)),this.updateMeetingRolesAsync=(g,m,f,S=causeId2())=>{const v=defer2();if(!g||g.length<1){const g=`[${S}][updateMeetingRolesAsync] participantsInfo cannot be empty or null`,m=new Error(g);m.endCode={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),v.reject(m)}else if(m)if(f){let C;"attendee"===m?C=qi.UPDATE_MEETING_ROLE_ATTENDEE.name:"presenter"===m?C=qi.UPDATE_MEETING_ROLE_PRESENTER.name:"organizer"===m?C=qi.UPDATE_MEETING_ROLE_ORGANIZER.name:v.reject(new Error(`[${S}] Invalid meetingRole value(${m})`)),this.logger.info(`[${S}][updateMeetingRolesAsync][meetingRole=${m}]`),this.signalingSession.ensureMessageChannelReady(C).then((()=>{this.sendNetworkRequestForUpdatingMeetingRoles(g,m,f,C,S,v)})).catch((g=>{const m=getPrintableObject(g);this.logger.info(`[${S}][updateMeetingRolesAsync][failed][reason=${m}]`);const f={...getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig).error};v.reject(f)}))}else{const g=`[${S}][updateMeetingRolesAsync] updateMeetingRoleUrl cannot be empty or null`,m=new Error(g);m.endCode={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),v.reject(m)}else{const g=`[${S}][updateMeetingRolesAsync] meetingRole cannot be empty or null`,m=new Error(g);m.endCode={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),v.reject(m)}return v.promise},this.updateParticipantInterpretationStateAsync=(g,m,f)=>{const S=`[${f}][updateParticipantInterpretationStateAsync]`,v=g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)));this.logger.info(`${S} remoteParticipantsIds: ${v}`);const C=[],_=[];return g.forEach((g=>{const m=defer2();this.participantOperationHandler.hasPendingOperation(5,g.id,f)?(this.logger.info(`${S}there is an existing pending request to update the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),m.reject(new Error("there is an existing pending request to update the participant"))):(this.participantOperationHandler.setPendingOperation(5,g.id,{option:g,promise:m,causeId:f},f),C.push(g)),_.push(m.promise)})),this.sendNetworkRequestToUpdateParticipantInterpretationState(C,m,g,f),_},this.callMeBackAsync=(g,m,f)=>{this.logger.info(`[${f}][callMeBackAsync] ${this.piiUtils.scrubMriOrOmit(g.id)}`);const S=defer2();return this.connectedRemoteParticipantIds.hasOwnProperty(g.id)?(this.logger.info(`the given participant is already connected to the call : ${this.piiUtils.scrubMriOrOmit(g.id)}`),S.reject(new Error("the given participant is already connected to the call"))):this.participantOperationHandler.hasPendingOperation(2,g.id,f)?(this.logger.info(`there is an existing pending request to call back the participant : ${this.piiUtils.scrubMriOrOmit(g.id)}`),S.reject(new Error("there is an existing pending request to call back the participant"))):(this.participantOperationHandler.setPendingOperation(2,g.id,{participant:g,promise:S},f),this.sendNetworkRequestForCallMeBack(g,m,f)),S.promise},this.isRosterStale=(g,m)=>this.rosterManager.isRosterStale(g,m),this.removeParticipantAsync=(g,m,f)=>{this.logger.info(`[${f}][removeParticipantAsync] ${this.piiUtils.scrubMriOrOmit(g.id)}`),assertNotNullOrEmpty(m,"correct removeParticipantUrl is not provided");const S=defer2();if(this.participantOperationHandler.hasPendingOperation(3,g.id,f))this.logger.info(`there is an existing pending request to remove the participant ${this.piiUtils.scrubMriOrOmit(g.id)}`),S.reject(new Error("there is an existing pending request to remove the participant"));else{this.participantOperationHandler.setPendingOperation(3,g.id,{participant:g,promise:S},f);const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession.telemetryHelper.recordEvent(Wi.REMOVE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(3,g.id,"timed out waiting for participant to not show up in roster",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Hi.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},f)}),Hi.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,g.id)};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload20(this.signalingSession,g),requestName:qi.REMOVE_PARTICIPANT_NONE.name,onceTrouterReady:onceTrouterReady,causeId:f}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${f}][removeParticipantAsync][failed][reason=${getPrintableObject(S)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(3,g.id,m,S.error,f))}))}return S.promise},this.removeParticipantEndpointAsync=(g,m,f,S)=>{this.logger.info(`[${S}][removeParticipantEndpointAsync] ${truncate(g.endpointId)} [endPointScope] ${f}`),assertNotNullOrEmpty(m,"correct removeParticipantUrl is not provided");const v=defer2();let C="";switch(f){case"all":C=qi.REMOVE_PARTICIPANT_OTHERS.name;break;case"specified":C=qi.REMOVE_PARTICIPANT_SPECIFIED.name;break;default:return Promise.reject(`invalid scope ${f} removeParticipantEndpointAsync`)}this.participantOperationHandler.setPendingOperation(4,g.endpointId,{participant:g,promise:v,scope:f},S);const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Wi.REMOVE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.endpointId),this.participantOperationHandler.rejectPendingOperation(4,g.endpointId,"timed out waiting for participant endpoint sync response from service",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_PARTICIPANT_REMOVAL_TIMEOUT,phrase:Hi.CALL_END_PHRASE.PARTICIPANT_REMOVAL_TIMEOUT},S))}),Hi.TIMEOUT_VALUES_IN_SECONDS.REMOVE_PARTICIPANT_TIMEOUT,g.endpointId)};return this.signalingSession.http.sendPostRequest({url:m,payload:getPayload19(this.signalingSession,g,f),requestName:C,onceTrouterReady:onceTrouterReady,causeId:S}).then((g=>{if(g.response&&g.response.code)if(-1!==[Hi.HTTP_STATUS_CODES.OK,Hi.HTTP_STATUS_CODES.CREATED].indexOf(g.response.code))this.logger.info(`[${S}][removeParticipantEndpointAsync][endPointScope] ${f} [passed][reason=${getPrintableObject(g.response)}]`),v.resolve(g.response);else{const m=new Error("invalid service response for removeParticipantEndpoint");m.endCode={code:g.response.code,subCode:g.response.subcode,phrase:g.response.reason},this.logger.info(`[${S}][removeParticipantEndpointAsync][endPointScope] ${f} [failed][reason=${getPrintableObject(g.response)}]`),v.reject(m)}v.resolve()})).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][removeParticipantEndpointAsync][endPointScope] ${f} [failed][reason=${getPrintableObject(v)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g.endpointId),this.participantOperationHandler.rejectPendingOperation(4,g.endpointId,getPrintableObject(m),v.error,S))})),v.promise},this.getParticipantsToInitiateCallWith=()=>{this.logger.info("getParticipantsToInitiateCallWith");const g=[],m=this.participantOperationHandler.getAllPendingOperations(0,causeId2());for(const f of Object.keys(m))m.hasOwnProperty(f)&&m[f]&&g.push(m[f].participant);return g},this.initializeForIncomingCall=g=>{this.logger.info("initializeForIncomingCall"),this.participantOperationHandler.dispose("incoming calls cannot add/remove participants until call is connected",null,causeId2())},this.handleAddParticipantSuccess=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAddParticipantSuccess(${m.participantInfos?"new format":"old format"})]${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADD_PARTICIPANT_SUCCESS,g),this.internalHandleCallMeBackSuccess(m,f)||this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_ADD_PARTICIPANT_SUCCESS),this.signalingSession.signalingAgentConfig.enableAddParticipantEnhancements&&this.internalHandleAcceptedByParticipants(m,f)},this.handleAddParticipantFailure=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAddParticipantFailure(${m.participantInfos?"new format":"old format"})][${getPrintableObject(m)}]`),m.modalityFailure?(this.logger.info(`[${f}][handleAddParticipantFailure][modalityFailure=${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADD_PARTICIPANT_MODALITY_FAILURE,g)):this.internalHandleAddParticipantFailure(g,f)},this.handleAdmitParticipantSuccess=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAdmitParticipantSuccess][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADMIT_PARTICIPANT_SUCCESS,g),m.participants&&this.internalHandleAdmitParticipantSuccess(g,f)},this.handleAdmitParticipantFailure=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAdmitParticipantFailure][${getPrintableObject(m)}]`),m.participants&&this.internalHandleAdmitParticipantFailure(g,f)},this.handleRemoveParticipantFailure=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleRemoveParticipantFailure][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_REMOVE_PARTICIPANT_FAILURE,g);for(const g of Object.keys(m.participants))m.participants.hasOwnProperty(g)&&this.internalHandleRemoveParticipantFailure(g,m.participants[g],f)},this.handleRemoveParticipantSuccess=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleRemoveParticipantSuccess][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_REMOVE_PARTICIPANT_SUCCESS,g)},this.handleUnmuteConfirmRequest=g=>{const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleUnmuteConfirmRequest][${getPrintableObject(m)}]`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_UNMUTE_CONFIRM,g),this.unmuteApprovalLinks[m.from.id]={approve:m.links.approveUnmute,reject:m.links.rejectUnmute},this.signalingSessionCallback.onUnmuteRequested(m.from.id,f)},this.approveUnmuteRequestAsync=(g,m)=>{this.logger.info(`[${m}][approveUnmuteRequestAsync]`);const f=defer2();return this.unmuteApprovalLinks.hasOwnProperty(g)?(this.signalingSession.ensureMessageChannelReady(qi.APPROVE_UNMUTE.name).then((()=>{this.muteUnmute(qi.APPROVE_UNMUTE.name,getPayload14(this.signalingSession),f,this.unmuteApprovalLinks[g].approve,m)})).catch((g=>{const S=getPrintableObject(g);this.logger.info(`[${m}][approveUnmuteRequestAsync][failed][reason=${S}]`),f.reject(new Error(g))})),f.promise):(f.reject(new Error("no unmute links found for given participant")),f.promise)},this.rejectUnmuteRequestAsync=(g,m,f)=>{this.logger.info(`[${m}][rejectUnmuteRequestAsync]`);const S=defer2();if(!this.unmuteApprovalLinks.hasOwnProperty(g))return S.reject(new Error("no unmute links found for given participant")),S.promise;const v=f||{code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UNMUTE_REQUEST_REJECTED,phrase:Hi.CALL_END_PHRASE.UNMUTE_REQUEST_REJECTED};return this.signalingSession.ensureMessageChannelReady(qi.REJECT_UNMUTE.name).then((()=>{this.muteUnmute(qi.REJECT_UNMUTE.name,getPayload18(this.signalingSession,v),S,this.unmuteApprovalLinks[g].reject,m)})).catch((g=>{const f=getPrintableObject(g);this.logger.info(`[${m}][rejectUnmuteRequestAsync][failed][reason=${f}]`),S.reject(new Error(g))})),S.promise},this.handleRosterUpdate=(g,m,f)=>{const S=this.getCurrentParticipantsInCallModality(!1);this.rosterManager.handleRosterUpdate(g,S,m,f)},this.updateLocalParticipantFromSubscribe=(g,m)=>{this.localParticipant.fromRoster||this.rosterManager.updateLocalParticipantFromSubscribe(g,m)},this.muteAsync=(g,m,f,S)=>{this.logger.info(`[${S}][muteAsync][muteScope=${m}]`);let v="specified";const C=[];let _=qi.MUTE_SPECIFIED;switch(m){case Hi.MUTE_SCOPE.MYSELF:_=qi.MUTE_MYSELF,C.push({id:this.localParticipant.id});break;case Hi.MUTE_SCOPE.EVERYONE_ELSE:_=this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?qi.MUTE_ALL_SYNC:qi.MUTE_ALL,v="all",f.forEach((g=>{C.push({id:g})}));break;case Hi.MUTE_SCOPE.SPECIFIED_PARTICIPANTS:assertNotNullOrEmpty(f,`[${S}]array of participantIds must be specified for SPECIFIED_PARTICIPANTS mute scope`),_=this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?qi.MUTE_SPECIFIED_SYNC:qi.MUTE_SPECIFIED,f.forEach((g=>{C.push({id:g})}));break;default:assert2(!1,`[${S}]muteScope is a required param. please pass in a valid value.`)}const E=defer2();if(m===Hi.MUTE_SCOPE.SPECIFIED_PARTICIPANTS){const g=this.areParticipantsConnectedToCall(f);if(!g.result)return E.reject(new Error(`[${S}]specified participant is not connected to call yet. Id = ${g.participant}`)),E.promise}return this.signalingSession.ensureMessageChannelReady(_.name).then((()=>{this.muteUnmute(_.name,getPayload15(this.signalingSession,v,C),E,g,S)})).catch((g=>{const m=getPrintableObject(g),f=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][muteAsync][failed][reason=${m}]`),E.reject(f)})),E.promise},this.unmuteAsync=(g,m)=>{this.logger.info(`[${m}][unmuteAsync]`);const f=defer2();return this.signalingSession.ensureMessageChannelReady(qi.UNMUTE.name).then((()=>{this.muteUnmute(this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()?qi.UNMUTE_SYNC.name:qi.UNMUTE.name,getPayload21(this.signalingSession),f,g,m,!0)})).catch((g=>{const S=getPrintableObject(g);this.logger.info(`[${m}][unmuteAsync][failed][reason=${S}]`),f.reject(new Error(g))})),f.promise},this.dispose=(g,m)=>{this.logger.info(`[${m}][dispose]`),this.disposed=!0,this.participantOperationHandler.dispose("call ended",g,m),this.signalingSession.telemetryHelper.setParticipantId(this.localParticipant.participantId)},this.internalHandleAcceptedByParticipants=(g,m)=>{if(g?.participantInfos){const f=g.participantInfos,S=this.getCurrentParticipantsInCallModality(!1);this.logger.info(`[${m}][internalHandleAcceptedByParticipants] handling participants with acceptedBy blob.`);for(const g of f)if(g?.acceptedBy){const f=g.id;this.participantOperationHandler.hasPendingOperation(0,f,m)&&(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,f),this.logger.info(`[${m}][internalHandleAcceptedByParticipants] ${this.piiUtils.scrubMriOrOmit(f)} added using a different MRI. Resolving operation.`),this.participantOperationHandler.resolvePendingOperation(0,f,void 0,m)),this.rosterManager.handleParticipantAcceptedBy(g,S,m)}}},this.internalHandleCallMeBackSuccess=(g,m)=>{let f=!1;if(g&&g.participantInfos){const S=g.participantInfos;for(const g of S){const S=g.id;this.internalHandleCallMeBackSuccessHelper(S,m)&&(f=!0)}}else if(g&&g.participants)for(const S of g.participants)this.internalHandleCallMeBackSuccessHelper(S,m)&&(f=!0);return f},this.signalingSession=g,this.signalingSessionCallback=m,this.localParticipant=f,this.localParticipant.endpointId||(this.localParticipant.endpointId=this.signalingSession.getEndpointId());const S=truncate(this.localParticipant.endpointId);this.logger=g.logger.createChild((()=>`[PM][${S}]`)),this.piiUtils=g.piiUtils,this.participantOperationHandler=new wn(g.logger.createChild((()=>`[ParticipantOperationHandler][${S}]`))),this.rosterManager=new Dn(this,g.logger.createChild((()=>`[RosterManager][${S}]`))),this.localParticipant.participantId||(this.localParticipant.participantId=newGuid()),"string"==typeof g.signalingAgentConfig.languageCode?this.localParticipant.languageId=g.signalingAgentConfig.languageCode:"function"==typeof g.signalingAgentConfig.languageCode&&(this.localParticipant.languageId=g.signalingAgentConfig.languageCode()),g.telemetryHelper.setParticipantId(this.localParticipant.participantId),g.telemetryHelper.setEndPointId(this.localParticipant.endpointId)}handleUpdateParticipantInterpretationStateCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.operationId;if(this.disposed)return void this.logger.info(`[${f}][handleUpdateParticipantInterpretationStateCompletion] ignored. Call disposed.`);S||this.logger.warn(`[${f}][handleUpdateParticipantInterpretationStateCompletion] operationId is undefined.`),this.logger.info(`[${f}][handleUpdateParticipantInterpretationStateCompletion] starts`);const v=g.body;if(v.participantInfos)for(const m of v.participantInfos)if(this.logger.info(m),this.participantOperationHandler.hasPendingOperation(5,m.participant.id,f))if(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,m.participant.id),m.transactionEnd.code===Hi.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${f}]Update participant interpretation state succeeded for: ${this.piiUtils.scrubMriOrOmit(m.participant.id)}`),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_COMPLETED,g),this.participantOperationHandler.resolvePendingOperation(5,m.participant.id,void 0,f);else{const S=m.transactionEnd.reason;this.logger.info(`[${f}]Update participant interpretation state failed for: ${this.piiUtils.scrubMriOrOmit(m.participant.id)} reason : ${getPrintableObject(S)}`);const v=this.getCallEndGivenParticipantFailure(S);this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_RESPONSE_FAILED,g,v),this.participantOperationHandler.rejectPendingOperation(5,m.participant.id,v.phrase,v,f)}}areParticipantsConnectedToCall(g){this.logger.info(`areParticipantsConnectedToCall : ${getPrintableObject(g)}`);const m=this.getCurrentParticipantsInCallModality(!0);for(const f of g)if(!m.hasOwnProperty(f))return this.logger.info(`areParticipantsConnectedToCall : returning false for :${this.piiUtils.scrubMriOrOmit(f)}`),{result:!1,participant:f};return this.logger.info("areParticipantsConnectedToCall : returning true"),{result:!0}}processUnmuteInfo(g){if(void 0===g||void 0===g.muteUnmuteResponse)return;const m=g.muteUnmuteResponse[this.localParticipant.id];if(void 0===m)return;const f=Pn.find(m,(g=>g.participantId===this.localParticipant.participantId));void 0!==f&&("success"===f.reason?this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_UNMUTE_SUCCESS,f.serverMuteVersion):this.signalingSession.telemetryHelper.recordEvent(Wi.HANDLE_UNMUTE_FAILURE,f.serverMuteVersion))}muteUnmute(g,m,f,S,v,C){assert2(2!==this.signalingSession.callMode,"mute/unmute operations are not allowed in streaming mode"),this.logger.info(`[muteUnmute][${v}][operation=${g}]`),S?(C&&this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UNMUTE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Wi.UNMUTE_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UNMUTE);const g=new Error("timed out waiting for response to request");g.endCode={code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UNMUTE_REQUEST_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UNMUTE_REQUEST_TIMEOUT},f.reject(g)}}),Hi.TIMEOUT_VALUES_IN_SECONDS.UNMUTE_TIMEOUT),this.signalingSession.http.sendPostRequest({url:S,payload:m,requestName:g,withoutTrouter:!0,causeId:v}).then((m=>{this.disposed||(g===qi.UNMUTE.name&&m.response&&this.processUnmuteInfo(m.response),this.signalingSession.isHandleUnmuteMuteFromResponseEnabled()&&(g===qi.UNMUTE_SYNC.name&&m.response&&f.resolve(m.response),g!==qi.MUTE_ALL_SYNC.name&&g!==qi.MUTE_SPECIFIED_SYNC.name||!m.response||f.resolve(m.response)),f.resolve())})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);this.logger.info(`[${v}][muteUnmute][failed][reason=${getPrintableObject(m)}]`),this.disposed||(C&&this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UNMUTE),f.reject(m.error))}))):f.reject(new Error(`[${v}][muteUnmute] cannot be performed now, the link is not yet available`))}sendNetworkRequestForUpdatingMeetingRoles(g,m,f,S,v,C){if(!f){const g=`[${v}][sendNetworkRequestForUpdatingMeetingRoles] failed because correct updateMeetingRoleUrl is not provided`;new Error(g).endCode={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),C.reject()}if(!g){const g=`[${v}][sendNetworkRequestForUpdatingMeetingRoles] failed because participants list is empty or null`,m=new Error(g);m.endCode={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_REJECTED,phrase:g},this.logger.info(g),C.reject(m)}const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE,(()=>{if(this.signalingSession&&!this.signalingSession.disposed){this.signalingSession.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_ROLE,{causeId:v}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE);const g=new Error(`[${v}] Timed out waiting for response to request`);g.endCode={code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_ROLE_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_MEETING_ROLE_TIMEOUT},C.reject(g)}}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_ROLE_TIMEOUT)};this.signalingSession.http.sendPostRequest({url:f,payload:getPayload22(this.signalingSession,g,"specified",m),requestName:S,onceTrouterReady:onceTrouterReady,causeId:v}).then((g=>{C.resolve(g.response)})).catch((g=>{const m=getPrintableObject(g);this.logger.info(`[${v}][sendNetworkRequestForUpdatingMeetingRoles] failed: ${m}`);const f=new Error(`[${v}][CS response] Forbidden request`),S=getErrorForXHRFailure(g,this.signalingSession.signalingAgentConfig);f.code=S.error.code,f.subCode=S.error.subCode,f.phrase=S.error.phrase,this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_ROLE),C.reject(f))}))}sendNetworkRequestForNudgingParticipants(g,m,f,S,v,C,_){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Wi.NUDGE_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,g?g.join():""))}),Hi.TIMEOUT_VALUES_IN_SECONDS.NUDGE_PARTICIPANT_TIMEOUT,g?g.join():"")},E=C||v?getPayload16(this.signalingSession,g,v,C,_,S):getPayload17(this.signalingSession,g,S);return this.signalingSession.http.sendPostRequest({url:m,payload:E,requestName:qi.NUDGE_PARTICIPANT.name,onceTrouterReady:onceTrouterReady,causeId:f}).then((()=>{})).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);return this.logger.info(`[${f}][sendNetworkRequestForNudgingParticipant][failed][reason=${getPrintableObject(S)}]`),this.disposed||this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.NUDGE_PARTICIPANT,g?g.join():""),Promise.reject(S.error)}))}return this.logger.info(`[${f}][sendNetworkRequestForNudgingParticipant] failed because correct nudgeParticipantUrl is not provided`),Promise.reject("Missing nudgeParticipant url")}sendNetworkRequestForAddingParticipant(g,m,f,S=causeId2()){if(m){let v=qi.ADD_PARTICIPANT.name,C=Wi.ADD_PARTICIPANT_TIMEOUT,_={};switch(f.replacementType){case 2:v=qi.ADD_PARTICIPANT_WITH_PICKUP_CODE.name,C=Wi.ADD_PARTICIPANT_WITH_PICKUP_CODE_TIMEOUT,_.unparkContent={pickupCode:f.pickupCode};break;case 1:v=qi.ADD_PARTICIPANT_WITH_REPLACES.name,C=Wi.ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT,_=this.signalingSession.getCallReplacementDetailsForCall(f.callIdToReplace,S);break;case 3:v=qi.ADD_PARTICIPANT_WITH_REPLACES.name,C=Wi.ADD_PARTICIPANT_WITH_REPLACES_TIMEOUT,_=this.signalingSession.getReplacementDetailsByParticipantLegOfCall(f.callIdToReplace,g[0].id,g[0].replacementParticipantId,S);break;default:v=qi.ADD_PARTICIPANT.name,C=Wi.ADD_PARTICIPANT_TIMEOUT,_=null}const onceTrouterReady=()=>{g.forEach((g=>{const m=3===f.replacementType?g.participantId:g.id;this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(C,{causeId:S}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,m),this.participantOperationHandler.rejectPendingOperation(0,m,"timed out waiting for participant to show up in roster",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},S))}),Hi.TIMEOUT_VALUES_IN_SECONDS.ADD_PARTICIPANT_TIMEOUT,m)}))},E=f.threadId||f.groupId?getPayload11(this.signalingSession,g,f,_):getPayload12(this.signalingSession,g,f,_);this.signalingSession.http.sendPostRequest({url:m,payload:E,requestName:v,onceTrouterReady:onceTrouterReady,causeId:S}).catch((m=>{const v=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][sendNetworkRequestForAddingParticipant] failed:${getPrintableObject(m)}`),this.disposed||g.forEach((g=>{const C=3===f.replacementType?g.participantId:g.id;this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,C),this.participantOperationHandler.rejectPendingOperation(0,C,m,v.error,S)}))}))}else this.logger.info(`[${S}][sendNetworkRequestForAddingParticipants] failed because correct addParticipantUrl is not provided`),g.forEach((g=>{const m=3===f.replacementType?g.participantId:g.id;this.participantOperationHandler.rejectPendingOperation(0,m,"correct addParticipantUrl is not provided",{code:Hi.CALL_END_CODE.LOCAL_ERROR,subCode:Hi.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Hi.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},S)}))}sendNetworkRequestToUpdateParticipantInterpretationState(g,m,f,S=causeId2()){if(m){const v=qi.UPDATE_PARTICIPANT_INTERPRETATION_STATE.name,C=Wi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,onceTrouterReady=()=>{const m={code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_TIMEOUT};g.forEach((g=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.logger.info(`[${S}][sendNetworkRequestToUpdateParticipantInterpretationState] timed out`),this.signalingSession.telemetryHelper.recordEvent(C,{causeId:S}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,g.id),this.participantOperationHandler.rejectPendingOperation(5,g.id,"timed out waiting to update particiant interpretation state",m,S))}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION_TIMEOUT,g.id)}))},_=getUpdateParticipantInterpretationStatePayload(this.signalingSession,f,S);this.signalingSession.http.sendPostRequest({url:m,payload:_,requestName:v,onceTrouterReady:onceTrouterReady,causeId:S}).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${S}][sendNetworkRequestToUpdateParticipantInterpretationState] failed:${getPrintableObject(m)}`),this.disposed||g.forEach((g=>{this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANT_INTERPRETATION_STATE_COMPLETION,g.id),this.participantOperationHandler.rejectPendingOperation(5,g.id,m,f.error,S)}))}))}else{this.logger.info(`[${S}][sendNetworkRequestToUpdateParticipantInterpretationState] failed because correct updateParticipantUrl is not provided`);const m={code:Hi.CALL_END_CODE.LOCAL_ERROR,subCode:Hi.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Hi.CALL_END_PHRASE.UPDATE_PARTICIPANT_INTERPRETATION_STATE_URL_MISSING};g.forEach((g=>{this.participantOperationHandler.rejectPendingOperation(5,g.id,"correct updateParticipantUrl is not provided",m,S)}))}}sendNetworkRequestForCallMeBack(g,m,f){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.CALL_ME_BACK,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Wi.CALL_ME_BACK_TIMEOUT,{causeId:f}),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.CALL_ME_BACK,g.id),this.participantOperationHandler.rejectPendingOperation(2,g.id,"timed out waiting for call me back success response",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},f))}),Hi.TIMEOUT_VALUES_IN_SECONDS.CALL_ME_BACK_TIMEOUT,g.id)},S={groupId:this.signalingSession.groupId,threadId:this.signalingSession.threadId,messageId:this.signalingSession.teamsMessageId};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload11(this.signalingSession,[g],S),requestName:qi.CALL_ME_BACK.name,onceTrouterReady:onceTrouterReady,causeId:f}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${f}][sendNetworkRequestForCallMeBack] failed: ${getPrintableObject(S)}`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.CALL_ME_BACK,g.id),this.participantOperationHandler.rejectPendingOperation(2,g.id,m,S.error,f))}))}else this.logger.info(`[${f}][sendNetworkRequestForCallMeBack] failed because correct addParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(2,g.id,"correct addParticipantUrl is not provided",{code:Hi.CALL_END_CODE.LOCAL_ERROR,subCode:Hi.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Hi.CALL_END_PHRASE.ADD_PARTICIPANT_URL_MISSING},f)}sendNetworkRequestForAdmittingParticipant(g,m,f){if(m){const onceTrouterReady=()=>{this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,(()=>{this.signalingSession&&!this.signalingSession.disposed&&(this.signalingSession.telemetryHelper.recordEvent(Wi.ADMIT_PARTICIPANT_TIMEOUT),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(1,g.id,"timed out waiting for participant to show up in roster",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT},f))}),Hi.TIMEOUT_VALUES_IN_SECONDS.ADMIT_PARTICIPANT_TIMEOUT,g.id)};this.signalingSession.http.sendPostRequest({url:m,payload:getPayload13(this.signalingSession,g,f),requestName:qi.ADMIT_PARTICIPANT.name,onceTrouterReady:onceTrouterReady,causeId:f}).catch((m=>{const S=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);this.logger.info(`[${f}][sendNetworkRequestForAdmittingParticipant][failed][reason=${getPrintableObject(S)}]`),this.disposed||(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g.id),this.participantOperationHandler.rejectPendingOperation(1,g.id,m,S.error,f))}))}else this.logger.info(`[${f}][sendNetworkRequestForAdmittingParticipant] failed because correct admitParticipantUrl is not provided`),this.participantOperationHandler.rejectPendingOperation(1,g.id,"correct admitParticipantUrl is not provided",{code:Hi.CALL_END_CODE.LOCAL_ERROR,subCode:Hi.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED,phrase:Hi.CALL_END_PHRASE.ADMIT_PARTICIPANT_URL_MISSING},f)}getCurrentParticipantsInCallModality(g){const m={},f=[Hi.PARTICIPANT_AUDIO_STATE.CONNECTED];return g||f.push(Hi.PARTICIPANT_AUDIO_STATE.CONNECTING,Hi.PARTICIPANT_AUDIO_STATE.RINGING),this.signalingSessionCallback.getRemoteParticipantCollection()?.forEach((g=>{f.some((m=>m===g.audioState))&&(m[g.mri]=!0)})),m}internalHandleRemoveParticipantFailure(g,m,f){if(this.participantOperationHandler.hasPendingOperation(3,g,f)){this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.REMOVE_PARTICIPANT,g),this.logger.info(`[${f}][internalHandleRemoveParticipantFailure] failed for ${this.piiUtils.scrubMriOrOmit(g)} reason ${getPrintableObject(m)}`);const S=this.getCallEndGivenParticipantFailure(m);this.participantOperationHandler.rejectPendingOperation(3,g,S.phrase,S,f)}}internalHandleCallMeBackSuccessHelper(g,m){if(this.participantOperationHandler.hasPendingOperation(2,g,m)){const f={id:g};return this.logger.info(`participant : ${this.piiUtils.scrubMriOrOmit(g)} was successfully added. Resolving CallMeBack request`),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.CALL_ME_BACK,g),this.participantOperationHandler.resolvePendingOperation(2,f.id,f,m),!0}return!1}internalHandleAddParticipantFailure(g,m=causeId2()){const f=g.body;if(f.participantInfos){f.participantInfos.forEach((f=>{const S=[f.participant.participantId],v=this.participantOperationHandler.getRnlMri(S,m)||f.participant.id;this.rejectAddParticipantFailure(v,f.transactionEnd,g,m)}))}else if(f.participants)for(const S of Object.keys(f.participants))this.rejectAddParticipantFailure(S,f.participants[S],g,m)}rejectAddParticipantFailure(g,m,f,S){const v=this.getCallEndGivenParticipantFailure(m);this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADD_PARTICIPANT_FAILURE,f,v),this.participantOperationHandler.hasPendingOperation(0,g,S)?(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADD_PARTICIPANT,g),this.logger.info(`participantAdd failed for : ${this.piiUtils.scrubMriOrOmit(g)} reason : ${getPrintableObject(m)}`),this.participantOperationHandler.rejectPendingOperation(0,g,v.phrase,v,S)):this.participantOperationHandler.hasPendingOperation(2,g,S)&&(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.CALL_ME_BACK,g),this.logger.info(`callMeBack failed for : ${this.piiUtils.scrubMriOrOmit(g)} reason : ${getPrintableObject(m)}`),this.participantOperationHandler.rejectPendingOperation(2,g,v.phrase,v,S))}internalHandleAdmitParticipantSuccess(g,m){const f=g.body;for(const g of f.participants)this.participantOperationHandler.hasPendingOperation(1,g,m)&&(this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,g),this.logger.info(`Admit participant success for : ${this.piiUtils.scrubMriOrOmit(g)}`),this.participantOperationHandler.resolvePendingOperation(1,g,void 0,m))}internalHandleAdmitParticipantFailure(g,m){const f=g.body;for(const S of Object.keys(f.participants))if(this.participantOperationHandler.hasPendingOperation(1,S,m)){this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT_PARTICIPANT,S);const v=f.participants[S];this.logger.info(`Admit participant failed for : ${this.piiUtils.scrubMriOrOmit(S)} reason : ${getPrintableObject(v)}`);const C=this.getCallEndGivenParticipantFailure(v);this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADMIT_PARTICIPANT_FAILURE,g,C),this.participantOperationHandler.rejectPendingOperation(1,S,C.phrase,C,m)}}getCallEndGivenParticipantFailure(g){let m={code:g.code,subCode:g.subCode,phrase:g.phrase,resultCategories:g.resultCategories};return g.code===Hi.CALL_END_CODE.CALL_MODALITY_FAILURE&&g.callControllerTransactionEnd?m={...g.callControllerTransactionEnd}:g.code===Hi.CALL_END_CODE.ATC_CONTROLLER_FAILURE&&g.atcControllerTransactionEnd?m={...g.atcControllerTransactionEnd}:g.code===Hi.CALL_END_CODE.CVA_CONTROLLER_FAILURE&&g.cvaControllerTransactionEnd&&(m={...g.cvaControllerTransactionEnd}),m}};function getPayload23(g,m){assertNotNull(g,"signalingSession cannot be null"),assertNotNullOrEmpty(m,"sendMessageOptions cannot be null or empty");const f=[];for(const S of m){const m=0===S.scope?"all":"specified",v=[];S.to&&Object.keys(S.to).forEach((g=>{S.to[g].participantLegIdMap?Object.keys(S.to[g].participantLegIdMap).forEach((m=>{v.push({id:g,level:S.to[g].level,endpointId:S.to[g].participantLegIdMap[m].endpointId,participantId:m})})):v.push({id:g,level:S.to[g].level})})),f.push({links:{sendMessageStatus:get(g,Vi.SEND_MESSAGE_STATUS)},operationId:S.operationId,payload:S.payload,scope:m,to:v,type:S.type})}return{payload:{from:{displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,id:g.participantManager.localParticipant.id,languageId:g.participantManager.localParticipant.languageId??"",participantId:g.participantManager.localParticipant.participantId},messageContent:f}}}function mapMriToResolveString(g,m){return`${g}-${m}`}function mapLegIdToResolveString(g,m){return`${g}-${m}`}function mapMriAndPropertyNameToResolveString(g,m,f){return`${g}_${m}_${f}`}var Nn=class{constructor(g){this.signalingSession=g,this.scopeAllOperations=new Map,this.mriOperations=new Map,this.legOperations=new Map,this.logger=g.logger.createChild((()=>"[ProxiedMessageNotificationManager]"))}sendProxiedMessageAsync(g,m,f){this.logger.createChild("sendProxiedMessageAsync",g).info(`Url: ${f}`);const S=[],v=[];for(const f of m)if(0!==f.scope){if(1===f.scope)for(const m in f.to)if("participant"===f.to[m].level){const C=mapMriToResolveString(m,f.operationId),_=defer2();this.mriOperations.set(C,_),S.push(_.promise),v.push(C),this.startTimeout(g,"participant",C)}else if("endpoint"===f.to[m].level)for(const C in f.to[m].participantLegIdMap){const m=mapLegIdToResolveString(C,f.operationId),_=defer2();this.legOperations.set(m,_),S.push(_.promise),v.push(m),this.startTimeout(g,"endpoint",m)}}else{const m=defer2();this.scopeAllOperations.set(f.operationId,m),S.push(m.promise),v.push(f.operationId),this.startTimeout(g,"all",f.operationId)}return this.sendProxiedMessageNetworkRequest(g,m,f,v),S}sendProxiedMessageNetworkRequest(g,m,f,S){const v=getPayload23(this.signalingSession,m),C=this.logger.createChild("sendProxiedMessageNetworkRequest",g);C.info(`Url: ${f}`),this.signalingSession.http.sendPostRequest({url:f,requestName:qi.SEND_PROXIED_MESSAGE.name,payload:v,causeId:g}).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingSession.signalingAgentConfig);if(C.info(`failed:${getPrintableObject(m)}`),this.signalingSession.disposed)C.info("signaling session is already disposed.");else for(const m of S){this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,m);let S=null;this.scopeAllOperations.has(m)?(S=this.scopeAllOperations.get(m),this.scopeAllOperations.delete(m)):this.mriOperations.has(m)?(S=this.mriOperations.get(m),this.mriOperations.delete(m)):this.legOperations.get(m)?(S=this.legOperations.get(m),this.legOperations.delete(m)):C.warn(`could not find resolveString:${m} to reject it.`),null!==S&&S.reject({transactionEnd:f.error,causeId:g,resolveString:m})}}))}startTimeout(g,m,f){const S=this.logger.createChild("startTimeout",g);S.info(`Creating timeout for level ${m} message with resolveString ${f}`),this.signalingSession.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,(()=>{this.signalingSession.telemetryHelper.recordEvent(Wi.SEND_MESSAGE_TIMEOUT,{causeId:g,resolveString:f}),S.info(`timed out waiting for level [${m}] message with resolveString [${f}]`),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,f);const v="all"===m?this.scopeAllOperations:"participant"===m?this.mriOperations:"endpoint"===m?this.legOperations:null;null!==v?v.has(f)?(v.get(f).reject({transactionEnd:{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.CONVERSATION_NOTIFICATION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.CONVERSATION_NOTIFICATION_TIMEOUT},causeId:g,resolveString:f}),v.delete(f)):S.warn(`Could not find resolveString [${f}] on map for ${m}. Will not reject promise.`):S.warn(`Could not find a operations map for ${m}. Will not reject promise.`)}),Hi.TIMEOUT_VALUES_IN_SECONDS.SEND_MESSAGE_COMPLETION_TIMEOUT,f)}handleProxiedMessageNotificationItem(g,m,f){if(m.info(`Message contains ${g.participantInfos?.length} participantInfos.`),0===this.scopeAllOperations.size&&0===this.mriOperations.size&&0===this.legOperations.size)return void m.info("Received statusMessage but there is no pending operation.");const S=g.operationId;if(this.scopeAllOperations.has(S)){m.info(`Scope all resolveString:${S}`),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,S);const g={transactionEnd:{code:0,subCode:0,phrase:""},causeId:f,resolveString:S};return this.scopeAllOperations.get(S).resolve(g),this.scopeAllOperations.delete(S),void this.signalingSession.telemetryHelper.recordEvent(Wi.SEND_MESSAGE_COMPLETION,{causeId:f,operationId:S,level:"all"})}for(const v of g.participantInfos){const g=0===v.transactionEnd?.code,C=mapMriToResolveString(v.participant.id,S),_=mapLegIdToResolveString(v.participant.participantId,S);if(C&&this.mriOperations.has(C)){m.info(`Scope mri resolveString:${C}`);const _={transactionEnd:v.transactionEnd,causeId:f,resolveString:C};g?this.mriOperations.get(C).resolve(_):this.mriOperations.get(C).reject(_),this.mriOperations.delete(C),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,C),this.signalingSession.telemetryHelper.recordEvent(Wi.SEND_MESSAGE_COMPLETION,{causeId:f,operationId:S,level:"mri"})}else if(_&&this.legOperations.has(_)){m.info(`Scope legId resolveString:${_}`);const C={transactionEnd:v.transactionEnd,causeId:f,resolveString:_};g?this.legOperations.get(_).resolve(C):this.legOperations.get(_).reject(C),this.legOperations.delete(_),this.signalingSession.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SEND_MESSAGE_COMPLETION,_),this.signalingSession.telemetryHelper.recordEvent(Wi.SEND_MESSAGE_COMPLETION,{causeId:f,operationId:S,level:"leg"})}else m.warn(`Could not map this participantInfo to any pending operation operationId:${S}`)}}handleProxiedMessageNotification(g){const m=extractCauseIdFromMessage(g),f=this.logger.createChild("handleProxiedMessageNotification",m);let S;S=Array.isArray(g.body?.statuses)?g.body.statuses:[g.body],f.info(`Received ${S.length} proxied message notification(s).`);for(const g of S)this.handleProxiedMessageNotificationItem(g,f,m)}};function getPayload24(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"broadcastContext cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},broadcast:m,links:{addModalitySuccess:get(g,Vi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Vi.CONV_ADD_MODALITY_FAILURE)}}}}function getPayload25(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},links:{admitAllStatus:get(g,Vi.CONV_ADMIT_ALL_STATUS)},operationId:m,debugContent:{causeId:m}}}}function getPayload26(g,m,f=!0){assertNotNull(g,"signalingSession cannot be null"),assertNotNull(m,"joinUrl cannot be null");const S={type:"Delta",rosterUpdate:get(g,Vi.CONV_ROSTER_UPDATE)},v=g.getEndpointCapabilities(),C={payload:{attach:{requireMediaContent:f,links:{end:get(g,Vi.END)},locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent()},capabilities:null,endpointCapabilities:v,additionalActions:[{input:{capabilities:null,endpointCapabilities:v,conversationRequest:{applicationType:g.participantManager.localParticipant.applicationType,roster:S,links:{conversationEnd:get(g,Vi.CONV_END),conversationUpdate:get(g,Vi.CONV_UPDATE),localParticipantUpdate:get(g,Vi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:get(g,Vi.RECEIVE_MESSAGE)}},endpointMetadata:g.endpointMetadata,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}}},name:"join",url:m,waitForResponse:!0}]}};return g.signalingAgentConfig.ecsEtag&&(C.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),C.payload.additionalActions.length>0&&g.deviceType&&"default"!==g.deviceType&&(C.payload.additionalActions[0].input.conversationRequest.deviceType=g.deviceType),C}function getPayload27(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callAcceptanceAcknowledgement:{links:{mediaRenegotiation:get(g,Vi.MEDIA_RENEGOTIATION),transfer:get(g,Vi.TRANSFER),replacement:get(g,Vi.REPLACE),balanceUpdate:get(g,Vi.BALANCE_UPDATE),retargetCompletion:get(g,Vi.RETARGET_COMPLETION),controlVideoStreaming:get(g,Vi.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:get(g,Vi.UPDATE_MEDIA_DESCRIPTIONS)}}}}}function getPayload28(g,m,f,S){assertNotNull(g,"signalingSession cannot be null");const v=getMediaTypes(f);g.telemetryHelper.addOutgoingModalities(v);const C=g.getEndpointCapabilities();return{payload:{callAcceptance:{acceptedBy:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},acceptedCallModalities:v,capabilities:null,endpointCapabilities:C,clientEndpointCapabilities:0!==S?S:null,links:{mediaRenegotiation:get(g,Vi.MEDIA_RENEGOTIATION),transfer:get(g,Vi.TRANSFER),replacement:get(g,Vi.REPLACE),balanceUpdate:get(g,Vi.BALANCE_UPDATE),retargetCompletion:get(g,Vi.RETARGET_COMPLETION),controlVideoStreaming:get(g,Vi.CONTROL_VIDEO_STREAMING),updateMediaDescriptions:get(g,Vi.UPDATE_MEDIA_DESCRIPTIONS)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m,pstnContent:g.pstnContent,callKeepAliveInterval:null}}}}function getPayload29(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callProgress:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},status:"ringing",phrase:"ringing"}}}}function getPayload30(g,m,f,S){assertNotNull(g,"signalingSession cannot be null");const v=g.participantManager.localParticipant;return{payload:{invitationRedirection:{target:{type:m,endpointType:S,id:f},sender:{id:v.id,endpointId:v.endpointId,participantId:v.participantId,languageId:v.languageId}}}}}function getPayload31(g,m,f){assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m);const S={payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,languageId:g.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Hi.CALL_END_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:m}};return f&&m.code===Hi.CALL_END_CODE.CANCEL&&(S.payload.callTransactionEnd.callQualityDiagnosticsInformation=f),S}function getPayload32(g,m,f,S){assertNotNull(g,"signalingSession cannot be null");let v=[];v=S.invitationType===Hi.INVITATION_TYPE.NUDGE&&Array.isArray(S.participantsToNudge)?S.participantsToNudge.map((g=>({id:g}))):g.participantManager.getParticipantsToInitiateCallWith(),g.signalingAgentConfig.doHostlessCalling||assert2(v.length>0,"remoteParticipants need to be set before a call can be made");const C={type:"Delta",rosterUpdate:get(g,Vi.CONV_ROSTER_UPDATE)},_=g.groupId?{id:g.groupId}:null,E=g.threadId?{threadId:g.threadId,messageId:g.teamsMessageId||null}:null,T=g.contentSharingManager.getContentSharingInfoToStartSharing(),I=null===T?null:{identifier:T.contentIdentifier,subject:T.subject,sessionState:T.sessionState,sessionUpdateSequenceNumber:T.sequenceNumber,links:{sessionUpdate:get(g,Vi.CONV_CONTENT_SHARING_UPDATE),sessionEnd:get(g,Vi.CONV_CONTENT_SHARING_END)}},b=g.broadcastSession&&g.broadcastSession.getContext(),A=g.getEndpointCapabilities();1===v.length&&g.telemetryHelper.setCalleeType(v[0].id),g.numberOfOriginalInvitees=v.length;const P=[];v.forEach((m=>{const f={id:m.id};m.displayName&&(f.displayName=m.displayName),m.participantId&&(f.participantId=m.participantId),(S.callToVoicemail||g.transferContext&&g.transferContext.target&&"voicemail"===g.transferContext.target.endpointType)&&(f.endpointType="voicemail"),P.push(f)}));const R=g.transferContext?g.transferContext.transferor:null,w=g.transferContext?g.transferContext.transferContext:null,M={};S.callToVoicemail&&(S.voicemailResourcePath&&(M.localResourcePath=S.voicemailResourcePath),S.voicemailItemId&&(M.voicemailItemId=S.voicemailItemId));const D={payload:{conversationRequest:{conversationType:S.conversationType,subject:g.convSubject,suppressDialout:S.suppressDialout,applicationType:S.applicationType,targetApplicationType:S.targetApplicationType,roster:C,properties:{allowConversationWithoutHost:g.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:g.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:g.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration},links:{conversationEnd:get(g,Vi.CONV_END),conversationUpdate:get(g,Vi.CONV_UPDATE),localParticipantUpdate:get(g,Vi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE),addModalitySuccess:get(g,Vi.CONV_ADD_MODALITY_SUCCESS),addModalityFailure:get(g,Vi.CONV_ADD_MODALITY_FAILURE),confirmUnmute:get(g,Vi.CONV_CONFIRM_UNMUTE),receiveMessage:get(g,Vi.RECEIVE_MESSAGE)}},broadcast:b,contentSharing:I,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,meetingRegistrationId:S.meetingRegistrationId,participantPin:S.participantPin},to:P},capabilities:null,endpointCapabilities:A,clientEndpointCapabilities:S.clientEndpointCapabilities?S.clientEndpointCapabilities:null,endpointMetadata:g.endpointMetadata,groupContext:_,groupChat:E,meetingInfo:g.getMeetingInfo(),meetingData:S.meetingData,meetingPreferences:S.meetingPreferences,endpointState:S.endpointState}};if(S.publishedStates?.publishedStates.length>0){let m=[];m=S.publishedStates.publishedStates.map((m=>{let f={};try{f=JSON.parse(m.content)}catch(m){g.logger.warn("createConversationRequest getPayload() failed to parse state.content")}return{stateType:m.type,level:m.level,content:f,sequenceNumber:g.getPublishStateSequenceNumber()}})),D.payload.publishedStates=m}g.deviceType&&"default"!==g.deviceType&&(D.payload.conversationRequest.deviceType=g.deviceType);const O=getMediaTypes(f);if(g.telemetryHelper.addOutgoingModalities(O),D.payload.callInvitation={callModalities:O,replaces:null,transferor:R||null,clientTransferContext:w,links:{progress:get(g,Vi.PROGRESS),mediaAnswer:get(g,Vi.MEDIA_ANSWER),acceptance:get(g,Vi.ACCEPT),redirection:get(g,Vi.REDIRECTION),end:get(g,Vi.END)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),pstnContent:g.pstnContent,emergencyContent:g.getEmergencyContent(),mediaContent:m,voicemailSettings:M,routingFlags:S.routingFlags,invitationData:S.invitationData,locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent()},S.pickupCode&&(D.payload.callInvitation.unparkContent={pickupCode:parseInt(S.pickupCode,10)}),S.onBehalfOf&&(D.payload.callInvitation.onBehalfOf={id:S.onBehalfOf},S.onBehalfOfUserDisplayName&&(D.payload.callInvitation.onBehalfOf.displayName=S.onBehalfOfUserDisplayName)),S.scenario&&(D.payload.conversationRequest.scenario=S.scenario),S.alternateId&&(D.payload.participants.from.alternateId=S.alternateId),S.invitationType===Hi.INVITATION_TYPE.NUDGE&&(D.payload.participants.invitationType=S.invitationType),g.signalingAgentConfig.ecsEtag&&(D.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),S.clientEndpointDebugContent){D.payload.debugContent||(D.payload.debugContent={});try{D.payload.debugContent.clientDebugContent=JSON.parse(S.clientEndpointDebugContent)}catch(g){assert2(!1,`Failed to parse ${S.clientEndpointDebugContent}`)}}return D}function getPayload33(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},conversationTransactionEnd:{reason:"noError",code:Hi.CALL_END_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED},callTransactionEnd:m}}}function getPayload34(g,m){return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:m}}}function getPayload35(g,m,f,S,v){assertNotNull(g,"signalingSession cannot be null");const C={type:"Delta",rosterUpdate:get(g,Vi.CONV_ROSTER_UPDATE)},_=g.getEndpointCapabilities(),E=g.groupId?{id:g.groupId}:null,T=g.threadId?{threadId:g.threadId,messageId:g.teamsMessageId||null}:null,I={payload:{conversationRequest:{conversationType:S.conversationType,subject:g.convSubject,suppressDialout:S.suppressDialout,scenario:S.scenario,applicationType:S.applicationType,roster:C,properties:{allowConversationWithoutHost:g.signalingAgentConfig.doHostlessCalling,enableGroupCallEventMessages:g.signalingAgentConfig.shouldServiceSendCallEventMessages,enableGroupCallUpgradeMessage:g.signalingAgentConfig.shouldServiceSendNGCUpgradeMessages,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration},links:{conversationEnd:get(g,Vi.CONV_END),conversationUpdate:get(g,Vi.CONV_UPDATE),localParticipantUpdate:get(g,Vi.CONV_LOCAL_PARTICIPANT_UPDATE),addParticipantSuccess:get(g,Vi.CONV_ADD_PARTICIPANT_SUCCESS),addParticipantFailure:get(g,Vi.CONV_ADD_PARTICIPANT_FAILURE),receiveMessage:get(g,Vi.RECEIVE_MESSAGE)}},groupContext:E,groupChat:T,participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,meetingRegistrationId:S.meetingRegistrationId,participantPin:S.participantPin}},capabilities:null,endpointCapabilities:_,clientEndpointCapabilities:S.clientEndpointCapabilities?S.clientEndpointCapabilities:null,endpointMetadata:g.endpointMetadata,meetingInfo:g.getMeetingInfo(),meetingData:S.meetingData,meetingPreferences:S.meetingPreferences,endpointState:S.endpointState}};if(S.publishedStates?.publishedStates.length>0){let m=[];m=S.publishedStates.publishedStates.map((m=>{let f={};try{f=JSON.parse(m.content)}catch(m){g.logger.warn("joinConversationRequest getPayload() failed to parse state.content")}return{stateType:m.type,level:m.level,content:f,sequenceNumber:g.getPublishStateSequenceNumber()}})),I.payload.publishedStates=m}if(S?.applyServerMute&&(I.payload.participants.from.applyServerMute=S.applyServerMute.value,S.applyServerMute.mediaTypes&&(I.payload.participants.from.mediaTypes=S.applyServerMute.mediaTypes)),g.deviceType&&"default"!==g.deviceType&&(I.payload.conversationRequest.deviceType=g.deviceType),!S.subscribe){const v=getMediaTypes(f);g.telemetryHelper.addOutgoingModalities(v),I.payload.callInvitation={callModalities:v,replaces:null,transferor:null,links:{progress:get(g,Vi.PROGRESS),mediaAnswer:get(g,Vi.MEDIA_ANSWER),acceptance:get(g,Vi.ACCEPT),redirection:get(g,Vi.REDIRECTION),end:get(g,Vi.END)},clientContentForMediaController:g.webRtcSignalingManager.getClientUrls(),mediaContent:m,pstnContent:g.pstnContent,locationContent:g.getLocationContent(),networkContent:g.getNetworkContent(),areaContent:g.getAreaContent(),sharedLineCallInvitationContent:S.sharedLineCallInvitationContent,invitationData:S.invitationData}}if(g.signalingAgentConfig.ecsEtag&&(I.payload.debugContent={ecsEtag:g.signalingAgentConfig.ecsEtag}),v&&(I.payload.debugContent||(I.payload.debugContent={}),I.payload.debugContent.causeId=v),S.clientEndpointDebugContent){I.payload.debugContent||(I.payload.debugContent={});try{I.payload.debugContent.clientDebugContent=JSON.parse(S.clientEndpointDebugContent)}catch(g){assert2(!1,`Failed to parse ${S.clientEndpointDebugContent}`)}}return I}function getJoinMeetingGroupPayload(g,m,f){assertNotNull(g,"signalingSession cannot be null");const{meetingGroupId:S,groupPreferences:v}=m;return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingGroup:S,...v&&{groupPreferences:v},links:{joinMeetingGroupStatus:get(g,Vi.JOIN_MEETING_GROUP_STATUS)},operationId:f}}}function getPayload36(g,m,f,S){assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m);const v={payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},scope:S&&"all"!==S?void 0:S},conversationTransactionEnd:{reason:"noError",code:Hi.CALL_END_CODE.SUCCESS,phrase:Hi.CALL_END_PHRASE.CONV_END_NO_MODALITY},callTransactionEnd:m}};return f&&m.code===Hi.CALL_END_CODE.CANCEL&&(v.payload.callTransactionEnd.callQualityDiagnosticsInformation=f),v}function getLeaveMeetingGroupPayload(g,m,f){assertNotNull(g,"signalingSession cannot be null");const{meetingGroupId:S}=m;return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingGroup:S,links:{leaveMeetingGroupStatus:get(g,Vi.LEAVE_MEETING_GROUP_STATUS)},operationId:f}}}function getPayload37(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),assertNotNull(f,"newOfferLink cannot be null"),{payload:{mediaOfferRequirements:{compatibleContentTypes:m,links:{offerReady:get(g,Vi.NEW_MEDIA_OFFER)}}}}}function getPayload38(g,m){return assertNotNull(m,"signalingSession cannot be null"),{payload:{callTransfer:{target:{id:m.participantManager.localParticipant.id},transferor:{details:{id:m.participantManager.localParticipant.id,endpointId:m.participantManager.localParticipant.endpointId,participantId:m.participantManager.localParticipant.participantId,languageId:m.participantManager.localParticipant.languageId},authorizationToken:null},parkType:g,links:{transferAcceptance:get(m,Vi.TRANSFER_ACCEPTANCE),transferCompletion:get(m,Vi.TRANSFER_COMPLETION)}}}}}function getPayload39(g,m,f){assertNotNull(g,"ParkRequestPayload: signalingSession cannot be null");const S={payload:{hold:{holdType:m,links:{holdCompletion:get(g,Vi.PARK_COMPLETION)}}}};return f&&(S.payload.debugContent=f),S}function getPayload40(g){return assertNotNull(g,"signalingSession cannot be null"),{payload:{callParticipantUpdate:{links:getLinksPayload(g,xi),clientContentForMediaController:g.webRtcSignalingManager.getClientUrls()}}}}function getPayload41(g,m,f,S,v,C){const _={payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},publishedState:{content:S,level:f,stateType:m,sequenceNumber:g.getPublishStateSequenceNumber()},scope:v}};if(C&&C.length>0){const g=C.map((g=>({id:g})));_.payload.to=g}return _}function getPayload42(g,m){return assertNotNull(g,"signalingSession cannot be null"),assertCallEndReason(m),{payload:{callEnd:m}}}function getPayload43(g,m,f,S){const v={from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},sequenceNumber:g.getPublishStateSequenceNumber(),scope:m};return"specified"===m?v.stateIds=f:v.stateType=S,{payload:v}}function getPayload44(g,m){return{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},searchOptions:m}}}function getPayload45(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},...m,links:{setMeetingLayoutStatus:get(g,Vi.SET_MEETING_LAYOUT_STATUS)}}}}function getPayload46(){return{payload:{transferAcceptance:{}}}}function getPayload47(g,m,f,S,v){assertNotNull(m,"signalingSession cannot be null"),assertNotNullOrEmpty(g,"transferTarget cannot be null OR empty");return{payload:{callTransfer:{target:{id:g,endpointType:"TransferTypeVoicemail"===S?"voicemail":void 0},transferor:{details:{id:m.participantManager.localParticipant.id,endpointId:m.participantManager.localParticipant.endpointId,participantId:m.participantManager.localParticipant.participantId,languageId:m.participantManager.localParticipant.languageId},authorizationToken:null},links:{transferAcceptance:get(m,Vi.TRANSFER_ACCEPTANCE),transferCompletion:get(m,Vi.TRANSFER_COMPLETION)},replacementDetails:f,disableForwardingAndUnanswered:v&&v.disableForwardingAndUnanswered,transferContext:v&&v.clientTransferContext}}}}function getPayload48(g){return{payload:{transferCompletion:g}}}function getPayload49(g,m){assertNotNull(g,"ResumePayload: signalingSession cannot be null");const f={payload:{resume:{links:{resumeCompletion:get(g,Vi.UNPARK_COMPLETION)}}}};return m&&(f.payload.debugContent=m),f}function getPayload50(g,m){return assertNotNull(m,"clientMetadataJson cannot be null"),{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},endpointMetadata:m}}}function getPayload51(g,m,f,S){assertNotNull(m,"clientStateJson cannot be null");const v={payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},endpointState:m}};if(f?.publishedStates.length>0){let m=[];m=f.publishedStates.map((m=>{let f={};try{f=JSON.parse(m.content)}catch(m){g.logger.warn("updateEndpointState getPayload() failed to parse stateType.content")}return{stateType:m.type,level:m.level,content:f,sequenceNumber:g.getPublishStateSequenceNumber()}})),v.payload.publishedStates=m}return S&&(v.payload.links={updateEndpointStateStatus:get(g,Vi.DISABLE_PREHEAT_ASYNC_STATUS)}),v}function getMeetingGroupsPayload(g,m,f){assertNotNull(g,"signalingSession cannot be null");const{scope:S,toGroup:v,fromGroup:C,participants:_}=m;"specified"===S&&assertNotNull(_,"participantsIds cannot be null");const E={from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},scope:S,fromGroup:C,toGroup:v,links:{updateMeetingGroupsStatus:get(g,Vi.UPDATE_MEETING_GROUPS_STATUS)},operationId:f};return _&&(E.to=_.map((g=>({id:g.mri,endpointId:g.endpointId,participantId:g.participantId})))),{payload:E}}function getPayload52(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},meetingLiveState:m,links:{updateMeetingLiveStateStatus:get(g,Vi.UPDATE_MEETING_LIVE_STATE_STATUS)},operationId:f}}}function getPayload53(g,m){const f={};return void 0!==m.allowRaiseHands&&(f.allowRaiseHands=m.allowRaiseHands),void 0!==m.attendeeRestrictions&&(f.attendeeRestrictions=m.attendeeRestrictions),void 0!==m.lockMeeting&&(f.lockMeeting=m.lockMeeting),void 0!==m.breakoutRoomsEnabled&&(f.breakoutRoomsEnabled=m.breakoutRoomsEnabled),void 0!==m.allowPresentersToManageBreakoutRooms&&(f.allowPresentersToManageBreakoutRooms=m.allowPresentersToManageBreakoutRooms),void 0!==m.disableMdpClientAudioRecording&&(f.disableMdpClientAudioRecording=m.disableMdpClientAudioRecording),void 0!==m.refreshSettings&&(f.refreshSettings=m.refreshSettings),{payload:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},meetingSettings:f,sequenceNumber:g.getPublishStateSequenceNumber()}}}function getPayload54(g){assertNotNull(g,"signalingSession cannot be null");const m={type:"Delta",rosterUpdate:get(g,Ui.CONV_ROSTER_UPDATE)};return{payload:{participants:{from:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId}},roster:m,links:getLinksPayload(g,Ui)}}}function getUpdateParticipantsPropertiesPayload(g,m,f){assertNotNull(g,"signalingSession cannot be null");return{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId},to:m,links:{updateParticipantPropertiesStatus:get(g,Vi.UPDATE_PARTICIPANT_PROPERTIES_STATUS)},operationId:f}}}function getPayload55(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{mediaAnswer:{sender:{id:g.participantManager.localParticipant.id,displayName:g.participantManager.localParticipant.displayName,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId},mediaContent:m,pstnContent:g.pstnContent}}}}function getPayload56(g,m){return assertNotNull(g,"signalingSession cannot be null"),{payload:{UpdateMediaDescriptions:{mediaDescriptions:m}}}}function getPayload57(g,m,f){return assertNotNull(g,"signalingSession cannot be null"),{payload:{from:{id:g.participantManager.localParticipant.id,endpointId:g.participantManager.localParticipant.endpointId,participantId:g.participantManager.localParticipant.participantId,languageId:g.participantManager.localParticipant.languageId,displayName:g.participantManager.localParticipant.displayName},meetingStates:m,updateMeetingStatesStatus:get(g,Vi.UPDATE_MEETING_STATES_STATUS),operationId:f}}}var kn=__toESM(R),Ln=__toESM(Te()),Fn=class{constructor(g,m){this.signalingSession=g,this.logger=m,this.logConversationCallModalityEvent=g=>{const m=this.createCallModalityEvent(g);this.logger.info("sending modality telemetry:",this.getStringifiedEventData(m)),m.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(zi.EVENT_TYPE.CONVERSATION_CALL_MODALITY,m)},this.logConversationContentSharingEvent=g=>{g[zi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,g[zi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,this.logger.info("sending content sharing telemetry:",this.getStringifiedEventData(g)),g.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(zi.EVENT_TYPE.CONVERSATION_CONTENT_SHARING,g)},this.logHttpTelemetryEvent=g=>{g[zi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,g[zi.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),this.logger.info("sending http telemetry:",this.getStringifiedEventData(g)),g.hostName=this.getHostDomainInfo(),this.telemetryLogger.sendEvent(zi.EVENT_TYPE.CONVERSATION_HTTP_REQUEST,g)},this.getHostDomainInfo=()=>"localhost"===location.hostname||"127.0.0.1"===location.hostname?"localhost":"<redacted>",this.getSignalingAgentConfig=()=>{const g=[],m=this.signalingSession.signalingAgentConfig;return m.supportsCompressedServicePayload&&g.push(zi.SIGNALING_CONFIG_FLAGS.SUPPORTS_COMPRESSED_PAYLOAD),m.brokerEnabledOutgoing&&g.push(zi.SIGNALING_CONFIG_FLAGS.BROKER_OUTGOING_ENABLED),m.brokerEnabledIncoming&&g.push(zi.SIGNALING_CONFIG_FLAGS.BROKER_INCOMING_ENABLED),m.brokerRequestBatching&&g.push(zi.SIGNALING_CONFIG_FLAGS.BROKER_REQUEST_BATCHING_ENABLED),m.brokerExclusively&&g.push(zi.SIGNALING_CONFIG_FLAGS.BROKER_EXCLUSIVELY_ENABLED),m.supportsSynchronousTrouterResponse&&g.push(zi.SIGNALING_CONFIG_FLAGS.SYNC_TROUTER_RESPONSE),m.handleMediaOfferFromPushNotification&&g.push(zi.SIGNALING_CONFIG_FLAGS.HANDLE_OFFER_FROM_NOTIFICATION),m.handleNewOfferRequest&&g.push(zi.SIGNALING_CONFIG_FLAGS.HANDLE_NEW_OFFER_REQUEST),m.sendProgressFromCC&&g.push(zi.SIGNALING_CONFIG_FLAGS.SEND_PROGRESS_FROM_CC),m.handleUnmuteMuteFromResponse&&g.push(zi.SIGNALING_CONFIG_FLAGS.HANDLE_UNMUTE_MUTE_FROM_RESPONSE),m.useInternalHttpDispatcher&&g.push(zi.SIGNALING_CONFIG_FLAGS.INTERNAL_HTTP_DISPATCHER),m.enableTokenCache&&g.push(zi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE),m.enableTokenPrefetch&&g.push(zi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_PREFETCH),m.supportMediaRetargetWhileIncomingRenegotiation&&g.push(zi.SIGNALING_CONFIG_FLAGS.SUPPORT_MEDIA_RETARGET_WHILE_INCOMING_RENEGOTIATION),m.enableCallEstablishmentTimeoutsForStartJoinCall&&g.push(zi.SIGNALING_CONFIG_FLAGS.ENABLE_CALL_ESTABLISHMENT_TIMEOUTS_FOR_START_OR_JOIN_CALL),m.enableTokenCacheForGenericTokenAPI&&g.push(zi.SIGNALING_CONFIG_FLAGS.ENABLE_TOKEN_CACHE_FOR_GENERIC_TOKEN_API),g.push(zi.SIGNALING_CONFIG_FLAGS.SERVER_MUTE_UNMUTE),g.join(",")},this.getStringifiedEventData=g=>{try{return JSON.stringify(g)}catch(g){return"invalid data"}},this.telemetryLogger=this.signalingSession.signalingAgentConfig.oneDsTelemetryLogger??this.signalingSession.signalingAgentConfig.telemetryManager}createCallModalityEvent(g){const m={};m.Type=zi.SOURCE.NGC_SOURCE;const setEventPropertyIfRecorded=(f,S=!1)=>{g.hasOwnProperty(f)&&(m[f]=S?JSON.stringify(g[f]):g[f])};if(m.ResultDetail=g[zi.EXTENSIONS.RESULT_DETAIL],m.ResultValue=g[zi.EXTENSIONS.RESULT_VALUE],m.ResultCode=g[zi.EXTENSIONS.CALL_END_CODE],m.ResultCauseId=g[zi.EXTENSIONS.RESULT_CAUSE_ID],m[zi.SIGNALING_CONFIG]=this.getSignalingAgentConfig(),m[zi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,m[zi.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,m[zi.CONTEXT_ID.ENDPOINT_ID]=g[zi.CONTEXT_ID.ENDPOINT_ID],m[zi.CONTEXT_ID.PARTICIPANT_ID]=g[zi.CONTEXT_ID.PARTICIPANT_ID],m[zi.EXTENSIONS.ECS_ETAG]=this.signalingSession.signalingAgentConfig.ecsEtag,m[zi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g[zi.EXTENSIONS.CONVERSATION_SERVICE_URL],m[zi.EXTENSIONS.CALL_START_TIME]=JSON.stringify(g[zi.EXTENSIONS.CALL_START_TIME]),m[zi.EXTENSIONS.CALL_END_TIME]=JSON.stringify(g[zi.EXTENSIONS.CALL_END_TIME]),m[zi.EXTENSIONS.MESSAGING_CHANNEL]=JSON.stringify(g[zi.EXTENSIONS.MESSAGING_CHANNEL]),m[zi.EXTENSIONS.IS_GROUP_CALL]=this.signalingSession.multiParty?"true":"false",m[zi.EXTENSIONS.IS_HOSTLESS_CALL]=this.signalingSession.isHostLessCall?"true":"false",m[zi.EXTENSIONS.IS_CAST_CALL]=this.signalingSession.isCastCall?"true":"false",m[zi.EXTENSIONS.IS_HUDDLE_GROUP_CALL]=this.signalingSession.isHuddleGroupCall?"true":"false",m[zi.EXTENSIONS.IS_ON_BEHALF_OF_CALL]=this.signalingSession.onBehalfOf?"true":"false",m[zi.EXTENSIONS.CLIENT_INFORMATION]=g[zi.EXTENSIONS.CLIENT_INFORMATION],m[zi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=g[zi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION],m[zi.EXTENSIONS.CALL_TERMINATING_END]=g[zi.EXTENSIONS.CALL_TERMINATING_END],m[zi.EXTENSIONS.CALL_END_CODE]=JSON.stringify(g[zi.EXTENSIONS.CALL_END_CODE]),m[zi.EXTENSIONS.CALL_END_SUB_CODE]=JSON.stringify(g[zi.EXTENSIONS.CALL_END_SUB_CODE]),setEventPropertyIfRecorded(zi.CONTEXT_ID.SHARED_CORRELATION_ID),setEventPropertyIfRecorded(zi.EXTENSIONS.DIRECTION),setEventPropertyIfRecorded(zi.EXTENSIONS.SELF_PARTICIPANT_ROLE),setEventPropertyIfRecorded(zi.EXTENSIONS.CONNECTED_DURATION_IN_MS,!0),setEventPropertyIfRecorded(zi.EXTENSIONS.TIME_TO_RING_IN_MS,!0),setEventPropertyIfRecorded(zi.EXTENSIONS.NETWORK_REQUESTS_COMPLETED),setEventPropertyIfRecorded(zi.EXTENSIONS.NETWORK_REQUESTS_PENDING),setEventPropertyIfRecorded(zi.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED),setEventPropertyIfRecorded(zi.EXTENSIONS.EVENT_TIMESTAMP_BAG),setEventPropertyIfRecorded(zi.EXTENSIONS.ROSTER_UPDATES_BAG),setEventPropertyIfRecorded(zi.EXTENSIONS.NETWORK_REQUESTS_BAG),setEventPropertyIfRecorded(zi.EXTENSIONS.TROUTER_WAIT_OPERATIONS),setEventPropertyIfRecorded(zi.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS),setEventPropertyIfRecorded(zi.EXTENSIONS.OUTGOING_MODALITIES),setEventPropertyIfRecorded(zi.EXTENSIONS.INCOMING_MODALITIES),setEventPropertyIfRecorded(zi.EXTENSIONS.OFFERED_MODALITIES),setEventPropertyIfRecorded(zi.EXTENSIONS.ANSWERED_MODALITIES),setEventPropertyIfRecorded(zi.EXTENSIONS.VBSS_OPERATIONS),setEventPropertyIfRecorded(zi.EXTENSIONS.CALLER_TYPE),setEventPropertyIfRecorded(zi.EXTENSIONS.CALLEE_TYPE),setEventPropertyIfRecorded(zi.EXTENSIONS.SCENARIO),setEventPropertyIfRecorded(zi.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S),setEventPropertyIfRecorded(zi.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S),setEventPropertyIfRecorded(zi.EXTENSIONS.IS_PREHEATED),setEventPropertyIfRecorded(zi.EXTENSIONS.ACS_RESOURCE_ID),setEventPropertyIfRecorded(zi.EXTENSIONS.CALL_END_RESULT_CATEGORIES),setEventPropertyIfRecorded(zi.EXTENSIONS.APPLICATION_TYPE),setEventPropertyIfRecorded(zi.EXTENSIONS.RING),setEventPropertyIfRecorded(zi.EXTENSIONS.REGION),setEventPropertyIfRecorded(zi.EXTENSIONS.PARTITION),setEventPropertyIfRecorded(zi.EXTENSIONS.JOINED_FROM),setEventPropertyIfRecorded(zi.EXTENSIONS.MEETING_URL),setEventPropertyIfRecorded(zi.EXTENSIONS.MEETING_CODE),setEventPropertyIfRecorded(zi.EXTENSIONS.USER_HEX_CID),setEventPropertyIfRecorded(zi.EXTENSIONS.BROADCAST_MEETING_ROLE),setEventPropertyIfRecorded(zi.EXTENSIONS.MEETING_ROLE),setEventPropertyIfRecorded(zi.EXTENSIONS.ADVANCED_MEETING_ROLE),setEventPropertyIfRecorded(zi.EXTENSIONS.PARTICIPANT_TYPE),setEventPropertyIfRecorded(zi.EXTENSIONS.AUDIO_ONLY_WATERMARK),setEventPropertyIfRecorded(zi.EXTENSIONS.TARGET_APPLICATION_TYPE),setEventPropertyIfRecorded(zi.EXTENSIONS.IS_REINVITELESS),setEventPropertyIfRecorded(zi.EXTENSIONS.CLIENT_TYPE),this.signalingSession.callType&&(m[zi.EXTENSIONS.CALL_TYPE]=this.signalingSession.callType),this.signalingSession.signalingAgentConfig.testCall&&(m[zi.EXTENSIONS.TEST_CONTEXT_ID]="Test"),this.signalingSession.groupId&&(m[zi.CONTEXT_ID.GROUP_ID]=scrubMriOrOmit(this.signalingSession.groupId)),this.signalingSession.threadId&&(m[zi.CONTEXT_ID.THREAD_ID]=getLoggableThreadId(this.signalingSession.threadId)),this.signalingSession.teamsMessageId&&(m[zi.CONTEXT_ID.TEAMS_MESSAGEID]=this.signalingSession.teamsMessageId),this.signalingSession.getMeetingInfo()){const g={...this.signalingSession.getMeetingInfo()};g.hasOwnProperty("organizerId")&&(g.organizerId=scrubMriOrOmit(g.organizerId)),m[zi.CONTEXT_ID.TEAMS_MEETINGINFO]=JSON.stringify(g)}return this.signalingSession.multiParty&&0===this.signalingSession.numberOfOriginalInvitees&&g.hasOwnProperty(zi.EXTENSIONS.SELF_PARTICIPANT_ROLE)&&g[zi.EXTENSIONS.SELF_PARTICIPANT_ROLE]===zi.ROLE.CALLER&&(m[zi.EXTENSIONS.IS_MEETUP_CALL]="true"),m}};function getLogger(g,m){return new Fn(g,m)}var xn=class{constructor(g,m,f){this.signalingSession=g,this.callStartTime=f,this.networkRequestsCompleted=[],this.networkRequestsStarted={},this.networkRequests={},this.localOperationsPerformed=[],this.recordedEvents=[],this.rosterUpdates=[],this.contentSharingOperationsPerformed={},this.outgoingModalities=[],this.incomingModalities=[],this.offeredModalities="",this.answeredModalities="",this.vbssOperations=[],this.vbssStarted=!1,this.localOfferAnswerGenerationTimestamps=[],this.trouterWaitOperations=[],this.telemetryData={},this.contentSharingBaseTelemetryData={},this.httpRequestTelemetryData={},this.connectedStopWatch=null,this.preheatedCallSetupDurationWatch=null,this.callCancelationDurationWatch=null,this.timeToRingStopWatch=null,this.isSdpInCallNotification=!1,this.isPreheated=0,this.isReinviteless=0,this.addBrokerChannel=()=>{this.setMessagingChannel(zi.MESSAGING_CHANNEL.BROKER)},this.addTrouterChannel=()=>{this.setMessagingChannel(zi.MESSAGING_CHANNEL.TROUTER)},this.addTrouterWaitOperation=g=>{this.trouterWaitOperations.push(this.recordOperation(g))},this.recordIncomingEvent=(g,m,f)=>{const S=extractCauseIdFromMessage(m),v={origin:m.origin,causeId:S,data:f};f||delete v.data,this.recordEvent(g,v)},this.recordIncomingEventCount=g=>{this.localOperationsPerformed.push(this.recordOperation(g));const m=this.recordedEvents.findIndex((m=>m[g]));if(-1!==m)this.recordedEvents[m][g]+=1;else{const m={};m[g]=1,this.recordedEvents.push(m)}},this.recordEvent=(g,m)=>{this.logger.debug("Event:",g,m),this.localOperationsPerformed.push(this.recordOperation(g));const f={};f[g]=this.timeSinceCallStart(),m&&(f.data=m),this.recordedEvents.push(f)},this.recordRosterEvent=(g,m,f)=>{this.localOperationsPerformed.push(this.recordOperation(m));const S={data:g,causeId:f},v={eventName:this.timeSinceCallStart(),data:S};this.rosterUpdates.push(v)},this.addOutgoingModalities=g=>{g&&this.outgoingModalities.push(g)},this.addIncomingModalities=g=>{g&&this.incomingModalities.push(g)},this.setOfferedModalities=(g,m)=>{this.offeredModalities=this.sdpTelemetryFormat(g,m)},this.setAnsweredModalities=(g,m)=>{this.answeredModalities=this.sdpTelemetryFormat(g,m)},this.setIsSdpInCallNotification=g=>{this.isSdpInCallNotification=g},this.addVbssOperations=g=>{g&&(g===zi.VBSS_OPERATION.START?this.vbssStarted=!0:this.vbssStarted=!1,this.vbssOperations.push(this.recordOperation(g)))},this.addNetworkOperationStarted=g=>{tryAddNewKeyToHashTable(this.networkRequestsStarted,g,this.recordOperation(g))},this.addNetworkOperationCompleted=(g,m,f)=>{const S=m?zi.RESULT_VALUE.SUCCESS:zi.RESULT_VALUE.FAILURE,v=f?`${g}:${S}:${f}`:`${g}:${S}`;this.networkRequestsCompleted.push(this.recordOperation(v)),tryRemoveKeyFromHashTable(this.networkRequestsStarted,g)},this.updateNetworkRequest=g=>{this.networkRequests[g.uid]?kn.assign(this.networkRequests[g.uid],g):this.networkRequests[g.uid]=g},this.deleteNetworkRequest=g=>{delete this.networkRequests[g.uid]},this.addContentSharingOperation=(g,m,f)=>{this.contentSharingOperationsPerformed[g]||(this.contentSharingOperationsPerformed[g]=[]);const S={[m]:this.timeSinceCallStart()};this.contentSharingOperationsPerformed[g].push(S);const v=this.contentSharingOperationsPerformed[g].length-1;return f&&this.updateContentSharingOperation(g,v,f),v},this.updateContentSharingOperation=(g,m,f)=>{if(!this.contentSharingOperationsPerformed[g])return;const S=this.contentSharingOperationsPerformed[g][m],v=[];for(const g of Object.keys(f))v.push(`${g}: ${f[g]}`);S.data=v.join(", ")},this.setDirection=g=>{this.telemetryData[zi.EXTENSIONS.DIRECTION]=g},this.setEndPointId=g=>{this.telemetryData[zi.CONTEXT_ID.ENDPOINT_ID]=g,this.contentSharingBaseTelemetryData[zi.CONTEXT_ID.ENDPOINT_ID]=g,this.httpRequestTelemetryData[zi.CONTEXT_ID.ENDPOINT_ID]=g},this.setParticipantId=g=>{this.telemetryData[zi.CONTEXT_ID.PARTICIPANT_ID]=g,this.contentSharingBaseTelemetryData[zi.CONTEXT_ID.PARTICIPANT_ID]=g,this.httpRequestTelemetryData[zi.CONTEXT_ID.PARTICIPANT_ID]=g},this.addTokenTelemetry=(g,m)=>{g?this.networkRequests?.[g]?(this.networkRequests[g].tokenTelemetries||(this.networkRequests[g].tokenTelemetries=[]),this.networkRequests[g].tokenTelemetries.push(m)):this.logger.info(`[addTokenTelemtry] httprequest: ${g} is not found in networkRequests`):this.logger.error("[addTokenTelemetry] httprequest uid is undefined")},this.setConversationServiceUrl=g=>{this.telemetryData[zi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g},this.setMeetingInfo=g=>{g||(this.telemetryData[zi.EXTENSIONS.MEETING_INFO]=g)},this.setJoinedFrom=g=>{this.telemetryData[zi.EXTENSIONS.JOINED_FROM]=g},this.setMeetingCode=g=>{this.telemetryData[zi.EXTENSIONS.MEETING_CODE]=g},this.setMeetingUrl=g=>{this.telemetryData[zi.EXTENSIONS.MEETING_URL]=g},this.setBroadcastMeetingRole=g=>{this.telemetryData[zi.EXTENSIONS.BROADCAST_MEETING_ROLE]=g},this.setMeetingRole=g=>{this.telemetryData[zi.EXTENSIONS.MEETING_ROLE]=g},this.setAdvancedMeetingRole=g=>{this.telemetryData[zi.EXTENSIONS.ADVANCED_MEETING_ROLE]=g},this.setParticipantType=g=>{this.telemetryData[zi.EXTENSIONS.PARTICIPANT_TYPE]=g},this.setSelfParticipantRole=g=>{this.telemetryData[zi.EXTENSIONS.SELF_PARTICIPANT_ROLE]=g},this.setAudioOnlyWatermark=g=>{this.telemetryData[zi.EXTENSIONS.AUDIO_ONLY_WATERMARK]=g},this.setWatermarkSupport=g=>{this.telemetryData[zi.EXTENSIONS.CLIENT_SUPPORT_WATERMARK]=g},this.setScenario=g=>{this.telemetryData[zi.EXTENSIONS.SCENARIO]=g},this.setTargetApplicationType=g=>{g&&(this.telemetryData[zi.EXTENSIONS.TARGET_APPLICATION_TYPE]=g)},this.setCallerType=g=>{g&&(this.telemetryData[zi.EXTENSIONS.CALLER_TYPE]=g.split(":",1)[0])},this.setCalleeType=g=>{g&&(this.telemetryData[zi.EXTENSIONS.CALLEE_TYPE]=g.split(":",1)[0])},this.setTerminatingData=g=>{this.telemetryData[zi.EXTENSIONS.CALL_TERMINATING_END]=g.terminatingEnd,this.telemetryData[zi.EXTENSIONS.CALL_END_CODE]=g.endCode||Hi.CALL_END_CODE.SUCCESS,this.telemetryData[zi.EXTENSIONS.CALL_END_SUB_CODE]=g.endSubCode||Hi.CALL_END_SUB_CODE.SUCCESS,this.telemetryData[zi.EXTENSIONS.CALL_PHRASE]=g.phrase||Hi.CALL_END_PHRASE.UNKNOWN,this.telemetryData[zi.EXTENSIONS.RESULT_VALUE]=g.resultValue||zi.RESULT_VALUE.SUCCESS,this.telemetryData[zi.EXTENSIONS.RESULT_DETAIL]=g.resultDetail||"Call gracefully hungup",this.telemetryData[zi.EXTENSIONS.RESULT_CAUSE_ID]=g.causeId||"unknown",this.telemetryData[zi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=g.resultCategories||[],this.telemetryData[zi.EXTENSIONS.CALL_END_CLIENT_SUB_CODE]=g.clientReasonSubCode,this.telemetryData[zi.EXTENSIONS.CALL_END_CLIENT_PHRASE]=g.clientReasonPhrase},this.startCallInitializationWatch=g=>{this.timeToRingStopWatch=build3(),g&&(this.timeToRingStopWatch.msElapsed+=g)},this.startCallConnectedWatch=()=>{this.connectedStopWatch=build3()},this.setIsPreheated=()=>{this.isPreheated=1},this.startPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch=build3()},this.stopPreheatedCallSetupDurationWatch=()=>{this.preheatedCallSetupDurationWatch.pause()},this.startCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=build3()},this.stopCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch&&this.callCancelationDurationWatch.pause()},this.getCallCancelationDuration=()=>this.callCancelationDurationWatch?this.callCancelationDurationWatch.durationInSeconds():0,this.resetCallCancelationDurationWatch=()=>{this.callCancelationDurationWatch=null},this.setOfferAnswerGenerationTimestamps=g=>{this.localOfferAnswerGenerationTimestamps.push(this.recordOperation(g))},this.setTimeToRingDuration=()=>{this.timeToRingStopWatch&&(this.telemetryData[zi.EXTENSIONS.TIME_TO_RING_IN_MS]=this.timeToRingStopWatch.duration(),this.timeToRingStopWatch=null)},this.dispose=()=>{this.sendCallModalityTelemetryData()},this.setMessagingChannel=g=>{this.telemetryData[zi.EXTENSIONS.MESSAGING_CHANNEL]||(this.telemetryData[zi.EXTENSIONS.MESSAGING_CHANNEL]=[]);this.telemetryData[zi.EXTENSIONS.MESSAGING_CHANNEL].some((m=>-1!==m.indexOf(g)))||this.telemetryData[zi.EXTENSIONS.MESSAGING_CHANNEL].push(this.recordOperation(g))},this.sendHttpTelemetryData=g=>{const m={...this.httpRequestTelemetryData};m[zi.CONTEXT_ID.CORRELATION_ID]=this.signalingSession.correlationId,m[zi.CONTEXT_ID.SIGNALING_SESSION_ID]=this.signalingSession.sessionId,m[zi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation;const f=JSON.stringify({eventStart:this.callStartTime,events:this.networkRequests[g]});tryRemoveKeyFromHashTable(this.networkRequests,g),m[zi.EXTENSIONS.NETWORK_REQUESTS_BAG]=f,this.telemetryLogger.logHttpTelemetryEvent(m)},this.sdpTelemetryFormat=(g,m)=>{if(!g)return"";const convertType=g=>{switch(g){case"main-audio":return"Audio";case"main-video":return"Video";case"applicationsharing-video":return"AppSharing";default:return}},convertDirection=g=>{switch(g){case"inactive":return"Inactive";case"sendonly":return m?"ReceiveFromPeer":"SendToPeer";case"recvonly":return m?"SendToPeer":"ReceiveFromPeer";default:return"Bidirectional"}},f={"main-audio":0,"main-video":0,"applicationsharing-video":0},S=[],v=Ln.parse(g);for(const g of v.media){const m=convertType(g.label);if(!m)continue;const v=f[g.label]++,C=convertDirection(g.direction);S.push(`${m}[${v}] = ${C}`)}return S.join(", ")},this.setReinviteless=g=>{this.isReinviteless=g?1:0},this.logger=g.logger,this.telemetryLogger=getLogger(g,this.logger),this.telemetryData[zi.EXTENSIONS.CALL_START_TIME]=this.callStartTime,this.telemetryData[zi.EXTENSIONS.CONVERSATION_SERVICE_URL]=g.signalingAgentConfig.conversationServiceUrl,this.fillCommonData(m,this.telemetryData),this.fillCommonData(m,this.httpRequestTelemetryData),this.fillCommonData(m,this.contentSharingBaseTelemetryData)}fillCommonData(g,m){m[zi.EXTENSIONS.APPLICATION_TYPE]=g.applicationType,m[zi.EXTENSIONS.RING]=g.ring,m[zi.EXTENSIONS.TENANT_ID]=g.tenantId,m[zi.EXTENSIONS.USER_HEX_CID]=g.userHexCID,m[zi.EXTENSIONS.ACS_RESOURCE_ID]=g.acsResourceId,m[zi.EXTENSIONS.REGION]=g.region,m[zi.EXTENSIONS.PARTITION]=g.partition,m[zi.EXTENSIONS.CLIENT_TYPE]=g.clientType}addChangingCorrelationId(g,m){this.telemetryData[zi.EXTENSIONS.CHANGING_CORRELATION_ID_OLD_ID]=g,this.telemetryData[zi.EXTENSIONS.CHANGING_CORRELATION_ID_NEW_ID]=m}addSharedCorrelationId(g){this.telemetryData[zi.CONTEXT_ID.SHARED_CORRELATION_ID]=g}sendContentSharingTelemetryData(g,m,f,S,v,C){const _={...this.contentSharingBaseTelemetryData},E=this.contentSharingOperationsPerformed[g];E&&(_[zi.EXTENSIONS.EVENT_TIMESTAMP_BAG]=JSON.stringify(E)),_[zi.CONTEXT_ID.CONTENT_SHARING_CORRELATION_ID]=g,_[zi.CONTEXT_ID.SIGNALING_SESSION_ID]=m,_[zi.CONTEXT_ID.CONTENT_SHARING_ID]=C||"",_[zi.EXTENSIONS.CONTENT_SHARING_SERVICE_URL]=v,_[zi.EXTENSIONS.CONTENT_SHARING_DIRECTION]=f?zi.DIRECTION.OUTGOING:zi.DIRECTION.INCOMING,_[zi.EXTENSIONS.CALL_END_CODE]=S.code,_[zi.EXTENSIONS.CALL_END_SUB_CODE]=S.subCode,_[zi.EXTENSIONS.CALL_PHRASE]=S.phrase,_[zi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(S.resultCategories),_[zi.EXTENSIONS.CALL_END_CAUSE_ID]=S.causeId,_[zi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,delete this.contentSharingOperationsPerformed[g],this.telemetryLogger.logConversationContentSharingEvent(_)}recordOperation(g){return`${g}:${this.timeSinceCallStart()}`}timeSinceCallStart(){return(new Date).getTime()-this.callStartTime}sendCallModalityTelemetryData(){this.vbssStarted&&this.addVbssOperations(zi.VBSS_OPERATION.CALL_END);const durationMsToS=g=>"number"==typeof g?g/1e3:0;if(this.telemetryData[zi.EXTENSIONS.CLIENT_INFORMATION]=this.signalingSession.signalingAgentConfig.clientInformation,this.telemetryData[zi.EXTENSIONS.CALL_END_TIME]=(new Date).getTime(),this.connectedStopWatch&&(this.telemetryData[zi.EXTENSIONS.CONNECTED_DURATION_IN_MS]=this.connectedStopWatch.duration()),this.telemetryData[zi.EXTENSIONS.IS_PREHEATED]=this.isPreheated,this.preheatedCallSetupDurationWatch&&(this.telemetryData[zi.EXTENSIONS.PREHEATED_CALL_SETUP_DURATION_IN_S]=durationMsToS(this.preheatedCallSetupDurationWatch.duration())),this.callCancelationDurationWatch&&(this.telemetryData[zi.EXTENSIONS.CALL_CANCELATION_DURATION_IN_S]=durationMsToS(this.callCancelationDurationWatch.duration())),this.networkRequestsCompleted.length&&(this.telemetryData[zi.EXTENSIONS.NETWORK_REQUESTS_COMPLETED]=JSON.stringify(this.networkRequestsCompleted)),this.localOperationsPerformed.length&&(this.telemetryData[zi.EXTENSIONS.LOCAL_OPERATIONS_PERFORMED]=JSON.stringify(this.localOperationsPerformed)),this.trouterWaitOperations.length&&(this.telemetryData[zi.EXTENSIONS.TROUTER_WAIT_OPERATIONS]=JSON.stringify(this.trouterWaitOperations)),this.localOfferAnswerGenerationTimestamps.length&&(this.telemetryData[zi.EXTENSIONS.LOCAL_OFFER_ANSWER_GENERATION_TIMESTAMPS]=JSON.stringify(this.localOfferAnswerGenerationTimestamps)),this.incomingModalities.length&&(this.telemetryData[zi.EXTENSIONS.INCOMING_MODALITIES]=JSON.stringify(this.incomingModalities)),this.outgoingModalities.length&&(this.telemetryData[zi.EXTENSIONS.OUTGOING_MODALITIES]=JSON.stringify(this.outgoingModalities)),this.offeredModalities.length&&(this.telemetryData[zi.EXTENSIONS.OFFERED_MODALITIES]=this.offeredModalities),this.answeredModalities.length&&(this.telemetryData[zi.EXTENSIONS.ANSWERED_MODALITIES]=this.answeredModalities),this.telemetryData[zi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]=this.getResultCategoryString(this.telemetryData[zi.EXTENSIONS.CALL_END_RESULT_CATEGORIES]),this.telemetryData[zi.EXTENSIONS.IS_SDP_IN_CALL_NOTIFICATION]=this.isSdpInCallNotification.toString(),this.vbssOperations.length&&(this.telemetryData[zi.EXTENSIONS.VBSS_OPERATIONS]=JSON.stringify(this.vbssOperations)),this.recordedEvents.length){const g=JSON.stringify({eventStart:this.callStartTime,events:this.recordedEvents});this.telemetryData[zi.EXTENSIONS.EVENT_TIMESTAMP_BAG]=g}if(this.rosterUpdates.length){const g=JSON.stringify({eventStart:this.callStartTime,events:this.rosterUpdates});this.telemetryData[zi.EXTENSIONS.ROSTER_UPDATES_BAG]=g}const g=[];for(const m of Object.keys(this.networkRequestsStarted))g.push(this.networkRequestsStarted[m]);g.length>0&&(this.telemetryData[zi.EXTENSIONS.NETWORK_REQUESTS_PENDING]=JSON.stringify(g)),this.telemetryData[zi.EXTENSIONS.IS_REINVITELESS]=this.isReinviteless,this.telemetryLogger.logConversationCallModalityEvent(this.telemetryData)}getResultCategoryString(g){return g&&Array.isArray(g)?g.join(","):""}},Un=class{constructor(g,m){this.disposed=!1,this.lastSeenSeqNumbers={},this.isDominantSpeakerInfoLinkEnabled=!0,this.clientUrlsGenerated=!1,this.getClientUrls=()=>{this.clientUrlsGenerated=!0;let g=null;return this.isWebRtcCall&&(g={controlVideoStreaming:get(this.signalingSession,Vi.CONTROL_VIDEO_STREAMING),csrcInfo:get(this.signalingSession,Vi.CSRC_INFO)},this.isDominantSpeakerInfoLinkEnabled&&(g.dominantSpeakerInfo=get(this.signalingSession,Vi.DOMINANT_SPEAKER_INFO))),g},this.handleDominantSpeakerInfo=g=>{const m=g.body;this.logger.debug("handleDominantSpeakerInfo : ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEventCount(Wi.HANDLE_DOMINANT_SPEAKER_CHANGED_COUNT),this.handleWebRtcNotification(Hi.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO,m.dominantSpeakerInformation)},this.handleControlVideoStreaming=g=>{const m=g.body;this.logger.debug("handleControlVideoStreaming: ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CONTROL_VIDEO_STREAMING,g),this.handleWebRtcNotification(Hi.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING,m.controlVideoStreaming,!1)},this.handleCsrcInfo=g=>{const m=g.body;this.logger.debug("handleCsrcInfo : ",getPrintableObject(m)),this.signalingSession.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CSRC_INFO,g),this.handleWebRtcNotification(Hi.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO,m.csrcInfo)},this.sendWebRtcMediaNotificationAsync=({operation:g,requestUrl:m,requestBody:f,stackRetry:S=!0},v)=>{this.logger.info("sendWebRtcMediaNotificationAsync"),assert2(this.isWebRtcCall,"this is not a webrtc call"),assertNotNullOrEmpty(m,"correct media notification requestUrl is not provided"),assertNotNullOrEmpty(f,"media notification requestBody cannot be null or empty");const C=defer2(),_={url:m,payload:{payload:f},requestName:g,withoutTrouter:!0,causeId:v};return S||(_.disableRetry=!0),this.signalingSession.http.sendPostRequest(_).then((()=>{this.disposed||C.resolve()})).catch((g=>{const m=getPrintableObject(g);if(this.logger.error(`sendWebRtcMediaNotificationAsync failed because : ${m}`),!this.disposed){const m=new Error(g);m.endCode=Hi.CALL_END_NETWORK_ERROR,C.reject(m)}})),C.promise},this.dispose=()=>{this.logger.info("WebRtcSignalingManager :: dispose"),this.disposed=!0},this.signalingSession=g,this.signalingSessionCallback=m,this.isWebRtcCall=g.signalingAgentConfig.isWebRtcEnabled,this.logger=g.logger,this.lastSeenSeqNumbers[Hi.WEBRTC_NOTIFICATION_TYPE.CONTROL_VIDEO_STREAMING]=-1,this.lastSeenSeqNumbers[Hi.WEBRTC_NOTIFICATION_TYPE.DOMINANT_SPEAKER_INFO]=-1,this.lastSeenSeqNumbers[Hi.WEBRTC_NOTIFICATION_TYPE.CSRC_INFO]=-1}areClientURLsGenerated(){return this.clientUrlsGenerated}getIsDominantSpeakerInfoLinkEnabled(){return this.isDominantSpeakerInfoLinkEnabled}setIsDominantSpeakerInfoLinkEnabled(g){this.isDominantSpeakerInfoLinkEnabled=g}handleWebRtcNotification(g,m,f=!0){assert2(this.isWebRtcCall,"ignoring message in non-webrtc call");const S=this.lastSeenSeqNumbers[g];f&&m.sequenceNumber<=S?this.logger.info(`ignoring ${g} . Last seen seq = ${S} current seq = ${m.sequenceNumber}`):(m.sequenceNumber<=S&&this.logger.info(`let listener to handle older ${g} . Last seen seq = ${S} current seq = ${m.sequenceNumber}`),this.lastSeenSeqNumbers[g]=Math.max(m.sequenceNumber,this.lastSeenSeqNumbers[g]),this.signalingSessionCallback.onWebRtcMediaNotification(g,m))}},Vn=class{constructor(g,m,f,S,v,C){this.disposed=!1,this.convSubject=null,this.groupId=null,this.threadId=null,this.incomingCallCallerId=null,this.incomingCallPayload=null,this.multiParty=!0,this.isIncomingCall=!1,this.isHostLessCall=!1,this.isCastCall=!1,this.isHuddleGroupCall=!1,this.numberOfOriginalInvitees=0,this.teamsMessageId=null,this.enableGroupCallMeetupGeneration=!1,this.meetingInfo=null,this.meetingDetails=null,this.emergencyContent=null,this.transferContext=null,this.callType="default",this.callMode=0,this.transferor=null,this.onBehalfOf=null,this.onBehalfOfUserDisplayName=null,this.callPhoneLineType=null,this.endpointMetadata={},this.sessionId=newGuid(),this.remoteCaller=null,this.acceptedElsewhereBy=null,this.parkAdditionalContextJson=null,this.serverHoldLocation=null,this.breakoutDetails=null,this.callLimits=null,this.complianceRecordingContent=null,this.backroomThreadId=null,this.realTimeState=0,this.disposing=!1,this.links={},this.provisionalMediaAnswersSeenSoFar=[],this.incomingTrouterMessagesSeenSoFar=[],this.incomingBrokerMessagesSeenSoFar=[],this.currentCallStatus=null,this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.convJoined=!1,this.keepAliveTimer=null,this.keepAliveInterval=null,this.keepAliveCount=1,this.conversationKeepAliveTimer=null,this.conversationKeepAliveInterval=null,this.conversationKeepAliveCount=1,this.remoteUser=null,this.mediaTypesToUse=null,this.lastUsedOutgoingMediaContent=null,this.lastUsedJoinCallOptions=null,this.originalRoleBeforePreheat="",this.endpointStateSequenceNumber=0,this.publishStateSequenceNumber=0,this.requestedPublishedStatesWhileConnecting=null,this.linkUpdateRequested={conversationLinks:!1,keepAliveLinks:!1},this.incomingMessageSyncResponseCache={},this.isPreheatOnly=!1,this.callStartTime=(new Date).getTime(),this.callUsesMixer=!1,this.disablePreheatDefer=defer2(),this.participantReplacementDetails={},this.meetingLiveStateSequenceNumber=0,this.meetingLayoutSequenceNumber=0,this.localParticipantUpdateSequenceNumber=0,this.isRedirectAllowed=!1,this.updateSequenceNumber=-1,this.isPromotingToRealtime=!1,this.streamInformationReceived=!1,this.startOrJoinConvResponseReceived=!1,this.updateParticipantsPromises={},this.updateEndpointState=(g,m=causeId2(),f)=>{this.logger.info(`[${m}][requestedEndpointState=${getPrintableObject(g,!0)}]`);const S=this.links[Hi.LINKS.UPDATE_ENDPOINT_STATE],v=this.getEndpointState();this.logger.info(`[${m}][currentEndpointState=${getPrintableObject(v,!0)}] startOrJoinConvResponseReceived=${this.startOrJoinConvResponseReceived}`);const C={...v,...g,endpointStateSequenceNumber:++this.endpointStateSequenceNumber};this.telemetryHelper.recordEvent(Wi.UPDATE_ENDPOINT_STATE,{newEndpointState:C,causeId:m});const preheatDisabledInNewState=g=>0===g?.endpointProperties?.preheatProperties;if(preheatDisabledInNewState(C)&&this.isPreheatOnly&&(this.telemetryHelper.recordEvent(Wi.PREHEAT_DISABLING,{causeId:m}),this.telemetryHelper.startPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallCancelationDurationWatch()),2===this.callMode&&preheatDisabledInNewState(C))return this.logger.info(`[${m}][updateEndpointState skipped as mode is streaming]`),this.handleEndpointStateUpdated(m,!0),Promise.resolve();if(!this.startOrJoinConvResponseReceived)return this.logger.info(`[${m}][updateEndpointState will be queued as we don't have a link yet]`),this.requestedEndpointStateWhileConnecting=g,preheatDisabledInNewState(C)?(this.requestedPublishedStatesWhileConnecting=f,this.disablePreheatDefer.promise):Promise.resolve();if(!this.shouldUpdateEndpointState(v,C)&&!this.http.hasPendingRequest(qi.UPDATE_ENDPOINT_STATE.name))return this.logger.info(`[${m}][updateEndpointState will ignore current update as there is nothing new to send]`),Promise.resolve();if(!S)return this.logger.info(`[${m}][updateEndpointState operation cannot be performed now, the link is not yet available]`),Promise.reject("No link");this.latestEndpointState=C;const _=this.signalingAgentConfig.enableAsyncDisablePreheat&&preheatDisabledInNewState(C);_&&this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT,(()=>{const g={code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.DISABLE_PREHEAT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.DISABLE_PREHEAT_TIMEOUT};this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject({response:g})}),Hi.TIMEOUT_VALUES_IN_SECONDS.DISABLE_PREHEAT_TIMEOUT);const E=this.http.sendPostRequest({url:S,requestName:qi.UPDATE_ENDPOINT_STATE.name,payload:getPayload51(this,C,f,_),causeId:m}).then((()=>(_&&(this.logger.info(`[${m}][updateEndpointState] asyncDisablePreheat: true`),this.telemetryHelper.recordEvent(Wi.DISABLE_PREHEAT_RESPONSE_RECEIVED,{causeId:m})),Promise.resolve()))).catch((g=>{if(!_)throw g;this.disablePreheatDefer.reject(g)}));return(_?this.disablePreheatDefer.promise:E).then((()=>{this.logger.info(`[${m}][updateEndpointState] asyncDisablePreheat: ${_}`),this.telemetryHelper.recordEvent(_?Wi.ASYNC_DISABLE_PREHEAT_SUCCEEDED:Wi.DISABLE_PREHEAT_SUCCEEDED,{causeId:m}),this.disposed||this.handleEndpointStateUpdated(m,preheatDisabledInNewState(C))})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][updateEndpointState] error: ${getPrintableObject(f)}`),preheatDisabledInNewState(C)&&(this.handleDisablePreheatError(f.error,_?Wi.ASYNC_DISABLE_PREHEAT_FAILED:Wi.DISABLE_PREHEAT_FAILED,m),this.stopCallPreheatTimer(),this.terminateEstablishedCall({code:f.error.code,subCode:f.error.subCode,phrase:f.error.phrase},{forEveryone:!1,causeId:m})),Promise.reject(f.error)}))},this.setParticipantCallLinks=g=>{g&&g.endpointDetails&&(this.participantReplacementDetails[g.id]={},g.endpointDetails.forEach((m=>{m&&m.callLinks&&(this.participantReplacementDetails[g.id][m.participantId]=m.callLinks)})))},this.clearParticipantCallLinks=g=>{this.participantReplacementDetails&&this.participantReplacementDetails.hasOwnProperty(g)&&delete this.participantReplacementDetails[g]},this.getReplacementDetailsByParticipantLeg=(g,m,f=causeId2())=>(this.logger.info(`[${f}]getReplacementDetailsByParticipantLeg: participantMri ${getPIISafeObject(g)} participantLegId ${m}`),this.participantReplacementDetails&&this.participantReplacementDetails.hasOwnProperty(g)&&this.participantReplacementDetails[g].hasOwnProperty(m)?{replaces:this.participantReplacementDetails[g][m].replacement,replacementTargetParticipantId:m}:(this.logger.info(`[${f}]getReplacementDetailsByParticipantLeg: unable to find replacement details for participantLegId ${m}`),{})),this.getReplacementDetailsByParticipantLegOfCall=(g,m,f,S=causeId2())=>{this.logger.info(`[${S}]getReplacementDetailsByParticipantLegOfCall: callId ${g} participantMri ${getPIISafeObject(m)} participantLegId ${f}`);const v=this.signalingAgent.getSignalingSession(g);return v?v.getReplacementDetailsByParticipantLeg(m,f,S):{}},this.getMriByParticipantLegOfCall=(g,m,f)=>{this.logger.info(`[${f}]getMriByParticipantLegOfCall: callId: ${g} participantLegId ${m}`);const S=this.signalingAgent.getSignalingSession(g);return S?S.getMriByParticipantLeg(m,f):""},this.getMriByParticipantLeg=(g,m)=>{this.logger.info(`getMriByParticipantLeg[${m}] participantLegId ${g}`);for(const m of Object.keys(this.participantReplacementDetails))if(m&&this.participantReplacementDetails.hasOwnProperty(m)&&this.participantReplacementDetails[m]&&this.participantReplacementDetails[m].hasOwnProperty(g))return m;return""},this.handleEndpointStateUpdated=(g,m)=>{this.requestedEndpointStateWhileConnecting=null,this.requestedPublishedStatesWhileConnecting=null,m&&this.handlePreheatDisabled(g)},this.handlePreheatDisabled=g=>{this.isPreheatOnly=!1,this.telemetryHelper.setSelfParticipantRole(this.originalRoleBeforePreheat),this.telemetryHelper.recordEvent(Wi.PREHEAT_DISABLED,{causeId:g}),this.telemetryHelper.resetCallCancelationDurationWatch(),this.telemetryHelper.stopPreheatedCallSetupDurationWatch(),this.telemetryHelper.startCallConnectedWatch(),this.stopCallPreheatTimer(),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.resolve()},this.shouldUpdateEndpointState=(g,m)=>{if(!m)return!1;const f=m.state&&m.state.isMuted?1:0,S=m.endpointProperties&&1===m.endpointProperties.preheatProperties?1:0,v=g&&g.state&&g.state.isMuted?1:0,C=g&&g.endpointProperties&&1===g.endpointProperties.preheatProperties?1:0,_=g?.endpointProperties?.additionalEndpointProperties,E=m?.endpointProperties?.additionalEndpointProperties;return!!(f^v||S^C||E!==_)},this.setInitialTelemetry=(g,m)=>{let f,S;switch(g){case"Subscribe":this.telemetryHelper.recordEvent(Wi.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY,{causeId:m.causeId,correlationId:m.correlationId}),this.telemetryHelper.setDirection(zi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(zi.ROLE.JOIN_FOR_ROSTER_ONLY),this.telemetryHelper.setConversationServiceUrl(m.conversationServiceUrl||this.signalingAgentConfig.conversationServiceUrl),this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id);break;case"Acknowledge":this.telemetryHelper.recordEvent(Wi.HANDLE_INCOMING_CALL,{causeId:m.causeId}),this.telemetryHelper.setDirection(zi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(zi.ROLE.CALLEE),this.telemetryHelper.setCalleeType(this.participantManager.localParticipant.id);break;case"JoinCall":f=this.gatherTelemetryForStartOrJoin(m.joinCallOptions,m.causeId,m.offerGenerationTime),this.telemetryHelper.recordEvent(Wi.JOIN_CALL,f),this.telemetryHelper.setDirection(zi.DIRECTION.INCOMING),this.telemetryHelper.setSelfParticipantRole(zi.ROLE.JOIN);break;case"StartCall":case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":S=this.gatherTelemetryForStartOrJoin(m.callStartOptions,m.causeId,m.offerGenerationTime),this.telemetryHelper.recordEvent(Wi.START_CALL,S),this.telemetryHelper.setDirection(zi.DIRECTION.OUTGOING),this.telemetryHelper.setSelfParticipantRole(zi.ROLE.CALLER),this.telemetryHelper.startCallInitializationWatch(m.offerGenerationTime),this.telemetryHelper.setMeetingInfo(this.getMeetingInfo())}},this.getParticipantIdForOfferAnswer=g=>{assertNotNull(g,"mediaContent should be a non null value"),this.logger.info("getParticipantIdForOfferAnswer");let m=null;return!this.remoteUser||this.groupId||this.threadId||g.newOffer||g.escalationOccurring||(m=this.remoteUser.id),m},this.getMeetingInfo=()=>this.meetingInfo,this.getEmergencyContent=()=>(this.telemetryHelper.recordEvent(Wi.GET_EMERGENCY_CONTENT),this.emergencyContent),this.getEndpointId=()=>this.signalingAgent.endpointId,this.getConversationUrl=()=>this.links[Hi.LINKS.CONVERSATION_CONTROLLER],this.setJoinedFrom=g=>{!this.disposed&&g&&(this.telemetryHelper.recordEvent(Wi.SET_JOINED_FROM),this.telemetryHelper.setJoinedFrom(g))},this.setMeetingCode=g=>{!this.disposed&&g&&this.telemetryHelper.setMeetingCode(g)},this.setMeetingUrl=g=>{!this.disposed&&g&&this.telemetryHelper.setMeetingUrl(g)},this.setSubject=g=>{this.disposed||(this.telemetryHelper.recordEvent(Wi.SET_SUBJECT),assertNotNull(g,"subject should be a non null value"),this.convSubject=g)},this.setDeviceType=g=>{this.disposed||(this.telemetryHelper.recordEvent(Wi.SET_DEVICETYPE),g&&(this.deviceType=g,this.logger.info("setDeviceType",this.deviceType)))},this.setOfferAnswerGenerationTimestamps=g=>{this.disposed||this.telemetryHelper.setOfferAnswerGenerationTimestamps(g)},this.setTimeToRingDuration=()=>{this.disposed||this.telemetryHelper.setTimeToRingDuration()},this.setGroupId=g=>{this.telemetryHelper.recordEvent(Wi.SET_GROUPID),this.groupId!==g&&g&&(assert2(!this.groupId,"conversation groupId has already been set. It cannot be overwritten"),this.groupId=g)},this.setThreadId=g=>{this.telemetryHelper.recordEvent(Wi.SET_THREADID),assertNotNull(g,"threadId should be a non null value"),this.threadId!==g&&(assert2(!this.threadId,"conversation threadId has already been set. It cannot be overwritten"),this.threadId=g)},this.setCallOptions=g=>{if(assertNotNull(g,"callOptions should be a non null value"),this.logger.info("setCallOptions",getPrintableObject(g)),this.telemetryHelper.recordEvent(Wi.SET_CALLOPTIONS),g){this.teamsMessageId=g.teamsMessageId,this.meetingInfo=g.meetingInfo||null,this.emergencyContent=g.emergencyContent||null,this.enableGroupCallMeetupGeneration=g.enableGroupCallMeetupGeneration||!1,g.broadcastContext&&(this.broadcastSession=new tn(this,this.signalingSessionCallback),this.broadcastSession.setContext(g.broadcastContext));try{this.endpointMetadata=JSON.parse(g.endpointMetadata)}catch(g){this.logger.warn("Unable to parse endpoint metadata")}}},this.setTransferContext=g=>{assertNotNull(g,"transferContext should not be null"),this.logger.info("Transfer: setTransferContext",g),this.telemetryHelper.recordEvent(Wi.SET_TRANSFER_CONTEXT),this.transferContext=g},this.muteAsync=(g,m,f=causeId2())=>(assert2(2!==this.callMode||g!==Hi.MUTE_SCOPE.MYSELF,"mute self operation is not allowed in streaming mode"),this.logger.info(`[${f}][muteAsync][scope=${g}]`),this.telemetryHelper.recordEvent(Wi.MUTE,{causeId:f}),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,`[${f}]mute operation for all or specified only allowed in a connected call`),this.participantManager.muteAsync(this.links[Hi.LINKS.MUTE],g,m,f)),this.unmuteAsync=(g=causeId2())=>(assert2(2!==this.callMode,"unmute operation is not allowed in streaming mode"),this.logger.info(`[${g}][unmuteAsync]`),this.telemetryHelper.recordEvent(Wi.UNMUTE,{causeId:g}),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"unmute operation only allowed in a connected call"),this.participantManager.unmuteAsync(this.links[Hi.LINKS.UNMUTE],g)),this.recordTelemetryForStartAudio=(g,m)=>(this.telemetryHelper.recordEvent(Wi.START_AUDIO,{mediaNegotiationStatus:g,causeId:m}),Promise.resolve(null)),this.recordTelemetryForStopAudio=(g,m)=>(this.telemetryHelper.recordEvent(Wi.STOP_AUDIO,{mediaNegotiationStatus:g,causeId:m}),Promise.resolve(null)),this.rejectUnmuteRequestAsync=(g,m=causeId2(),f)=>(assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"rejectUnmute operation only allowed in a connected call"),assertNotNullOrEmpty(g,"requestor must be specified"),this.logger.info(`[${m}][rejectUnmuteRequestAsync][rejectionReason=${f}]`),this.telemetryHelper.recordEvent(Wi.REJECT_UNMUTE,{causeId:m,rejectionReason:f}),this.participantManager.rejectUnmuteRequestAsync(g,m,f)),this.approveUnmuteRequestAsync=(g,m=causeId2())=>(assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"approveUnmute operation only allowed in a connected call"),assertNotNullOrEmpty(g,"requestor must be specified"),this.logger.info(`[${m}][approveUnmuteRequestAsync]`),this.telemetryHelper.recordEvent(Wi.APPROVE_UNMUTE,{causeId:m}),this.participantManager.approveUnmuteRequestAsync(g,m)),this.sendWebRtcMediaNotificationAsync=(g,m,f=causeId2())=>(assert2(2!==this.callMode,"sendWebRtcMediaNotification operation is not allowed in streaming mode"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"webRtc media notification can only be sent in a connected call"),this.telemetryHelper.recordEvent(Wi.SEND_WEBRTC_MEDIA_NOTIFICATION,{causeId:f}),0===g?this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:qi.SEND_APPLY_CHANNEL_PARAMETERS.name,requestUrl:this.links[Hi.LINKS.APPLY_CHANNEL_PARAMETERS],requestBody:m,stackRetry:!1},f):this.webRtcSignalingManager.sendWebRtcMediaNotificationAsync({operation:qi.SEND_CONTROL_VIDEO_STREAMING.name,requestUrl:this.links[Hi.LINKS.CONTROL_VIDEO_STREAMING],requestBody:m},f)),this.addParticipantsAsync=(g,m,f=causeId2())=>{assertNotNullOrEmpty(g,"remoteParticipants should be a non null value"),assert2(this.isCallOngoing()||this.isCallIdleOrRosterOnly(),"remoteParticipants can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${f}][addParticipantsAsync][addParticipantOptions=${getPrintableObject(m)}]\n            [remoteParticipantId=${g.map((g=>this.piiUtils.scrubMriOrOmit(g.id)))}]`);let S=Wi.ADD_PARTICIPANT;switch(m.replacementType){case 2:S=Wi.ADD_PARTICIPANT_WITH_PICKUP_CODE;break;case 1:case 3:S=Wi.ADD_PARTICIPANT_WITH_REPLACES;break;default:S=Wi.ADD_PARTICIPANT}this.telemetryHelper.recordEvent(S,{causeId:f}),m.groupId=this.groupId||m.groupId,m.threadId=this.threadId||m.threadId;const v=m.threadId||m.groupId?this.links[Hi.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Hi.LINKS.ADD_PARTICIPANT],C=this.participantManager.addParticipantsAsync(g,v,this.isCallConnectedOrConnectedForRoster(),m,f);return this.currentCallStatus||this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,f),C},this.addGroupModalityAsync=(g,m)=>{assert2(this.isCallOngoing(),"GroupModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${m}][addGroupModalityAsync][addGroupModalityOptions=${getPrintableObject(g)}]`);const f=Wi.ADD_PARTICIPANTS_AND_MODALITY;this.telemetryHelper.recordEvent(f,{causeId:m});const S=getPayload11(this,null,g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.ADD_PARTICIPANTS_AND_MODALITY],payload:S,requestName:qi.ADD_PARTICIPANTS_AND_MODALITY.name,causeId:m}).then((()=>{en.noop()})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][sendNetworkRequestForAddingParticipant] failed:${getPrintableObject(f)}`);throw f.error}))},this.addBroadcastModalityAsync=(g,m)=>{if(assert2(this.isCallOngoing(),"BroadcastModality can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${m}][addBroadcastModalityAsync][addBroadcastContext=${getPrintableObject(this.addBroadcastModalityAsync)}]`),this.telemetryHelper.recordEvent(Wi.ADD_BROADCAST_MODALITY,{causeId:m}),this.broadcastSession){const g="There is already a broadcast session";return this.logger.info(g),Promise.resolve(Hi.SUCCESS_TRANSACTION_END)}this.broadcastSession=new tn(this,this.signalingSessionCallback),this.broadcastSession.setContext(g);const f=getPayload24(this,g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.ADD_MODALITY],payload:f,requestName:qi.ADD_BROADCAST_MODALITY.name,causeId:m}).then((g=>(this.logger.info(`[${m}][addBroadcastModalityAsync] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_ADD_BROADCAST_MODALITY_COMPLETION,{causeId:m}),Hi.SUCCESS_TRANSACTION_END))).catch((g=>{const f=getErrorForXHRFailure(g);return this.logger.info(`[${m}][sendNetworkRequestForAddBroadcastModalityAsync] failed:${getPrintableObject(f)}`),this.endBroadcastMeeting(m),Promise.reject(f.error)}))},this.nudgeParticipantsAsync=g=>{if(assertNotNull(g.participantsIds,"ParticipantsIds should be a non null value"),assert2(this.isCallOngoing(),"Participants can only be nudged before starting an outgoing call or to an ongoing call"),this.logger.info(`[${g.causeId}][nudgeParticipantsAsync][participantsIds=${this.piiUtils.scrubParticipantsList(g.participantsIds)}][invitationData=${g.invitationData}]`),void 0===g.participantsIds||g.participantsIds.length<1)return Promise.reject("List of participants to nudge is empty");this.telemetryHelper.recordEvent(Wi.ADD_PARTICIPANT,{withNudge:Hi.INVITATION_TYPE.NUDGE,causeId:g.causeId});const m=this.groupId||g.newGroupId,f=this.threadId||g.newThreadId,S=this.teamsMessageId||g.newMessageId,v=f||m?this.links[Hi.LINKS.ADD_PARTICIPANTS_AND_MODALITY]:this.links[Hi.LINKS.ADD_PARTICIPANT];return this.participantManager.nudgeParticipantsAsync(g.participantsIds,v,this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,g.causeId,g.invitationData,m,f,S)},this.callMeBackAsync=(g,m=causeId2())=>(assertNotNull(g,"remoteParticipant should be a non null value"),this.logger.info(`[${m}][callMeBackAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}]`),this.telemetryHelper.recordEvent(Wi.CALL_ME_BACK,{causeId:m}),this.hasGroupModality()||assert2(!1,"threadId/groupId must be set before using call me back"),this.participantManager.callMeBackAsync(g,this.links[Hi.LINKS.ADD_PARTICIPANTS_AND_MODALITY],m)),this.removeParticipantAsync=(g,m=causeId2(),f="none")=>{switch(assertNotNull(g,"remoteParticipant should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"participants can only be removed from an ongoing call"),this.logger.info(`[${m}][removeParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}] [removeEndpointScope] ${f}`),f){case"all":this.telemetryHelper.recordEvent(Wi.REMOVE_PARTICIPANT_OTHERS,{causeId:m});break;case"specified":this.telemetryHelper.recordEvent(Wi.REMOVE_PARTICIPANT_SPECIFIED,{causeId:m});break;default:this.telemetryHelper.recordEvent(Wi.REMOVE_PARTICIPANT,{causeId:m})}return"none"!==f&&g.endpointId?this.participantManager.removeParticipantEndpointAsync(g,this.links[Hi.LINKS.REMOVE_PARTICIPANT],f,m):this.participantManager.removeParticipantAsync(g,this.links[Hi.LINKS.REMOVE_PARTICIPANT],m)},this.admitParticipantAsync=(g,m=causeId2())=>(assertNotNull(g,"remoteParticipant should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"remoteParticipants can only be admitted to an ongoing call"),this.hasGroupModality()||assert2(!1,"threadId/groupId must be set before admitting more participants to connected call"),this.logger.info(`[${m}][admitParticipantAsync][remoteParticipantId=${this.piiUtils.scrubMriOrOmit(g.id)}]`),this.telemetryHelper.recordEvent(Wi.ADMIT_PARTICIPANT,{causeId:m}),this.participantManager.admitParticipantAsync(g,this.links[Hi.LINKS.ADMIT],m)),this.admitAsync=g=>{if(this.logger.info(`[${g}][admitAsync]`),this.telemetryHelper.recordEvent(Wi.ADMIT,{causeId:g}),!this.links[Hi.LINKS.ADMIT_ALL]){const m={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.ADMIT_ALL_LINK_MISSING,phrase:Hi.CALL_END_PHRASE.ADMIT_ALL_URL_MISSING};return this.telemetryHelper.recordEvent(Wi.ADMIT_FAILURE,{causeId:g,transactionEnd:m}),this.logger.warn(`admitAsync error ${JSON.stringify(m)}`),Promise.reject(m)}const m=defer2();return this.callOperationHandler.setPendingOperation(0,g,{promise:m,causeId:g},g),this.sendNetworkRequestForAdmit(g),m.promise},this.updateMeetingRolesAsync=(g,m,f=causeId2())=>(assertNotNull(g,"participants array should be a non null value"),assertNotNull(m,"meetingRole should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"remote participant roles can only be updated in an ongoing call"),this.logger.info(`[${f}][updateMeetingRolesAsync][participants=${this.piiUtils.scrubMriOrOmit(g)}]`),this.participantManager.updateMeetingRolesAsync(g,m,this.links[Hi.LINKS.UPDATE_PARTICIPANT_ROLE],f)),this.startContentSharingAsync=(g,m,f,S,v=causeId2())=>(assertNotNull(g,"contentIdentifier should be a non null value"),assert2(this.isCallOngoing(),"contentSharing can only be added before starting an outgoing call or to an ongoing call"),this.logger.info(`[${v}][startContentSharingAsync]`),this.telemetryHelper.recordEvent(Wi.ADD_CONTENT_SHARING_MODALITY,{causeId:v}),this.contentSharingManager.startContentSharingAsync(g,m,f,this.links[Hi.LINKS.ADD_MODALITY],this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,v,S)),this.deleteContentSharingAsync=(g,m=causeId2())=>(this.logger.info(`[${m}][deleteContentSharingAsync][correlationId=${g}]`),this.telemetryHelper.recordEvent(Wi.DELETE_CONTENT_SHARING,{causeId:m,correlationId:g}),this.contentSharingManager.deleteContentSharingAsync(g,m)),this.joinContentSharingAsync=(g,m=causeId2())=>(this.logger.info(`[${m}][joinContentSharingAsync][correlationId=${g}]`),this.telemetryHelper.recordEvent(Wi.JOIN_CONTENT_SHARING,{causeId:m,correlationId:g}),this.contentSharingManager.joinContentSharingAsync(g,m)),this.updateContentSharingSessionStateAsync=(g,m,f=causeId2())=>(assertNotNull(m,"sessionState should be a non null value"),this.telemetryHelper.recordEvent(Wi.UPDATE_SESSION_STATE_CONTENT_SHARING,{causeId:f,correlationId:g}),this.logger.info(`[${f}][updateContentSharingSessionStateAsync][correlationId=${g}][sessionState=${m}]`),this.contentSharingManager.updateContentSharingSessionStateAsync(g,m,f)),this.takeContentSharingControlAsync=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Wi.TAKE_CONTROL_CONTENT_SHARING,{causeId:m,correlationId:g}),this.logger.info(`[${m}][takeContentSharingControlAsync][correlationId=${g}]`),this.contentSharingManager.takeContentSharingControlAsync(g,m)),this.updateContentSharingParticipantStateAsync=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANT_STATE_CONTENT_SHARING,{causeId:m}),this.logger.info(`[${m}][updateContentSharingParticipantStateAsync][correlationId=${g}]`),this.contentSharingManager.updateContentSharingParticipantStateAsync(g,m)),this.configureEndpointStateForStartOrJoin=g=>{const m={endpointStateSequenceNumber:this.endpointStateSequenceNumber};let f=!1;if(g&&(g.muted&&(f=!0,Object.assign(m,{state:{isMuted:g.muted}})),g.isPreheatOnly||g.additionalEndpointProperties)){const S={};f=!0,g.isPreheatOnly&&(S.preheatProperties=1),g.additionalEndpointProperties&&(S.additionalEndpointProperties=g.additionalEndpointProperties),Object.assign(m,{endpointProperties:S})}if(f)return m},this.gatherTelemetryForStartOrJoin=(g,m,f)=>{const S={causeId:m};return g&&(g.invitationType===Hi.INVITATION_TYPE.NUDGE&&(S.withNudge=g.invitationType===Hi.INVITATION_TYPE.NUDGE),g.parkContext&&(S.unpark=!0,S.context=g.parkContext),g.isPreheatOnly&&(S.isPreheatOnly=!0),g.targetApplicationType&&(S.targetApplicationType=g.targetApplicationType,this.telemetryHelper.setTargetApplicationType(g.targetApplicationType))),S},this.startOutgoingCall=(g,m,f,S,v=causeId2())=>{if(assertNotNull(g,"mediaContent should be a non null value"),assertNotNull(g.blob,"outgoingSdp should be a non null value"),assert2(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.logger.info(`[${v}][startOutgoingCall][start] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${v}][startOutgoingCall][failed][reason=Session disposed]`);this.lastUsedJoinCallOptions={muted:f?f.muted:null,scenario:f?f.scenario:null,isPreheatOnly:f?f.isPreheatOnly:null,clientEndpointCapabilities:f?f.clientEndpointCapabilities:null,clientEndpointDebugContent:f?f.clientEndpointDebugContent:null},this.originalRoleBeforePreheat=zi.ROLE.CALLER,f&&f.scenario&&this.telemetryHelper.setScenario(f.scenario),this.logger.info(`[${v}][startOutgoingCall]options=${getPrintableObject(this.gatherTelemetryForStartOrJoin(f,v,S))}`),this.isBrokerEnabledForOutgoingCall()&&this.setupBrokerChannel(),this.callUsesMixer=!(!f||!f.callUsesMixer),this.fsmState=Hi.SIGNALING_FSM_STATE.OUTGOING,this.meetingData=f&&f.meetingData,this.meetingPreferences=f&&f.meetingPreferences;const C={newCall:!0,suppressDialout:f&&f.suppressDialout||!1,conversationServiceUrl:this.signalingAgentConfig.conversationServiceUrl,onBehalfOf:f?f.onBehalfOf:null,onBehalfOfUserDisplayName:f?f.onBehalfOfUserDisplayName:null,callToVoicemail:!!f&&f.callToVoicemail,voicemailResourcePath:f?f.voicemailResourcePath:null,voicemailItemId:f?f.voicemailItemId:null,endpointState:this.configureEndpointStateForStartOrJoin(f),invitationType:f&&f.invitationType?f.invitationType:null,participantsToNudge:f&&Array.isArray(f.participantsToNudge)?f.participantsToNudge:null,routingFlags:f?f.routingFlags:null,parkContext:f?f.parkContext:null,pickupCode:f?f.pickupCode:null,scenario:f?f.scenario:null,isPreheatOnly:!!f&&f.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:f?f.clientEndpointCapabilities:0,clientEndpointDebugContent:f?f.clientEndpointDebugContent:null,invitationData:f?f.invitationData:null,conversationType:f?this.getConversationType(f.isEmergency,f.castCall,f.isHuddleGroupCall):null,meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,alternateId:f?f.alternateId:null,meetingRegistrationId:f?f.meetingRegistrationId:null,participantPin:f?f.participantPin:null,publishedStates:f?f.publishedStates:null,targetApplicationType:f?f.targetApplicationType:null};this.isCastCall=f&&f.castCall,this.isHuddleGroupCall=f&&f.isHuddleGroupCall,this.onBehalfOf=C.onBehalfOf,this.onBehalfOfUserDisplayName=C.onBehalfOfUserDisplayName,this.startOrJoinCall(C,qi.START_CALL.name,v,g,m)},this.joinGivenConversation=(g,m,f,S,v,C={},_=causeId2())=>{if(assertNotNull(m,"correlationId should be a non null value"),assertNotNullOrEmpty(g||this.getConversationUrl(),"conversationUrl should be a non null value"),assertNotNull(f,"mediaContent should be a non null value"),assertNotNull(f.blob,"outgoingSdp should be a non null value"),this.isPromotingToRealtime=2===this.callMode,assert2(this.isCallIdleOrRosterOnly()||this.isPromotingToRealtime,"a call is already in progress"),this.logger.info(`[${_}][joinGivenConversation][start][correlationId=${m}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed)return void this.logger.warn(`[${_}][joinGivenConversation][failed][reason=Session disposed]`);const E=this.gatherTelemetryForStartOrJoin(C,_,v);this.lastUsedJoinCallOptions=C,this.originalRoleBeforePreheat=zi.ROLE.JOIN,this.telemetryHelper.startCallInitializationWatch(v),C&&C.scenario&&this.telemetryHelper.setScenario(C.scenario),this.logger.info(`[${_}][joinGivenConversation]options=${getPrintableObject(E)}`),this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Hi.SIGNALING_FSM_STATE.OUTGOING,this.updateCorrelationId(m,_),this.meetingData=C&&C.meetingData,this.meetingPreferences=C&&C.meetingPreferences;const T={newCall:!1,suppressDialout:!0,conversationServiceUrl:g,endpointState:this.configureEndpointStateForStartOrJoin(C),scenario:C?C.scenario:null,isPreheatOnly:!!C&&C.isPreheatOnly,applicationType:this.participantManager.localParticipant.applicationType,clientEndpointCapabilities:C?C.clientEndpointCapabilities:0,clientEndpointDebugContent:C?C.clientEndpointDebugContent:null,conversationType:C?this.getConversationType(C.isEmergency,!1):null,meetingPreferences:this.meetingPreferences,meetingData:this.meetingData,meetingRegistrationId:C?.meetingRegistrationId,participantPin:C?.participantPin,sharedLineCallInvitationContent:C?.sharedLineCallInvitationContent,applyServerMute:C?.applyServerMute,publishedStates:C?.publishedStates,invitationData:C?.invitationData};this.isCastCall=!1,this.startOrJoinCall(T,qi.JOIN_CONVERSATION.name,_,f,S)},this.subscribeToCall=(g,m,f=0,S,v=causeId2())=>{assertNotNull(m,"correlationId should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.IDLE,"a call is already in progress");let C=g;return C||(C=this.signalingAgentConfig.conversationServiceUrl,this.logger.info(`conversationServiceUrl passed is empty. so it is set to ${C}`)),assertNotNullOrEmpty(C,"conversationUrl should be a non null value"),this.logger.info(`[${v}][subscribeToCall][start][correlationId=${m}] applicationType=${this.participantManager.localParticipant.applicationType}`),this.disposed?(this.logger.warn(`[${v}][subscribeToCall][failed][reason=Session disposed]`),Promise.reject(Hi.CALL_END_CODE.CALL_DOES_NOT_EXIST)):(this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.lastUsedJoinCallOptions=S||{},this.lastUsedJoinCallOptions.clientEndpointCapabilities=f||this.lastUsedJoinCallOptions?.clientEndpointCapabilities,this.meetingData=S?.meetingData,this.meetingPreferences=S?.meetingPreferences,this.fsmState=Hi.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY,this.updateCorrelationId(m,v),this.http.sendPostRequest({url:C,requestName:qi.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,operationType:"CallSetup",payload:getPayload35(this,null,null,{subscribe:!0,clientEndpointCapabilities:f,...S,applicationType:this.participantManager.localParticipant.applicationType,endpointState:this.configureEndpointStateForStartOrJoin({additionalEndpointProperties:S?.additionalEndpointProperties})},v),causeId:v}).then((g=>{this.disposed||(this.fsmState=Hi.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.processConversationServiceResponseHeaders(g,v),this.processConversationServiceResponse(g.response,v,1),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY,v))})).catch((g=>{if(g.stack&&!this.isFatalException(g))return Promise.resolve();const m=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${v}][subscribeToCall] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(m)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,endCode:m.telemetryEndSubCode,endSubCode:m.error.subCode,resultCategories:m.error.resultCategories,resultDetail:m.error.phrase||this.getTerminatingCallResultDetail("subscribe",m.error),causeId:v}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,v,m.error),Promise.reject(m.error))})))},this.getCallReplacementDetailsForCall=(g,m=causeId2())=>{this.logger.info(`[${m}] getCallReplacementDetailsForCall callId ${g}`);const f=this.signalingAgent.getSignalingSession(g);return f?f.getCallReplacementDetails(m):{replaces:""}},this.getCallReplacementDetails=(g=causeId2())=>(this.logger.info(`[${g}] getCallReplacementDetails`),{replaces:this.links[Hi.LINKS.REPLACE]}),this.transferCallAsync=(g,m,f,S,v=causeId2())=>{this.logger.info(`[${v}] transferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(g)} transferType ${m} callTransferOptions: ${safeJsonStringify(S)}`),this.transferHelper(g,m,f,S,v)},this.redirectCall=(g,m=causeId2(),f)=>{const{id:S,endpointType:v,type:C}=g.redirectOptions;if(this.logger.info(`[${m}] redirectCall: targetId: ${this.piiUtils.scrubMriOrOmit(S)} targetEndpointType ${v}`),!this.isRedirectAllowed){const g={code:Hi.CALL_END_CODE.REJECT,phrase:Hi.CALL_END_PHRASE.CALL_REDIRECT_IS_NOT_ALLOWED};return Promise.reject(g)}this.telemetryHelper.recordEvent(Wi.CALL_REDIRECT,{causeId:m});const _=getPayload30(this,C,S,v);return this.http.sendPostRequest({url:this.links[Hi.LINKS.REDIRECT],requestName:qi.SEND_CALL_REDIRECT_REQUEST.name,payload:_,causeId:m}).then((S=>(this.logger.info(`[${m}][redirectCall] succeeds. Leaving the call...`),this.telemetryHelper.recordEvent(Wi.CALL_REDIRECT_REQUEST_SENT,{causeId:m,targetEndpointType:v}),this.terminateEstablishedCall(f,g)))).catch((g=>{const S=getErrorForXHRFailure(g);this.logger.info(`[${m}][redirectCall] error: ${getPrintableObject(S)}`);const C=S.error;return this.telemetryHelper.recordEvent(Wi.CALL_REDIRECT_REQUEST_FAILED,{causeId:m,transactionEnd:C,endpointType:v}),this.disposed||(this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,endCode:f.code,endSubCode:f.subCode,clientReasonSubCode:f.clientReasonSubCode,clientReasonPhrase:f.clientReasonPhrase,resultDetail:f.phrase||"RedirectCall",resultCategories:f.resultCategories,causeId:m}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,f),this.dispose(f,m)),Promise.reject(C)}))},this.transferHelper=(g,m,f,S,v=causeId2())=>{assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet");let C=!1;this.logger.info(`[${v}][transferHelper][replacementDetails=${getPrintableObject(f)}] disableForwardingAndUnanswered=${S&&S.disableForwardingAndUnanswered}`),this.telemetryHelper.recordEvent(Wi.TRANSFER_CALL,{causeId:v}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(v,C)}),Hi.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT),this.http.sendPostRequest({url:this.links[Hi.LINKS.TRANSFER],requestName:qi.SEND_TRANSFER_REQUEST.name,payload:getPayload47(g,this,f,m,S),causeId:v}).then((()=>{this.telemetryHelper.recordEvent(Wi.WAITING_FOR_TRANSFER_ACCEPTANCE,{causeId:v}),C=!0})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${v}][transferCallAsync] error: ${getPrintableObject(m)}`),this.disposed||(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Hi.CALL_END_CODE.NETWORK_ERROR,reason:getPrintableObject(g)}},v),this.telemetryHelper.recordEvent(Wi.TRANSFER_REQUEST_FAILED,{causeId:v,...m.error}))})),this.telemetryHelper.recordEvent(Wi.TRANSFER_REQUEST_SENT,{causeId:v,transferType:m})},this.consultTransferCallAsync=(g,m,f,S,v)=>{let C,_;if(this.logger.info(`[${S}] consultTransferCallAsync: transferTargetMri: ${this.piiUtils.scrubMriOrOmit(m)} transferTargetParticipantLegId: ${f}`),f?(_=this.getMriByParticipantLegOfCall(g,f,S),C=this.getReplacementDetailsByParticipantLegOfCall(g,m,f,S)):(_=m,C=this.getCallReplacementDetailsForCall(g,S)),!_||!C){const v=C?"target mri corresponding not found":`unable to retrieve replacementDetails for transferTargetCallId: ${g}, transferTargetMri: ${m}, transferTargetParticipantLegId: ${f}`;return this.logger.info(`[${S}] consultTransferCallAsync: error: ${v}`),void this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Hi.CALL_END_CODE.BAD_REQUEST,reason:v}},S)}this.transferHelper(_,"TransferTypeStandard",C,v,S)},this.isParkByTransfer=(g,m)=>{const f=["serverHold","sharedLinePark","teamPark"].indexOf(g)>-1;return this.logger.info(`[${m}][isParkByTransfer][context=${g}] result = ${f}`),f},this.parkCallAsync=(g,m=causeId2())=>{if(g&&"none"===g){throw{code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"}}return assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"call is not connected yet"),this.logger.info(`[${m}][parkCallAsync][context=${g}]`),this.telemetryHelper.recordEvent(Wi.PARK_CALL,{causeId:m,parkType:getParkTypeName(g)}),this.isParkByTransfer(g,m)?this.parkByTransfer(g,m):this.park(g,m)},this.unparkAsync=(g,m=causeId2())=>{if(g&&"none"===g){throw{code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark context is missing or none"}}if(!this.links[Hi.LINKS.UNPARK]){throw{code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.PARK_UNPARK_TYPE_MISSING,phrase:"Unpark link not available"}}this.logger.info(`[${m}][unparkAsync][context=${g}]`),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UNPARK_COMPLETION,(()=>{this.handleUnparkError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UNPARK_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UNPARK_COMPLETION_TIMEOUT},Wi.WAITING_FOR_UNPARK_COMPLETION_TIMEOUT,m,g)}),Hi.TIMEOUT_VALUES_IN_SECONDS.UNPARK_COMPLETION_TIMEOUT);const f={causeId:m};return this.http.sendPostRequest({url:this.links[Hi.LINKS.UNPARK],requestName:qi.SEND_UNPARK_REQUEST.name,payload:getPayload49(this,f),causeId:m}).then((g=>(this.logger.info(`[${m}][unparkAsync] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_UNPARK_COMPLETION,{causeId:m}),Promise.resolve()))).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${m}][unparkAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUnparkError(S.error,Wi.UNPARK_REQUEST_FAILED,m,g),Promise.reject(S.error))}))},this.handleUpdateParticipantsPropertiesCompletion=g=>{const m=g.body,f=extractCauseIdFromMessage(g),S=this.logger.createChild(`[${f}][handleUpdateParticipantsPropertiesCompletion]`,this.correlationId),v={};if(this.disposed)S.info("ignored. Call disposed.");else{if(m.operationId||S.warn("operationId is undefined."),S.info("starts"),m.participantInfos)for(const g of m.participantInfos){if(!g.participant.id){S.warn("participant id is undefined."),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,"participant id is undefined in response, property");continue}if(!g.participant.key){S.warn("property name (key) is undefined."),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,"property name (key) is undefined in response");continue}const C=mapMriAndPropertyNameToResolveString(g.participant.id,m.operationId,g.participant.key),_={code:g.transactionEnd.code,subCode:g.transactionEnd.subCode,phrase:g.transactionEnd.phrase,resultCategories:g.transactionEnd.resultCategories};S.info(`Update participants properties completed for: ${this.piiUtils.scrubMriOrOmit(g.participant.id)} with transactionEnd ${getPrintableObject(_)}`),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_COMPLETED,{causeId:f,resolveId:this.piiUtils.scrubMriOrOmit(C),property:g.participant.key,result:getPrintableObject(_)}),v[C]=_,this.updateParticipantsPromises[m.operationId].delete(C)}this.checkAndCleanupPromisesForOperationId(m.operationId),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(v,m.operationId,f)}},this.getCallStatus=()=>this.currentCallStatus,this.processIncomingCallRequest=(g,m,f=causeId2())=>{if(assertNotNull(g,"request should be a non null value"),assertNotNullOrEmpty(g.body,"request should have a valid body"),assertNotNullOrEmpty(g.body.gp||g.body.cp,"request body should have payload"),assert2(this.isCallIdleOrRosterOnly(),"a call is already in progress"),this.callUsesMixer=g.fromMixer,this.logger.info(`[${f}][processIncomingCallRequest][start]`),this.disposed)return void this.logger.warn("processIncomingCallRequest canceled");this.telemetryHelper.startCallInitializationWatch(),this.isIncomingCall=!0,this.isBrokerEnabledForIncomingCall()&&this.setupBrokerChannel(),this.fsmState=Hi.SIGNALING_FSM_STATE.INCOMING,this.participantManager.initializeForIncomingCall();let S={};try{m&&(S=JSON.parse(m))}catch(g){this.logger.warn("Unable to parse endpoint metadata")}this.endpointMetadata=S;try{let m;if(g&&g.body&&g.body.gp&&!isStringBase64(g.body.gp))this.logger.info(`[${f}][processIncomingCallRequest] unencoded payload, skipping decoding.`),m=g.body.gp;else{const f=g.body.gp?atob(g.body.gp):decodeMessage(g.body.cp);m=JSON.parse(f)}if(!m.callNotification)throw this.logger.info(`[${f}][processIncomingCallRequest][failed][reason=CallNotification missing]`),new Error("CallNotification is missing");this.processIncomingCallPayload(m,f),this.incomingCallPayload=m}catch(g){this.endIncomingCallBecauseOfInvalidPayload(f)}},this.sendAttachToCall=(g=causeId2())=>(this.logger.info(`[${g}][sendAttachToCall]`),this.incomingCallPayload?(this.onCallStatusChanged(Hi.CALL_STATUS.IDLE,g),this.sendAttachToCallInternal(g)):(this.endIncomingCallBecauseOfInvalidPayload(g),Promise.reject(Hi.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD))),this.supportsNewOfferRequest=()=>this.signalingAgentConfig.handleNewOfferRequest,this.requestNewOffer=(g,m=causeId2())=>(this.telemetryHelper.recordEvent(Wi.REQUEST_NEW_OFFER,{compatibleContentTypes:g,causeId:m}),this.signalingAgentConfig.handleNewOfferRequest?(assertNotNullOrEmpty(this.links[Hi.LINKS.NEW_OFFER],"newOffer link should be a non null value"),this.http.sendPostRequest({url:this.links[Hi.LINKS.NEW_OFFER],requestName:qi.REQUEST_NEW_OFFER.name,payload:getPayload37(this,g,this.links[Hi.LINKS.NEW_OFFER]),causeId:m}).then((g=>this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):Promise.resolve(g))).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[requestNewOffer][${m}] error ${getPrintableObject(f)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,endCode:f.telemetryEndSubCode,endSubCode:f.error.subCode,resultCategories:f.error.resultCategories,resultDetail:f.error.phrase||this.getTerminatingCallResultDetail("requestNewOffer",f.error),causeId:m}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,f.error),this.dispose(f.error,m),Promise.reject(f.error))}))):Promise.reject("Disabled")),this.endAsync=(g,m={})=>{m.causeId=m.causeId||causeId2();const f=m.causeId;if(this.logger.info(`[${f}][endAsync][rejectionData=${g&&getPrintableObject(g)}][endCallForAll=${m.forEveryone}]`),this.disposed)return this.logger.warn(`[${f}][endAsync] canceled but session already disposed`),Promise.resolve(null);if(this.disposing=!0,this.telemetryHelper.recordEvent(Wi.END_CALL,g?{code:g.code,subCode:g.subCode,causeId:f,callEndClientSubCode:g.clientReasonSubCode,callEndClientPhrase:g.clientReasonPhrase}:{causeId:f}),m.preventAllCallbacks){const g=Object.keys(this.signalingSessionCallback);for(const m of g)this.signalingSessionCallback[m]=en.noop}const S=this.mediaRenegotiationManager?.isIncomingRenegotiationInProgress()||this.mediaRenegotiationManager?.isOutgoingRenegotiationInProgress();if(this.telemetryHelper.stopCallCancelationDurationWatch(),this.fsmState===Hi.SIGNALING_FSM_STATE.INCOMING)return g.code===Hi.CALL_END_CODE.CALL_REDIRECTED?this.redirectCall(m,f,g):this.rejectIncomingCall(g,f);if(this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING||this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY)return this.cancelOutgoingCall(g,f);if(this.fsmState===Hi.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK)return this.rejectIncomingCall(g,f);if((this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED||S)&&m.forEveryone)return this.deleteConversation(g,f);if(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY||S)return this.terminateEstablishedCall(g,m);{this.logger.info(`[${f}][endAsync] there is no call to cancel or end or reject in current state`);const m={code:isNaN(g?.code)?Hi.CALL_END_CODE.NOT_FOUND:g.code,subCode:isNaN(g?.subCode)?Hi.CALL_END_SUB_CODE.CALL_NOT_ATTEMPTED:g.subCode,phrase:g?.phrase||Hi.CALL_END_PHRASE.CALL_DOES_NOT_EXIST,resultCategories:g?.resultCategories||[ki.ExpectedError],clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};return this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultDetail:m.phrase||"CallDoesNotExist",endCode:m.code,endSubCode:m.subCode,resultCategories:m.resultCategories,causeId:f,clientReasonSubCode:m.clientReasonSubCode,clientReasonPhrase:m.clientReasonPhrase}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,f,m),this.dispose(m,f),Promise.resolve(null)}},this.handleIncomingMsgAsync=(g,m=Hi.INCOMING_MESSAGE_ORIGIN.TROUTER)=>{assertNotNull(g,"incoming message should be a non null value");const f=extractMessageIdFromMessage(g),S=defer2(),v=g.body,C=g.url,_={...g,origin:m},E=extractCauseIdFromMessage(_);if(this.logger.info(`[${E}][handleIncomingMsgAsync][url=${C}][messageId=${f}]`),!v)return this.logger.info(`[${E}][handleIncomingMsgAsync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Wi.MESSAGE_MISSING_BODY,{origin:m,messageId:f,causeId:E}),S.reject(new Error("received message with no body")),S.promise;if(this.disposed)return this.logger.info(`[${E}][handleIncomingMsgAsync][failed][reason=call is disposed]`),S.reject(this.getCallNotFoundTransactionEnd()),S.promise;if(this.isDuplicatedIncomingMessage(_))return this.logger.info(`[${E}][handleIncomingMsgAsync][failed][reason=duplicate]`),this.telemetryHelper.recordEvent(Wi.DUPLICATE_MESSAGE_IGNORED,{origin:m,messageId:f,causeId:E}),S.resolve(new Error("Message was already handled")),S.promise;this.checkCorrelationIdChange(g,E);const T={[Bi.CALL_NOTIFICATION]:g=>{this.handleCallNotification(g)},[Bi.MEDIA_ANSWER]:g=>{this.handleMediaAnswer(g)},[Bi.MEDIA_ACKNOWLEDGEMENT]:g=>{this.handleMediaAcknowledgement(g)},[Bi.CALL_ACCEPTANCE]:g=>{this.handleCallAcceptance(g)},[Bi.CALL_END]:g=>{this.handleCallEnd(g)},[Bi.CALL_PROGRESS]:g=>{this.handleCallProgress(g)},[Bi.CALL_ACCEPTANCE_ACKNOWLEDGEMENT]:g=>{this.handleCallAcceptanceAck(g)},[Bi.MEDIA_NEGOTIATION]:g=>{this.mediaRenegotiationManager?.handleMediaNegotiationOffer(g)},[Bi.MEDIA_NEGOTIATION_FAILURE]:g=>{this.mediaRenegotiationManager?.handleMediaNegotiationFailure(g)},[Bi.BALANCE_UPDATE]:g=>{this.handlePSTNBalanceUpdate(g)},[Bi.RETARGET_COMPLETED]:g=>{this.mediaRenegotiationManager?.handleRetargetCompleted(g)},[Bi.CALL_TRANSFER]:g=>{this.handleTransferRequested(g)},[Bi.TRANSFER_COMPLETION]:g=>{this.handleTransferCompletion(g)},[Bi.TRANSFER_ACCEPTANCE]:g=>{this.handleTransferAcceptance(g)},[Bi.PARK_COMPLETION]:g=>{this.handleParkCompletion(g)},[Bi.UNPARK_COMPLETION]:g=>{this.handleUnparkCompletion(g)},[Bi.UPDATE_MEETING_LIVE_STATE_RESPONSE]:g=>{this.handleUpdateMeetingLiveStateCompletion(g)},[Bi.UPDATE_MEETING_GROUPS_RESPONSE]:g=>{this.handleUpdateMeetingGroupsCompletion(g)},[Bi.SET_MEETING_LAYOUT_RESPONSE]:g=>{this.handleSetMeetingLayoutCompletion(g)},[Bi.UPDATE_MEETING_STATES_RESPONSE]:g=>{this.handleUpdateMeetingStatesCompletion(g)}},I={[Vi.CONTROL_VIDEO_STREAMING]:g=>{this.webRtcSignalingManager.handleControlVideoStreaming(g)},[Vi.DOMINANT_SPEAKER_INFO]:g=>{this.webRtcSignalingManager.handleDominantSpeakerInfo(g)},[Vi.CSRC_INFO]:g=>{this.webRtcSignalingManager.handleCsrcInfo(g)},[Vi.CONV_ROSTER_UPDATE]:g=>{this.handleRosterUpdate(g,!1)},[Vi.NEW_MEDIA_OFFER]:g=>{this.handleNewMediaOffer(g)},[Vi.CONV_ADD_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleAddParticipantSuccess(g)},[Vi.CONV_ADD_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleAddParticipantFailure(g)},[Vi.CONV_ADMIT_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleAdmitParticipantSuccess(g)},[Vi.CONV_ADMIT_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleAdmitParticipantFailure(g)},[Vi.CONV_ADMIT_ALL_STATUS]:g=>{this.handleAdmitAllStatus(g)},[Vi.CONV_REMOVE_PARTICIPANT_SUCCESS]:g=>{this.participantManager.handleRemoveParticipantSuccess(g)},[Vi.CONV_REMOVE_PARTICIPANT_FAILURE]:g=>{this.participantManager.handleRemoveParticipantFailure(g)},[Vi.CONV_CONFIRM_UNMUTE]:g=>{this.participantManager.handleUnmuteConfirmRequest(g)},[Vi.CONV_UPDATE]:g=>{this.handleConversationUpdate(g)},[Vi.CONV_LOCAL_PARTICIPANT_UPDATE]:g=>{this.handleLocalParticipantUpdate(g)},[Vi.CONV_ADD_MODALITY_SUCCESS]:g=>{this.handleAddModalitySuccess(g)},[Vi.CONV_ADD_MODALITY_FAILURE]:g=>{this.handleAddModalityFailure(g)},[Vi.CONV_BROADCAST_UPDATE]:g=>{this.broadcastSession.handleBroadcastStateChanged(g)},[Vi.CONV_CONTENT_SHARING_UPDATE]:g=>{this.contentSharingManager?.handleContentSharingUpdate(g)},[Vi.CONV_CONTENT_SHARING_END]:g=>{this.contentSharingManager?.handleContentSharingEnd(g)},[Vi.CONV_END]:g=>{this.handleCallEnd(g)},[Vi.UPDATE_PARTICIPANT_INTERPRETATION_STATE_STATUS]:g=>{this.participantManager.handleUpdateParticipantInterpretationStateCompletion(g)},[Vi.UPDATE_PARTICIPANT_PROPERTIES_STATUS]:g=>{this.handleUpdateParticipantsPropertiesCompletion(g)},[Vi.JOIN_MEETING_GROUP_STATUS]:g=>{this.handleJoinMeetingGroupCompletion(g)},[Vi.LEAVE_MEETING_GROUP_STATUS]:g=>{this.handleLeaveMeetingGroupCompletion(g)},[Vi.RECEIVE_MESSAGE]:g=>{this.handleReceiveMessage(g)},[Vi.SEND_MESSAGE_STATUS]:g=>{this.proxiedMessageNotificationManager.handleProxiedMessageNotification(g)},[Vi.DISABLE_PREHEAT_ASYNC_STATUS]:g=>{this.handleDisablePreheatCompletion(g)}};try{const g=Object.keys(T).filter((g=>v.hasOwnProperty(g)))[0],m=Object.keys(I).filter((g=>_.url&&stringEndsWith(_.url,g)))[0];g?T[g](_):m?I[m](_):(this.telemetryHelper.recordEvent(Wi.UNKNOWN_MESSAGE_TYPE,{messageId:f}),this.logger.info(`[${E}][handleIncomingMsgAsync][failed][reason=received unknown message]`)),S.resolve(!0)}catch(g){this.telemetryHelper.recordEvent(Wi.FAILED_TO_HANDLE_MESSAGE,{messageId:f,error:getPrintableObject(g)}),this.logger.info(`[${E}][handleIncomingMsgAsync][failed][reason=${g.message}]`),S.reject(new Error(g.message))}return S.promise},this.canHandleIncomingMsgSync=g=>{if(this.signalingAgentConfig.supportsSynchronousTrouterResponse){const m=g.body;return Boolean(m.callAcceptance)}return!1},this.handleIncomingMsgSync=g=>{const m=extractMessageIdFromMessage(g),f=g.body,S=g.url,v=Hi.INCOMING_MESSAGE_ORIGIN.TROUTER,C={...g,origin:v},_=extractCauseIdFromMessage(C);this.logger.info(`[${_}][handleIncomingMsgSync][url=${S}][messageId=${m}]`);const E=C.headers;let T=Hi.HTTP_STATUS_CODES.OK,I="";const b=new Gi;if(isDuplicateMessage(E,this.incomingTrouterMessagesSeenSoFar)){this.logger.info(`[${_}][handleIncomingMsgSync][failed][reason=duplicate]`);const g=getMessageResultFromCache(E,this.incomingMessageSyncResponseCache);if(g)return this.logger.info(`[${_}][handleIncomingMsgSync][cachedResponse]`),g;this.telemetryHelper.recordEvent(Wi.DUPLICATE_MESSAGE_IGNORED,{origin:v,messageId:m,causeId:_}),this.logger.info(`[${_}][handleIncomingMsgSync][failed][reason=cachedResponseNotFound]`),T=Hi.HTTP_STATUS_CODES.BAD_REQUEST}else if(f){if(f.callAcceptance)try{I=safeJsonStringify(this.handleCallAcceptanceSync(C))}catch(g){this.telemetryHelper.recordEvent(Wi.FAILED_TO_HANDLE_MESSAGE,{messageId:m,origin:v,causeId:_,error:getPrintableObject(g)}),this.logger.info(`[${_}][handleIncomingMsgSync][failed][reason=${g&&g.message}]`),T=Hi.HTTP_STATUS_CODES.BAD_REQUEST}}else this.logger.info(`[${_}][handleIncomingMsgSync][failed][reason=received message with no body]`),this.telemetryHelper.recordEvent(Wi.MESSAGE_MISSING_BODY,{origin:v,messageId:m,causeId:_}),T=Hi.HTTP_STATUS_CODES.BAD_REQUEST;E&&(E.get(Hi.HEADERS.CORRELATION_ID)&&b.set(Hi.HEADERS.CORRELATION_ID,E.get(Hi.HEADERS.CORRELATION_ID)),E.get(Hi.HEADERS.MESSAGE_ID)&&b.set(Hi.HEADERS.MESSAGE_ID,E.get(Hi.HEADERS.MESSAGE_ID)));const A={resultCode:T,responseBody:I,responseHeaders:b.getAll()};return cacheMessageResult(E,this.incomingMessageSyncResponseCache,A),this.logger.info(`[${_}][handleIncomingMsgSync][success][resultCode=${T}]`),A},this.acceptRenegotiationAsync=(g,m,f=causeId2())=>(assertNotNull(g.blob,"finalSdp should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${f}][acceptRenegotiationAsync][mediaTypes=${m}]`),this.mediaRenegotiationManager.acceptRenegotiationAsync(g,m,f)),this.setProvisionalAnswerAsync=(g,m=causeId2())=>{assertNotNull(g.blob,"sdp should be a non null value"),this.telemetryHelper.recordEvent(Wi.SET_PROVISIONAL_ANSWER,{causeId:m});const f=defer2();return this.fsmState!==Hi.SIGNALING_FSM_STATE.INCOMING?(this.logger.info(`[setProvisionalAnswerAsync][${m}] there is no incoming call to set provisional answer on.`),f.reject(new Error("there is no incoming call to set provisional answer on.")),f.promise):(this.http.sendPostRequest({url:this.links[Hi.LINKS.MEDIA_ANSWER],requestName:qi.SEND_MEDIA_ANSWER.name,payload:getPayload55(this,g),causeId:m}).then((g=>{this.disposed||this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTING,m),f.resolve(null),this.disposed||(this.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_ACKNOWLEDGEMENT,{causeId:m}),this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Hi.CALL_STATUS.RINGING,m),this.signalingSessionCallback.onMediaAcknowledgementSuccess(!1,m))})).catch((g=>{const S=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[setProvisionalAnswerAsync][${m}] error: ${getPrintableObject(S)}`),this.disposed?f.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(Wi.SET_PROVISIONAL_ANSWER_FAILED,{causeId:m}),f.reject(S.error))})),f.promise)},this.startRenegotiationAsync=(g,m,f=causeId2())=>(assertNotNull(g,"mediaContent should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${f}][startRenegotiationAsync]`),this.mediaRenegotiationManager.startRenegotiationAsync(g,this.links[Hi.LINKS.MEDIA_RENEGOTIATION],m,f)),this.updateMediaDescriptionsAsync=(g=causeId2(),m)=>{assertNotNull(m,"mediaDescriptions should be a non null value"),assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"updateMediaDescriptions operations are only allowed when the call is connected");const f=this.links[Hi.LINKS.UPDATE_MEDIA_DESCRIPTIONS];return assertNotNull(f,"updateMediaDescriptionsUrl should be a non null value"),this.telemetryHelper.recordEvent(Wi.UPDATE_MEDIA_DESCRIPTIONS,{causeId:g}),this.http.sendPostRequest({url:f,requestName:qi.UPDATE_MEDIA_DESCRIPTIONS.name,payload:getPayload56(this,m),causeId:g}).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingAgentConfig);return this.logger.info(`[updateMediaDescriptionsAsync][${g}] error: ${getPrintableObject(f)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.telemetryHelper.recordEvent(Wi.UPDATE_MEDIA_DESCRIPTIONS_FAILED,{causeId:g}),Promise.reject(f.error))}))},this.acceptAsync=(g,m,f,S=causeId2())=>{assertNotNull(g,"mediaContent should be a non null value"),assertNotNull(g.blob,"outgoingSdp should be a non null value"),this.logger.info(`[${S}][acceptAsync][mediaTypes=${m}]`),this.telemetryHelper.recordEvent(Wi.ACCEPT_CALL,{causeId:S}),this.telemetryHelper.setAnsweredModalities(g.blob);const v=defer2();return this.fsmState!==Hi.SIGNALING_FSM_STATE.INCOMING?(this.logger.warn("acceptAsync, there is no incoming call to accept"),v.reject(new Error("there is no incoming call to accept")),v.promise):(this.fsmState=Hi.SIGNALING_FSM_STATE.WAITING_CALL_ACCEPTANCE_ACK,this.http.sendPostRequest({url:this.links[Hi.LINKS.ACCEPT],requestName:qi.SEND_ACCEPTANCE.name,payload:getPayload28(this,g,m,f),causeId:S}).then((g=>{this.disposed||(this.currentCallStatus===Hi.CALL_STATUS.IDLE&&(this.telemetryHelper.setTimeToRingDuration(),this.telemetryHelper.recordEvent(Wi.ACCEPTED_BEFORE_RINGING,{causeId:S}),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTING,S)),g.response.callAcceptanceAcknowledgement&&(this.logger.info("acceptAsync, handling inlined callAcceptanceAcknowledgement"),this.internalHandleCallAcceptanceAck(g.response,S))),v.resolve(null)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[acceptAsync][${S}] error: ${getPrintableObject(m)}`),this.disposed?v.reject(this.getCallNotFoundTransactionEnd()):(this.fsmState=Hi.SIGNALING_FSM_STATE.INCOMING,this.telemetryHelper.recordEvent(Wi.ACCEPT_CALL_FAILED,{causeId:S,xhrError:m}),v.reject(m.error))})),v.promise)},this.rejectRenegotiationAsync=(g,m=causeId2())=>(assert2(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED,"Renegotation operations are only allowed when the call is connected and no disconnect operation is in flight"),this.logger.info(`[${m}][rejectRenegotiationAsync][rejectionData=${g}]`),this.mediaRenegotiationManager.rejectRenegotiationAsync(g,m)),this.saveMediaControllerLinksIfAny=g=>{g.links&&(this.links[Hi.LINKS.CONTROL_VIDEO_STREAMING]=g.links.controlVideoStreaming||this.links[Hi.LINKS.CONTROL_VIDEO_STREAMING],this.links[Hi.LINKS.APPLY_CHANNEL_PARAMETERS]=g.links.applyChannelParameters||this.links[Hi.LINKS.APPLY_CHANNEL_PARAMETERS])},this.getInitialMediaOfferFromIncomingCallPayload=(g=causeId2())=>{if(!this.signalingAgentConfig.handleMediaOfferFromPushNotification)return null;const m=this.incomingCallPayload&&this.incomingCallPayload.callNotification&&this.incomingCallPayload.callNotification.mediaContent?this.incomingCallPayload.callNotification.mediaContent:null;return this.telemetryHelper.setIsSdpInCallNotification(!!m),m},this.updateCorrelationId=(g,m=causeId2())=>{if(this.logger.info(`[${m}][updateCorrelationId][old=${this.correlationId}][new=${g}]`),this.correlationId!==g&&!this.disposed){const f=this.correlationId;this.correlationId=g,this.telemetryHelper&&this.telemetryHelper.recordEvent&&this.telemetryHelper.recordEvent(Wi.CORRELATION_ID_UPDATED,{newId:this.correlationId,oldId:f,causeId:m}),this.signalingSessionCallback&&this.signalingSessionCallback.onCorrelationIdUpdated&&this.signalingSessionCallback.onCorrelationIdUpdated(this.correlationId,m)}},this.endIncomingCallBecauseOfInvalidPayload=g=>{this.logger.info(`[${g}][endIncomingCallBecauseOfInvalidPayload]`),this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE;const m={code:Hi.CALL_END_CODE.BAD_REQUEST,subCode:Hi.CALL_END_SUB_CODE.BAD_NOTIFICATION_PAYLOAD,phrase:Hi.CALL_END_PHRASE.BAD_NOTIFICATION_PAYLOAD,resultCategories:[ki.UnexpectedServerError]};this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,endCode:m.code,endSubCode:m.subCode,resultDetail:m.phrase||"EndIncomingCall",resultCategories:m.resultCategories,causeId:g}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,g,m),this.dispose(m,g)},this.isDuplicatedIncomingMessage=g=>g.origin===Hi.INCOMING_MESSAGE_ORIGIN.BROKER&&isDuplicateMessage(g.headers,this.incomingBrokerMessagesSeenSoFar)||g.origin===Hi.INCOMING_MESSAGE_ORIGIN.TROUTER&&isDuplicateMessage(g.headers,this.incomingTrouterMessagesSeenSoFar),this.getEndpointState=()=>{let g;return g=this.startOrJoinConvResponseReceived?{...this.latestEndpointState}:{...this.requestedEndpointStateWhileConnecting},g},this.setMultiParty=(g,m)=>{const f=!!g;this.multiParty!==f&&(this.telemetryHelper.recordEvent(Wi.SET_MULTIPARTY,{isMultiparty:f,causeId:m}),this.multiParty=f)},this.setupTrouterChannel=()=>{this.logger.info(`Broker config: outgoing=${this.signalingAgentConfig.brokerEnabledOutgoing?"enabled":"disabled"}incoming=${this.signalingAgentConfig.brokerEnabledIncoming?"enabled":"disabled"}batching=${this.signalingAgentConfig.brokerRequestBatching?"enabled":"disabled"}exclusive=${this.signalingAgentConfig.brokerExclusively?"enabled":"disabled"}`);const setTrouterUrl=g=>{g&&"string"==typeof g&&g.trim()&&(this.baseMessagingChannelUrl=this.previousTrouterUrl=this.currentTrouterUrl=g.trim(),this.telemetryHelper.addTrouterChannel())};this.brokerExclusiveEnabled()||(this.signalingAgentConfig.trouterServiceProvider?(2===this.signalingAgentConfig.trouterServiceProvider.state()&&this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync().then(setTrouterUrl),this.signalingAgentConfig.trouterServiceProvider.onStateChanged(this.onTrouterStateChanged)):(setTrouterUrl(this.signalingAgentConfig.trouterUrlGetter.trouterUrl()),this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed(this.onTrouterUrlChanged)))},this.isTrouterDisconnected=()=>{try{return 3===this.signalingAgentConfig.trouterServiceProvider.state()}catch(g){return!1}},this.forceTrouterConnectionCheck=()=>{try{return void this.signalingAgentConfig.trouterServiceProvider.checkConnection(!1)}catch(g){return}},this.navigatorOnlineCallback=()=>{this.disposed||(this.reportConnectivityStatus(),this.isTrouterDisconnected()&&this.signalingAgentConfig.forceTrouterReconnectOnNetworkOnline&&this.forceTrouterConnectionCheck())},this.navigatorOfflineCallback=()=>{this.reportConnectivityStatus()},this.reportConnectivityStatus=()=>{if(!this.disposed){const g=isTrouterAndNavigatorConnected(this.signalingAgentConfig.trouterServiceProvider);this.logger.info(`[Connectivity] status=${g}`),this.telemetryHelper.recordEvent(Wi.CONNECTIVITY_CHANGED,{status:g})}},this.onTrouterStateChanged=(g,m)=>{const f=causeId2();this.logger.info(`[${f}][onTrouterStateChanged][state=${g}]`),this.disposed?this.logger.info("onTrouterStateChanged ignored"):(this.reportConnectivityStatus(),2===g&&(this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Wi.TROUTER_STATE_CHANGED,f)))},this.setupConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.addEventListener&&(window.addEventListener("online",this.navigatorOnlineCallback),window.addEventListener("offline",this.navigatorOfflineCallback))}catch(g){return}},this.tearDownConnectionCheck=()=>{try{navigator&&navigator.onLine&&window&&window.removeEventListener&&(window.removeEventListener("online",this.navigatorOnlineCallback),window.removeEventListener("offline",this.navigatorOfflineCallback))}catch(g){return}},this.getTrouterUrlAsync=()=>this.signalingAgentConfig.trouterServiceProvider?this.signalingAgentConfig.trouterServiceProvider.getTrouterUrlAsync():this.signalingAgentConfig.trouterUrlGetter.getTrouterUrlAsync(),this.brokerExclusiveEnabled=()=>this.signalingAgentConfig.brokerEnabledOutgoing&&this.signalingAgentConfig.brokerEnabledIncoming&&this.signalingAgentConfig.brokerExclusively,this.isBrokerEnabledForOutgoingCall=()=>this.signalingAgentConfig.brokerEnabledOutgoing,this.isBrokerEnabledForIncomingCall=()=>this.signalingAgentConfig.brokerEnabledIncoming,this.isHandleUnmuteMuteFromResponseEnabled=()=>this.signalingAgentConfig.handleUnmuteMuteFromResponse,this.setupBrokerChannel=()=>{this.brokerService||(this.logger.info("setupBrokerChannel, Enable broker"),this.brokerService=new cn(this),this.brokerService.onBrokerMessage((g=>{this.logger.info("setupBrokerChannel, message from broker",g),this.handleIncomingMsgAsync(g,Hi.INCOMING_MESSAGE_ORIGIN.BROKER).catch((g=>{this.telemetryHelper.recordEvent(Wi.FAILED_TO_HANDLE_BROKER_MESSAGE),this.logger.info("setupBrokerChannel, Failed to handle message from broker",g)}))})),this.baseMessagingChannelUrl||(this.telemetryHelper.addBrokerChannel(),this.baseMessagingChannelUrl=this.brokerService.baseUrl))},this.onTrouterUrlChanged=()=>{const g=causeId2();this.logger.info(`[${g}][onTrouterUrlChanged]`),this.disposed?this.logger.info("onTrouterUrlChanged ignored"):this.getTrouterUrlAsync().then((m=>{this.telemetryHelper.recordEvent(Wi.TROUTER_URL_CHANGED,{url:m}),this.telemetryHelper.addTrouterChannel(),this.updateLinksToTrouter(Wi.TROUTER_URL_CHANGED,g)})).catch((g=>{this.logger.info(`Failed to update links to trouter: ${g}`)}))},this.updateLinksToTrouter=(g,m)=>{this.logger.info(`[${m}][updateLinksToTrouter][tag=${g}]`),this.ensureLatestTrouterUrl(g).then((()=>{this.previousTrouterUrl!==this.currentTrouterUrl?(this.previousTrouterUrl=this.currentTrouterUrl,this.updateConversationLinks(),this.updateKeepAliveUrl(),this.contentSharingManager?.updateContentSharingNotificationLinksAsync(m),this.broadcastSession&&this.broadcastSession.updateBroadcastCallbackUrl(m)):this.logger.info(`[${m}][updateLinksToTrouter]skip updating links, url did not change`)})).catch((g=>{this.disposed||this.telemetryHelper.recordEvent(Wi.TROUTER_URL_UPDATE_FAILED,{causeId:m}),this.logger.info(`[${m}][updateLinksToTrouter][failed][reason=${getPrintableObject(g)}]`)}))},this.updateLinks=(g,m)=>{this.ensureLatestTrouterUrl(Wi.TROUTER_URL_CHANGED).then((()=>{g(m)})).catch((g=>{this.disposed||this.telemetryHelper.recordEvent(Wi.TROUTER_URL_UPDATE_FAILED,{causeId:m}),this.logger.warn("Failed to update links")}))},this.startCallPreheatTimer=g=>{this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT,(()=>{this.handleCallEstablishmentTimeout(g,Hi.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,"Preheat timed out!"),this.terminateEstablishedCall({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.PREHEATED_CALL_TIMEDOUT,phrase:"Preheat timed out!"},{forEveryone:!1,causeId:g})}),Hi.TIMEOUT_VALUES_IN_SECONDS.MAX_PREAHEATED_TIMEOUT)},this.stopCallPreheatTimer=()=>{this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.MAX_PREAHEATED_TIMEOUT)},this.updateKeepAliveUrl=()=>{this.logger.info("updateKeepAliveUrl"),this.links.hasOwnProperty(Hi.LINKS.KEEPALIVE)?(this.linkUpdateRequested.keepAliveLinks=!1,this.logger.info("updateKeepAliveUrl, sending request"),this.sendToKeepAliveUrl(getPayload40(this))):this.linkUpdateRequested.keepAliveLinks=!0},this.updateConversationLinks=(g=causeId2())=>{this.logger.info(`[${g}][updateConversationLinks]`),this.telemetryHelper.recordEvent(Wi.UPDATE_CONVERSATION_LINKS,{causeId:g}),this.links.hasOwnProperty(Hi.LINKS.NOTIFICATION_LINKS)?(this.linkUpdateRequested.conversationLinks=!1,this.logger.info("updateConversationLinks, sending request"),this.sendToUpdateConversationLinks(!0)):this.linkUpdateRequested.conversationLinks=!0},this.sendAttachToCallInternal=(g=causeId2())=>{this.telemetryHelper.recordEvent(Wi.SEND_ATTACH,{causeId:g}),this.logger.info(`[${g}][sendAttachToCallInternal]`);const m=new Gi;return this.signalingAgentConfig.sendProgressFromCC&&m.set(Hi.HEADERS.CACHE_SKYPE_TOKEN,"1"),this.http.sendPostRequest({url:this.incomingCallPayload.callNotification.links.attach,customHeaders:m,requestName:qi.SEND_CALL_ATTACH.name,payload:getPayload26(this,this.incomingCallPayload.conversationInvitation.conversationController,!this.getInitialMediaOfferFromIncomingCallPayload()),causeId:g}).then((m=>{if(!this.disposed){this.processAttachResponse(this.incomingCallPayload,m,g);const f=m.response.additionalActionResponses;f&&f.length>0&&this.processConversationServiceResponse(f[0].output,g,0),this.onCallStatusChanged(Hi.CALL_STATUS.RINGING,g),this.telemetryHelper.setTimeToRingDuration(),this.handleBrokerSubscription(m.response.callInvitation,g)}})).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingAgentConfig);this.logger.info(`[${g}][sendAttachToCallInternal] error: ${getPrintableObject(m)} xhrError: ${getPrintableObject(f)}`),this.disposed||(this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,endCode:f.telemetryEndSubCode,endSubCode:f.error.subCode,resultCategories:f.error.resultCategories,resultDetail:f.error.phrase||this.getTerminatingCallResultDetail("attach",f.error),causeId:g}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,g,f.error),this.dispose(f.error,g))}))},this._processCallAcceptance=(g,m)=>{if(this.logger.info(`[${m}][_processCallAcceptance]`),this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING){this.processCallAcceptance(g.body,m),this.telemetryHelper.setTimeToRingDuration();try{this.multiParty||this.callUsesMixer||this.participantManager.handleRosterUpdate(this.getFakeRoster(g.body),!0,m)}catch(f){const S={code:Hi.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Hi.CALL_END_SUB_CODE.CALL_ACCEPTANCE_INVALID_SERVICE_RESPONSE,phrase:f&&f.toString()};throw this.logger.info(`[${m}][_processCallAcceptance] ${safeJsonStringify(S)}`),this.telemetryHelper.recordRosterEvent(g,Wi.HANDLE_ROSTER_UPDATE_FAIL,m),S}}},this.restartKeepAliveInterval=(g=!1,m)=>{this.disposed||(g&&this.telemetryHelper.recordEvent(Wi.SEND_KEEP_ALIVE_FAILED,m),this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval))},this.isCallOngoing=()=>this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Hi.SIGNALING_FSM_STATE.IDLE,this.isCallIdleOrRosterOnly=()=>this.fsmState===Hi.SIGNALING_FSM_STATE.IDLE||this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,this.isCallConnectedOrConnectedForRoster=()=>this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED||this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY,C&&(this.callStartTime=C),this.signalingSessionCallback=m,this.signalingAgentConfig=f,this.signalingAgent=v,this.urlIdentifier=S,this.piiUtils=new Zi(f.piiScrubber),this.isHostLessCall=f.doHostlessCalling||!1,this.logger=f.logger.createChild((()=>`CSA[${this.correlationId}][${this.fsmState}]`),this.correlationId,!0),this.updateCorrelationId(S),this.logger.info(`[endpointId=${truncate(this.signalingAgent.endpointId)}]`),this.logger.info(`[participantId=${g.participantId}]`),this.callOperationHandler=new hn(this.logger.createChild((()=>`[CallOperationHandler][${g.participantId}]`))),this.http=new bn(this,this.callStartTime),this.telemetryHelper=new xn(this,g,this.callStartTime),this.mediaRenegotiationManager=new An(this,m,this.telemetryHelper),this.participantManager=new On(this,m,g),this.proxiedMessageNotificationManager=new Nn(this),this.timeoutManager=new Ji(this.logger),this.contentSharingManager=new pn(this,m),this.webRtcSignalingManager=new Un(this,m),this.pstnContent={emergencyCallCountry:f.emergencyCallCountry||"",platformName:f.clientInformation,publicApiCall:!1},this.setupTrouterChannel(),this.setupConnectionCheck()}onPromotionCompleted(g,m,f){this.logger.info(`[${f}][onPromotionCompleted] isFailed=${g} error=${getPrintableObject(m)}]`),this.isPromotingToRealtime=!1,this.signalingSessionCallback.onPromotionCompleted(g,m,f)}setRealTimeState(g,m){let f=g;(2===g&&1===this.realTimeState||1===g&&2===this.realTimeState)&&(f=3),f!==this.realTimeState&&(this.logger.info(`[${m}][setRealTimeState] changed: input=${g} old=${this.realTimeState}, new=${f}`),this.realTimeState=f,3===f?this.setCallMode(1,m):0!==this.callMode||2!==f&&1!==f||this.setCallMode(1,m))}setCallMode(g,m){this.callMode!==g&&(this.logger.info(`[${m}][setCallMode] oldMode=${this.callMode}, newMode=${g}`),this.callMode=g,this.signalingSessionCallback.onCallModeChanged(this.callMode,m))}configureStreamingMode(g){2!==this.callMode?(this.logger.info(`[${g}][configureStreamingMode]`),this.setCallMode(2,g),this.cleanUpDueToStreaming(g),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTED,g)):this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT)}updateDominantSpeakerHistoryMessageSubscription(g){this.webRtcSignalingManager.getIsDominantSpeakerInfoLinkEnabled()!==g&&(this.logger.info(`Signaling dominant speaker history subscription updated: ${g}`),this.webRtcSignalingManager.setIsDominantSpeakerInfoLinkEnabled(g),this.webRtcSignalingManager.areClientURLsGenerated()&&this.updateKeepAliveUrl())}cleanUpDueToStreaming(g){this.setRealTimeState(0,g),this.fsmState=Hi.SIGNALING_FSM_STATE.CONNECTED,this.isPromotingToRealtime=!1,this.provisionalMediaAnswersSeenSoFar=[],this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=new An(this,this.signalingSessionCallback,this.telemetryHelper),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const m={code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.DOWNGRADE_TO_STREAMING_CLIENT,phrase:Hi.CALL_END_PHRASE.DOWNGRADE_TO_STREAMING_CLIENT},f=qi;for(const S of Object.keys(f))0!==f[S].controller&&4!==f[S].controller&&3!==f[S].controller||this.http.cancelRequestIfPending(f[S].name,g,void 0,m)}updateEndpointMetadata(g,m=causeId2()){let f={};try{f=JSON.parse(g)}catch(g){return Promise.reject("Invalid metadata")}return this.http.sendPutRequest({url:this.links[Hi.LINKS.UPDATE_ENDPOINT_METADATA],requestName:qi.UPDATE_ENDPOINT_METADATA.name,payload:getPayload50(this,f),causeId:m}).then((()=>{this.telemetryHelper.recordEvent(Wi.UPDATE_ENDPOINT_METADATA_SUCCESS,{causeId:m})})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][updateEndpointMetadata] error: ${getPrintableObject(f)}`),this.telemetryHelper.recordEvent(Wi.UPDATE_ENDPOINT_METADATA_FAILURE,{...f.error}),Promise.reject(f.error)}))}isOneToOnePSTNCall(){return this.signalingSessionCallback.isOneToOnePstnCall()}getLocationContent(){return this.isOneToOnePSTNCall()?tryParse(this.locationInfoContent):null}getNetworkContent(){return this.isOneToOnePSTNCall()?tryParse(this.networkInfoContent):null}getAreaContent(){return this.isOneToOnePSTNCall()?tryParse(this.areaContent):null}setLocationInfo(g,m,f){this.locationInfoContent=g,this.networkInfoContent=m,this.areaContent=f}setStreamInformationReceived(){this.disposed||this.streamInformationReceived||(this.streamInformationReceived=!0,this.telemetryHelper.recordEvent(Wi.SET_STREAM_INFORMATION_RECEIVED))}getEndpointCapabilities(){let g=0;return this.signalingAgentConfig.brokerEnabledIncoming&&(g|=16),this.signalingAgentConfig.isGVCJoiningEnabled&&(g|=1),"disabled"!==this.signalingAgentConfig.cloudScreenSharingFlag&&(g|=2),this.signalingAgentConfig.supportsHostlessGroupCalls&&(g|=4),this.signalingAgentConfig.autoJoinOnConflict&&(g|=32),this.signalingAgentConfig.supportsCompressedServicePayload&&(g|=128),this.signalingAgentConfig.enableAutoPromotion&&(g|=65536),this.signalingAgentConfig.enableBatchedSendMessageStatus&&(g|=16384),this.signalingAgentConfig.enableBatchedReceiveMessage&&(g|=8192),g|=64,g|=1024,this.signalingAgent?.accountConfig?.clientSupportsAudioOnlyWatermark&&(g|=4096,this.telemetryHelper.setAudioOnlyWatermark(!0)),this.signalingAgent?.accountConfig?.clientSupportsWatermark&&(g|=2048,this.telemetryHelper.setWatermarkSupport(!0)),(this.getMaxReinvitelessMediaForVBSSForWeb()||this.getMaxReinvitelessMediaForVideoForWeb())&&(this.telemetryHelper.setReinviteless(this.callUsesMixer),g|=512),g}handleAdmitAllStatus(g){const m=g.body&&g.body.transactionResponse,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAdmitAllStatus][${getPrintableObject(m)}]`);const S=m&&m.operationId;if(S&&this.callOperationHandler.hasPendingOperation(0,S,f)){this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT,S);const g=m&&m.result&&m.result.code,v=m&&m.result&&m.result.subCode,C=m&&m.result&&m.result.resultCategories,_=m&&m.additionalDetail;if(0===g||g>=200&&g<300){const m={code:g,subCode:v,resultCategories:C,result:safeJsonStringify(_)};this.telemetryHelper.recordEvent(Wi.ADMIT_SUCCESS,{causeId:S,transactionEnd:m}),this.callOperationHandler.resolvePendingOperation(0,S,m,f)}else{const _={code:g||Hi.CALL_END_CODE.BAD_REQUEST,subCode:v||0,resultCategories:C,result:m,phrase:Hi.CALL_END_PHRASE.BAD_SERVICE_RESPONSE};this.telemetryHelper.recordEvent(Wi.ADMIT_FAILURE,{causeId:S,transactionEnd:_}),this.callOperationHandler.rejectPendingOperation(0,S,"AdmitAllStatus response contains failure",_,f)}}else this.logger.warn(`[${f}][handleAdmitAllStatus] invalid admitAllStatus response or no pending operation. operationId=${S}`)}sendNetworkRequestForAdmit(g){const onceTrouterReady=()=>{this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.ADMIT,(()=>{this.telemetryHelper.recordEvent(Wi.ADMIT_TIMEOUT,{causeId:g}),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT,g),this.callOperationHandler.rejectPendingOperation(0,g,"timed out waiting for admit operation",{code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.ADMIT_TIMEOUT,phrase:Hi.CALL_END_PHRASE.ADMIT_TIMEOUT},g)}),Hi.TIMEOUT_VALUES_IN_SECONDS.ADMIT_TIMEOUT,g)};this.http.sendPostRequest({url:this.links[Hi.LINKS.ADMIT_ALL],requestName:qi.ADMIT.name,payload:getPayload25(this,g),causeId:g,onceTrouterReady:onceTrouterReady}).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingAgentConfig);this.telemetryHelper.recordEvent(Wi.ADMIT_FAILURE,{causeId:g,...f.error}),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.ADMIT,g),this.callOperationHandler.rejectPendingOperation(0,g,m,f.error,g)}))}getConversationType(g,m,f){return g?"emergencyGroupCall":m?"cast":f?"huddleGroupCall":null}getMaxReinvitelessMediaForVideoForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVideoForWeb}getMaxReinvitelessMediaForVBSSForWeb(){return this.signalingAgentConfig.maxReinvitelessMediaForVBSSForWeb}convertParkType(g){return"teamPark"===g?"TransferTypeTeamPark":"sharedLinePark"===g?"TransferTypeSharedLinePark":"serverHold"===g?"TransferTypeServerHold":(this.logger.info(`convertParkType, parkType: ${g} is unknown`),"none")}parkByTransfer(g,m){this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallTransferTimeout(m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT);const f=this.getNetworkRequestName(g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.TRANSFER],requestName:f,payload:getPayload38(g,this),causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[${m}][parkByTransfer] error: ${getPrintableObject(f)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.signalingSessionCallback.onTransferCompleted({transferCompletion:{code:Hi.CALL_END_CODE.NETWORK_ERROR,reason:getPrintableObject(g)}},m),this.telemetryHelper.recordEvent(Wi.TRANSFER_REQUEST_FAILED,{causeId:m,...f.error}),Promise.reject(f.error))})),this.telemetryHelper.recordEvent(Wi.TRANSFER_REQUEST_SENT,{causeId:m,transferType:this.convertParkType(g)}),Promise.resolve()}park(g,m){this.logger.info(`[${m}][park] context ${g}`),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.PARK_COMPLETION,(()=>{this.handleParkError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.PARK_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.PARK_COMPLETION_TIMEOUT},Wi.WAITING_FOR_PARK_COMPLETION_TIMEOUT,m,g)}),Hi.TIMEOUT_VALUES_IN_SECONDS.PARK_COMPLETION_TIMEOUT);const f=this.getHoldTypeInRequest(g),S={causeId:m};return this.http.sendPostRequest({url:this.links[Hi.LINKS.PARK],requestName:qi.PARK_REQUEST.name,payload:getPayload39(this,f,S),causeId:m}).then((g=>{this.logger.info(`[${m}][park] response: ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_PARK_COMPLETION,{causeId:m}),assertNotNull(g.response.holdResponse.links,"server response does not include park links"),this.links[Hi.LINKS.UNPARK]=g.response.holdResponse.links.resume})).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${m}][park] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleParkError(S.error,Wi.PARK_REQUEST_FAILED,m,g),Promise.reject(S.error))})),Promise.resolve()}getHoldTypeInRequest(g){switch(g){case"serverHoldV2":return"musicOnHold";case"sharedLineParkV2":return"sharedLineAppearance";case"callPark":return"callPark";default:return null}}handleParkError(g,m,f,S){this.disposed?this.logger.info("handleParkError ignored"):(this.logger.info(`[${f}] handleParkError reject reason: ${getPrintableObject(g)}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.PARK_COMPLETION),this.signalingSessionCallback.onParkCompleted&&(this.telemetryHelper.recordEvent(m,{...g,parkContext:S,causeId:f}),this.signalingSessionCallback.onParkCompleted(g,f)),this.links[Hi.LINKS.UNPARK]=void 0)}handleParkCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.holdCompletion;this.handleOperationCompletionCommon(S,f,void 0,getPrintableObject(m),"handleParkCompletion",Hi.TIMEOUT_OPERATIONS.PARK_COMPLETION,Wi.PARK_COMPLETED,Wi.PARK_FAILED,this.signalingSessionCallback.onParkCompleted,this.handleParkError.bind(this))}handleUnparkError(g,m,f,S){this.disposed?this.logger.info("handleUnparkError ignored"):(this.logger.info(`[${f}] handleUnparkError reject reason: ${g}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.signalingSessionCallback.onUnparkCompleted&&(this.telemetryHelper.recordEvent(m,{...g,parkContext:S,causeId:f}),this.signalingSessionCallback.onUnparkCompleted(g,f)),this.links[Hi.LINKS.UNPARK]=void 0)}handleUnparkCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g);if(this.disposed)return void this.logger.info(`[${f}]handleUnparkCompletion ignored`);this.logger.info(`[${f}][handleUnparkCompletion] body ${getPrintableObject(m)}`);const S=m.resumeCompletion;S.code===Hi.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UNPARK_COMPLETION),this.telemetryHelper.recordEvent(Wi.UNPARK_COMPLETED,{...S,causeId:f}),this.signalingSessionCallback.onUnparkCompleted(S,f),this.links[Hi.LINKS.UNPARK]=void 0):this.handleUnparkError(S,Wi.UNPARK_FAILED,f)}getNetworkRequestName(g){return{none:null,teamPark:qi.SEND_PARK_REQUEST.name,sharedLinePark:qi.SEND_SHARED_LINE_PARK_REQUEST.name,serverHold:qi.SEND_SERVER_HOLD_REQUEST.name}[g]}updateMeetingsGroupsAsync(g,m){this.logger.info(`[${g}][updateMeetingsGroupsAsync] scope=${m.scope}`),this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_GROUPS,{causeId:g,options:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION,(()=>{this.handleUpdateMeetingGroupsError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT},Wi.WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION,g,g,m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_GROUPS_COMPLETION_TIMEOUT);const f=getMeetingGroupsPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.UPDATE_MEETING_GROUPS],requestName:qi.UPDATE_MEETING_GROUPS.name,payload:f,causeId:g}).then((m=>{this.logger.info(`[${g}][updateMeetingsGroupsAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_UPDATE_MEETING_GROUPS_COMPLETION,{causeId:g})})).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${g}][updateMeetingsGroupsAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingGroupsError(S.error,Wi.UPDATE_MEETING_GROUPS_REQUEST_FAILED,g,g,m),Promise.reject(S.error))}))}updateParticipantInterpretationStateAsync(g,m){return assertNotNullOrEmpty(m,"options should be a non null value"),this.logger.info(`[${g}][updateParticipantInterpretationStateAsync]`),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANT_INTERPRETATION_STATE,{causeId:g,options:m}),this.participantManager.updateParticipantInterpretationStateAsync(m,this.links[Hi.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE],g)}async sendProxiedMessageAsync(g,m){return m&&0!==m.length?this.links[Hi.LINKS.SEND_MESSAGE]?this.proxiedMessageNotificationManager.sendProxiedMessageAsync(g,m,this.links[Hi.LINKS.SEND_MESSAGE]):Promise.reject({code:Hi.VALIDATION.VALIDATION_FAILED,subCode:Hi.VALIDATION.NULL_OR_EMPTY,phrase:"missing url for CONSTANTS.LINKS.SEND_MESSAGE"}):Promise.reject({code:Hi.VALIDATION.VALIDATION_FAILED,subCode:Hi.VALIDATION.NULL_OR_EMPTY,phrase:"options should be a non empty array"})}async updateParticipantsPropertiesAsync(g,m,f,S){this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES,{causeId:S,updateParticipantsPropertiesContext:g});const v=this.links[Hi.LINKS.UPDATE_PARTICIPANTS_PROPERTIES],C=[],_=g.scope;if("self"===_){const m={id:this.participantManager.localParticipant.id,propertyBag:g.propertyBag};C.push(m)}else{if("specified"!==_)return Promise.reject("This scope is not Supported");{const m=g.participants;for(const g of m){const m={id:g.id,propertyBag:g.propertyBag};C.push(m)}}}return this.sendNetworkRequestForUpdateParticipantsProperties(C,m,v,f,S)}sendNetworkRequestForUpdateParticipantsProperties(g,m,f,S,v){const C=this.logger.createChild(`[${v}][sendNetworkRequestForUpdateParticipantsProperties]`,this.correlationId);if(f){const onceTrouterReady=()=>{const g={code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT};this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,(()=>{this.handleUpdateParticipantsPropertiesOnTimeout(m,g,Wi.UPDATE_PARTICIPANTS_PROPERTIES_TIMEOUT,S,v)}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION_TIMEOUT,S)},_=getUpdateParticipantsPropertiesPayload(this,g,S);return this.updateParticipantsPromises[S]=m,this.http.sendPostRequest({url:f,payload:_,requestName:qi.UPDATE_PARTICIPANTS_PROPERTIES.name,onceTrouterReady:onceTrouterReady,causeId:v}).then((g=>{C.info(`response: ${getPrintableObject(g)}`)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);C.info(`failed: ${getPrintableObject(m)}`);const f={...m.error};return this.disposed||(this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,S),delete this.updateParticipantsPromises[S]),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,{causeId:v,transactionEnd:f}),Promise.reject(f)}))}{const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_PARTICIPANTS_PROPERTIES_LINK_MISSING,phrase:"updateParticipantsProperties link is missing"};return C.warn(g),this.telemetryHelper.recordEvent(Wi.UPDATE_PARTICIPANTS_PROPERTIES_RESPONSE_FAILED,{causeId:v,error:g}),Promise.reject(g)}}checkAndCleanupPromisesForOperationId(g){this.updateParticipantsPromises[g]&&(0===this.updateParticipantsPromises[g].size?(delete this.updateParticipantsPromises[g],this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_PARTICIPANTS_PROPERTIES_COMPLETION,g)):this.logger.info(`remaining promises for the operation  ${g} (count: ${this.updateParticipantsPromises[g].size}): \n                ${this.piiUtils.scrubMriOrOmit(safeJsonStringify(this.updateParticipantsPromises[g]))}`))}handleUpdateParticipantsPropertiesOnTimeout(g,m,f,S,v){if(this.disposed)return void this.logger.info("handleUpdateParticipantsPropertiesOnTimeout ignored");this.logger.createChild(`[${v}][handleUpdateParticipantsPropertiesOnTimeout]`,this.correlationId).info(`reason: ${m}`),this.telemetryHelper.recordEvent(f,{...m,causeId:v});const C={};g.forEach((g=>{C[g]=m,this.updateParticipantsPromises[S].delete(g)})),this.checkAndCleanupPromisesForOperationId(S),this.signalingSessionCallback.onUpdateParticipantsPropertiesCompleted(C,S,v)}joinMeetingGroupAsync(g,m){this.logger.info(`[${g}][joinMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Wi.JOIN_MEETING_GROUP,{causeId:g,options:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION,(()=>{this.handleJoinMeetingGroupError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.JOIN_MEETING_GROUP_TIMEOUT,phrase:Hi.CALL_END_PHRASE.JOIN_MEETING_GROUP_TIMEOUT},Wi.WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION,g,g,m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.JOIN_MEETING_GROUP_COMPLETION_TIMEOUT);const f=getJoinMeetingGroupPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.JOIN_MEETING_GROUP],requestName:qi.JOIN_MEETING_GROUP.name,payload:f,causeId:g}).then((m=>{this.logger.info(`[${g}][joinMeetingGroupAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_JOIN_MEETING_GROUP_COMPLETION,{causeId:g})})).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${g}][joinMeetingGroupAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleJoinMeetingGroupError(S.error,Wi.JOIN_MEETING_GROUP_REQUEST_FAILED,g,g,m),Promise.reject(S.error))}))}leaveMeetingGroupAsync(g,m){this.logger.info(`[${g}][leaveMeetingGroupAsync]`),this.telemetryHelper.recordEvent(Wi.LEAVE_MEETING_GROUP,{causeId:g,options:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION,(()=>{this.handleLeaveMeetingGroupError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.LEAVE_MEETING_GROUP_TIMEOUT,phrase:Hi.CALL_END_PHRASE.LEAVE_MEETING_GROUP_TIMEOUT},Wi.WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION,g,g,m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.LEAVE_MEETING_GROUP_COMPLETION_TIMEOUT);const f=getLeaveMeetingGroupPayload(this,m,g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.LEAVE_MEETING_GROUP],requestName:qi.LEAVE_MEETING_GROUP.name,payload:f,causeId:g}).then((m=>{this.logger.info(`[${g}][leaveMeetingGroupAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_LEAVE_MEETING_GROUP_COMPLETION,{causeId:g})})).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${g}][leaveMeetingGroupAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleLeaveMeetingGroupError(S.error,Wi.LEAVE_MEETING_GROUP_REQUEST_FAILED,g,g,m),Promise.reject(S.error))}))}handleUpdateMeetingGroupsError(g,m,f,S,v){this.disposed?this.logger.info(`[${f}][handleUpdateMeetingGroupsError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleUpdateMeetingGroupsError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:v,causeId:f}),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(g,f,S))}handleUpdateMeetingGroupsCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.updateMeetingGroupsResponse.operationId;if(this.disposed)return void this.logger.info(`[${f}][handleUpdateMeetingGroupsCompletion] ignored. Call disposed.`);S||this.logger.warn(`[${f}][handleUpdateMeetingGroupsCompletion] operationId is undefined.`),this.logger.info(`[${f}][handleUpdateMeetingGroupsCompletion] starts`);const{updateMeetingGroupsResponse:v}=m,C=processTransactionResponse(v);C.code===Hi.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${f}][handleUpdateMeetingGroupsCompletion] update meeting group succeeded`),this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_GROUPS_RESPONSE_SUCCESS,{...C,causeId:f})):(this.logger.info(`[${f}][handleUpdateMeetingGroupsCompletion] update meeting group failed code=${C.code} subCode=${C.subCode}`),this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_GROUPS_RESPONSE_FAILURE,{...C,causeId:f})),this.logger.info(`[${f}][handleUpdateMeetingGroupsCompletion] completes`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_GROUPS_COMPLETION),this.signalingSessionCallback.onUpdateMeetingGroupsCompleted(C,f,S)}handleJoinMeetingGroupError(g,m,f,S,v){this.disposed?this.logger.info(`[${f}][handleJoinedMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleJoinedMeetingGroupError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,joinMeetingGroupOptions:v,causeId:f}),this.signalingSessionCallback.onJoinMeetingGroupCompleted(g,f,S))}handleJoinMeetingGroupCompletion(g){const m=g.body.joinMeetingGroupResponse,f=extractCauseIdFromMessage(g),S=m.operationId;if(this.disposed)return void this.logger.info(`[${f}][handleJoinMeetingGroupCompletion] ignored. Call disposed.`);S||this.logger.warn(`[${f}][handleJoinMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${f}][handleJoinMeetingGroupCompletion] starts`);const v=processTransactionResponse(m);v.code===Hi.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${f}][handleJoinMeetingGroupCompletion] join meeting group succeeded`),this.telemetryHelper.recordEvent(Wi.JOIN_MEETING_GROUP_RESPONSE_COMPLETED,{...v,causeId:f})):(this.logger.info(`[${f}][handleJoinMeetingGroupCompletion] join meeting group failed code=${v.code} subCode=${v.subCode}`),this.telemetryHelper.recordEvent(Wi.JOIN_MEETING_GROUP_RESPONSE_FAILED,{...v,causeId:f})),this.logger.info(`[${f}][handleJoinMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.JOIN_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onJoinMeetingGroupCompleted(v,f,S)}handleLeaveMeetingGroupError(g,m,f,S,v){this.disposed?this.logger.info(`[${f}][handleLeaveMeetingGroupError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleLeaveMeetingGroupError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,leaveMeetingGroupOptions:v,causeId:f}),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(g,f,S))}handleLeaveMeetingGroupCompletion(g){const m=g.body.leaveMeetingGroupResponse,f=extractCauseIdFromMessage(g),S=m.operationId;if(this.disposed)return void this.logger.info(`[${f}][handleLeaveMeetingGroupCompletion] ignored. Call disposed.`);S||this.logger.warn(`[${f}][handleLeaveMeetingGroupCompletion] operationId is undefined.`),this.logger.info(`[${f}][handleLeaveMeetingGroupCompletion] starts`);const v=processTransactionResponse(m);v.code===Hi.TRANSACTION_END_CODE.SUCCESS?(this.logger.info(`[${f}][handleLeaveMeetingGroupCompletion] leave meeting group succeeded`),this.telemetryHelper.recordEvent(Wi.LEAVE_MEETING_GROUP_RESPONSE_COMPLETED,{...v,causeId:f})):(this.logger.info(`[${f}][handleLeaveMeetingGroupCompletion] leave meeting group failed code=${v.code} subCode=${v.subCode}`),this.telemetryHelper.recordEvent(Wi.LEAVE_MEETING_GROUP_RESPONSE_FAILED,{...v,causeId:f})),this.logger.info(`[${f}][handleLeaveMeetingGroupCompletion] complete`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.LEAVE_MEETING_GROUP_COMPLETION),this.signalingSessionCallback.onLeaveMeetingGroupCompleted(v,f,S)}handleDisablePreheatError(g,m,f){this.disposed?this.logger.info(`[${f}][handleDisablePreheatError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleDisablePreheatError] reject reason: ${JSON.stringify(g)}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),this.telemetryHelper.recordEvent(m,{...g,causeId:f}),this.disablePreheatDefer.isPending()&&this.disablePreheatDefer.reject(g))}handleDisablePreheatCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.transactionEnd;if(this.disposed)this.logger.info(`[${f}][handleDisablePreheatCompletion] ignored. Call disposed.`);else if(this.disablePreheatDefer.isPending()){if(this.logger.info(`[${f}][handleDisablePreheatCompletion] starts`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.DISABLE_PREHEAT_ASYNC_TIMEOUT),S.code===Hi.TRANSACTION_END_CODE.SUCCESS)this.logger.info(`[${f}][handleDisablePreheatCompletion] update endpoint state succeeded`),this.handleEndpointStateUpdated(f,!0);else if(this.logger.info(`[${f}][handleDisablePreheatCompletion] update endpoint state failed code=${S.code} subCode=${S.subCode}`),this.disablePreheatDefer.isPending()){const g={response:S};this.disablePreheatDefer.reject(g)}}else this.logger.info(`[${f}][handleDisablePreheatCompletion] ignored. Disable preheat promise is resolved/rejected.`)}handleReceiveMessage(g){const m=extractCauseIdFromMessage(g);if(this.disposed)return void this.logger.info(`[${m}][handleReceiveMessage] ignored. Call disposed.`);let f;f=Array.isArray(g.body?.messageContent)?g.body.messageContent:[g.body];let S="";const v=[];for(let g=0;g<f.length;g++){const m=f[g];S+=m?.operationId,g<f.length-1&&(S+=","),v.push({operationId:m.operationId,messageType:m.type,payload:m.payload,from:{[m.from.id]:{participantLegIdMap:{[m.from.participantId]:{...m.from.endpointId&&{endpointId:m.from.endpointId}}},level:"endpoint"}}})}this.logger.info(`[${m}][handleReceiveMessage] complete. OperationIds:${S}`),this.telemetryHelper.recordEvent(Wi.INCOMING_PROXIED_MESSAGES,{causeId:m,operationIds:S}),this.signalingSessionCallback.onIncomingProxiedMessages(v,m)}publishStateAsync(g,m,f,S,v,C){this.logger.info(`[${f}][publishStateAsync][publishType=${g} publishLevel=${m}]`),this.telemetryHelper.recordEvent(Wi.PUBLISH_STATE,{causeId:f,publishType:g,publishLevel:m});const _=this.links[Hi.LINKS.PUBLISH_STATE];if(!_){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.PUBLISH_STATE_LINK_MISSING,phrase:"publish state link is missing"};return this.logger.warn(g),Promise.reject(g)}let E={};try{E=JSON.parse(S)}catch(g){const m={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_CONTENT,phrase:"publish state content is invalid"};return this.logger.warn(m),Promise.reject(m)}return this.http.sendPostRequest({url:_,requestName:qi.PUBLISH_STATE.name,payload:getPayload41(this,g,m,E,v,C),causeId:f,requestId:f}).then((g=>{if(g?.response?.publishStateResponse)return this.parsePublishStateResult(g,f);{const m=`Invalid CS response which does not contains publishStateResponse. Respone: ${g?.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(m),{response:{code:Hi.CALL_END_CODE.DECODING_FAILED,subCode:Hi.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:m}}}})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${f}][publishStateAsync] error: ${getPrintableObject(m)}`);const S=m.error;return this.telemetryHelper.recordEvent(Wi.PUBLISH_STATE_FAILURE,{causeId:f,transactionEnd:S}),Promise.reject(S)}))}getPublishStateSequenceNumber(){return++this.publishStateSequenceNumber}parsePublishStateResult(g,m){let f={};if(g&&g.response&&g.response.publishStateResponse){if(g.response.publishStateResponse.stateId)return g.response.publishStateResponse.stateId;if(g.response.publishStateResponse.results){if(1===g.response.publishStateResponse.results.length){if(g.response.publishStateResponse.results[0].stateId)return g.response.publishStateResponse.results[0].stateId;this.logger.warn("invalid response format")}return g.response.publishStateResponse.results.forEach((g=>{f[g.participantId]={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode}})),JSON.stringify(f)}if(g.response.publishStateResponse.result)return f={code:g.response.publishStateResponse.result.code,phrase:g.response.publishStateResponse.result.phrase,subCode:g.response.publishStateResponse.result.subCode,result:g.response.publishStateResponse.additionalDetail},JSON.stringify(f)}const S=`Invalid CS response which does not contains publishStateResponse. Respone: ${g&&g.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(S),{response:{code:Hi.CALL_END_CODE.DECODING_FAILED,subCode:Hi.CALL_END_SUB_CODE.PUBLISH_STATE_INVALID_SERVICE_RESPONSE,phrase:S}}}removeStateAsync(g,m,f,S){if(this.logger.info(`[${g}][removeStateAsync][scope=${m} publishType=${f} stateIds=${S}]`),this.telemetryHelper.recordEvent(Wi.REMOVE_STATE,{causeId:g,scope:m,publishType:f,stateIds:S}),!f&&!S){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.REMOVE_STATE_MISSING_ARGUMENTS,phrase:"remove state operation miss arguments"};return this.logger.warn(g),Promise.reject(g)}const v=this.links[Hi.LINKS.REMOVE_STATE];if(!v){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.REMOVE_STATE_LINK_MISSING,phrase:"remove state link is missing"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:v,requestName:qi.REMOVE_STATE.name,payload:getPayload43(this,m,S,f),causeId:g,requestId:g}).then((m=>this.parseRemoveStateResult(m,g))).catch((m=>{const f=getErrorForXHRFailure(m,this.signalingAgentConfig);this.logger.info(`[${g}][removeStateAsync] error: ${getPrintableObject(f)}`);const S=f.error;return this.telemetryHelper.recordEvent(Wi.REMOVE_STATE_FAILURE,{causeId:g,transactionEnd:S}),Promise.reject(S)}))}parseRemoveStateResult(g,m){let f={};return g&&g.response&&g.response.removeStateResponse&&(g.response.removeStateResponse.results?g.response.removeStateResponse.results.forEach((g=>{f[g.stateId]={code:g.result.code,phrase:g.result.phrase,subCode:g.result.subCode}})):g.response.removeStateResponse.result&&(f={code:g.response.removeStateResponse.result.code,phrase:g.response.removeStateResponse.result.phrase,subCode:g.response.removeStateResponse.result.subCode,result:g.response.removeStateResponse.additionalDetail})),JSON.stringify(f)}updateMeetingSettingsAsync(g,m){this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_SETTINGS,{causeId:m,meetingSettings:g});const f=this.links[Hi.LINKS.UPDATE_MEETING_SETTINGS];if(!f){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_LINK_MISSING,phrase:"update meeting settings link is missing"};return this.logger.warn(g),Promise.reject(g)}if(!Object.keys(g).length){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_SETTINGS_MISSING_ARGUMENTS,phrase:"update meeting settings missing arguments"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPutRequest({url:f,requestName:qi.UPDATE_MEETING_SETTINGS.name,payload:getPayload53(this,g),causeId:m,requestId:m}).then((()=>{en.noop()})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][updateMeetingSettingsAsync] error: ${getPrintableObject(f)}`);const S=f.error;throw this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_SETTINGS_FAILURE,{causeId:m,transactionEnd:S}),S}))}searchParticipantsAsync(g,m){this.logger.info(`[${m}][searchParticipantsAsync][queryOptions=${g}]`),this.telemetryHelper.recordEvent(Wi.SEARCH_PARTICIPANTS,{causeId:m,queryOptions:g});const f=this.links[Hi.LINKS.SEARCH_PARTICIPANTS];if(!f){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_LINK_MISSING,phrase:"search participants link is missing"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:f,requestName:qi.SEARCH_PARTICIPANTS.name,payload:getPayload44(this,g),causeId:m,requestId:m}).then((g=>{if(g&&g.response&&g.response.participants)return this.parseSearchParticipantsResult(g,m);{const m=`Invalid CS response which does not contain proper search results. Respone: ${g&&g.response?JSON.stringify(g.response):"no response"}`;throw this.logger.warn(m),{response:{code:Hi.CALL_END_CODE.DECODING_FAILED,subCode:Hi.CALL_END_SUB_CODE.SEARCH_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:m}}}})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][searchParticipantsAsync] error: ${getPrintableObject(f)}`);const S=f.error;return this.telemetryHelper.recordEvent(Wi.SEARCH_PARTICIPANTS_FAILURE,{causeId:m,transactionEnd:S}),Promise.reject(S)}))}parseSearchParticipantsResult(g,m){const f=[];if(g&&g.response){const m=g.response.participants;if(m)for(const S of Object.keys(m))f.push(ji.fromRosterSearchResults(g.response.participants[S]))}return{participants:f}}getAllParticipantsAsync(g,m){this.logger.info(`[${m}][getAllParticipantsAsync][scope=${g}]`),this.telemetryHelper.recordEvent(Wi.GET_ALL_PARTICIPANTS,{causeId:m,scope:g});const f=this.links[Hi.LINKS.GET_ALL_PARTICIPANTS];if(!f){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_LINK_MISSING,phrase:"get all participants link is missing"};return this.logger.warn(g),Promise.reject(g)}if("lobby"!==g){const g={code:Hi.CALL_END_CODE.REJECT,subCode:Hi.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SCOPE,phrase:"get all participants scope is invalid"};return this.logger.warn(g),Promise.reject(g)}return this.http.sendPostRequest({url:f,requestName:qi.GET_ALL_PARTICIPANTS.name,payload:getPayload34(this,g),causeId:m,requestId:m}).then((g=>{if(g&&g.response){return{participants:g.response.participants}}{const g="Invalid CS response which does not contain results.";throw this.logger.warn(g),{response:{code:Hi.CALL_END_CODE.DECODING_FAILED,subCode:Hi.CALL_END_SUB_CODE.GET_ALL_PARTICIPANTS_INVALID_SERVICE_RESPONSE,phrase:g}}}})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][getAllParticipantsAsync] error: ${getPrintableObject(f)}`);const S=f.error;return this.telemetryHelper.recordEvent(Wi.GET_ALL_PARTICIPANTS_FAILURE,{causeId:m,transactionEnd:S}),Promise.reject(S)}))}resetState(){this.currentCallStatus=null,this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE}saveUpdatedCallLinksIfAny(g){g.links&&(this.logger.info(`saveUpdatedCallLinksIfAny, updated call links found, update to new links ${getPrintableObject(g)}`),this.links[Hi.LINKS.MEDIA_RENEGOTIATION]=g.links.mediaRenegotiation||this.links[Hi.LINKS.MEDIA_RENEGOTIATION],this.links[Hi.LINKS.TRANSFER]=g.links.transfer||this.links[Hi.LINKS.TRANSFER],this.links[Hi.LINKS.REPLACE]=g.links.replacement||this.links[Hi.LINKS.REPLACE],this.links[Hi.LINKS.HANGUP]=g.links.callLeg||this.links[Hi.LINKS.HANGUP],this.links[Hi.LINKS.KEEPALIVE]=g.links.callLeg||this.links[Hi.LINKS.KEEPALIVE],this.links[Hi.LINKS.PARK]=g.links.hold||this.links[Hi.LINKS.PARK],this.links[Hi.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.links.updateMediaDescriptions||this.links[Hi.LINKS.UPDATE_MEDIA_DESCRIPTIONS])}ensureMessageChannelReady(g){return this.disposed?(this.logger.info("ensureMessageChannelReady: error: call already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):this.brokerService?(this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.STARTED}:${g}`),this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),Promise.resolve()):this.ensureLatestTrouterUrl(g)}ensureLatestTrouterUrl(g){return this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.STARTED}:${g}`),this.getTrouterUrlAsync().then((m=>!m||"string"==typeof m&&!m.trim()?(this.telemetryHelper.recordEvent(Wi.TROUTER_URL_CHANGED_TO_INVALID),this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),Promise.reject(new Error("Invalid trouter url"))):this.disposed?(this.logger.info("ensureLatestTrouterUrl, trouterUrlGetter returned too late. Object is already disposed"),Promise.reject(this.getCallNotFoundTransactionEnd())):(this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.ENDED}:${g}`),this.baseMessagingChannelUrl=this.currentTrouterUrl=m,Promise.resolve()))).catch((m=>(this.disposed||this.telemetryHelper.addTrouterWaitOperation(`${zi.TROUTER_WAIT_OPERATION.FAILED}:${g}`),this.logger.info(`ensureLatestTrouterUrl, failed because:${m}`),Promise.reject(m))))}signalTransferAcceptedAsync(g,m=causeId2()){return this.logger.info(`[signalTransferAcceptedAsync][${m}] transferType ${g}`),this.disposed?(this.logger.info(`[signalTransferAcceptedAsync][${m}] Call already ended, skip acceptance request`),Promise.reject({code:Hi.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(this.telemetryHelper.recordEvent(Wi.SEND_ACCEPT_TRANSFER,{causeId:m,transferType:g}),this.http.sendPostRequest({url:this.links[Hi.LINKS.TRANSFER_ACCEPTANCE],requestName:qi.TRANSFER_ACCEPTANCE.name,payload:getPayload46(),causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[signalTransferAcceptedAsync][${m}] error: ${getPrintableObject(f)}`),this.telemetryHelper.recordEvent(Wi.SEND_ACCEPT_TRANSFER_FAIL,{causeId:m}),Promise.reject(f.error)})))}signalTransferCompletedAsync(g,m=causeId2()){return this.logger.info(`[signalTransferCompletedAsync][${m}] rejectReason ${g}`),this.disposed?(this.logger.info(`[signalTransferCompletedAsync][${m}]  Call already ended by transferor, skip completion request`),Promise.reject({code:Hi.CALL_END_CODE.CALL_DOES_NOT_EXIST,reason:null})):(0!==g.code?this.telemetryHelper.recordEvent(Wi.TRANSFER_COMPLETION_FAILED,{code:g.code,subcode:g.subCode,causeId:m}):this.telemetryHelper.recordEvent(Wi.TRANSFER_COMPLETED,{causeId:m}),this.telemetryHelper.recordEvent(Wi.SEND_COMPLETE_TRANSFER,{causeId:m}),this.http.sendPostRequest({url:this.links[Hi.LINKS.TRANSFER_COMPLETION],requestName:qi.TRANSFER_COMPLETION.name,payload:getPayload48(g),causeId:m}).catch((g=>{this.telemetryHelper.recordEvent(Wi.SEND_COMPLETE_TRANSFER_FAILED,{causeId:m});const f=getErrorForXHRFailure(g,this.signalingAgentConfig);return this.logger.info(`[signalTransferCompletedAsync][${m}] error: ${getPrintableObject(f)}`),Promise.reject(f.error)})))}endWithBeacon(g){if(navigator&&navigator.sendBeacon&&!this.disposed){const m={code:Hi.CALL_END_CODE.SUCCESS,subCode:Hi.CALL_END_SUB_CODE.BEACON,phrase:Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED};this.telemetryHelper.recordEvent(Wi.END_WITH_BEACON,{causeId:g});const f=JSON.stringify(getPayload36(this,m).payload),S=-1===this.links[Hi.LINKS.LEAVE].indexOf("?")?"?":"&",v=`skypeToken=${this.signalingAgent.authTokenManager.getLastToken(g)}`;return navigator.sendBeacon(`${this.links[Hi.LINKS.LEAVE]}${S}${v}`,f)}return!1}setFsmState(g){this.fsmState=g}setIsHostless(g,m){const f=!!g;this.isHostLessCall!==f&&(this.logger.info(`[${m}][setIsHostless] isHostless=${f}`),this.isHostLessCall=f)}hasGroupModality(){return this.threadId||this.groupId}processConversationServiceResponseHeaders(g,m){this.logger.info(`[${m}][processConversationServiceResponseHeaders]`);try{const f=g.request.getResponseHeader(Hi.HEADERS.CORRELATION_ID)||g.request.getResponseHeader(Hi.HEADERS.CORRELATION_ID.toLowerCase());this.updateCorrelationId(f,m)}catch(g){this.logger.info(`[${m}][processConversationServiceResponseHeaders] failed, reason=${getPrintableObject(g)}`)}}processConversationServiceResponse(g,m,f){const S=this.logger.createChild(`[${m}][processConversationServiceResponse]`);if(S.info(`responseType :${f}`),this.processConversationServiceUpdate(g,m),g.subscriptionDetails&&g.subscriptionDetails.selfParticipant){const f=ji.fromRoster(g.subscriptionDetails.selfParticipant,!0);S.info("converted selfParticipant to Participant type"),this.participantManager.updateLocalParticipantFromSubscribe(f,m)}this.handleBrokerSubscription(g,m),g.roster&&this.internalHandleRosterUpdate(g.roster,!0,m),0===f&&(this.startOrJoinConvResponseReceived=!0,this.handlePendingEndpointState(m))}processConversationServiceUpdate(g,m){const f=this.logger.createChild(`[${m}][processConversationServiceUpdate]`);f.info(),this.convJoined=!0;const S=g.sequenceNumber>=0?g.sequenceNumber:-1;S<this.updateSequenceNumber?f.info(`seqNum=${S} is less than latest seqNum=${this.updateSequenceNumber}`):(this.updateSequenceNumber=S,this.links[Hi.LINKS.CONVERSATION_CONTROLLER]=g.conversationController,this.links[Hi.LINKS.ADD_PARTICIPANT]=g.links.addParticipant,this.links[Hi.LINKS.ADD_PARTICIPANTS_AND_MODALITY]=g.links.addParticipantAndModality,this.links[Hi.LINKS.LEAVE]=g.links.leave,this.links[Hi.LINKS.NOTIFICATION_LINKS]=g.links.notificationLinks,this.links[Hi.LINKS.REMOVE_PARTICIPANT]=g.links.removeParticipant,this.links[Hi.LINKS.ADD_MODALITY]=g.links.addModality,this.links[Hi.LINKS.REMOVE_MODALITY]=g.links.removeModality,this.links[Hi.LINKS.MUTE]=g.links.mute||null,this.links[Hi.LINKS.UNMUTE]=g.links.unmute||null,this.links[Hi.LINKS.ADMIT]=g.links.admit||null,this.links[Hi.LINKS.ADMIT_ALL]=g.links.admitAll||null,this.links[Hi.LINKS.UPDATE_ENDPOINT_STATE]=g.links.updateEndpointState||null,this.links[Hi.LINKS.UPDATE_ENDPOINT_METADATA]=g.links.updateEndpointMetadata||null,this.links[Hi.LINKS.UPDATE_PARTICIPANT_ROLE]=g.links.updateParticipantRole||null,this.links[Hi.LINKS.PUBLISH_STATE]=g.links.publishState||null,this.links[Hi.LINKS.REMOVE_STATE]=g.links.removeState||null,this.links[Hi.LINKS.UPDATE_MEETING_SETTINGS]=g.links.updateMeetingSettings||null,this.links[Hi.LINKS.SEARCH_PARTICIPANTS]=g.links.searchParticipants||null,this.links[Hi.LINKS.GET_ALL_PARTICIPANTS]=g.links.getAllParticipants||null,this.links[Hi.LINKS.UPDATE_MEETING_LIVE_STATE]=g.links.updateMeetingLiveState||null,this.links[Hi.LINKS.UPDATE_MEETING_GROUPS]=g.links.updateMeetingGroups||null,this.links[Hi.LINKS.SET_MEETING_LAYOUT]=g.links.setMeetingLayout||null,this.links[Hi.LINKS.UPDATE_PARTICIPANT_INTERPRETATION_STATE]=g.links.updateParticipantInterpretationState||null,this.links[Hi.LINKS.UPDATE_PARTICIPANTS_PROPERTIES]=g.links.updateParticipantProperties||null,this.links[Hi.LINKS.JOIN_MEETING_GROUP]=g.links.joinMeetingGroup||null,this.links[Hi.LINKS.LEAVE_MEETING_GROUP]=g.links.leaveMeetingGroup||null,this.links[Hi.LINKS.SEND_MESSAGE]=g.links.sendMessage||null,this.links[Hi.LINKS.UPDATE_MEETING_STATES]=g.links.updateMeetingStates||null,this.convSubject=g.subject,g.state&&(this.setMultiParty(g.state.isMultiParty,m),this.setIsHostless(g.state.isHostless||!1,m),this.conversationType=g.state.conversationType,this.isCastCall="cast"===g.state.conversationType,this.isHuddleGroupCall="huddleGroupCall"===g.state.conversationType),g.activeModalities&&g.activeModalities.groupChat&&this.updateGroupChatIds(g.activeModalities.groupChat,m),g.activeModalities&&g.activeModalities.broadcast&&(this.broadcastSession||(this.broadcastSession=new tn(this,this.signalingSessionCallback)),this.broadcastSession.handleBroadcastDetailsChanged(g,m)),this.handleMeetingDetailsChanged(g,m),this.handleMeetingStatesChanged(g,m),this.linkUpdateRequested.conversationLinks?(f.info("Updating CS links as requested"),this.updateLinks(this.updateConversationLinks,m)):this.scheduleConversationKeepAlive(),g.meetingData&&(this.meetingData=g.meetingData),g.meetingInfo&&(this.meetingInfo=g.meetingInfo),g.region&&(this.region=g.region),g.callLimits&&(this.callLimits=g.callLimits),g.complianceRecordingContent&&(this.complianceRecordingContent=g.complianceRecordingContent),this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,complianceRecordingContent:this.complianceRecordingContent,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},m))}processLocalParticipantUpdateResponse(g,m){this.logger.info(`[${m}][processLocalParticipantUpdateResponse]`),g.sequenceNumber&&g.sequenceNumber<this.localParticipantUpdateSequenceNumber||(this.breakoutDetails=g.breakoutDetails||{},this.signalingSessionCallback.onBreakoutDetailsUpdated(this.breakoutDetails,m),!0===g.nudgeToJoinAsRealtime&&(this.telemetryHelper.recordEvent(Wi.NUDGE_TO_JOIN_REALTIME,{causeId:m}),this.signalingSessionCallback.onNudgeToJoinRealtime(m)))}handlePendingEndpointState(g){this.requestedEndpointStateWhileConnecting&&(this.logger.info(`[${g}][handlePendingEndpointState]sending pending endpoint state now that we are connected.`),this.updateEndpointState(this.requestedEndpointStateWhileConnecting,g,this.requestedPublishedStatesWhileConnecting).catch((g=>{this.isPreheatOnly&&this.disablePreheatDefer.isPending()&&(this.logger.info("handlePendingEndpointState failed"),this.disablePreheatDefer.reject(g))})))}handleMeetingDetailsChanged(g,m){this.logger.info(`[${m}][handleMeetingDetailsChanged]`),g.meetingDetails&&!en.isEqual(g.meetingDetails,this.meetingDetails)&&this.signalingSessionCallback.onMeetingDetailsUpdated&&(this.meetingDetails=g.meetingDetails,this.meetingDetails.meetingCapability&&this.meetingDetails.meetingCapability.meetingLiveState&&(this.meetingLiveStateSequenceNumber=this.meetingDetails.meetingCapability.meetingLiveState.seqNum,this.logger.info(`[${m}][handleMeetingDetailsChanged] update meeting seqNum as ${this.meetingLiveStateSequenceNumber}`)),this.signalingSessionCallback.onMeetingDetailsUpdated(this.meetingDetails,m))}handleMeetingStatesChanged(g,m){this.logger.info(`[${m}][handleMeetingStatesChanged]`),this.signalingSessionCallback.onMeetingStatesUpdated&&this.signalingSessionCallback.onMeetingStatesUpdated(g.meetingStates,m)}handleBrokerSubscription(g,m){this.logger.info(`[${m}][handleBrokerSubscription]`),g.links.subscribe?(this.telemetryHelper.recordEvent(Wi.SUBSCRIBE_URL_FOUND,m),this.brokerService&&!en.isEqual(g.links.subscribe,this.brokerService.currentSubscriptionUrl)?this.brokerService.subscribeToBroker(g.links.subscribe):(this.logger.info(`[${m}][handleBrokerSubscription] broker subscribe ignored. Broker is disabled or subscribe url is same.`),this.telemetryHelper.recordEvent(Wi.BROKER_DISABLED_SUBSCRIBE_URL_PRESENT,m))):this.telemetryHelper.recordEvent(Wi.SUBSCRIBE_URL_MISSING,m)}cancelOutgoingCall(g,m){const f=defer2();this.logger.info(`[${m}][cancelOutgoingCall][rejectionData=${g&&getPrintableObject(g)}]`);const S={code:isNaN(g?.code)?Hi.CALL_END_CODE.CANCEL:g.code,subCode:g?.subCode||Hi.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};if(S.resultCategories=S.resultCategories||[ki.Success],this.links.hasOwnProperty(Hi.LINKS.LEAVE)){this.logger.info(`[${m}][cancelOutgoingCall] cancelling outgoing call`),this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE;const g={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()},v={terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultDetail:S.phrase||"CancelOutgoingCall",endCode:S.code,endSubCode:S.subCode,causeId:m,clientReasonSubCode:S.clientReasonSubCode,clientReasonPhrase:S.clientReasonPhrase,resultCategories:S.resultCategories};this.http.sendPostRequest({url:this.links[Hi.LINKS.LEAVE],requestName:qi.CANCEL_CALL.name,payload:getPayload31(this,S,g),causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.setTerminatingData(v),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m)),f.resolve(null)})).catch((g=>{const C=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[cancelOutgoingCall][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(C)}`),this.disposed||(this.telemetryHelper.setTerminatingData(v),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m)),f.resolve(null)}))}else this.logger.info(`[${m}][cancelOutgoingCall] Conversation Service Leave Url is not yet set. Cannot leave conversation. Disposing anyways.`),S.subCode=Hi.CALL_END_SUB_CODE.CONV_URL_NOT_SET,this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultDetail:S.phrase||"CancelOutgoingCall",endCode:S.code,endSubCode:S.subCode,causeId:m,clientReasonSubCode:S.clientReasonSubCode,clientReasonPhrase:S.clientReasonPhrase,resultCategories:S.resultCategories}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m),f.resolve(null);return f.promise}terminateEstablishedCall(g,m){const f=m.causeId||causeId2();this.logger.info(`[${f}][terminateEstablishedCall]`);const S=defer2();this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE;const v=this.convJoined?qi.LEAVE_CONVERSATION.name:qi.END_CALL.name,C=build3(),_={code:g?.code||Hi.CALL_END_CODE.SUCCESS,subCode:g?.subCode||Hi.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};_.resultCategories=_.resultCategories||[ki.Success];const E={terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,endCode:_.code,endSubCode:_.subCode,resultDetail:_.phrase||"TerminateEstablishedCall",causeId:f,clientReasonSubCode:_.clientReasonSubCode,clientReasonPhrase:_.clientReasonPhrase,resultCategories:_.resultCategories};return this.leaveConversation(_,m).then((()=>{this.logger.info(`[${f}][terminateEstablishedCall]success`),this.disposed||(this.telemetryHelper.setTerminatingData(E),this.telemetryHelper.addNetworkOperationCompleted(v,!0,C.duration()),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,f,_),this.dispose(_,f)),S.resolve(null)})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${f}][terminateEstablishedCall][failed] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(m)}]`),this.disposed||(this.telemetryHelper.setTerminatingData(E),this.telemetryHelper.addNetworkOperationCompleted(v,!1,C.duration()),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,f,_),this.dispose(_,f)),S.resolve(null)})),S.promise}deleteConversation(g,m){this.logger.info(`[${m}][deleteConversation]`);const f=defer2();this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE;const S=qi.DELETE_CONVERSATION.name,v=build3(),C={code:g?.code||Hi.CALL_END_CODE.SUCCESS,subCode:g?.subCode||Hi.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Hi.CALL_END_PHRASE.CONV_END_FOR_ALL_INITIATED,resultCategories:g?.resultCategories||[ki.Success],clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase},_={terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,endCode:C.code,endSubCode:C.subCode,resultDetail:C.phrase,causeId:m,clientReasonSubCode:C.clientReasonSubCode,clientReasonPhrase:C.clientReasonPhrase,resultCategories:C.resultCategories};return this.deleteConversationController(C,m).then((()=>{this.logger.info(`[${m}][deleteConversation]success`),this.disposed||(this.telemetryHelper.setTerminatingData(_),this.telemetryHelper.addNetworkOperationCompleted(S,!0,v.duration()),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,C),this.dispose(C,m)),f.resolve(null)})).catch((g=>{const E=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][deleteConversation][failed] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(E)}`),this.disposed||(this.telemetryHelper.setTerminatingData(_),this.telemetryHelper.addNetworkOperationCompleted(S,!1,v.duration()),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,C),this.dispose(C,m)),f.resolve(null)})),f.promise}leaveConversation(g,m){const f=m.causeId||causeId2();if(this.convJoined){this.logger.info(`[${f}][leaveConversation]`);const S={cancelationDuration:this.telemetryHelper.getCallCancelationDuration()};return this.http.sendPostRequest({url:this.links[Hi.LINKS.LEAVE],requestName:qi.LEAVE_CONVERSATION.name,payload:getPayload36(this,g,S,m.scope),withoutTrouter:!0,causeId:f})}return this.logger.info(`[${f}][leaveConversation] ignore, not joined to conversation`),Promise.resolve(void 0)}deleteConversationController(g,m){return this.convJoined?(this.logger.info(`[${m}][deleteConversationController]`),this.http.sendDeleteRequest({url:this.links[Hi.LINKS.CONVERSATION_CONTROLLER],requestName:qi.DELETE_CONVERSATION.name,payload:getPayload33(this,g),withoutTrouter:!0,causeId:m})):(this.logger.info(`[${m}][deleteConversationController]ignored, not joined to conversation`),Promise.resolve(void 0))}rejectIncomingCall(g,m){this.telemetryHelper.recordEvent(Wi.REJECT_INCOMING_CALL,m),this.logger.info(`[${m}][rejectIncomingCall]`);const f=defer2();this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE;const S={code:isNaN(g?.code)?Hi.CALL_END_CODE.REJECT:g.code,subCode:g?.subCode||Hi.CALL_END_SUB_CODE.SUCCESS,phrase:g?.phrase||Hi.CALL_END_PHRASE.LOCAL_USER_INITIATED,resultCategories:g?.resultCategories,clientReasonSubCode:g?.clientReasonSubCode,clientReasonPhrase:g?.clientReasonPhrase};S.resultCategories=S.resultCategories||[ki.Success];const v={terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,endCode:S.code,endSubCode:S.subCode,resultDetail:S.phrase||"RejectCall",causeId:m,clientReasonSubCode:S.clientReasonSubCode,clientReasonPhrase:S.clientReasonPhrase,resultCategories:S.resultCategories};return this.http.sendDeleteRequest({url:this.links[Hi.LINKS.REJECT],requestName:qi.REJECT_CALL.name,payload:getPayload42(this,S),causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.setTerminatingData(v),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m)),f.resolve(null)})).catch((g=>{const C=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[rejectIncomingCall][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(C)}`),this.disposed||(this.telemetryHelper.setTerminatingData(v),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,m,S),this.dispose(S,m)),f.resolve(null)})),f.promise}onCallStatusChanged(g,m,f){const S=`[${m}][onCallStatusChanged]`;if(this.logger.info(`${S}${this.currentCallStatus}=>${g}]`),this.disposed)this.logger.info(`${S}Call is already disposed!!`);else if(f&&this.logger.info(`${S}[statusCode=${getPrintableObject(f)}]`),this.isPromotingToRealtime)g===Hi.CALL_STATUS.CONNECTED&&this.onPromotionCompleted(!1,void 0,m);else if(this.isValidStateTransitions(g)){this.currentCallStatus=g;const S={callStatus:g,statusCode:f,causeId:m};this.isPreheatOnly&&(S.isPreheatOnly=!0),this.telemetryHelper.recordEvent(Wi.UPDATE_CALL_STATUS,S),this.signalingSessionCallback.onCallStatusChanged(g,f,m),this.currentCallStatus===Hi.CALL_STATUS.CONNECTED&&(this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.telemetryHelper.resetCallCancelationDurationWatch(),this.isPreheatOnly&&this.startCallPreheatTimer(m))}}updateMeetingLiveStateAsync(g,m){this.logger.info(`[${g}][updateMeetingLiveStateAsync][options=${JSON.stringify(m)}]`),this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_LIVE_STATE,{causeId:g,meetingLiveStateOptions:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,(()=>{this.handleUpdateMeetingLiveStateError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT},Wi.WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION,g,g,m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_LIVE_STATE_COMPLETION_TIMEOUT);const f=getPayload52(this,{...m,seqNum:this.meetingLiveStateSequenceNumber},g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.UPDATE_MEETING_LIVE_STATE],requestName:qi.UPDATE_MEETING_LIVE_STATE.name,payload:f,causeId:g}).then((m=>{this.logger.info(`[${g}][updateMeetingLiveStateAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_UPDATE_MEETING_LIVE_STATE_COMPLETION,{causeId:g})})).catch((f=>{const S=getErrorForXHRFailure(f,this.signalingAgentConfig);return this.logger.info(`[${g}][updateMeetingLiveStateAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleUpdateMeetingLiveStateError(S.error,Wi.UPDATE_MEETING_LIVE_STATE_REQUEST_FAILED,g,g,m),Promise.reject(S.error))}))}updateMeetingStatesAsync(g,m){const f=this.logger.createChild(`[${g}][updateMeetingStatesAsync]`,this.correlationId);if(f.info(`meetingStatesOptions: ${JSON.stringify(m)}`),!m)return Promise.reject({code:Hi.VALIDATION.VALIDATION_FAILED,subCode:Hi.VALIDATION.NULL_OR_EMPTY,phrase:"meetingStatesOptions should be a non empty object"});this.telemetryHelper.recordEvent(Wi.UPDATE_MEETING_STATES,{causeId:g,meetingStatesOptions:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,(()=>{for(const f in m.meetingStates)this.handleUpdateMeetingStatesError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT},Wi.WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION,g,m.operationId+"_"+f)}),Hi.TIMEOUT_VALUES_IN_SECONDS.UPDATE_MEETING_STATES_COMPLETION_TIMEOUT);const S=getPayload57(this,{...m.meetingStates},g);return this.http.sendPostRequest({url:this.links[Hi.LINKS.UPDATE_MEETING_STATES],requestName:qi.UPDATE_MEETING_STATES.name,payload:S,causeId:g}).then((m=>{f.info(`response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_UPDATE_MEETING_STATES_COMPLETION,{causeId:g})})).catch((S=>{const v=getErrorForXHRFailure(S,this.signalingAgentConfig);if(f.error(`error: ${getPrintableObject(v)}`),!this.disposed){for(const f in m.meetingStates)this.handleUpdateMeetingStatesError(v.error,Wi.UPDATE_MEETING_STATES_RESPONSE_FAILURE,g,m.operationId+"_"+f);return Promise.reject(v.error)}return Promise.reject(this.getCallNotFoundTransactionEnd())}))}handleUpdateMeetingLiveStateError(g,m,f,S,v){this.disposed?this.logger.info(`[${f}][handleUpdateMeetingLiveStateError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleUpdateMeetingLiveStateError] reject reason: ${g}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:v,causeId:f}),this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted&&this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted(g,f,S))}handleUpdateMeetingLiveStateCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.updateMeetingLiveStateResponse.result,v=m.updateMeetingLiveStateResponse.operationId;v||this.logger.warn(`[${f}][handleUpdateMeetingLiveStateCompletion] operationId is undefined.`),this.logger.info(`[${f}][handleUpdateMeetingLiveStateCompletion] meetingLiveUpdate completes with operationId=${v}`),this.handleOperationCompletionCommon(S,f,v,getPrintableObject(m),"handleUpdateMeetingLiveStateCompletion",Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_LIVE_STATE_COMPLETION,Wi.UPDATE_MEETING_LIVE_STATE_RESPONSE_SUCCESS,Wi.UPDATE_MEETING_LIVE_STATE_RESPONSE_FAILURE,this.signalingSessionCallback.onUpdateMeetingLiveStateCompleted,this.handleUpdateMeetingLiveStateError.bind(this))}handleUpdateMeetingStatesError(g,m,f,S){this.disposed?this.logger.info(`[${f}][handleUpdateMeetingStatesError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleUpdateMeetingStatesError] reject reason: ${g}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,causeId:f}),this.signalingSessionCallback.onUpdateMeetingStatesCompleted&&this.signalingSessionCallback.onUpdateMeetingStatesCompleted(g,f,S))}handleUpdateMeetingStatesCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.updateMeetingStatesResponse,v=m.operationId,C=this.logger.createChild(`[${f}][handleUpdateMeetingStatesCompletion]`,this.correlationId);v||C.warn("operationId is undefined.");for(const g of S)C.info(`UpdateMeetingStates completes with operationId=${v}.`),this.handleOperationCompletionCommon(g.transactionEnd,f,v+"_"+g.meetingStateName,getPrintableObject(m),"handleUpdateMeetingStatesCompletion",Hi.TIMEOUT_OPERATIONS.UPDATE_MEETING_STATES_COMPLETION,Wi.UPDATE_MEETING_STATES_RESPONSE_SUCCESS,Wi.UPDATE_MEETING_STATES_RESPONSE_FAILURE,this.signalingSessionCallback.onUpdateMeetingStatesCompleted,this.handleUpdateMeetingStatesError.bind(this))}setMeetingLayoutAsync(g,m){this.logger.info(`[${g}][setMeetingLayoutAsync][options=${JSON.stringify(m)}]`),this.telemetryHelper.recordEvent(Wi.SET_MEETING_LAYOUT,{causeId:g,setMeetingLayoutOptions:m}),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,(()=>{this.handleSetMeetingLayoutError({code:Hi.CALL_END_CODE.TIMEOUT,subCode:Hi.CALL_END_SUB_CODE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT,phrase:Hi.CALL_END_PHRASE.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT},Wi.WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION,g,g,m)}),Hi.TIMEOUT_VALUES_IN_SECONDS.SET_MEETING_LAYOUT_COMPLETION_TIMEOUT);const f=getPayload45(this,{...m,sequenceNumber:this.meetingLayoutSequenceNumber});return this.http.sendPostRequest({url:this.links[Hi.LINKS.SET_MEETING_LAYOUT],requestName:qi.SET_MEETING_LAYOUT.name,payload:f,causeId:g}).then((m=>{this.logger.info(`[${g}][setMeetingLayoutAsync] response: ${getPrintableObject(m)}`),this.telemetryHelper.recordEvent(Wi.WAITING_FOR_SET_MEETING_LAYOUT_COMPLETION,{causeId:g})})).catch((f=>{const S=getErrorForXHRFailure(f);return this.logger.info(`[${g}][setMeetingLayoutAsync] error: ${getPrintableObject(S)}`),this.disposed?Promise.reject(this.getCallNotFoundTransactionEnd()):(this.handleSetMeetingLayoutError(S.error,Wi.SET_MEETING_LAYOUT_REQUEST_FAILED,g,g,m),Promise.reject(S.error))}))}handleSetMeetingLayoutError(g,m,f,S,v){this.disposed?this.logger.info(`[${f}][handleSetMeetingLayoutError] ignored. Call disposed, err: ${JSON.stringify(g)}`):(this.logger.info(`[${f}][handleSetMeetingLayoutError] reject reason: ${g}`),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION),this.telemetryHelper.recordEvent(m,{...g,updateMeetingGroupsOptions:v,causeId:f}),this.signalingSessionCallback.onSetMeetingLayoutCompleted&&this.signalingSessionCallback.onSetMeetingLayoutCompleted(g,f,S))}handleSetMeetingLayoutCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g),S=m.setMeetingLayoutResponse.result,v=m.setMeetingLayoutResponse.operationId;v||this.logger.warn(`[${f}][handleSetMeetingLayoutCompletion] operationId is undefined.`),this.handleOperationCompletionCommon(S,f,v,getPrintableObject(m),"handleSetMeetingLayoutCompletion",Hi.TIMEOUT_OPERATIONS.SET_MEETING_LAYOUT_COMPLETION,Wi.SET_MEETING_LAYOUT_RESPONSE_SUCCESS,Wi.SET_MEETING_LAYOUT_RESPONSE_FAILURE,this.signalingSessionCallback.onSetMeetingLayoutCompleted,this.handleSetMeetingLayoutError.bind(this))}handleOperationCompletionCommon(g,m,f,S,v,C,_,E,T,I){this.disposed?this.logger.info(`[${m}][${v}] ignored. Call disposed.`):(this.logger.info(`[${m}][${v}] body ${S}`),g.code===Hi.TRANSACTION_END_CODE.SUCCESS?(this.timeoutManager.stopTimer(C),this.telemetryHelper.recordEvent(_,{...g,causeId:m}),T&&T(g,m,f)):I&&I(g,E,m,f))}isValidStateTransitions(g){if(this.currentCallStatus===Hi.CALL_STATUS.LOCAL_TERMINATED&&g===Hi.CALL_STATUS.CONNECTING)return!0;const orderOfCallState=g=>{switch(g){case Hi.CALL_STATUS.IDLE:case Hi.CALL_STATUS.CONNECTED_FOR_ROSTER_ONLY:return 0;case Hi.CALL_STATUS.CONNECTING:return 1;case Hi.CALL_STATUS.RINGING:return 2;case Hi.CALL_STATUS.CONNECTED:return 3;case Hi.CALL_STATUS.LOCAL_TERMINATED:case Hi.CALL_STATUS.REMOTE_TERMINATED:return 4;default:return-1}};return orderOfCallState(g)>orderOfCallState(this.currentCallStatus)}handlePSTNBalanceUpdate(g){const m=g.body.balanceUpdate,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handlePSTNBalanceUpdate]`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_PSTN_BALANCE_UPDATE,g),m.updateBalance?this.signalingSessionCallback.onPSTNBalanceUpdate(m):this.logger.info(Wi.HANDLE_PSTN_BALANCE_UPDATE,"this was a pstn keepAlive message - ignore")}handleCallAcceptanceAck(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleCallAcceptanceAck]`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CALL_ACCEPTANCE_ACK,g),this.internalHandleCallAcceptanceAck(m,f)}internalHandleCallAcceptanceAck(g,m){this.logger.info(`[${m}][internalHandleCallAcceptanceAck] ${getPrintableObject(g)}`),this.fsmState!==Hi.SIGNALING_FSM_STATE.CONNECTED&&(this.links[Hi.LINKS.MEDIA_RENEGOTIATION]=g.callAcceptanceAcknowledgement.links.mediaRenegotiation,this.links[Hi.LINKS.TRANSFER]=g.callAcceptanceAcknowledgement.links.transfer,this.links[Hi.LINKS.REPLACE]=g.callAcceptanceAcknowledgement.links.replacement,this.links[Hi.LINKS.HANGUP]=g.callAcceptanceAcknowledgement.links.callLeg,this.links[Hi.LINKS.KEEPALIVE]=g.callAcceptanceAcknowledgement.links.callLeg,this.links[Hi.LINKS.PARK]=g.callAcceptanceAcknowledgement.links.hold,this.links[Hi.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.callAcceptanceAcknowledgement.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(g.callAcceptanceAcknowledgement),this.scheduleKeepAlives(g.callAcceptanceAcknowledgement.callKeepAliveInterval),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(g.callAcceptanceAcknowledgement.callProperties?.isSharedLineAppearanceV2Activated),this.fsmState=Hi.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.INCOMING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(m),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTED,m),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${m}][internalHandleCallAcceptanceAck] updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,m)))}isFatalException(g){let m=!0;try{JSON.parse(g.message).code===Hi.CALL_END_CODE.CONFLICT&&(m=!1,this.logger.info("isFatalException: received non-fatal 409 error"))}catch(g){this.logger.error("isFatalException: failed to parse error")}return m}startOrJoinCall(g,m,f,S,v){if(this.logger.info(`[${f}]startOrJoinCall[${m}]`),this.disposed)return void this.logger.info(`[${f}][${m}] session already disposed, ignore`);this.setMultiParty(1!==this.participantManager.getParticipantsToInitiateCallWith().length,f);const C=this.getConversationUrl()?this.getConversationUrl():g.conversationServiceUrl;this.telemetryHelper.setConversationServiceUrl(C),this.logger.info(`options.conversationServiceUrl ${g.conversationServiceUrl} conversationServiceUrl ${C}`),g.isPreheatOnly?(this.isPreheatOnly=!0,this.telemetryHelper.recordEvent(Wi.PREHEAT_ENABLING,{causeId:f}),this.telemetryHelper.setSelfParticipantRole(zi.ROLE.PREHEAT),this.telemetryHelper.setIsPreheated()):this.telemetryHelper.startCallCancelationDurationWatch(),this.mediaTypesToUse=v,this.lastUsedOutgoingMediaContent=S,this.telemetryHelper.setCallerType(this.participantManager.localParticipant.id),this.logger.info(`[${f}][${m}]target endpointType = ${this.transferContext&&this.transferContext.target?this.transferContext.target.endpointType:"default"}`);const _=g.newCall?getPayload32(this,S,v,g):getPayload35(this,S,v,g,f);this.signalingAgentConfig.enableCallEstablishmentTimeoutsForStartJoinCall&&this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(f)}),Hi.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT),this.signalingSessionCallback.onTransferredCallAcceptance(f),g.endpointState&&(this.latestEndpointState=g.endpointState),this.http.sendPostRequest({url:C,requestName:m,operationType:"CallSetup",payload:_,causeId:f}).then((g=>{this.disposed||(this.processConversationServiceResponseHeaders(g,f),this.processConversationServiceResponse(g.response,f,0),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTING,f))})).catch((g=>{if(g.stack&&!this.isFatalException(g))return;const S=getErrorForXHRFailure(g,this.signalingAgentConfig);if(this.logger.info(`[startOrJoinCall][${f}][${m}] error: ${getPrintableObject(g)} xhrError: ${getPrintableObject(S)}`),!this.disposed){if(this.isPromotingToRealtime)return void this.onPromotionCompleted(!0,S.error,f);this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,endCode:S.telemetryEndSubCode,endSubCode:S.error.subCode,resultCategories:S.error.resultCategories,resultDetail:S.error.phrase||this.getTerminatingCallResultDetail(m,S.error),causeId:f}),this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,f,S.error),this.dispose(S.error,f)}}))}processIncomingCallPayload(g,m){this.remoteUser=ji.fromWireParticipant(g.callNotification.from),this.participantManager.setLocalParticipantId(g.callNotification.to.participantId,m),g?(g.conversationInvitation&&(this.links[Hi.LINKS.CONVERSATION_CONTROLLER]=g.conversationInvitation.conversationController,this.setMultiParty(g.conversationInvitation.isMultiParty,m),this.setIsHostless(!!g.conversationInvitation.isHostless,m)),g.callNotification&&(this.links[Hi.LINKS.ATTACH]=g.callNotification.links&&g.callNotification.links.attach,this.links[Hi.LINKS.REDIRECT]=g.callNotification.links&&g.callNotification.links.redirection,this.onBehalfOf=g.callNotification.onBehalfOf&&g.callNotification.onBehalfOf.id,this.onBehalfOfUserDisplayName=g.callNotification.onBehalfOf&&g.callNotification.onBehalfOf.displayName,this.callPhoneLineType=g.callNotification.callPhoneLineType,this.callType=g.callNotification.callType,this.incomingCallCallerId=g.callNotification.from&&g.callNotification.from.id,this.callUsesMixer=!(!g.callNotification.mediaContent||!g.callNotification.mediaContent.fromMixer),this.isRedirectAllowed=!(!g.callNotification.redirectionProperties||!g.callNotification.redirectionProperties.isRedirectAllowed)),g.debugContent&&this.updateCorrelationId(g.debugContent.callId,m),g.callNotification.transferor&&(this.transferor=g.callNotification.transferor.details?g.callNotification.transferor.details.id:null),g.groupChat&&this.updateGroupChatIds(g.groupChat,m),g.meetingData&&(this.meetingData=g.meetingData),g.meetingInfo&&(this.meetingInfo=g.meetingInfo)):this.logger.info(`[${m}][processIncomingCallPayload] empty incoming payload content`)}processAttachResponse(g,m,f){this.telemetryHelper.recordEvent(Wi.PROCESS_INITIAL_OFFER,{causeId:f}),this.links[Hi.LINKS.MEDIA_ANSWER]=m.response.callInvitation.links.mediaAnswer,this.links[Hi.LINKS.ACCEPT]=m.response.callInvitation.links.acceptance,this.links[Hi.LINKS.REJECT]=m.response.callInvitation.links.callLeg,this.links[Hi.LINKS.REDIRECT]=m.response.callInvitation.links.redirection,this.links[Hi.LINKS.NEW_OFFER]=m.response.callInvitation.links.newOffer,this.signalingAgentConfig.sendProgressFromCC||this.sendProgress(m),this.remoteCaller=m.response.participants.from;const S=this.getInitialMediaOfferFromIncomingCallPayload()||m.response.callInvitation.mediaContent;this.telemetryHelper.setCallerType(this.getParticipantIdForOfferAnswer(S));const v=getMediaTypes(m.response.callInvitation.callModalities);this.telemetryHelper.addIncomingModalities(v),this.telemetryHelper.setOfferedModalities(S.blob,!0),this.callUsesMixer=S.fromMixer,this.isRedirectAllowed=!(!m.response.callInvitation.redirectionProperties||!m.response.callInvitation.redirectionProperties.isRedirectAllowed),this.signalingSessionCallback.onOffer({subject:g.conversationInvitation.subject,remoteParticipantId:this.getParticipantIdForOfferAnswer(S),remoteEndpointId:m.response.participants.from.endpointId,transferor:m.response.callInvitation.transferor,clientTransferContext:g.callNotification.transferContext,mediaTypes:v,mediaContent:S,renegotiation:!1,invitationData:m.response.callInvitation.invitationData,riskLevel:m.response.callInvitation.spamProperties&&m.response.callInvitation.spamProperties.riskLevel,stirAttestation:m.response.callInvitation.spamProperties&&m.response.callInvitation.spamProperties.stirAttestation,isRedirectAllowed:this.isRedirectAllowed},f)}sendProgress(g,m=causeId2()){this.logger.info(`[${m}][sendProgress]`),this.telemetryHelper.recordEvent(Wi.SEND_PROGRESS,{causeId:m}),this.http.sendPostRequest({url:g.response.callInvitation.links.progress,requestName:qi.SEND_CALL_PROGRESS.name,payload:getPayload29(this),causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][sendProgress] error: ${getPrintableObject(f)}`),this.disposed||this.telemetryHelper.recordEvent(Wi.SEND_PROGRESS_FAILED,{causeId:m,...f.error})}))}handleCallNotification(g){const m=extractCauseIdFromMessage(g);if(this.logger.info(`[${m}][handleCallNotification]`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CALL_NOTIFICATION,g),!stringEndsWith(g.url,Vi.REPLACE))throw new Error(`[${m}][handleCallNotification]IncomingCallNotification should not be received in handleIncomingMsg`);this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_INCOMING_CALL_REPLACEMENT,g),this.logger.info(`[${m}][handleCallNotification]replacementCallNotification`),this.signalingSessionCallback&&this.signalingSessionCallback.onIncomingCallReplacement(g.body,m)}handleMediaAnswer(g){this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_MEDIA_ANSWER,g);const m=g.body,f=extractCauseIdFromMessage(g);if(this.logger.info(`[${f}][handleMediaAnswer]`),this.mediaRenegotiationManager.isOutgoingRenegotiationInProgress())this.mediaRenegotiationManager.handleMediaAnswer(m,f);else if(this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED);else if(this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING){if(isDuplicateMessage(g.headers,this.provisionalMediaAnswersSeenSoFar))return void this.logger.info(`[${f}][handleMediaAnswer] ignoring provisional answer retried by service`);m.mediaAnswer.sender&&(this.remoteUser=m.mediaAnswer.sender),this.resetCallEstablishmentTimeout(f),m.mediaAnswer.noRingBack||(this.telemetryHelper.setTimeToRingDuration(),this.onCallStatusChanged(Hi.CALL_STATUS.RINGING,f));const S=m.mediaAnswer.mediaContent;this.signalingSessionCallback.onAnswer({provisional:!0,renegotiation:!1,remoteEndpointId:m.mediaAnswer.sender?m.mediaAnswer.sender.endpointId:newGuid(),remoteParticipantId:this.getParticipantIdForOfferAnswer(S),mediaContent:S},f)}}async _sendCallAcceptanceAcknowledgement(g,m){this.http.sendPostRequest({url:g.body.callAcceptance.links.acknowledgement,requestName:qi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:getPayload27(this),causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][_sendCallAcceptanceAcknowledgement] error: ${getPrintableObject(f)}`),this.disposed||this.telemetryHelper.recordEvent(Wi.HANDLE_CALL_ACCEPTANCE_FAILED,{causeId:m,...f.error})}))}handleCallAcceptance(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CALL_ACCEPTANCE,g,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:m}),this.logger.info(`[${m}][handleCallAcceptance]enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?(this._sendCallAcceptanceAcknowledgement(g,m),this._processCallAcceptance(g,m)):(this._processCallAcceptance(g,m),this.http.sendPostRequest({url:g.body.callAcceptance.links.acknowledgement,requestName:qi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,payload:getPayload27(this),causeId:m}).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig);this.logger.info(`[${m}][handleCallAcceptance] error: ${getPrintableObject(f)}`),this.disposed||this.telemetryHelper.recordEvent(Wi.HANDLE_CALL_ACCEPTANCE_FAILED,{causeId:m,...f.error})})))}handleCallAcceptanceSync(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CALL_ACCEPTANCE_SYNC,g,{enableQuickSendAcceptanceAck:this.signalingAgentConfig.enableQuickSendAcceptanceAck,causeId:m}),this.logger.info(`[${m}][handleCallAcceptanceSync] enableQuickSendAcceptanceAck:\n            ${this.signalingAgentConfig.enableQuickSendAcceptanceAck}`),this.signalingAgentConfig.enableQuickSendAcceptanceAck?en.defer(this._processCallAcceptance,g,m):this._processCallAcceptance(g,m);const f=getPayload27(this).payload;return this.telemetryHelper.addNetworkOperationCompleted(qi.SEND_ACCEPTANCE_ACKNOWLEDGEMENT.name,!0),f}getFakeRoster(g){const m=this.participantManager.getParticipantsToInitiateCallWith();let f;f=1===m.length?m[0].id:g.callAcceptance.acceptedBy.id;const S={id:f,displayName:g.callAcceptance.acceptedBy.id===f?g.callAcceptance.acceptedBy.displayName:"",languageId:g.callAcceptance.acceptedBy.languageId},v=g.callAcceptance.acceptedBy.endpointId;return{type:"MultiPartyEndpoint",participants:{[f]:{acceptedBy:g.callAcceptance.acceptedBy.id,details:S,endpoints:{[v]:{call:{},contentSharing:{},capabilities:g.callAcceptance.capabilities,participantId:g.callAcceptance.acceptedBy.participantId}}}}}}processCallAcceptance(g,m){this.logger.info(`[${m}][processCallAcceptance] ${getPrintableObject(g)}`),this.telemetryHelper.recordEvent(Wi.PROCESS_CALL_ACCEPTANCE,{causeId:m}),this.fsmState=Hi.SIGNALING_FSM_STATE.CONNECTED,this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.isPreheatOnly||this.telemetryHelper.startCallConnectedWatch(),this.mediaRenegotiationManager.onCallConnected(m);let f=!1;g.callAcceptance.controllerName===Hi.MISC.LOBBY_CALL_CONTROLLER&&(this.logger.info(`[${m}][processCallAcceptance] Controller name is lobby so putting user in lobby`),this.participantManager.localParticipant.isLobby=!0,this.participantManager.localParticipant.endpointDetails.push({isLobby:!0,endpointId:this.participantManager.localParticipant.endpointId,participantId:this.participantManager.localParticipant.participantId}),f=!0,this.telemetryHelper.recordEvent(Wi.ACCEPTANCE_USER_IN_LOBBY,{causeId:m})),this.participantManager.localParticipant.isStaging=hasStagingGroup(g.callAcceptance),this.signalingSessionCallback.onMeetingGroupDetailsUpdated(g.callAcceptance.meetingGroupDetails,m),this.signalingSessionCallback.updateIsSharedLineAppearanceV2Activated(g.callAcceptance.callProperties?.isSharedLineAppearanceV2Activated),this.logger.info(`[${m}][processCallAcceptance] for localParticipant, isStaging is set to ${this.participantManager.localParticipant.isStaging}`);let S=this.mediaTypesToUse,v=newGuid();g.callAcceptance.acceptedBy&&(this.remoteUser=ji.fromWireParticipant(g.callAcceptance.acceptedBy),v=g.callAcceptance.acceptedBy.endpointId),g.callAcceptance.acceptedCallModalities&&g.callAcceptance.acceptedCallModalities.length>0&&(S=g.callAcceptance.acceptedCallModalities);const C=g.callAcceptance.mediaContent;this.callUsesMixer=C.fromMixer;const _=getMediaTypes(S);this.telemetryHelper.addIncomingModalities(_),this.telemetryHelper.setAnsweredModalities(C.blob,!0),this.links[Hi.LINKS.MEDIA_RENEGOTIATION]=g.callAcceptance.links.mediaRenegotiation,this.links[Hi.LINKS.TRANSFER]=g.callAcceptance.links.transfer,this.links[Hi.LINKS.REPLACE]=g.callAcceptance.links.replacement,this.links[Hi.LINKS.HANGUP]=g.callAcceptance.links.callLeg,this.links[Hi.LINKS.KEEPALIVE]=g.callAcceptance.links.callLeg,this.links[Hi.LINKS.PARK]=g.callAcceptance.links.hold,this.links[Hi.LINKS.UPDATE_MEDIA_DESCRIPTIONS]=g.callAcceptance.links.updateMediaDescriptions,this.saveMediaControllerLinksIfAny(g.callAcceptance),this.scheduleKeepAlives(g.callAcceptance.callKeepAliveInterval);const E=this.getParticipantIdForOfferAnswer(C);this.signalingSessionCallback.onAnswer({provisional:!1,renegotiation:!1,remoteEndpointId:v,remoteParticipantId:E,callAcceptedByNGCVoicemail:E===Hi.KNOWN_BOTS.VOICEMAIL_BOT_ID,mediaTypes:_,mediaContent:C},m),this.setRealTimeState(2,m),this.onCallStatusChanged(Hi.CALL_STATUS.CONNECTED,m),f&&this.signalingSessionCallback.onSelfParticipantUpdated(this.participantManager.localParticipant,m),this.linkUpdateRequested.keepAliveLinks&&(this.logger.info(`[${m}][processCallAcceptance] Updating CC links as requested`),this.updateLinks(this.updateKeepAliveUrl,m))}updateGroupChatIds(g,m){const f=this.groupId,S=this.threadId,v=this.teamsMessageId,C=this.backroomThreadId;this.groupId=g.groupId,this.threadId=g.threadId,this.teamsMessageId=g.messageId,this.backroomThreadId=g.backroomThreadId,this.groupId===f&&this.threadId===S&&this.teamsMessageId===v&&this.backroomThreadId===C||this.signalingSessionCallback.onConversationUpdated({conversationType:this.conversationType,groupId:this.groupId,threadId:this.threadId,teamsMessageId:this.teamsMessageId,isMultiParty:this.multiParty,commandUrlPresence:this.getCommandUrlPresence(),meetingData:this.meetingData,region:this.region,meetingInfo:this.meetingInfo,callLimits:this.callLimits,isHuddleGroupCall:this.isHuddleGroupCall,backroomThreadId:this.backroomThreadId},m)}handleCallEnd(g){let m=g.body.callEnd||g.body;const f=extractCauseIdFromMessage(g);if(this.logger.info(`[${f}][handleCallEnd][content=${getPrintableObject(m)}]`),this.telemetryHelper.recordEvent(Wi.HANDLE_CALL_END,{origin:g.origin,code:m?m.code:"unknown",subCode:m?m.subCode:"unknown",resultCategories:m?m.resultCategories:[],causeId:f}),this.signalingAgentConfig.enableConversationTypeUpdateOnCallEnd&&(this.conversationType=m&&m.conversationType||this.conversationType),this.fsmState!==Hi.SIGNALING_FSM_STATE.IDLE)if(m.code===Hi.CALL_END_CODE.CONFLICT&&this.multiParty&&m.conversationUrl&&m.conversationUrl.Location)this.handleConversationResolutionConflict(m,f);else{this.disposing=!0,m.callControllerTransactionEnd&&(this.logger.info("handleCallEnd: using CC end details specified in CS end"),m=m.callControllerTransactionEnd),m.broadcastOperationFailure&&(this.logger.info("handleCallEnd: using broadcastOperationFailure end details specified in CS end"),m=m.broadcastOperationFailure);const g=m.code===Hi.CALL_END_CODE.SUCCESS||m.code===Hi.CALL_END_CODE.CANCEL||m.code===Hi.CALL_END_CODE.REJECT;this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.REMOTE,resultDetail:m.phrase,resultValue:g?zi.RESULT_VALUE.SUCCESS:zi.RESULT_VALUE.FAILURE,endCode:m.code,endSubCode:m.subCode,resultCategories:m?m.resultCategories:[],causeId:f});const S={code:m.code,subCode:m.subCode,phrase:m.phrase,resultCategories:m.resultCategories,pickupCode:""};this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,m.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:m.acceptedElsewhereBy.id,displayName:m.acceptedElsewhereBy.displayName}),m.unparkContent&&(m.unparkContent.CallParkAdditionalContext&&(this.parkAdditionalContextJson=JSON.stringify(m.unparkContent.CallParkAdditionalContext),this.serverHoldLocation=m.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),m.unparkContent.pickupCode&&(S.pickupCode=m.unparkContent.pickupCode)),this.onCallStatusChanged(Hi.CALL_STATUS.REMOTE_TERMINATED,f,S),this.dispose(S,f)}else this.logger.info(`[${f}][handleCallEnd] not handling incoming callEnd since fsmstate = SIGNALING_FSM_STATE.IDLE`)}handleConversationResolutionConflict(g,m){this.logger.info(`[${m}][handleConversationResolutionConflict]`);const f={...g,phrase:g.phrase||"Conflict Resolution Error"};if(this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING_FOR_ROSTER_ONLY||this.fsmState===Hi.SIGNALING_FSM_STATE.CONNECTED_FOR_ROSTER_ONLY)this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.http.cancelRequestIfPending(qi.JOIN_CONVERSATION_WITHOUT_CALL_MODALITY.name,m,void 0,f),this.subscribeToCall(g.conversationUrl.Location,g.correlationId,this.lastUsedJoinCallOptions?this.lastUsedJoinCallOptions.clientEndpointCapabilities:0,{meetingData:this.meetingData,meetingPreferences:this.meetingPreferences,additionalEndpointProperties:this.lastUsedJoinCallOptions?.additionalEndpointProperties},m);else{this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT);const S={meetingData:this.meetingData,meetingPreferences:this.meetingPreferences};if(this.lastUsedJoinCallOptions){const g=this.lastUsedJoinCallOptions.scenario;S.muted=this.lastUsedJoinCallOptions.muted,S.scenario=`409Redirect${g||""}`,S.isPreheatOnly=this.lastUsedJoinCallOptions.isPreheatOnly,S.clientEndpointCapabilities=this.lastUsedJoinCallOptions.clientEndpointCapabilities,S.clientEndpointDebugContent=this.lastUsedJoinCallOptions.clientEndpointDebugContent,S.additionalEndpointProperties=this.lastUsedJoinCallOptions.additionalEndpointProperties}else S.scenario="409RedirectJoin";this.setInitialTelemetry("JoinCall",{correlationId:g.correlationId,causeId:m,conversationServiceUrl:g.conversationUrl.Location,joinCallOptions:S,offerGenerationTime:void 0}),this.http.cancelRequestIfPending(qi.JOIN_CONVERSATION.name,m,void 0,f),this.http.cancelRequestIfPending(qi.START_CALL.name,m,void 0,f),this.joinGivenConversation(g.conversationUrl.Location,g.correlationId,this.lastUsedOutgoingMediaContent,this.mediaTypesToUse,void 0,S,m)}}handleCallProgress(g){this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CALL_PROGRESS,g);const m=extractCauseIdFromMessage(g);this.logger.info(`[${m}][handleCallProgress]`);const f=g.body.callProgress;this.fsmState===Hi.SIGNALING_FSM_STATE.OUTGOING&&(this.telemetryHelper.setTimeToRingDuration(),this.resetCallEstablishmentTimeout(m),this.onCallStatusChanged(Hi.CALL_STATUS.RINGING,m),"forwarded"===f.status&&this.signalingSessionCallback.onCallForwarded({destinationType:f.forwardingDestinationType||"user"},m))}resetCallEstablishmentTimeout(g){this.logger.info("resetCallEstablishmentTimeout"),this.timeoutManager.stopTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT),this.timeoutManager.startTimer(Hi.TIMEOUT_OPERATIONS.OUTGOING_CALL_ESTABLISHMENT,(()=>{this.handleCallEstablishmentTimeout(g)}),Hi.TIMEOUT_VALUES_IN_SECONDS.OUTGOING_CALL_ESTABLISHMENT_TIMEOUT)}handleMediaAcknowledgement(g){this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_MEDIA_ACK,g);const m=g.body,f=extractCauseIdFromMessage(g);this.currentCallStatus!==Hi.CALL_STATUS.CONNECTED?this.telemetryHelper.recordEvent(Wi.HANDLE_MEDIA_PROVISIONAL_ACK,{causeId:f}):this.mediaRenegotiationManager.handleMediaAcknowledgment(m,f)}handleConversationUpdate(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleConversationUpdate]content=${getPrintableObject(m)}`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_CONVERSATION_UPDATE,g),this.processConversationServiceResponse(m,f,2)}endBroadcastMeeting(g){this.logger.info(`[${g}][endBroadcastMeeting]`),this.broadcastSession=null}handleLocalParticipantUpdate(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleLocalParticipantUpdate]content=${getPrintableObject(m)}`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_LOCAL_PARTICIPANT_UPDATE,g),this.processLocalParticipantUpdateResponse(m,f)}handleAddModalityFailure(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAddModalityFailure]`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADD_MODALITY_FAILURE,g),m.modalityFailure.contentSharing?this.contentSharingManager?.handleAddModalityFailure(m,f):m.modalityFailure.groupChat?this.signalingSessionCallback.onChatModalitySetupFailed({code:m.modalityFailure.groupChat.code,subCode:m.modalityFailure.groupChat.subCode,phrase:m.modalityFailure.groupChat.phrase,resultCategories:m.modalityFailure.groupChat.resultCategories},f):m.modalityFailure.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalityFailure(m,f)}handleAddModalitySuccess(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleAddModalitySuccess]`),this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_ADD_MODALITY_SUCCESS,g),m.modalitySuccess.contentSharing?this.contentSharingManager?.handleAddModalitySuccess(m,f):m.modalitySuccess.groupChat?this.logger.info(`[${f}][handleAddModalitySuccess] group modality ${getPrintableObject(m.modalitySuccess.groupChat)}`):m.modalitySuccess.broadcast&&this.broadcastSession&&this.broadcastSession.handleAddBroadcastModalitySuccess(m,f)}handleTransferRequested(g){const m=g.body.callTransfer,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleTransferRequested]`),m.parkType?(this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_PARK_REQUESTED,g,{type:m.parkType}),this.telemetryHelper.addSharedCorrelationId(m.sharedCorrelationId)):"voicemail"===m.target.endpointType?(this.logger.info(`[${f}][handleTransferRequested] target endpointType = ${m.target.endpointType}`),this.telemetryHelper.recordIncomingEvent(Wi.TRANSFER_REQUEST_RECEIVED,g)):this.telemetryHelper.recordIncomingEvent(Wi.TRANSFER_REQUEST_RECEIVED,g),this.links[Hi.LINKS.TRANSFER_ACCEPTANCE]=m.links.transferAcceptance,this.links[Hi.LINKS.TRANSFER_COMPLETION]=m.links.transferCompletion,this.signalingSessionCallback.onTransferRequested?this.signalingSessionCallback.onTransferRequested(m,f):this.logger.info(`[${f}][handleTransferRequested] failed, no callback defined`)}handleTransferAcceptance(g){const m=extractCauseIdFromMessage(g);this.logger.info(`[${m}][handleTransferAcceptance]`),this.telemetryHelper.recordIncomingEvent(Wi.WAITING_FOR_TRANSFER_COMPLETION,g),this.signalingSessionCallback.onTransferAccepted?this.signalingSessionCallback.onTransferAccepted(m):this.logger.info(`[${m}][handleTransferAcceptance]failed, no callback defined`)}handleTransferCompletion(g){const m=g.body,f=extractCauseIdFromMessage(g);this.logger.info(`[${f}][handleTransferCompletion]`),m.sharedCorrelationId&&this.telemetryHelper.addSharedCorrelationId(m.sharedCorrelationId),m.unparkContent&&void 0!==m.unparkContent.pickupCode&&(m.unparkContent.pickupCode=m.unparkContent.pickupCode.toString(),this.telemetryHelper.recordIncomingEvent(Wi.PICKUP_CODE_SET,g)),this.signalingSessionCallback.onTransferCompleted?(g.body.transferCompletion&&(0===g.body.transferCompletion.code?this.telemetryHelper.recordIncomingEvent(Wi.TRANSFER_COMPLETED,g):(this.logger.info(`[${f}][handleTransferCompletion]-1-code: ${m.transferCompletion.code}, message: ${getPrintableObject(g)}`),this.telemetryHelper.recordIncomingEvent(Wi.TRANSFER_COMPLETION_FAILED,g,{code:m.transferCompletion.code,subcode:m.transferCompletion.subCode,resultCategories:m.transferCompletion.resultCategories}))),this.signalingSessionCallback.onTransferCompleted(m,f)):(g.body.transferCompletion&&(g.body.transferCompletion.code===Hi.CALL_END_CODE.NETWORK_ERROR?this.telemetryHelper.recordIncomingEvent(Wi.WAITING_FOR_TRANSFER_COMPLETION_FAIL,g):this.telemetryHelper.recordIncomingEvent(Wi.TRANSFER_COMPLETION_FAILED,g,{code:m.transferCompletion.code,subcode:m.transferCompletion.subCode,resultCategories:m.transferCompletion.resultCategories})),this.logger.info(`[${f}][handleTransferCompletion]failed, no callback defined`))}handleRosterUpdate(g,m){const f=g.body,S=extractCauseIdFromMessage(g);this.disposing||this.disposed?this.logger.info(`[${S}][handleRosterUpdate]failed=ignore call ending or ended`):this.internalHandleRosterUpdate(f,m,S)}handleNewMediaOffer(g){const m=extractCauseIdFromMessage(g);this.telemetryHelper.recordIncomingEvent(Wi.HANDLE_NEW_OFFER,g);const f=g.body.mediaOfferReady.mediaContent;this.callUsesMixer=f.fromMixer,this.signalingSessionCallback.onNewOffer({mediaContent:f,renegotiation:!1},m)}internalHandleRosterUpdate(g,m,f){if(g&&"Delta"!==g.type&&"MultiPartyEndpoint"!==g.type)this.logger.warn(`[${f}][internalHandleRosterUpdate] roster.type=${g.type} is invalid`);else{this.logger.info(`[${f}][internalHandleRosterUpdate]`);try{this.participantManager.handleRosterUpdate(g,m,f),this.contentSharingManager?.handleIncomingContentSharingFromRoster(g,m,f)}catch(m){const S={code:Hi.CALL_END_CODE.BAD_SERVICE_RESPONSE,subCode:Hi.CALL_END_SUB_CODE.ROSTER_HANDLING_INVALID_SERVICE_RESPONSE,phrase:m&&m.toString()};throw this.logger.info(`[${f}][internalHandleRosterUpdate] ${safeJsonStringify(S)}`),this.telemetryHelper.recordRosterEvent(g,Wi.HANDLE_ROSTER_UPDATE_FAIL,f),S}}}scheduleKeepAlives(g){const m=.9*g*1e3;this.logger.info(`scheduleKeepAlives: every ${m} milliseconds`),this.keepAliveInterval=m,this.keepAliveTimer=window.setInterval(this.sendKeepAlive.bind(this),this.keepAliveInterval)}scheduleConversationKeepAlive(){if(!this.conversationKeepAliveTimer&&!this.disposed){if(!this.conversationKeepAliveInterval){const g=getRandomizedTimeout(1e3*this.signalingAgentConfig.csaTimeoutConfiguration.conversationKeepAliveTimeoutSec);this.logger.info(`sendConversationKeepAlive: every ${g} milliseconds`),this.conversationKeepAliveInterval=g}this.conversationKeepAliveTimer=window.setInterval(this.sendConversationKeepAlive.bind(this),this.conversationKeepAliveInterval)}}sendConversationKeepAlive(){this.logger.info("sendConversationKeepAlive"),this.disposed?this.logger.info("sendConversationKeepAlive ignored"):(this.logger.info("sendConversationKeepAlive keepAlive count = "+this.conversationKeepAliveCount++),this.sendToUpdateConversationLinks(!0))}sendKeepAlive(){this.logger.info("sendKeepAlive"),this.disposed?this.logger.info("sendKeepAlive ignored"):(this.logger.info("sendKeepAlive keepAlive count = "+this.keepAliveCount++),this.sendToKeepAliveUrl(null))}sendToUpdateConversationLinks(g,m=causeId2()){if(this.disposed)return;const f=this.logger.createChild(`[${m}][sendToUpdateConversationLinks]`,this.correlationId),S=g?getPayload54(this):{},v=g?qi.UPDATE_CONVERSATION_LINKS.name:qi.SEND_CONVERSATION_KEEP_ALIVE.name,C=this.links[Hi.LINKS.NOTIFICATION_LINKS];f.info(`shouldUpdateUrl: ${g}, url: ${C}, payload: ${getPrintableObject(S)}`),C&&(this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.http.sendPostRequest({url:C,payload:S,withoutTrouter:!0,requestName:v,causeId:m}).then((g=>{this.disposed||(this.telemetryHelper.recordEvent(Wi.UPDATE_CONVERSATION_LINKS_SUCCESS,{causeId:m}),this.processConversationServiceResponse(g.response,m,2))})).catch((g=>{const f=getErrorForXHRFailure(g,this.signalingAgentConfig),S=isRetryable(f.error.code);this.logger.info(`[${m}][updateConversationLinks] error: ${getPrintableObject(f)}, retryable: ${S}`),this.disposed||(this.telemetryHelper.recordEvent(Wi.UPDATE_CONVERSATION_LINKS_FAILED,{causeId:m,...f.error}),S?this.scheduleConversationKeepAlive():this.links[Hi.LINKS.NOTIFICATION_LINKS]=null)})))}sendToKeepAliveUrl(g,m=causeId2()){const f=this.logger.createChild(`[${m}][sendToKeepAliveUrl]`,this.correlationId);f.info(`payload: ${getPrintableObject(g)}`),window.clearInterval(this.keepAliveTimer),this.disposed||(this.telemetryHelper.recordEvent(Wi.SEND_KEEP_ALIVE),this.http.sendPostRequest({url:this.links[Hi.LINKS.KEEPALIVE],payload:g,requestName:qi.SEND_KEEP_ALIVE.name,withoutTrouter:!0,causeId:m}).then((()=>{this.restartKeepAliveInterval()})).catch((g=>{const m=getErrorForXHRFailure(g,this.signalingAgentConfig);f.info(`error: ${getPrintableObject(m)}`),this.restartKeepAliveInterval(!0,m.error)})))}handleCallEstablishmentTimeout(g,m,f){const S={code:Hi.CALL_END_CODE.TIMEOUT,subCode:m||Hi.CALL_END_SUB_CODE.CALL_ESTABLISHMENT_TIMEOUT,phrase:f||Hi.CALL_END_PHRASE.ESTABLISHMENT_TIMEOUT,resultCategories:[ki.UnexpectedClientError]};this.isPromotingToRealtime?this.onPromotionCompleted(!0,S,g):(this.telemetryHelper.recordEvent(Wi.HANDLE_CALL_ESTABLISHMENT_TIMEOUT),this.telemetryHelper.setTerminatingData({terminatingEnd:zi.CALL_TERMINATING_END.LOCAL,resultValue:zi.RESULT_VALUE.FAILURE,resultDetail:S.phrase,endCode:S.code,endSubCode:S.subCode,causeId:g,resultCategories:S.resultCategories}),this.fsmState=Hi.SIGNALING_FSM_STATE.IDLE,this.onCallStatusChanged(Hi.CALL_STATUS.LOCAL_TERMINATED,g,S),this.dispose(S,g))}handleCallTransferTimeout(g,m){if(this.disposed)return void this.logger.info("Transfer: handleCallTransferTimeout ignored");const f={code:Hi.CALL_END_CODE.TIMEOUT,phrase:Hi.CALL_END_PHRASE.TRANSFER_COMPLETION_TIMEOUT};this.signalingSessionCallback.onTransferCompleted&&(!1===m?this.telemetryHelper.recordEvent(Wi.TRANSFER_COMPLETION_FAILED,{code:Hi.CALL_END_CODE.TIMEOUT,subcode:Hi.CALL_END_SUB_CODE.TRANSFER_COMPLETE_TIMEOUT,causeId:g}):!0===m&&this.telemetryHelper.recordEvent(Wi.WAITING_FOR_TRANSFER_ACCEPTANCE_FAIL,{causeId:g}),this.signalingSessionCallback.onTransferCompleted({transferCompletion:f},g))}checkCorrelationIdChange(g,m){if(g&&g.headers){const f=g.headers.get(Hi.HEADERS.CORRELATION_ID);if(f&&f.length){const S=[Vi.CONV_CONTENT_SHARING_UPDATE,Vi.CONV_CONTENT_SHARING_END].some((m=>g.url&&stringEndsWith(g.url,m)));this.correlationId===f||S||(this.logger.info(`[${m}]checkCorrelationIdChange:${this.correlationId} => ${f}`),this.telemetryHelper.addChangingCorrelationId(this.correlationId,f),this.updateCorrelationId(f,m))}}}getCommandUrlPresence(){let g=0;return this.links[Hi.LINKS.MUTE]&&(g|=1),this.links[Hi.LINKS.UNMUTE]&&(g|=2),g}getCallNotFoundTransactionEnd(){return{code:Hi.CALL_END_CODE.CALL_DOES_NOT_EXIST,subCode:0,phrase:Hi.CALL_END_PHRASE.CALL_DOES_NOT_EXIST}}getTerminatingCallResultDetail(g,m){return getPrintableObject({source:g,...m})}dispose(g,m){this.disposed||(this.logger.info(`[${m}][dispose] end reason ${getPrintableObject(g)}`),this.disposed=!0,this.disposing=!1,this.tearDownConnectionCheck(),this.conversationKeepAliveTimer&&(window.clearInterval(this.conversationKeepAliveTimer),this.conversationKeepAliveTimer=0),this.keepAliveTimer&&window.clearInterval(this.keepAliveTimer),this.brokerService&&this.brokerService.dispose(),this.http.cancelAllRequests(m).then((()=>{this.signalingAgent.onCallCompleted(this.sessionId,m),this.signalingAgentConfig.trouterUrlGetter&&this.signalingAgentConfig.trouterUrlGetter.trouterUrl.changed.off(this.onTrouterUrlChanged),this.signalingAgentConfig.trouterServiceProvider&&this.signalingAgentConfig.trouterServiceProvider.offStateChanged(this.onTrouterStateChanged),this.timeoutManager.dispose(),this.timeoutManager=null,this.participantManager.dispose(g,m),this.callOperationHandler.dispose("call ended",g,m),this.participantManager=null,this.mediaRenegotiationManager?.dispose(),this.mediaRenegotiationManager=null,this.contentSharingManager?.dispose(g,m),this.contentSharingManager=null,this.telemetryHelper.dispose(),this.telemetryHelper=null,this.webRtcSignalingManager.dispose(),this.webRtcSignalingManager=null})))}};function build5(g,m,f,S,v,C){return new Vn(g,m,f,S,v,C)}var Bn=class{constructor(g){this.endpointId=newGuid(),this.signalingSessions={},this.clientSupportsGenericTokenAPI=!1,this.getNewSignalingSession=(g,m,f,S)=>{const v=causeId2();assertNotNull(g,"selfParticipant should be a non null value"),assertNotNull(m,"signalingSessionCallback should be a non null value");const C=f||newGuid();assertNotNullOrEmpty(C,"signalingSession id generated cannot be null or empty"),this.checkConfigChange(v);const _=build5(g,m,this.signalingAgentConfig,C,this,S),E=_.sessionId;return this.signalingSessions[E]=_,this.logger.info(`[${v}]Created new signalingSession with correlation ID ${C} and session ID ${E}`),_},this.resolvePotentialCallConflict=g=>{const m=causeId2();let f;if(this.logger.info(`[${m}][resolvePotentialCallConflict]`),!g.multiParty)return Object.keys(this.signalingSessions).forEach((m=>{this.isSessionInConflictingState(this.signalingSessions[m],!g.isIncomingCall)&&(f=g.isIncomingCall?this.compareAndGetConflictingSession(g,this.signalingSessions[m]):this.compareAndGetConflictingSession(this.signalingSessions[m],g))})),f?(this.logger.info("Call conflict done, conflicting session callId=",f.correlationId,"urlIdentifier=",f.urlIdentifier),f.telemetryHelper.recordEvent(Wi.CONFLICTED_CALL),this.signalingAgentConfig.endConflictedCall?(this.endConflictedSession(f,m),f):void 0):void 0},this.handleIncomingNotification=g=>{if(assertNotNull(g,"request should be a non null value"),this.logger.info(`handleIncomingNotification to : ${g.url}`),!g.body&&!g.rawBody)return this.logger.error("request has no body"),this.buildNotificationResponse(Hi.HTTP_STATUS_CODES.BAD_REQUEST);let m=Hi.HTTP_STATUS_CODES.OK;const f=getIdFromUrl(g.url);if(f){const S=this.signalingSessions.hasOwnProperty(f);if(this.logger.info(`Is session found:${S}`),S){const m=this.signalingSessions[f];if(g.headers=new Gi(g.headers),isEncodedMessage(g.headers))try{if(!isMessageEncodingSupported(g.headers))throw new Error("Unsupported encoding");const m=decodeMessage(g.rawBody),f=JSON.parse(m);g.body=f}catch(g){return m.telemetryHelper.recordEvent(Wi.TROUTER_DECODE_PAYLOAD_FAILURE),this.buildNotificationResponse(Hi.HTTP_STATUS_CODES.BAD_REQUEST)}if(m.canHandleIncomingMsgSync(g))return m.handleIncomingMsgSync(g);window.setTimeout((()=>{if(this.signalingSessions.hasOwnProperty(f)){const m=this.signalingSessions[f];m.handleIncomingMsgAsync(g).catch((g=>{m&&m.telemetryHelper&&m.telemetryHelper.recordEvent(Wi.FAILED_TO_HANDLE_TROUTER_MESSAGE),this.logger.error(`handling IncomingMsg failed with error: ${g}`)}))}}),0)}else this.logger.info(`Incoming message for session ID ${f}, but session was not found!`),m=Hi.HTTP_STATUS_CODES.NOT_FOUND}else this.logger.error(`Could not retrieve session ID from Url path. Path = ${g.url}`),m=Hi.HTTP_STATUS_CODES.BAD_REQUEST;const S=this.buildNotificationResponse(m);return this.logger.info(`Result code:${getPrintableObject(S)}`),S},this.onCallCompleted=(g,m)=>{this.signalingSessions.hasOwnProperty(g)?(delete this.signalingSessions[g],this.logger.info(`[${m}][onCallCompleted] Session ID ${g} found. Deleted from signalingSession table`)):this.logger.info(`[${m}][onCallCompleted] Session ID ${g} not found. Could not delete from signalingSession table`)},this.applyAuthTokenCacheConfig=g=>{this.signalingAgentConfig.enableTokenCache?(this.authTokenManager.setTokenCaching(!0,g),this.signalingAgentConfig.enableTokenPrefetch&&this.authTokenManager.getToken(g).then((()=>{this.logger.info(`[${g}] token prefetch success`)})).catch((m=>{this.logger.info(`[${g}] token prefetch failure, error=${getPrintableObject(m)}`)}))):this.authTokenManager.setTokenCaching(!1,g),this.signalingAgentConfig.enableTokenCacheForGenericTokenAPI?this.authTokenManager.setTokenCachingForGenericTokenAPI(!0,g):this.authTokenManager.setTokenCachingForGenericTokenAPI(!1,g)},this.endConflictedSession=(g,m)=>{this.logger.info("Call conflict, ending signalingSession with callId=",g.correlationId,"urlIdentifier=",g.urlIdentifier),g.endAsync({code:Hi.CALL_END_CODE.CONFLICT,subCode:Hi.CALL_END_SUB_CODE.CONFLICT_IN_NG,phrase:Hi.CALL_END_PHRASE.CONFLICT},{forEveryone:!1,causeId:m})},this.compareAndGetConflictingSession=(g,m)=>{if(!is1to1Mri(g.incomingCallCallerId)||!is1to1Mri(m.participantManager.localParticipant.id))return;const f=stripMri(g.incomingCallCallerId),S=stripMri(m.participantManager.getParticipantsToInitiateCallWith().length&&m.participantManager.getParticipantsToInitiateCallWith()[0].id),v=stripMri(m.participantManager.localParticipant.id);return S===f?v>f?g:m:void 0},this.isSessionInConflictingState=(g,m)=>{if(!g)return this.logger.info("Call conflict, ignore, session already disposed"),!1;const f=[Hi.CALL_STATUS.IDLE,Hi.CALL_STATUS.CONNECTING,Hi.CALL_STATUS.RINGING];return!g.multiParty&&f.indexOf(g.getCallStatus())>-1&&(m&&g.isIncomingCall||!m&&!g.isIncomingCall)},this.buildNotificationResponse=(g,m)=>this.signalingAgentConfig.supportsSynchronousTrouterResponse?{resultCode:g,responseBody:m}:g,setDefaultsForSignalingConfig(g),this.signalingAgentConfig=g,this.logger=g.logger.createChild("SignalingAgent"),assertNotNull(g,"signalingAgentConfig should be a non null value"),this.logger.info(g.isWebRtcEnabled?"webRTC enabled":"ORTC enabled");const m={aadTokenExpirationTimeInSeconds:g.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:g.caeTokenExpirationTimeInSeconds,disableTokenMigrationHeader:g.disableTokenMigrationHeader,enablePublishTokenTelemetry:g.enablePublishTokenTelemetry,refreshTimeBeforeTokenTimeoutInSeconds:g.refreshTimeBeforeTokenTimeoutInSeconds,forceClearExpiredTokens:g.forceClearExpiredTokens,enableRefreshToken:g.enableRefreshToken,enableRefreshTokenRetry:g.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:g.enableRefreshTokenRetryInSeconds};this.authTokenManager=Xi.build(this.logger,g.skypeToken,m,g.telemetryManager),this.applyAuthTokenCacheConfig(causeId2()),Gi.useLowerCaseHeaders=g.forceLowercaseHttpHeaders}updateSignalingAgentConfig(g){const m=causeId2(),f=JSON.stringify(g,((g,m)=>g?String(m):m));this.logger.info(`[${m}] updateSignalingAgentConfig, SignalingAgentConfig: ${f}`),this.logger.info(`[${m}] ecsEtag=${g.ecsEtag}`),setDefaultsForSignalingConfig(g),this.updatedSignalingAgentConfig=g,this.authTokenManager?.updateTokenSettings({aadTokenExpirationTimeInSeconds:g.aadTokenExpirationTimeInSeconds,caeTokenExpirationTimeInSeconds:g.caeTokenExpirationTimeInSeconds,refreshTimeBeforeTokenTimeoutInSeconds:g.refreshTimeBeforeTokenTimeoutInSeconds,disableTokenMigrationHeader:g.disableTokenMigrationHeader,enablePublishTokenTelemetry:g.enablePublishTokenTelemetry,forceClearExpiredTokens:g.forceClearExpiredTokens,enableRefreshToken:g.enableRefreshToken,enableRefreshTokenRetry:g.enableRefreshTokenRetry,enableRefreshTokenRetryInSeconds:g.enableRefreshTokenRetryInSeconds}),Gi.useLowerCaseHeaders=g.forceLowercaseHttpHeaders}updateUrls(g,m,f){this.logger.info(`updateUrls: conversationServiceUrl: ${g}, uploadLogRequestUrl: ${m}, enforceUrls: ${f}`),this.updatedSignalingAgentConfig=this.updatedSignalingAgentConfig||this.signalingAgentConfig,f||!this.updatedSignalingAgentConfig.isConversationServiceUrlFromEcs?this.updatedSignalingAgentConfig.conversationServiceUrl=g||this.updatedSignalingAgentConfig.conversationServiceUrl:this.updatedSignalingAgentConfig.conversationServiceUrl=this.updatedSignalingAgentConfig.conversationServiceUrl||g,f||!this.updatedSignalingAgentConfig.isUploadLogRequestUrlFromEcs?this.updatedSignalingAgentConfig.uploadLogRequestUrl=m||this.updatedSignalingAgentConfig.uploadLogRequestUrl:this.updatedSignalingAgentConfig.uploadLogRequestUrl=this.updatedSignalingAgentConfig.uploadLogRequestUrl||m}update(g){this.logger.info(`update accountConfiguration ${JSON.stringify(g)}`),g&&g.clientSupportsGenericTokenAPI!==this.clientSupportsGenericTokenAPI&&(this.clientSupportsGenericTokenAPI=g.clientSupportsGenericTokenAPI,this.authTokenManager.updateTokenSettings({clientSupportsGenericTokenAPI:this.clientSupportsGenericTokenAPI})),this.accountConfig=g}sendPushAsync(g,m,f,S,v=causeId2()){const C=new Zi(this.signalingAgentConfig.piiScrubber),_=`sendPush[local participant mri = ${C.scrubMriOrOmit(g)}][recipientList = ${C.scrubMriOrOmit(m)}][headers = ${f})][causeId = ${v}]`;if(!g?.id)return this.logger.info(`${_} Empty localParticipantId`),Promise.reject("invalid localParticipantId");if(!m||0===m.length||m.every((g=>g&&""===g.id)))return this.logger.info(`${_} Empty recipientList`),Promise.reject("invalid recipientList");if(!f)return this.logger.info(`${_} Empty headers`),Promise.reject("invalid headers");if(!S||null===tryParse(S))return this.logger.info(`${_} Invalid body.`),Promise.reject("invalid body");const E={...tryParse(S),To:Array.from(m,(g=>g.id)),From:g.id},T=new Gi(f);T.hasOwnPropertyCaseInsensitive(Hi.HEADERS.CORRELATION_ID)||T.set(Hi.HEADERS.CORRELATION_ID,generateGuid()),T.hasOwnPropertyCaseInsensitive(Hi.HEADERS.MESSAGE_ID)||T.set(Hi.HEADERS.MESSAGE_ID,generateGuid()),T.hasOwnPropertyCaseInsensitive(Hi.HEADERS.PARTICIPANT_ID)||T.set(Hi.HEADERS.PARTICIPANT_ID,generateGuid()),T.hasOwnPropertyCaseInsensitive(Hi.HEADERS.CONTENT_TYPE)||T.set(Hi.HEADERS.CONTENT_TYPE,"application/json"),T.hasOwnPropertyCaseInsensitive(Hi.HEADERS.CLIENT_USER_AGENT)&&T.set(Hi.HEADERS.CLIENT_USER_AGENT,T.get(Hi.HEADERS.CLIENT_USER_AGENT)+`/TsCallingVersion=${getTsCallingVersion()}/Ovb=${getOvb()}`);const I=this.signalingAgentConfig.httpRequestDispatcher.getRequestOptions("POST",T?.getAll(),JSON.stringify(E),3e4);return new Promise(((g,m)=>{this.signalingAgentConfig.httpRequestDispatcher.postAsync(this.signalingAgentConfig.uploadLogRequestUrl||Hi.URL_DEFAULTS.UPLOAD_LOG_URL,I).then((()=>{g()})).catch((g=>{m(g)}))}))}getSignalingSession(g){for(const m of Object.keys(this.signalingSessions)){const f=this.signalingSessions[m];if(f.correlationId===g)return f}return null}updateToken(g,m,f,S,v){this.authTokenManager.updateToken(g,m,f,S,v)}setTokenRequiredCallBack(g){this.authTokenManager.setTokenRequiredCallBack(g)}resetAuthTokenManager(){this.setTokenRequiredCallBack(null),this.authTokenManager.setDisableTimerFlag(!0),this.authTokenManager.dispose()}checkConfigChange(g){this.updatedSignalingAgentConfig&&this.updatedSignalingAgentConfig!==this.signalingAgentConfig&&(this.signalingAgentConfig=this.updatedSignalingAgentConfig,this.updatedSignalingAgentConfig=null,this.applyAuthTokenCacheConfig(g))}},Hn=/;aliases=.*$/i,$n="8:",Gn=";aliases=",jn="2:",Wn="4:";function stripMriAliases(g){return g?g.replace(Hn,""):g}function generateAliasedMri(g,m){let f=g;return m&&(f+=Gn+jn+m),f}var isOneOfPhaseErrors=(g,m)=>m&&void 0!==m.phase&&!!g[m.phase],isPhaseError=(g,m)=>m&&void 0!==m.phase&&m.phase===g;function createPhaseExecutor(g){const m={},recordPhaseStep=g=>{const f={status:"Pending"};m[g]=f},recordStepDoneTelemetry=(g,f)=>{m[g].t=f,delete m[g].status},recordStepFailedTelemetry=(g,f,S)=>{m[g].status="Failed",m[g].t=f,m[g].reason=getPrintableObject(S)};return{execute:async(f,S)=>{const v=g.createChild(`[phase=${f}]`);recordPhaseStep(f),v.info("started");const C=(new Date).getTime();try{const g=await S(),m=+new Date-C;return v.logSuccess(`done, time=${m}`),recordStepDoneTelemetry(f,m),g}catch(g){const S=+new Date-C;throw v.logFailure(`time=${S}, error=${getPrintableObject(g)}`),recordStepFailedTelemetry(f,S,g),{phase:f,error:g,phases:m}}},executeSync:(f,S)=>{const v=g.createChild(`[phase=${f}]`);v.info("started"),recordPhaseStep(f);const C=(new Date).getTime();try{const g=S(),m=+new Date-C;return recordStepDoneTelemetry(f,m),v.logSuccess(`done, time=${m}`),g}catch(g){const S=+new Date-C;throw v.logFailure(`time=${S}, error=${getPrintableObject(g)}`),recordStepFailedTelemetry(f,S,g),{phase:f,error:g,phases:m}}},getTelemetryData:()=>m}}function callStateIsAnyOf(g,m){return-1!==m.indexOf(g)}var qn,zn,Kn,Jn={0:[1,2,8,6,10,11,9],1:[2,6,7,10,13],2:[1,3,6,7,9,10,13,14],3:[6,7,4,5,10,13],8:[1,11,10,2,9,6,7],4:[6,7,3,5,10,13],5:[6,7,3,4,10,13],9:[3,6,7,10,13],10:[3,6,7,9,4,5,13,15],13:[3,6,7,4,5],14:[3,6,7,10,13],15:[3,6,7,4,5,13],11:[12,1,2,6,7],12:[2,6,7],6:[7],7:[]};(g=>{let m;var f;let S;var v;let C;var _;let E;var T;(f=m=g.VideoEffectType||(g.VideoEffectType={})).Off="off",f.BackgroundBlur="blur",f.BackgroundReplacement="replacement",(v=S=g.PowerPreference||(g.PowerPreference={})).Default="default",v.HighPerformance="high-performance",v.LowPower="low-power",(_=C=g.ProcessorType||(g.ProcessorType={})).Wasm="Wasm",_.Webgl2="Webgl2",(T=E=g.EffectQualityChangeReason||(g.EffectQualityChangeReason={}))[T.ExternalParam=0]="ExternalParam",T[T.Performance=1]="Performance",T[T.RendererSize=2]="RendererSize"})(qn||(qn={})),(g=>{let m;var f;let S;var v;let C;var _;let E;var T;let I;var b;(f=m=g.CallType||(g.CallType={}))[f.P2P=0]="P2P",f[f.Conference=1]="Conference",f[f.PSTN=2]="PSTN",f[f.BroadcastingConf=3]="BroadcastingConf",(v=S=g.AudioUsageMode||(g.AudioUsageMode={}))[v.Default=0]="Default",v[v.LongRangeSpeaker=1]="LongRangeSpeaker",v[v.Auditorium=2]="Auditorium",(_=C=g.AecPerfProfile||(g.AecPerfProfile={}))[_.Normal=0]="Normal",_[_.Soc=1]="Soc",_[_.Mobile=2]="Mobile",_[_.NoisyTimestamps=3]="NoisyTimestamps",(T=E=g.VqeMode||(g.VqeMode={}))[T.Off=0]="Off",T[T.SkypeNS=1]="SkypeNS",T[T.SkypeAEC=2]="SkypeAEC",T[T.SkypeVQE=3]="SkypeVQE",T[T.DeepNS=4]="DeepNS",T[T.DeepVQE=5]="DeepVQE",(b=I=g.AudioEffectType||(g.AudioEffectType={})).Off="Off",b.NoiseSuppressionDeep="Deep NS",b.NoiseSuppressionClassic="Classic NS",b.EchoCancellationClassic="Classic AEC",b.VoiceQualityEnhancementClassic="Classic VQE",b.VoiceQualityEnhancementDeep="Deep VQE"})(zn||(zn={})),(g=>{let m;var f;let S;var v;(f=m=g.FrameType||(g.FrameType={}))[f.None=0]="None",f[f.Software=1]="Software",f[f.Hardware=2]="Hardware",(v=S=g.LogLevel||(g.LogLevel={}))[v.Default=0]="Default",v[v.Debug=1]="Debug",v[v.Info=2]="Info",v[v.Warning=3]="Warning",v[v.Error=4]="Error"})(Kn||(Kn={}));var Yn=R,Qn=(g=>(g[g.CallStateChanged=0]="CallStateChanged",g[g.TrouterStateChanged=1]="TrouterStateChanged",g[g.MultiPartyModeSet=2]="MultiPartyModeSet",g[g.MediaRetargetSucceeded=3]="MediaRetargetSucceeded",g[g.MediaRetargetFailed=4]="MediaRetargetFailed",g))(Qn||{}),Xn=(g=>(g[g.StartModality=0]="StartModality",g[g.StopModality=1]="StopModality",g[g.StreamStateChanged=2]="StreamStateChanged",g[g.NegotiationStateChanged=3]="NegotiationStateChanged",g))(Xn||{}),Zn=(g=>(g[g.SelectSource=0]="SelectSource",g[g.AttachSource=1]="AttachSource",g[g.DetachSource=2]="DetachSource",g))(Zn||{}),er=(g=>(g[g.Available=0]="Available",g[g.Subscribe=1]="Subscribe",g[g.Subscribed=2]="Subscribed",g[g.Unsubscribe=3]="Unsubscribe",g[g.Unsubscribed=4]="Unsubscribed",g[g.RenderingStarted=5]="RenderingStarted",g[g.RenderingStopped=6]="RenderingStopped",g))(er||{}),tr=class{constructor(g,m){this.value=g,this.piiKind=m}},ir=class{};ir.agentEnvironmentId="agent_environment_id",ir.correlationId="CorrelationId",ir.participantId="participant_id",ir.tenantId="TenantId",ir.userHexCID="UserHexCID",ir.acsResourceId="AcsResourceId",ir.endpointId="endpoint_id",ir.mediaLegId="media_leg_id",ir.webMediaConfigIds="web_media_config_ids",ir.tsCallingVersion="ts_calling_version";var nr=class{};nr.diagnostics="MediaDiagnostic",nr.qoeStats="QoE",nr.webrtcSession="webrtc_session",nr.webrtcSessionInitial="webrtc_session_initial",nr.realtimeTelemetry="realtimetelemetry",nr.webrtcMediaSession="webrtc_call_session",nr.mediaSession="pluginless_modality_session",nr.callSession="pluginless_call_session";var rr=class{constructor(g){this.eventName=g,this.ended=!1,this.events=[]}setLocalUserId(g){this.localUserId=g}start(){this.ended||(this.startTime=Date.now())}end(g=0){this.ended||(this.ended=!0,this.resultCode=g)}asStatsRecord(g={}){if((0,Yn.isEmpty)(this.events))return null;const m=(0,Yn.uniqBy)(this.events,(g=>JSON.stringify(g))).map((g=>{const m={[g.type]:g.timestamp-this.startTime};return(0,Yn.isEmpty)(g.data)||(m.data=g.data),m}));return{name:this.eventName,record:(0,Yn.assign)({LocalUser:this.localUserId,ResultCode:String(this.resultCode),EventTimestampBag:JSON.stringify({eventStart:this.startTime,events:m})},g)}}add(g){!this.ended&&g.type&&((0,Yn.isUndefined)(this.startTime)&&(this.startTime=Date.now()),(0,Yn.isUndefined)(g.timestamp)&&(g.timestamp=Date.now()),this.events.push(g))}},sr=class _CallStats extends rr{constructor(){super(nr.callSession)}callStateChanged(g){super.add({type:Qn[0],data:_CallStats.callStateToString[g]||g})}event(g){super.add({type:Qn[g]})}};sr.callStateToString={0:"None",1:"Notified",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",6:"Disconnecting",7:"Disconnected",8:"Observing",10:"Lobby"};var ar=sr,or=class _MediaModalityStats extends rr{constructor(g,m){super(nr.mediaSession),this.mediaType=g,this.mediaDirection=m,this.streamDirection=_MediaModalityStats.mediaDirectionToStream[this.mediaDirection]}addEvent(g,m){super.add({type:g,data:m})}lifecycle(g){this.addEvent(Xn[g])}streamStateChanged(g,m=this.streamDirection){const f=Xn[2];this.addEvent(f,{state:_MediaModalityStats.streamStateToString[g],direction:_MediaModalityStats.streamDirectionToString[m]})}negotiationStateChanged(g,m,f=this.streamDirection){const S=Xn[3];this.addEvent(S,{state:_MediaModalityStats.negotiationStateToString[g],reason:m})}asStatsRecord(g={}){return super.asStatsRecord((0,Yn.assign)({MediaType:_MediaModalityStats.mediaTypeToString[this.mediaType],Role:_MediaModalityStats.mediaDirectionToRole[this.mediaDirection]},g))}};or.negotiationStateToString={started:"NegotiationStarted",rejected:"NegotiationRejected",completed:"NegotiationCompleted"},or.streamStateToString={created:"StreamCreated",started:"StreamStarted",active:"StreamActive",inactive:"StreamInactive",stopped:"StreamStopped",removed:"StreamRemoved",failed:"StreamFailed",cancelled:"StreamCancelled"},or.streamDirectionToString={send:"Send",receive:"Receive"},or.mediaTypeToString={0:"Audio",1:"Video",2:"ScreenShare",3:"Data"},or.mediaDirectionToRole={1:"Receiver",2:"Sender",4:"Bidirectional"},or.mediaDirectionToStream={1:"receive",2:"send"};var lr=or,cr=class extends lr{constructor(){super(0,4)}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}},dr=class extends lr{constructor(g){super(g,2),this.mediaType=g}start(){super.start(),super.lifecycle(0)}stop(){super.lifecycle(1)}event(g){super.addEvent(Zn[g])}},hr=class extends lr{constructor(g,m){super(g,1),this.mediaType=g,this.remoteParticipantId=m,this.rendererCounter=0}newRendererId(){return this.rendererCounter+=1,String(this.rendererCounter)}event(g,m,f){super.addEvent(er[g],(0,Yn.isUndefined)(f)?{rendererId:m}:{rendererId:m,sourceId:f})}asStatsRecord(){return super.asStatsRecord({TargetUser:this.remoteParticipantId})}},ur=class{constructor(){this.allStats=[],this.ended=!1}setLocalUserId(g){this.localUserId=g}get call(){return this.callStats||this.startCall()}get audio(){return this.audioStats||this.newSession(0)}get video(){return this.videoStats||this.newSession(1)}get screenShare(){return this.sharingStats||this.newSession(2)}renderer(g,m){let f=this.renderingStats[m];return f||(f=this.renderingStats[m]=this.receive(g,m)),f}startCall(){return this.callStats?this.callStats:(this.callStats=new ar,this.callStats.start(),this.addStats(this.callStats))}endCall(g=0){this.ended=!0,this.call.end(g),this.allStats.forEach((g=>g.end())),this.cleanUp()}cleanUp(){this.audioStats&&(this.audioStats.stop(),this.audioStats=null),this.videoStats&&(this.videoStats.stop(),this.videoStats=null),this.sharingStats&&(this.sharingStats.stop(),this.sharingStats=null)}newSession(g){let m;switch(g){case 0:m=this.audioStats=new cr;break;case 1:m=this.videoStats=new dr(g);break;case 2:m=this.sharingStats=new dr(g)}return this.addStats(m)}receive(g,m){const f=new hr(g,m);return f.start(),this.addStats(f)}buildStatsRecords(){return this.allStats.map((g=>g.asStatsRecord())).filter((g=>!!g))}addStats(g){return this.ended||(this.allStats.push(g),g.setLocalUserId(this.localUserId)),g}},gr=class _CallTelemetryBuilder{constructor(g){this.configProvider=g,this.localStats=new ur,this.tsCallingVersion=getTsCallingVersion()}setCallId(g){this.callId=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}setParticipantId(g){this.participantId=g}setEndpointId(g){this.endpointId=g}setMediaLegId(g){this.mediaLegId=g}setMediaStats(g){this.mediaStats=g}setAcsResourceId(g){this.acsResourceId=g}appendDataChannelInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.DataHandlers=g)}appendSharingControlInfo(g){this.mediaStats?.data&&(this.mediaStats.data.SharingControlEnabled=g?"true":"false")}appendMediaControlPaneInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.MediaControlPlane=g)}appendTerminationInfo(g,m){this.mediaStats?.data&&(this.mediaStats.data.TerminatedReason=`${g}`,this.mediaStats.data.TerminatedState=`${m}`)}appendPictureInPictureInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.PictureInPicture=g)}appendCallDeviceManagerInfo(g){this.mediaStats?.data&&g&&(this.mediaStats.data.CallDeviceManager=g)}buildFromMediaStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,nr.webrtcSession)]:[]}buildShortBeaconEvent(){const g=this.configProvider?.config?.mediaEventDictionary??je.MEDIA_EVENT_FIELDS,m={};m[ir.correlationId]=this.callId||"",m[ir.participantId]=this.participantId||"",m[ir.tenantId]=this.tenantId||"",m[ir.tsCallingVersion]=this.tsCallingVersion||"",m.metrics_TerminationReason_code=new tr(oi.CODE.SUCCESS,0),m.metrics_TerminationReason_subCode=new tr(oi.SUB_CODE.BEACON,0);const f=this.buildFromDictionary(this.mediaStats.data,g);return[{eventName:nr.webrtcMediaSession,props:this.buildProps(f,null,m)}]}buildShortCallModalityStats(){const g={};return g[ir.correlationId]=this.callId||"",g[ir.userHexCID]=this.userHexCID||"",g[ir.participantId]=this.participantId||"",g[ir.endpointId]=this.endpointId||"",g[ir.tenantId]=this.tenantId||"",g[ir.tsCallingVersion]=this.tsCallingVersion||"",g[ir.acsResourceId]=this.acsResourceId||"",g.Code=new tr(oi.CODE.SUCCESS,0),g.SubCode=new tr(oi.SUB_CODE.BEACON,0),[{eventName:"skypecosi_concore_web_csa_conversation_callmodality",props:g}]}buildFromDictionary(g,m){const f={};for(const S in m)g[S]&&(f[S]={},m[S].forEach((m=>{void 0!==g[S][m]&&(f[S][m]=g[S][m])})));return f}buildMediaTelemetry(){if(!this.mediaStats)return;const g=this.buildEvent(this.mediaStats.data,null).props,m={};return Object.keys(g).forEach((f=>{void 0===g[f].piiKind?m[f]=g[f]:m[f]=g[f].value})),m}buildMidCallTelemetry(g){if(!this.mediaStats)return[];const m=this.buildEvent(this.mediaStats.data,nr.webrtcSession),f=m.props,S=g.reduce(((g,m)=>(f[m]&&(g[m]=f[m]),g)),{});return[{eventName:m.eventName,props:S}]}buildFromCallSetupStats(){return"WebRtcMediaStats"===this.mediaStats?.type?[this.buildEvent(this.mediaStats.data,nr.webrtcSessionInitial)]:[]}buildFromLocalStats(){return this.localStats.buildStatsRecords().map((g=>this.buildEvent(g.record,g.name)))}buildEvent(g,m){const f={};return f[ir.agentEnvironmentId]=_CallTelemetryBuilder.agentEnvironmentId,f[ir.correlationId]=this.callId||"",f[ir.tenantId]=this.tenantId||"",f[ir.userHexCID]=this.userHexCID||"",f[ir.participantId]=this.participantId||"",f[ir.endpointId]=this.endpointId||"",f[ir.mediaLegId]=this.mediaLegId||"",f[ir.webMediaConfigIds]=this.webMediaConfigIds||"",f[ir.tsCallingVersion]=this.tsCallingVersion||"",f[ir.acsResourceId]=this.acsResourceId||"",{eventName:m,props:this.buildProps(g,null,f)}}normalizeKey(g){return g.replace(/[^a-zA-Z0-9._]/g,"_")}buildProps(g,m,f){return Object.keys(g).forEach((S=>{const v=this.normalizeKey(S),C=m?`${m}_${v}`:v,_=g[S];if((0,Yn.isString)(_))f[C]=this.getPiiAwareValue(S,_);else if((0,Yn.isArray)(_)){if(_.length>0){const g=_,m=g.map((g=>g.value)).toString();f[C]=new tr(m,g[0].type)}}else if((0,Yn.isObject)(_))if(_.__VALUE__){const g=_;(0,Yn.isBoolean)(g.value)&&(g.value=g.value?"true":"false"),f[C]=new tr(g.value,g.type)}else this.buildProps(_,C,f)})),f}getPiiAwareValue(g,m){return _CallTelemetryBuilder.piiProps.hasOwnProperty(g)?new tr(m,_CallTelemetryBuilder.piiProps[g]):m}build(){return(0,Yn.flatten)([this.buildFromMediaStats(),this.buildFromLocalStats()])}};gr.agentEnvironmentId=generateGuid(),gr.piiProps={IPAddr:13,MACAddr:13,IPAddress:13,OpaqueData:0,LocalSite:13,RemoteSite:13,BaseAddress:13,LocalAddress:13,RemoteAddress:13,NetworkName:12,LocalUser:10,TargetUser:10};var pr=gr,mr=R;function convertReason(g){return g?getTerminationCode(g.code,g.subCode):0}function convertSignalingEndpointDetails(g,m){const f={clientVersion:g.clientVersion,participantId:g.participantId,endpointId:g.endpointId,endpointType:g.endpointType,endpointMetadata:g.endpointMetadata,originalId:g.originalId,capabilities:g.capabilities,clientEndpointCapabilities:g.clientEndpointCapabilities,mappedTo:g.mappedTo,meetingGroupDetails:g.meetingGroupDetails};return g.mediaStreams&&(f.mediaStreams=g.mediaStreams),g.appliedInteractivityLevel&&(f.appliedInteractivityLevel=g.appliedInteractivityLevel),g.deviceType&&(f.deviceType=g.deviceType),g.streamInformation&&32&m&&(f.streamInformation=g.streamInformation),g.propertyBag&&(f.propertyBag=g.propertyBag),f}function getTerminationCode(g,m=null){if(g===vi.Success)switch(m){case yi.RemovedFromConversation:case yi.RemovedFromCall:return 44;case yi.DeniedInLobby:return 55;case yi.TimedOutInLobby:return 56;default:return 1}if(null!==m&&m>=2e5&&m<=299999){const g=m-2e5;return _i[g]?_i[g]:0}return null!==m&&m>=4e5&&m<=499999?Ei[g]?Ei[g]:43:g===vi.Forbidden?m===yi.UserBlocked?64:m===yi.PolicyRestriction?62:m===yi.AnonymousJoinDisabledByPolicy?66:m===yi.NoLobbyForBroadcastJoin?67:m===yi.NotAllowedDueToInformationBarrier?68:m===yi.TeamParkPolicyDisabled?70:m===yi.B2bJoinDisabledByPolicy?71:m===vi.Success?8:7:g===vi.PreconditionFailed&&m===yi.InsufficientCapabilities?63:g===vi.ServiceUnavailable?m===yi.BroadcastLimitReached?69:48:g===vi.InternalServerError?7:g===vi.ConfParticipantCountLimitReached?m===yi.MaxLobbyParticipantLimitReached?73:59:Ci[g]?Ci[g]:g}function getCSAEndCode(g){if(1===g)return vi.Success;const m=Object.keys(Ci).filter((m=>Ci[m]===g));if(m.length>=1)for(const f of m){const m=parseInt(f);if(m&&Ci[m]===g)return m}return vi.UnknownError}function getMediaState(g,m){if(void 0!==m&&3!==m&&1!==m)return{mediaType:g,isDisabled:0===m,label:getMediaLabel(g)}}function getCallStartOptions(g){if(g.sendMediaModalities)return g;const m={mediaStates:[]};let f=getMediaState(0,g.audioDirection?g.audioDirection:4);return f&&m.mediaStates.push(f),f=getMediaState(1,g.withVideo?4:g.videoDirection),f&&m.mediaStates.push(f),f=getMediaState(2,g.screenshareDirection?g.screenshareDirection:1),f&&m.mediaStates.push(f),g.sendMediaModalities=m,g}function convertRedirectOptions(g){const m=convertRedirectionTargetIdType(g.type),f=convertRedirectionEndpointType(g.endpointType);return{type:m,id:g.id,endpointType:f}}function convertRedirectionTargetIdType(g){if("mri"===g)return"mri";throw"Unknown RedirectionTargetIdType"}function convertRedirectionEndpointType(g){switch(g){case"voicemail":return"voicemail";case"default":return"default";default:throw"Unknown RedirectionEndpointType"}}var fr=class{constructor(g){this.mediaStateConfiguration=g}isDisabled(g){if(this.mediaStateConfiguration?.mediaStates){const m=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));return!!m&&!!m.isDisabled}return!1}isInactiveOrDisabled(g){if(this.mediaStateConfiguration?.mediaStates){const m=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));return!m||!!m.isDisabled}return!1}isSending(g){if(this.mediaStateConfiguration?.mediaStates){return!!this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g&&!m.isDisabled))}return!1}disableModality(g){this.setModality(g,!0)}enableModality(g){this.setModality(g,!1)}removeModality(g){this.mediaStateConfiguration?.mediaStates&&(0,mr.remove)(this.mediaStateConfiguration.mediaStates,(m=>m.mediaType===g))}setCallAcceptOptions(g){const m=this.isDisabled(1),f=this.isDisabled(2),S=this.isSending(3);if(g.sendMediaModalities)this.mediaStateConfiguration=g.sendMediaModalities;else{void 0===g.answerMediaType&&(g.answerMediaType=g.withVideo?1:0);const m={mediaStates:[]};switch(g.answerMediaType){case 0:m.mediaStates.push(getMediaState(0,4));break;case 1:m.mediaStates.push(getMediaState(0,4)),m.mediaStates.push(getMediaState(1,4));break;case 2:m.mediaStates.push(getMediaState(1,0))}this.mediaStateConfiguration=m}m&&this.setModality(1,!0),f&&this.setModality(2,!0),S&&this.setModality(3,!1),g.sendMediaModalities=this.mediaStateConfiguration}setModality(g,m){if(this.mediaStateConfiguration?.mediaStates){const f=this.mediaStateConfiguration.mediaStates.find((m=>m.mediaType===g));f?f.isDisabled=m:this.mediaStateConfiguration.mediaStates.push({mediaType:g,isDisabled:m,label:getMediaLabel(g)})}}};function hasValue2(g){return g||!1===g||""===g||0===g}function scrubCallOptions(g){const m={};hasValue2(g.callStartTime)&&(m.callStartTime=g.callStartTime),hasValue2(g.callVoicemailStartOptions)&&(m.callVoicemailStartOptions=g.callVoicemailStartOptions),hasValue2(g.invitationType)&&(m.invitationType=g.invitationType),hasValue2(g.meetingPreferences)&&(m.meetingPreferences=g.meetingPreferences),hasValue2(g.parkContext)&&(m.parkContext=g.parkContext),hasValue2(g.pickupCode)&&(m.pickupCode=g.pickupCode),hasValue2(g.participantsToNudge)&&(m.participantsToNudgeSize=g.participantsToNudge.length);const f=g.callStartOptions;if(f){const g={};hasValue2(f.additionalEndpointProperties)&&(g.additionalEndpointProperties=f.additionalEndpointProperties),hasValue2(f.clientEndpointCapabilities)&&(g.clientEndpointCapabilities=f.clientEndpointCapabilities),hasValue2(f.connectionType)&&(g.connectionType=f.connectionType),hasValue2(f.invitationDataJson)&&(g.invitationDataJson=f.invitationDataJson),hasValue2(f.isCast)&&(g.isCast=f.isCast),hasValue2(f.isHuddleGroupCall)&&(g.isHuddleGroupCall=f.isHuddleGroupCall),hasValue2(f.label)&&(g.label=f.label),hasValue2(f.maxVideoChannels)&&(g.maxVideoChannels=f.maxVideoChannels),hasValue2(f.mediaConfiguration)&&(g.mediaConfiguration=f.mediaConfiguration),hasValue2(f.muteFlags)&&(g.muteFlags=f.muteFlags),hasValue2(f.muted)&&(g.muted=f.muted),hasValue2(f.negotiationTag)&&(g.negotiationTag=f.negotiationTag),hasValue2(f.preheatFlags)&&(g.preheatFlags=f.preheatFlags),hasValue2(f.ringOthers)&&(g.ringOthers=f.ringOthers),hasValue2(f.routingFlags)&&(g.routingFlags=f.routingFlags),hasValue2(f.scenario)&&(g.scenario=f.scenario),hasValue2(f.screenshareDirection)&&(g.screenshareDirection=f.screenshareDirection),hasValue2(f.sendMediaModalities)&&(g.sendMediaModalities=f.sendMediaModalities),hasValue2(f.sharedLineCallInvitationContentJson)&&(g.sharedLineCallInvitationContentJson=f.sharedLineCallInvitationContentJson),hasValue2(f.targetApplicationType)&&(g.targetApplicationType=f.targetApplicationType),hasValue2(f.clientEndpointDebugContent)&&(g.clientEndpointDebugContentSize=f.clientEndpointDebugContent.length),hasValue2(f.alternateId)&&(g.alternateId=scrubMriOrOmit(f.alternateId)),hasValue2(f.callKey)&&(g.callKeySize=f.callKey.length),hasValue2(f.encryptedKey)&&(g.encryptedKeySize=f.encryptedKey.length),m.callStartOptions=g}return m}function getAgentMediaType(g){switch(g){case 0:return"Audio";case 1:return"Video";case 2:return"ScreenShare"}throw new Error("MediaType required")}function getSkypeMediaType(g){switch(g){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2}throw new Error("MediaType required")}var Sr=class{constructor(){this.stateInt=0,this.promiseInt=new Promise(((g,m)=>{this.resolveInt=g,this.rejectInt=m}))}get state(){return this.stateInt}get resolve(){return g=>{this.stateInt=2,this.resolveInt(g)}}get reject(){return g=>{this.stateInt=1,this.rejectInt(g)}}get promise(){return this.promiseInt}get isPending(){return 0===this.stateInt}},vr=class{constructor(g){this.mcpConfig=g,this.data={sourceRequestsSignaling:{},sourceRequestsMCP:{},fallback:!1,sourceRequestsResponses:{},errors:[]}}setRecord(g,m,f){const S={sequenceNumber:m,timestamp:Date.now(),sourceId:f?.sourceId,fmtp:f?.fmtParams};g.records??(g.records=[]),arrayLimitedPush(g.records,S,this.mcpConfig.storedSRRecordsCount)}recordSignalingOperation(g,m){var f;(f=this.data.sourceRequestsSignaling)[g]??(f[g]={counter:0}),this.data.sourceRequestsSignaling[g].counter++,this.mcpConfig.verboseTelemetry&&this.mcpConfig.sendDuplicates&&"ApplyChannelParametersSourceRequest"===g&&this.setRecord(this.data.sourceRequestsSignaling[g],m)}recordMCPOperation(g,m,f){var S;(S=this.data.sourceRequestsMCP)[g]??(S[g]={counter:0}),this.data.sourceRequestsMCP[g].counter++,this.mcpConfig.verboseTelemetry&&this.setRecord(this.data.sourceRequestsMCP[g],m,f)}recordError(g,m){const f=[Date.now(),m,g];arrayLimitedPush(this.data.errors,f,this.mcpConfig.storedSRRecordsCount)}recordFallback(){this.data.fallback=!0}recordSignalingOperationDuration(g,m){const f=this.data.sourceRequestsSignaling[g]?.records?.find((g=>g.sequenceNumber===m));f&&(f.duration=Date.now()-f.timestamp)}recordSrResultReceived(g,m,f){var S;if(this.mcpConfig.verboseTelemetry){const S=this.data.sourceRequestsMCP[f]?.records?.find((g=>g.sequenceNumber===m));S&&(S.duration=Date.now()-S.timestamp,S.result=g)}(S=this.data.sourceRequestsResponses)[g]??(S[g]=0),this.data.sourceRequestsResponses[g]++}getObjectRef(){return this.data}},yr=5,Cr=class{constructor(g){this.mcpConfig=g,this.storage={createTime:Date.now(),startedCount:0,stoppedCount:0,clientCapabilities:[],events:[]},this.sourceRequestSenderDiagnostics=new vr(this.mcpConfig)}get getSourceRequestSenderDiagnostics(){return this.sourceRequestSenderDiagnostics}logStarted(){if(this.storage.startedCount++,this.storage.startedCount>yr)return;const g={startedTs:duration(this.storage.createTime),mpCapabilities:{},sentMessages:{},recvMessages:{},sentFailed:0,recvFailed:0,cachedDshReceived:!1};this.storage.events.push(g),this.lastEventConnecting=!0}logStopped(){this.storage.stoppedCount++;const g=this.getCurrentDCSessionEvent();g&&(g.stoppedTs=duration(this.storage.createTime)),this.lastEventConnecting=!1}logSentMsg(g){var m,f;const S=this.getCurrentDCSessionEvent();S&&((m=S.sentMessages)[f=g.type]??(m[f]=0),S.sentMessages[g.type]++)}logReceivedMsg(g){var m,f;this.lastEventConnecting=!1;const S=this.getCurrentDCSessionEvent();S&&((m=S.recvMessages)[f=g.type]??(m[f]=0),S.recvMessages[g.type]++,"dsh"!==g.type||S.handshakeDuration||(S.cachedDshReceived=!0))}logHandshakeStarted(g){const m=this.getCurrentDCSessionEvent();m&&(m.handshakeStartedTs=Date.now()),this.storage.clientCapabilities=g}logHandshakeCompleted(g){const m=this.getCurrentDCSessionEvent();m&&(m.handshakeDuration||(m.handshakeDuration=duration(m.handshakeStartedTs)),m.mpCapabilities.send=g.send_capabilities,m.mpCapabilities.recv=g.receive_capabilities)}logSentFailed(g){const m=this.getCurrentDCSessionEvent();m&&(m.sentFailed++,m.lastSentFailed={ts:duration(this.storage.createTime),error:g})}logRecvFailed(g){const m=this.getCurrentDCSessionEvent();m&&(m.recvFailed++,m.lastRecvFailed={ts:duration(this.storage.createTime),error:g})}logTimeout(){if(this.storage.startedCount>=yr&&!this.lastEventConnecting)return;const g={timeoutTs:Date.now()},m=this.getCurrentDCSessionEvent();m&&(g.handshakeStartedTs=m.handshakeStartedTs),this.lastEventConnecting&&this.storage.events.pop(),this.storage.events.push(g),this.lastEventConnecting=!1}getReport(){const g=this.sourceRequestSenderDiagnostics.getObjectRef();return this.storage.sourceRequestsReport=g,this.storage}getCurrentDCSessionEvent(){const g=this.storage.events[this.storage.events.length-1];return this.storage.startedCount<=yr&&void 0!==g?.startedTs?g:null}};function duration(g){return Date.now()-g}var _r=4294967292,Er=class extends Ve{constructor(g,m,f){super(),this.dcAdapter=g,this.logger=m,this.mcpConfig=f,this.dcSend=null,this.handshakePromise=new Sr,this.isStarted=!1,this.isActive=!1,this.handshakeTimeout=null,this.telemetryLogger=new Cr(this.mcpConfig),this.mcpSupportedFeautres={sourceRequestsEnabled:!1,sourceRequestsResponseEnabled:!1,sendDuplicates:this.mcpConfig?.sendDuplicates}}getTelemetryLogger(){return this.telemetryLogger}mcpFeaturesSupported(g){return this.mcpSupportedFeautres[g]}switchMcpFeauture(g,m){this.logger.warn(`Switching ${g} to ${m}`),this.mcpSupportedFeautres[g]=m}getConfig(){return this.mcpConfig}dispose(){super.dispose(),this.isStarted&&this.dcAdapter.removeHandler(18),this.handshakePromise.promise.catch((()=>{})),this.handshakePromise.reject("MediaControlPlane disposed"),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1),this.dcSend=null}getTelemetryReport(){return this.logger.debug(`Telemetry ${JSON.stringify(this.telemetryLogger.getReport())}`),this.telemetryLogger.getReport()}async sendMsg(g){return await this.handshakePromise.promise,this.sendMsgInternal(g)}start(){if(this.isStarted||!this.mcpConfig)return;this.isStarted=!0;const g={onStarted:async(g,m)=>{this.logger.info(`Data channel handler is started ${g}`),this.telemetryLogger.logStarted(),this.dcSend=m,await this.startHandshake()},onStopped:async g=>{this.logger.info(`Data channel handler is stopped ${g}`),this.telemetryLogger.logStopped(),this.dcSend=null,this.isActive=!1,this.switchMcpFeauture("sourceRequestsEnabled",!1),this.switchMcpFeauture("sourceRequestsResponseEnabled",!1)},onDataReceived:async(g,m)=>{this.processIncomingData(m)}};this.dcAdapter.addHandler(18,g)}onTransportConnected(){this.isStarted&&this.mcpConfig.handshakeTimeout&&!this.isActive&&(this.handshakeTimeout&&clearTimeout(this.handshakeTimeout),this.handshakeTimeout=window.setTimeout((()=>{this.handshakeTimeout=null,this.telemetryLogger.logTimeout(),this.logger.warn(`Timeout after ${this.mcpConfig.handshakeTimeout}ms, raising onHandshakeTimeout`),this.event("onHandshakeTimeout").raise()}),this.mcpConfig.handshakeTimeout))}async startHandshake(){this.handshakePromise.isPending||(this.handshakePromise=new Sr),this.isActive=!1;try{const g=[];this.mcpConfig.enableDominantSpeakerHistory&&g.push("dsh"),this.mcpConfig.enableBweNotifications&&g.push("bwe"),this.mcpConfig.enableSourceRequests&&g.push("sr"),this.telemetryLogger.logHandshakeStarted(g),this.logger.info(`Send syn, client capabilities: ${JSON.stringify(g)}`),await this.sendMsgInternal({type:"syn",client_capabilities:g})}catch(g){this.handshakePromise.reject(g)}}async sendMsgInternal(g){const m=Array.isArray(g)?g:[g],f=(new TextEncoder).encode(JSON.stringify(m)),S=new Uint8Array(1+f.length);S[0]=1,S.set(f,1);try{await this.dcSend(S,[_r]);for(const g of m)this.telemetryLogger.logSentMsg(g)}catch(g){throw this.logger.error(`Send failed: ${stringifyObject(g)}`),this.telemetryLogger.logSentFailed(stringifyObject(g)),g}}processIncomingData(g){if(1!==g[0]){const m=`Unsupported header version ${g[0]}`;return this.logger.info(m),void this.telemetryLogger.logRecvFailed(m)}const m=new DataView(g.buffer,1);let f;try{const g=(new TextDecoder).decode(m);f=JSON.parse(g)}catch(g){return this.logger.error(`Failed to parse received data, error ${stringifyObject(g)}`),void this.telemetryLogger.logRecvFailed(stringifyObject(g))}for(const g of f)switch(this.telemetryLogger.logReceivedMsg(g),g.type){case"syn":break;case"ack":this.processAckMsg(g);break;case"bwe":this.processBweMsg(g);break;case"dsh":this.processDshMsg(g);break;case"sr_res":this.processSrResMsg(g);break;default:{const m=`Unsupported msg type ${g.type}`;this.logger.error(m),this.telemetryLogger.logRecvFailed(m)}}}processDshMsg(g){this.mcpConfig.enableDominantSpeakerHistory&&(this.logger.debug(`DSH received: ${JSON.stringify(g)}`),this.event("mpDshChanged").raise(g.history))}processSrResMsg(g){this.mcpConfig.enableSourceRequests&&(this.logger.debug(`SR_RES received: ${JSON.stringify(g)}`),this.event("mpSrResReceived").raise(g.sequenceNumber,g.result))}processBweMsg(g){this.mcpConfig.enableBweNotifications&&this.event("mpSendBandwidthChanged").raise(g.bw)}processAckMsg(g){this.telemetryLogger.logHandshakeCompleted(g),this.logger.info(`Ack received: ${JSON.stringify(g)}`);const m=!(!this.mcpConfig.enableDominantSpeakerHistory||!g.send_capabilities?.includes("dsh"));this.switchMcpFeauture("sourceRequestsEnabled",!(!this.mcpConfig.enableSourceRequests||!g.receive_capabilities?.includes("sr"))),this.switchMcpFeauture("sourceRequestsResponseEnabled",!(!this.mcpConfig.enableSourceRequests||!g.send_capabilities?.includes("sr_res"))),this.logger.info(`raising mpDshStatusChanged ${m}`),this.event("mpDshStatusChanged").raise(m),this.handshakePromise.resolve(),clearTimeout(this.handshakeTimeout),this.handshakeTimeout=null,this.isActive=!0}},Tr={NEGOTIATION_COMPLETED:"NegotiationCompleted",INITIAL:{OFFER_GENERATION_STARTED:"InitialOfferGenerationStarted",OFFER_GENERATION_ENDED:"InitialOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"InitialAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"InitialAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"InitialOfferProcessingStarted",OFFER_PROCESSING_ENDED:"InitialOfferProcessingEnded",ANSWER_GENERATION_STARTED:"InitialAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"InitialAnswerGenerationEnded"},RENEGOTIATION:{OFFER_GENERATION_STARTED:"RenegotiationOfferGenerationStarted",OFFER_GENERATION_ENDED:"RenegotiationOfferGenerationEnded",ANSWER_PROCESSING_STARTED:"RenegotiationAnswerProcessingStarted",ANSWER_PROCESSING_ENDED:"RenegotiationAnswerProcessingEnded",OFFER_PROCESSING_STARTED:"RenegotiationOfferProcessingStarted",OFFER_PROCESSING_ENDED:"RenegotiationOfferProcessingEnded",ANSWER_GENERATION_STARTED:"RenegotiationAnswerGenerationStarted",ANSWER_GENERATION_ENDED:"RenegotiationAnswerGenerationEnded"}},Ir=class{constructor(g,m,f){this.mediaSession=g,this.signalingSession=m,this.sourceRequestSender=f,this.operationNames=Tr.INITIAL,this.configureModalitiesAsync=this.mediaSession.configureModalitiesAsync.bind(this.mediaSession),this.getAllowedModalities=this.mediaSession.getAllowedModalities.bind(this.mediaSession),this.rejectNegotiationAsync=this.mediaSession.rejectNegotiationAsync.bind(this.mediaSession),this.createRemoteRenderer=this.mediaSession.createRemoteRenderer.bind(this.mediaSession),this.getStatsAsync=this.mediaSession.getStatsAsync.bind(this.mediaSession),this.getLastKnownStats=this.mediaSession.getLastKnownStats.bind(this.mediaSession),this.getCallTechnicalInfo=this.mediaSession.getCallTechnicalInfo.bind(this.mediaSession),this.muteHold=this.mediaSession.muteHold.bind(this.mediaSession),this.muteInputAsync=this.mediaSession.muteInputAsync.bind(this.mediaSession),this.unmuteInputAsync=this.mediaSession.unmuteInputAsync.bind(this.mediaSession),this.muteOutputAsync=this.mediaSession.muteOutputAsync.bind(this.mediaSession),this.unmuteOutputAsync=this.mediaSession.unmuteOutputAsync.bind(this.mediaSession),this.terminate=this.mediaSession.terminate.bind(this.mediaSession),this.createAudioElement=this.mediaSession.createAudioElement.bind(this.mediaSession),this.getSessionConfig=this.mediaSession.getSessionConfig.bind(this.mediaSession),this.getDiagnostics=this.mediaSession.getDiagnostics.bind(this.mediaSession),this.getIncomingRawAudioStream=this.mediaSession.getIncomingRawAudioStream.bind(this.mediaSession),this.getUnmixedAudioProvider=this.mediaSession.getUnmixedAudioProvider.bind(this.mediaSession),this.useNullAudioStreamClient=this.mediaSession.useNullAudioStreamClient.bind(this.mediaSession),this.getSubscriptionManager=this.mediaSession.getSubscriptionManager.bind(this.mediaSession),this.configureSpatialAudio=this.mediaSession.configureSpatialAudio.bind(this.mediaSession),this.setParticipantSpatialAudioPositions=this.mediaSession.setParticipantSpatialAudioPositions.bind(this.mediaSession),this.setCallConstraints=this.mediaSession.setCallConstraints.bind(this.mediaSession),this.startMediaDescriptionsUpdateAsync=this.mediaSession.startMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.completeMediaDescriptionsUpdateAsync=this.mediaSession.completeMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.rejectMediaDescriptionsUpdateAsync=this.mediaSession.rejectMediaDescriptionsUpdateAsync.bind(this.mediaSession),this.getExtensionsManager()?.configureExtension("videoStreamControl",{sender:this.sourceRequestSender})}enableTeamsRealTimeTelemetry(){this.mediaSession.enableTeamsRealTimeTelemetry()}getMediaStatsReport(){return this.mediaSession.getMediaStatsReport()}processOfferAsync(g,m){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_STARTED),this.mediaSession.processOfferAsync(g,m).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_PROCESSING_ENDED),g)))}createAnswerAsync(g,m){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_STARTED),this.mediaSession.createAnswerAsync(g,m).then((m=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_GENERATION_ENDED),g||(this.operationNames=Tr.RENEGOTIATION),m)))}createOfferAsync(g){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_STARTED),this.mediaSession.createOfferAsync(g).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.OFFER_GENERATION_ENDED),g)))}processAnswerAsync(g,m,f,S=!1){return this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_STARTED),this.mediaSession.processAnswerAsync(g,m,f,S).then((()=>{this.signalingSession.setOfferAnswerGenerationTimestamps(this.operationNames.ANSWER_PROCESSING_ENDED),this.operationNames=Tr.RENEGOTIATION}))}completeNegotiationAsync(g){return this.mediaSession.completeNegotiationAsync(g).then((g=>(this.signalingSession.setOfferAnswerGenerationTimestamps(Tr.NEGOTIATION_COMPLETED),g)))}sendDtmf(g){return this.mediaSession.sendDtmf?this.mediaSession.sendDtmf(g):Promise.reject("Not Implemented")}getExtensionsManager(){return this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null}reconnectAsync(g,m=!1){return this.mediaSession.reconnectAsync(g,m)}completeEscalationAsync(g){return this.mediaSession.completeEscalationAsync(g)}rejectEscalationAsync(g,m){return this.mediaSession.rejectEscalationAsync(g,m)}getAcceptedTypes(){return this.mediaSession.getAcceptedTypes()}getLocalMediaTrackId(g){return this.mediaSession.getLocalMediaTrackId?this.mediaSession.getLocalMediaTrackId(g):null}processNotification(g,m){this.mediaSession.processNotification(g,m)}};function handleServerMutedVersion(g,m,f){if(void 0===m?.serverMuteVersion||void 0===f?.serverMuteVersion||f.serverMuteVersion>=m.serverMuteVersion)return;const S=f&&f.mediaStreams,v=S&&S.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type)),C=m&&m.mediaStreams,_=C&&C.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type));v&&v.length&&(f.serverMuteVersion=m.serverMuteVersion,v[0].serverMuted=_[0].serverMuted,g.info(`handleServerMutedVersion: patching server muted state in audio streams updated:${JSON.stringify(v[0])} as we encountered stale muteServerVersion. Updated to ${m.serverMuteVersion}`))}function handleMuteUnmuteParticipantInfo(g,m,f,S){if("success"!==f.reason||void 0===m||f.serverMuteVersion<=m.serverMuteVersion)return g.info(`handleMuteUnmuteParticipantInfo: ignoring updating since we encountered invalid state: ${f.reason} serverMuteVersion: ${f.serverMuteVersion}`),!1;const v=m&&m.mediaStreams,C=v&&v.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type));return!!C&&(C[0].serverMuted=S,m.serverMuteVersion=f.serverMuteVersion,g.info(`handleMuteUnmuteParticipantInfo: updating since we encountered valid state serverMuteVersion: ${f.serverMuteVersion} to: ${S} streams: ${C[0].sourceId}`),!0)}var br=P;function scrub(g,m,f,S){const v=JSON.stringify(g),C=JSON.parse(v);return C&&(scrubOneTypeOfParams(g,C,m,br.pii.Omit),scrubOneTypeOfParams(g,C,f,br.pii.Mri),scrubOneTypeOfParams(g,C,S,br.pii.UserName)),JSON.stringify(C)}function scrubOneTypeOfParams(g,m,f,S){f?.forEach((f=>{g[f]&&(m[f]=S(g[f]))}))}function scrubSignalingParticipant(g){return`id=${br.pii.Mri(g.id)}, participantId=${g.participantId}`}function scrubITransferContext(g){return scrub(g,[],["transferorMri","targetMri"])}var Ar=R,Pr=f.setImmediate?g=>{f.setImmediate(g)}:g=>{(0,Ar.defer)(g)},Rr=class _DeferHandler{constructor(){this.deferredOperations=new Map,this.deferredOperationsNames=[],this.isRunning=!1}setLogger(g){this._logger=g.createChild("[DeferHandler]")}setDeferToQueueMicrotask(g){g&&f.queueMicrotask?_DeferHandler.defer=g=>f.queueMicrotask(g):_DeferHandler.defer=Pr}createDeferRunner(g){const m={};return f=>this.runDeferred(m,f,g)}runDeferredWithoutDedup(g,m){const f={};this.runDeferred(f,g,m)}runDeferred(g,m,f){this.deferredOperations.has(g)||(this.deferredOperations.set(g,m),f&&this.deferredOperationsNames.push(" "+f),this.isRunning||(this.isRunning=!0,this._startDeferalTime=Date.now(),this.causeId=generateCauseId(),this._logger?.info(`[${this.causeId}]Deferring operations`),_DeferHandler.defer((()=>{this._timeToRun=Date.now()-this._startDeferalTime,this.deferredOperations.forEach((g=>{_DeferHandler.runWithTryCatch(g)})),this.deferredOperations.clear(),this.isRunning=!1,this._logger?.info(`[${this.causeId}]Deferred operations ran after ${this._timeToRun}ms | Completed after ${Date.now()-this._startDeferalTime}ms | Operations:${this.deferredOperationsNames}`),this.deferredOperationsNames=[]}))))}static runWithTryCatch(g){try{g&&g()}catch(g){}}};Rr.defer=Pr;var wr=Rr,Mr=class{};Mr.instance=new wr;var Dr=R,Or={send:"sendonly",receive:"recvonly",sendReceive:"sendrecv"},Nr={audio:"audio",video:"video",sharing:"applicationsharing-video",audioteleconference:"audio-teleconferencing"},kr=class extends Ve{constructor(g,m,f){super(m),this.mediaSession=g,this.isAvailable=!1,this.mediaSessionInitPromise=new Sr,this.currentIsStreaming=!1,g&&this.mediaSessionInitPromise.resolve(),this.id=f,this.logger=m.createChild(`Stream[${this.id}]`)}set isStreaming(g){this.currentIsStreaming=g,this.logger.info(`isStreaming has changed to ${this.currentIsStreaming}`),this.raiseChanged()}get isStreaming(){return this.currentIsStreaming}update({sourceId:g=null,direction:m=Or.receive,participantId:f=null,endpointId:S=null}={},v){this.logger.info(`[${v}][update before]  sourceId=${g}, direction=${m}, participantId=${f}, endpointId=${truncate(S)}`),this.id=g,this.isAvailable=m===Or.sendReceive||m===Or.send,this.mediaSession?.getSessionConfig().config.streamAvailabilityConsiderModalities&&this.getIsModalityDisabled()&&(this.logger.info(`Disabling current modality, disabled: ${JSON.stringify(this.mediaSession?.getDisabledModalities?.()||"")}`),this.isAvailable=!1),this.participantId=f,this.endpointId=S,this.logger.info(`[${v}][update after]  sourceId=${g}, direction=${m}, participantId=${f}, endpointId=${truncate(S)}`),this.raiseChanged()}setMediaSession(g,m){const f=g?.getAllowedModalities?.()||{};this.logger.info(`[${m}][setMediaSession] ${JSON.stringify(f)}`),this.mediaSession=g,g?this.mediaSessionInitPromise.resolve():this.mediaSessionInitPromise.reject(new Error("MediaSession is null"))}isActive(){return this.isAvailable&&this.isStreaming}getIsModalityDisabled(){return!1}},Lr=class extends kr{},Fr=R,xr=class extends kr{constructor(g,m,f,S,v,C){super(void 0,g,m),this.configProvider=f,this.streamOptions=S,this.telemetryLogger=v,this.callInfo=C,this.type=2,this.finalTelemetrySent=!1,this.initializeStatistics(),this.player=new Mt(this.logger.createChild("UmsLiveStreamPlayer"),this.liveStreamStatistic,this.configProvider,(g=>this.sendTelemetry(g)),(()=>this.sendSnapshotTelemetry())),this.liveStreamStatisticMetadata={configIds:this.configProvider.configIds,threadId:this.streamOptions.threadId,playerId:this.player.playerId},this.isAvailable=!0}get tracks(){return this.player.tracks}getStreamOptions(){return this.streamOptions}initializeStatistics(){const g={currentPlayPosition:[],playbackRate:[],statsInterval:[],videoBufferLength:[],videoCachedLength:[],videoEdgeLatency:[],playerHeight:[],playerWidth:[],mediaHeight:[],mediaWidth:[],windowHeight:[],windowWidth:[]};this.liveStreamStatistic=new st(this.configProvider.config,this.logger.createChild("UmsLiveStreamStatistic"),g)}selectVideoTrack(g){return this.player.selectVideoTrack(g)}setVideoStreamConfig(g){throw new Error("Method not implemented.")}getDiagnosticData(){return JSON.stringify({id:this.id,type:this.type,rank:this.rank,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const g=this.liveStreamStatistic.getSnapshotReport({isFinal:!1,...this.liveStreamStatisticMetadata}),m={isAvailable:this.isAvailable,isStreaming:this.isStreaming,...g};return(0,Fr.isEqual)(this.lastStreamStats,m)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=m),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,rank:this.rank,...this.lastStreamStats}}stop(){return Promise.resolve(void 0)}async start(g){if(this.logger.info("[start]: Starting UMS stream"),!this.renderer){await this.player.configure(this.streamOptions);if(!(await this.player.loadPlayer(g)).setupSucceeded)return this.player.stop(),this.logger.error("[start]: Failed to load UMS player"),Promise.reject("Failed to load UMS player");this.renderer=this.player.getRenderer()}return this.isStreaming=!0,this.renderer}sendSnapshotTelemetry(){const g=this.liveStreamStatistic.getSnapshotReport({isFinal:!1,...this.liveStreamStatisticMetadata});this.logger.debug(`[sendSnapshotTelemetry] sending snapshot telemetry report: ${JSON.stringify(g)}`);const m={...this.callInfo,...g};this.telemetryLogger.sendEvent({eventName:"live_events",props:m})}sendTelemetry(g){if(this.finalTelemetrySent)return;g&&(this.finalTelemetrySent=!0);const m=this.liveStreamStatistic.getReport({isFinal:g,...this.liveStreamStatisticMetadata});this.logger.debug(`[sendTelemetry] sending telemetry report: ${JSON.stringify(m)}`);const f={...this.callInfo,...m,threadId:this.streamOptions.threadId};this.telemetryLogger.sendEvent({eventName:"live_events",props:f})}};function toMediaAgentScalingMode(g){switch(g){case 1:return"crop";case 0:return"stretch";default:return"fit"}}var Ur=class extends Ve{constructor(){super(...arguments),this.isRendering=!1,this.frameType=-1}get rendererType(){return 0}captureFrame(){if(this.renderer.captureFrame)return this.renderer.captureFrame();throw new Error("Not implemented yet")}async getStats(){if(this.renderer.getStats)return this.renderer.getStats();throw new Error("Renderer does not support stats")}async setScalingMode(g){this.renderer.setScalingMode(toMediaAgentScalingMode(g))}async dumpVideoSourceImages(){throw new Error("Not implemented")}async cameraAutoControl(g){throw new Error("Not implemented")}async getCameraManualControlStates(g){throw new Error("Not implemented")}async setCameraManualControlStates(g){throw new Error("Not implemented")}async enumerateCameraManualControls(){throw new Error("Not implemented")}onVideoSizeChanged(g,m){this.streamSize={width:g,height:m},this.event("videoSizeChanged").raise(g,m),this.raiseChanged()}},Vr=class extends Ur{constructor(g,m){super(),this.renderer=m.createPreviewRenderer(g),this.renderer.on("onVideoSizeChanged",((g,m)=>this.onVideoSizeChanged(g,m)))}onVideoSizeChanged(g,m){this.isRendering=g>0&&m>0,super.onVideoSizeChanged(g,m)}setVideoMirroring(g){this.renderer.setVideoMirroring(g)}startVideoAsync(){return this.renderer.startVideoAsync()}dispose(){this.renderer&&(this.renderer.dispose(),this.renderer=null)}},Br=class extends Ur{constructor(g,m,f,S,v){super(),this.logger=g,this.target=m,this.rendererStats=S,this.configProvider=v,this.subscriptionActive=!1,this.firstFrameRendered=!1,this.rendererId=S.newRendererId(),this.renderer=f.createRemoteRenderer(m),this.renderer.on("onVideoSizeChanged",((g,m)=>this.onVideoSizeChanged(g,m))),this.renderer.on("onVideoStateChanged",(g=>this.onVideoStateChanged(g))),this.renderer.on("onIsRenderingChanged",(g=>this.onIsRenderingChanged(g)))}toString(){return`rvr:${this.rendererId}`}onVideoStateChanged(g){this.rendererStats.streamStateChanged(g.stream)}onVideoSizeChanged(g,m){this.configProvider.config.videoIsRenderingCheck&&this.setIsRendering(g>0&&m>0),super.onVideoSizeChanged(g,m)}setIsRendering(g){this.isRendering!==g&&(this.isRendering=g,this.logger.info(`isRendering has changed to ${this.isRendering}`),this.rendererStats.event(this.isRendering?5:6,this.rendererId),this.isRendering&&!this.firstFrameRendered&&(this.firstFrameRendered=!0,this.event("firstFrameRendered").raise()))}onIsRenderingChanged(g){this.setIsRendering(g),this.raiseChanged()}subscribeVideoAsync(g){this.currentVideoStream=g,this.rendererStats.event(1,this.rendererId,g.id);const m=this.renderer.subscribeVideoAsync(g.id,1===g.type);return this.subscriptionActive=!0,m.then((()=>{this.rendererStats.event(2,this.rendererId,g.id),this.watchStream(g)})),m}watchStream(g){this.changeSub&&this.changeSub.dispose(),this.changeSub=g.changed((()=>{g.isAvailable?this.subscriptionActive||this.subscribeVideoAsync(g):(this.subscriptionActive=!1,this.rendererStats.event(3,this.rendererId),this.renderer.unsubscribeNow(),this.rendererStats.event(4,this.rendererId))}))}dispose(){this.renderer&&(this.subscriptionActive&&(this.rendererStats.event(3,this.rendererId),this.currentVideoStream&&!this.currentVideoStream.isAvailable&&this.renderer.unsubscribeNow()),this.renderer.dispose(),this.subscriptionActive&&this.rendererStats.event(4,this.rendererId),this.renderer=null,this.currentVideoStream=null),this.changeSub&&(this.changeSub.dispose(),this.changeSub=null)}},Hr=class extends Ve{constructor(g,m,f,S=generateCauseId()){super(f),this.getRawStream=g,this.disposeStream=m,this.logger=f,this.causeId=S,this.isClientDisposed=!1,this.clientId=uniqueId()}get isDisposed(){return this.isClientDisposed}notifyStreamChange(){this.logger.info(`Raw stream changed, causeId=${this.causeId}`),this.raiseChanged(),this.event("notifiedOnStreamChanged").raise(this.clientId)}async getMediaStream(){return this.checkDisposed(),this.logger.info(`Raw stream requested, causeId=${this.causeId}`),this.event("rawStreamRequested").raise(this.clientId),this.getRawStream()}dispose(){this.checkDisposed(),this.disposeStream?.(),this.isClientDisposed=!0,this.event("clientDisposed").raise(this.clientId),super.dispose(),this.logger.info(`Raw stream client disposed, causeId=${this.causeId}`)}checkDisposed(){if(this.isClientDisposed)throw new Error("Raw stream client is already disposed")}},$r=class{constructor(g,m,f){this.stream=g,this.rawBaseClient=new Hr((async()=>this.stream),(()=>this.dispose()),m,f)}client(){return this.rawBaseClient}updateAndNotifyClient(g){this.rawBaseClient&&(this.stream=g,this.rawBaseClient.notifyStreamChange())}dispose(){this.rawBaseClient=null,this.stream=null}},Gr=class{constructor(g,m,f,S){this.videoStream=g,this.subscriptionManager=m,this.logger=f,this.causeId=S,this.modality=0===g.type?je.MODALITY.video:je.MODALITY.sharing,this.subscriptionClient=m.subscribeVideo(this.modality,g.mediaSourceId),this.rawBaseClient=new Hr((async()=>this.subscriptionClient?.subscribedStream),(()=>this.unsubscribeVideo()),f,S),this.setClientSubscription(),this.videoStream.changed((()=>{this.rawBaseClient?.isDisposed||(g.isAvailable?this.updateSubscription():this.unsubscribeVideo())}))}client(){return this.rawBaseClient}updateSubscription(){this.rawBaseClient?.isDisposed?this.logger.error(`updateSubscription skipped, raw stream client disposed: stream already exists, causeId=${this.causeId}`):(this.logger.info(`update subcription: Created new subscription, causeId=${this.causeId}`),this.subscriptionClient=this.subscriptionManager.subscribeVideo(this.modality,this.videoStream.mediaSourceId),this.setClientSubscription())}unsubscribeVideo(){this.logger.info(`Disposing subcription, causeId=${this.causeId}`),this.subscriptionClient?.dispose(),this.subscriptionClient=null}setClientSubscription(){this.logger.info(`setting onMediaStreamChanged callback, causeId=${this.causeId}`),this.subscriptionClient.setOnMediaStreamChangedHandler((()=>this.rawBaseClient?.notifyStreamChange()))}},jr=class{constructor(){this.handlerMap=new Map}dispose(){this.handlerMap.forEach((g=>g.client().dispose())),this.handlerMap.clear()}handlerAdded(g){const m=g.client();m.on("clientDisposed",(()=>this.deleteRawStreamManagerById(m.clientId))),this.handlerMap.set(m.clientId,g)}deleteRawStreamManagerById(g){this.handlerMap.delete(g)}},Wr=class extends jr{constructor(g){super(),this.logger=g}streamChanged(g){this.handlerMap.forEach((m=>m.updateAndNotifyClient(g)))}createIRawStreamClient(g){const m=new $r(g,this.logger);super.handlerAdded(m);return m.client()}},qr=class extends jr{constructor(g){super(),this.logger=g}createIRawStreamClient(g,m){const f=new Gr(g,m,this.logger);super.handlerAdded(f);return f.client()}},zr=R,Kr=class extends kr{constructor(g,m,f,S){super(g,f,S),this.rendererStats=m,this.rawIncomingVideoStreamManager=new qr(this.logger.createChild("rawVideoStream")),this.type=0}get mediaSourceId(){return this.id}getDiagnosticData(){return JSON.stringify({id:this.id,msi:this.mediaSourceId,rank:this.rank,type:this.type,isAvailable:this.isAvailable,isStreaming:this.isStreaming})}getStats(){const g={isAvailable:this.isAvailable,isStreaming:this.isStreaming};return(0,zr.isEqual)(this.lastStreamStats,g)||(this.streamStatsUpdatedTimestamp=Date.now(),this.lastStreamStats=g),{id:this.id,type:this.type,timestampUpdated:this.streamStatsUpdatedTimestamp,msi:this.mediaSourceId,rank:this.rank,...this.lastStreamStats}}stop(){return this.mediaSessionInitPromise.reject(new Error("Video stream stopped")),Promise.resolve(void 0)}getRawStream(g){return this.rawIncomingVideoStreamManager.createIRawStreamClient(this,this.mediaSession.getSubscriptionManager())}start(g,m){return this.logger.info(`video start: target=${g}, options=${JSON.stringify(m)}`),this.mediaSessionInitPromise.promise.then((()=>new Br(this.logger.createChild("RemoteVideoRenderer"),g,this.mediaSession,this.rendererStats,this.mediaSession?.getSessionConfig()))).then((g=>(m&&g.setScalingMode(m.scalingMode),this.logger.info(`subscribeVideoAsync: videoRenderer=${g}, id=${this.id}`),g.subscribeVideoAsync(this).catch((m=>{throw g.dispose(),m})).then((()=>(this.isStreaming=!0,g))))))}update(g,m){this.logger.info(`[${m}][update] stream=${JSON.stringify(g)}`);const f=this.isAvailable;super.update(g,m),this.isAvailable&&this.isAvailable!==f&&this.rendererStats.event(0)}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().video}},Jr=class extends Kr{constructor(g,m,f,S){super(g,m,f,S),this.type=1}getIsModalityDisabled(){return!!this.mediaSession?.getDisabledModalities?.().sharing}},Yr=1,Qr=2,Xr=3,Zr=class _PluginlessCallStreamManager extends Ve{constructor(g,m,f,S){super(),this.participantId=g,this.mediaSession=m,this.localStats=f,this.audioSourceIds=[],this.streams={},this.lastUmsStreamId=1;const v=f.receive(1,g),C=f.receive(2,g);this.audio=new Lr(m,S,Yr);const _=new Kr(m,v,S,Qr),E=new Jr(m,C,S,Xr),T=this.mediaSession?.getSessionConfig()?.config.participantStreamInitialSubscriptions;T&&(_.changed((()=>this.event("streamChanged").raise())),E.changed((()=>this.event("streamChanged").raise()))),this.streams[0]=[_],this.streams[1]=[E],this.streams[2]=[],this.logger=S.createChild("PluginlessCallStreamManager")}setMediaSession(g,m){this.logger.info(`[${m}][setMediaSession]`),this.mediaSession=g;[[this.audio],this.streams[0],this.streams[1]].forEach((f=>f.forEach((f=>f.setMediaSession(g,m)))))}updateStreams(g,m){this.logger.info(`[${m}][updateStreams]`);const filterAndSortStreams=m=>g.filter((g=>g.type===m)).sort(_PluginlessCallStreamManager.compareStreams);let f=filterAndSortStreams(Nr.audio);0===f.length&&(f=filterAndSortStreams(Nr.audioteleconference)),f.length>0&&(this.audioSourceIds=f.map((g=>g.sourceId)));const S=f[0];S&&this.audio.update(S,m),this.updateMediaStreams(filterAndSortStreams(Nr.video),0,m),this.updateMediaStreams(filterAndSortStreams(Nr.sharing),1,m)}hasAudioSource(g){return this.audioSourceIds.some((m=>m===g))||this.audio.id===g}useUmsStream(g,m,f,S,v,C){this.logger.info(`[${C}][useUmsStream] Updating ums streams`);const _=this.getUmsInformation(g,S),E=this.streams[2],T=E.filter((g=>!_.some((m=>_PluginlessCallStreamManager.compareUmsStreams(g,m)))));T.forEach((g=>(0,Dr.remove)(E,g))),T.length&&this.logger.info(`[${C}][useUmsStream] Removing ${T.length} ums streams`),_.forEach((g=>{let S=E.find((m=>_PluginlessCallStreamManager.compareUmsStreams(m,g)));S||(S=new xr(this.logger.createChild("UmsStream"),this.lastUmsStreamId++,m,g,v,f),this.logger.info(`[${C}][useUmsStream] Adding ums stream with metadata: ${JSON.stringify(g)}`),E.push(S))}))}getUmsStreamMetadata(g,m){let f=null,S=null;if(f=g.find((function(g){return"MiddleLaneUltraLowLatency"===g.deliveryPipelineType&&m===g.isPrimary})),f){const g=f.urls;if(g&&g.length>0){f.identifier||this.logger.warn(`[getUmsStreamInformation]: no ums stream identifier found, isPrimary: ${m}`);const v=f.decryptionKey?.id,C=f.decryptionKey?.value;v&&C||this.logger.warn(`[getUmsStreamInformation]: no valid ums stream decryption key found, isPrimary: ${m}`);const _=f.deliveryPipelineType||void 0;S={url:g[0],streamDeliveryPipeline:_,decryptionKey:v&&C?{id:v,value:C}:null}}else this.logger.info(`[getUmsStreamInformation]: no ums URLs found, isPrimary: ${m}`)}else this.logger.info(`[getUmsStreamInformation]: no ums stream information found, isPrimary: ${m}`);return S}getUmsInformation(g,m){const f=[];let S=null,v=null;for(const m in g){const f=g[m].streams;if(f){if(S)this.logger.info(`[getUmsInformation]: primary ums stream already found, skipping finding primary stream for participant: ${m}`);else{const g=this.getUmsStreamMetadata(f,!0);g?S=g:this.logger.info(`[getUmsInformation]: no primary ums stream found for participant: ${m}`)}if(v)this.logger.info(`[getUmsInformation]: alternate ums stream already found, skipping finding alternate stream for participant: ${m}`);else{const g=this.getUmsStreamMetadata(f,!1);g?v=g:this.logger.info(`[getUmsInformation]: no alternate ums stream found for participant: ${m}`)}}else this.logger.warn(`[getUmsInformation]: no stream information found for participant: ${m}`)}return(S||v)&&f.push({stream:S,altStream:v,threadId:m}),f}static compareStreams(g,m){const f="sendonly"===g.direction||"sendrecv"===g.direction,S="sendonly"===m.direction||"sendrecv"===m.direction;return f&&!S?-1:S&&!f?1:m.sourceId-g.sourceId}static compareUmsStreams(g,m){const f=g.getStreamOptions();return _PluginlessCallStreamManager.compareUmsStreamMetadata(f.stream,m.stream)&&_PluginlessCallStreamManager.compareUmsStreamMetadata(f.altStream,m.altStream)}static compareUmsStreamMetadata(g,m){return!g&&!m||!(!g&&m||g&&!m)&&(g.decryptionKey.id===m.decryptionKey.id&&g.decryptionKey.value===m.decryptionKey.value&&g.url===m.url)}updateMediaStreams(g,m,f){const S=this.streams[m],v=S.filter((m=>!g.some((g=>g.sourceId===m.id))));v.forEach((g=>(0,Dr.remove)(S,g))),v.length&&this.logger.info(`[${f}][updateMediaStreams] Removing ${v.length} streams of type ${m}`),g.forEach(((v,C)=>{let _=S.find((g=>g.id===v.sourceId));_||(0===m?_=new Kr(this.mediaSession,this.localStats.receive(1,this.participantId),this.logger,v.sourceId):1===m&&(_=new Jr(this.mediaSession,this.localStats.receive(2,this.participantId),this.logger,v.sourceId)),this.logger.info(`[${f}][updateMediaStreams] Adding stream ${v.sourceId} of type ${m}`),S.push(_),_.changed((()=>this.event("streamChanged").raise()))),_.update(v,f),_.rank=g.length-C}))}},es={0:[1],1:[2,6,3,4,5,7,8],2:[6,3,4,8],3:[1,4,5,8],7:[3,4,8],4:[],5:[3,4,8],6:[3,4],8:[3,5,4]},ts={0:"Disconnected",1:"Connecting",2:"Ringing",3:"Connected",5:"Connected",4:"Disconnected",7:"Connecting"},is=class extends Ve{constructor(g,m,f,S,v,C=generateCauseId(),_=[]){super(f),this.mri=g,this.callTelemetry=v,this.cachedMediaStreams=_,this.state=0,this.voiceLevel=0,this.isServerMuted=!1,this.endpointType="default",this.balanceUpdates={},this._raiseChangeDeferRunner=Mr.instance.createDeferRunner("CallParticipant.RaiseChange"),this.filteredParticipantEndpointDetails={},this.recordTelemetryForStateChange=(g,m,f,S)=>{if(S){const S="_SetParticipantStateInvalid",v={state:m,reason:f,endpoints:[]};this.endpoints?.endpointDetails?.length&&(v.endpoints=getEndpointInformationForTelemetry(this.endpoints.endpointDetails)),this.callTelemetry.recordEvent(S,v,g)}},this.checkIfIncomingServerMutedIsUpdated=g=>{g.endpointDetails.forEach((g=>{const m=this.filteredParticipantEndpointDetails[g.participantId];void 0!==m&&handleServerMutedVersion(this.logger,m,g)}))},this.handleServerMutedInfoUpdate=g=>{let m=!1;for(const f of g){const g=this.filteredParticipantEndpointDetails[f.participantId];handleMuteUnmuteParticipantInfo(this.logger,g,f,!0)&&(m=!0)}m&&this.updateIsServerMuted()},this.id=this.mri,this.logger=f.createChild((()=>`ICallParticipant[${scrubMriOrOmit(this.id)}][${this.state}]`)),this.logger.info(`[${C}]created`),this.streamManager=new Zr(this.id,m,S,this.logger),this.streamManager.on("streamChanged",(()=>this.raiseChanged()))}get audio(){return this.streamManager.audio}get streams(){return this.streamManager.streams}getDiagnosticData(){return JSON.stringify({id:scrubMriOrOmit(this.id),state:this.state,isServerMuted:this.isServerMuted})}isSameParticipantsMri(g){return this.id===g}setMediaSession(g,m=generateCauseId()){this.streamManager.setMediaSession(g,m)}applyCachedMediaStreams(g=generateCauseId()){const m=this.logger.createFnLogger("applyCachedMediaStreams",g);this.cachedMediaStreams?.length?(m.info("applying cachedMediaStreams"),this.updateStreams(this.cachedMediaStreams,g,!1)):m.info("cachedMediaStreams is empty")}updateStreams(g,m=generateCauseId(),f=!1){this.logger.createFnLogger("updateStreams",m).info(`isStreamingMode=${f} mediaStreams=${safeJsonStringify(g)}`),g?.length&&(this.cachedMediaStreams=g),f||(this.streamManager.updateStreams(g,m),this.raiseChangedDeferred())}hasAudioSource(g){return this.streamManager.hasAudioSource(g)}raiseChangedDeferred(){this._raiseChangeDeferRunner((()=>this.raiseChanged()))}updateIsServerMuted(){if(!Object.values(this.filteredParticipantEndpointDetails).length)return void this._updateIsServerMuted(!1);let g=!1;Object.values(this.filteredParticipantEndpointDetails).forEach((m=>{const filterAndSortStreams=g=>m.mediaStreams?.filter((m=>m.type===g)).sort(Zr.compareStreams);let f=filterAndSortStreams(Nr.audio)?.[0];f||(f=filterAndSortStreams(Nr.audioteleconference)?.[0]);const S=!!f?.serverMuted,v=m.endpointState?.state;!1!==S||!1!==!!v?.isMuted||(g=!0)}));const m=!g;this._updateIsServerMuted(m)}_updateIsServerMuted(g){g!==this.isServerMuted&&(this.isServerMuted=g,this.logger.info(`_updateIsServerMuted updating to: ${this.isServerMuted}`),this.raiseChanged())}updateVoiceLevel(g){this.voiceLevel!==g&&(this.voiceLevel=g,this.raiseChanged())}setState(g,m,f){if(this.state===g)return;const S=this.logger.createFnLogger("setState",f);if(3===this.state&&6===g)return void S.info("Ignore Connected->EarlyMedia transition, it is a race between media and signaling");const v=es[this.state].indexOf(g)>=0;this.recordTelemetryForStateChange(f,g,m,!v),v?(S.info(`state=${this.state}->${g} reason=${this.stateReason}->${m}`),this.state=g,this.stateReason=m,this.raiseChangedDeferred()):S.logFailure(`Invalid state transition ${this.state}->${g} attempted`)}processParticipantDetails(g,m,f){const S=this.logger.createFnLogger("processParticipantDetails","");this.role=g.role,this.meetingRole=g.meetingRole,this.advancedMeetingRole=g.advancedMeetingRole,this.participantType=g.participantType,this.tenantId=g.tenantId,this.propertyBag=g.propertyBag,this.version=g.version,this.isIdentityMasked=!!g.isIdentityMasked,this.nonMaskedId=g.nonMaskedId,this.nonMaskedDisplayName=g.nonMaskedDisplayName,this.nonMaskedObjectId=g.nonMaskedObjectId,this.maskedIdSeqNumber=g.maskedIdSeqNumber,this.maskedId=g.maskedId,g.endpointDetails?.length&&(this.endpoints={endpointDetails:[]},this.participantCapabilities={canConference:!1,canShareScreen:!1,canMerge:!0},this.checkIfIncomingServerMutedIsUpdated(g),this.filteredParticipantEndpointDetails={},g.endpointDetails.forEach((g=>{const S=convertSignalingEndpointDetails(g,m);if(this.endpoints.endpointDetails.push(S),!S.mappedTo){if(this.filteredParticipantEndpointDetails[g.participantId]={endpointId:g.endpointId,serverMuteVersion:g.serverMuteVersion,endpointState:g.endpointState,mediaStreams:g.mediaStreams},g.capabilities&&(this.participantCapabilities.canConference||"enabled"!==g.capabilities.cloudAudioVideoConference||(this.participantCapabilities.canConference=!0),this.participantCapabilities.canShareScreen||"enabled"!==g.capabilities.cloudScreenSharing||(this.participantCapabilities.canShareScreen=!0),this.participantCapabilities.canMerge||"enabled"!==g.capabilities.cloudMerge||(this.participantCapabilities.canMerge=!0)),this.contentSharingRole=0,g.contentSharing&&g.contentSharing.sessionInformation){const m=g.contentSharing.sessionInformation;"attendee"===m.role?this.contentSharingRole=1:"presenter"===m.role&&(this.contentSharingRole=2)}S.streamInformation&&f&&f()}})),this.updateIsServerMuted(),S.info(`endpointDetails=${JSON.stringify(this.endpoints)}`),this.raiseChangedDeferred())}toCafeParticipant(){return{audioState:ts[this.state],mri:this.mri}}getSourceIdForMediaType(g){const m=getSourceIdForMediaType(this,g);return-1===m&&this.logger.warn("getSourceIdForMediaType failed"),m}useUmsStream(g,m,f,S,v,C){this.streamManager.useUmsStream(g,m,f,S,v,C),this.raiseChangedDeferred()}hasSourceId(g,m){return void 0!==getParticipantIdForSourceId(this,g,m)}},ns=class extends Ve{constructor(g,m,f,S,v,C="",_,E){super(),this.callTelemetry=g,this.signalingSession=f,this.contentSharingGuid=S,this.contentSharingIdentity=v,this.state=C,this.subject=_,this.handleOperationFailure=(g,m,f)=>{f.logFailure(g);const S=this.getTerminatedReasonFromError(g);return m.updateStatusTo&&(this.contentSharingStatus=m.updateStatusTo,this.rejectContentSharing(S)),Promise.reject(S)},this._logger=m.createChild((()=>`[ContentSharingSession][${this.contentSharingGuid}]`)),this.contentSharingStatus=0,this.contentSharingTerminationReason=null,this.contentSharingState=C,this._callOperationHandler=new Si(this._logger,this.callTelemetry),E&&(this.sessionId=E)}get contentSharingStatus(){return this.status}set contentSharingStatus(g){if(this._logger.info(`[set contentSharingStatus][currentStatus=${this.status}][newStatus=${g}]`),this.callTelemetry.recordEvent("_SetContentSharingStatus",{newStatus:g,oldStatus:this.status}),this.status!==g&&7!==this.status&&8!==this.status){if(this._logger.info(`[set contentSharingStatus] Changing content sharing status to: ${g}`),this.status=g,7===this.status){const g={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[set contentSharingStatus] Content sharing is disconnected"};this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(g)}if(2===this.status||5===this.status){const g={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Content sharing cannot be ended when not presenting"};this._callOperationHandler.maybeRejectOperation("StopContentSharing",g)}3===this.status&&(this._callOperationHandler.maybeResolveOperation("StartContentSharing"),this._callOperationHandler.maybeResolveOperation("TakeContentSharingControl")),this.raiseChanged()}}get contentSharingState(){return this.state}set contentSharingState(g){this.state!==g&&(this.state=g,this.raiseChanged())}startContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("StartContentSharing",g);if(0!==this.contentSharingStatus){const f=`[${g}][startContentSharing][failed][reason=InvalidState]`,S={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:f};return m.logFailure(`state=${this.contentSharingStatus}, reason=${f}`),Promise.reject(S)}return this.signalingSession.startContentSharingAsync(this.contentSharingIdentity,this.contentSharingState,this.subject,this.contentSharingGuid,g).then((g=>{this.sessionId=g.sessionId,this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((f=>this.handleOperationFailure(f,{causeId:g,operation:"StartContentSharing",updateStatusTo:8},m))),this._callOperationHandler.waitForOperation("StartContentSharing")}joinContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("JoinContentSharing",g);if(2!==this.contentSharingStatus){const f=`[${g}][joinContentSharing][failed][reason=InvalidState]`,S={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:f};return m.logFailure(`state=${this.contentSharingStatus}, reason=${f}`),Promise.reject(S)}return this.signalingSession.joinContentSharingAsync(this.contentSharingGuid,g).then((g=>(this.contentSharingStatus=4,this.contentSharingState=g.sessionState,this.presenterId=g.presenter,Promise.resolve()))).catch((f=>this.handleOperationFailure(f,{causeId:g,operation:"JoinContentSharing",updateStatusTo:8},m)))}updateContentSharingSessionState(g,m,f=generateCauseId()){const S=this._logger.createFnLogger("UpdateContentSharingSessionState",f);if(3!==this.contentSharingStatus){const g=`[${f}][updateContentSharingSessionState][failed][reason=InvalidState]`,m={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:g};return S.logFailure(`state=${this.contentSharingStatus}, reason=${g}`),Promise.reject(m)}return this.signalingSession.updateContentSharingSessionStateAsync(this.contentSharingGuid,m,f).then((()=>Promise.resolve())).catch((m=>this.handleOperationFailure(m,{causeId:f,operation:"UpdateContentSharingSessionState",operationId:g},S)))}takeContentSharingControl(g=generateCauseId()){const m=this._logger.createFnLogger("TakeContentSharingControl",g);if(5!==this.contentSharingStatus){const f=`[${g}][updateContentSharingSessionState][failed][reason=InvalidState]`,S={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:f};return m.logFailure(`state=${this.contentSharingStatus}, reason=${f}`),Promise.reject(S)}return this.signalingSession.takeContentSharingControlAsync(this.contentSharingGuid,g).then((()=>{this.contentSharingStatus=3,this.presenterId=this.signalingSession.participantManager.localParticipant.id})).catch((f=>this.handleOperationFailure(f,{causeId:g,operation:"TakeContentSharingControl"},m))),this._callOperationHandler.waitForOperation("TakeContentSharingControl")}updateContentSharingParticipantStateToViewer(g=generateCauseId()){const m=this._logger.createFnLogger("UpdateParticipantState",g);if(4!==this.contentSharingStatus){const f=`[${g}][updateContentSharingSessionState][failed][reason=InvalidState]`,S={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:f};return m.logFailure(`state=${this.contentSharingStatus}, reason=${f}`),Promise.reject(S)}return this.signalingSession.updateContentSharingParticipantStateAsync(this.contentSharingGuid,g).then((()=>(this.contentSharingStatus=this.presenterId===this.signalingSession.participantManager.localParticipant.id?3:5,Promise.resolve()))).catch((f=>this.handleOperationFailure(f,{causeId:g,operation:"UpdateParticipantState"},m)))}stopContentSharing(g=generateCauseId()){const m=this._logger.createFnLogger("StopContentSharing",g);if(2===this.contentSharingStatus||4===this.contentSharingStatus||5===this.contentSharingStatus){const f=`[${g}][stopContentSharing][failed][reason=InvalidState]`,S={terminatedReason:60,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:f};return m.logFailure(`state=${this.contentSharingStatus}, reason=${f}`),Promise.reject(S)}return this.signalingSession.deleteContentSharingAsync(this.contentSharingGuid,g).then((()=>(this.contentSharingStatus=7,this._callOperationHandler.waitForOperation("StopContentSharing")))).catch((f=>this.handleOperationFailure(f,{causeId:g,operation:"StopContentSharing"},m)))}dispose(g=generateCauseId()){const m={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"Call ended"};this._callOperationHandler.rejectPendingOperations(m,g),this.contentSharingStatus=7,this.contentSharingState="",super.dispose()}rejectContentSharing(g={terminatedReason:12,terminatedReasonCode:0,terminatedReasonSubCode:0,errorMessage:"[rejectContentSharing] Content sharing is disconnected"}){if(7!==this.status&&8!==this.status)throw new Error(`Tried to reject content sharing with status=${this.status}`);this._callOperationHandler.maybeResolveOperation("StopContentSharing"),this._callOperationHandler.rejectPendingOperations(g)}getTerminatedReasonFromError(g){const m=g?.endCode?.code||0,f={terminatedReason:32,terminatedReasonCode:m,terminatedReasonSubCode:g?.endCode?.subCode||0,errorMessage:g};switch(m){case vi.NotFound:f.terminatedReason=34,f.errorMessage="Active session not found on server";break;case vi.Forbidden:f.terminatedReason=8,f.errorMessage="Failed due to insufficient permissions"}return f}};__decorateClass([callOperation("StartContentSharing"),__decorateParam(0,causeId)],ns.prototype,"startContentSharing",1),__decorateClass([callOperation("JoinContentSharing"),__decorateParam(0,causeId)],ns.prototype,"joinContentSharing",1),__decorateClass([callOperation("UpdateContentSharingSessionState"),__decorateParam(0,operationId),__decorateParam(2,causeId)],ns.prototype,"updateContentSharingSessionState",1),__decorateClass([callOperation("TakeContentSharingControl"),__decorateParam(0,causeId)],ns.prototype,"takeContentSharingControl",1),__decorateClass([callOperation("UpdateParticipantState"),__decorateParam(0,causeId)],ns.prototype,"updateContentSharingParticipantStateToViewer",1),__decorateClass([callOperation("StopContentSharing",{waitFor:"StartContentSharing"}),__decorateParam(0,causeId)],ns.prototype,"stopContentSharing",1);var rs,ss=class{constructor(){this.messageCounters=new Map}recordDataChannelProtocolEvent(g){this.messageCounters.has(g.dataId)||this.messageCounters.set(g.dataId,{});const m=this.messageCounters.get(g.dataId);switch(m[g.direction]||(m[g.direction]={successful:0,failed:0,fragmented:0,dismissed:0}),g.state){case 0:m[g.direction].successful++;break;case 1:m[g.direction].failed++;break;case 2:m[g.direction].fragmented++;break;case 3:m[g.direction].dismissed++}}setSessionDataChannelState(g){this.sessionState=g.toString()}recordDataChannelError(g){this.dataChannelError=g}get protocolCounters(){if(!this.messageCounters.size)return;const g={};for(const m of this.messageCounters.keys())g[m]=this.messageCounters.get(m);return g}getReport(g){const m={};return m[g+"ProtocolCounters"]=JSON.stringify(this.protocolCounters),m[g+"SessionState"]=this.sessionState,m[g+"Error"]=this.dataChannelError,m}},as=class{constructor(g){this.value=g,this.next=void 0}},os=class{constructor(){this.length=0}enqueue(g){const m=new as(g);this.front?(this.rear.next=m,this.rear=m):(this.front=m,this.rear=m),this.length++}dequeue(){if(!this.front)return;const g=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,g.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}},ls=R,cs=class{constructor(g){this.comparator=g,this.heap=[]}enqueue(g){this.heap.push(g),this.bubbleUp()}dequeue(){const g=this.peek();if(void 0!==g){const g=this.heap.pop();this.size()>0&&(this.heap[0]=g,this.bubbleDown())}return g}peek(){return this.heap[0]}size(){return this.heap.length}bubbleUp(){let g=this.size()-1,m=this.getParentIndex(g);for(;!this.isRoot(g)&&this.comparator(this.heap[g],this.heap[m]);)[this.heap[m],this.heap[g]]=[this.heap[g],this.heap[m]],g=m,m=this.getParentIndex(g)}bubbleDown(){if(this.size()<=1)return;let g=this.getRootIndex(),m=this.getLeftIndex(g),f=this.getRightIndex(g);for(;this.heap[m]&&this.comparator(this.heap[m],this.heap[g])||this.heap[f]&&this.comparator(this.heap[f],this.heap[g]);)!this.heap[f]||this.comparator(this.heap[m],this.heap[f])?([this.heap[g],this.heap[m]]=[this.heap[m],this.heap[g]],g=m):([this.heap[g],this.heap[f]]=[this.heap[f],this.heap[g]],g=f),m=this.getLeftIndex(g),f=this.getRightIndex(g)}getRootIndex(){return 0}isRoot(g){return 0===g}getLeftIndex(g){return 2*g+1}getRightIndex(g){return 2*g+2}getParentIndex(g){return Math.floor((g-1)/2)}},ds=class{constructor(g,m,f){this.maxPacketRate=m,this.rateLimiterCheckInterval=f,this.maxDataRate=0,this.packetsEndTimeForPacketRate=0,this.packetsEndTimeForBitrate=0,this.maxDataRate=g/8}canSend(g){if(0===this.maxDataRate&&0===this.maxPacketRate)return!0;const m=We();if(this.maxPacketRate&&this.packetsEndTimeForPacketRate>m+this.rateLimiterCheckInterval)return!1;if(this.maxDataRate&&this.packetsEndTimeForBitrate>m+this.rateLimiterCheckInterval)return!1;const f=this.maxPacketRate?1e3/this.maxPacketRate:0,S=this.maxDataRate?g.length/this.maxDataRate*1e3:0;return this.packetsEndTimeForPacketRate=Math.max(this.packetsEndTimeForPacketRate,m)+f,this.packetsEndTimeForBitrate=Math.max(this.packetsEndTimeForBitrate,m)+S,!0}},hs=class{constructor(g){this.dataIds=new Map,this.maxBitrate=g.config.webrtcDataChannel.maxBitrate,this.maxPacketRate=g.config.webrtcDataChannel.maxPacketRate,this.maxQueueSize=g.config.webrtcDataChannel.maxQueueSize,g.config.webrtcDataChannel.dataIds.forEach((g=>{this.dataIds.set(g.dataId,g)}))}getMaxBitrate(g){return this.dataIds.get(g)?.maxBitrate??this.maxBitrate}getMaxPacketRate(g){return this.dataIds.get(g)?.maxPacketRate??this.maxPacketRate}getMaxQueueSize(g){return this.dataIds.get(g)?.maxQueueSize??this.maxQueueSize}getConfig(g){const m=this.dataIds.get(g)||{dataId:g};return m.maxBitrate=m.maxBitrate??this.maxBitrate,m.maxPacketRate=m.maxPacketRate??this.maxPacketRate,m.maxQueueSize=m.maxQueueSize??this.maxQueueSize,m.priorityWeight=m.priorityWeight??1,m}},us=class{constructor(g,m,f){this.dataIdConfig=m,this.rateLimiterCheckInterval=f,this.timeOffset=0,this.packets=new os,this.startTime=g(),this.finishTime=this.startTime,this.rateLimiter=new ds(m.maxBitrate,m.maxPacketRate,this.rateLimiterCheckInterval),this.getCurrentTime=g,this.stats={bufferSize:m.maxQueueSize,remainingBytes:0,remainingPackets:0}}enqueue(g){if(0===g.length)return 0;const m=(0,ls.sumBy)(g,(g=>g.length)),f=this.dataIdConfig.maxQueueSize;if(f&&this.stats.remainingBytes+m>f)throw new Error(`dataId ${this.dataIdConfig.dataId} send queue is full`);const S=this.getCurrentTime();let v=0;return 0===this.packets.size()?(this.startTime=S,this.finishTime=S,this.timeOffset=0,v=S):v=this.finishTime,g.forEach((g=>{v+=g.length*this.dataIdConfig.priorityWeight,this.packets.enqueue({finishTime:v,packet:g}),this.stats.remainingBytes+=g.length,this.stats.remainingPackets++})),this.finishTime=v,m}dequeue(){const g=this.peek();if(void 0!==g){if(!this.rateLimiter.canSend(g.packet))return;this.packets.dequeue(),this.stats.remainingBytes-=g.packet.length,this.stats.remainingPackets--}return g}updateTimeOffset(){this.packets.size()?this.timeOffset=this.getCurrentTime()-this.startTime:(this.startTime=this.getCurrentTime(),this.finishTime=this.startTime,this.timeOffset=0)}peek(){if(0===this.packets.size())return;const g=this.packets.peek();return{finishTime:g.finishTime+this.timeOffset,packet:g.packet}}getConfig(){return this.dataIdConfig}getStats(){return(0,ls.clone)(this.stats)}},gs=class{constructor(g){this.senders=new Map,this.currentVirtualClock=0,this.dataIdConfigManager=new hs(g),this.virtualTimeQueue=new cs(((g,m)=>g.minTime<m.minTime)),this.sendStats={bufferSize:0,remainingBytes:0,remainingPackets:0},this.rateLimiterCheckInterval=g.config.webrtcDataChannel.rateLimiterCheckInterval}getPacketsToSend(g){if(0===this.virtualTimeQueue.size())return[];const m=[],f=[];for(;g>=0&&this.virtualTimeQueue.size();){const S=this.virtualTimeQueue.peek();if(S.size>g)break;this.virtualTimeQueue.dequeue();const v=S.dataId,C=this.senders.get(v);if(void 0!==C.peek()){const S=C.dequeue();if(void 0!==S){m.push(S.packet),this.sendStats.remainingBytes-=S.packet.length,g-=S.packet.length,this.sendStats.remainingPackets--,this.currentVirtualClock=Math.max(this.currentVirtualClock,S.finishTime);const f=C.peek();f&&this.virtualTimeQueue.enqueue({dataId:v,minTime:f.finishTime,size:f.packet.length})}else f.push(v)}}return f.forEach((g=>{const m=this.senders.get(g);m.updateTimeOffset();const f=m.peek();f&&this.virtualTimeQueue.enqueue({dataId:g,minTime:f.finishTime,size:f.packet.length})})),m}appendPackets(g,m){let f=this.senders.get(g);void 0===f&&(f=new us((()=>this.currentVirtualClock),this.dataIdConfigManager.getConfig(g),this.rateLimiterCheckInterval),this.senders.set(g,f));const S=f.getStats(),v=f.enqueue(m);if(this.sendStats.remainingBytes+=v,this.sendStats.remainingPackets+=m.length,0===S.remainingPackets){const m=f.peek();void 0!==m&&this.virtualTimeQueue.enqueue({dataId:g,minTime:m.finishTime,size:m.packet.length})}}getStats(g){if(void 0===g)return(0,ls.clone)(this.sendStats);const m=this.senders.get(g);return void 0===m?{bufferSize:this.dataIdConfigManager.getMaxQueueSize(g),remainingBytes:0,remainingPackets:0}:m.getStats()}},ps=class{constructor(g,m,f){this.dataId=g,this.statsGatherer=m,this.logger=f,this.pendingFragments=[]}depacketize(g){const m=new DataView(g.buffer),f=63&m.getUint8(2);if(f!==this.dataId)throw new Error(`Invalid packet dataId: ${this.dataId} !== ${f}`);const S=11,v=((15&m.getUint8(0))<<8)+m.getUint8(1),C=128&m.getUint8(2),_=m.getUint16(3),E=m.getUint8(5),T=m.getUint32(6),I=m.getUint8(10);if(C){this.pendingFragments.length&&this.logger.warn(`Unfinished message: dataId: ${this.dataId} seqNum: ${_}`),this.remainingPackets=E,0!==E&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:2,dataId:f}),this.pendingFragments=[],this.sourceId=T,this.recipients=[];for(let g=0;g<I;g++){const f=m.getUint32(S+4*g);this.recipients.push(f)}}else{if(0===this.pendingFragments.length)return this.logger.safe.error(`No start flag dataId: ${this.dataId} seqNum: ${_}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:f}),null;if(this.nextSeqNum!==_)return this.logger.safe.error(`Invalid sequence number: dataId: ${this.dataId} seqNum: ${_}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:3,dataId:f}),null;this.remainingPackets-=1}if(this.nextSeqNum=_+1&65535,this.pendingFragments.push(g.slice(v)),0===this.remainingPackets){const g=this.pendingFragments.reduce(((g,m)=>g+m.length),0),m=new Uint8Array(g);let f=0;for(const g of this.pendingFragments)m.set(g,f),f+=g.length;return this.pendingFragments=[],{dataId:this.dataId,sourceId:this.sourceId,data:m,recipients:this.recipients}}return null}},ms=class{constructor(g){this.seqNum=0,this.dataId=g}packetize(g){if(g.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${g.dataId}`);const m=11,f=m+4*g.recipients.length,S=new Uint8Array(g.data.length+f),v=new DataView(S.buffer);v.setUint8(0,16+(f>>8)),v.setUint8(1,255&f),v.setUint8(2,128|63&g.dataId),v.setUint16(3,this.seqNum),v.setUint8(5,0),v.setUint32(6,g.sourceId),v.setUint8(10,g.recipients.length);for(let f=0;f<g.recipients.length;f++)v.setUint32(m+4*f,g.recipients[f]);return S.set(g.data,f),this.seqNum+=1,[S]}},fs=class{constructor(g,m,f){this.statsGatherer=f,this.seqNum=0,this.dataId=g,this.fragmentationSize=m}packetize(g){if(g.dataId!==this.dataId)throw new Error(`Invalid dataId: ${this.dataId} !== ${g.dataId}`);const m=11,f=m+4*g.recipients.length,S=[],v=this.fragmentationSize-f;if(v<0)throw new Error(`message dataId: ${this.dataId} payload size: ${f} exceeds limit`);let C=g.data.length?Math.ceil(g.data.length/v):1;const _=C-1;_>0&&this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:2,dataId:this.dataId});let E=g.data.length,T=!0,I=0;for(;C>0;){const b=Math.min(E,v),A=new Uint8Array(b+f),P=new DataView(A.buffer);P.setUint8(0,16+(f>>8)),P.setUint8(1,255&f),T?(T=!1,P.setUint8(2,128|63&g.dataId)):P.setUint8(2,63&g.dataId),P.setUint16(3,this.seqNum),P.setUint8(5,_),P.setUint32(6,g.sourceId),P.setUint8(10,g.recipients.length);for(let f=0;f<g.recipients.length;f++)P.setUint32(m+4*f,g.recipients[f]);A.set(g.data.slice(I,I+b),f),I+=b,S.push(A),this.seqNum+=1,C-=1,E-=b}return S}},Ss=class extends Be{constructor(g,m,f,S){super(),this.dataChannel=g,this.statsGatherer=m,this.stateInternal="Created",this.packetizers=new Map,this.depacketizers=new Map,this.sendScheduleTimer=0,this.pendingPackets=new os,this.label=g.label,this.logger=f.createChild(`[WebRtcDataChannel ${this.label}]`),this.bufferedAmountLowThreshold=S.config.webrtcDataChannel.bufferedAmountLowThreshold,this.bufferedAmountHighThreshold=S.config.webrtcDataChannel.bufferedAmountHighThreshold,this.fragmentationSize=S.config.webrtcDataChannel.enableFragmentation?S.config.webrtcDataChannel.fragmentationSize:0,S.config.webrtcDataChannel.enableSendScheduler&&(this.sendScheduler=new gs(S)),this.rateLimiterCheckInterval=S.config.webrtcDataChannel.rateLimiterCheckInterval,this.discardOnSendFailure=S.config.webrtcDataChannel.discardOnSendFailure,this.subscribeOnDataChannelEvents()}getDataIdStats(g){return this.sendScheduler?.getStats(g)}get state(){return this.stateInternal}setDataChannel(g){this.dataChannel&&(this.logger.info(`Replacing internal data channel ${this.label}:${this.dataChannel.id} with ${g.label}:${g.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close()),this.dataChannel=g,this.subscribeOnDataChannelEvents()}dispose(){this.logger.info("dispose"),this.dataChannel&&(this.logger.info(`dataChannel.close ${this.dataChannel.id}`),this.unsubscribeOnDataChannelEvents(),this.dataChannel.close(),this.dataChannel=null,this.setState("Destroyed"),super.dispose())}sendMessage(g,m,f,S=[]){try{this.packetizers.has(g)||(this.fragmentationSize?this.packetizers.set(g,new fs(g,this.fragmentationSize,this.statsGatherer)):this.packetizers.set(g,new ms(g)));const v=this.packetizers.get(g).packetize({dataId:g,sourceId:m,data:f,recipients:S});void 0!==this.sendScheduler?(this.sendScheduler.appendPackets(g,v),this.scheduleSend()):v.forEach((g=>{this.dataChannel.send(g)})),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:0,dataId:g})}catch(m){throw this.logger.unsafe.warn(`Failed to construct protocol message: ${stringifyObject(m)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"send",state:1,dataId:g}),m}}scheduleSend(){if("Connected"!==this.state)return;const sendPacket=g=>{try{this.dataChannel.send(g)}catch(g){return this.logger.unsafe.warn(`Failed to send message: ${stringifyObject(g)}`),!1}return!0};if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){const g=Date.now();let m=this.bufferedAmountHighThreshold-this.dataChannel.bufferedAmount;for(;this.pendingPackets.size();){const g=this.pendingPackets.peek();if(g.length>m)break;if(!sendPacket(g))break;this.pendingPackets.dequeue(),m-=g.length}if(0===this.pendingPackets.size()&&m>0){const g=this.sendScheduler.getPacketsToSend(m);for(const m of g)if(!1===sendPacket(m)&&!1===this.discardOnSendFailure){this.pendingPackets.enqueue(m);break}}if(this.dataChannel.bufferedAmount<=this.dataChannel.bufferedAmountLowThreshold){if(this.sendScheduleTimer)return;if(this.sendScheduler.getStats().remainingPackets>0){const m=Math.max(g+this.rateLimiterCheckInterval-Date.now(),20);this.sendScheduleTimer=window.setTimeout((()=>{this.sendScheduleTimer=0,this.scheduleSend()}),m)}}}}subscribeOnDataChannelEvents(){this.dataChannel.binaryType="arraybuffer",this.dataChannel.onmessage=g=>{const m=new Uint8Array(g.data),f=63&m[2];try{this.depacketizers.has(f)||this.depacketizers.set(f,new ps(f,this.statsGatherer,this.logger));const g=this.depacketizers.get(f).depacketize(m);g&&(this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:0,dataId:f}),this.event("onmessage").raise(f,g.sourceId,g.data))}catch(g){this.logger.unsafe.warn(`Failed to parse incoming message: ${stringifyObject(g)}`),this.statsGatherer.recordDataChannelProtocolEvent({direction:"recv",state:1,dataId:f})}},this.dataChannel.onerror=g=>{const m=g?.target,f=stringifyObject(g?.error??g);this.logger.safe.warn(`onerror: label:${m.label} id:${m.id} ${f} `),this.statsGatherer.recordDataChannelError(f)},"open"===this.dataChannel.readyState&&this.dataChannel.id%2==0&&(this.logger.safe.info(`readyState is already 'open' label:${this.dataChannel.label} id:${this.dataChannel.id}`),this.setState("Connected")),this.dataChannel.onopen=g=>{const m=g.target;this.logger.safe.info(`onopen label:${m.label} id:${m.id}`),m.id%2==0&&this.setState("Connected")},this.dataChannel.onclose=g=>{const m=g.target;this.logger.safe.info(`onclose label:${m.label} id:${m.id}`),this.setState("Closed")},this.dataChannel.onclosing=g=>{const m=g.target;this.logger.safe.debug(`onclosing label:${m.label} id:${m.id}`),this.setState("Closed")},void 0!==this.sendScheduler&&(this.dataChannel.bufferedAmountLowThreshold=this.bufferedAmountLowThreshold,this.dataChannel.onbufferedamountlow=()=>{this.scheduleSend()})}unsubscribeOnDataChannelEvents(){this.dataChannel.onmessage=null,this.dataChannel.onerror=null,this.dataChannel.onopen=null,this.dataChannel.onclose=null,this.dataChannel.onclosing=null,this.dataChannel.onbufferedamountlow=null}setState(g){this.stateInternal=g,this.event("onStateChanged").raise(),"Connected"===g&&void 0!==this.sendScheduler&&this.scheduleSend()}},vs="main-channel",ys=class extends Be{constructor(g,m,f,S){const v=f.createChild("PluginlessDataChannel");super(v),this.pc=g,this.statsGatherer=m,this.configProvider=S,this._state="Inactive",this.logger=v,this.subscribeOnDatachannel()}get state(){return this._state}getDataChannel(g){if(!this.dataChannel){this.logger.safe.info(`[${g}] creating new dataChannel`);try{const g={};this.dataChannel=new Ss(this.pc.createDataChannel(vs,g),this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()}catch(m){return this.logger.safe.error(`[${g}] createDataChannel failed: ${stringifyObject(m)}`),this.statsGatherer.sessionInfo.setCreateChannelFailReason(m),this.setState("Failed"),null}}return this.dataChannel}updateDataModalityState(g){"Failed"!==this._state&&"Disabled"!==this._state&&(g===je.MEDIA_STATE.sendReceive?this.setState("Active"):g===je.MEDIA_STATE.inactive&&this.setState("Inactive"))}disable(){this.setState("Disabled")}dispose(){this.stopDataChannel(),this.pc=null,super.dispose()}subscribeOnDatachannel(){this.pc.ondatachannel=g=>{this.onDataChannel(g.channel)}}onDataChannel(g){this.logger.safe.info(`onDataChannel id=${g.id} label=${g.label}`),g.id%2==0?this.dataChannel?(this.logger.safe.info("Found existing data channel, replacing"),this.dataChannel.setDataChannel(g)):(this.dataChannel=new Ss(g,this.statsGatherer,this.logger,this.configProvider),this.subscribeForDataChannelEvents()):this.logger.safe.info(`onDataChannel ignoring id ${g.id}`)}subscribeForDataChannelEvents(){this.dataChannel.on("onStateChanged",(()=>{"Closed"===this.dataChannel.state&&(this.stopDataChannel(),this.setState("Inactive"))}))}setState(g){if(this._state!==g){this.statsGatherer.setSessionDataChannelState(g);const m=generateCauseId();this._state=g,this.logger.safe.info(`[${m}] SessionDataChannelState changed, state=${this._state}`),"Inactive"===this._state||"Disabled"===this._state?this.stopDataChannel():"Active"===this._state&&this.getDataChannel(m),this.event("onStateChanged").raise(this._state)}}stopDataChannel(){this.dataChannel&&(this.logger.safe.info("stopDataChannel"),this.dataChannel.dispose(),this.dataChannel=null)}},Cs=class extends Ve{constructor(g){super(),this.mainChannel=null,this.sourceId=li,this._state="Inactive",this.dataHandlers=new Map,this.dataHandlerTelemetry=new Map,this.startTime=Date.now(),this.sendMessage=async(g,m,f)=>{if(this.logger.debug(`Sending message for ${g}, from: ${this.sourceId} to: ${f} state: ${!!this.mainChannel&&this.mainChannel.state} len: ${m.length}`),!this.mainChannel||"Connected"!==this.mainChannel.state||"Active"!==this.state)throw new Error("No active data channel to send data from");this.mainChannel.sendMessage(g,this.sourceId,m,f)},this.logger=g.createChild("PluginlessDataChannel")}get state(){return this._state}registerSessionDataChannel(g,m){this.sessionDataChannel&&this.stop(m),this.sessionDataChannel=g,this.subscribeForSessionDataChannelEvents()}setDataChannelSourceId(g){this.logger.debug(`setDataChannelSourceId ${g}`),this.sourceId=g}requestDataChannelHandler(g){return this.sessionDataChannel.getDataChannel(g)}async sendUserEvents(g,m){if(!this.mainChannel)throw this.logger.info("sendUserEvents() no data channel available"),new Error("Main DataChannel is not active");{const f=m?m.map((g=>parseInt(g,10))):[];this.mainChannel.sendMessage(0,this.sourceId,(new TextEncoder).encode(g),f)}}async addHandler(g,m){if(this.logger.info(`Adding handler with dataId ${g}`),this.dataHandlers.get(g))throw new Error(`Data Id ${g} is already registered`);const f={isStarted:!1,handler:m};this.dataHandlers.set(g,f),this.recordDataHandlerEvent(g,"added"),"Connected"===this.mainChannel?.state&&this.startHandler(g,f)}async removeHandler(g){if(this.logger.info(`Removing handler with dataId ${g}`),!this.dataHandlers.has(g))throw new Error(`Handler associated with Data Id ${g} is not attached`);const m=this.dataHandlers.get(g);m.isStarted&&this.stopHandler(g,m),this.dataHandlers.delete(g)}async updateNegotiationTag(g){}getTelemetry(){if(!this.dataHandlerTelemetry.size)return"";const g={};for(const[m,f]of this.dataHandlerTelemetry)g[m]=f;return JSON.stringify(g)}start(g){this.mainChannel?this.logger.info(`[${g}] already started`):(this.logger.info(`[${g}] starting`),this.mainChannel=this.sessionDataChannel.getDataChannel(g),this.subscribeForMainDataChannelEvents())}stop(g){this.mainChannel&&(this.logger.info(`[${g}] stopping`),this.mainChannel.dispose(),this.mainChannel=null)}dispose(){this.stop(void 0),this.sessionDataChannel=null,super.dispose()}setConfigProviderView(g){this.configProviderView=g}subscribeForMainDataChannelEvents(){this.mainChannel.on("onmessage",((g,m,f)=>{this.logger.debug(`Got message for ${g}, from: ${m} state: ${!!this.mainChannel&&this.mainChannel.state}, len: ${f.length}`),this.dataHandlers.has(g)&&(this.recordDataHandlerEvent(g,"recvd"),this.dataHandlers.get(g).handler.onDataReceived(g,f,m)),this.event("remoteUserEventsReceived").raise(g.toString(),(new TextDecoder).decode(f))})),this.onMainChannelStateChanged(),this.mainChannel.on("onStateChanged",(()=>this.onMainChannelStateChanged()))}onMainChannelStateChanged(){if(this.mainChannel)switch(this.mainChannel.state){case"Connected":this.startHandlers();break;case"Closed":case"Destroyed":this.stopHandlers()}}startHandlers(){for(const[g,m]of this.dataHandlers.entries())m.isStarted||this.startHandler(g,m)}stopHandlers(){for(const[g,m]of this.dataHandlers.entries())m.isStarted&&this.stopHandler(g,m)}startHandler(g,m){this.logger.info(`Starting dataHandler id: ${g}`),m.handler.onStarted(g,((m,f)=>(this.recordDataHandlerEvent(g,"sent"),this.sendMessage(g,m,f))),(()=>{const m=this.mainChannel?.getDataIdStats(g);if(void 0!==m){const g={bufferSize:m.bufferSize,remainingBytes:m.remainingBytes,remainingPackets:m.remainingPackets};return Promise.resolve(g)}return Promise.reject(new Error(`Stats of dataId ${g} is not available`))})),m.isStarted=!0,this.recordDataHandlerEvent(g,"started")}stopHandler(g,m){this.logger.info(`Stopping dataHandler id: ${g}`),m.handler.onStopped(g),m.isStarted=!1,this.recordDataHandlerEvent(g,"removed")}subscribeForSessionDataChannelEvents(){this.sessionDataChannel.on("onStateChanged",(g=>{const m=generateCauseId();switch(g){case"Active":this.start(m),this.setState("Active");break;case"Inactive":this.stop(m),this.setState("Inactive");break;case"Failed":this.stop(m),this.setState("Failed");break;case"Disabled":this.stop(m),this.setState("Disabled");break;default:this.logger.warn(`[${m}] unhandled SessionDataChannelState ${g}`)}}))}recordDataHandlerEvent(g,m){this.dataHandlerTelemetry.has(g)||this.dataHandlerTelemetry.set(g,[{}]);const f=this.dataHandlerTelemetry.get(g);let S=f[f.length-1];if("added"===m&&void 0!==S.added){S={},f.push(S);const g=this.configProviderView?.config.maxStoredDataChannelValues??15;f.length>g&&f.shift()}switch(m){case"added":case"started":case"removed":S[m]=Date.now()-this.startTime;break;case"recvd":case"sent":S[m]=isNaN(S[m])?1:S[m]+1}}setState(g){this._state!==g&&(this._state=g,this.logger.info(`PluginlessDataChannelState changed, state=${this._state}`),this.event("onDataChannelStateUpdated").raise(this._state))}},_s=__toESM(Ie());(g=>{const m=7,f=3;function encodeMouseEvent(g){if(!g)return new Uint8Array(0);g.buttonType||(g.buttonType=0),g.xPos||(g.xPos=0),g.yPos||(g.yPos=0),g.wheelRotation||(g.wheelRotation=0);const f=new ArrayBuffer(m),S=new DataView(f),v=(3&g.type)<<0,C=(7&g.buttonType)<<2,_=(g.buttonDown?1:0)<<5,E=(g.wheelButtonDown?1:0)<<6,T=0;return S.setUint8(0,1),S.setUint8(1,v|C|_|E|T),S.setUint16(2,g.xPos,!0),S.setUint16(4,g.yPos,!0),S.setUint8(6,g.wheelRotation),new Uint8Array(f)}function encodeKeyboardEvent(g){const m=new ArrayBuffer(f),S=new DataView(m),v=(3&g.codeType)<<0,C=0,_=(g.keyUp?1:0)<<4,E=(g.repeat?1:0)<<5,T=0,I=0;return S.setUint8(0,0),S.setUint8(1,v|C|_|E|T|I),S.setUint8(2,g.code),new Uint8Array(m)}function decodeEventType(g){return g[0]}function decodeMouseEvent(g){if(1!==g[0]||g.length!==m)return null;const f=new DataView(g.buffer),S=f.getUint8(1);return{type:3&S,buttonType:S>>2&7,buttonDown:!!(S>>5&1),wheelButtonDown:!!(S>>6&1),xPos:f.getUint16(2,!0),yPos:f.getUint16(4,!0),wheelRotation:f.getUint8(6)}}function decodeKeyboardEvent(g){if(0!==g[0]||g.length!==f)return null;const m=new DataView(g.buffer),S=m.getUint8(1);return{codeType:3&S,code:m.getUint8(2),repeat:!!(S>>5&1),keyUp:!!(S>>4&1)}}g.encodeMouseEvent=encodeMouseEvent,g.encodeKeyboardEvent=encodeKeyboardEvent,g.decodeEventType=decodeEventType,g.decodeMouseEvent=decodeMouseEvent,g.decodeKeyboardEvent=decodeKeyboardEvent})(rs||(rs={}));var Es=R,Ts=P,Is=3e4,bs=1e4,As=2e3,Ps=6,Rs="",ws=class extends ri{constructor(g,m,f,S,v,C){super(g,m,(()=>this.recordedEvents.length>100)),this.negotiationTag=f,this.callId=S,this.participantId=v,this.endpointId=C,this.messagesFromUnknownSender={},this.tsCallingVersion=getTsCallingVersion()}recordProtocolMessage(g,m){g||(m in this.messagesFromUnknownSender||(this.messagesFromUnknownSender[m]=0),this.messagesFromUnknownSender[m]++)}setCallId(g){this.callId=g}setEndpointId(g){this.endpointId=g}setParticipantId(g){this.participantId=g}setTenantId(g){this.tenantId=g}setUserHexCID(g){this.userHexCID=g}},Ms=class extends ws{constructor(g,m,f,S,v,C,_){super(g,m,f,S,v,C);const E=getSharingParticipantLeg(_);if(E){this.sharerParticipantId=E;const g=(0,Es.find)(_.endpoints.endpointDetails,(g=>g.participantId===E));g&&(this.sharerClientVersion=g.clientVersion)}}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.callId),ParticipantId:getValue2(this.participantId),EndpointId:getValue2(this.endpointId),NegotiationTag:getValue2(this.negotiationTag),TsCallingVersion:getValue2(this.tsCallingVersion),TenantId:getValue2(this.tenantId),SharerParticipantId:getValue2(this.sharerParticipantId),SharerClientVersion:getValue2(this.sharerClientVersion),EventTimestampBag:super.getEventTimestampBag(g,m),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},Ds=class extends ws{constructor(g,m,f,S,v,C){super(g,m,f,S,v,C)}getEvent(g,m){const getValue2=g=>void 0===g?"":g;return{CorrelationId:getValue2(this.callId),ParticipantId:getValue2(this.participantId),EndpointId:getValue2(this.endpointId),NegotiationTag:getValue2(this.negotiationTag),TsCallingVersion:getValue2(this.tsCallingVersion),TenantId:getValue2(this.tenantId),EventTimestampBag:super.getEventTimestampBag(g,m),ProtocolMessages:JSON.stringify({UnknownSender:this.messagesFromUnknownSender})}}},Os=class extends Ve{constructor(g,m,f,S){super(g),this._logger=g,this._call=m,this._telemetryLoggers=f,this._config=S,this.controlState=0,this.role=0,this._enabled=!1,this._availableAckEnabled=!0,this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._controlRequest=null,this._controlRequestSubscription=null,this._controllerParticipant=null,this._controllerParticipantSubscription=null,this._controllerSourceId=null,this._screenSharingVideoRenderer=null,this._screenSharingVideoRendererSubscriptions=[],this._sharerParticipant=null,this._pendingSharer=null,this._controlCapturer=null,this._captureEventSubscription=null,this._mouseControlEventSubscription=null,this._keyboardControlEventSubscription=null,this._requestControlTimer=null,this._grantControlTimer=null,this._acceptControlTimer=null,this._terminateControlTimer=null,this._delayedSendHandshakeTimer=null,this._availableAckTimer=null,this._retryAttempt=0,this._raiseRenderedAtViewer=null,this._participantSubscriptions={},this._viewerSessionLastTerminatedReason=0,this._completedViewerSessions=[],this.giveControlEnabled=!0,this.isEscalationInProgress=!1,this._logger.info("constructor"),this._callId=this._call.callId,this._call.on("callIdChanged",(g=>{this._callId=g,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setCallId(g),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setCallId(g)})),this._participantId=this._call.participantId,this._call.on("callLegIdChanged",(g=>{this._participantId=g,this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.setParticipantId(g),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.setParticipantId(g)})),this._endpointId=this._call.endpointId}setAdapters(g,m,f){this._controlInjector=g,this._rendererAdapter=m,this._dataChannelAdapter=f,this._dataChannelAdapter.on("stateChange",(g=>{this._onDataChannelStatusChanged(g)})),this._dataChannelAdapter.on("protocolMessage",((g,m,f,S)=>this.processProtocolMessage(g,m,f,S))),this._dataChannelAdapter.on("controlMessage",((g,m)=>this.processControlMessage(g,m)))}testSetControlInjector(g){}enableScreenSharingControl(g,m,f,S){if(this._logger.info(`enableScreenSharingControl() enabled=${g} disabledReason=${m}`),this._availableAckEnabled!==g||this._allowControlForUser!==S){if(this._allowControlForUser=S,g)this._raiseScreenSharingControlCapableEvent(!0,Rs);else{if(0===m){const g={reason:2,detail:f};this.event("sharingControlError").raise(g)}this._raiseScreenSharingControlCapableEvent(!1,Rs)}if(this._availableAckEnabled!==g){const m=g?"AvailableAckEnabled":"AvailableAckDisabled";this._recordSharerSessionTelemetry((g=>g.recordEvent(m)),!1)}this._availableAckEnabled=g}}setGiveControlEnabled(g){this.giveControlEnabled=g}_canEnableGiveControl(){return this._controlInjector.canBeEnabled()&&this.giveControlEnabled}setRaiseRenderedAtViewer(g){this._raiseRenderedAtViewer=g}setScreenSharingControlFeatureFlag(g){this._logger.info(`setScreenSharingControlFeatureFlag() enabled=${g}`),this._enabled=g,this._availableAckEnabled=g,this._enabled&&this._handleCallState(this._callState)}isScreenSharingControlEnabled(){return this._enabled}_disposeRenderer(g){this._disposeControlCapturer(g);for(const g of this._screenSharingVideoRendererSubscriptions)g.dispose();this._screenSharingVideoRendererSubscriptions=[],this._screenSharingVideoRenderer=null}setRenderer(g,m){this._logger.info("setRenderer");const f=generateCauseId();if(this._disposeRenderer(f),!g)return Promise.resolve();const S=m||this._rendererAdapter.getTarget(g);return asap((()=>{this._setViewingRenderer(g,S)}))}_isDataChannelActive(){return this._dataChannelAdapter.isActive()&&this._dataChannelAvailable}_raiseScreenSharingControlCapableEvent(g,m,f){if(this._enabled&&this._isDataChannelActive()){this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=true, capable=${g}, role=${this.role}`);const S={capable:g,id:m,disabledBySharer:f};this.event("sharingControlCapable").raise(S)}else{this._logger.info(`_raiseScreenSharingControlCapableEvent() enabled=false, capable=${g}, role=${this.role}`);const f={capable:!1,id:m};this.event("sharingControlCapable").raise(f)}}initControlForSharer(g){this._logger.info("initControlForSharer()"),this._isSharing()&&this._logger.warn("initControlForSharer() when already sharing"),this._resetControlState(),this._screenSharingVideoRenderer=null,this._disposeControlCapturer(),this._logger.info(`role is changing from=${this.role} to=1`),this.role=1,this._availableHandshakeSent=!1,this._raiseScreenSharingControlCapableEvent(this._canEnableGiveControl(),Rs),this._initiateSharerSessionTelemetry(g)}enableControlInjector(g){this._logger.info(`enableControlInjector() trackId: ${g}`),this._canEnableGiveControl()?this._controlInjector.enableInjector(g).catch((g=>{const m={reason:0,detail:JSON.stringify({errorMsg:g})};this.event("sharingControlError").raise(m)})):this._logger.info("enableControlInjector() give control cannot be enabled")}shutdownControlForSharer(){if(this._logger.info("shutdownControlForSharer()"),this._isSharing()||this._logger.warn("shutdownControlForSharer() when not sharing"),this._controlRequest){this._logger.warn("Rejecting pending control requests");const g=this._getDataSourceIdForParticipantLeg(this._controlRequest),m=this._controlRequest;this._clearControlRequest(),this._raiseControlRequestCanceled(m),this._sendControlRejectRequest(5,g)}if(this._controllerParticipant){const g={inControl:!1,id:this._controllerParticipant.participant.id,terminatedReason:5};this.event("sharingControlChanged").raise(g)}this._finalizeSharerSessionTelemetry("Shutdown"),this._teardownSharerRemoteControl(),this._controlInjector.disableInjector().catch((g=>{const m={reason:0,detail:JSON.stringify({errorMsg:g})};this.event("sharingControlError").raise(m)})),this._resetControlState(),this._resetParticipantSubscriptions(),this._availableAckEnabled=this._enabled,this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}_resetParticipantSubscriptions(){this._logger.info("resetParticipantSubscriptions() Stopping tracking all participant state changes"),(0,Es.each)(this._participantSubscriptions,(g=>{g.dispose()})),this._participantSubscriptions={}}_initiateViewerSessionTelemetry(g,m,f){if(!f&&!m)return null;if(!f&&(0,Es.find)(this._completedViewerSessions,(g=>m===g)))return null;if(this._currentViewerSessionTelemetry){if(this._currentViewerSessionTelemetry.negotiationTag===m)return null;this._finalizeViewerSessionTelemetry("ShutdownByOtherSession")}return this._logger.info(`Initiating new viewer session telemetry for ${m}`),this._currentViewerSessionTelemetry=new Ms(this._logger,(new Date).getTime(),m,this._callId,this._participantId,this._endpointId,g),this._currentViewerSessionTelemetry.recordEvent("CallState",{state:this._callState}),this._isDataChannelActive()&&this._currentViewerSessionTelemetry.recordEvent("DataChannelAvailable"),this._currentViewerSessionTelemetry}_recordViewerSessionTelemetry(g,m=!0){this._currentViewerSessionTelemetry?g&&g(this._currentViewerSessionTelemetry):m&&this._logger.error("Cannot record telemetry without current session")}_finalizeViewerSessionTelemetry(g){if(!this._currentViewerSessionTelemetry)return;this._currentViewerSessionTelemetry.recordEvent(g);const m=this._currentViewerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_viewer_session",m),this._currentViewerSessionTelemetry.negotiationTag&&this._completedViewerSessions.push(this._currentViewerSessionTelemetry.negotiationTag),this._currentViewerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentViewerSessionTelemetry.messagesFromUnknownSender).length&&Ts.RootToolsManager.logExternalForDDL("ScreenSharingControl_viewer: messages received from unkonwn sender",JSON.stringify(m.ProtocolMessages)),this._currentViewerSessionTelemetry=null}_initiateSharerSessionTelemetry(g){if(this._currentSharerSessionTelemetry){if(this._currentSharerSessionTelemetry.negotiationTag===g)return null;this._finalizeSharerSessionTelemetry("ShutdownByOtherSession")}this._logger.info(`Initiating new sharer session telemetry for ${g}`),this._currentSharerSessionTelemetry=new Ds(this._logger,(new Date).getTime(),g,this._callId,this._participantId,this._endpointId),this._isDataChannelActive()&&this._currentSharerSessionTelemetry.recordEvent("DataChannelAvailable")}_recordSharerSessionTelemetry(g,m=!0){this._currentSharerSessionTelemetry?g&&g(this._currentSharerSessionTelemetry):m&&this._logger.error("Cannot record telemetry without current session")}_finalizeSharerSessionTelemetry(g){if(!this._currentSharerSessionTelemetry)return;this._currentSharerSessionTelemetry.recordEvent(g);const m=this._currentSharerSessionTelemetry.getEvent();this._sendTelemetryEvent("mdsc_gtc_sharer_session",m),this._currentSharerSessionTelemetry.messagesFromUnknownSender&&Object.keys(this._currentSharerSessionTelemetry.messagesFromUnknownSender).length&&Ts.RootToolsManager.logExternalForDDL("ScreenSharingControl_sharer: messages received from unkonwn sender",JSON.stringify(m.ProtocolMessages)),this._currentSharerSessionTelemetry=null}_sendTelemetryEvent(g,m){this._logger.info(`Sending event ${g}: `),Object.keys(m).forEach((g=>{this._logger.info(`     ${g} => ${m[g]}`)})),this._telemetryLoggers?.media?.sendEvent({eventName:g,props:m})}_recordProtocolMessage(g,m){this._currentViewerSessionTelemetry&&this._currentViewerSessionTelemetry.recordProtocolMessage(g,m),this._currentSharerSessionTelemetry&&this._currentSharerSessionTelemetry.recordProtocolMessage(g,m)}reportSharingSessionChangeForViewer(g,m){m&&this._initiateViewerSessionTelemetry(g,m,!1)}initControlForViewer(g,m){if(this._logger.info(`initControlForViewer(${scrubMriOrOmit(g?.id)}, ${m})`),!g)return void this._logger.warn("initControlForViewer: Sharer undefined, ignoring");if(this._isViewing()&&this._logger.warn("initControlForViewer: called when already viewing"),3!==this._callState)return this._logger.info(`initControlForViewer: postponed until call is connected, callState=${this._callState}`),this._pendingNegotiationTag=m,void(this._pendingSharer=g);const f=!this._sharerParticipant||this._sharerParticipant&&this._sharerParticipant.id!==g.id||m!==this._currentNegotiationTag;this._currentNegotiationTag=m,this._logger.info(`role is changing from=${this.role} to=2`),this.role=2,this._sharerParticipant?this._sharerParticipant.id!==g.id&&(this._recordViewerSessionTelemetry((g=>g.recordEvent("ShutdownByOtherSession",null,m))),this._logger.info(`initControlForViewer: sharer switched, new sharer id=${scrubMriOrOmit(g.id)}`),this._availableHandshakeSent=!1,4===this.controlState&&this._terminateControl(!1)):(this._logger.info(`initControlForViewer: setting sharer to id=${scrubMriOrOmit(g.id)}`),this._sharerParticipant=g,this._availableHandshakeSent=!1),this._initiateViewerSessionTelemetry(g,m,!0),f&&this._recordViewerSessionTelemetry((g=>g.recordEvent("SharingStarted"))),this._enabled&&this._isDataChannelActive()&&!this._availableHandshakeSent&&(this._resetControlState(),this._sharerParticipant=g,this._logger.info("initControlForViewer: sending Available message to sharer"),this._startAvailableHandshake())}shutdownControlForViewer(g){this._logger.info("shutdownControlForViewer()"),this._pendingSharer=null;let m=!1;if(g&&g.id!==this._sharerParticipant?.id||(this._logger.info(`shutdownControlForViewer: setting shouldShutdownControlForViewer to true, isViewing: ${this._isViewing()}`),m=!0),m&&this._isViewing()){if(1===this.controlState){if(this._sharerParticipant){const g=this._getSharerDataSourceId();this._sendRequest({action:2,terminatedReason:6},g)}else this._logger.warn("shutdownControlForViewer: sharer participant is null");const g={inControl:!1,id:Rs,terminatedReason:6};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:g,details:""}))):this._logger.error("shutdownControlForViewer: Unexpected, no promise could be resolved, controlState=RequestSent")}else if(4===this.controlState){const g={inControl:!1,id:Rs,terminatedReason:6};this.event("sharingControlChanged").raise(g)}this._teardownViewerRemoteControl(),this._resetControlState(),this._screenSharingVideoRenderer=null,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._availableHandshakeSent=!1,this._finalizeViewerSessionTelemetry("Shutdown"),2===this.role?(this._logger.info(`_raiseScreenSharingControlCapableEvent  with user role=${this.role}, MRI=${Rs}, isCapable=false`),this._raiseScreenSharingControlCapableEvent(!1,Rs)):this._logger.warn(`can't call _raiseScreenSharingControlCapableEvent, role=${this.role}`),this._logger.info(`role is changing from=${this.role} to=0`),this.role=0}}_resetControlRequest(g){this._clearControlRequest(),this._controlRequest=g,this._registerParticipantListener(g),3===g.participantState&&(this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${g.participant.id}`),this.event("sharingIncomingControlRequest").raise(g.participant.id))}_clearControlRequest(){this._logger.info("_clearControlRequest()"),this._stopListeningToParticipantChanges(this._controlRequest),this._controlRequest=null}_stopListeningToParticipantChanges(g){this._controlRequestSubscription&&(this._logger.info(`_stopListeningToParticipantChanges: stopping tracking changes for ${g.participant.id}`),this._controlRequestSubscription.dispose(),this._controlRequestSubscription=null)}_registerParticipantListener(g){this._logger.info(`_registerParticipantListener: tracking changes for ${g.participant.id}`),this._logger.info(`request.participantState: ${g.participantState} | request.participant.state: ${g.participant.state}`),this._controlRequestSubscription=g.participant.changed((()=>{if(g.participant.state!==g.participantState)switch(this._logger.info(`request.participantState about to changed from: ${g.participantState} to: ${g.participant.state}`),g.participantState=g.participant.state,g.participantState){case 3:this.event("sharingIncomingControlRequest").raise(g.participant.id),this._logger.info(`participantState: Connected, raising: sharingIncomingControlRequest for participantId: ${g.participant.id}`);break;case 0:case 5:case 4:this.denyControlRequest().catch((g=>{this._logger.info(`It is ok if denyControlRequest rejects here as screensharing may have just been stopped. Err: ${g}`)})),this._logger.info(`_registerParticipantListener: participant ${g.participant.id} is no longer connected. resetting`),this._clearControlRequest(),this._raiseControlRequestCanceled(g);break;case 1:case 2:case 6:case 7:this._logger.info(`participantState: ${g.participantState}, participantId: ${g.participant.id}`);break;default:this._logger.error(`_registerParticipantListener: Unexpected participantState ${g.participantState} unhandled`)}}))}_resetControllerParticipant(g){this._controllerParticipantSubscription&&(this._logger.info(`_resetControllerParticipant: stopping tracking changes for ${this._controllerParticipant.participant.id}`),this._controllerParticipantSubscription.dispose(),this._controllerParticipantSubscription=null),g&&(this._logger.info(`_resetControllerParticipant: tracking changes for ${g.participant.id}`),this._controllerParticipantSubscription=g.participant.changed((()=>{3!==g.participant.state&&this.handleParticipantRemoved(g.participant.id)}))),this._controllerParticipant=g}handleParticipantRemoved(g){if(this._participantSubscriptions[g]&&(this._logger.info(`handleParticipantRemoved(): Stopping tracking state changes for ${g}`),this._participantSubscriptions[g].dispose(),delete this._participantSubscriptions[g]),this._isSharing()){if(this._controllerParticipant&&this._controllerParticipant.participant.id===g){this._logger.info("handleParticipantRemoved: controller left call, tearing down control session"),this._teardownSharerRemoteControl(),this.controlState=0,this._resetControllerParticipant();const m={inControl:!1,id:g,terminatedReason:5};this.event("sharingControlChanged").raise(m)}this._raiseScreenSharingControlCapableEvent(!1,g)}else if(this._sharerParticipant&&this._sharerParticipant.id===g&&4===this.controlState){this._logger.info("handleParticipantRemoved: sharer left call, tearing down control session"),this._teardownViewerRemoteControl(),this.controlState=0;const g={inControl:!1,id:Rs,terminatedReason:6};this.event("sharingControlChanged").raise(g)}}callStateChanged(g){this._callState=g,this._recordViewerSessionTelemetry((m=>m.recordEvent("CallState",{state:g})),!1),this._recordSharerSessionTelemetry((m=>m.recordEvent("CallState",{state:g})),!1),this.isScreenSharingControlEnabled()&&this._handleCallState(g)}setIsEscalationInProgress(g){this.isEscalationInProgress=g}_getHandshakeDelay(){if(!this._config.handshakeSendDelay?.minParticipantThreshold)return 0;let g=0;if(this._call.participants.length>=this._config.handshakeSendDelay.minParticipantThreshold)for(const m of this._call.participants)m.endpoints?.endpointDetails.some((g=>"interactive"===g.appliedInteractivityLevel))&&g++;if(g<=this._config.handshakeSendDelay.minParticipantThreshold)return 0;const m=Math.ceil((g-this._config.handshakeSendDelay.minParticipantThreshold)/this._config.handshakeSendDelay.increaseEveryN);return Math.min(this._config.handshakeSendDelay.maxDelay,m*this._config.handshakeSendDelay.delayPerN)}_handleCallState(g){switch(g){case 3:this._handleCallConnected();break;case 7:this._handleCallDisconnected();break;case 4:case 5:this.shutdownControlForViewer()}}_handleCallConnected(){this._logger.info("_handleCallConnected()"),this._pendingSharer&&(this.initControlForViewer(this._pendingSharer,this._pendingNegotiationTag),this._pendingSharer=null)}_handleCallDisconnected(){this._logger.info("_handleCallDisconnected()"),this._isSharing()?this.shutdownControlForSharer():this.shutdownControlForViewer()}_videoSizeChanged(g,m){null!==this._controlCapturer&&this._controlCapturer.updateVideoSize(g,m)}_onRenderStarted(){const g={action:11,terminatedReason:0};if(this._sharerParticipant){const m=this._getSharerDataSourceId();this._sendRequest(g,m)}else this._logger.error("Attempted to send sharing rendered message to null sharerParticipant")}_setViewingRenderer(g,m){try{this._screenSharingVideoRenderer=g,this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeVideoSizeChangedEvent(this._screenSharingVideoRenderer,((g,m)=>{this._videoSizeChanged(g,m)}))),this._screenSharingVideoRendererSubscriptions.push(this._rendererAdapter.subscribeRenderStartedEvent(this._screenSharingVideoRenderer,(()=>{this._onRenderStarted()})));let f=1;g.streamSize&&g.streamSize.width>0&&g.streamSize.height>0&&(f=g.streamSize.width/g.streamSize.height),this._controlCapturer=new _s.SlimCoreElectronControlCapturer(this._logger,m,!0,f),4===this.controlState?(this._logger.info("_setViewingRenderer: detected local state is controlling"),this._setupViewerRemoteControl()):this._teardownViewerRemoteControl()}catch(g){this._logger.error(`_setViewingRenderer: unable to set _screenSharingVideoRenderer error=${g}`)}}_onDataChannelStatusChanged(g){this._logger.info(`_onDataChannelStatusChanged(): Data channel status=${g}, isEscalationInProgress=${this.isEscalationInProgress}`),g?this._dataChannelAvailable||(this._dataChannelAvailable=!0,this._recordViewerSessionTelemetry((g=>g.recordEvent("DataChannelAvailable")),!1),this._recordSharerSessionTelemetry((g=>g.recordEvent("DataChannelAvailable")),!1),this._enabled&&(this._isViewing()?this._availableHandshakeSent||(this._sharerParticipant?(this._logger.info("_onDataChannelStatusChanged: sending Available message to sharer"),this._startAvailableHandshake()):this._logger.error("Unexpected null _sharerParticipant trying to send Available to sharer")):this._isSharing()&&(this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!0,Rs)))):this._dataChannelAvailable&&(this._recordViewerSessionTelemetry((g=>g.recordEvent("DataChannelUnavailable")),!1),this._recordSharerSessionTelemetry((g=>g.recordEvent("DataChannelUnavailable")),!1),this._dataChannelAvailable=!1,this._availableHandshakeSent=!1,this._terminateAvailableHandshake&&this._terminateAvailableHandshake(3),this.isEscalationInProgress||this._raiseScreenSharingControlCapableEvent(!1,Rs))}_isSharing(){return 1===this.role}_isViewing(){return 2===this.role}_handleAvailableRequest(g,m,f){let S=!1,v=0;if(this._enabled)if(this._availableAckEnabled)if(this._canEnableGiveControl())if(m?.id){if(this._allowControlForUser&&typeof this._allowControlForUser==typeof Function)return void this._allowControlForUser(m).then((C=>{C||(S=!0,v=1),this._sendResponseToAvailableRequest(g,m,f,S,v)}))}else S=!0,v=10;else this._logger.info("GiveControl is not enabled. no need to answer the available ack"),S=!0,v=9;else this._logger.info("Available ack is off. no need to answer the available ack"),S=!0,v=9;else this._logger.info("Feature flag is off. no need to answer the available ack"),S=!0,v=9;this._sendResponseToAvailableRequest(g,m,f,S,v)}_sendResponseToAvailableRequest(g,m,f,S,v){S?(this._logger.info(`Rejecting Available for handShake:${f}:${g.handshakeId}`),this.event("controlAvailableHandshake").raise(g.handshakeId,f,7,this._getAvailableHandshakeTerminatedFromControlTerminated(v)),this._sendRequest({action:10,terminatedReason:v,handshakeId:g.handshakeId},f)):(this._raiseScreenSharingControlCapableEvent(!0,m.id),this._participantSubscriptions[m.id]||(this._logger.info(`Tracking participant status for ${m.id}`),this._participantSubscriptions[m.id]=m.changed((()=>{3!==m.state&&(this._logger.info(`Participant ${m.id} is not connected. removing`),this.handleParticipantRemoved(m.id))}))),this._logger.info(`Acking Available for handShake:${f}:${g.handshakeId}`),this.event("controlAvailableHandshake").raise(g.handshakeId,f,3),this._sendRequest({action:9,terminatedReason:0,handshakeId:g.handshakeId},f))}processProtocolMessage(g,m,f,S){return asap((()=>{this._processProtocolMessage(g,m,f,S)}))}_raiseControlRequestCanceled(g){this.event("sharingIncomingControlRequestCancelled").raise(g.participant.id)}_handleControlRequest(g,m,f){this._recordSharerSessionTelemetry((g=>{g.recordOperation("ControlRequest",null,String(m))})),this._enabled?this._controlRequest?(this._logger.warn("Sharer is already processing a control request...rejecting new requests"),this._sendControlRejectRequest(3,m)):this._controllerParticipant&&this._controllerParticipant.participant===g?this._controllerParticipant.participantId&&this._controllerParticipant.participantId!==f?(this._logger.warn(`rejecting control request from second endpoint. participantId: ${f}`),this._sendControlRejectRequest(3,m)):(this._logger.warn("Got control request for someone already in control"),this._resetControllerParticipant(),this._resetControlRequest({participant:g,participantState:g.state,participantId:f})):g?(this._logger.info(`resetControlRequest for participantId: ${f}`),this._resetControlRequest({participant:g,participantState:g.state,participantId:f})):this._logger.error("Got ControlRequest message but could not find a sender participant, ignoring"):(this._logger.warn("Sharer control is disabled - rejecting request"),this._sendControlRejectRequest(9,m))}_handleAcceptRequest(g,m){if(1===this.controlState){const f=this._sendRequest({action:5,terminatedReason:0},m);this._logger.info(`_handleAcceptRequest controlMessage.action: ${toControlActionString(g.action)} _sendRequest isSent: ${f}`),f?(this._setupViewerRemoteControl(),this.controlState=4,this._requestControlPromise?this._requestControlPromise.resolve():this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${toControlActionString(g.action)}`),this._recordViewerSessionTelemetry((g=>{g.recordOperationSuccess("ControlRequest",null)}))):this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control is accepted, but failed to send ack"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)} action=${toControlActionString(g.action)}`),this._cancelRequestControlTimer()}else this._logger.warn(`AcceptRequest message received in controlState=${toControlStateString(this.controlState)}`)}_handleRejectRequest(g){if(1===this.controlState){this._logger.info(`_handleRejectRequest: controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0;const m={inControl:!1,id:Rs,terminatedReason:g.terminatedReason};this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:m,details:""}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=RequestSent action=${toControlActionString(g.action)}`),this._recordViewerSessionTelemetry((m=>{m.recordOperationFailure("ControlRequest",{reason:toControlTerminatedReason(g.terminatedReason)})})),this._cancelRequestControlTimer()}else this._logger.warn(`RejectRequest message received in controlState=${toControlStateString(this.controlState)} reason=${g.terminatedReason}`)}_handleCancelControlRequest(g,m){if(this._logger.info(`_handleCancelControlRequest action=${toControlActionString(g.action)} sender=${m}, controlRequest participantId: ${this._controlRequest.participantId}, controlRequest participantState: ${this._controlRequest.participantState}:`),this._controlRequest){const f=this._controlRequest;this._logger.info(`_handleCancelControlRequest action=${toControlActionString(g.action)} sender=${m}, about to raise: _raiseControlRequestCanceled state: ${this._controlRequest.participantState} `),this._recordSharerSessionTelemetry((g=>{g.recordOperationTimeout("ControlRequest",{participantId:m},String(m))})),this._clearControlRequest(),this._raiseControlRequestCanceled(f)}}_handleGiveControl(g,m,f){const S=this._sendRequest({action:5,terminatedReason:0},m);if(this._logger.info(`_handleGiveControl: controlMessage.action: ${toControlActionString(g.action)} _sendRequest isSent: ${S}`),S){this._setupViewerRemoteControl(),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(4)}`),this.controlState=4,this._recordViewerSessionTelemetry((g=>{g.recordEvent("ControlGiven",{sender:m})}));const f={inControl:!0,id:Rs,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(f)}}_handleAck(g,m,f){if(2===this.controlState)if(this._controllerParticipant&&this._controllerParticipant.participant===m){const m=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);f!==m&&this._logger.warn(`acknowledging source id: ${f} does not match requesting source id: ${m}`),this._logger.info(`Setting up remote control for controller source id=${m}`),this._setupSharerRemoteControl(m),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(3)}`),this.controlState=3;const S={inControl:!0,id:this._controllerParticipant.participant.id,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(S),this._grantControlPromise?(this._grantControlPromise.resolve(),this._cancelGrantControlTimer(),this._recordSharerSessionTelemetry((g=>{g.recordOperationSuccess("GiveControl",{participantId:m})}))):this._acceptControlPromise?(this._acceptControlPromise.resolve(),this._cancelAcceptControlTimer(),this._recordSharerSessionTelemetry((g=>{g.recordOperationSuccess("ControlRequest",{participantId:m},String(m))}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForControlAck action=${toControlActionString(g.action)}`)}else m?this._logger.warn(`Ignoring ack from participant that does not match controller id=${scrubMriOrOmit(m.id)}`):this._logger.warn(`Ignoring ack from null participant source id=${f}`);else 5===this.controlState?(this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0,this._resetControllerParticipant(),this._terminateControlPromise?(this._terminateControlPromise.resolve(),this._cancelTerminateControlTimer()):this._logger.error(`Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck action=${toControlActionString(g.action)}`)):this._logger.warn(`Unexpected ack in control controlState=${toControlStateString(this.controlState)}`)}_handleTerminate(g,m,f){let S;this._isViewing()?(this._teardownViewerRemoteControl(),S=Rs):(this._teardownSharerRemoteControl(),m?S=m.id:this._logger.error("Got terminate message but could not find a sender participant!")),this._logger.info(`controlMessage action: ${toControlActionString(g.action)}, controllerId: ${S}`),this._logger.info(`controlState: ${toControlStateString(this.controlState)}, about to be changed to: ${toControlStateString(0)}`),this.controlState=0,this._resetControllerParticipant();const v={inControl:!1,id:S,terminatedReason:g.terminatedReason};this.event("sharingControlChanged").raise(v),8===g.action&&this._sendRequest({action:5,terminatedReason:0},f)}_handleAvailableAck(g){this._terminateAvailableHandshake&&(this._logger.info(`_handleAvailableAck: terminate available handshake reason: 1,handshakeId: ${g.handshakeId}`),this._terminateAvailableHandshake(1,g.handshakeId)),2===this.role?this._raiseScreenSharingControlCapableEvent(!0,Rs):this._logger.info(`Ignoring AvailableAck as viewer session is not initialized, role: ${this.role}`)}_handleAvailableNack(g){this._logger.info(`_handleAvailableNack: action=${toControlActionString(g.action)} terminate reason: ${toControlTerminatedReason(g.terminatedReason)}`),this._viewerSessionLastTerminatedReason=g.terminatedReason,this._recordViewerSessionTelemetry((m=>{m.updateOperationData("AvailableHandshake",{nackReason:g.terminatedReason},g.handshakeId)})),10!==g.terminatedReason?(this._terminateAvailableHandshake&&(this._terminateAvailableHandshake(this._getAvailableHandshakeTerminatedFromControlTerminated(g.terminatedReason),g.handshakeId),this._logger.info(`_handleAvailableNack: terminateAvailableHandshake reason=${toControlTerminatedReason(g.terminatedReason)}`)),1===g.terminatedReason?(this._logger.warn("_handleAvailableNack: control terminate reason: SharerDenied"),this._raiseScreenSharingControlCapableEvent(!0,Rs,!0)):this._raiseScreenSharingControlCapableEvent(!1,Rs)):this._logger.warn("_handleAvailableNack: control terminate reason: UnknownSender")}_handleRenderedAtViewer(g,m){this._raiseRenderedAtViewer&&(m?(this._logger.info(`raiseRenderedAtViewer senderId=${m.id}, action=${toControlActionString(g.action)}`),this._raiseRenderedAtViewer(m.id)):this._logger.error("Got RenderedAtViewer message but could not find a sender participant!"))}_processProtocolMessage(g,m,f,S){let v;this._recordProtocolMessage(m,S);try{v=JSON.parse(g)}catch(g){return void this._logger.error("Error parsing controlMessage")}switch(m||this._logger.warn(`protocol message from unknown sender with sourceId=${S}`),this._logger.info(`_processProtocolMessage action=${toControlActionString(v.action)}, sourceId=${S}`),v.action){case 0:this._handleAvailableRequest(v,m,S);break;case 1:this._handleControlRequest(m,S,f);break;case 3:this._handleAcceptRequest(v,S);break;case 4:this._handleRejectRequest(v);break;case 2:this._handleCancelControlRequest(v,S);break;case 6:this._handleGiveControl(v,S,m);break;case 5:this._handleAck(v,m,S);break;case 8:case 7:this._handleTerminate(v,m,S);break;case 9:this._handleAvailableAck(v);break;case 10:this._handleAvailableNack(v);break;case 11:this._handleRenderedAtViewer(v,m);break;default:this._logger.error(`Unknown request action received on control protocol data sink, action=${toControlActionString(v.action)}`)}}_getAvailableHandshakeTerminatedFromControlTerminated(g){switch(g){case 10:return 6;case 1:return 7;default:return 0}}_sendRequest(g,m){if(m<0)return this._logger.warn(`Unexpected: invalid sourceID=${m}`),!1;this._logger.info(`_sendRequest() action=${toControlActionString(g.action)} recipient sourceid=${m}`);const f={type:0,message:JSON.stringify(g)},S=[m];return this._dataChannelAdapter.sendProtocolMessage(stringToBuffer(JSON.stringify(f)),S),!0}async processControlMessage(g,m){if(m===this._controllerSourceId){if(3===this.controlState)return this._processControlMessage(g,m);this._logger.debug(`Ignoring control message, wrong controlState. Expected: RemoteControlling, got: ${toControlStateString(this.controlState)}`)}else this._logger.debug(`Ignoring control message, wrong sourceId. Expected: ${m}, got: ${this._controllerSourceId}`)}_processControlMessage(g,m){return this._controlInjector.injectRawInput(g,m)}_resetControlState(){this._logger.info("_resetControlState()"),this.controlState=0,this._resetControllerParticipant(),this._sharerParticipant=null,this._clearControlRequest(),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer()}_setupSharerRemoteControl(g){this._logger.info(`_setupSharerRemoteControl() sourceId=${g}`),this._controllerSourceId=g,this._controlInjector.showVirtualCursor(g).catch((m=>{const f={reason:3,detail:JSON.stringify({sourceId:g,errorMsg:m})};this.event("sharingControlError").raise(f)}))}_teardownSharerRemoteControl(){this._logger.info("_teardownSharerRemoteControl()"),this._controllerSourceId=null,this._controlInjector.showVirtualCursor(0).catch((g=>{const m={reason:3,detail:JSON.stringify({sourceId:0,errorMsg:g})};this.event("sharingControlError").raise(m)}))}_setupViewerRemoteControl(){this._logger.info("_setupViewerRemoteControl()"),this._setCapturerMode(3)}_teardownViewerRemoteControl(){this._logger.info("_teardownViewerRemoteControl()"),this._setCapturerMode(0)}_clearCapturerEventSubscriptions(){this._logger.info("_clearCapturerEventSubscriptions()"),this._captureEventSubscription&&(this._captureEventSubscription.dispose(),this._captureEventSubscription=null),this._mouseControlEventSubscription&&(this._mouseControlEventSubscription.dispose(),this._mouseControlEventSubscription=null),this._keyboardControlEventSubscription&&(this._keyboardControlEventSubscription.dispose(),this._keyboardControlEventSubscription=null)}sendRemoteControlEvent(g,m){if(m)switch(g){case"mouseControlEvent":this._sendControlEvent(rs.encodeMouseEvent(m));break;case"keyboardControlEvent":this._sendControlEvent(rs.encodeKeyboardEvent(m));break;default:return void this._logger.error("sendRemoteControlEvent: Invalid type=",g)}else this._logger.error("sendRemoteControlEvent: Invalid argument.")}_sendControlEvent(g){if(!this._isDataChannelActive()||!this._sharerParticipant||4!==this.controlState)return void this._logger.error(`_sendControlEvent: Dropping message - No data channel or wrong controlState. dataConnected: ${this._isDataChannelActive()} controlState: ${toControlStateString(this.controlState)})`);const m=[this._getSharerDataSourceId()];this._dataChannelAdapter.sendControlMessage(g,m)}_setCapturerMode(g){this._logger.info(`_setCapturerMode() capturerMode=${g}`),this._controlCapturer?(this._controlCapturer.setCaptureMode(g),this._clearCapturerEventSubscriptions(),1===g?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{0===g&&this.event("sharingRendererClicked").raise()})):2===g?this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{1===g?this.event("sharingRendererMouseEntering").raise():2===g&&this.event("sharingRendererMouseLeaving").raise()})):3===g&&(this._mouseControlEventSubscription=this._controlCapturer.on("mouseControlEvent",(g=>{this._sendControlEvent(rs.encodeMouseEvent(g))})),this._keyboardControlEventSubscription=this._controlCapturer.on("keyboardControlEvent",(g=>{this._sendControlEvent(rs.encodeKeyboardEvent(g))})),this._captureEventSubscription=this._controlCapturer.on("ctrlCaptureEvent",(g=>{1===g?this.event("sharingRendererMouseEntering").raise():2===g&&this.event("sharingRendererMouseLeaving").raise()})))):this._logger.info("_controlCapturer not set, relying on external controlCapturer")}setPointerImage(g,m){return this._logger.warn("setPointerImage is deprecated. Use setLocalPointerImage or setRemotePointerImage"),g?this.setRemotePointerImage(g,m):this.setLocalPointerImage(m)}setLocalPointerImage(g){return 0===g.length?Promise.reject(new Error("setLocalPointerImage invalid image length")):this._setPointerImage(0,g)}async setRemotePointerImage(g,m){if(!g)throw new Error("setRemotePointerImage participant is null");if(0===m.length)throw new Error("setRemotePointerImage invalid image length");const f=this._getParticipantsDataSourceIds(g);if(0===f.length)throw new Error("setRemotePointerImage unable to map participant to sourceIds");this._logger.info(`set pointer image for ${f.length} sources`);for(const g of f)await this._setPointerImage(g,m)}_setPointerImage(g,m){return this._isSharing()||this._logger.warn("_setPointerImage called when not sharing"),this._controlInjector.setPointerImage(g,m)}startPointerMode(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`startPointerMode called in bad control controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?asap((()=>{this._setCapturerMode(2)})):Promise.reject(new Error("startPointerMode when not viewing")):Promise.reject(new Error("startPointerMode when data channel not active")):Promise.reject(new Error("startPointerMode when feature not enabled"))}stopPointerMode(){return 0!==this.controlState?Promise.reject(new Error(`stopPointerMode called in bad control controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?asap((()=>{this._setCapturerMode(1)})):Promise.reject(new Error("stopPointerMode when not viewing"))}_startAvailableHandshake(){const g=this._getSharerDataSourceId(),m=generateGuid(),f=this._getHandshakeDelay(),S=Math.floor(Math.random()*f);if(this._logger.info(`_startAvailableHandshake() - handshakeId: ${g}:${m} ${S>0?`delay: ${S}ms maxDelay: ${f}ms`:""}}`),this._terminateAvailableHandshake&&(this._logger.warn("Replacing existing availble handshake"),this._terminateAvailableHandshake(4)),this._recordViewerSessionTelemetry((g=>g.recordOperation("AvailableHandshake",m))),g<0)this._logger.warn(`_startAvailableHandshake() - sharer: ${scrubMriOrOmit(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(m);else{const sendAvailableHandshake=()=>{this.event("controlAvailableHandshake").raise(m,g,1);this._sendRequest({action:0,terminatedReason:0,handshakeId:m},g)||this._logger.error("Failed to send Available message to sharer, will retry after backoff"),this._waitForAvailableAck(m)};S>0?(this._delayedSendHandshakeTimer=window.setTimeout(sendAvailableHandshake,S),this._recordViewerSessionTelemetry((g=>{g.updateOperationData("AvailableHandshake",{delay:S,maxDelay:f},m)}))):sendAvailableHandshake()}this._availableHandshakeSent=!0,this._terminateAvailableHandshake=(f=0,S)=>{this._logger.info(`_terminateAvailableHandshake() - handshakeId: ${g}:${m}, status: ${f}`),this._recordViewerSessionTelemetry((g=>{g.updateOperationData("AvailableHandshake",{tries:this._retryAttempt},S)})),1===f?this._recordViewerSessionTelemetry((g=>{g.recordOperationSuccess("AvailableHandshake",null,"",S)})):(this._logger.error(`GTC handshake terminated with code ${f}, last terminated reason: ${toControlTerminatedReason(this._viewerSessionLastTerminatedReason)}`),Ts.RootToolsManager.logExternalForDDL(`GTC handshake terminated with code ${f},`,this._viewerSessionLastTerminatedReason.toString()),this._recordViewerSessionTelemetry((g=>{g.recordOperationFailure("AvailableHandshake",{reason:f},"",S)}))),this._terminateAvailableHandshake=null,this.event("controlAvailableHandshake").raise(m,g,1===f?5:6,f),S&&S!==m&&this._logger.warn(`AvailableSeries: Got handshake from another series - expected: ${m}, received: ${S}`),this._availableAckTimer&&(clearTimeout(this._availableAckTimer),this._availableAckTimer=null),this._delayedSendHandshakeTimer&&(clearTimeout(this._delayedSendHandshakeTimer),this._delayedSendHandshakeTimer=null),this._retryAttempt=0}}_waitForAvailableAck(g){this._logger.info("_waitForAvailableAck()"),this._availableAckTimer=window.setTimeout((()=>{this._logger.warn(`No Ack received for Available message from attempt=${this._retryAttempt}`),this._availableAckTimer=null;const m=this._getSharerDataSourceId();if(this._retryAttempt<=Ps)m>=0?(this._logger.info(`Re-sending Available message handshakeId: ${m}:${g}`),this.event("controlAvailableHandshake").raise(g,m,2),this._sendRequest({action:0,terminatedReason:0,handshakeId:g},m)):this._logger.warn(`_waitForAvailableAck() - sharer: ${scrubMriOrOmit(this._sharerParticipant?.id)} has no data channel, retrying later`),this._waitForAvailableAck(g);else if(this._logger.error("Reached Available retry limit! Control capability will be false"),this._terminateAvailableHandshake)this._terminateAvailableHandshake(5);else{const g={reason:4,detail:JSON.stringify({sourceId:m,errorMsg:`Timed out after ${this._retryAttempt} tries`})};this.event("sharingControlError").raise(g)}}),As*++this._retryAttempt)}requestControl(){return this._enabled?this._isDataChannelActive()?0!==this.controlState?Promise.reject(new Error(`requestControl called in bad controlState=${toControlStateString(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?Promise.reject(new Error("request control promise has not been resolved yet while requesting control")):this._terminateControlPromise?Promise.reject(new Error("terminate control promise has not been resolved yet while requesting control")):this._requestControl():Promise.reject(new Error("requestControl unexpected null sharer")):Promise.reject(new Error("requestControl when not viewing")):Promise.reject(new Error("requestControl when data channel not active")):Promise.reject(new Error("requestControl when feature not enabled"))}_requestControl(){this._logger.info(`_requestControl(), controlState: ${this.controlState}`),this._requestControlPromise=defer();const always=()=>{this._requestControlPromise=null};this._requestControlPromise.promise.then(always,always);const g=this._getSharerDataSourceId();if(!this._sendRequest({action:1,terminatedReason:0},g)){const g={inControl:!1,id:Rs,terminatedReason:7};return this._requestControlPromise.reject(new Error),this._logger.error("_requestControl(): failed to send the request."),Promise.reject(new Error(JSON.stringify({controlInfo:g,details:""})))}return this._recordViewerSessionTelemetry((g=>g.recordOperation("ControlRequest",""))),this.controlState=1,this._requestControlTimer=window.setTimeout((()=>{if(1===this.controlState){this.controlState=0,this._logger.warn("No response to control request - canceling");this._sendRequest({action:2,terminatedReason:2},g)||this._logger.error("Failed to send the cancel control request");const m={inControl:!1,id:Rs,terminatedReason:2};this._recordViewerSessionTelemetry((g=>{g.recordOperationTimeout("ControlRequest",null)})),this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:m,details:"we did not get any response to the control - terminating control"}))):this._logger.error("Unexpected, no promise could be resolved - controlState=RequestSent")}else this._requestControlPromise?this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:void 0,details:"request control - times out in bad state - do nothing"}))):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._requestControlTimer=null}),Is),this._requestControlPromise.promise}_cancelRequestControlTimer(){this._requestControlTimer&&(this._requestControlPromise&&this._requestControlPromise.reject(new Error("cancelled by _cancelRequestControlTimer")),clearTimeout(this._requestControlTimer),this._requestControlTimer=null)}cancelControl(){return this._enabled?this._isDataChannelActive()?1!==this.controlState?Promise.reject(new Error(`cancelControl called in bad state=${toControlStateString(this.controlState)}`)):this._isViewing()?this._sharerParticipant?this._requestControlPromise?this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while cancelling control")):this._cancelControl():Promise.reject(new Error("Request control promise has been resolved while cancelling control")):Promise.reject(new Error("cancelControl unexpected null sharer")):Promise.reject(new Error("cancelControl when not viewing")):Promise.reject(new Error("cancelControl when data channel not active")):Promise.reject(new Error("cancelControl when feature not enabled"))}_cancelControl(){this._logger.info("_cancelControl()");const g=this._getSharerDataSourceId();if(1!==this.controlState)return Promise.reject(new Error("Cancel control - in bad state - do nothing"));this._cancelRequestControlTimer(),this.controlState=0,this._logger.info("Viewer cancels the control");if(!this._sendRequest({action:2,terminatedReason:8},g))return Promise.reject(new Error("Failed to send cancel control request"));{const g={inControl:!1,id:Rs,terminatedReason:8};this._recordViewerSessionTelemetry((m=>{m.recordOperationFailure("ControlRequest",{reason:toControlTerminatedReason(g.terminatedReason)})})),this._requestControlPromise.reject(new Error(JSON.stringify({controlInfo:g,details:""})))}return new Promise(((g,m)=>{g()}))}acceptControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while accepting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while accepting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while accepting control")):this._acceptControlRequest():Promise.reject(new Error("acceptControlRequest when not sharing")):Promise.reject(new Error("acceptControlRequest while no control request pending")):Promise.reject(new Error("acceptControlRequest when data channel not active")):Promise.reject(new Error("acceptControlRequest when feature not enabled"))}_acceptControlRequest(){this._logger.info("_acceptControlRequest()"),this._acceptControlPromise=defer();const always=()=>{this._acceptControlPromise=null};if(this._acceptControlPromise.promise.then(always,always),this._controllerParticipant){this._logger.warn("_acceptControlRequest called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const g=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},g)||this._logger.error("Failed to send the terminateNoAck request"),this._resetControllerParticipant()}const g=this._getDataSourceIdForParticipantLeg(this._controlRequest),m=this._controlRequest.participant.id;return this._sendControlAcceptRequest(g)?(this._resetControllerParticipant(this._controlRequest),this._clearControlRequest(),this.controlState=2,this._acceptControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._recordSharerSessionTelemetry((m=>{m.recordOperationTimeout("ControlRequest",{participantId:g},String(g))})),this._logger.error("No ack received when accepting control request - terminating control");this._sendRequest({action:7,terminatedReason:4},g)||this._logger.error("Failed to send the TerminateNoAck request");const f={inControl:!1,id:m,terminatedReason:4};this.event("sharingControlChanged").raise(f),this._acceptControlPromise?this._acceptControlPromise.reject(new Error("No ack received when accept control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._acceptControlPromise?this._acceptControlPromise.reject(new Error("accept control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._acceptControlTimer=null}),bs),this._acceptControlPromise.promise):(this._logger.error("Failed to send the accept control request"),this._acceptControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the accept control request!")))}_sendControlAcceptRequest(g){const m=this._sendRequest({action:3,terminatedReason:0},g);return this._recordSharerSessionTelemetry((m=>{m.updateOperationData("ControlRequest",{status:"accepting",participantId:g},null,String(g))})),m}_sendControlRejectRequest(g,m){const f=this._sendRequest({action:4,terminatedReason:g},m);return this._recordSharerSessionTelemetry((f=>{f.recordOperationFailure("ControlRequest",{participantId:m,reason:toControlTerminatedReason(g)},String(m))})),f}_cancelAcceptControlTimer(){this._acceptControlTimer&&(this._acceptControlPromise&&this._acceptControlPromise.reject(new Error("cancelled by _cancelAcceptControlTimer")),clearTimeout(this._acceptControlTimer),this._acceptControlTimer=null)}denyControlRequest(){return this._enabled?this._isDataChannelActive()?this._controlRequest?this._isSharing()?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while denying control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while denying control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while denying control")):this._denyControlRequest():Promise.reject(new Error("denyControlRequest when not sharing")):Promise.reject(new Error("denyControlRequest while no control request pending")):Promise.reject(new Error("denyControlRequest when data channel not active")):Promise.reject(new Error("denyControlRequest when feature not enabled"))}_denyControlRequest(){this._logger.info("_denyControlRequest()");const g=this._getDataSourceIdForParticipantLeg(this._controlRequest);this._clearControlRequest();return this._sendControlRejectRequest(1,g)?Promise.resolve():Promise.reject(new Error("Failed to send the deny control requst"))}grantControl(g){return this._enabled?this._isDataChannelActive()?this._controlRequest?Promise.reject(new Error("grantControl called while control request pending")):this._isSharing()?g?this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while granting control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while granting control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while granting control")):this._grantControl(g):Promise.reject(new Error("grantControl null participant")):Promise.reject(new Error("grantControl when not sharing")):Promise.reject(new Error("grantControl when data channel not active")):Promise.reject(new Error("grantControl when feature not enabled"))}_grantControl(g){this._logger.info("_grantControl()"),this._grantControlPromise=defer();const always=()=>{this._grantControlPromise=null};if(this._grantControlPromise.promise.then(always,always),3===this.controlState){if(this._controllerParticipant.participant===g)return this._logger.warn("_grantControl called for participant who already has control"),this._grantControlPromise.resolve(),new Promise(((g,m)=>{g()}));{this._logger.warn("_grantControl called while another participant already has control - terminating control"),this._teardownSharerRemoteControl();const g=this._getDataSourceIdForParticipantLeg(this._controllerParticipant);this._sendRequest({action:7,terminatedReason:5},g)||this._logger.error("Failed to send the terminateNoAck request")}}const m=this._mapParticipantToSourceId(g),f=this._sendRequest({action:6,terminatedReason:0},m);if(this._recordSharerSessionTelemetry((g=>{g.recordOperation("GiveControl",null)})),!f)return this._logger.error("Failed to send the grant control request"),this._grantControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));const S=this._getParticipantIdForDataSourceId(g,m);return this._resetControllerParticipant({participant:g,participantState:g.state,participantId:S}),this.controlState=2,this._grantControlTimer=window.setTimeout((()=>{if(2===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when granting control - terminating control");this._sendRequest({action:7,terminatedReason:4},m)||this._logger.error("Failed to send the terminateNoAck request"),this._recordSharerSessionTelemetry((g=>{g.recordOperationTimeout("GiveControl",null)})),this._grantControlPromise?this._grantControlPromise.reject(new Error("No ack received when granting control - terminating control")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForControlAck")}else this._grantControlPromise?this._grantControlPromise.reject(new Error("Grant control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._grantControlTimer=null}),bs),this._grantControlPromise.promise}_cancelGrantControlTimer(){this._grantControlTimer&&(this._grantControlPromise&&this._grantControlPromise.reject(new Error("cancelled by _cancelGrantControlTimer")),clearTimeout(this._grantControlTimer),this._grantControlTimer=null)}_mapParticipantToSourceId(g){return this._dataChannelAdapter.isActive()?getSourceIdForMediaType(g,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getParticipantsDataSourceIds(g){const m=[];try{if(g?.endpoints?.endpointDetails){if(1===g.endpoints.endpointDetails.length){const f=g.endpoints.endpointDetails[0];if(!f?.mediaStreams)return m.push(li),m}for(const f of g.endpoints.endpointDetails)if(f?.mediaStreams)for(const g of f.mediaStreams)if(3===mapMediaTypeStringToMediaType(g.type)){if(m.push(g.sourceId),m.length>=8)return this._logger.error("Excessive amount of data streams"),m;break}}}catch(g){this._logger.error(`_getParticipantsDataSourceIds caught exception error=${g}`)}return m}_getParticipantIdForDataSourceId(g,m){return getParticipantIdForSourceId(g,3,m)}_getDataSourceIdForParticipantId(g,m){return this._dataChannelAdapter.isActive()?getSourceId(g,m,3):(this._logger.error("Null data channel cannot map participant to source id"),-1)}_getDataSourceIdForParticipantLeg(g){return this._getDataSourceIdForParticipantId(g.participant,g.participantId)}_getSharerDataSourceId(){const g=getSharingParticipantLeg(this._sharerParticipant);return g?this._getDataSourceIdForParticipantId(this._sharerParticipant,g):(this._logger.warn("Unable to identify the sharer participantId, falling back to first data channel"),this._mapParticipantToSourceId(this._sharerParticipant))}terminateControl(){if(this._isViewing()){if(4!==this.controlState)return Promise.reject(new Error("terminateControl called while not in control"));if(!this._sharerParticipant)return Promise.reject(new Error("terminateControl called but _sharerParticipant is null"))}else{if(!this._isSharing())return Promise.reject(new Error("terminateControl called but not sharing nor viewing"));if(!this._controllerParticipant)return Promise.reject(new Error("terminateControl called but controllerParticipant is null"))}return this._requestControlPromise?Promise.reject(new Error("Request control promise has not been resolved yet while terminating control")):this._acceptControlPromise?Promise.reject(new Error("Accept control promise has not been resolved yet while terminating control")):this._grantControlPromise?Promise.reject(new Error("Grant control promise has not been resolved yet while terminating control")):this._terminateControlPromise?Promise.reject(new Error("Terminate control promise has not been resolved yet while terminating control")):this._terminateControl()}_terminateControl(g=!0){this._logger.info("_terminateControl()"),this._terminateControlPromise=defer();const always=()=>{this._terminateControlPromise=null};this._terminateControlPromise.promise.then(always,always);let m=0;const f=g?8:7;let S,v;if(this._isViewing()){if(4!==this.controlState)return this._logger.error("Local viewer called terminateControl when not controlling"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local viewer called terminateControl when not controlling"));this._teardownViewerRemoteControl(),m=6,S=this._getSharerDataSourceId(),v=Rs,this._logger.info(`Terminating remote control reason: ${m},  recipient: ${S}, controllerId: ${v}`)}else{if(3!==this.controlState||!this._controllerParticipant)return this._logger.error("Local sharer called terminateControl when no one is in control"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Local sharer called terminateControl when no one is in control"));this._teardownSharerRemoteControl(),m=5,S=this._getDataSourceIdForParticipantLeg(this._controllerParticipant),v=this._controllerParticipant.participant.id,this._logger.info(`Terminating control on the sharer side, reason: ${m}, recipient: ${S}, controllerId: ${v}`)}if(!this._sendRequest({action:f,terminatedReason:m},S)){if(g)return this._logger.error("Failed to send the terminate control request"),this._terminateControlPromise.reject(new Error),Promise.reject(new Error("Failed to send the grant control request!"));this._logger.error("Failed to send the terminateNoAck request")}this.controlState=g?5:0;const C={inControl:!1,id:v,terminatedReason:m};return this._logger.info(`raising event sharingControlChanged reason=${C.terminatedReason} controlState=${this.controlState}`),this.event("sharingControlChanged").raise(C),g?(this._terminateControlTimer=window.setTimeout((()=>{if(5===this.controlState){this.controlState=0,this._resetControllerParticipant(),this._logger.error("No ack received when terminating control - resending terminate request");this._sendRequest({action:7,terminatedReason:4},S)||this._logger.error("Failed to send the terminateNoAck request"),this._terminateControlPromise?this._terminateControlPromise.reject(new Error("No ack received when terminating control - resending terminate request")):this._logger.error("Unexpected, no promise could be resolved - controlState=WaitingForTerminateAck")}else this._terminateControlPromise?this._terminateControlPromise.reject(new Error("terminate control - times out in bad state - do nothing")):this._logger.error(`Unexpected, no promise could be resolved - controlState=${toControlStateString(this.controlState)}`);this._terminateControlTimer=null}),bs),this._terminateControlPromise.promise):(this._terminateControlPromise.resolve(),new Promise(((g,m)=>{g()})))}_cancelTerminateControlTimer(){this._terminateControlTimer&&(this._terminateControlPromise&&this._terminateControlPromise.reject(new Error("cancelled by _cancelTerminateControlTimer")),clearTimeout(this._terminateControlTimer),this._terminateControlTimer=null,this._logger.info("_cancelTerminateControlTimer()"))}_disposeControlCapturer(g=generateCauseId()){this._logger.info(`_disposeControlCapturer causeId: ${g}`),this._clearCapturerEventSubscriptions(),this._controlCapturer&&(this._controlCapturer.dispose(g),this._controlCapturer=null)}dispose(g){this._logger.info(`dispose causeId: ${g}`),this._dataChannelAdapter.dispose(g),this._resetControlState(),this._disposeRenderer(g),this._cancelRequestControlTimer(),this._cancelAcceptControlTimer(),this._cancelGrantControlTimer(),this._cancelTerminateControlTimer(),this._terminateAvailableHandshake&&this._terminateAvailableHandshake(2),this._call=null,this._resetParticipantSubscriptions(),this._finalizeViewerSessionTelemetry("Shutdown"),this._finalizeSharerSessionTelemetry("Shutdown"),super.dispose(g)}};function toControlActionString(g){switch(g){case 0:return"Available";case 1:return"ControlRequest";case 2:return"CancelControlRequest";case 3:return"AcceptRequest";case 4:return"RejectRequest";case 5:return"Ack";case 6:return"GiveControl";case 7:return"TerminateNoAck";case 8:return"Terminate";case 9:return"AvailableAck";case 10:return"AvailableNack";case 11:return"RenderedAtViewer";default:return"Unknown"}}function toControlStateString(g){switch(g){case 0:return"None";case 1:return"RequestSent";case 2:return"WaitingForControlAck";case 3:return"RemoteControlling";case 4:return"LocalControlling";case 5:return"WaitingForTerminateAck";default:return"Unknown"}}function toControlTerminatedReason(g){switch(g){case 0:return"None";case 1:return"SharerDenied";case 2:return"SharerNoResponse";case 3:return"SharerBusy";case 4:return"AckTimeout";case 5:return"SharerTerminated";case 6:return"ViewerTerminated";case 7:return"DataChannelError";case 8:return"ViewerCancelled";case 9:return"SharerControlDisabled";case 10:return"UnknownSender";default:return"Unknown"}}var Ns=(g=>(g[g.LEFT=0]="LEFT",g[g.RIGHT=1]="RIGHT",g[g.MIDDLE=2]="MIDDLE",g[g.BACK=3]="BACK",g[g.FORWARD=4]="FORWARD",g))(Ns||{}),ks=(g=>(g[g.SCAN_CODE=0]="SCAN_CODE",g[g.VIRTUAL_KEY=1]="VIRTUAL_KEY",g[g.RECOGNITION_INPUT=2]="RECOGNITION_INPUT",g))(ks||{}),Ls=class{constructor(g){this.logger=g}toEdgeControlMouseEvent(g){let m;switch(g.type){case 0:return{event:this.toMouseMoveEvent(g),apiName:"injectMouseMoveEvent"};case 1:return{event:this.toMouseWheelEvent(g),apiName:"injectMouseWheelEvent"};case 2:return{event:this.toMouseButtonPressedEvent(g),apiName:"injectMouseButtonEvent"};default:throw m=`Uncovered mouse control event type. Event: ${g}`,this.logger.error(m),Error(m)}}toEdgeControlKeyboardEvent(g){return{event:{repeat:g.repeat,keyUp:g.keyUp,codeType:ks[g.codeType],keyCode:g.code},apiName:"injectKeyEvent"}}toMouseMoveEvent(g){return{xPos:g.xPos,yPos:g.yPos}}toMouseWheelEvent(g){return{wheelButtonDown:g.wheelButtonDown,wheelRotation:g.wheelRotation}}toMouseButtonPressedEvent(g){return{xPos:g.xPos,yPos:g.yPos,button:Ns[g.buttonType],buttonDown:g.buttonDown}}};async function pngBase64ToBitmap(g,m,f){return new Promise(((S,v)=>{const C=Buffer.from(g,"base64"),_=document.createElement("canvas").getContext("2d"),E=new Blob([C],{type:"image/png"});let T=new Image;T.onload=()=>{_.drawImage(T,0,0,T.width,T.height,0,0,m,f);const g=_.getImageData(0,0,m,f);window.URL.revokeObjectURL(T.src),T=null,S(Array.from(g.data))},T.onerror=g=>{v(g)},T.src=window.URL.createObjectURL(E)}))}var Fs="ncbjelpjchkpbikbpkcchkhkblodoama",xs=class{constructor(g){this.logger=g}async sendInjectInputEventMessage(g,m){return this.logger.info("EdgeControlInjectorApi - sendInjectInputEventMessage"),new Promise(((f,S)=>{window.top.chrome.runtime.sendMessage(Fs,{api:g,deviceId:this.virtualInputDeviceId,event:m},(g=>{g.error?S(g.error.message):f(0)}))}))}async createInputDeviceId(g,m,f){this.virtualInputDeviceId&&this.logger.warn("EdgeControlInjectorApi - createInputDeviceId virtual input already exists.");try{this.virtualInputDeviceId=await this.sendCreateInputDeviceMessage(g,f)}catch(g){this.logger.error(`EdgeControlInjectorApi - createInputDevice failed, error: ${JSON.stringify(g)}`),m()}}async sendSetLocalUserAvatarMessage(g){const m=await this.generateAvatarBitmap(g);return new Promise(((g,f)=>{const S=window.top;m&&S.chrome.runtime.sendMessage(Fs,{api:"setLocalUserAvatar",avatarBitmap:m},(m=>{m.error?f(m.error.message):g()}))}))}async sendCloseVirtualInputDeviceMessage(){const g=this.virtualInputDeviceId;return g?(this.logger.info("EdgeControlInjectorApi - sendCloseVirtualInputDeviceMessage called"),new Promise(((m,f)=>{const S=window.top;S.chrome.runtime.sendMessage(Fs,{api:"closeInputDevice",deviceId:g},(g=>{g?g.error?f(g.error.message):(this.virtualInputDeviceId=null,m(g.deviceId)):f(S.chrome.runtime.lastError.message)}))}))):(this.logger.info("EdgeControlInjectorApi - VirtualInputDevice does not exists, nothing to close."),Promise.resolve())}async sendCreateInputDeviceMessage(g,m){this.logger.info("EdgeControlInjectorApi - sendCreateInputDeviceMessage called");const f=await this.generateAvatarBitmap(m);return new Promise(((m,S)=>{const v=window.top,messageCallback=g=>{g?g.deviceId?m(g.deviceId):g.error?S(g.error.message):S("Error: Unexpected response from API"):S(v.chrome.runtime.lastError.message)};f?v.chrome.runtime.sendMessage(Fs,{api:"createInputDevice",mediaStreamTrackId:g,avatarBitmap:f},messageCallback):v.chrome.runtime.sendMessage(Fs,{api:"createInputDevice",mediaStreamTrackId:g},messageCallback)}))}async generateAvatarBitmap(g){if(!g)return null;try{const m=32;return{width:m,height:m,data:await pngBase64ToBitmap(g,m,m)}}catch(g){return this.logger.error(`EdgeControlInjectorApi - generateAvatarBitmap error: ${JSON.stringify(g)}, continue without avatar.`),null}}};async function sendIsVirtualInputSupportedMessage(g){return new Promise(((m,f)=>{g.info("EdgeControlInjectorApi - sendIsVirtualInputSupportedMessage");const S=window.top;S.chrome.runtime.sendMessage(Fs,{api:"isVirtualInputSupported"},(g=>{g?g.error?m(g.error.message):m(g):f(S.chrome.runtime.lastError?.message)}))}))}var Us=class{constructor(g,m,f){this.logger=g,this.sharingTrackId=m,this.onInitErrorCallback=f,this.images=new Map,this.controlEventConverter=new Ls(g),this.edgeApi=new xs(this.logger)}showVirtualCursor(g,m){if(this.logger.info(`EdgeControlInjector - showVirtualCursor, id: ${g} sharingTrackId: ${this.sharingTrackId}`),m){this.edgeApi.createInputDeviceId(this.sharingTrackId,this.onInitErrorCallback,this.images[g]);const m=this.images[0];m?this.edgeApi.sendSetLocalUserAvatarMessage(m):this.logger.error("EdgeControllerInjector - local avatar is missing, continue without local avatar")}else this.edgeApi.sendCloseVirtualInputDeviceMessage()}setAvatar(g,m){this.logger.info(`${g} EdgeControlInjector - setAvatar, id: ${g}, data: ${JSON.stringify(m)}`),this.images[g]=m}async injectMouseEvent(g,m){this.logger.info(`${g} EdgeControlInjector - injectMouseEvent ${JSON.stringify(m)}`);const f=this.controlEventConverter.toEdgeControlMouseEvent(m);return this.edgeApi.sendInjectInputEventMessage(f.apiName,f.event)}async injectKeyboardEvent(g,m){const f=this.controlEventConverter.toEdgeControlKeyboardEvent(m);return this.edgeApi.sendInjectInputEventMessage(f.apiName,f.event)}injectClipboardText(g,m){return this.logger.info(`${g} EdgeControlInjector - injectClipboardText is unimplemented`),Promise.resolve(0)}dispose(g){this.logger.info("EdgeControlInjector - dispose"),this.edgeApi.sendCloseVirtualInputDeviceMessage()}},Vs=class{constructor(g){this.logger=g,this.activeSourceId=0,this.edgeVirtualInputSupported=!1,this.pendingPointerImages=new Map,this.logger.info("ControlInjectorAdapter"),"EdgeAnaheim"===getBrowserInfo().name&&sendIsVirtualInputSupportedMessage(g).then((m=>{this.edgeVirtualInputSupported=m,g.info(`ControlInjectorAdapter - Edge supports virtual input device: ${JSON.stringify(this.edgeVirtualInputSupported)}`)})).catch((m=>{g.info(`ControlInjectorAdapter - Edge IsVirtualInputSupported: ${JSON.stringify(m)}`)}))}enableInjector(g){if(this.injector)return this.logger.error("Control injector already present"),Promise.reject();if("EdgeAnaheim"===getBrowserInfo().name){if(!this.edgeVirtualInputSupported)return this.logger.info("ControlInjectorAdapter - Edge doesn't support give control"),Promise.reject();const onInitErrorCallback=()=>(this.disableInjector(),this.logger.error("ControlInjectorAdapter - An error occured, control injector is disabled."),Promise.reject());this.injector=new Us(this.logger,g,onInitErrorCallback),this.logger.info("ControlInjectorAdapter - Edge ControlInjector created")}else window.ControlInjector&&(this.injector=window.ControlInjector(g),this.logger.info("ControlInjectorAdapter - Window ControlInjector created"));return this.pendingPointerImages.forEach(((g,m)=>{this.injector.setAvatar(m,g)})),this.pendingPointerImages.clear(),Promise.resolve()}disableInjector(){return this.injector?(this.logger.info("ControlInjectorAdapter - ControlInjector disposed"),this.injector.dispose(),this.injector=null,Promise.resolve()):(this.logger.error("Control injector not present"),Promise.reject())}setPointerImage(g,m){return this.injector?new Promise((f=>{this.injector.setAvatar(g,m),f()})):(this.pendingPointerImages.set(g,m),Promise.resolve())}showVirtualCursor(g){return this.logger.info(`ControlInjectorAdapter - showVirtualCursor ${g} ${this.activeSourceId}`),this.injector?new Promise((m=>{g?(this.activeSourceId&&this.injector.showVirtualCursor(this.activeSourceId,!1),this.injector.showVirtualCursor(g,!0),this.activeSourceId=g):this.activeSourceId&&(this.injector.showVirtualCursor(this.activeSourceId,!1),this.activeSourceId=0),m()})):(this.logger.error("Control injector not present"),Promise.reject())}injectRawInput(g,m){if(!this.injector)return this.logger.error("Control injector not present"),Promise.reject();const f=this.injector;return new Promise(((S,v)=>{let C,_;const E=rs.decodeEventType(g);switch(E){case 1:C=rs.decodeMouseEvent(g),f.injectMouseEvent(m,C).then((g=>0===g?S():v()));break;case 0:_=rs.decodeKeyboardEvent(g),f.injectKeyboardEvent(m,_).then((g=>0===g?S():v()));break;default:this.logger.error(`Invalid event type in raw input: ${E}`),v()}}))}canBeEnabled(){return"EdgeAnaheim"===getBrowserInfo().name?this.edgeVirtualInputSupported:!!window.ControlInjector}},Bs=class{constructor(g){this.logger=g,this.logger.info("RendererAdapter")}getTarget(g){return g.target}subscribeVideoSizeChangedEvent(g,m){const f=g;return f.streamSize&&m(f.streamSize.width,f.streamSize.height),f.renderer.on("onVideoSizeChanged",m)}subscribeRenderStartedEvent(g,m){return g.renderer.on("onVideoStarted",((g,f)=>m()))}};function bufferToString(g){return String.fromCharCode.apply(null,g)}var Hs=class extends Ve{constructor(g,m){super(g),this.logger=g,this._call=m}isActive(){return!(!this.protocolSendFunc||!this.controlSendFunc)}sendProtocolMessage(g,m){return this.protocolSendFunc?this.protocolSendFunc(g,m):(this.logger.error("Cannot send protocol message, ProtocolHandler hasn't started"),Promise.resolve())}sendControlMessage(g,m){return this.controlSendFunc?this.controlSendFunc(g,m):(this.logger.error("Cannot send control message, ControlHandler hasn't started"),Promise.resolve())}getProtocolHandler(){return{onStarted:async(g,m)=>{this.logger.info(`ProtocolHandler started for ${g}`),this.protocolSendFunc=m,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async g=>{this.logger.info(`ProtocolHandler stopped for ${g}`);const m=this.isActive();this.protocolSendFunc=null,m&&this.event("stateChange").raise(!1)},onDataReceived:async(g,m,f)=>{if(1===g){const g=JSON.parse(bufferToString(m)),S=this._call.mapDataChannelSourceIdToParticipant(f);let v;return S&&(v=getParticipantIdForSourceId(S,3,f)),this.event("protocolMessage").raise(g.message,S,v,f)}}}}getControlHandler(){return{onStarted:async(g,m)=>{this.logger.info(`ControlHandler started for ${g}`),this.controlSendFunc=m,this.isActive()&&this.event("stateChange").raise(!0)},onStopped:async g=>{this.logger.info(`ControlHandler stopped for ${g}`);const m=this.isActive();this.controlSendFunc=null,m&&this.event("stateChange").raise(!1)},onDataReceived:async(g,m,f)=>{if(2===g)return this.event("controlMessage").raise(m,f)}}}},$s=class extends Os{constructor(g,m,f,S,v){const C={};try{const g=v.getEcsConfig("SkypeCalling","gtcHandshakeSendDelay");g&&(C.handshakeSendDelay=JSON.parse(g))}catch(m){g.error(`Failed to parse ecs config gtcAvailableAckDelay: ${stringifyObject(m)}`)}super(g.createChild("ScreenSharingControl"),f,S,C),this.dataChannel=m;const _=new Vs(this._logger),E=new Bs(this._logger),T=new Hs(this._logger,f);this.setAdapters(_,E,T)}setupDataHandlers(){this.dataChannel.addHandler(1,this.getProtocolHandler()),this.dataChannel.addHandler(2,this.getControlHandler())}startOrStopControlForViewer(g,m,f){g&&"nonInteractive"!==f?.appliedInteractivityLevel?m&&0===this.role&&this.initControlForViewer(m):2===this.role&&this.shutdownControlForViewer()}getProtocolHandler(){return this._dataChannelAdapter.getProtocolHandler()}getControlHandler(){return this._dataChannelAdapter.getControlHandler()}};function createParticipantListFromMriMap(g){const m=[];for(const f in g)if(g[f].participantLegIdMap)for(const S in g[f].participantLegIdMap){const v=g[f].participantLegIdMap[S].endpointId;m.push({id:f,mri:f,participantId:S,...v&&{endpointId:v}})}else m.push({id:f,mri:f});return m}function mapParticipantScope(g){switch(g){case 1:return"specified";case 0:return"all";case 3:return"attendees";case 2:return"presenters";case 4:return"self";default:return"none"}}var Gs,js={};if(__export(js,{addReceiveDirectionality:()=>addReceiveDirectionality,allowDataChannel:()=>allowDataChannel,allowProvisionalAnswer:()=>allowProvisionalAnswer,areNegotiatedDirectionsAcceptable:()=>areNegotiatedDirectionsAcceptable,areNegotiatedDirectionsFulfilled:()=>areNegotiatedDirectionsFulfilled,areSendDirectionsFulfilled:()=>areSendDirectionsFulfilled,canUseWebrtc1_0:()=>canUseWebrtc1_0,convertToCodecInfo:()=>convertToCodecInfo,getAllowedCodecs:()=>getAllowedCodecs,getSendMediaModalities:()=>getSendMediaModalities,getSimulcastConfigForMediaType:()=>getSimulcastConfigForMediaType,getSrtpInfo:()=>getSrtpInfo,hasReceiveDirectionality:()=>hasReceiveDirectionality,hasSendDirectionality:()=>hasSendDirectionality,invertModalities:()=>invertModalities,ipAddressConverter:()=>ipAddressConverter,ipV4RegExp:()=>zs,ipV6RegExp:()=>Ks,ipv4AddressConverter:()=>ipv4AddressConverter,ipv6AddressConverter:()=>ipv6AddressConverter,isOnHold:()=>isOnHold,isSendModalityAdded:()=>isSendModalityAdded,isVersionGreaterOrEqual:()=>isVersionGreaterOrEqual,makeReinvitelessContext:()=>makeReinvitelessContext,mediaTypeToModality:()=>mediaTypeToModality,mergeSendModalities:()=>mergeSendModalities,modalityToMediaType:()=>modalityToMediaType,negotiateDirectionality:()=>negotiateDirectionality,negotiateModalities:()=>negotiateModalities,parseCandidateString:()=>parseCandidateString,preferSdesSrtp:()=>preferSdesSrtp,printMediaStream:()=>printMediaStream,removeChangedSendDirection:()=>removeChangedSendDirection,removeSendDirectionality:()=>removeSendDirectionality,scrubConstraints:()=>scrubConstraints,scrubDevices:()=>scrubDevices,scrubObjectExcludingFields:()=>scrubObjectExcludingFields,scrubObjectFields:()=>scrubObjectFields,scrubSelectedDevices:()=>scrubSelectedDevices,sendStreamsToModalities:()=>sendStreamsToModalities}),"undefined"!=typeof window&&"undefined"!=typeof navigator){Gs=window,window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.MediaStream=window.MediaStream||window.webkitMediaStream||window.mozMediaStream||window.msMediaStream,window.AudioContext=window.AudioContext||window.webkitAudioContext;const g=getBrowserInfo();void 0!==navigator.webkitGetUserMedia&&"undefined"!=typeof webkitRTCPeerConnection&&isVdiBrowser(g)?(window.RTCPeerConnection=webkitRTCPeerConnection,navigator.getUserMedia=(g,m,f)=>{const polyfillDeviceId=g=>{g?.deviceId?.exact&&(g.mandatory||(g.mandatory={}),g.mandatory.sourceId=g.deviceId.exact,delete g.deviceId)};return g&&(polyfillDeviceId(g.audio),polyfillDeviceId(g.video)),navigator.webkitGetUserMedia(g,m,f)}):navigator.mediaDevices&&void 0!==navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=function(g,m,f){return navigator.mediaDevices.getUserMedia(g).then(m).catch(f)})}var Ws={window:Gs},qs=class _UserAgentConfig extends Be{constructor(g){super(),this.configProvider=g,this.isAudioOutputSelectionSupportedValue=!1,this.configProvider.on("configUpdated",(()=>this.updateConfig())),this.updateConfig(),this.isRollbackSupported()}get isAudioOutputSelectionSupported(){return this.isAudioOutputSelectionSupportedValue}get isBrowserRollbackSupported(){return this.isRollbackSupportedValue}static hasApplyConstraints(){return void 0!==MediaStreamTrack.prototype.applyConstraints}static hasPermissionsApi(){return void 0!==navigator.permissions&&"Firefox"!==getBrowserInfo().name}static get hardwareConcurrency(){return window.navigator.hardwareConcurrency}static get unmaskedGlRenderer(){if(this.renderer)return this.renderer===je.MEDIA_ERROR.webGlRendererError?void 0:this.renderer;try{const g=document.createElement("canvas").getContext("webgl"),m=g?.getExtension("WEBGL_debug_renderer_info"),f=m&&g.getParameter(m.UNMASKED_RENDERER_WEBGL);return this.renderer=f,f}catch{return void(this.renderer=je.MEDIA_ERROR.webGlRendererError)}}async isRollbackSupported(){let g;try{if(g=Ws.window.RTCPeerConnection&&new Ws.window.RTCPeerConnection({sdpSemantics:"unified-plan"}),g){const m=await g.createOffer();await g.setLocalDescription(m),await g.setLocalDescription({type:"rollback"}),this.isRollbackSupportedValue=!0}}catch(g){this.isRollbackSupportedValue=!1}finally{g?.close()}}static async isCodecsSupported(g){const m={format:"annexb"},f=1280,S=720,v=["no-preference","prefer-software","prefer-hardware"],C=[];for(const _ of g)for(const g of v){const v=await(window.VideoEncoder?.isConfigSupported({codec:_,hardwareAcceleration:g,hevc:m,width:f,height:S})),E=await(window.VideoDecoder?.isConfigSupported({codec:_,hardwareAcceleration:g,hevc:m}));if(v||E){const g={name:_,mode:v?.config.hardwareAcceleration,encode:v?.supported,decode:E?.supported};C.push(g)}}return C}static async hasH264CodecSupport(g){const m="v=0\no=- 596983 0 IN IP4 127.0.0.1\ns=session\nc=IN IP4 0.0.0.0\nt=0 0\na=msid-semantic: WMS *\nm=video 3480 RTP/SAVPF 107 99\na=rtpmap:107 H264/90000\na=rtpmap:99 rtx/90000\na=fmtp:107 max-fs=240;max-mbps=3600;max-br=208;max-fps=1500;profile-level-id=42C02A;packetization-mode=1\na=fmtp:99 apt=107\na=setup:actpass\na=mid:video\na=recvonly\na=rtcp-mux\na=ice-ufrag:CvYq\na=ice-pwd:axsjsa0GOz3kz6TuGvNgJZWO\na=fingerprint:sha-256 34:DF:5C:15:60:FF:28:3E:E8:96:4B:F8:85:61:E4:C0:57:D1:60:82:21:FD:BC:D2:90:41:06:FA:03:FD:12:A2\n",f=Ws.window.RTCPeerConnection&&new Ws.window.RTCPeerConnection;if(!f)return!1;try{return await f.setRemoteDescription({sdp:m,type:"offer"}),!0}catch(m){return g.error("H264 not supported",m),!1}finally{try{f.close()}catch(g){}}}static hasMediaApi(){return navigator.getUserMedia&&"undefined"!=typeof RTCPeerConnection}static hasCapabilitiesApi(){return!!Ws.window.RTCRtpReceiver?.getCapabilities}static isAudioOutputSelectionSupportedByBrowser(){return!!Ws.window?.HTMLAudioElement?.prototype.setSinkId}updateConfig(){const g=_UserAgentConfig.isAudioOutputSelectionSupportedByBrowser();g!==this.isAudioOutputSelectionSupportedValue&&(this.isAudioOutputSelectionSupportedValue=g,this.event("isAudioOutputSelectionSupportedChanged").raise())}static hasUnifiedPlanSupport(){let g;try{g=Ws.window.RTCPeerConnection&&new Ws.window.RTCPeerConnection({sdpSemantics:"unified-plan"})}catch(g){return!1}let m=!1;return g&&(m=!!g.addTransceiver,g.close()),m}static hasEncodedStreamApi(){return!!RTCRtpReceiver.prototype.createEncodedStreams||_UserAgentConfig.hasScriptTransformApi()}static hasScriptTransformApi(){return!!window.RTCRtpScriptTransform}static isWakeLockSupported(){return!!window.navigator.wakeLock}},zs=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(:[0-9]{1,5})?$/),Ks=RegExp(/^\[?(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|:((:[0-9a-fA-F]{1,4}){1,5}|:)((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,5}([0-9a-fA-F]{1,4})?:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\]?(?::\d{1,5})?$/);function invertDirectionality(g){switch(g){case je.MEDIA_STATE.send:return je.MEDIA_STATE.receive;case je.MEDIA_STATE.receive:return je.MEDIA_STATE.send;default:return g}}function negotiateDirectionality(g,m){const f=hasSendDirectionality(g)&&hasSendDirectionality(m),S=hasReceiveDirectionality(g)&&hasReceiveDirectionality(m);return f&&S?je.MEDIA_STATE.sendReceive:f?je.MEDIA_STATE.send:S?je.MEDIA_STATE.receive:g===je.MEDIA_STATE.inactive&&m||g&&m===je.MEDIA_STATE.inactive?je.MEDIA_STATE.inactive:void 0}function invertModalities(g){const m={},f=invertDirectionality(g.audio);f&&(m.audio=f);const S=invertDirectionality(g.video);S&&(m.video=S);const v=invertDirectionality(g.sharing);v&&(m.sharing=v);const C=invertDirectionality(g.data);return C&&(m.data=C),m}function removeSendDirectionality(g){return g===je.MEDIA_STATE.sendReceive?je.MEDIA_STATE.receive:void 0}function hasSendDirectionality(g){return g===je.MEDIA_STATE.send||g===je.MEDIA_STATE.sendReceive}function hasReceiveDirectionality(g){return g===je.MEDIA_STATE.receive||g===je.MEDIA_STATE.sendReceive}function addReceiveDirectionality(g){return hasReceiveDirectionality(g)?g:g===je.MEDIA_STATE.send?je.MEDIA_STATE.sendReceive:je.MEDIA_STATE.receive}function isOnHold(g){return!(g.audio!==je.MEDIA_STATE.inactive||g.video&&g.video!==je.MEDIA_STATE.inactive||g.sharing&&g.sharing!==je.MEDIA_STATE.inactive)}function negotiateModalities(g,m){const f={},S=negotiateDirectionality(g.audio,m.audio);S&&(f.audio=S);const v=negotiateDirectionality(g.video,m.video);v&&(f.video=v);const C=negotiateDirectionality(g.sharing,m.sharing);C&&(f.sharing=C);const _=negotiateDirectionality(g.data,m.data);return _&&(f.data=_),f}function isNegotiatedDirectionAcceptable(g,m,f){const S=hasSendDirectionality(g)&&hasSendDirectionality(m)||!hasSendDirectionality(g)&&!hasSendDirectionality(f),v=!f||hasReceiveDirectionality(g)&&hasReceiveDirectionality(m)||!hasReceiveDirectionality(g)&&!hasReceiveDirectionality(f);return S&&v}function areNegotiatedDirectionsAcceptable(g,m,f){return isNegotiatedDirectionAcceptable(g.audio,m.audio,f.audio)&&isNegotiatedDirectionAcceptable(g.video,m.video,f.video)&&isNegotiatedDirectionAcceptable(g.sharing,m.sharing,f.sharing)&&isNegotiatedDirectionAcceptable(g.data,m.data,f.data)}function areNegotiatedDirectionsFulfilled(g,m){function isNegotiatedDirectionFulfilled(g,m){const f=hasSendDirectionality(g)===hasSendDirectionality(m),S=hasReceiveDirectionality(g)===hasReceiveDirectionality(m)||hasReceiveDirectionality(g)&&!m;return f&&S}return isNegotiatedDirectionFulfilled(g.audio,m.audio)&&isNegotiatedDirectionFulfilled(g.video,m.video)&&isNegotiatedDirectionFulfilled(g.sharing,m.sharing)&&isNegotiatedDirectionFulfilled(g.data,m.data)}function areSendDirectionsFulfilled(g,m){const isSendDirectionFulfilled=(g,m)=>hasSendDirectionality(g)===hasSendDirectionality(m);return isSendDirectionFulfilled(g.audio,m.audio)&&isSendDirectionFulfilled(g.video,m.video)&&isSendDirectionFulfilled(g.sharing,m.sharing)&&isSendDirectionFulfilled(g.data,m.data)}function getSrtpInfo(g){const m={dtls:!1,sdes:!1};return m.dtls=!!g.fingerprint,g.media.forEach((g=>{m.dtls=m.dtls||!!g.fingerprint,m.sdes=m.sdes||!!g.crypto})),m}function removeChangedSendDirection(g,m){if(!m||isEmpty(m))return g;const f={};return forOwn(g,((g,S)=>{S===je.MODALITY.data?f[S]=removeChangedDataSendDirection(g,m[S]):f[S]=removeChangedMediaSendDirection(g,m[S])})),f}function removeChangedMediaSendDirection(g,m){return hasSendDirectionality(g)&&!hasSendDirectionality(m)?removeSendDirectionality(g)||m:g}function removeChangedDataSendDirection(g,m){return hasSendDirectionality(g)&&!hasSendDirectionality(m)?m:g}function parseCandidateString(g){const m=(g||"").split(" ");return{component:m[1],protocol:m[2],priority:m[3],ip:m[4],port:m[5],type:m[7]}}function isSendModalityAdded(g,m){return!hasSendDirectionality(g)&&hasSendDirectionality(m)}function getSendMediaModalities(g){return{Audio:hasSendDirectionality(g.audio),Video:hasSendDirectionality(g.video),ScreenShare:hasSendDirectionality(g.sharing),Data:hasSendDirectionality(g.data)}}function mergeSendModalities(g,m){const f=shallowClone(g);return forOwn(g,((g,S)=>{const v=modalityToMediaType(S);hasSendDirectionality(g)&&!m[v]&&(f[S]=removeSendDirectionality(g))})),f}function modalityToMediaType(g){switch(g){case"audio":return"Audio";case"video":return"Video";case"sharing":return"ScreenShare";default:return null}}function mediaTypeToModality(g){switch(g){case"Audio":return"audio";case"Video":return"video";case"ScreenShare":return"sharing";default:return null}}function sendStreamsToModalities(g){const m={};return keys(g).forEach((f=>m[f]=!!g[f])),m}function scrubObjectFields(g,m,f){if(!g)return g;const S={...g};for(const[v,C]of Object.entries(g))"object"==typeof C?S[v]=scrubObjectFields(C,m):C&&m.includes(v)&&(S[v]=f?f(C):scrubMriOrOmit(C));return S}function scrubObjectExcludingFields(g,m,f){if(!g)return g;const S={...g};for(const[v,C]of Object.entries(g))"object"==typeof C?S[v]=scrubObjectExcludingFields(C,m):C&&!m.includes(v)&&(S[v]=f?f(C):scrubMriOrOmit(C));return S}function scrubSelectedDevices(g){return g?scrubObjectExcludingFields(g,[]):g}function scrubDevices(g,m){if(!g)return g;const f=scrubObjectFields(g,["deviceId","groupId","guid"]);return scrubObjectFields(f,["label"],(g=>scrubDeviceLabelPii(g,m)))}function scrubConstraints(g){return scrubObjectFields(g,["sourceId","deviceId"])}function preferSdesSrtp(g){return!(!g.configProvider.config.webrtcForceSdesForS1||!g.configProvider.config.checkSupportForWebrtc_1_0||g.configProvider.mediaConfig.simulcastSessionEnabled)||(g.config.isPstnCall?g.configProvider.config.preferSdesSrtpPstn:g.configProvider.config.preferSdesSrtp)}function canUseWebrtc1_0(g){return!g||qs.hasUnifiedPlanSupport()}function allowDataChannel(g){return!!g.configProvider.mediaConfig.simulcastSessionEnabled&&(g.config.isPstnCall?g.configProvider.config.enableDataChannelPstn:g.configProvider.config.enableDataChannel)}function getAllowedCodecs(g,m){switch(m){case je.MEDIA_TYPE.audio:return g.config.allowedAudioCodecs;case je.MEDIA_TYPE.video:return g.config.allowedVideoCodecs;default:return[]}}function isVersionGreaterOrEqual(g,m){const f=m.split(".").map((g=>parseInt(g,10))),S=g.split(".").map((g=>parseInt(g,10)));return S[0]>f[0]||S[0]===f[0]&&S[1]>=f[1]}function getSimulcastConfigForMediaType(g,m){return"Video"===g?m.config.specCompliantSimulcast?.video:"ScreenShare"===g?m.config.specCompliantSimulcast?.sharing:null}function convertToCodecInfo(g){return g.map((g=>{const m=g.mimeType.split("/"),f={codec:m[1]||m[0],rate:g.clockRate};return g.channels&&(f.encoding=g.channels),g.sdpFmtpLine&&(f.fmtpLine=g.sdpFmtpLine),f}))}function allowProvisionalAnswer(g,m=!1){const f=!g.configProvider.config.acceptProvisionalAnswerFromPstnOnly||m;return g.config.isPstnCall?g.configProvider.config.allowProvisionalAnswerPstn&&f:g.configProvider.config.allowProvisionalAnswer}function printMediaStream(g){return`${g?.id}:${JSON.stringify(g?.getTracks().map((g=>g.id)))}}`}function ipAddressConverter(g){try{if(zs.test(g))return ipv4AddressConverter(g);if(Ks.test(g))return ipv6AddressConverter(g)}catch(m){return g}return g}function ipv6AddressConverter(g){let m,f=g.lastIndexOf("]")+1,S="",v="";f>0?(m=g.substring(0,f),v=g.substring(f)):(m=g,f=m.length);const C=m.lastIndexOf(":");if(m.includes(".")){const g=ipv4AddressConverter(m.substring(C+1,f-1-C));S=m.substring(0,C+1)+g}else C<m.length-1||":"===m[C-1]&&m.match(/:/g).length<7?S=m.substring(0,C+1)+"x":7===m.match(/:/g).length&&(S=m.substring(0,C)+"0:x");return S?v?S+"]"+v:"["===g.substring(0,1)?(S=S.substring(1),S):S:g}function ipv4AddressConverter(g){const m=g.substring(0,g.lastIndexOf(".")+1)+"x",f=g.lastIndexOf(":");return f>0?m+g.substring(f):m}function makeReinvitelessContext(g,m){const f=(m?g?.maxReinvitelessMediaForVideoMultiparty:g?.maxReinvitelessMediaForVideo1on1)||0,S=(m?g?.maxReinvitelessMediaForVBSSMultiparty:g?.maxReinvitelessMediaForVBSS1on1)||0;return{enabled:f>0||S>0,maxStreamsForModality:{video:f,sharing:S}}}function getStreamInformation(g){let m=[];return g.forEach((g=>{try{let f=m.find((m=>m.participantId===g.participantId&&m.endpointId===g.endpointId));f||(f={participantId:g.participantId,endpointId:g.endpointId},m.push(f)),"audio"!==g.type&&"audioteleconference"!==g.type||(f.serverMuted=g.serverMuted),f[g.type]=g.direction}catch(g){m=[]}})),m}var Js=class extends Ve{constructor(){super(),this.subs=[]}get streams(){return this.sessionAudioProvider?.streams??[]}get comfortNoiseStream(){return this.sessionAudioProvider?.comfortNoiseStream??null}get active(){return this.sessionAudioProvider?.active??!1}setSessionStreamsProvider(g){this.unsubscribeFromStreamEvents(),this.sessionAudioProvider=g,this.subscribeForStreamEvents(),this.event("onStreamsChanged").raise(),this.event("onActiveStateChanged").raise()}dispose(){super.dispose(),this.unsubscribeFromStreamEvents()}subscribeForStreamEvents(){this.sessionAudioProvider&&this.subs.push(this.sessionAudioProvider.on("onStreamsChanged",(()=>this.event("onStreamsChanged").raise())),this.sessionAudioProvider.on("onStreamSourcesUpdated",(g=>this.event("onStreamSourcesUpdated").raise(g))),this.sessionAudioProvider.on("onActiveStateChanged",(()=>this.event("onActiveStateChanged").raise())))}unsubscribeFromStreamEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}},Ys=class extends Ve{constructor(g,m,f,S,v){super(),this.allowVirtualDeviceInCall=g,this.defaultDeviceManager=m,this.logger=f,this.callStats=S,this.isMediaSending=v,this.stats=[],this.selectedVirtualDevice={camera:void 0,screenshare:void 0},this.subs=[this.defaultDeviceManager.on("onVirtualDevicesChanged",(()=>this.handleRegisteredDeviceChange()))]}get isVirtualDeviceEnabled(){return this.allowVirtualDeviceInCall}selectDevices(g){const m=this.defaultDeviceManager.getRegisteredDevices(),f=m.find((m=>m.id===g.camera)),S=m.find((m=>m.id===g.screenshare));this.logger.info(`Selecting virtual devices, camera: ${f?.id}, screenshare: ${S?.id}`);const v={camera:this.selectedVirtualDevice.camera?.id,screenshare:this.selectedVirtualDevice.screenshare?.id};g.camera!==v.camera||g.screenshare!==v.screenshare?(this.selectedVirtualDevice={camera:f,screenshare:S},this.addToCallStat({type:"VirtualDeviceSelected",payload:this.selectedVirtualDevice}),this.event("onSelectedVirtualDevicesChanged").raise(g,v)):this.logger.info("Virtual Device did not change.")}getSelectedDevices(){return Object.entries(this.selectedVirtualDevice).reduce(((g,[m,f])=>(g[m]=f?.id,g)),{})}getDeviceManager(g){return this.allowVirtualDeviceInCall?this.getDeviceManagersForVirtualDevice(g)[0]:(this.logger.info(`VirtualDevice not enabled, using default DM, type: ${g}`),this.defaultDeviceManager)}getDeviceManagersForVirtualDevice(g){return"Video"===g&&this.selectedVirtualDevice.camera?(this.logger.info(`Using Virtual Device (DM), type: ${g}`),this.selectedVirtualDevice.camera.getDeviceManagers()):"ScreenShare"===g&&this.selectedVirtualDevice.screenshare?(this.logger.info(`Using Virtual Device (DM), type: ${g}`),this.selectedVirtualDevice.screenshare.getDeviceManagers()):(this.logger.info(`Using default DM, type: ${g}`),[this.defaultDeviceManager])}getDefaultDeviceManager(){return this.defaultDeviceManager}dispose(){this.stats=[],this.subs.forEach((g=>g.dispose())),super.dispose()}hasDevice(g){return this.defaultDeviceManager.id===g||[...this.selectedVirtualDevice.camera?.getDeviceManagers()??[],...this.selectedVirtualDevice.screenshare?.getDeviceManagers()??[]].some((m=>m?.id===g))}addToCallStat(g){const m=this.stats.push(g);this.callStats.appendCallDeviceManagerInfo({events:JSON.stringify(m)})}handleRegisteredDeviceChange(){const g=this.defaultDeviceManager.getRegisteredDevices(),{camera:m,screenshare:f}=this.selectedVirtualDevice;let S=!1,v=!1;m&&(S=g.some((g=>g.id===m.id)),this.logger.info(`Selected camera(${m.id}) in call, isCameraValid:${S}`)),f&&(v=g.some((g=>g.id===f.id)),this.logger.info(`Selected SS(${f.id}) in call, isScreenShareValid:${v}`)),this.selectDevices({camera:S?m.id:void 0,screenshare:v?f.id:void 0})}isModalityEnabled(g){return this.isMediaSending(getSkypeMediaType(g))}},Qs=class{constructor(g){this.ontimeout=g,this.active=!1}get isActive(){return this.active}start(g){void 0!==this.timeoutId&&this.stop(),this.timeoutId=setTimeout((()=>{this.ontimeout(),this.active=!1}),g),this.active=!0}stop(){clearTimeout(this.timeoutId),this.timeoutId=void 0,this.active=!1}};function defer4(){let g,m,f=!0;return{isPending:()=>f,promise:new Promise(((f,S)=>{g=f,m=S})),resolve:m=>{f&&(g(m),f=!1)},reject:g=>{f&&(m(g),f=!1)}}}function delay2(g){return new Promise((m=>setTimeout(m,g)))}function timeout(g,m,f,S){let v;const C=[g,new Promise(((g,S)=>{v=setTimeout(S.bind(null,new Error(`Promise timed out ${f?`: ${f}`:""} after ${m} ms`)),m)}))];S&&C.push(S);const _=Promise.race(C),always=()=>{v&&clearTimeout(v)};return _.then(always,always),_}var Xs=class{constructor(g,m,f,S){this.mediaControlPlane=g,this.signalingSession=m,this.logger=f,this.diagnostics=S,this.pendingSourceRequests=new Map,this.mediaControlPlane.on("mpSrResReceived",((g,m)=>this.onMsgReceived(g,m)))}mapToSignalingOperation(g){switch(g){case"ApplyChannelParametersSourceRequest":case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":return 0;case"ControlVideoStreaming":return 1;default:return this.logger.error("Unknown send operation"),null}}send(g,m,f,S){switch(g){case"ApplyChannelParametersSourceRequest":return this.sendMessages(g,m,f,S);case"ApplyChannelParametersVideoCapabilities":case"ApplyChannelParametersBandwidth":case"ControlVideoStreaming":return this.signalingSession?(this.diagnostics.recordSignalingOperation(g),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g),m)):Promise.reject(new Error("no signaling session"));default:return this.logger.warn(`Unable to send message reason: Operation unknown ${g}`),Promise.reject(new Error("Unable to send message"))}}async sendMessages(g,m,f,S){return this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")?Promise.all([this.sendMcpMessage(g,m,f,S),this.sendSignalingDupeOperation(g,m,S)]).then():this.sendMcpMessage(g,m,f,S)}setResendingMechanism(g,m,f,S){const v=window.setTimeout((()=>{this.logger.warn(`Fallback for SR: ${g}, switching to signaling`),this.mediaControlPlane.switchMcpFeauture("sourceRequestsEnabled",!1),this.resendPendingMessagesThroughSignaling()}),this.mediaControlPlane.getConfig()?.sourceRequestsMessagesTimeout);this.pendingSourceRequests.set(g,{sequenceNumber:g,timeoutId:v,deferred:m,message:f,operation:S})}async sendMcpMessage(g,m,f,S){if(this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsEnabled")&&m.applyChannelParameters?.multiChannelParameter?.mediaParameter?.includes("controlVideoStreaming")){const v=defer4();this.setResendingMechanism(S,v,m,g);try{return this.diagnostics.recordMCPOperation(g,S,f.controlVideoStreaming?.controlInfo),await this.mediaControlPlane.sendMsg({type:"sr",controlVideoStreaming:f.controlVideoStreaming}),this.logger.info(`Sending to MCP sequenceNumber:${S}`),this.mediaControlPlane?.mcpFeaturesSupported("sourceRequestsResponseEnabled")?v.promise:Promise.resolve()}catch(g){const m=stringifyObject(g);this.diagnostics.recordError(m,S),this.logger.error(`sendMsgInternal failed with error: ${m}`)}}return this.signalingSession?this.mediaControlPlane?.mcpFeaturesSupported("sendDuplicates")?void 0:(this.diagnostics.recordSignalingOperation(g),this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g),m)):Promise.reject(new Error("no signaling session"))}async sendSignalingDupeOperation(g,m,f){if(this.signalingSession){const S=this.mapToSignalingOperation(g);return this.diagnostics.recordSignalingOperation(g,f),await this.signalingSession.sendWebRtcMediaNotificationAsync(S,m),this.diagnostics.recordSignalingOperationDuration(g,f),Promise.resolve()}return Promise.reject(new Error("no signaling session"))}resendPendingMessagesThroughSignaling(){this.diagnostics.recordFallback(),this.pendingSourceRequests.forEach((async(g,m)=>{try{this.mediaControlPlane.mcpFeaturesSupported("sendDuplicates")||(this.diagnostics.recordSignalingOperation(g.operation),await this.signalingSession.sendWebRtcMediaNotificationAsync(this.mapToSignalingOperation(g.operation),g.message)),g.deferred.resolve()}catch{g.deferred.reject()}finally{this.logger.warn(`Deleting message from pending: ${m}`),this.pendingSourceRequests.delete(m),clearTimeout(g.timeoutId)}}))}onMsgReceived(g,m){const f=this.pendingSourceRequests.get(g);switch(this.diagnostics.recordSrResultReceived(m,g,f.operation),m){case"ok":case"duplicate":case"out_of_order":f.deferred.resolve();break;default:f.deferred.reject(`Sequence number: ${g} failed with ${m}!`)}clearTimeout(f.timeoutId),this.pendingSourceRequests.delete(g)}},Zs=[1,2,9,10,11,12,30,27,28],ea="remote",ta="remote",ia=class extends Ve{constructor(g,m){super(),this.isStreaming=g,this.mediaType=m}},na=class _PluginlessCall extends Ve{constructor(g,m,f,S,v,C,_,E,T,I,b,A,P,R,w,M,D){super(f),this.signalingAgent=g,this.mediaAgent=m,this.logger=f,this.telemetryLoggers=S,this.currentUserSkypeIdentity=v,this.groupId=C,this.threadId=_,this.ecsProvider=I,this.trouterService=b,this.accountConfiguration=A,this.participants=[],this.isServerMuted=!1,this.isSpeakerMuted=!1,this.isVideoOn=!1,this.isScreenSharingOn=!1,this.callStartedAt=null,this.callHeldAt=null,this.callType=-1,this.failureType=2,this.isEmergency=!1,this.contentSharingSessions=[],this.endpoints={endpointDetails:[]},this.isPreheatEnabled=!1,this.localMediaStreams=[],this.enableRealtimeTelemetry=!1,this.isSharedLineAppearanceV2Activated=!1,this.requestedHoldState=!1,this.mediaStateConfigurationHelper=new fr({mediaStates:[getMediaState(0,4)]}),this.canToggleAudio=!0,this.canToggleVideo=!0,this.connectCallPromise=Promise.resolve(),this.canToggleScreenSharing=!0,this.callUsesMixer=!1,this.isEscalationInProgress=!1,this.retryOutgoingRenegotiation={retry:!1,causeId:""},this.isHoldInProgress=!1,this.isMuteOnHold=!1,this.callSetupFailed=!1,this.isSomeoneSharing=!1,this.isSomeoneStreamingVideo=!1,this.activeTalkersHistory=[],this.callGotConnected=!1,this.mediaRelayWhiteListingIssue=!1,this.signalingSessionCallOptions=null,this.tsCallingTelemetryReported=!1,this.isCallSetupTelemetrySent=!1,this._isAudioStreamConnected=!1,this._wasAudioStreamConnected=!1,this._callInLobby=!1,this._callIsSetupComplete=!1,this._transferState=0,this._parkState=0,this._muteState=0,this._callCreationTime=(new Date).getTime(),this._commandUrlPresence=0,this._capabilities={canMuteOthers:!1,canUnmuteSelf:!1},this._spamRiskLevel=null,this._spamStirAttestation=null,this._callMode=0,this._isUpdatePropertiesSpecifiedAllowedByEcs=!1,this._deferUsingMicrotask=!1,this._staleRosterCheckFixForPluginless=!1,this._transfereeAcceptanceWithoutWaitingForConv=!1,this._enableResolveScreenSharingWhenNegotiationComplete=!1,this._publishedStatesModified=0,this._participantPublishedStatesMap={},this._endpointPublishedStatesMap={},this._participantChangedEventSkipConfig={skipParticipantsUpdatesOnCall:!0},this._dominantSpeakerChangedEventSkipConfig={skipDominantSpeakerUpdatesOnCall:!0},this.receiveOnlyAudioOnCallStart=!1,this.lastContibutingSourceReport=Date.now(),this.instanceNumber=_PluginlessCall.instanceCount++%1e3,this._hasDelayedReconnect=!1,this.startVM=(g,m,f,S,v)=>this.signalingSession.startOutgoingCall(f,S,{voicemailResourcePath:m.callVoicemailStartOptions.voicemailResourcePath,voicemailItemId:m.callVoicemailStartOptions.voicemailItemId,callToVoicemail:!0},Date.now()-v,g),this.getSignalingSessionCallOptions=g=>{const m={suppressDialout:!g.callStartOptions.ringOthers,isPreheatOnly:1==(1&g.callStartOptions.preheatFlags),onBehalfOf:this.onBehalfOfMri,onBehalfOfUserDisplayName:this.onBehalfOfUserDisplayName,muted:1==(1&g.callStartOptions.muteFlags),invitationType:g.invitationType,participantsToNudge:g.participantsToNudge,routingFlags:g.callStartOptions&&g.callStartOptions.routingFlags,parkContext:g.parkContext,pickupCode:g.pickupCode,scenario:g.callStartOptions&&g.callStartOptions.scenario,callUsesMixer:this.callUsesMixer,clientEndpointCapabilities:g.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:g.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:g.meetingPreferences,alternateId:g.callStartOptions?g.callStartOptions.alternateId:null,meetingRegistrationId:g.callStartOptions?g.callStartOptions.meetingRegistrationId:"",participantPin:g.callStartOptions?g.callStartOptions.participantPin:"",additionalEndpointProperties:g.callStartOptions?.additionalEndpointProperties||null,publishedStates:g.callStartOptions?.publishedStates||null,targetApplicationType:g.callStartOptions?.targetApplicationType,isHuddleGroupCall:g.callStartOptions?.isHuddleGroupCall},f=g.callStartOptions?.invitationDataJson;if(f)try{m.invitationData=JSON.parse(f)}catch(g){throw new Error(`Invalid JSON in invitationData: ${f}`)}return m},this.startOutgoingCall=(g,m,f,S,v)=>this.signalingSession.startOutgoingCall(f,S,this.getSignalingSessionCallOptions(m),Date.now()-v,g),this.joinGivenConversation=(g,m,f,S,v,C)=>{const _=1==(1&m.callStartOptions.muteFlags),E=1==(1&m.callStartOptions.preheatFlags),T=m.callStartOptions?.invitationDataJson,I=m.callStartOptions?.sharedLineCallInvitationContentJson;this.logger.info(`[${g}][joinGivenConversation] muted=${_}, isPreheatOnly=${E},\n            sharedLineCallInvitationContentJson=${I}, invitationDataJson=${T}`);const b={muted:_,isPreheatOnly:E,clientEndpointCapabilities:m.callStartOptions.clientEndpointCapabilities,clientEndpointDebugContent:m.callStartOptions.clientEndpointDebugContent,isEmergency:this.isEmergency,meetingData:this.meetingData,meetingPreferences:m.meetingPreferences,meetingRegistrationId:m.callStartOptions?m.callStartOptions.meetingRegistrationId:"",participantPin:m.callStartOptions?m.callStartOptions.participantPin:"",additionalEndpointProperties:m?.callStartOptions?.additionalEndpointProperties,applyServerMute:m?.applyServerMute,publishedStates:m?.callStartOptions.publishedStates,invitationData:m?.callStartOptions.invitationDataJson};if(I)try{b.sharedLineCallInvitationContent=JSON.parse(I)}catch(g){throw new Error(`Invalid JSON in sharedLineCallInvitationContent: ${I}`)}if(T)try{b.invitationData=JSON.parse(T)}catch(g){throw new Error(`Invalid JSON in invitationDataJson: ${T}`)}return this.signalingSession.joinGivenConversation(C,this.callId,f,S,Date.now()-v,b,g)},this.executeCallTransfer=(g,m,f,S)=>{this._setTransferState(1);const v=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return 0===f?this.signalingSession.transferCallAsync(g,"TransferTypeStandard",void 0,S,m):2===f&&this.signalingSession.transferCallAsync(g,"TransferTypeVoicemail",void 0,S,m),v},this.executeConsultCallTransfer=(g,m,f,S,v)=>{this._setTransferState(1);const C=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,S,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});return this.signalingSession.consultTransferCallAsync(g,m,f,S,v),C},this.createUpdateParticipantPromise=(g,m)=>this._callOperationHandler.createPendingOperation("UpdateParticipantsProperties",g,m),this._getCallEndOperation=()=>this._callOperationHandler.hasPendingOperation("StopCall")?this._callOperationHandler.waitForOperation("StopCall"):this._callOperationHandler.hasPendingOperation("Reject")?this._callOperationHandler.waitForOperation("Reject"):this._callOperationHandler.hasPendingOperation("CallRedirect")?this._callOperationHandler.waitForOperation("CallRedirect"):Promise.resolve(),this._onAcknowledgeError=(g,m,f,S)=>{f.logFailure(g);let v,C={code:2,success:!1,fatal:!0},_=7;throw isPhaseError("SendAttach",g)&&(v={code:vi.InternalServerError,subCode:yi.AttachFailed,phrase:Ai.AttachFailed}),isPhaseError("ProcessIncomingCallRequest",g)&&(v={code:vi.NotAcceptable,subCode:yi.AttachActionFailed,phrase:Ai.BadNotificationPayload},C={code:0,success:!1,fatal:!0}),isOneOfPhaseErrors(wi,g)&&(_=47),g?.error&&g.error.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer&&(v={code:vi.MediaError,subCode:yi.MediaOfferProcessingError,phrase:Ai.IncompatibleOffer}),this.callTelemetry.updateOperationData("Acknowledge",{phases:S,error:getPIISafeObject(g)},m),this._callOperationHandler.maybeRejectOperation("Acknowledge",C,void 0,m),this.stopInternal({rejectReason:v,causeId:m,terminatedReason:_}),C},this._onAcknowledgeSuccess=(g,m,f)=>(g.logSuccess("success"),this.callTelemetry.updateOperationData("Acknowledge",{phases:m},f),{code:1,success:!0}),this._processOfferedModalities=(g,m)=>{this.handleOfferedModalities(g,m);const f=this.callUsesMixer?void 0:{modalityOverride:g};return this.updateMediaModalities(f,m)},this._handleOfferProcessingError=(g,m,f)=>(f.logFailure(`handleOfferProcessingError=${g}`),g?.error?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer?(this.callTelemetry.recordEvent("IncompatibleOffer",void 0,m),this.signalingSession.supportsNewOfferRequest()?(this.newOfferRequestDeferred=defer(),this.attachToCallAndGetOffer.promise.then((()=>this.mediaSession.rejectNegotiationAsync(g.error,m))).then((()=>this.signalingSession.requestNewOffer(this.mediaSession.getAcceptedTypes(),m))).then((()=>this.newOfferRequestDeferred.promise)).then((g=>this.mediaSession.processOfferAsync(g,m))).catch((g=>(this.callTelemetry.recordEvent("NewOfferFailed",getPrintableObject(g),m),Promise.reject(g))))):Promise.reject(g)):Promise.reject(g)),this._trySendProvisionalMediaAnswer=g=>Promise.resolve(void 0).then((()=>this.mediaSession.createAnswerAsync(!0,g))).then((g=>g.blob?(this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",void 0,generateCauseId(),{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.signalingSession.setProvisionalAnswerAsync(g).then((()=>this.mediaAcknowledgmentOperation))):Promise.resolve(void 0))),this.checkForCallIdUpdate=(g,m)=>{if(this.callId!==g){this.logger.info(`[${m}][checkForCallIdUpdate] old=${this.callId}, new=${g}`),this.setCallId(g);try{this.event("callIdChanged").raise(this.callId)}catch(g){this.logger.error(`Error raising call ID change: ${g}`)}this.raiseChanged()}},this.handleRemoteParticipantStateInOneToOneCall=g=>{if(!this.callUsesMixer&&3===this.state){const m=this.participants[0];m&&m.setState(3,void 0,g)}},this.handleRemoteParticipantJoinedInOneToOneCall=(g,m)=>{if(!this.callUsesMixer&&3===this.state){const f=this.participants.filter((m=>m.id===g.id))[0];f?f.setState(3,void 0,m):this.logger.logFailure(`[${m}][handleRemoteParticipantJoinedInOneToOneCall]unable to find particpant ${scrubMriOrOmit(g.id)}`)}},this.handleRemoteParticipantStateInObservingCall=(g,m,f)=>{const S=m.isLobby;if(8===this.state){const m=S?7:3;g.setState(m,void 0,f)}},this.getTelemetryFromPhaseExecution=g=>{const m={phase:g.phase,phases:g.phases,code:g.error&&g.error.code,subCode:g.error&&g.error.subCode,message:g.error&&g.error.message,error:g.error};return(m.code||m.message)&&delete m.error,m},this._setTransferState=g=>{this.transferState!==g&&(this.logger.info(`Transfer: state set: ${g}`),this._transferState=g,this.callTelemetry.recordEvent("_SetTransferState",{state:g}),this.raiseChanged())},this._setParkState=g=>{this.parkState!==g&&(this.logger.info(`Parking: state set: ${g}`),this._parkState=g,this.callTelemetry.recordEvent("_SetParkState",{state:g}),this.raiseChanged())},this.prepareNegotiationResultForTelemtry=g=>({isComplete:g.isComplete,activeModalities:g.activeModalities,configuredModalities:g.configuredModalities,initiator:scrubMriOrOmit(g.initiator),attemptedModalities:g.attemptedModalities,offeredModalities:g.offeredModalities}),this.prepareTelemetryForOfferAnswer=g=>g&&g.mediaContent&&{isRenegotiation:!!g.renegotiation,isEscalation:!!g.mediaContent.isTwoPartyToMultiPartyEscalation,mediaTypes:g.mediaTypes,newOffer:g.mediaContent.newOffer},this.updateLocalParticipantEndpoints=g=>{const m=this.logger.createFnLogger("updateLocalParticipantEndpoints",""),f=[];(0,Mi.forEach)(g,(g=>{const m=convertSignalingEndpointDetails(g,this.getSelfClientEndpointCapabilities());f.push(m)})),this.endpoints.endpointDetails=f;const S=this.getDataChannelSourceId();-1!==S&&this.dataChannel&&this.dataChannel.setDataChannelSourceId(S),m.info(`selfEndpointDetails=${JSON.stringify(this.endpoints)}`)},this.handleParticipantsMutedUpdated=g=>{if(void 0!==g?.muteUnmuteResponse){this.logger.info(`handleParticipantsMutedUpdated: number of infos: ${g.muteUnmuteResponse.length}`);for(const m of Object.keys(g.muteUnmuteResponse)){const f=this.getParticipant(m);f&&f.handleServerMutedInfoUpdate(g.muteUnmuteResponse[m])}}},this.handleSelfUnmuteUpdatedInfo=(g,m)=>{if(void 0!==g?.muteUnmuteResponse){this.logger.info("handleSelfUnmuteUpdatedInfo");for(const f of Object.keys(g.muteUnmuteResponse)){const S=g.muteUnmuteResponse[f];if(f===this.localSignalingParticipant.id){const g=(0,Mi.find)(S,(g=>g.participantId===this.localSignalingParticipant.participantId));if(void 0===g)continue;const f=(0,Mi.find)(this.localSignalingParticipant.endpointDetails,(m=>m.participantId===g.participantId));handleMuteUnmuteParticipantInfo(this.logger,f,g,!1)&&this.handleSelfServerMutedState(m)}}}},this.state=0,this.terminatedReason=0,this.callStats=new pr(this.mediaAgent?.getConfigProvider()),this.callDeviceManager=this.createCallDeviceManager(),this.callTelemetry=new ai(this.logger,this._callCreationTime),this.collectMediaStatsDeferred=defer(),this.setCallId(E),this.setGroupId(C),this.setThreadId(_),this.setMessageId(P),this.setSkypeId(this.currentUserSkypeIdentity.id),this.setParticipantId(T),this.setCallOrigin(0),this.logger=this.logger.createChild((()=>{const g=(this.endpointId||"").substr(0,8),m=(this.participantId||"").substr(0,8);return`Web/${this.instanceNumber}[${this.callId}][${g}][${m}][${this.state}]`})),this._staleRosterCheckFixForPluginless=this.ecsProvider.getEcsConfig("SkypeCalling","staleRosterCheckFixForPluginless"),this._transfereeAcceptanceWithoutWaitingForConv=this.ecsProvider.getEcsConfig("SkypeCalling","transfereeAcceptanceWithoutWaitingForConv"),this.initializeSignalingSession(T),this.signalingSession.setLocationInfo(R,w,D),this.streamManager=new Zr(this.participantId,null,this.callStats.localStats,this.logger),this.mediaAgent&&(this.dataChannel=new Cs(this.logger),this.dataChannel.on("remoteUserEventsReceived",((g,m)=>this.event("remoteUserEventsReceived").raise(g,m))),this.dataChannel.on("onDataChannelStateUpdated",(g=>{"Failed"===g&&(this.logger.error("onDataChannelStateUpdated: datachannel creation failed, will remove data modality"),this.mediaStateConfigurationHelper.removeModality(3),this.updateSignalingDSHMessageSubscription(!0),this.updateMediaModalities())})),this.screenSharingControl=new $s(this.logger,this.dataChannel,this,this.telemetryLoggers,this.ecsProvider),this.initializeMediaControlPlane(),this.mediaAgent.handleSendMidCallTelemetry(this.sendMidCallTelemetry.bind(this)));const O={enableErrorConversion:this.ecsProvider.getEcsConfig("SkypeCalling","enableErrorConversion")};this._deferUsingMicrotask=this.ecsProvider.getEcsConfig("SkypeCalling","deferUsingMicrotask"),Mr.instance.setDeferToQueueMicrotask(this._deferUsingMicrotask),Mr.instance.setLogger(f),this.logger.info(`operationHandlerEcsConfig: ${JSON.stringify(O)}`),this._preferredMpLocation=this.ecsProvider.getEcsConfig("SkypeCalling","preferredMpLocation"),this._isUpdatePropertiesSpecifiedAllowedByEcs=this.ecsProvider.getEcsConfig("SkypeCalling","enableUpdateParticipantsSpecified"),this._enableResolveScreenSharingWhenNegotiationComplete=this.ecsProvider.getEcsConfig("SkypeCalling","enableResolveScreenSharingWhenNegotiationComplete"),this._callOperationHandler=new Si(this.logger,this.callTelemetry,O,void 0,((g,m)=>{this.preconditions(g,m)})),this._participantOperationHandler=new Si(this.logger,this.callTelemetry,O),this.setMeetingData(M),this.initializeLiveStreamConfigProvider()}get callMode(){return this._callMode}get callId(){return this._callId}get endpointId(){return this._endpointId}get isHostless(){return this.signalingSession.isHostLessCall}get transferState(){return this._transferState}get parkState(){return this._parkState}get capabilities(){return this._capabilities}get publishedStates(){return this._publishedStates}get dataChannelAdapter(){return this.dataChannel}get participantId(){try{const g=this.signalingSession?.participantManager?.localParticipant?.participantId;this._participantId=g||this._participantId}catch(g){this.logger.error("Error updating participantId")}return this._participantId}get role(){return this.localSignalingParticipant.role}get meetingRole(){return this.localSignalingParticipant.meetingRole}get advancedMeetingRole(){return this.localSignalingParticipant.advancedMeetingRole}get maskedIdentityDetails(){return{isIdentityMasked:this.localSignalingParticipant.isIdentityMasked,maskedIdSeqNumber:this.localSignalingParticipant.maskedIdSeqNumber,maskedId:this.localSignalingParticipant.maskedId}}get participantType(){return this.localSignalingParticipant.participantType}get isMuted(){return 2===this._muteState||3===this._muteState}get tenantId(){return this.localSignalingParticipant.tenantId}get mediaLegId(){return this._mediaLegId}get isIncomingOneOnOneVideoCall(){return this.isOneToOneCall()&&this.isSomeoneStreamingVideo}get mediaStreams(){return this.streamManager.streams}get origin(){return this._origin}get propertyBag(){return this.localSignalingParticipant.propertyBag}get version(){return this.localSignalingParticipant.version}get isAudioStreamConnected(){return this._isAudioStreamConnected}set isAudioStreamConnected(g){this._isAudioStreamConnected!==g&&(this._isAudioStreamConnected=g,this._wasAudioStreamConnected=this._wasAudioStreamConnected||g,this.raiseChanged())}setMeetingRole(g){g!==this.localSignalingParticipant.meetingRole&&(this.logger.info(`changing self role to [${g}]`),this.localSignalingParticipant.meetingRole=g,this.event("meetingRoleUpdated").raise(g))}setAdvancedMeetingRole(g){g!==this.localSignalingParticipant.advancedMeetingRole&&(this.logger.info(`changing self advanced meeting role to [${g}]`),this.localSignalingParticipant.advancedMeetingRole=g,this.event("advancedMeetingRoleUpdated").raise(g))}setParticipantType(g){g!==this.localSignalingParticipant.participantType&&(this.logger.info(`changing self participant user type to [${g}]`),this.localSignalingParticipant.participantType=g,this.event("participantTypeUpdated").raise(g))}setPropertyBag(g){g&&!(0,Mi.isEqual)(g,this.localSignalingParticipant.propertyBag)&&(this.logger.info(`changing self participant property bag to [${g}]`),this.localSignalingParticipant.propertyBag=g,this.event("propertyBagUpdated").raise(g))}setPropertyRosterVersion(g){g!==this.localSignalingParticipant.version&&(this.logger.info(`changing self participant property version to [${g}]`),this.localSignalingParticipant.version=g,this.event("propertyRosterVersionUpdated").raise(g))}setMaskedIdentityDetails(g=!1,m,f){this.localSignalingParticipant.isIdentityMasked===g&&this.localSignalingParticipant.maskedIdSeqNumber===m&&this.localSignalingParticipant.maskedId===f||(this.localSignalingParticipant.isIdentityMasked=g,this.localSignalingParticipant.maskedIdSeqNumber=m,this.localSignalingParticipant.maskedId=f,this.logger.info(`self participant masked identity details updated to [${JSON.stringify(this.maskedIdentityDetails)}]`),this.event("maskedIdentityDetailsUpdated").raise(this.maskedIdentityDetails))}get spamRiskLevel(){return this._spamRiskLevel}set spamRiskLevel(g){g&&(this._spamRiskLevel=g)}get spamStirAttestation(){return this._spamStirAttestation}set spamStirAttestation(g){g&&(this._spamStirAttestation=g)}async getScreenHandle(g){if(!this.sharedScreenHandle){const m=!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled,f=!!this.mediaSession&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&!this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing,S=this.mediaStateConfigurationHelper.isSending(0)&&f&&m,v=3===g?.getType()?g?.getDeviceId():void 0,C=this.callDeviceManager.getDeviceManager(getAgentMediaType(2));C.setAudioSharingRequested(S),this.sharedScreenHandle=await C.createDevicesHandle({audio:S,sharing:!0},"pluginlessCall:getScreenHandle()",v),this.subscribeOnSharedScreenHandleEvents(this.sharedScreenHandle)}return this.sharedScreenHandle}setCallOrigin(g){this.logger.info(`Set call origin to ${g}`),this._origin=g,this.callTelemetry.setCallOrigin(g),this.callTelemetry.recordEvent("_SetCallOrigin",{origin:g})}setMediaLegId(g){this._mediaLegId=g,this.callStats.setMediaLegId(g)}setCallId(g){this.callTelemetry.setCallId(g),this.callStats.setCallId(g),this._callId=g}setEndpointId(g){this._endpointId=g,this.logger.info(`[endpointId=${truncate(this._endpointId)}]`),this.callTelemetry.setEndpointId(g),this.callStats.setEndpointId(g)}setFailureType(g){this.callTelemetry.setFailureType(g),this.failureType=g}setParticipantId(g){this._participantId=g,this.logger.info(`[participantId=${this._participantId}]`),this.callTelemetry.setParticipantId(this.participantId)}setCallerMri(g){this.callerMri=g,this.logger.info(`[callerMri=${scrubMriOrOmit(this.callerMri)}]`)}setTransferorMri(g){const m=stripMriAliases(g);m!==this.transferorMri&&(this.transferorMri=m,this.logger.info(`transferorMri: ${scrubMriOrOmit(this.transferorMri)}`),this.raiseChanged())}setGroupId(g,m=generateCauseId()){this.logger.info(`[${m}][setGroupId] groupId=${scrubMriOrOmit(g)}`),this.groupId!==g&&(this.groupId=g,this.callTelemetry.setGroupId(g),this.event("groupIdChanged").raise(g))}setMeetingData(g){if(g){if(g.meetingCode&&(!this.meetingData||this.meetingData&&g.meetingCode!==this.meetingData.meetingCode)){const m=g.meetingCode;this.logger.info(`[setMeetingData] meetingCode=${m}`),this.callTelemetry.setMeetingCode(m),this.signalingSession.setMeetingCode(m)}if(g.meetingUrl&&(!this.meetingData||this.meetingData&&g.meetingUrl!==this.meetingData.meetingUrl)){const m=g.meetingUrl.split("?")[0];this.logger.info(`[setMeetingData] meetingUrl=${g.meetingUrl}`),this.callTelemetry.setMeetingUrl(m),this.signalingSession.setMeetingUrl(m)}}this.meetingData=g}setHuddleGroupCall(g){this.isHuddleGroupCall!==!!g&&(this.logger.info(`[setHuddleGroupCall] new isHuddleGroupCall=${g}`),this.isHuddleGroupCall=g,this.callTelemetry.setIsHuddleGroupCall(!0))}setComplianceRecordingContent(g,m){try{if(!(0,Mi.isEqual)(this.complianceRecordingContent,m)){this.complianceRecordingContent=m;const f=m?JSON.stringify(m):"";this.callTelemetry.setComplianceRecordingContentLength(f.length),this.logger.info(`[${g}][setComplianceRecordingContent] complianceRecordingContentLength=${f.length}`)}}catch(m){this.logger.error(`[${g}][setComplianceRecordingContent] ${m}`)}}setThreadId(g,m=generateCauseId()){this.threadId!==g&&(this.logger.info(`[${m}][setThreadId] threadId=${getLoggableThreadId(g)}`),this.threadId=g,this.callTelemetry.setThreadId(g))}setBackroomThreadId(g,m=generateCauseId()){this.backroomThreadId!==g&&(this.logger.info(`[${m}][setBackroomThreadId] backroomThreadId=${getLoggableThreadId(g)}`),this.backroomThreadId=g,this.callTelemetry.setBackroomThreadId(g))}setMessageId(g,m=generateCauseId()){this.messageId!==g&&(this.logger.info(`[${m}][setMessageId] messageId=${scrubMriOrOmit(g)}`),this.messageId=g,this.callTelemetry.setMesageId(g))}setSkypeId(g,m=generateCauseId()){this.skypeId!==g&&(this.logger.info(`[${m}][setSkypeId]`),this.skypeId=g,this.callTelemetry.setSkypeId(g))}setCallType(g,m){const f=this.logger.createFnLogger("setCallType",m);f.info(`current=${this.callType}, newValue: ${g}`),2!==this.callType||1!==g?g!==this.callType&&(this.callType=g,this.callTelemetry.setCallType(g),2===g&&this.callStats.localStats.call.event(2),this.raiseChanged()):f.logFailure("De-escalating to P2P should not happen!")}setConversationType(g,m){this.logger.createFnLogger("setConversationType",m).info(`current=${this.conversationType}, newValue=${g}`),g!==this.conversationType&&(this.conversationType=g,this.callTelemetry.setConversationType(g),this.raiseChanged())}setCallUsesMixer(g,m){this.callUsesMixer!==!!g&&(this.logger.info(`[${m}][setCallUsesMixer] new value=${g}`),this.callUsesMixer=g,this.callTelemetry.recordEvent("_CallUsesMixer",{newValue:g},m),this.dataChannel.setConfigProviderView(this.mediaSession?.getSessionConfig())),g&&this.mediaControlPlane.start()}setIsEscalationInProgress(g,m){this.logger.info(`[${m}][setIsEscalationInProgress] currentValue=${this.isEscalationInProgress}, newValue=${g}`),this.isEscalationInProgress=g,this.allowScreenSharingControl()&&this.screenSharingControl.setIsEscalationInProgress(g),this.callTelemetry.recordEvent("_EscalationInProgress",void 0,m)}setFromApplicationType(g,m){g&&(this.fromApplicationType=g,this.callTelemetry.recordEvent("_SetFromApplicationType",{fromApplicationType:g},m))}processCallStartOptions(g,m){const f=this.logger.createFnLogger("_ProcessCallStartOptions",m);try{1&g.preheatFlags&&(this.isPreheatEnabled=!0)}catch(g){f.logFailure(g)}}getlocalScreenShareStream(){return(0,Mi.find)(this.localMediaStreams,(g=>2===g.mediaType))}setMeetingLayout(g,m){throw new Error("Method not implemented.")}async selectDevices(g){this.callDeviceManager.isVirtualDeviceEnabled?this.callDeviceManager.selectDevices(g):this.logger.error("allowVirtualDeviceInCall not enabled.")}async getSelectDevices(){return this.callDeviceManager.getSelectedDevices()}createStage(g){throw new Error("Method not implemented.")}updateDisplayName(g){this.logger.info("updating displayName"),this.localSignalingParticipant.displayName=g,this.signalingSession.participantManager.localParticipant.displayName=g}init(g){if(this.logger.info(`init callInitOptions:${safeJsonStringify(getPIISafeCallInitOptions(g))}`),this.signalingSessionCallOptions={teamsMessageId:g.messageId,enableGroupCallMeetupGeneration:g.enableGroupCallMeetupGeneration,meetingInfo:g.meetingInfo,emergencyContent:g.emergencyContent?JSON.parse(g.emergencyContent):void 0,broadcastContext:g.broadcastContext,endpointMetadata:g.endpointMetadata},this.setMessageId(g.messageId),this.onBehalfOfMri=g.onBehalfOf,this.onBehalfOfUserDisplayName=g.onBehalfOfUserDisplayName,g.threadId&&(this.setThreadId(g.threadId),this.signalingSession.setThreadId(g.threadId)),this.groupId&&this.signalingSession.setGroupId(this.groupId),this.signalingSession.setCallOptions(this.signalingSessionCallOptions),g.transferContext){switch(this.logger.info("Transfer: Call.init, set transferContext",scrubITransferContext(g.transferContext)),this.signalingSession.setTransferContext(g.transferContext.context),g.transferContext.transferType){case 1:this.setCallOrigin(2);break;case 0:this.setCallOrigin(1);break;case 2:this.setCallOrigin(3);break;default:throw new Error(`TransferType: ${g.transferContext.transferType} doesn't have a switch option`)}g.transferContext.context.callAcceptanceCallback?this._transferredCallAcceptanceCallback=g.transferContext.context.callAcceptanceCallback:this.logger.info("[failed]Transfer: Missing transferred call acceptance callback"),g.transferContext.transferorMri&&this.setTransferorMri(g.transferContext.transferorMri)}this.setIsEmergency(!!g.isEmergency),this.raiseChanged()}getIncomingRawAudioStream(){if(!this.mediaSession)throw this.logger.error("can not execute getIncomingRawAudioStream as there is no mediaSession"),new Error("NoMediaSession");return this.mediaSession.getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.unmixedAudioProvider?Promise.resolve(this.unmixedAudioProvider):Promise.reject("No audio provider available")}setDeviceManager(g){}async startVideo(g,m=generateCauseId()){return this.startStopVideo(!0,m)}async stopVideo(g,m=generateCauseId()){return this.startStopVideo(!1,m)}async dumpVideoSourceImages(){return Promise.reject(60)}async hold(g,m=generateCauseId(),f,S){const v=this.logger.createFnLogger("Hold",m);return v.info(`[Hold][${m}] negotiationTag ${g} hold options: ${safeJsonStringify(f)}`),4===this.state?(v.logFailure("Trying to put a call on hold which is already held state, early resolving the promise"),Promise.resolve(void 0)):f?.isLocal?this.localHold(m,f,S):this.holdWithRenegotiate(m,f)}async holdWithRenegotiate(g,m){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,g,m):(this.logger.logFailure(`[Hold][${g}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async localHold(g,m,f){return this.isValidHoldResumeCallState(this.state)?this.setHold(!0,g,m,f):(this.logger.logFailure(`[LocalHold][${g}] Trying to hold a call in an invalid state: ${this.state}`),Promise.reject(`Trying to hold a call in an invalid state: ${this.state}`))}async unhold(g,m=generateCauseId()){const f=this.logger.createFnLogger("Unhold",m);return 3===this.state?(f.logFailure("Trying to resume a call which is already in connected state, early resolving the promise"),Promise.resolve(void 0)):4===this.state?(f.info(`current hold state ${this.requestedHoldState}`),this.setHold(!1,m)):(f.logFailure(`Trying to resume a call in an invalid state: ${this.state}`),Promise.reject(`Trying to resume a call in an invalid state: ${this.state}`))}canMerge(g,m){const f=g.isOneToOneCall(),S=3===this.state,v=4===g.state,C=f&&S&&v;return this.logger.info(`[${m}][canMerge] Call ${g.callId} isOneToOne ${f} isCallConnected ${S} call.state ${this.state} isMergeOnHold ${v} mergeCall.state ${g.state} CanMerge result: ${C}`),C}async updateEndpointMetadata(g,m=generateCauseId()){return this.signalingSession.updateEndpointMetadata(g,m)}async sendDtmfTone(g){if(this.mediaSession){const m=this.toneToString(g);return m?(this.logger.info(`[${causeId}][sendDtmfTone]DtmfTone: <omitted>`),Promise.resolve(this.mediaSession.sendDtmf(m))):Promise.reject(new Error("Unsupported DtmfTone"))}return Promise.reject(new Error("no mediaSession"))}async setAudioUsageMode(g){return Promise.reject(60)}async setAudioMidcallConfig(g,m){return Promise.reject(60)}async setAudioMidcallConfigJson(g,m=generateCauseId()){if(!g)return Promise.reject(60);isDefined(g.enableSpatialAudio)&&this.mediaSession?.configureSpatialAudio(g.enableSpatialAudio,m),g.noiseSuppressionMode&&await this.setNoiseSuppressionMode(g.noiseSuppressionMode,g.enableAEC)}async setParticipantSpatialAudioPositions(g,m=generateCauseId()){const f=g.map((g=>({sourceId:this.participants.find((m=>m.id===g.participantId))?.audio.id,x:g.x,y:g.y})));return this.mediaSession?.setParticipantSpatialAudioPositions(f,m)}async setNoiseSuppressionMode(g,m){return this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe||this.mediaSession.getSessionConfig().config.wasmdns.enableNoiseSuppression?"Auto"===g?this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaSession.getSessionConfig().config.wasmvqe.defaultVqeMode)):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(this.mediaSession.getSessionConfig().config.wasmdns.noiseSuppressionMode,m))):this.mediaSession.getSessionConfig().config.wasmvqe.enableVqe?this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(g,this.mediaSession.getSessionConfig().config.wasmvqe.enableAec))):this.mediaAgent.getDeviceManager().setAudioEffects(this.mediaAgent.getDeviceManager().effectsManager.vqeModeToAudioEffectType(this.mediaAgent.getDeviceManager().effectsManager.nsModeToVqeMode(g,m))):Promise.resolve()}setInitialTelemetry(g,m,f,S){let v,C,_,E,T;switch(g){case"Subscribe":case"SubscribeWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("SUBSCRIBE"),f||this.callTelemetry.setOperationVariant(g,"CCWM"),this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:S,conversationServiceUrl:f});break;case"Acknowledge":0!==this.state&&8!==this.state&&this.callTelemetry.maybeRecordOperationSuccess(g,{code:4}),this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("callee"),this.signalingSession.setInitialTelemetry(g,{causeId:S});break;case"JoinCall":case"JoinWithMeetingData":this.callTelemetry.setDirection("Incoming"),this.callTelemetry.setSelfParticipantRole("join"),1&m.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(g,"Preheat"),v=this.telemetryDataFromCallStartOptions(m.callStartOptions),v&&this.callTelemetry.updateOperationData(g,v,S),C=1==(1&m.callStartOptions.muteFlags),_=1==(1&m.callStartOptions.preheatFlags),E={muted:C,isPreheatOnly:_},this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:S,conversationServiceUrl:f,joinCallOptions:E,offerGenerationTime:Date.now()-m.callStartTime});break;case"StartCall":case"StartWithMeetingData":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),1&m.callStartOptions.preheatFlags&&this.callTelemetry.setOperationVariant(g,"Preheat"),v=this.telemetryDataFromCallStartOptions(m.callStartOptions),v&&this.callTelemetry.updateOperationData(g,v,S),T=m.callStartOptions,this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:S,conversationServiceUrl:f,callStartOptions:T,offerGenerationTime:Date.now()-m.callStartTime});break;case"StartCallToVoiceMail":case"StartCallWithNudge":case"StartCallAndUnpark":this.callTelemetry.setDirection("Outgoing"),this.callTelemetry.setSelfParticipantRole("caller"),this.signalingSession.setInitialTelemetry(g,{correlationId:this.callId,causeId:S,conversationServiceUrl:f,startCallOptions:m.callStartOptions,offerGenerationTime:Date.now()-m.callStartTime})}}async setHold(g,m,f,S){const v=this.logger.createFnLogger("setHold",m,`hold=${g}`);if(!this.canToggleAudio||this.callHoldResumeDeferred)return Promise.reject(new Error("can not set hold as it is already in progress"));this.callHoldResumeDeferred=defer(),this.isHoldInProgress=g,this.canToggleAudio=!1,this.canToggleVideo=!1,this.canToggleScreenSharing=!1,this.requestedHoldState=g;const always=()=>{this.canToggleAudio=!0,this.canToggleScreenSharing=!0,this.canToggleVideo=!0};v.info(`start, holdOptions: ${JSON.stringify(f)}`);const C=this.callHoldResumeDeferred.promise,_=g?"Hold":"Unhold",E={debugContent:{clientScenario:this.convertClientScenario(S)}};try{if(g?this.isMuteOnHold=f&&f.isLocal&&5!==this.state:this.prepareModalitiesForResume(m),!this.isMuteOnHold){const g=await this.updateMediaModalities(void 0,m);this.updateMediaState(g,m),this.updateScreenSharingState(g,m)}g&&(this.prepareModalitiesForHold(m),5===this.state&&this.finishCallHoldResume(),this.setCallState(4,m)),this.isMuteOnHold&&this.setMuteOnHold(g,m),always();const S={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(_,S,null,m,E)}catch(f){this.callTelemetry.recordOperationFailure(_,{error:getPIISafeObject(f)},null,m,E),v.logFailure(f),always(),this.callHoldResumeDeferred?.reject(new Error(`Failed setting hold state to ${g}`)),this.callHoldResumeDeferred=null}return C}transferCall(g){return this.logger.warn("transferCall is deprecated, please use callBlindTransfer instead"),this.callBlindTransfer(g)}callBlindTransfer(g,m=generateCauseId(),f){return this.executeCallTransfer(g,m,0,f)}callSafeTransfer(g,m=generateCauseId(),f){return this.executeCallTransfer(g,m,0,f)}transferCallToVoicemail(g,m=generateCauseId()){return this.executeCallTransfer(g.transferTargetMri,m,2,void 0)}callConsultativeTransfer(g,m=generateCauseId(),f,S){const v=this.logger.createFnLogger("ConsultativeTransfer",m),C=g.participants[0],_=C&&C.acceptedBy||C&&C.id;return v.info(`transferTargetParticipantLegId: ${f} targetMri: ${scrubMriOrOmit(_)}`),this.executeConsultCallTransfer(g.callId,_,f,m,S)}async consultativeTransferWithPickupCode(g,m){const f=this.logger.createFnLogger("ConsultativeTransferWithPickupCode",m);if(f.info(`pickup code: ${g}`),!g||isNaN(Number(g)))return f.info("pickup code cannot be empty"),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const S=this._callOperationHandler.createPendingOperation("_CallTransferInProgress",void 0,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),v=`4:${Xt.SERVER_HOLD}`,C={unparkContent:{pickupCode:Number(g)}},_={disableForwardingAndUnanswered:!1};return this.signalingSession.transferCallAsync(v,"TransferTypeStandard",C,_,m),S}callRedirect(g,m=generateCauseId()){return this.logger.createFnLogger("CallRedirect",m).info(`redirectOptions: ${JSON.stringify(g)}`),this.stopInternal({terminatedReason:75,redirectOptions:g,causeId:m}).then((()=>({code:vi.CallRedirected,subCode:yi.CallRedirectedSuccess,phrase:Ai.CallEndReasonRedirected,resultCategories:["Success"]})))}convertParkContext(g){switch(g){case 1:return"sharedLinePark";case 4:return"sharedLineParkV2";case 0:return"teamPark";case 3:return"serverHoldV2";case 5:return"callPark";default:return"serverHold"}}convertClientScenario(g){switch(g){case 0:return"breakoutRoom";case 1:return"musicOnHoldV2";case 2:return"sharedLineAppearanceV2";default:return}}park(g,m=generateCauseId()){const f=this.convertParkContext(g);return this.logger.info(`[${m}] [ParkCall] start -  context ${g} parkType ${f}`),5===g?(this.callTelemetry.recordOperation(`${getParkTypeName(f)}`,m),this._pendingParkPromise=this._callOperationHandler.createPendingOperation("CallParkV2",void 0,m)):this._pendingParkPromise=this._callOperationHandler.waitForOperation("ParkCall"),"serverHoldV2"!==f&&"callPark"!==f&&this._setParkState(1),this.signalingSession.parkCallAsync(f,m).catch((g=>{this.logger.info(`[${m}] [ParkCall] error in parkCallAsync (synchronous error) : ${getPIISafeObject(g)}. Hold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("ParkCall",{error:getPIISafeObject(g)},m)})),this._pendingParkPromise}async unpark(g,m){const f=this.convertParkContext(g);return this.logger.info(`[${m}] [UnparkCall] start -  context ${g} parkType ${f}`),this._pendingUnparkPromise=this._callOperationHandler.waitForOperation("UnparkCall"),this.signalingSession.unparkAsync(f,m).catch((g=>{this.logger.info(`[${m}] [UnparkCall] error in unparkAsync (synchronous error) : ${getPIISafeObject(g)}. Unhold promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UnparkCall",{error:getPIISafeObject(g)},m)})),this._pendingUnparkPromise}getServerHoldLocation(){return this._pendingParkPromise.then((()=>(this.logger.info(`getServerHoldLocation ${this.serverHoldLocation}`),this.serverHoldLocation)))}getParkAdditionalContextJson(){return this._pendingParkPromise.then((()=>(this.logger.info(`getParkAdditionalContextJson ${this.parkAdditionalContextJson}`),this.parkAdditionalContextJson)))}getJoinBlob(){return Promise.resolve(JSON.stringify({conversationUrl:this.signalingSession.getConversationUrl(),conversationId:this.callId}))}getTechnicalInformationJson(){return Promise.resolve(JSON.stringify(this.mediaSession.getCallTechnicalInfo()))}isOneToOneCall(){return 1===this.callType&&1===this.participants.length}setMuteOnHold(g,m){this.mediaSession.muteHold(g,m),g||(this.computeCallState(m),this.isMuteOnHold=!1),this.finishCallHoldResume()}finishCallHoldResume(g){g?this.callHoldResumeDeferred?.reject(g):this.callHoldResumeDeferred?.resolve(),this.isHoldInProgress=!1,this.callHoldResumeDeferred=null}computeCallState(g){let m=3;this._callInLobby?m=10:this.signalingSession.participantManager.localParticipant.isStaging&&(m=13),this.logger.info(`[${g}][computeCallState] the call state will be set to ${m}`),this.setCallState(m,g)}async prepareModalitiesForResume(g){this.mediaStateConfigurationHelper.isSending(1)&&await this.turnOnLocalVideoPreview(g)}async prepareModalitiesForHold(g){await this.turnOffLocalVideoPreview(g)}updateMediaState(g,m){this.setVideoOn(g.video===this.mediaAgent.constants.MEDIA_STATE.sendReceive||g.video===this.mediaAgent.constants.MEDIA_STATE.send,m),this.setAudioOn(g.audio===this.mediaAgent.constants.MEDIA_STATE.sendReceive||g.audio===this.mediaAgent.constants.MEDIA_STATE.send,m)}updateScreenSharingState(g,m){this.setScreenSharingOn(g.sharing===this.mediaAgent.constants.MEDIA_STATE.send,m)}subscribeOnSharedScreenHandleEvents(g){this.sharedHandleSubs=g.on("onStreamStateChanged",((g,m)=>this.onSharingStreamStateChanged(g)))}unsubscribeFromSharedScreenHandleEvents(){this.sharedHandleSubs.dispose(),this.sharedHandleSubs=null}onSharingStreamStateChanged(g){const m=generateCauseId();this.logger.info(`[${m}] Sharing stream state moved to ${g}`);const f={mediaType:2,mediaDirection:1,mediaStreamState:_PluginlessCall.streamingStatetoMediaStreamState(g)};this.event("mediaStreamStateChanged").raise(f),this.callStats.localStats.screenShare.streamStateChanged(g),"stopped"===g&&(this.canToggleScreenSharing=!0,this.stopScreenSharing(),"screenSharingCall"!==this.conversationType||this.participants.some((g=>3===g.state))||this.stop(!0,m))}async startScreenSharing(g,m,f,S=generateCauseId()){this.allowScreenSharingControl()&&(this.screenSharingControl.shutdownControlForViewer(),this.screenSharingControl.initControlForSharer(f));const v=this.logger.createFnLogger("StartScreenSharing",S);if(!this.canToggleScreenSharing)return Promise.reject(new Error("cannot start screen sharing"));if(this.isScreenSharingOn)return v.logSuccess("Resolving early because screen sharing is already on"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(v.logFailure("called before the renegotiation deferred for the previous one has been closed"),this.screenSharingRenegotiationDeferred.resolve()),this.screenSharingRenegotiationDeferred=defer(),this.callStats.localStats.newSession(2),this.callStats.localStats.screenShare.start(),this.mediaStateConfigurationHelper.isDisabled(2)&&v.info("sharing modality was skipped till now. Adding it now"),this.canToggleScreenSharing=!1;const restoreToggle=()=>{this.canToggleScreenSharing=!0};this.callStats.localStats.screenShare.event(0);try{const m=await this.getScreenHandle(g);await m.acquire(),v.logSuccess("sharing stream acquired"),this.mediaStateConfigurationHelper.enableModality(2),this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities(void 0,S),v.logSuccess("updateMediaModalities done"),this.callStats.localStats.screenShare.negotiationStateChanged("started"),this.setScreenSharingOn(!0,S),restoreToggle(),await this.screenSharingRenegotiationDeferred.promise,this.enableControlInjector(),this.callStats.localStats.screenShare.negotiationStateChanged("completed")}catch(g){this.callTelemetry.updateOperationData("StartScreenSharing",{error:getPIISafeObject(g)},S),this.setScreenSharingOn(!1,S),this.mediaStateConfigurationHelper.removeModality(2),restoreToggle(),this.disposeSharingScreenHandle();const m=g.error;throw m&&m.code===vi.GlareError?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),v.logFailure("starting screen sharing failure with reason glare")):"ScreenSharingStopped"===g.reason?(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","sharingStopped"),v.logFailure("expectedstarting screen sharing failure with reason stopped")):(this.callStats.localStats.screenShare.negotiationStateChanged("rejected","other"),v.logFailure(g)),g}}async stopScreenSharing(g,m,f=generateCauseId()){const S=this.logger.createFnLogger("StopScreenSharing",f);if(!this.canToggleScreenSharing)return S.logFailure("cannot stop screen sharing"),Promise.reject(new Error("cannot stop screen sharing"));if(!this.isScreenSharingOn&&!this._callOperationHandler.hasPendingOperation("StartScreenSharing"))return S.logFailure("screensharing is not on, ignore this operation"),Promise.resolve();this.screenSharingRenegotiationDeferred&&(this.screenSharingRenegotiationDeferred.reject({reason:"ScreenSharingStopped"}),this.screenSharingRenegotiationDeferred=null),this.mediaStateConfigurationHelper.removeModality(2),this.canToggleScreenSharing=!1;const always=()=>{this.canToggleScreenSharing=!0,this.callStats.localStats.screenShare.stop(),this.disposeSharingScreenHandle(),this.mediaAgent.getDeviceManager().shareSystemSound(!1),this.mediaAgent.getDeviceManager().setAudioSharingRequested(!1)};return this.allowScreenSharingControl()&&this.screenSharingControl.shutdownControlForSharer(),this.updateMediaModalities(void 0,f).then((()=>this.setScreenSharingOn(!1,f))).then(always,(g=>{throw S.logFailure(g),this.callTelemetry.updateOperationData("StopScreenSharing",{error:getPIISafeObject(g)},f),always(),g}))}async startDataChannel(g,m=generateCauseId()){if(!this.allowDataChannel())throw new Error("startDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.enableModality(3),await this.updateMediaModalities({},m)}async stopDataChannel(g,m=generateCauseId()){if(!this.allowDataChannel())throw new Error("stopDataChannel is disabled since ECS flag prohibits it");this.mediaStateConfigurationHelper.removeModality(3),await this.updateMediaModalities({},m)}allowDataChannel(){return this.mediaSession?!!this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&(this.isOneToOnePSTNCall()?this.mediaSession.getSessionConfig().config.enableDataChannelPstn:this.mediaSession.getSessionConfig().config.enableDataChannel):(this.logger.warn("datachannel not allowed as there is no mediaSession"),!1)}isGiveControlEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?g.enableGiveControl:(this.logger.warn("Give take control is not enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!1)}isInitialSignalingDSHSubscriptionEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?!this.allowDataChannel()||g.enableInitialSignalingDSHSubscription:(this.logger.warn("Initial signaling dsh subscription is enabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}isSignalingDSHFallbackEnabled(){const g=this.mediaSession?.getSessionConfig()?.config;return g?g.enableSignalingDSHFallback:(this.logger.warn("Falling back to Signaling DSH is disabled as there is no mediaSession, sessionConfig or sessionConfig.config"),!0)}allowScreenSharingControl(){return this.screenSharingControl?.isScreenSharingControlEnabled()&&this.allowDataChannel()}updateSignalingDSHMessageSubscription(g){this.signalingSession.updateDominantSpeakerHistoryMessageSubscription(g),g&&this.mediaSession?.getDiagnostics?.().dshDiagnostics.setCurrentActiveStrategy("signaling")}async sendUserEvents(g,m){return this.dataChannel.sendUserEvents(g,m)}async shareSystemSound(g,m=generateCauseId()){const f=this.logger.createFnLogger("ShareSystemSounds",m,`shareSystemSound=${g}`);if(!(!!this.mediaSession&&this.mediaSession.getSessionConfig().mediaConfig.simulcastSessionEnabled&&this.mediaSession.getSessionConfig().config.enableAudioSharing&&this.mediaSession.getSessionConfig().config.requireUserActionForAudioSharing))return f.error("shareSystemSound not allowed"),Promise.reject(60);try{return void this.mediaAgent.getDeviceManager().shareSystemSound(g)}catch{return f.error("shareSystemSound failed with device error"),Promise.reject(58)}}async mute(g=generateCauseId()){return this.isMuted?Promise.reject(getRejectTransactionEnd("TransactionDisallowed")):this.muteUnmute(!0,g)}async unmute(g=generateCauseId()){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")&&await this._callOperationHandler.waitForOperation("_PromotionToRealtime"),this.muteUnmute(!1,g)}async muteSpeaker(g=generateCauseId()){return this.muteUnmuteSpeaker(!0,g)}async unmuteSpeaker(g=generateCauseId()){return this.muteUnmuteSpeaker(!1,g)}async muteParticipants(g,m,f=generateCauseId()){const S=this.logger.createFnLogger("MuteParticipants",f,`muteScope=${g}`);S.info(`callParticipants count=${m.length}`);const v=_PluginlessCall.convertMuteScope(g);if(void 0===v)return S.logFailure(`Unrecognized ${g}`),Promise.reject(new Error("Unrecognized muteScope"));if(callStateIsAnyOf(this.state,[11,12]))return S.logFailure("Can not mute/unmute during preheat call"),Promise.reject(60);const C=[];return m.forEach((g=>{C.push(g.id)})),this.signalingSession.muteAsync(v,C,f).then((g=>this.handleParticipantsMutedUpdated(g))).catch((g=>(this.callTelemetry.updateOperationData("MuteParticipants",{error:getPIISafeObject(g)},f),S.logFailure(g),g?.endCode?Promise.reject(g.endCode):Promise.reject(g))))}async startAudio(g,m=generateCauseId()){const f=this.logger.createFnLogger("StartAudio",m);if(this.receiveOnlyAudioOnCallStart=!1,3!==this.state)return f.logFailure("Cannot startAudio when call is not connected"),Promise.reject(60);if(this.mediaStateConfigurationHelper.enableModality(0),this.callUsesMixer&&this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.isSending(1))try{await this.turnOnLocalVideoPreview(m)}catch(g){return f.logFailure(g),Promise.reject(25)}const S=await this.startStopAudio(!0,m);return await this.signalingSession.recordTelemetryForStartAudio(S),{code:S}}async stopAudio(g,m=generateCauseId()){const f=this.logger.createFnLogger("StopAudio",m);if(3!==this.state)return f.logFailure("Cannot stopAudio when call is not connected"),Promise.reject(60);this.mediaStateConfigurationHelper.removeModality(0);const S=await this.startStopAudio(!1,m);return await this.turnOffLocalVideoPreview(m),await this.signalingSession.recordTelemetryForStopAudio(S),{code:S}}assimilate(g,m,f,S=generateCauseId()){return Promise.reject(new Error("Not implemented"))}async merge(g,m,f=generateCauseId()){const S=this.logger.createFnLogger("MergeCall",f);S.error(`merge callId ${g.callId} callMergeOptions ${JSON.stringify(m)}`);const v=this.canMerge(g,f);if(!v)return S.info(`Error. ${getPrintableObject(v)}`),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const C=[];g.participants.forEach((g=>{C.push(this._callOperationHandler.createPendingOperation("MergeCall",g.id,f))}));return(await this.mergeCallByAddParticipantWithReplaces(m,g.participants,g,1,"MergeCall",f,C,void 0))[0]}async mergeParticipants(g,m,f,S,v){const C=[];if(!g)return Promise.reject(getRejectTransactionEnd("Invalid callToMerge"));if(0===m.length)return Promise.reject(getRejectTransactionEnd("Invalid participantIds"));const _=[];for(const f of m){const m=findParticipantUsingParticipantLegId(g,f);if(m){const g=generateGuid(),v={id:m.id,participantId:g,replacementParticipantId:f,nonMaskedId:m.nonMaskedId};C.push(v),_.push(this._callOperationHandler.createPendingOperation("MergeParticipant",g,S))}else{const g={code:406,subCode:5201,phrase:`participantLegId ${f} is invalid!`};_.push(Promise.reject(getRejectTransactionEnd(g)))}}return this.mergeCallByAddParticipantWithReplaces(f,C,g,3,"MergeParticipant",S,_,v)}async mergeWithPickupCode(g,m,f=generateCauseId()){const S=this.logger.createFnLogger("MergeWithPickupCode",f);if(S.info(`mergeWithPickupCode: pickup code: ${g}, groupId: ${scrubMriOrOmit(m.groupId)}, threadId: ${getLoggableThreadId(m.threadId)} messageId: ${m.messageId}`),!g||isNaN(Number(g)))return S.info("mergeWithPickupCode: pickup code cannot be empty"),Promise.reject(getRejectTransactionEnd("mergeWithPickupCode: pickup code cannot be empty"));const v={additionalData:m.additionalData,groupId:m.groupId,threadId:m.threadId,messageId:m.messageId,replacementType:2,pickupCode:Number(g)},C={id:`4:${Xt.SERVER_HOLD}`};return Promise.resolve().then((()=>Promise.all(this.signalingSession.addParticipantsAsync([C],v,f)))).then((g=>(g.length>0&&this.signalingNotifications.onParticipantJoined(g[0],f),Promise.resolve({code:0,subCode:0,phrase:"TransactionComplete"})))).catch((g=>{S.logFailure(`Participant was not added to call, error=${getPrintableObject(g)}`);const m=this._handleParticipantOperationFailure("MergeWithPickupCode",g,f,null,!0).reason;return Promise.reject(g?g.endCode:m||0)}))}async setMaxVideoChannels(g){return Promise.reject(60)}async stop(g=!1,m=generateCauseId(),f,S){const v=this.logger.createFnLogger("StopAudio",m);if(6===this.state)return v.logFailure("Trying to stop a call which is already Disconnecting"),Promise.reject(new Error("cannot stop call in Disconnecting state"));if(7===this.state)return v.logFailure("Trying to stop a call which is already Disconnected"),Promise.reject(new Error("cannot stop call in Disconnected state"));if(this.disposedPromise)return Promise.reject("Call already ended");let C=0;1===this.state&&(C=10);const _={terminatedReason:C,forEveryone:g,causeId:m,...f,rejectReason:S?{clientReasonSubCode:S.clientSubCode,clientReasonPhrase:S.clientPhrase}:{}};return this.stopInternal(_)}publishState(g,m){const f=getPluginlessStateType(g.type),S=this.getPluginlessPublishLevel(g.level),v=g.participantIds&&g.participantIds.length>0?"specified":void 0;return this.callTelemetry.setOperationVariant("PublishState","specified"===v?`${f}Specified`:`${f}None`,m),this.signalingSession.publishStateAsync(f,S,m,g.content,v,g.participantIds)}publishStatesForEveryone(g,m){const f=getPluginlessStateType(g.type),S=this.getPluginlessPublishLevel(g.level),v="all";return this.callTelemetry.setOperationVariant("PublishState",`${f}All`),this.signalingSession.publishStateAsync(f,S,m,g.content,v)}removeState(g,m){return this.signalingSession.removeStateAsync(m,"specified",void 0,g.stateIds).then((g=>Promise.resolve()))}removeStatesForEveryone(g,m){const f=getPluginlessStateType(g.type);return this.signalingSession.removeStateAsync(m,"all",f,void 0).then((g=>Promise.resolve()))}updateMeetingSettings(g,m){return this.signalingSession.updateMeetingSettingsAsync({allowRaiseHands:g.allowRaiseHands,attendeeRestrictions:g.attendeeRestrictions,lockMeeting:g.lockMeeting,breakoutRoomsEnabled:g.breakoutRoomsEnabled,allowPresentersToManageBreakoutRooms:g.allowPresentersToManageBreakoutRooms,disableMdpClientAudioRecording:g.disableMdpClientAudioRecording,refreshSettings:g.refreshSettings},m)}updateMeetingGroups(g,m){this.logger.info(`[UpdateMeetingGroups][${g}] options ${safeJsonStringify(m)}`);const f=this._callOperationHandler.waitForOperation("UpdateMeetingGroups",g),S={fromGroup:m.fromGroup,toGroup:m.toGroup,scope:mapParticipantScope(m.scope)};return m.participants&&(S.participants=createParticipantListFromMriMap(m.participants)),this.signalingSession.updateMeetingsGroupsAsync(g,S).catch((m=>{this.logger.info(`[${g}] [UpdateMeetingGroups] error in updateMeetingGroups (synchronous error) : ${getPIISafeObject(m)}. updateMeetingGroupsPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingGroups",{error:getPIISafeObject(m)},g)})),f}updateMeetingLiveState(g,m){return this.logger.info(`[UpdateMeetingLiveState][${g}] options ${safeJsonStringify(m)}`),this.signalingSession.updateMeetingLiveStateAsync(g,m).catch((m=>{this.logger.info(`[${g}] [UpdateMeetingLiveState] error in updateMeetingLiveState (synchronous error) : ${getPIISafeObject(m)}. promise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateMeetingLiveState",{error:getPIISafeObject(m)},g)})),this._callOperationHandler.waitForOperation("UpdateMeetingLiveState",g)}updateMeetingStates(g,m=generateCauseId()){var f;this.logger.info(`[UpdateMeetingStates][${m}]`);const S={},v=[];g.operationId=g.operationId||m;for(const C of Object.keys(g.meetingStates)){const _=g.operationId+"_"+C;v.push(_);const E=this._callOperationHandler.createPendingOperation("UpdateMeetingStates",_,m);S[f=g.operationId]??(S[f]={}),S[g.operationId][C]=E,this.callTelemetry.recordOperation("UpdateMeetingStates",m,_)}return Promise.resolve().then((()=>this.signalingSession.updateMeetingStatesAsync(m,g))).then((g=>{for(const f of v)this.callTelemetry.updateOperationData("UpdateMeetingStates",{data:getPIISafeObject(g)},m,f)})).catch((g=>{for(const f of v)this.callTelemetry.updateOperationData("UpdateMeetingStates",{error:getPIISafeObject(g)},m,f);this.logger.logFailure(g)})).then((()=>S))}async updateParticipantInterpretationState(g,m){if(this.logger.info(`[UpdateParticipantInterpretationState][${g}] options ${safeJsonStringify(m)}`),0===m.length)return Promise.reject(getRejectTransactionEnd("Invalid UpdateParticipantInterpretationState options"));const f=this.signalingSession.updateParticipantInterpretationStateAsync(g,m),S=[];m.forEach((m=>{S.push(this._callOperationHandler.createPendingOperation("UpdateParticipantInterpretationState",m.id,g))}));for(let S=0;S<f.length;S++){const v=f[S],C=m[S];v.then((()=>{this.logger.logSuccess(`updateParticipantInterpretationState succeeded for [id=${scrubMriOrOmit(C.id)}]`);const m={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("UpdateParticipantInterpretationState",m,C.id,g),this._callOperationHandler.maybeResolveOperation("UpdateParticipantInterpretationState",m,C.id,g)})).catch((m=>{this.logger.error(`[${g}] [UpdateParticipantInterpretationState] error in updateParticipantInterpretationState (synchronous error) : ${getPIISafeObject(m)}. updateParticipantInterpretationStatePromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("UpdateParticipantInterpretationState",{error:getPIISafeObject(m)},g);const f=this._handleParticipantOperationFailure("UpdateParticipantInterpretationState",m,g,C.id).reason,S=m?.endCode||f||0;this._callOperationHandler.maybeRejectOperation("UpdateParticipantInterpretationState",S,C.id,g)}))}return Promise.resolve(S)}async updateParticipantsProperties(g,m){const f=this.logger.createFnLogger("UpdateParticipantsProperties",m);if(f.info(`options ${scrubMriOrOmit(safeJsonStringify(g))}`),!g)return Promise.reject(getRejectTransactionEnd("Invalid input: UpdateParticipantsPropertiesContext"));const S={},v=g.scope,C=g.operationId,_=new Set;if("self"===v){const f=this.signalingSession.participantManager.localParticipant.id;for(const v in g.propertyBag){const g=mapMriAndPropertyNameToResolveString(f,C,v),E=this.createUpdateParticipantPromise(g,m);S[g]={[f]:E},_.add(g),this.callTelemetry.recordOperation("UpdateParticipantsProperties",m,scrubMriOrOmit(g))}}else{if("specified"!==v||!this._isUpdatePropertiesSpecifiedAllowedByEcs)return Promise.reject("This scope is not supported.");{const f=g.participants;for(const g of f){const f=g.id;for(const v in g.propertyBag){const g=mapMriAndPropertyNameToResolveString(f,C,v),E=this.createUpdateParticipantPromise(g,m);S[g]={[f]:E},_.add(g),this.callTelemetry.recordOperation("UpdateParticipantsProperties",m,scrubMriOrOmit(g))}}}}return f.info(`promises created: ${scrubMriOrOmit(safeJsonStringify(S))}`),this.signalingSession.updateParticipantsPropertiesAsync(g,_,C,m).catch((g=>{const v=getPrintableObject(g);f.info(`[failed][reason=${v}]`);const C={...g};this.callTelemetry.updateOperationData("UpdateParticipantsProperties",{error:getPIISafeObject(v)},m);for(const g of Object.keys(S))this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",C,g,m)})),Promise.resolve().then((()=>S))}joinMeetingGroup(g,m){this.logger.info(`[JoinMeetingGroup][${g}] options ${safeJsonStringify(m)}`);const f=this._callOperationHandler.waitForOperation("JoinMeetingGroup",g),S={meetingGroupId:m.meetingGroupId,...m.groupPreferences&&{groupPreferences:m.groupPreferences}};return this.signalingSession.joinMeetingGroupAsync(g,S).catch((m=>{const f=getPIISafeObject(m);this.logger.info(`[${g}] [JoinMeetingGroup] error in joinMeetingGroup (synchronous error) : ${f}. joinMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("JoinMeetingGroup",{error:f},g)})),f}leaveMeetingGroup(g,m){this.logger.info(`[LeaveMeetingGroup][${g}] options ${safeJsonStringify(m)}`);const f=this._callOperationHandler.waitForOperation("LeaveMeetingGroup",g),S={meetingGroupId:m.meetingGroupId};return this.signalingSession.leaveMeetingGroupAsync(g,S).catch((m=>{const f=getPIISafeObject(m);this.logger.info(`[${g}] [LeaveMeetingGroup] error in leaveMeetingGroup (synchronous error) : ${f}. leaveMeetingGroupPromise will be rejected by signaling callback`),this.callTelemetry.updateOperationData("LeaveMeetingGroup",{error:f},g)})),f}sendMessages(g,m){var f,S;this.logger.info(`[SendMessages][${g}]`);const v={};for(const C of m)if(0===C.scope){const m=this._callOperationHandler.createPendingOperation("SendMessages",C.operationId,g);v[C.operationId]={all:m},this.callTelemetry.recordOperation("SendMessages",g,C.operationId)}else if(1===C.scope)for(const m in C.to)if("participant"===C.to[m].level){const S=mapMriToResolveString(m,C.operationId),_=this._callOperationHandler.createPendingOperation("SendMessages",S,g);v[f=C.operationId]??(v[f]={}),v[C.operationId][m]=_,this.callTelemetry.recordOperation("SendMessages",g,S)}else if("endpoint"===C.to[m].level)for(const f in C.to[m].participantLegIdMap){const m=mapLegIdToResolveString(f,C.operationId),_=this._callOperationHandler.createPendingOperation("SendMessages",m,g);v[S=C.operationId]??(v[S]={}),v[C.operationId][f]=_,this.callTelemetry.recordOperation("SendMessages",g,m)}return this.signalingSession.sendProxiedMessageAsync(g,m).then((g=>{for(const m of g)m.then((g=>{this._callOperationHandler.maybeResolveOperation("SendMessages",g.transactionEnd,g.resolveString,g.causeId)})).catch((g=>{this._callOperationHandler.maybeRejectOperation("SendMessages",g.transactionEnd,g.resolveString,g.causeId)}));return v}))}updateMonitorSession(g,m=generateCauseId()){return Promise.reject(new Error("Not implemented"))}async updateMeetingRoles(g,m,f=generateCauseId()){return 3===this.state&&this.signalingSession.hasOwnProperty("updateMeetingRolesAsync")?this.signalingSession.updateMeetingRolesAsync(g,m,f):Promise.reject({code:oi.CODE.CLIENT_ERROR_CODE,subCode:oi.SUB_CODE.ACTION_NOT_ALLOWED,phrase:"ActionNotAllowed"})}stopInternal(g){const m=this.logger.createFnLogger("stopInternal",g.causeId),f=g.terminatedReason||0;let S=g.rejectReason&&(g.rejectReason.code||g.rejectReason.subCode)?g.rejectReason:this.getRejectionInfoFromTerminatedReason(f);if(g.rejectReason&&(S||(S={}),S.clientReasonSubCode=g.rejectReason.clientReasonSubCode,S.clientReasonPhrase=g.rejectReason.clientReasonPhrase),m.info(`started, terminatedReason=${f}, rejectReason=${safeJsonStringify(S)}`),6===this.state)return m.logFailure("Trying to stop a call which is already Disconnecting"),this.disconnectingPromise;if(7===this.state)return m.logFailure("Trying to stop a call which is already Disconnected"),this.disconnectingPromise;this.setCallState(6,g.causeId,f);const v={causeId:g.causeId,forEveryone:g.forEveryone,scope:this.mapEndpointScope(g.scope),redirectOptions:g.redirectOptions&&convertRedirectOptions(g.redirectOptions)};return 1===g.scope&&(S.code=oi.CODE.SUCCESS,S.subCode=oi.SUB_CODE.ENDED_BY_REMOTE_ENDPOINT,S.phrase=Ai.EndedByRemoteEndpoint),this.disconnectingPromise=Promise.all([this.cleanUpMedia(g.causeId,S).catch((g=>{throw m.logFailure(`cleanUpMedia failed with reason=${getPrintableObject(g)}`),g})),this.signalingSession.endAsync(S,v).catch((g=>{throw m.logFailure(`endAsync failed with reason=${getPrintableObject(g)}`),g}))]).catch((f=>{throw m.logFailure(f),this.cleanUp(g.causeId,S),f})).then((()=>this.cleanUp(g.causeId,S))).catch((m=>{throw this.callTelemetry.updateOperationData("StopCall",{error:getPIISafeObject(m)},g.causeId),this.setCallState(7,g.causeId,f),m})),this.disconnectingPromise}async cleanUp(g,m){return this.logger.info(`[${g}][cleanup]start`),this.disposedPromise||(this.disposedPromise=this.cleanUpFinalize(g,m),this._getCallEndOperation().catch(noop).then((()=>{const m={code:oi.CODE.CLIENT_ERROR_CODE,subCode:oi.SUB_CODE.ABANDONED};this._callOperationHandler.rejectPendingOperations(61,g,m),this._participantOperationHandler.rejectPendingOperations(47,g,m)}))),this.disposedPromise}async cleanUpMedia(g,m){return this.mediaDisposedPromise||(this.mediaDisposedPromise=(async()=>{this.callDeviceManager?.dispose(),this.callDeviceManager=null,this.turnOffLocalVideoPreview(g),this.localVideoContainer=null,this.disposeContentSharingSessions(),this.disposeSharingScreenHandle();const f=this.mediaSession;if(this.reportMediaStats=!!f,!f)return;this.unmixedAudioProvider.dispose(),this.mediaControlPlane.dispose(),this.dataChannel.dispose(),this.screenSharingControl.dispose(g),this.mediaSession=null,this.streamManager.setMediaSession(null,g),this.participants?.forEach((m=>{m.setMediaSession(null,g)}));const S=f.terminate(g,m);this.isVideoOn=!1,this.setMediaStream(this.isVideoOn,!1,1),this.setMediaStream(!1,!1,2),this.setMediaStream(!1,!1,0),this.isScreenSharingOn=!1,this.screenSharingRenegotiationDeferred?.reject(m),this.screenSharingRenegotiationDeferred=null,this.mediaStateConfigurationHelper.removeModality(1),this.mediaStateConfigurationHelper.removeModality(0),this.mediaStateConfigurationHelper.removeModality(3),this.mediaStateConfigurationHelper.removeModality(2),f?.getSessionConfig()?.config?.useOneDsLogger&&f.getSessionConfig().config.addTelemetryReportingCallback&&window.removeEventListener("beforeunload",this.beforeUnloadTelemetrySender);try{await S}finally{await this.collectCallStats(f)}})()),this.mediaDisposedPromise}async cleanUpFinalize(g,m){try{await this.cleanUpMedia(g,m)}catch(m){this.logger.info(`[${g}][cleanUpMedia] failure: ${getPrintableObject(m)}`)}const f=this.reportCallEndStats(this.reportMediaStats);this.mediaSession?.getSessionConfig().config.waitReportStatsAtCallStop&&await f}async createContentSharingSession(g,m,f,S,v=generateCauseId()){if("attendee"===(this.advancedMeetingRole||this.meetingRole)){const g={terminatedReason:8,terminatedReasonCode:403,terminatedReasonSubCode:0,errorMessage:"Failed due to insufficient permissions"};return Promise.reject(g)}const C=new ns(this.callTelemetry,this.logger,this.signalingSession,g,m,S,f);return this.contentSharingSessions.push(C),C.changed((()=>this.removeContentSessionIfEnded(C))),this.event("contentSharingChanged").raise(),Promise.resolve(C)}stopWithBeacon(g=generateCauseId()){return 6===this.state||7===this.state||this.signalingSession.endWithBeacon(g)}disposeContentSharingSessions(){this.contentSharingSessions.forEach((g=>{g.dispose(),this.removeContentSessionIfEnded(g)})),this.event("contentSharingChanged").raise()}isPreheatedOnly(){return!!(12===this.state||2===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall")||9===this.state&&this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))}removeContentSessionIfEnded(g){7!==g.contentSharingStatus&&8!==g.contentSharingStatus||(this.logger.info("stopping the content sharing session."),(0,Mi.remove)(this.contentSharingSessions,(m=>m.contentSharingGuid===g.contentSharingGuid)).length&&this.event("contentSharingChanged").raise())}getRejectionInfoFromTerminatedReason(g){switch(g){case 53:return{code:vi.MediaError,subCode:yi.MediaWhiteListingIssue,phrase:Ai.MediaWhiteListingIssue};case 4:return{code:vi.MediaError,subCode:this._wasAudioStreamConnected?yi.MediaDropAfterConnect:yi.MediaDropDuringConnect,phrase:this._wasAudioStreamConnected?Ai.MediaDropAfterConnect:Ai.MediaDropDuringConnect};case 47:return{code:vi.MediaError,subCode:yi.MediaOfferProcessingError,phrase:Ai.MediaOfferProcessingError};case 38:return{code:vi.MediaError,subCode:yi.MediaRenegotiationError,phrase:Ai.RetargetNotSupported};case 10:return{code:vi.Reject,subCode:yi.Success,phrase:Ai.CallEndReasonLocalUserInitiated};case 25:return{code:vi.UnknownError,subCode:yi.MediaUnknownError,phrase:Ai.MediaError};case 58:return{code:vi.MediaError,subCode:yi.MediaPermissionError,phrase:Ai.MediaPermissionError};case 7:return{code:vi.UnknownError,subCode:yi.Success,phrase:Ai.Unknown};case 0:case 1:return{code:vi.Success,subCode:yi.Success,phrase:Ai.CallEndReasonLocalUserInitiated};case 75:return{code:vi.CallRedirected,subCode:yi.CallRedirectedSuccess,phrase:Ai.CallEndReasonRedirected,resultCategories:["Success"]}}return null}async acknowledge(g,m,f=generateCauseId()){const S=this.logger.createFnLogger("Acknowledge",f),v=Date.now();if(this.setInitialTelemetry("Acknowledge",{callStartTime:v},"",f),0!==this.state&&8!==this.state)throw new Error(`Trying to acknowledge a call that has already been acted on ${this.state}`);S.info(`isMultiParty=${g.isMultiParty}`),S.info(`fromMixer=${g.fromMixer}`),S.info(`participantId=${g.participantId}`),S.info(`callType=${g.callType}`),this.attachToCallAndGetOffer=defer(),this.setCallType(g.isMultiParty?2:1,f),this.setCallUsesMixer(!!g.fromMixer,f),this.setCallerMri(stripMriAliases(g.callerId)),this.setTransferorMri(g.transferorId),this.transferorType=g.transferorType,this.transferorDisplayName=g.transferorDisplayName,this.incomingCallType=g.callType,this.consultativeCallId=g.consultativeCallId,this.callQueueInfo=g.callQueueInfo,this.setFromApplicationType(g.fromApplicationType,f),this.callStats.localStats.startCall();const C=createPhaseExecutor(S);try{C.executeSync("ProcessIncomingCallRequest",(()=>this.signalingSession.processIncomingCallRequest(g,m,f))),this.setParticipantId(this.participantId);if(C.executeSync("ResolvePotentialConflict",(()=>this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)))===this.signalingSession)return Promise.reject({code:7,success:!1});const mediaSetup=async()=>{C.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(f))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled());const g=this.signalingSession.getInitialMediaOfferFromIncomingCallPayload();this.callStats.setParticipantId(this.participantId),this.onBehalfOfMri=this.signalingSession.onBehalfOf,this.onBehalfOfUserDisplayName=this.signalingSession.onBehalfOfUserDisplayName,this.callPhoneLineType=this.signalingSession.callPhoneLineType;const m=await C.execute("WaitForMediaOffer",(()=>g?Promise.resolve(g):this.attachToCallAndGetOffer.promise));let v;try{v=await C.execute("ProcessOffer",(()=>this.mediaSession.processOfferAsync(m,f)))}catch(g){v=await this._handleOfferProcessingError(g,f,S)}await C.execute("ProcessOfferedModalities",(()=>this._processOfferedModalities(v,f))),await C.execute("TrySendingProvisionalAnswer",(()=>this._trySendProvisionalMediaAnswer(f)))},v=(()=>C.execute("SendAttach",(()=>this.signalingSession.sendAttachToCall(f))).then((()=>this.setCallState(1,f))))();return await Promise.all([v,mediaSetup()]).catch((async g=>{throw await v,g})),C.executeSync("OnAcknowledgeSuccess",(()=>this._onAcknowledgeSuccess(S,C.getTelemetryData(),f)))}catch(g){return this._onAcknowledgeError(g,f,S,C.getTelemetryData())}}async accept(g,m=generateCauseId()){const f=this.logger.createFnLogger("Accept",m);if(f.info(`accept, answerMediaType: ${g.answerMediaType},\n                            withVideo: ${g.withVideo},\n                            muted: ${g.muted},\n                            getSendMediaModalities: ${JSON.stringify(g.sendMediaModalities)},\n                            clientEndpointCapabilities: ${g.clientEndpointCapabilities},\n                            muteFlags: ${g.muteFlags}`),1!==this.state)throw new Error("Only calls in Notified state can be accepted");this.setCallOptions({callStartOptions:g,callStartTime:Date.now()}),this.setSessionIceTransportPolicy(g?.mediaConfiguration);const S=this._callOperationHandler.createPendingOperation("_ConnectCall",void 0,m);this.callStats.localStats.audio.start();const v=createPhaseExecutor(f);this.mediaSession.createAudioElement(m);const C=g.muted||1==(1&g.muteFlags);this.setMuted(C?2:this.isServerMuted?1:0,m),this.setCallState(2,m),this.connectCallPromise=this._callOperationHandler.waitForOperation("Accept");try{g.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient(),this.mediaStateConfigurationHelper.setCallAcceptOptions(g),this.mediaStateConfigurationHelper.isSending(1)&&await v.execute("StartVideoSafe",(()=>this.startVideoSafe(m))),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,m);const f=await v.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,m))),C=v.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(f)));await v.execute("handleEndpointStatesForAccept",(()=>this.handleEndpointStatesForAccept(2===this._muteState,g?.additionalEndpointProperties,m)));const _=await v.execute("CreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,m)));await v.execute("Accept",(()=>this.signalingSession.acceptAsync(_,C,g.clientEndpointCapabilities,m))),await v.execute("WaitForConnect",(()=>S)),this.handleRemoteParticipantStateInOneToOneCall(m),await v.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(m))),this.callTelemetry.updateOperationData("Accept",{phases:v.getTelemetryData()},m)}catch(g){let S=7,v={};throw this.callTelemetry.updateOperationData("Accept",this.getTelemetryFromPhaseExecution(g),m),g?.error&&(v={...g.error}),isOneOfPhaseErrors(Ri,g)&&(S=47),this.mediaSession?.getSessionConfig().config.stopCallOnAcceptFailure&&this.stopInternal({terminatedReason:S,causeId:m,rejectReason:v}),g.terminatedReason=S,f.logFailure(g),g}}async reject(g=generateCauseId(),m){const f=m?{clientReasonSubCode:m.clientSubCode,clientReasonPhrase:m.clientPhrase}:{};return 1!==this.state?Promise.reject(60):this.stopInternal({terminatedReason:10,causeId:g,rejectReason:f})}async join(g,m={},f=generateCauseId()){const S=Date.now();return this.setInitialTelemetry("JoinCall",{callStartOptions:m,callStartTime:S},g.conversationUrl,f),this.setCallerMri(stripMriAliases(g.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinCall"),this.joinOrStartCall({callStartOptions:getCallStartOptions(m),callStartTime:S},this.joinGivenConversation,f,g.conversationUrl)}async joinPreheatedCall(g,m){const f=this.logger.createFnLogger("JoinPreheatedCall",m),S=this.isServerMuted||1==(1&g.muteFlags),v=2==(2&g.muteFlags),C=createPhaseExecutor(f);this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinPreheatedCall");try{const f={endpointProperties:{preheatProperties:0}};this.setCallState(2,m),this.isCallModeStreaming()||(S?f.state={isMuted:!0}:(await C.execute("UnmuteInput",(()=>this.mediaSession.unmuteInputAsync(m))),this.setMuted(0,m)),v||(await C.execute("UnmuteOutput",(()=>this.mediaSession.unmuteOutputAsync(m))),this.setSpeakerMuted(!1,m))),await this.signalingSession.updateEndpointState(f,m,g.publishedStates),this.computeCallState(m)}catch(g){const S=7;let v;return f.logFailure(` error: ${S} ${getPrintableObject(g)}`),isTransactionEnd(g)?v=g:isPhaseError("UnmuteInput",g)?v={code:vi.LocalError,subCode:yi.MediaUnmuteMicrophoneError,phrase:getPrintableObject(g),causeId:m}:isPhaseError("UnmuteOutput",g)&&(v={code:vi.LocalError,subCode:yi.MediaUnmuteSpeakerError,phrase:getPrintableObject(g),causeId:m}),this.callTelemetry.updateOperationData("JoinPreheatedCall",{phases:C.getTelemetryData(),error:getPIISafeObject(g)},m),this.stopInternal({causeId:m,terminatedReason:S,rejectReason:v}),Promise.reject(v)}}async start(g={},m=generateCauseId()){const f=Date.now();return this.setCallerMri($n+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCall",{callStartOptions:g,callStartTime:f},"",m),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCall"),this.joinOrStartCall({callStartOptions:getCallStartOptions(g),callStartTime:f},this.startOutgoingCall,m)}async startCallToVoicemail(g,m=generateCauseId()){const f=Date.now();return this.setCallerMri($n+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartCallToVoiceMail",{callVoicemailStartOptions:g,callStartTime:f},"",m),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallToVoiceMail"),this.joinOrStartCall({callVoicemailStartOptions:g,callStartTime:f},this.startVM,m)}async joinCallWithoutCallModality(g,m={},f=generateCauseId()){const S=Date.now();this.setCallerMri(g.groupCallInitiator),this.setCallType(2,f);const v={callStartOptions:getCallStartOptions(m),callStartTime:S};return this.setInitialTelemetry("Subscribe",v,g.conversationUrl,f),0!==this.state?(this.logger.info(`[${f}][joinCallWithoutCallModality]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(v),this.setCallState(8,f),this.signalingSession.subscribeToCall(g.conversationUrl,this.callId,m.clientEndpointCapabilities,{meetingRegistrationId:m.meetingRegistrationId,participantPin:m.participantPin,clientEndpointDebugContent:m.clientEndpointDebugContent,additionalEndpointProperties:m.additionalEndpointProperties},f).catch((g=>isTransactionEnd(g)?(this.logger.info(`[${f}][joinCallWithoutCallModality] ${getPrintableObject(g)}`),Promise.reject(g)):Promise.reject(convertReason(g)))),this._callOperationHandler.waitForOperation("Subscribe",void 0,f))}startWithMeetingData(g,m){const f=Date.now();return this.setCallerMri($n+this.currentUserSkypeIdentity.id),this.setInitialTelemetry("StartWithMeetingData",{callStartOptions:m,callStartTime:f},"",g),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartWithMeetingData"),this.joinOrStartCall({callStartOptions:getCallStartOptions(m),callStartTime:f,meetingPreferences:{shouldResurrect:m.shouldResurrect}},this.startOutgoingCall,g)}joinWithMeetingData(g,m,f){const S=Date.now();return this.setInitialTelemetry("JoinWithMeetingData",{callStartOptions:f,callStartTime:S},m.conversationUrl,g),this.setCallerMri(stripMriAliases(m.groupCallInitiator)),this.connectCallPromise=this._callOperationHandler.waitForOperation("JoinWithMeetingData"),this.joinOrStartCall({callStartOptions:getCallStartOptions(f),callStartTime:S,meetingPreferences:{shouldResurrect:f.shouldResurrect}},this.joinGivenConversation,g,m.conversationUrl)}subscribeWithMeetingData(g,m,f){const S=Date.now();this.setCallerMri(m.groupCallInitiator),this.setCallType(2,g);const v={callStartOptions:getCallStartOptions(f),callStartTime:S};return this.setInitialTelemetry("SubscribeWithMeetingData",v,m.conversationUrl,g),0!==this.state?(this.logger.info(`[${g}][subscribeWithMeetingData]Trying to subscribe to a call that has already been acted on`),Promise.reject(60)):(this.setCallOptions(v),this.setCallState(8,g),this.signalingSession.subscribeToCall(m.conversationUrl,this.callId,f.clientEndpointCapabilities,{meetingPreferences:{shouldResurrect:f.shouldResurrect},meetingData:this.meetingData,meetingRegistrationId:f.meetingRegistrationId,participantPin:f.participantPin,additionalEndpointProperties:f.additionalEndpointProperties},g).catch((m=>isTransactionEnd(m)?(this.logger.info(`[${g}][subscribeWithMeetingData] ${getPrintableObject(m)}`),Promise.reject(m)):Promise.reject(convertReason(m)))),this._callOperationHandler.waitForOperation("SubscribeWithMeetingData",void 0,g))}async startCallWithNudge(g,m={},f=generateCauseId()){this.setCallerMri($n+this.currentUserSkypeIdentity.id),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallWithNudge");const S=Date.now();if(this.logger.info(`[${f}][startCallWithNudge]startCallWithNudge for participants: ${scrubMriOrOmitList(g)}`),this.participants.length)return Promise.reject(48);if(m.isCast&&m.isHuddleGroupCall)return this.logger.logFailure(`isCast: ${m.isCast} isHuddleGroupCall: ${m.isHuddleGroupCall}`),Promise.reject(new Error("isCast or isHuddleGroupCall can only be set exclusively."));const v={};return v.callStartOptions=getCallStartOptions(m),v.invitationType=Hi.INVITATION_TYPE.NUDGE,v.participantsToNudge=g,v.callStartTime=S,this.setInitialTelemetry("StartCallWithNudge",v,"",f),this.joinOrStartCall(v,this.startOutgoingCall,f)}async startAndUnpark(g,m,f={},S=generateCauseId()){this.setCallerMri($n+this.currentUserSkypeIdentity.id);const v=this.logger.createFnLogger("StartCallAndUnpark",S),C=Date.now();this.setInitialTelemetry("StartCallAndUnpark",{callStartTime:C},"",S),v.info(`startAndUnpark for context: ${g}, pickupCode :${m}`),this.connectCallPromise=this._callOperationHandler.waitForOperation("StartCallAndUnpark");const _={};switch(_.callStartOptions=getCallStartOptions(f),_.pickupCode=m,_.parkContext=Xt.SERVER_HOLD,g){case 0:_.parkContext=Xt.PARK;break;case 1:_.parkContext=Xt.SHARED_LINE;break;case 5:_.parkContext=Xt.CALL_PARK;break;case 2:_.parkContext=Xt.SERVER_HOLD;break;default:throw new Error(`[startAndUnpark] unsupported ParkContext name: ${g}`)}return this.addParticipant(`4:${_.parkContext}`).catch((g=>v.logFailure("Failed to add participant to unparked call"))),this.joinOrStartCall(_,this.startOutgoingCall,S)}async admitParticipant(g,m=generateCauseId()){const f=generateAliasedMri(g),S=this.getParticipant(f),v=this._getParticipantLegId(S),C=v?{participantLegId:v}:{};if(S&&7!==S.state){const f={code:0,subCode:3552,phrase:"Participant is not in lobby state"};return this.callTelemetry.maybeRecordOperationSuccess("AdmitParticipant",f,g,m,C),Promise.reject(f)}return this.admitParticipantToCall(f,m,v)}admit(g,m){return this.signalingSession.admitAsync(m)}async callMeBack(g,m,f=generateCauseId()){const S=generateAliasedMri(`${$n}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri);return this.addCallMeBackParticipant(g,m||S,f)}async addParticipant(g,m={},f=generateCauseId()){return(await this.addParticipantsImpl([g],m,f,"addParticipant"))[0]}async addParticipants(g,m={},f=generateCauseId()){return this.addParticipantsImpl(g,m,f,"addParticipants")}async addParticipantsImpl(g,m={},f=generateCauseId(),S){if(this.logger.info(`[${f}][${S}] start`),this.isEmergency&&0===this.state&&(0!==this.participants.length||1!==g.length))return Promise.reject(new Error("Only 1 participant (the emergency operator) may be added to unstarted emergency calls"));if(m.participantInvitationData)try{JSON.stringify(m.participantInvitationData)}catch(g){throw this.logger.info(`[${f}][${S}] ${g}`),g}const v=[],C=[];if(g.forEach((g=>{const m=this.getOrCreateParticipant(g,f,!0);0===m.state||4===m.state?(C.push(m),v.push(this._participantOperationHandler.createPendingOperation("AddParticipant",m.id,f))):3===m.state?v.push(Promise.resolve(m)):this._participantOperationHandler.hasPendingOperationWithOperationId("AddParticipant",m.id)&&v.push(this._participantOperationHandler.waitForOperation("AddParticipant",m.id))})),0===C.length)return Promise.resolve(v);const _=!!m.disableUnmute,E=this.addParticipantsToCall(C,f,m.participantInvitationData,m.groupId,m.threadId,m.messageId,_,m.alternateId);return(0,Mi.zip)(E,C).forEach((async([g,m])=>{try{await g;const S=this._getParticipantLegId(this.getParticipant(m.id)),v=S?{participantLegId:S}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},m.id,f,v),this._participantOperationHandler.maybeResolveOperation("AddParticipant",m,m.id,f)}catch(g){this._participantOperationHandler.maybeRejectOperation("AddParticipant",g,m.id,f)}})),this.raiseChanged(this._participantChangedEventSkipConfig),Promise.resolve(v)}async nudgeParticipants(g,m,f={},S=generateCauseId()){return 2!==this.state&&3!==this.state?Promise.reject(48):this.signalingSession.nudgeParticipantsAsync({participantsIds:m,causeId:S,invitationData:f.participantInvitationData,newGroupId:f.groupId,newThreadId:f.threadId,newMessageId:f.messageId})}mapEndpointScope(g){let m="none";switch(g){case 0:m="specified";break;case 1:case 1:m="all";break;default:m="none"}return m}async removeParticipant(g,m=generateCauseId(),f,S){const v=this.logger.createFnLogger("removeParticipant",m);v.info("start");const C=this.mapEndpointScope(S);return this.signalingSession.removeParticipantAsync({id:g,endpointId:f},m,C).catch((f=>{v.logFailure(`Participant was not removed from call, error=${f}`);const S=this._handleParticipantOperationFailure("RemoveParticipant",f,m,g).reason;return Promise.reject(S||38)}))}async searchParticipants(g,m){return this.signalingSession.searchParticipantsAsync(g.searchQueryOptions,m)}async getAllParticipants(g,m){return this.signalingSession.getAllParticipantsAsync(g.scope,m)}set dominantSpeakerInfo(g){this.internalDominantSpeakerInfo=g}get dominantSpeakerInfo(){return this.internalDominantSpeakerInfo?this.internalDominantSpeakerInfo:this.mediaSession?.getSessionConfig().config.emptyInitialDSH?{speakerList:[],timestamp:null,noCurrentDominantSpeaker:!1}:{speakerList:this.participants.filter((g=>3===g.state)).map((g=>g.id)),timestamp:null,noCurrentDominantSpeaker:!1}}set slowedDownActiveTalkerInfo(g){(0,Mi.isEqual)(this.internalSlowedDownActiveTalkerInfo?.speakerList,g.speakerList)||(this.internalSlowedDownActiveTalkerInfo=g,this.raiseChanged())}get slowedDownActiveTalkerInfo(){return this.internalSlowedDownActiveTalkerInfo}startVideoSafe(g){return this.startVideo(g).catch((m=>{this.logger.info(JSON.stringify(m),"startVideoSafe",g)}))}async joinOrStartCall(g,m,f,S){const v=this.logger.createFnLogger("joinOrStartCall",f);if(0!==this.state&&8!==this.state&&!g.isPromotingToRealtime){const g="Trying to start a call that has already been acted on";return v.logFailure(g),Promise.reject(60)}if(this.signalingAgent.resolvePotentialCallConflict(this.signalingSession)===this.signalingSession)return Promise.reject(57);this.callStats.localStats.startCall();const C=8===this.state||1!==this.participants.length;v.info(`isMultiparty=${C}, reason: participants.length=${this.participants.length}`),this.setCallType(C?2:1,f),this.setCallUsesMixer(C,f),this.setCallOptions(g);const _=g.callStartOptions||{};if(1==(1&_.preheatFlags))this.setMuted(2,f),this.setSpeakerMuted(!0,f),this.setCallState(11,f);else{const g=!!_&&(_.muted||1==(1&_.muteFlags));this.setMuted(g?2:this.isServerMuted?1:0,f),this.setCallState(2,f)}const E=calculateJoinedFromForTelemetry(this.meetingData,this.threadId,this.messageId,this.groupId,!!S);this.callTelemetry.setJoinedFrom(E),this.signalingSession.setJoinedFrom(E),this.setHuddleGroupCall(!!g.callStartOptions?.isHuddleGroupCall);const T=this._callOperationHandler.createPendingOperation("_ConnectCall","",f);return T.catch(noop),await this.joinOrStartWithMedia(g,m,g.callStartTime,T,f,S),g.callStartOptions?.meetingRegistrationId&&this.callTelemetry.setHasMeetingRegistrationId(!0),g.callStartOptions?.participantPin&&this.callTelemetry.setHasParticipantPin(!0),T}setSessionIceTransportPolicy(g){const m=g?.connectionType;let f=je.ICE_TRANSPORT_POLICY.all;switch(m){case"AllSupported":f=je.ICE_TRANSPORT_POLICY.all;break;case"NoDirectConnection":f=je.ICE_TRANSPORT_POLICY.relay}this.mediaSession?.getSessionConfig().setIceTransportPolicy?.(f)}async joinOrStartWithMedia(g,m,f,S,v,C){const _=this.logger.createFnLogger("joinOrStartWithMedia",v);this.callStats.localStats.audio.start();const E=g.callStartOptions,T=E&&1&E.preheatFlags,I=createPhaseExecutor(_);if(g.callStartOptions?.sendMediaModalities&&(this.mediaStateConfigurationHelper=new fr(g.callStartOptions.sendMediaModalities)),this._preferredMpLocation){g.callStartOptions=g.callStartOptions||{};const m=g.callStartOptions.clientEndpointDebugContent?JSON.parse(g.callStartOptions.clientEndpointDebugContent):{};g.callStartOptions.clientEndpointDebugContent=JSON.stringify({preferredMpLocation:this._preferredMpLocation,...m})}try{E&&!T&&this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)&&this.mediaStateConfigurationHelper.isSending(2)&&(this.setCallUsesMixer(!0,v),await(await this.getScreenHandle()).acquire()),this.mediaStateConfigurationHelper.isSending(0)&&this.setAudioOn(!0,v),this.callUsesMixer||this.mediaStateConfigurationHelper.disableModality(2),_.info(`skipSharingModality=${!this.callUsesMixer}`),I.executeSync("InitializeMediaSession",(()=>this.initializeMediaSession(v))),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.getSessionConfig().config.alwaysNegotiateDataChannel&&this.mediaStateConfigurationHelper.enableModality(3),this.setSessionIceTransportPolicy(g?.callStartOptions?.mediaConfiguration),this.mediaSession.createAudioElement(v),this.callUsesMixer||C||this.isOneToOnePSTNCall()||g.callVoicemailStartOptions||(this.isSomeoneStreamingVideo=!0);const b=this._callOperationHandler.createPendingOperation("_WaitForAnswer","",v,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]});b.catch(noop);let A=!1;g.isPromotingToRealtime?(this.isSpeakerMuted=!0,A=!0,await I.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(v))),await I.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(v)))):E&&(T?(A=!0,await I.execute("MuteInput",(()=>this.mediaSession.muteInputAsync(v))),await I.execute("MuteOutput",(()=>this.mediaSession.muteOutputAsync(v))),this.setMuted(2,v),this.setCallUsesMixer(!0,v)):this.mediaStateConfigurationHelper.isSending(1)&&await I.execute("StartVideoSafe",(()=>this.startVideoSafe(v)))),E?.forceAudioSendModalityWithNullStream&&this.mediaSession.useNullAudioStreamClient();const P=await I.execute("UpdateMediaModalities",(()=>this.updateMediaModalities(void 0,v))),R=await I.execute("CreateOffer",(()=>this.mediaSession.createOfferAsync(v))),w=I.executeSync("GetSignalingMediaTypes",(()=>this.getSignalingMediaTypes(this.calculateModalityDirections({},v))));if(this.mediaStateConfigurationHelper.isSending(2)&&this.updateScreenSharingState(P,v),A||(await I.execute("MuteUnmute",(()=>this.muteUnmute(2===this._muteState,v))),await I.execute("MuteUnmuteSpeakers",(()=>this.muteUnmuteSpeaker(this.isSpeakerMuted,v)))),I.executeSync("CallStart",(()=>m(v,g,R,w,f,C))),await I.execute("WaitForConnect",(()=>S)),!this.isCallModeStreaming()||g.isPromotingToRealtime){const g=await I.execute("WaitForAnswer",(()=>b));if(!this.mediaSession?.processAnswerAsync)throw{error:"NoMediaSession",phase:"ProcessAnswer"};await I.execute("ProcessAnswer",(()=>this.mediaSession.processAnswerAsync(g,v,!1))),await I.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(v)))}this.callTelemetry.updateOperationData("_ConnectCall",{phases:I.getTelemetryData()},v),2!==E?.screenshareDirection&&4!==E?.screenshareDirection||(this.screenSharingControl.initControlForSharer(""),this.enableControlInjector())}catch(g){this.catchJoinOrStartCallError(g,v,_,I.getTelemetryData())}}catchJoinOrStartCallError(g,m,f,S){let v,C=0;throw f.logFailure(getPrintableObject(g)),g?.error&&(v={...g.error}),isPhaseError("MuteInput",g)?(C=7,v={code:vi.LocalError,subCode:yi.MediaMuteMicrophoneError,phrase:getPrintableObject(g),causeId:m}):isPhaseError("MuteOutput",g)?(C=7,v={code:vi.LocalError,subCode:yi.MediaMuteSpeakerError,phrase:getPrintableObject(g),causeId:m}):g?.type===this.mediaAgent.constants.MEDIA_ERROR.incompatibleOffer||isOneOfPhaseErrors(Ri,g)?C=47:g?.type===this.mediaAgent.constants.MEDIA_ERROR.permissionDeniedError?(C=58,v={code:vi.MediaError,subCode:yi.MediaPermissionError,phrase:getPrintableObject(g),causeId:m}):isPhaseError("WaitForAnswer",g)||isPhaseError("WaitForConnect",g)?C=g.error:isOneOfPhaseErrors(Pi,g)&&(C=7),this.callTelemetry.updateOperationData("_ConnectCall",this.getTelemetryFromPhaseExecution(g),m),this.callSetupFailed=!0,Promise.all([this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",C,"",m),this._callOperationHandler.maybeRejectOperation("_ConnectCall",C,"",m)]).then((()=>{this.isPromotingToRealtime()||this.stopInternal({causeId:m,terminatedReason:C,rejectReason:v})})).catch(noop),C}addCallMeBackParticipant(g,m,f){const S=this._participantOperationHandler.waitForOperation("CallMeBack",g),v=this.logger.createFnLogger("CallMeBack",f),C={id:g,assertedId:m};return this.signalingSession.callMeBackAsync(C).then((()=>{v.logSuccess(`successfully executed call me back, participantId = ${scrubMriOrOmit(g)}`),this._participantOperationHandler.resolveOperation("CallMeBack",0,g)})).catch((S=>{v.logFailure(`Call me back failed, participantId = ${scrubMriOrOmit(g)}, error = ${S}`),this._handleParticipantOperationFailure("CallMeBack",S,f,m,!1);const C=this._processError(S);let _={};C&&(_={...C}),_.failureReason=C.reason?C.reason:11,this._participantOperationHandler.rejectOperation("CallMeBack",_,g)})),S}addParticipantsToCall(g,m,f,S,v,C,_,E){const T=this.logger.createFnLogger("addParticipantsToCall",m);g.forEach((g=>{g.setState(1,void 0,m)}));const I=g.map((g=>({id:g.mri})));T.info(`participantIds=${g.map((g=>scrubMriOrOmit(g.id)))}, disableUnmute=${_}`);const b={additionalData:f,groupId:S,threadId:v,messageId:C,disableUnmute:_,alternateId:E};try{const g=this.signalingSession.addParticipantsAsync(I,b,m);return(0,Mi.zip)(g,I).map((async([g,f])=>{try{const S=await g;this.signalingNotifications.onParticipantJoined(S,m);const v=this._getParticipantLegId(this.getParticipant(f.id)),C=v?{participantLegId:v}:{};this.callTelemetry.recordOperationSuccess("AddParticipant",{code:0,subCode:0,phrase:""},S.id,m,C)}catch(g){const S=this._handleParticipantOperationFailure("AddParticipant",g,m,f.id).reason;throw this._removeParticipant(f,m,S),S}}))}catch(g){return T.logFailure(`Participants was not added to call, error=${g}`),(0,Mi.range)(I.length).map((()=>Promise.reject(1)))}}async mergeCallByAddParticipantWithReplaces(g,m,f,S,v,C,_,E){const T=this.logger.createFnLogger("mergeCallByAddParticipantWithReplaces",C),I=this.convertClientScenario(E),b={additionalData:g.additionalData,groupId:g.groupId,threadId:g.threadId,messageId:g.messageId,callIdToReplace:f.callId,replacementType:S,clientScenario:I},A=await this.signalingSession.addParticipantsAsync(m,b,C);for(let g=0;g<A.length;g++){const f=3===S?m[g].participantId:m[g].id;try{await A[g],T.logSuccess(` [participantInfos id =${scrubMriOrOmit(m[g].id)}]`);const S={debugContent:{replacementParticipantLegId:m[g].replacementParticipantId||void 0,clientScenario:I},participantLegId:m[g].participantId},_={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess(v,_,f,C,S),this._callOperationHandler.maybeResolveOperation(v,_,f,C)}catch(S){T.logFailure(`Participant was not added to call, error=${safeJsonStringify(S)}`);const _=this._handleParticipantOperationFailure(v,S,C,f,!0,I).reason;this._removeParticipant(m[g],C,_);const E=S?S.endCode:_||0;this._callOperationHandler.maybeRejectOperation(v,E,f,C)}}return Promise.resolve(_)}admitParticipantToCall(g,m,f){const S=this.logger.createFnLogger("admitParticipantToCall",m),v={id:g};return S.info("start"),this.signalingSession.admitParticipantAsync(v,m).then((v=>{S.info(`successfully admitted participant to call, participantId = ${scrubMriOrOmit(g)}`);const C=f?{participantLegId:f}:{},_={code:0,subCode:0,phrase:""};this.callTelemetry.recordOperationSuccess("AdmitParticipant",_,g,m,C)})).catch((f=>{S.logFailure(`Participant was not admitted to call, error=${f}`);const v=this._handleParticipantOperationFailure("AdmitParticipant",f,m,g);return Promise.reject(v)}))}_processError(g){let m;const f={reason:m};if(g?.endCode){const S=getTerminationCode(g.endCode.code,g.endCode.subCode);m=_PluginlessCall.getParticipantReasonFromTerminatedReason(S),f.reason=m,f.code=g.endCode.code,f.subCode=g.endCode.subCode,f.resultCategories=g.endCode.resultCategories,f.phrase=g.endCode.phrase}else f.phrase=`${g}`;return this.logger.info(`_processError error=${g} telemetryData=${JSON.stringify(f)}`),f}_handleParticipantOperationFailure(g,m,f,S,v=!0,C){this.callTelemetry.updateOperationData(g,{error:getPIISafeObject(m)},f,S);const _=this._processError(m),E=this.getParticipant(S);_.code&&E&&(E.callEndDiagnosticsInfo={callControllerCode:_.code,callControllerSubCode:_.subCode,phrase:_.phrase,resultCategories:_.resultCategories});try{if(v){const m={debugContent:{clientScenario:C},participantLegId:this._getParticipantLegId(E)||void 0};this.callTelemetry.recordOperationFailure(g,_,S,f,m)}}catch(g){this.logger.info(`_handleParticipantOperationFailure errow during recordOperationFailure ${g}`)}return _}_getParticipantLegId(g){return(0,Mi.has)(g,"endpoints.endpointDetails")&&g.endpoints.endpointDetails.length&&g.endpoints.endpointDetails[0].participantId?g.endpoints.endpointDetails[0].participantId:null}isOneToOnePSTNCall(){const g=this.signalingSession.isIncomingCall?this.callerMri:this.participants.length>0?this.participants[0].id:"";return this.isOneToOneCall()&&(0,Mi.startsWith)(g,Wn)&&(!this.incomingCallType||!this.callUsesMixer)}isParkedCall(){return this.isOneToOnePSTNCall()&&!!this.callOptions?.parkContext}async updateMediaModalities(g={},m=generateCauseId()){let f;const S=this.logger.createFnLogger("updateMediaModalities",m);return S.info(`callUsesMixer=${this.callUsesMixer},isSomeoneSharing=${this.isSomeoneSharing},isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),S.info(`options=${safeJsonStringify(g)},requestHoldState=${this.requestedHoldState},requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}`),f=g.modalityOverride?g.modalityOverride:this.requestedHoldState&&!this.isMuteOnHold?this.getMediaModalitiesForHold(m):this.calculateModalityDirections(g?.offered,m),S.info(`modalities=${safeJsonStringify(f)}`),await this.mediaSession.configureModalitiesAsync(f,m),f}calculateModalityDirections(g={},m){const f=this.logger.createFnLogger("calculateModalityDirections",m);f.info(`callUsesMixer=${this.callUsesMixer}, isEscalationInProgress=${this.isEscalationInProgress}`);const S={audio:this.calculateAudioDirection(g.audio,f),video:this.calculateVideoDirection(g.video,f),sharing:this.calculateSharingDirection(g.sharing,f),data:this.calculateDataDirection(g.data,f)};return f.info(`done, modalities=${safeJsonStringify(S)}`),this.deleteExtraneousModalities(S,m),S}calculateAudioDirection(g,m){if(m.info(`calculateAudioDirection, offer=${g}, requestedAudioState=${this.mediaStateConfigurationHelper.isSending(0)}`),this.receiveOnlyAudioOnCallStart)return m.info("calculateAudioDirection, direction=recvonly, receiveOnlyAudioOnCallStart=true"),"recvonly";if(this.mediaStateConfigurationHelper.isInactiveOrDisabled(0)||"inactive"===g)return"inactive";return this.mediaSession.getAllowedModalities().audio.some((g=>g===Or.send||g===Or.sendReceive))?"sendrecv":"sendonly"===g?"inactive":"recvonly"}calculateVideoDirection(g,m){const f=this.mediaStateConfigurationHelper.isSending(1);if(m.info(`calculateVideoDirection, offer=${g}, requestedVideoState=${f}, isSomeoneStreamingVideo=${this.isSomeoneStreamingVideo}`),this.mediaStateConfigurationHelper.isInactiveOrDisabled(0))return"inactive";let S=f,v=this.isSomeoneStreamingVideo||this.callUsesMixer||this.isEscalationInProgress;return g&&(S=S&&("sendrecv"===g||"sendonly"===g),v=v&&("sendrecv"===g||"recvonly"===g)),S?"sendrecv":v?"recvonly":"inactive"}calculateSharingDirection(g,m){return m.info(`calculateSharingDirection, offer=${g}, requestedScreenSharingState=${this.mediaStateConfigurationHelper.isSending(2)}, isSomeoneSharing=${this.isSomeoneSharing}`),"inactive"===g?"inactive":this.mediaStateConfigurationHelper.isSending(2)?"sendonly":this.isSomeoneSharing||this.callUsesMixer||this.isEscalationInProgress?"recvonly":void 0}calculateDataDirection(g,m){const f=this.mediaStateConfigurationHelper.isSending(3);if(m.info(`calculateDataDirection, offer=${g}, dataEnabled=${f}`),this.allowDataChannel())return f?"inactive"===g?"inactive":"sendrecv":void 0;m.info("calculateDataDirection, disabling data since ECS flag prohibits it")}getMediaModalitiesForHold(g){this.logger.info(`[${g}][getMediaModalitiesForHold]`);const m="inactive",f={audio:m,video:m,data:this.allowDataChannel()?m:void 0,sharing:m};return this.deleteExtraneousModalities(f,g),f}deleteExtraneousModalities(g,m){!hasSendDirectionality(g.video)&&this.mediaStateConfigurationHelper.isDisabled(1)&&(this.logger.info(`[${m}][deleteExtraneousModalities] skipping videoModality`),delete g.video),!hasSendDirectionality(g.sharing)&&this.mediaStateConfigurationHelper.isDisabled(2)&&(this.logger.info(`[${m}][deleteExtraneousModalities] skipping sharingModality`),delete g.sharing)}getSignalingMediaTypes(g){const isSendActive=g=>g===this.mediaAgent.constants.MEDIA_STATE.send||g===this.mediaAgent.constants.MEDIA_STATE.sendReceive,m=[];return g.audio&&g.audio!==this.mediaAgent.constants.MEDIA_STATE.inactive&&m.push("Audio"),isSendActive(g.video)&&m.push("Video"),g.sharing===this.mediaAgent.constants.MEDIA_STATE.send?m.push("ScreenSharer"):g.sharing===this.mediaAgent.constants.MEDIA_STATE.receive&&m.push("ScreenViewer"),m}enableControlInjector(){if(this.allowScreenSharingControl()){if(this.getlocalScreenShareStream()){const g=this.mediaSession?.getLocalMediaTrackId("ScreenShare")??"";this.screenSharingControl.enableControlInjector(g)}else this.logger.warn("enableControlInjector: no local screenshare stream found")}}createCallDeviceManager(){return new Ys(this.mediaAgent.getConfigProvider().config.allowVirtualDeviceInCall,this.mediaAgent.getDeviceManager(),this.logger.createChild("CallDeviceManager"),this.callStats,(g=>this.isMediaSending(g)))}initializeSignalingSession(g){if(this.signalingSession)return void this.logger.info("Session already exists!");const m=Hi.CALL_STATUS;if(this.localSignalingParticipant={id:generateAliasedMri(`${$n}${this.currentUserSkypeIdentity.id}`,this.currentUserSkypeIdentity.sipUri),displayName:this.currentUserSkypeIdentity.displayName,endpointDetails:[],languageId:null,participantId:g,endpointId:null},this.accountConfiguration){if(this.localSignalingParticipant.applicationType=this.accountConfiguration.applicationType,this.callTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.localSignalingParticipant.ring=this.accountConfiguration.ring,this.callTelemetry.setRing(this.accountConfiguration.ring),this.localSignalingParticipant.region=this.accountConfiguration.region,this.callTelemetry.setRegion(this.accountConfiguration.region),this.localSignalingParticipant.userHexCID=this.accountConfiguration.userHexCID,this.callTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.localSignalingParticipant.partition=this.accountConfiguration.partition,this.callTelemetry.setPartition(this.accountConfiguration.partition),this.localSignalingParticipant.acsResourceId=this.accountConfiguration.acsResourceId,this.callTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.callStats.setAcsResourceId(this.accountConfiguration.acsResourceId),this.accountConfiguration.serviceUrls){const g=this.accountConfiguration.serviceUrls.calling_conversationServiceUrl,m=this.accountConfiguration.serviceUrls.calling_uploadLogRequestUrl;this.signalingAgent.updateUrls(g,m,this.accountConfiguration.enforceUrls)}this.localSignalingParticipant.clientType=this.accountConfiguration.clientType,this.callTelemetry.setClientType(this.accountConfiguration.clientType)}this.callStats.localStats.setLocalUserId(this.localSignalingParticipant.id),this._callOperationHandler&&this._callOperationHandler.resetOperationChain(),this.signalingNotifications={onPromotionCompleted:(g,m,f)=>{this.logger.info(`[${f}][onPromotionCompleted] isFailed=${g} reason=${safeJsonStringify(m)} callMode=${this.callMode}`);const S=g?m:{code:0,subCode:0};if(this.callTelemetry.recordEvent("PromotionCompleted",{reason:S},f),g){const g=convertReason(m);this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",g,"",f),this._callOperationHandler.maybeRejectOperation("_CallStartOrJoinInitiated",g,"",f),this._callOperationHandler.maybeRejectOperation("_ConnectCall",g,"",f),this.promotionCompletedDeferred?.reject(g)}else this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,f),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,f);this.participants.forEach((g=>{g.applyCachedMediaStreams(f)}))},onCallStatusChanged:(g,f,S=generateCauseId())=>{const v=this.logger.createFnLogger("onCallStatusChanged",S);let C=`[status=${g}]`;if(f&&(C+=`[reason=${safeJsonStringify(f)}]`,void 0!==f.code&&(this.callEndDiagnosticsInfo={callControllerCode:f.code,callControllerSubCode:f.subCode,phrase:f.phrase,resultCategories:f.resultCategories},(f.overflowJoinInformation||f.registrationInformation)&&(this.callEndDiagnosticsInfo.additionalDiagnostics={overflowInformation:f.overflowJoinInformation,registrationInformation:f.registrationInformation}))),v.info(C),this.callTelemetry.recordEvent("_SignalingStateChanged",{status:g,reason:f},S),g===m.CONNECTING)!this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(v.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback()),this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,S);else if(g===m.RINGING)2===this.audioStreamState?(this.setCallState(9,S),this.participants.forEach((g=>g.setState(6,void 0,S)))):this.participants.forEach((g=>g.setState(2,void 0,S))),this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,S);else if(g===m.CONNECTED_FOR_ROSTER_ONLY)this._callOperationHandler.maybeResolveOperation("Subscribe",void 0,void 0,S),this._callOperationHandler.maybeResolveOperation("SubscribeWithMeetingData",void 0,void 0,S);else if(g===m.CONNECTED){this._callIsSetupComplete=!0;const g=this.getLocalSignalingEndpointDetails();(g?.isLobby||g?.streamLobby)&&(this._callInLobby=!0,this.updateCapabilities(S,!0));const m=this.signalingSession.participantManager.localParticipant.isStaging;if(11===this.state)this.setCallState(12,S);else if(this._callOperationHandler.hasPendingOperation("JoinPreheatedCall"))v.info("wait for joinPreheatedCall to resolved");else if(this._callInLobby)v.info("[inLobby] Override Connected state from signaling agent"),this.setCallState(10,S);else if(m)this.setCallState(13,S);else{if(3===this.state&&!this._callOperationHandler.hasPendingOperation("_CallStartOrJoinInitiated")&&!this._callOperationHandler.hasPendingOperation("_ConnectCall"))return void v.info("Return: Don't re-send setup telemetry if call was already connected and operations are completed");this.setCallState(3,S),this.handleRemoteParticipantStateInOneToOneCall(S)}this._callOperationHandler.maybeResolveOperation("_CallStartOrJoinInitiated",void 0,void 0,S),this._callOperationHandler.maybeResolveOperation("_ConnectCall",void 0,void 0,S),this.reportTsCallingTelemetry(!0)}else if(g===m.LOCAL_TERMINATED||g===m.REMOTE_TERMINATED){let C=this.callSetupFailed?7:convertReason(f);if(8===this.state&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData"]))return this.signalingSession.resetState(),this._callOperationHandler.maybeRejectOperation("Subscribe",C,void 0,S),this._callOperationHandler.maybeRejectOperation("SubscribeWithMeetingData",C,void 0,S),void v.info("Subscribe failed, there is pending start/join operation, ignore call end message");if((2===this.state||6===this.state||8===this.state)&&this._callOperationHandler.hasAtleastOneOfPendingOperation(["StartCall","JoinCall","StartWithMeetingData","JoinWithMeetingData","Subscribe","SubscribeWithMeetingData"])){const g={code:this.callEndDiagnosticsInfo.callControllerCode,subCode:this.callEndDiagnosticsInfo.callControllerSubCode,phrase:this.callEndDiagnosticsInfo.phrase,reason:C};this._callOperationHandler.maybeRejectOperations(["Accept","JoinCall","JoinWithMeetingData","JoinPreheatedCall","StartCall","StartCallAndUnpark","StartCallToVoiceMail","StartCallWithNudge","StartWithMeetingData","Subscribe","SubscribeWithMeetingData"],C,void 0,S,g)}this.signalingSession.acceptedElsewhereBy&&(this.acceptedElsewhereBy={id:this.signalingSession.acceptedElsewhereBy.id,displayName:this.signalingSession.acceptedElsewhereBy.displayName}),this.signalingSession.parkAdditionalContextJson&&(this.parkAdditionalContextJson=this.signalingSession.parkAdditionalContextJson),this.signalingSession.serverHoldLocation&&(this.serverHoldLocation=this.signalingSession.serverHoldLocation),this._callOperationHandler.hasPendingOperation("CallParkV2")&&f.pickupCode&&0===f.code&&this._callOperationHandler.resolveOperation("CallParkV2",""+f.pickupCode,void 0,S),1!==C&&(this.mediaRelayWhiteListingIssue&&(C=53),f?.code===vi.MediaError&&f?.subCode===yi.MediaPermissionError&&(C=58),v.info(`[terminated][reason=${safeJsonStringify(f)}]`)),this._callOperationHandler.maybeRejectOperation("CallParkV2",C,"",S),this._callOperationHandler.maybeRejectOperation("_WaitForAnswer",C,"",S),this._callOperationHandler.maybeRejectOperation("_ConnectCall",C,"",S);const _=this.mediaSession?.getSessionConfig().config.setDisconnectAfterCleanUp;if(_?this.setTerminatedReason(C):this.setCallState(7,S,C),this.participants.forEach((g=>g.setState(4,void 0,S))),!this.disconnectingPromise){const C={...f,remoteTerminated:g===m.REMOTE_TERMINATED};this.disconnectingPromise=this.cleanUp(S,C).catch((g=>{v.logFailure(`Error when cleaning up the call, callId = ${this.callId}, error = ${g}`)}))}_&&this.disconnectingPromise.finally((()=>{7!==this.state&&this.setCallState(7,S,C)}))}},onOffer:(g,m=generateCauseId())=>{const f=this.logger.createFnLogger("onOffer",m);f.info(`${safeJsonStringify((0,Mi.omit)(g,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(g.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnOffer",this.prepareTelemetryForOfferAnswer(g),m),g.transferor?.details?.id&&this.setTransferorMri(g.transferor.details.id),g.transferor?.transferorType&&(this.transferorType=g.transferor.transferorType),g.transferor?.details?.displayName&&(this.transferorDisplayName=g.transferor.details.displayName),this.clientTransferContext=g.clientTransferContext,this.invitationData=g.invitationData,this.spamRiskLevel=g.riskLevel,this.spamStirAttestation=g.stirAttestation,g.mediaContent.isTwoPartyToMultiPartyEscalation&&this.setIsEscalationInProgress(!0,m),g.renegotiation?this.requestedHoldState&&this._pendingParkPromise?this.renegotiateIncoming(g.mediaContent,m):this._callOperationHandler.executeChained((()=>this.renegotiateIncoming(g.mediaContent,m)),"_RenegotiateIncoming",m,m,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}):(f.info("resolving attach / offer promise"),this.attachToCallAndGetOffer.resolve(g.mediaContent))},onNewOffer:(g,m=generateCauseId())=>{const f=this.logger.createFnLogger("onNewOffer",m);this.newOfferRequestDeferred?(f.info("onNewOffer"),this.newOfferRequestDeferred.resolve(g.mediaContent)):f.info("callback received but new offer was not requested")},onAnswer:(g,m=generateCauseId())=>{const f=this.logger.createFnLogger("onAnswer",m);if(f.info(`${safeJsonStringify((0,Mi.omit)(g,"mediaContent","remoteParticipantId"))}`),this.setMediaLegId(g.mediaContent.mediaLegId),this.callTelemetry.recordEvent("_WebOnAnswer",this.prepareTelemetryForOfferAnswer(g),m),g.renegotiation)f.info("resolving previous renegotiation promise"),this.renegotiationAnswerDeferred.resolve(g.mediaContent);else if(f.info("resolving final answer promise"),g.provisional){const f=this.isOneToOnePSTNCall()&&(0,Mi.startsWith)(g.remoteParticipantId,Wn);this.mediaSession.processAnswerAsync(g.mediaContent,m,!0,f)}else this._callOperationHandler.maybeResolveOperation("_WaitForAnswer",g.mediaContent,void 0,m),this.handleRemoteParticipantStateInOneToOneCall(m);g.provisional||!g.mediaContent.fromMixer||this.callUsesMixer||this._callOperationHandler.executeChained((async()=>{this.setCallUsesMixer(!0,m),this.mediaStateConfigurationHelper.isDisabled(2)&&this.mediaStateConfigurationHelper.removeModality(2),await this.updateMediaModalities(void 0,m);const g=!(this.isSomeoneSharing||this.isScreenSharingOn||this.isVideoOn);return this.mediaSession.getSessionConfig().config.disableImmidiateEscalationReconnect&&g?(f.info("Delaying reconnect"),this._hasDelayedReconnect=!0,Promise.resolve()):this.mediaSession.reconnectAsync(m,!0)}),"_CallEscalatedToConference",m,m,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})},onMediaAcknowledgementSuccess:(g,m=generateCauseId())=>{this.logger.info(`isRenegotiation: ${g}`,"onMediaAcknowledgementSuccess",m),this._callOperationHandler.resolveOperation("_MediaAcknowledgment",void 0,void 0,m)},onMediaAcknowledgementFailure:(g,m,f=generateCauseId())=>{this.logger.createFnLogger("onMediaAcknowledgementFailure",f).logFailure(safeJsonStringify(m)),this._callOperationHandler.rejectOperation("_MediaAcknowledgment",m,f)},onMediaRenegotiationRejection:(g,m=generateCauseId())=>{this.logger.createFnLogger("onMediaRenegotiationRejection",m).logFailure(safeJsonStringify(g)),this.renegotiationAnswerDeferred.reject(g)},onRosterHandlingComplete:()=>{this.logger.info(`[onRosterHandlingComplete] ${this._publishedStatesModified}`),0!==this._publishedStatesModified&&(this.processPublishedStates(),this._publishedStatesModified=0)},onMeetingGroupDetailsUpdated:(g,m=generateCauseId())=>{this.meetingGroupDetails!==g&&(this.callTelemetry.recordEvent("_UpdateMeetingGroupDetails",g,m),this.logger.info(`[${m}][onMeetingGroupDetailsUpdated] update meetingGroupDetails from ${JSON.stringify(this.meetingGroupDetails)} to ${JSON.stringify(g)}`),this.meetingGroupDetails=g,this.raiseChanged())},onSelfParticipantUpdated:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onSelfParticipantUpdated]`),this.updateLocalParticipant(g,m),this.raiseChanged()},onParticipantMriUpdated:(g,m,f=generateCauseId())=>{this.logger.info(`[${f}][onParticipantMriUpdated]`);const S=this.getParticipant(g);S&&(S.id=m,this.raiseChangedDeferred())},onParticipantUpdated:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onParticipantUpdated]: ${scrubSignalingParticipant(g)}`);const f=this.getOrCreateParticipant(g.id,m,!0);f.displayName=g.displayName;const S=_PluginlessCall.getStreamsFromEndpoints(g.endpointDetails),v=(0,Mi.some)(g.endpointDetails,(g=>g?.streamInformation));this.callUsesMixer||S.length>0||v?(this.updateParticipantStreams(f,g,S,m),this.updateCallParticipantFromSignalingParticipant(f,g,m)):f.setState(3,void 0,m),f.processParticipantDetails(g,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(g),this.calculateIsSomeoneStreaming(m),this.raiseChangedDeferred()},onParticipantRemoved:(g,m=generateCauseId(),f=!1)=>{if(this.logger.info(`[${m}][onParticipantRemoved]`),f){const f=this.getParticipant(g.id);this.callTelemetry.recordOperationSuccess("_ParticipantJoined",null,f?.id,m,{participantJoinedButReplaced:"Participant joined with original MRI and replaced with participant of RNL MRI"})}else this.callTelemetry.recordOperationSuccess("RemoveParticipant",null,g.id,m),this._participantOperationHandler.maybeRejectOperation("AddParticipant",1,g.id,m);this._removeParticipant(g,m),this.removePublishedStatesByParticipant(g.id),this.calculateIsSomeoneStreaming(m)},onParticipantJoined:(g,m=generateCauseId())=>{this.logger.info(`[${m}][onParticipantJoined]`);const f=!this.getParticipant(g.id),S=this.getOrCreateParticipant(g.id,m,!1);S.displayName=g.displayName,0===S.state&&S.setState(1,void 0,m);const v=_PluginlessCall.filterVirtualEndpoints(g.endpointDetails),C=_PluginlessCall.getStreamsFromEndpoints(v),_=(0,Mi.some)(g.endpointDetails,(g=>g?.streamInformation));this.callUsesMixer||C.length>0||_?(this.updateParticipantStreams(S,g,C,m),this.updateCallParticipantFromSignalingParticipant(S,g,m),this.calculateIsSomeoneStreaming(m)):(this.handleRemoteParticipantJoinedInOneToOneCall(g,m),this.handleRemoteParticipantStateInObservingCall(S,g,m),g.acceptedBy&&g.acceptedBy!==g.id&&(S.acceptedBy=g.acceptedBy)),this.callTelemetry.recordOperationSuccess("_ParticipantJoined",getEndpointInformationForTelemetry(g.endpointDetails),S.id,m),S.processParticipantDetails(g,this.getSelfClientEndpointCapabilities(),(()=>{this.signalingSession?.setStreamInformationReceived()})),this.updatePublishedStates(g),f&&this.event("participantAdded").raise(S),this.raiseChangedDeferred()},onCallModeChanged:(g,m)=>{this.callTelemetry.recordEvent("_CallModeChanged",{newCallMode:g,oldCallMode:this._callMode},m),this.logger.info(`onCallModeChanged[${m}]: new=${g} old=${this._callMode} `),g&&this._callMode!==g&&(this._callMode=g,this.isCallModeStreaming()&&this.cleanUpDueToStreaming(m),1===this._callMode&&(this.participants.forEach((g=>{g.applyCachedMediaStreams(m)})),this.promotionCompletedDeferred?.resolve()),this.monitorCallStart(),this.updateCapabilities(m),this.raiseChanged())},getRemoteParticipantCollection:()=>this.participants.map((g=>g.toCafeParticipant())),onReTargetCompletedSuccess:g=>{const m=this.logger.createFnLogger("onReTargetCompletedSuccess",g);m.info(`started, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetSuccess",void 0,g),this.callStats.localStats.call.event(3);const f=this.isEscalationInProgress;this.screenSharingControl&&this.screenSharingControl.shutdownControlForViewer(),this.updateSignalingDSHMessageSubscription(this.isInitialSignalingDSHSubscriptionEnabled()),this.mediaSession.completeEscalationAsync(g).then((()=>(m.logSuccess("completeEscalationAsync"),this.callTelemetry.recordEvent("_WebOnEscalationSuccess",void 0,g),this.handleCallEscalation(f,g),this.updateMediaStatus(g)))).catch((f=>{m.logFailure(`completeEscalationAsync, error=${getPrintableObject(f)}`),this.setIsEscalationInProgress(!1,g),this.callTelemetry.recordEvent("_WebOnEscalationFailure",getPIISafeObject(f),g),this.stopInternal({causeId:g,terminatedReason:47})}))},onReTargetCompletedFailure:(g,m)=>{this.logger.createFnLogger("onReTargetCompletedFailure",m).logFailure(`reason=${getPrintableObject(g)}, isEscalationInProgress=${this.isEscalationInProgress}`),this.callTelemetry.recordEvent("_WebRetargetFailure",getPIISafeObject(g),m),this.isEscalationInProgress&&(this.setIsEscalationInProgress(!1,m),this.setCallUsesMixer(!1,m),this.updateMediaStatus(m)),this.callStats.localStats.call.event(4),this.mediaSession.rejectEscalationAsync(g,m)},onChatModalitySetupFailed:g=>{this.logger.debug(`onChatModalitySetupFailed: ${g}`)},onConversationUpdated:(g,m)=>{this.logger.info(`onConversationUpdated[${m}]: ${safeJsonStringify(g)}`),this.setConversationType(g.conversationType,m),this.setMessageId(g.teamsMessageId,m),this.setGroupId(g.groupId,m),this.setThreadId(g.threadId,m),this.setBackroomThreadId(g.backroomThreadId,m),this.setCallType(g.isMultiParty?2:1,m),this._commandUrlPresence=g.commandUrlPresence,this.updateCapabilities(m),this.region=g.region,this.setMeetingData(g.meetingData),this.meetingInfo=g.meetingInfo,this.callLimits=g.callLimits,this.setComplianceRecordingContent(m,g.complianceRecordingContent),this.setHuddleGroupCall(g.isHuddleGroupCall),this.raiseChanged()},onMeetingDetailsUpdated:g=>{this.meetingDetails=g,this.mediaSession&&!this.enableRealtimeTelemetry&&this.meetingDetails.meetingCapability?.enableRealtimeTelemetry&&(this.mediaSession.enableTeamsRealTimeTelemetry(),this.enableRealtimeTelemetry=!0),this.raiseChanged()},onMeetingStatesUpdated:g=>{(0,Mi.isEqual)(g,this.meetingStates)||(this.meetingStates=g,this.logger.info(`[onMeetingStatesUpdated] meetingStates updated to ${JSON.stringify(this.meetingStates)}`),this.raiseChanged())},onParticipantCountsUpdated:g=>{(0,Mi.isEqual)(g,this.participantCounts)||(this.participantCounts={...Zt,...g},this.event("participantCountsUpdated").raise(this.participantCounts),this.mediaSession?.processNotification("ParticipantCountChanged",{count:g.totalParticipants}))},updateIsSharedLineAppearanceV2Activated:g=>{this.isSharedLineAppearanceV2Activated!==g&&(this.logger.info(`_updateIsSharedLineAppearanceV2Activated: new value is ${g}`),this.isSharedLineAppearanceV2Activated=g,this.event("sharedLineAppearanceV2ActivatedChanged").raise(this.isSharedLineAppearanceV2Activated))},onBroadcastMeetingUpdated:g=>{g&&(this.broadcastMeeting&&this.broadcastMeeting.metadataChanged(JSON.stringify(g)),this.broadcastMetadata=g,this.raiseChanged())},onBroadcastMeetingConnected:(g,m)=>{this.logger.info(`[${m}][onBroadcastMeetingConnected]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&(0===g.code?this._callOperationHandler.resolveOperation("AddBroadcastModality",g,m):this._callOperationHandler.rejectOperation("AddBroadcastModality",g,m))},onBroadcastMeetingEnded:(g,m)=>{this.logger.info(`[${m}][onBroadcastMeetingEnded]`),this._callOperationHandler.hasPendingOperation("AddBroadcastModality")&&this._callOperationHandler.rejectOperation("AddBroadcastModality",g,m),this.signalingSession.endBroadcastMeeting(m)},onTransferRequested:(g,m)=>{const f=this.logger.createFnLogger("onTransferRequested",m);f.info("Transfer: onTransferRequested, target participant",scrubSignalingParticipant(g.target));let S="",v="",C=0;"voicemail"===g.target.endpointType&&(C=2);try{S=g.target.id,v=g.transferor.details.id,g&&g.parkType&&"none"!==g.parkType&&(C=1)}catch(g){return f.logFailure(g),this.callTelemetry.recordEvent("_OnTransferRequestedInvalid"),void this.signalingSession.signalTransferCompletedAsync({code:getCSAEndCode(7)})}const _=this.convertToTransferType(C,g.parkType),E={transferContext:{transferorMri:v,targetMri:S,transferType:C,context:{target:g.target,transferor:g.transferor,transferContext:g.transferContext,newCallModalities:g.newCallModalities,links:g.links,replacementDetails:g.replacementDetails,isConsultative:g.isConsultative,callAcceptanceCallback:()=>{f.logSuccess("Transfer: callAcceptanceCallback called"),this.signalingSession.signalTransferAcceptedAsync(_)}}},onCompleted:g=>{f.logSuccess("Transfer: onCompleted called"),this.signalingSession.signalTransferCompletedAsync({code:getCSAEndCode(g)})}};this.callTelemetry.recordEvent("_OnTransferRequested",{transferType:C}),this.event("transferRequested").raise(E)},onTransferredCallAcceptance:g=>{const m=this.logger.createFnLogger("onTransferredCallAcceptance",g);this._transfereeAcceptanceWithoutWaitingForConv&&this._transferredCallAcceptanceCallback&&(m.info("[Transfer] Invoke call acceptance callback for original call"),this._transferredCallAcceptanceCallback())},onTransferAccepted:g=>{this.logger.info("Transfer: onTransferAccepted"),this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&this._setTransferState(2),this._callOperationHandler.hasPendingOperation("BlindTransfer")&&this._callOperationHandler.maybeResolveOperation("_CallTransferInProgress",void 0,void 0,g),this._callOperationHandler.hasPendingOperation("ParkCall")&&this._setParkState(2)},onTransferCompleted:(g,m)=>{const f=this.logger.createFnLogger("onTransferCompleted",m);f.info("Transfer: onTransferCompleted");const S=g.transferCompletion,v=convertReason(S);if(S&&(f.info(`Transfer: Call Transfer Code: ${S.code}`),0===S.code)){if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.resolveOperation("_CallTransferInProgress",void 0,void 0,m),this._setTransferState(3)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const g={code:0,subCode:0,phrase:"TransactionComplete"};this._callOperationHandler.resolveOperation("ConsultativeTransferWithPickupCode",g,void 0,m),this._setTransferState(3)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(g.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation&&(this.serverHoldLocation=g.unparkContent.CallParkAdditionalContext.ConversationControllerLocation),void 0!==g.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("ParkCall",g.unparkContent.pickupCode,void 0,m),f.logSuccess(`pickupCode=${g.unparkContent.pickupCode}`),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",32,m),f.logFailure(`terminatedReason=${v}`),this._setParkState(4)))}else{if(this._callOperationHandler.hasPendingOperation("_CallTransferInProgress")&&(this._callOperationHandler.rejectOperation("_CallTransferInProgress",v,void 0,m),f.logFailure(`terminatedReason=${v}`),this.transferDiagnosticsInfo={callControllerCode:S.code,callControllerSubCode:S.subCode,phrase:S.phrase,resultCategories:S.resultCategories},this._setTransferState(4)),this._callOperationHandler.hasPendingOperation("ConsultativeTransferWithPickupCode")){const g={code:S.code,subCode:S.subCode,resultCategories:S.resultCategories};this._callOperationHandler.rejectOperation("ConsultativeTransferWithPickupCode",g,void 0,m)}this._callOperationHandler.hasPendingOperation("ParkCall")&&(this._callOperationHandler.rejectOperation("ParkCall",v,void 0,m),f.logFailure(`terminatedReason=${v}`),this.transferDiagnosticsInfo={callControllerCode:S.code,callControllerSubCode:S.subCode,phrase:S.phrase,resultCategories:S.resultCategories},this._setParkState(4))}},onParkCompleted:(g,m)=>{this.logger.createFnLogger("onParkCompleted",m).info(`transactionEnd ${getPrintableObject(g)}`),this._callOperationHandler.hasPendingOperation("CallParkV2")?0===g.code&&void 0!==g.unparkContent?.pickupCode?(this._callOperationHandler.resolveOperation("CallParkV2",""+g.unparkContent?.pickupCode,void 0,m),this.callTelemetry.maybeRecordOperationSuccess("CallParkV2"),this.serverHoldLocation=g.unparkContent?.CallParkAdditionalContext?.ConversationControllerLocation,this.parkAdditionalContextJson=JSON.stringify(g.unparkContent.CallParkAdditionalContext)):this._callOperationHandler.rejectOperation("CallParkV2",g,m):this._callOperationHandler.hasPendingOperation("ParkCall")&&(0===g.code?(this._callOperationHandler.resolveOperation("ParkCall","",void 0,m),this._setParkState(3)):(this._callOperationHandler.rejectOperation("ParkCall",g,m),this._setParkState(4)))},onUnparkCompleted:(g,m)=>{this.logger.createFnLogger("onUnparkCompleted",m).info(`transactionEnd ${getPrintableObject(g)}`),this._callOperationHandler.hasPendingOperation("UnparkCall")&&(0===g.code?this._callOperationHandler.resolveOperation("UnparkCall",g,void 0,m):this._callOperationHandler.rejectOperation("UnparkCall",g,m))},onIncomingCallReplacement:(g,m)=>{const f=this.logger.createFnLogger("onIncomingCallReplacement",m);this.callTelemetry.recordEvent("_onIncomingCallReplacement",{},m),g.callNotification.callType="replaces",g.callNotification.consultativeCallId=this.callId,f.info(`consultativeCallId=${this.callId}`),g.body={gp:g,evt:Ti.INCOMING_SKYPE_NGC_CALL,nsp:void 0},this.event("replacementRequested").raise(g)},onContentSharingStopped:g=>{this.logger.debug("ScreenSharing: onContentSharingStopped");for(const m of this.contentSharingSessions)m.contentSharingGuid===g.correlationId&&(m.contentSharingStatus=7)},onContentSharingStarted:g=>{this.logger.debug("ScreenSharing: onContentSharingStarted");const m=new ns(this.callTelemetry,this.logger.createChild("ContentSharingSession"),this.signalingSession,g.correlationId||generateGuid(),g.contentIdentifier,g.sessionState,g.subject,g.sessionId);m.contentSharingStatus=2,this.contentSharingSessions.push(m),m.changed((()=>this.removeContentSessionIfEnded(m))),this.event("contentSharingChanged").raise()},onContentSharingUpdated:g=>{this.logger.debug("ScreenSharing: onContentSharingUpdated");const m=(0,Mi.find)(this.contentSharingSessions,(m=>m.contentSharingGuid===g.correlationId));m?(g.presenter&&(m.presenterId=g.presenter),g.subject&&m.subject!==g.subject&&(m.subject=g.subject),g.sessionState&&m.contentSharingState!==g.sessionState&&(m.contentSharingState=g.sessionState),3===m.contentSharingStatus&&this.localSignalingParticipant.id!==g.presenter?m.contentSharingStatus=5:5===m.contentSharingStatus&&this.localSignalingParticipant.id===g.presenter&&(m.contentSharingStatus=3)):this.logger.warn("onContentSharingUpdated: session not found")},onWebRtcMediaNotification:(g,m)=>{this.mediaSession?.processNotification(g,m);const f=this.mediaSession&&this.mediaSession.getExtensionsManager?this.mediaSession.getExtensionsManager():null;f&&f.processNotification(g,m)},onCorrelationIdUpdated:(g,m)=>this.checkForCallIdUpdate(g,m),onUnmuteRequested:g=>{},onCallForwarded:g=>{g&&g.destinationType!==this.forwardingDestinationType&&(this.forwardingDestinationType=g.destinationType,this.raiseChanged())},onPSTNBalanceUpdate:g=>{},isOneToOnePstnCall:()=>this.isOneToOnePSTNCall(),onUpdateMeetingLiveStateCompleted:(g,m,f)=>{this.logger.info(`[onUpdateMeetingLiveStateCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingLiveState",f)},onUpdateMeetingStatesCompleted:(g,m,f)=>{this.logger.info(`[onUpdateMeetingStatesCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingStates",f)},onUpdateMeetingGroupsCompleted:(g,m,f)=>{this.logger.info(`[onUpdateMeetingGroupsCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"UpdateMeetingGroups",f)},onSetMeetingLayoutCompleted:(g,m,f)=>{this.logger.info(`[onSetMeetingLayoutCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"SetMeetingLayout",f)},onJoinMeetingGroupCompleted:(g,m,f)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"JoinMeetingGroup",f)},onLeaveMeetingGroupCompleted:(g,m,f)=>{this.logger.info(`[onJoinMeetingGroupCompleted] [${m}] transactionEnd ${getPrintableObject(g)}`),this.onOperationCompleteCommonHandler(g,m,"LeaveMeetingGroup",f)},onBreakoutDetailsUpdated:(g,m)=>{this.logger.info(`[onBreakoutDetailsUpdated] [${m}]`),this.breakoutDetails=g,this.raiseChanged()},onIncomingProxiedMessages:(g,m)=>{this.logger.info(`[onIncomingProxiedMessages] [${m}] payload ${getPrintableObject(g,!0)}`),this.event("incomingProxiedMessages").raise(g)},onUpdateParticipantsPropertiesCompleted:(g,m,f)=>{this.logger.createFnLogger("onUpdateParticipantsPropertiesCompleted",f).info(`promisesToResolve ${scrubMriOrOmit(safeJsonStringify(g))}`);for(const m of Object.keys(g)){g[m].code===oi.CODE.SUCCESS?this._callOperationHandler.maybeResolveOperation("UpdateParticipantsProperties",g[m],m,f):this._callOperationHandler.maybeRejectOperation("UpdateParticipantsProperties",g[m],m,f)}},onNudgeToJoinRealtime:g=>{this.logger.info("[onNudgeToJoinRealtime]",g),this.callTelemetry.recordEvent("NudgeToJoinRealTime",g),this.canPromoteToRealTime(1)&&this.promoteToRealtime(1,g).then((()=>this.logger.info(`[onNudgeToJoinRealtime][${g}] completed`))).catch((m=>this.logger.info(`[onNudgeToJoinRealtime][${g}] failed to auto promote: ${getPrintableObject(m)}`)))}};const f=Object.create(this.localSignalingParticipant);this.signalingSession=this.signalingAgent.getNewSignalingSession(f,this.signalingNotifications,this.callId,this._callCreationTime),this.signalingSession.participantManager.setStaleCheckForFullRoster(this._staleRosterCheckFixForPluginless),this.accountConfiguration&&this.accountConfiguration.deviceType&&this.signalingSession.setDeviceType(this.accountConfiguration.deviceType),this.setCallId(this.callId||this.signalingSession.correlationId),this.signalingSession.participantManager&&this.signalingSession.participantManager.localParticipant&&(this.setEndpointId(this.signalingSession.participantManager.localParticipant.endpointId),this.setParticipantId(this.signalingSession.participantManager.localParticipant.participantId),this.callStats.setParticipantId(this.participantId))}updateParticipantStreams(g,m,f,S){g.updateStreams(f,S,this.isCallModeStreaming());const v=this.getStreamInformationMap(m);this.logger.info(`[updateParticipantStreams]: streaming mode with new streamInfoMap: ${safeJsonStringify(v)}`);const C={callId:this.callId,participantId:this.participantId,endpointId:this.endpointId};this.meetingData&&(C.meetingId=this.meetingData.meetingCode);const _=this.telemetryLoggers?this.telemetryLoggers.tlePlayer:null;g.useUmsStream(v,this._liveStreamConfigProvider,C,this.threadId,_,S)}cleanUpDueToStreaming(g){this.logger.info(`cleanUpDueToStreaming[${g}]: cleaning streams and media and canceling cc operations`),this.cancelAllCallingOperationsDueToStreaming(g);const m={code:vi.Success,subCode:yi.DowngradeToStreamingClient,phrase:Ai.DowngradeToStreamingClient};this.participants.forEach((m=>m.updateStreams([],g))),this.cleanUpMedia(g,m).finally((()=>{this.mediaDisposedPromise=null})),this.finishCallHoldResume(m),this.renegotiationAnswerDeferred?.reject(m),this.newOfferRequestDeferred?.reject(m),this._parkState=0,this._transferState=0,this.isServerMuted||(this._muteState=0),this.isSpeakerMuted=!1,this.requestedHoldState=!1,this.isMuteOnHold=!1}cancelAllCallingOperationsDueToStreaming(g){this._callOperationHandler.maybeRejectPendingOperationsWithPredicate(74,g,((g,m)=>(0,Mi.some)(m?.preconditionTags,(g=>"NOT_SUPPORTED_IN_STREAMING_MODE"===g))))}onOperationCompleteCommonHandler(g,m,f,S){0===g.code?this._callOperationHandler.maybeResolveOperation(f,g,S,m):this._callOperationHandler.maybeRejectOperation(f,g,S,m)}convertToTransferType(g,m){let f="none";return 1===g&&m&&"none"!==m?"teamPark"===m?f="TransferTypeTeamPark":"sharedLinePark"===m?f="TransferTypeSharedLinePark":"serverHold"===m&&(f="TransferTypeServerHold"):0===g?f="TransferTypeStandard":2===g?f="TransferTypeVoicemail":this.logger.info(`Irrelevant combination of transferTye: ${g} and parkType: ${m}`),f}raiseChangedDeferred(g){(!this.raiseChangedDefer||this.raiseChangedDefer.isSkippable&&!g)&&(Mr.instance.runDeferredWithoutDedup((()=>{delete this.raiseChangedDefer,this.raiseChanged(g)}),"Call.raiseChanged"),this.raiseChangedDefer={isSkippable:!!g})}static getStreamsFromEndpoints(g){if(!g)return[];const m=_PluginlessCall.filterVirtualEndpoints(g);return m.forEach((g=>(0,Mi.forEach)(g.mediaStreams,(m=>{m.participantId=g.participantId,m.endpointId=g.endpointId})))),(0,Mi.flatMap)(m,(g=>g&&g.mediaStreams||[]))}preconditions(g,m){this.logger.info(`check call mode currentMode is ${this.callMode} operationName is ${g}`),(0,Mi.some)(m,(g=>"NOT_SUPPORTED_IN_STREAMING_MODE"===g))&&this.isCallModeStreaming(!0)}mapCallSetupIntent(g){switch(g){case 0:return"None";case 1:return"AutoPromotion";case 2:return"PromotionWithAudio";case 3:return"PromotionWithVideo";default:return"Unknown"}}async promoteToRealtime(g,m){this.logger.info(`[${m}][promoteToRealtime] started with intent=${g}`);const f=this.getPromoteToRealtimeCallOptions(g,this.callOptions);this.callTelemetry.updateOperationData("_PromotionToRealtime",{intent:g},m),this.callTelemetry.recordEvent("StartPromotion",{intent:this.mapCallSetupIntent(g)},m);try{this.promotionCompletedDeferred=defer(),await Promise.all([this.joinOrStartCall(f,this.joinGivenConversation,m,void 0),this.promotionCompletedDeferred.promise])}catch(g){throw this.logger.logFailure(`[${m}][promoteToRealtime] failed with reason=${getPrintableObject(g)}`),this.cleanUpDueToStreaming(m),this.signalingSession.cleanUpDueToStreaming(m),g}}async promoteToRealtimeAndUnmute(g){return this.logger.info(`[${g}][promoteToRealtimeAndUnmute]`),this.isPromotingToRealtime()?(this.logger.info(`[${g}][promoteToRealtimeAndUnmute] already promoting to realtime.`),this._callOperationHandler.waitForOperation("_PromotionToRealtime").then((()=>this.muteUnmute(!1,g)))):this.canPromoteToRealTime(2)?(this.unmutePendingPromise=defer(),setTimeout((()=>{this.unmutePendingPromise?.reject("promoteToRealtime unmute timed out")}),1e3*this.signalingSession.signalingAgentConfig.csaTimeoutConfiguration.promotionUnmuteTimeoutSec),Promise.all([this.promoteToRealtime(2,g),this.unmutePendingPromise.promise]).then((()=>{})).finally((()=>this.unmutePendingPromise=null))):Promise.reject("manual promotion with audio is not allowed")}isPromotingToRealtime(){return this._callOperationHandler.hasPendingOperation("_PromotionToRealtime")}getPromoteToRealtimeCallOptions(g,m){let f,S=1;1===g?f={value:!0,mediaTypes:["audio"]}:3===g?(f={value:!0,mediaTypes:["audio"]},S=4):2===g&&(f={value:!1});const v={...m.callStartOptions,sendMediaModalities:{mediaStates:[getMediaState(0,4),getMediaState(1,S)].filter((g=>null!=g))},preheatFlags:0};return{...m,callStartOptions:v,applyServerMute:f,isPromotingToRealtime:!0,callStartTime:Date.now()}}canPromoteToRealTime(g){const m=this.logger.createChild("[canPromoteToRealTime]");return m.info(`[promoteType:${g}]`),this.isCallModeStreaming()?this.isPromotingToRealtime()?(m.info("already promoting to realtime"),!1):1===g||2===g:(m.info("cant promote since call mode is not streaming"),!1)}isCallModeStreaming(g=!1){if(2===this.callMode){if(!g)return!0;throw this.logger.info("reject check callmode"),{code:499,subCode:3551,phrase:"TransactionNotAllowedForStreamMode"}}return!1}setCallOptions(g){this.receiveOnlyAudioOnCallStart=!!g.callStartOptions?.receiveOnlyAudioOnCallStart,this.callOptions=g,this.logger.info(`callOptions: ${safeJsonStringify(scrubCallOptions(g))}`)}getSelfClientEndpointCapabilities(){return this.callOptions?.callStartOptions?.clientEndpointCapabilities}getLocalSignalingEndpointDetails(){return(0,Mi.find)(this.localSignalingParticipant.endpointDetails,(g=>g?.endpointId===this._endpointId))}getStreamInformationMap(g){const m={};return g&&this.accountConfiguration?.clientSupportsUms&&(0,Mi.forEach)(g.endpointDetails,(g=>{g?.streamInformation&&g.participantId&&g.participantId!==this._participantId&&(m[g.participantId]=g.streamInformation)})),m}updateSATInfo(g=[]){const m=this.mediaSession?.getSessionConfig().config.slowedDownTalkerInfoAggregationTime;if(!m||m<0)return;const f=Date.now(),S=f-1e3*m;this.activeTalkersHistory=this.activeTalkersHistory.filter((({timestamp:g})=>g>S)).concat({speakers:g.map((g=>g.id)),timestamp:f});const v=Object.entries(this.activeTalkersHistory.reduce(((g,{speakers:m})=>{for(const f of m)g[f]??(g[f]=0),g[f]++;return g}),{})).sort((([,g],[,m])=>m-g)).map((([g])=>g));this.slowedDownActiveTalkerInfo={speakerList:v,timestamp:new Date(f)}}setPlatformCallConstraints(g){this.setCallConstraints(g).catch((g=>{this.logger.error(g)}))}setCallConstraints(g){return this.mediaSession?(this.logger.info(`Applying platform constraints to current call ${JSON.stringify(g)}`),this.mediaSession.setCallConstraints(g,generateCauseId())):(this.logger.info("Saving platform constraints until media session is created"),this.temporaryCallConstraints=g,new Promise(((g,m)=>{this.resolveTemporaryCallConstraints=g,this.rejectTemporaryCallConstraints=m})))}initializeMediaSession(g){if(this.mediaSession)return;const m=this.logger.createFnLogger("initializeMediaSession",g),f=((g,m)=>{const f={};return Object.keys(m).forEach((S=>{f[S]=(...f)=>m[S]&&g()&&m[S](...f)})),f})((()=>!this.isCallModeStreaming()||this.isPromotingToRealtime()),{onSessionErrorOccurred:(g,f=generateCauseId())=>{m.error(`[${f}][onSessionErrorOccurred]: ${safeJsonStringify(g)}`);const S=[this.mediaAgent.constants.MEDIA_ERROR.iceConnectionError,this.mediaAgent.constants.MEDIA_ERROR.internalError];(0,Mi.includes)(S,g.type)&&this.event("mediaConnectionFailed").raise(),this.callTelemetry.recordEvent("SessionError",{type:g.type},f)},onNegotiationRequired:(g=generateCauseId())=>{this.executeNegotiation(g,"onNegotiationRequired",!0)},onContributingSourcesChanged:g=>{const f=this.mediaSession?.getSessionConfig().config.contributingSourcesLogInterval,S=f&&Date.now()>=this.lastContibutingSourceReport+f,v=S?new Map(g.map((g=>[g,"<unknown>"]))):new Map,C=[];for(const m of this.participants){const f=g.some((g=>m.hasAudioSource(g))),_=f?1:0;m.updateVoiceLevel(_),f&&(C.push(m),S&&v.set(m.audio.id,scrubMriOrOmit(m.id)))}this.updateSATInfo(C),S&&(m.info(`[onContributingSourcesChanged], ${g.length?Array.from(v).join(";"):"none"}`),this.lastContibutingSourceReport=Date.now())},onDominantSpeakerChanged:(g,f)=>{const S=generateCauseId(),v=[],C=[];g.forEach((g=>{const m=(0,Mi.find)(this.participants,(m=>m.hasAudioSource(g)));m?(v.push(m.id),C.push(scrubMriOrOmit(m.id))):C.push(this.streamManager.audio.id===g?"<self>":"<unknown>")})),m.info(`[${S}][onDominantSpeakerChanged], msidList = ${g} => speakerList = ${C}, timestamp = ${f}`),this.dominantSpeakerInfo={speakerList:v,timestamp:f,noCurrentDominantSpeaker:!1},this.event("dominantSpeakerChanged").raise(),this.raiseChanged(this._dominantSpeakerChangedEventSkipConfig)},onAudioStateChanged:(g,m)=>{const f=generateCauseId(),S=this.logger.createFnLogger("onAudioStateChanged",f);S.info(safeJsonStringify(g)),this.callStats.localStats.audio.streamStateChanged(g.stream,g.direction);const v=_PluginlessCall.streamingStatetoMediaStreamState(g.stream);if(this.audioStreamState=v,!v)return;this.callTelemetry.recordEvent("AudioStateChanged",{state:g,reason:m},f),2===v&&2===this.state&&(this.setCallState(9,f),this.participants.forEach((g=>g.setState(6,void 0,f))));const C={mediaType:0,mediaDirection:_PluginlessCall.streamingDirectionToMediaDirectionMapping(g.direction),mediaStreamState:v};this.event("mediaStreamStateChanged").raise(C),!this.isCallSetupTelemetrySent&&this.mediaSession?.getSessionConfig().config.sendCallStartupTelemetry&&this.sendCallSetupTelemetry(),0===C.mediaDirection&&(this.isAudioStreamConnected=(0,Mi.includes)([2,1],C.mediaStreamState));if((0,Mi.includes)([3,4],C.mediaStreamState)){S.logFailure(`audio stream state changed to ${g.stream} with reason ${m}`);if(!m||["timeout","connection-dropped","connectivity-check-failure"].indexOf(m)>=0){this.event("mediaConnectionFailed").raise();const g=this.mediaRelayWhiteListingIssue?53:4;this.mediaRelayWhiteListingIssue&&this.callTelemetry.recordEvent("_MediaWhiteListingIssueDetected"),this.stopInternal({causeId:f,terminatedReason:g})}}},onQualityChanged:g=>{const m={type:_PluginlessCall.convertQualityEventType(g.type),value:_PluginlessCall.convertQualityLevel(g.value),isLocalSource:g.isLocalSource,mediaType:_PluginlessCall.convertMediaType(g.mediaType)};this.muteUnmuteWorkaround(m),32===m.type&&(this.mediaRelayWhiteListingIssue=3===m.value,this.mediaRelayWhiteListingIssue&&this.event("mediaConnectionWhitelistingWarning").raise()),5===m.type&&3===m.value&&this.trouterService.checkConnection(!0),this.callTelemetry.recordEvent("AudioQualityChanged",m),this.event("callQualityChanged").raise(m)},onOptimalVideoReceiversCountChanged:g=>{m.debug(`onOptimalVideoReceiversCountChanged: ${g}`),this.optimalVideoCount!==g&&(this.optimalVideoCount=g,this.raiseChanged())},onDataChannelUpdated:g=>{const f=generateCauseId();m.debug(`[${f}] onDataChannelUpdated`),this.dataChannel.registerSessionDataChannel(g,f)},onUpdateMediaDescriptionsRequired:g=>{this.executeNegotiation(g,"onUpdateMediaDescriptionsRequired",!1)},onRealtimeTelemetryReport:()=>{this.reportTelemetryEvents([{eventName:"realtimetelemetry",props:{user_object_id:{value:$n+this.currentUserSkypeIdentity.id,piiKind:10},call_context_id:{value:this.signalingSession.correlationId,piiKind:0},participant_id:{value:this.participantId,piiKind:0},media_leg_id:{value:this.mediaLegId,piiKind:0},DiagnosticLevel:{value:255,piiKind:0},eventpdclevel:{value:2,piiKind:0},eventpriority:{value:5,piiKind:0},call_technical_info:{value:JSON.stringify(this.mediaSession.getCallTechnicalInfo()),piiKind:0}}}],"realtimeMedia","mdsc")},onTransportConnected:()=>{this.mediaStateConfigurationHelper.isSending(3)&&this.allowDataChannel()?this.mediaControlPlane.onTransportConnected():!this.isInitialSignalingDSHSubscriptionEnabled()&&this.callUsesMixer&&this.updateSignalingDSHMessageSubscription(!0),this.unmixedAudioProvider.setSessionStreamsProvider(this.mediaSession.getUnmixedAudioProvider())}});this.callTelemetry.recordEvent("CreatingConference","",g),this.callDeviceManager||(m.info(`[${g}][initializeMediaSession] Creating new callDeviceManager`),this.callDeviceManager=this.createCallDeviceManager());const S=new Xs(this.mediaControlPlane,this.signalingSession,m.createChild("SourceRequestSender"),this.mediaControlPlane.getTelemetryLogger().getSourceRequestSenderDiagnostics),v={maxReinvitelessMediaForVBSSMultiparty:this.signalingSession.getMaxReinvitelessMediaForVBSSForWeb(),maxReinvitelessMediaForVideoMultiparty:this.signalingSession.getMaxReinvitelessMediaForVideoForWeb()};this.callTelemetry.recordEvent("_ReinvitelessConfig",{reinvitelessConfig:v},g),this.mediaSession=new Ir(this.mediaAgent.createSession(f,this.signalingSession.correlationId,{isConference:this.callUsesMixer,isPstnCall:this.isOneToOnePSTNCall(),isParkedCall:this.isParkedCall(),reinvitelessConfig:v},this.callDeviceManager),this.signalingSession,S),this.temporaryCallConstraints&&(m.info(`Applying saved call constraints to current call ${JSON.stringify(this.temporaryCallConstraints)}`),this.mediaSession.setCallConstraints(this.temporaryCallConstraints,generateCauseId()).then(this.resolveTemporaryCallConstraints).catch(this.rejectTemporaryCallConstraints).finally((()=>{this.temporaryCallConstraints=void 0,this.rejectTemporaryCallConstraints=void 0,this.resolveTemporaryCallConstraints=void 0}))),this.dataChannel.setConfigProviderView(this.mediaSession.getSessionConfig()),this.callTelemetry.recordEvent("CreatedConference","",g),this.streamManager.setMediaSession(this.mediaSession,g),this.participants.forEach((m=>{m.setMediaSession(this.mediaSession,g)}));const C=this.mediaSession.getSessionConfig()?.config;C?.useOneDsLogger&&C?.addTelemetryReportingCallback&&(this.beforeUnloadTelemetrySender=()=>{this.sendLastKnownStats()},window.addEventListener("beforeunload",this.beforeUnloadTelemetrySender)),this.screenSharingControl&&this.allowDataChannel()&&(this.screenSharingControl.setGiveControlEnabled(this.isGiveControlEnabled()),this.screenSharingControl.setupDataHandlers()),this.unmixedAudioProvider=new Js}executeNegotiation(g,m,f){const S=this.logger.createFnLogger(m,g);if(this.isCallModeStreaming()||this.isEscalationInProgress)return void S.info(`ignored due to being in streaming=${this.isCallModeStreaming()},\n                isEscalationInProgress=${this.isEscalationInProgress}`);const v=generateCauseId();3===this.state||4===this.state||5===this.state||10===this.state||this.isPreheatedOnly()?(S.info(`started, state: ${this.state}, runNegotiation: ${f}`),f?(this.callTelemetry.recordEvent("NegotiationRequired","",g),this._callOperationHandler.executeChained((()=>this.renegotiateOutgoing(g)),"_RenegotiateOutgoing",v,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})):(this.callTelemetry.recordEvent("UpdateMediaDescriptions","",g),this._callOperationHandler.executeChained((()=>this.updateMediaDescriptions(g)),"_UpdateMediaDescriptions",v,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}))):S.info(`not started, state: ${this.state}`)}async muteUnmuteWorkaround(g){if(this.mediaSession?.getSessionConfig().config.enableMuteSpeakerUnmuteSpeakerWorkaround&&!this.isSpeakerMuted&&25===g.type&&3===g.value&&0===g.mediaType){this.logger.log("Performing muteSpeaker->unmuteSpeaker workaround");const g=generateCauseId();await this.muteSpeaker(g),await this.unmuteSpeaker(g)}}sendLastKnownStats(){if(!this.tsCallingTelemetryReported){const g=this.mediaSession.getLastKnownStats(!0);this.callStats.setMediaStats(g),this.reportTelemetryEvents(this.callStats.buildShortBeaconEvent(),"media","mdsc"),this.reportTelemetryEvents(this.callStats.buildShortCallModalityStats(),"signaling"),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo);const m="in_call_session";this.reportTelemetryEvents([{eventName:m,props:this.callTelemetry.getEvent(!0)}],"signaling","skypecosi_concore_web_ts_calling")}}invertDirectionality(g){switch(g){case this.mediaAgent.constants.MEDIA_STATE.sendReceive:return Or.sendReceive;case this.mediaAgent.constants.MEDIA_STATE.send:return Or.receive;case this.mediaAgent.constants.MEDIA_STATE.receive:return Or.send;default:return null}}completeNegotiationAsync(g){const m=this.logger.createFnLogger("completeNegotiationAsync",g),f=this.mediaSession.completeNegotiationAsync(g).then((f=>{m.info(`activeModalities=${f&&Object.keys(f.activeModalities)}`);const S=this.participants[0],v=S?.endpoints?.endpointDetails.length&&S.endpoints.endpointDetails[0].mediaStreams?.length,C=this.mediaSession.getSessionConfig().config.avoidFakeStreamsDuringEscalation&&this.isEscalationInProgress;if(S&&!this.callUsesMixer&&!C&&!v){const prepareStreamData=(g,m,f)=>({participantId:ta,endpointId:ea,type:g,direction:this.invertDirectionality(m),sourceId:f,serverMuted:!1}),m=[];m.push(prepareStreamData(Nr.audio,f.activeModalities.audio,Yr)),f.activeModalities.video&&m.push(prepareStreamData(Nr.video,f.activeModalities.video,Qr)),f.activeModalities.sharing&&m.push(prepareStreamData(Nr.sharing,f.activeModalities.sharing,Xr)),S.updateStreams(m,g)}return m.logSuccess(safeJsonStringify(f)),f}));return f.catch((f=>{m.logFailure(f),this.callTelemetry.recordEvent("_CompleteNegotiationFailed",{e:f},g)})),f}async renegotiateOutgoing(g){let m;this.renegotiationAnswerDeferred=defer();const f=this.logger.createFnLogger("renegotiateOutgoing",g);if(this._hasDelayedReconnect)return f.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,void await this.mediaSession.reconnectAsync(g,!0);f.info("start");const S=createPhaseExecutor(f);try{try{m=this.inLocalHold()?this.getMediaModalitiesForHold(g):this.calculateModalityDirections({},g);const f=await S.execute("MediaCreateOffer",(()=>this.mediaSession.createOfferAsync(g))),v=this.getSignalingMediaTypes(m);await S.execute("SignalingStartNegotiation",(()=>this.signalingSession.startRenegotiationAsync(f,v,g)));const C=await S.execute("SignalingRenegotiationAnswer",(()=>this.renegotiationAnswerDeferred.promise));await S.execute("MediaProcessAnswer",(()=>this.mediaSession.processAnswerAsync(C,g,!1)));const _=await S.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(g)));this.onNegotiationCompletion(_,!0,m,g,S.getTelemetryData())}catch(S){if(f.logFailure(S),!S.phase)throw this.callTelemetry.recordEvent("OutgoingNegotiationFailure",S,g),S;let v="unknown";const C=this.mediaAgent.constants.RENEGOTIATION_ERROR;if(v=C.local,"SignalingRenegotiationAnswer"===S.phase||"SignalingStartNegotiation"===S.phase){const g=415;v=S.error.code===vi.GlareError?C.glare:S.error.code===g?C.media:C.signaling}else"MediaCreateOffer"===S.phase&&S.error.type===this.mediaAgent.constants.MEDIA_ERROR.noNetworkError&&(v=C.media);if(this.callTelemetry.recordEvent("OutgoingNegotiationFailure",this.getTelemetryFromPhaseExecution(S),g),S.error.message?.includes("The requested call does not exist"))throw new Error("Call drop due to remote replying with call not found");f.logFailure(v);const _={type:v,detail:S.error};await this.mediaSession.rejectNegotiationAsync(_,g),this.onNegotiationFailure(S,v,g,m)}}catch(m){f.logFailure(m),this.callTelemetry.recordEvent("NegotiationFatalError",getPIISafeObject(m),g),this.stopInternal({causeId:g,terminatedReason:47})}}async renegotiateIncoming(g,m){this.mediaAcknowledgmentOperation=this._callOperationHandler.createPendingOperation("_MediaAcknowledgment",null,m,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.mediaAcknowledgmentOperation.catch(noop);const f=this.logger.createFnLogger("renegotiateIncoming",m);if(f.info("start"),g.newOffer&&!this.mediaAgent.getCapabilities().retargeting)return f.logFailure("Retarget offer received, but pluginless has no support for retarget"),void this.stopInternal({causeId:m,terminatedReason:38});const S=createPhaseExecutor(f);try{const f=await S.execute("MediaProcessOffer",(()=>this.mediaSession.processOfferAsync(g,m)));this.handleOfferedModalities(f,m),2===this.getRenegotiationOfferType(f)&&await this.prepareModalitiesForResume(m);const v=await this.updateMediaModalities({offered:f},m);1===this.getRenegotiationOfferType(f)&&await this.prepareModalitiesForHold(m),this.updateMediaState(v,m),this.isRenegotiationHoldOrResume(v)&&this.updateScreenSharingState(v,m);const C=await S.execute("MediaCreateAnswer",(()=>this.mediaSession.createAnswerAsync(!1,m))),_=this.getSignalingMediaTypes(v);await S.execute("SignalingAcceptRenegotiation",(()=>this.signalingSession.acceptRenegotiationAsync(C,_,m))),await S.execute("SignalingMediaAcknowledgement",(()=>this.mediaAcknowledgmentOperation));const E=await S.execute("CompleteNegotiation",(()=>this.completeNegotiationAsync(m)));this.onNegotiationCompletion(E,!1,f,m,S.getTelemetryData())}catch(g){try{if(!g.phase||"CompleteNegotiation"===g.phase)throw this.callTelemetry.recordEvent("IncomingNegotiationFailure",g,m),g;const S=g;this.callTelemetry.recordEvent("IncomingNegotiationFailure",this.getTelemetryFromPhaseExecution(g),m);const v={type:this.mediaAgent.constants.RENEGOTIATION_ERROR.local,detail:g.error};if("SignalingAcceptRenegotiation"===S.phase||"SignalingMediaAcknowledgement"===S.phase)return f.logFailure("Error in renegotiateIncoming() -> rejecting media negotiation"),v.type=this.mediaAgent.constants.RENEGOTIATION_ERROR.signaling,this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",v,void 0,m),void await this.mediaSession.rejectNegotiationAsync(v,m);this._callOperationHandler.maybeRejectOperation("_MediaAcknowledgment",v,void 0,m),await this.mediaSession.rejectNegotiationAsync(v,m),await this.signalingSession.rejectRenegotiationAsync(void 0,m)}catch(g){f.logFailure(g),this.callTelemetry.recordEvent("NegotiationFatalError",getPIISafeObject(g),m),this.stopInternal({causeId:m,terminatedReason:47})}}}async updateMediaDescriptions(g){const m=this.logger.createFnLogger("updateMediaDescriptions",g);m.info("start");try{const f=await this.mediaSession.startMediaDescriptionsUpdateAsync(g);m.info(`send updateMediaDesriptions, descriptions=${safeJsonStringify(f)}`),await this.signalingSession.updateMediaDescriptionsAsync(g,f);const S=await this.mediaSession.completeMediaDescriptionsUpdateAsync(g);this.onUpdateMediaDescriptionsCompletion(S,g)}catch(f){m.logFailure(f),this.callTelemetry.recordEvent("UpdateMediaDescriptionsFailure",f,g);const S=await this.mediaSession.rejectMediaDescriptionsUpdateAsync(g,!0);this.onUpdateMediaDescriptionsFailure(f,S,g)}}handleCallEscalation(g,m){const f=this.logger.createFnLogger("handleCallEscalation",m);if(f.info(`current callType=${this.callType}, escalationInProgress=${g}, isEscalationInProgress=${this.isEscalationInProgress}`),g){const g=this.participants[0];g&&g.audio.participantId===ta?g.updateStreams([{type:Nr.audio,direction:"inactive",sourceId:null,serverMuted:!1},{type:Nr.video,direction:"inactive",sourceId:null,serverMuted:!1},{type:Nr.sharing,direction:"inactive",sourceId:null,serverMuted:!1}],m):f.info("no 1-1 participant found, stream update ignored"),this.setCallType(2,m),this.setCallUsesMixer(!0,m),this.setIsEscalationInProgress(!1,m),this.callTelemetry.recordEvent("_EscalationCompleted",void 0,m),this.raiseChanged()}}async reportTsCallingTelemetry(g){if(this.tsCallingTelemetryReported)return;await this.connectCallPromise.catch(noop);const m=g?"call_setup_session":"in_call_session";this.callTelemetry.setCallEndDiagnosticInfo(this.callEndDiagnosticsInfo),this.reportTelemetryEvents([{eventName:m,props:this.callTelemetry.getEvent(g)}],"signaling","skypecosi_concore_web_ts_calling"),g?this.callTelemetry.switchToInCallTelemetry():this.tsCallingTelemetryReported=!0}async sendMidCallTelemetry(g){this.mediaSession&&g?.length&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(!0)),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildMidCallTelemetry(g),"media","mdsc_mid_call_telemetry"))}sendCallSetupTelemetry(){this.mediaSession&&(this.collectCallStats(this.mediaSession),this.reportCallSetupStats(),this.isCallSetupTelemetrySent=!0)}collectCallStats(g){const always=()=>this.collectMediaStatsDeferred.resolve();return g.getStatsAsync(!1).then((g=>this.callStats.setMediaStats(g))).then(always,always)}reportCallSetupStats(){this.collectMediaStatsDeferred.promise.then((()=>{this.reportTelemetryEvents(this.callStats.buildFromCallSetupStats(),"media","mdsc"),this.event("statsReported").raise(),this.collectMediaStatsDeferred=defer()}))}async reportCallEndStats(g){this.callTelemetry.setTerminationState(this.state),this.callTelemetry.setTerminationReason(this.terminatedReason),this.callStats.localStats.endCall(this.terminatedReason),this.reportTelemetryEvents(this.callStats.buildFromLocalStats(),"signaling","skypecosi_concore_web"),this.reportTsCallingTelemetry(!this._callIsSetupComplete),g&&(await this.collectMediaStatsDeferred.promise,this.callStats.appendTerminationInfo(this.terminatedReason,this.state),this.appendInfoToCallStats(),this.reportTelemetryEvents(this.callStats.buildFromMediaStats(),"media","mdsc")),this.event("statsReported").raise(),this.collectMediaStatsDeferred=defer()}reportTelemetryEvents(g,m,f){const S=this.telemetryLoggers?this.telemetryLoggers[m]:null;S?g.forEach((g=>S.sendEvent({eventName:`${f?`${f}_`:""}${g.eventName}`,props:g.props}))):this.logger.debug(`reportTelemetryEvents no logger for tenant ${m}`)}onLocalPreviewSizeChanged(g,m){this.logger.debug(`onLocalPreviewSizeChanged: ${g}x${m}`)}onLocalPreviewStateChanged(g){this.logger.debug(`onLocalPreviewStateChanged: ${g}`),this.callStats.localStats.video.streamStateChanged(g.stream)}async configureVideoModalitiesAsync(g,m){if(!this.mediaSession)return this.logger.warn("Tried to configure modalities after call end"),Promise.resolve();await this.updateMediaModalities(void 0,m),g||this.turnOffLocalVideoPreview(m),this.setVideoOn(g,m)}turnOffLocalVideoPreview(g){return this.localVideoRenderer&&(this.localVideoRenderer.dispose(),this.localVideoRenderer=null),Promise.resolve(void 0)}turnOnLocalVideoPreview(g){const m=this.logger.createFnLogger("_StartPreviewVideo",g),f=this.mediaStateConfigurationHelper.isSending(1);if(!f||!this.localVideoContainer)return Promise.reject(`could not start video preview: requestedVideoState=${f}, localVideoContainer=${this.localVideoContainer}`);this.turnOffLocalVideoPreview(g);const S=asap((()=>{this.localVideoRenderer=this.callDeviceManager.getDeviceManager(getAgentMediaType(1)).createPreviewRenderer(this.localVideoContainer),this.localVideoRenderer.on("onVideoSizeChanged",((g,m)=>this.onLocalPreviewSizeChanged(g,m))),this.localVideoRenderer.on("onVideoStateChanged",(g=>this.onLocalPreviewStateChanged(g)))})).then((()=>this.localVideoRenderer.startVideoAsync(g)));return S.catch((g=>m.logFailure(g))),S}startStopVideo(g,m){const f=this.logger.createFnLogger(g?"startVideo":"stopVideo",m);if(f.info("start"),!this.canToggleVideo)return g===this.mediaStateConfigurationHelper.isSending(1)?this.videoTogglePromise.then((()=>{this.turnOnLocalVideoPreview(m)})):(f.logFailure(`video switching is in progress ${g}]`),Promise.reject({reason:1}));g?(this.callStats.localStats.newSession(1),this.callStats.localStats.video.start()):this.callStats.localStats.video.stop(),g&&this.mediaStateConfigurationHelper.isDisabled(1)&&f.info("Video modality was skipped till now. Adding it now."),g?this.mediaStateConfigurationHelper.enableModality(1):this.mediaStateConfigurationHelper.removeModality(1),this.canToggleVideo=!1;const always=()=>{this.canToggleVideo=!0};return this.videoTogglePromise=Promise.resolve().then((()=>!!g&&(this.localVideoContainer||(this.localVideoContainer=document.createElement("div")),this.turnOnLocalVideoPreview(m).then((()=>!0))))).then((g=>this.configureVideoModalitiesAsync(g,m))).catch((g=>(f.logFailure(g),this.mediaStateConfigurationHelper.removeModality(1),this.configureVideoModalitiesAsync(!1,m).then((()=>{throw g}))))).then(always,(g=>{throw f.logFailure(g),always(),g})),this.videoTogglePromise}async startStopAudio(g,m){const f=this.logger.createFnLogger(g?"startAudio":"stopAudio",m);try{const g=await this.updateMediaModalities(void 0,m);this.updateMediaState(g,m)}catch(g){return f.logFailure(g),9}return 0}updateEndpointStateForMute(g,m){try{this.signalingSession.updateEndpointState({state:{isMuted:g}},m).catch((g=>{this.logger.logFailure(`updateEndpointStateForMute failure: ${g}`)}))}catch(g){this.logger.logFailure(`updateEndpointStateForMute failure: ${g}`)}}async handleServerMutedState(g){const m=this.logger.createFnLogger(`handleServerMutedState, isServerMuted=${!!this.isServerMuted}`,g);if(!this.isServerMuted){const f=3===this._muteState;if(1===this._muteState||f)try{m.info("is unmuting, as we are no longer server muted"),await this.handleMuteUnmuteOnMediaSession(!1,g),this.setMuted(0,g),this.unmutePendingPromise?.resolve(),f&&this.updateEndpointStateForMute(!1,g)}catch(g){throw m.logFailure(g),g}}if(this.isServerMuted&&0===this._muteState){m.info("is muting, as we are unmuted");try{await this.handleMuteUnmuteOnMediaSession(!0,g),this.setMuted(1,g)}catch(g){throw m.logFailure(g),g}}}async handleMuteUnmuteOnMediaSession(g,m){const f=this.logger.createFnLogger(`handleMuteUnmuteOnMediaSession, value=${!!g}`,m);if(this.mediaSession&&this.mediaSession.getAllowedModalities&&!this.isServerMuted){const S=this.isMuted||this.isServerMuted,v=this.mediaSession.getAllowedModalities().audio.some((g=>g===Or.send||g===Or.sendReceive));(S&&v||!S&&!v)&&(f.info(`updating audio modalities: Muted ${S} -> ${g}; audioAllowed = ${v}`),await this.updateMediaModalities(void 0,m))}return g?(f.info("mediaSession.muteInputAsync"),await this.mediaSession.muteInputAsync(m)):g||(f.info("mediaSession.unmuteInputAsync"),await this.mediaSession.unmuteInputAsync(m)),Promise.resolve()}updateCapabilities(g,m=!1){let f=!1,S=!1;if(!callStateIsAnyOf(this.state,[11,12])){const g="attendee"===(this.advancedMeetingRole||this.meetingRole);this.isServerMuted&&!this._callInLobby?2&this._commandUrlPresence&&(f=!0):this.isMuted&&(f=!0),S=!!(1&this._commandUrlPresence)&&!g}this._capabilities.canUnmuteSelf===f&&this._capabilities.canMuteOthers===S||(this._capabilities.canUnmuteSelf=f,this._capabilities.canMuteOthers=S,this.logger.info(`[${g}][updateCapabilities] Computed self capabilities: ${JSON.stringify(this._capabilities)}`),m&&this.raiseChanged())}async handleEndpointStatesForAccept(g,m,f){const S=this.logger.createFnLogger(`handleEndpointStatesForAccept, isMuted=${!!g}`,f);try{const v={};await this.handleMuteUnmuteOnMediaSession(g,f),Object.assign(v,{state:{isMuted:g}}),S.info("is updating endpointState for mute"),m&&(Object.assign(v,{endpointProperties:{additionalEndpointProperties:m}}),S.info("is updating endpointState for additionalEndpointProperties")),await this.signalingSession.updateEndpointState(v,f)}catch(g){throw S.logFailure(g),getRejectTransactionEnd(g)}}async muteUnmute(g,m){const f=this.logger.createFnLogger(`muteUnmute, value=${!!g} isServerMuted=${this.isServerMuted} inLobby=${this._callInLobby}`,m);if(callStateIsAnyOf(this.state,[11,12]))return f.logFailure("Can not mute/unmute during preheat call"),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));const S=!g&&(!this.isServerMuted||this._callInLobby);try{if((g||S)&&await this.handleMuteUnmuteOnMediaSession(g,m),g)this.setMuted(2,m),f.info("is updating endpointState for mute"),this.updateEndpointStateForMute(!0,m);else{if(!S)return f.info("is unmuting on server"),2===this._muteState&&this.setMuted(3,m),this.isCallModeStreaming()?this.promoteToRealtimeAndUnmute(m):this.signalingSession.unmuteAsync().then((g=>{this.handleSelfUnmuteUpdatedInfo(g,m)}));f.info("is updating endpointState for unmute"),this.setMuted(0,m),this.updateEndpointStateForMute(!1,m)}}catch(g){throw f.logFailure(g),getRejectTransactionEnd(g)}}async muteUnmuteSpeaker(g,m){this.setSpeakerMuted(g,m),this.mediaSession&&(g?await this.mediaSession.muteOutputAsync(m):await this.mediaSession.unmuteOutputAsync(m))}getParticipant(g){return this.participants.filter((m=>m.isSameParticipantsMri(g)))[0]}getOrCreateParticipant(g,m,f){let S=this.getParticipant(g);return S||(S=new is(g,this.mediaSession,this.logger,this.callStats.localStats,this.callTelemetry,m),S.changed((()=>this.onParticipantChanged(S))),this.participants.push(S),f&&this.event("participantAdded").raise(S),this.monitorCallStart(),S)}onParticipantChanged(g){this.event("participantUpdated").raise(g),this.raiseChangedDeferred(this._participantChangedEventSkipConfig)}setCallState(g,m,f=0){if(this.state===g)return;const S=this.logger.createFnLogger("setCallState",m);S.info(`currentState=${this.state}, newState=${g}, terminatedReason=${this.terminatedReason}`);(Jn[this.state].indexOf(g)>=0||(S.logFailure("invalid state transition"),7===g))&&(this.callTelemetry.recordEvent("_SetCallState",{state:g,reason:f},m),this.state=g,this.callStats.localStats.call.callStateChanged(g),7===g&&this.setTerminatedReason(f),3===g&&(this.callGotConnected=!0,this.callHeldAt=null),this.callIsHeld()&&!this.callHeldAt&&(this.callHeldAt=new Date),S.logSuccess(`changed to ${g}, terminatedReason: ${this.terminatedReason}, failureType=${this.failureType}`),this.screenSharingControl.callStateChanged(this.state),this.monitorCallStart(),this.event("callStateChanged").raise(),this.updateCapabilities(m),this.raiseChanged(),this.callTelemetry.recordEvent("_RaiseCallStateChangeEvent",{state:g,reason:f},m))}setTerminatedReason(g){if(this.terminatedReason=g,!(0,Mi.includes)(Zs,g)){const g=44===this.terminatedReason,m=55===this.terminatedReason,f=56===this.terminatedReason;this.setFailureType(!this.callGotConnected||!this._wasAudioStreamConnected||g||m||f?0:1)}}setMediaStream(g,m,f){if(g){if(!(0,Mi.find)(this.localMediaStreams,(g=>g.mediaType===f))){const g=new ia(m,f);this.logger.info(`setMediaStream ${JSON.stringify(g)}`),this.localMediaStreams.push(g)}}else this.logger.info(`setMediaStream removing ${f}`),(0,Mi.remove)(this.localMediaStreams,(g=>g.mediaType===f))}setVideoOn(g,m){this.logger.info(`[${m}]videoOn=${g}`),this.isVideoOn=g,this.setMediaStream(this.isVideoOn,!0,1),this.callTelemetry.recordEvent("_SetLocalVideo",{value:g},m),this.raiseChanged()}setAudioOn(g,m){this.logger.info(`[${m}]audioOn=${g}`),this.setMediaStream(g,!0,0),this.callTelemetry.recordEvent("_SetLocalAudio",{value:g},m)}setScreenSharingOn(g,m){this.logger.info(`[${m}]screenSharingOn=${g}`),this.isScreenSharingOn=g,this.setMediaStream(this.isScreenSharingOn,this.isScreenSharingOn,2),this.callTelemetry.recordEvent("_SetScreenSharing",{screenSharingOn:g},m),this.event("userActivityChanged").raise(),this.raiseChanged()}disposeSharingScreenHandle(){this.sharedScreenHandle&&(this.unsubscribeFromSharedScreenHandleEvents(),this.sharedScreenHandle.dispose(),this.sharedScreenHandle=null)}setMuted(g,m){this._muteState!==g&&(this._muteState=g,this.callTelemetry.recordEvent("_SetMuted",{isMuted:g},m),this.logger.info(`[${m}]participantMuteState:${g}, isMuted: ${this.isMuted}`),this.updateCapabilities(m),this.raiseChanged())}setSpeakerMuted(g,m){this.logger.info(`[${m}]speakerMute=${g}]`),this.isSpeakerMuted=g,this.raiseChanged()}monitorCallStart(){3!==this.state||!this.participants.length&&2!==this.callMode||this.callStartedAt||(this.callStartedAt=new Date)}_removeParticipant(g,m,f=0){const S=this.logger.createFnLogger("removeParticipant",m);S.info(`mri=${scrubSignalingParticipant(g)}`);const v=(0,Mi.remove)(this.participants,(m=>m.isSameParticipantsMri(g.id)))[0];v?(v.setState(4,f,m),this.event("participantRemoved").raise(v)):S.logFailure(`unable to remove participant ${scrubMriOrOmit(g.id)}`),this.raiseChanged(this._participantChangedEventSkipConfig)}setIsSomeoneSharing(g,m){const f=this.isSomeoneSharing!==g&&!(g&&this.screenSharingRenegotiationDeferred&&this.callUsesMixer);f&&(this.isSomeoneSharing=g);let S=f;if(this.callUsesMixer&&this.mediaSession?.getSessionConfig().config.enableStopSharingWithIncomingOffer&&(S||(S=m)),S&&this.isSomeoneSharing&&this.isScreenSharingOn&&(this.stopScreenSharing(),this.logger.info("sharingStolen: Cleaning up local screenshare because remote screenshare is running"),this.event("sharingStolen").raise()),this.allowScreenSharingControl()){const g=this.localSignalingParticipant.endpointDetails.find((g=>this._endpointId===g.endpointId)),m=this.participants.find((g=>g.streams[1].some((g=>g.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,m,g)}}handleOfferedModalities(g,m){const f=this.mediaAgent.constants.MEDIA_STATE,S=this.logger.createFnLogger("handleOfferedModalities",m);try{S.info(`offeredModalities=${safeJsonStringify(g)}`)}catch(g){S.logFailure(g)}g.hasOwnProperty("video")||this.mediaStateConfigurationHelper.isSending(1)?g.hasOwnProperty("video")&&!this.mediaStateConfigurationHelper.isSending(1)&&this.mediaStateConfigurationHelper.removeModality(1):this.mediaStateConfigurationHelper.disableModality(1),g.hasOwnProperty("sharing")||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.disableModality(2),g.sharing!==f.receive||this.mediaStateConfigurationHelper.isSending(2)||this.mediaStateConfigurationHelper.removeModality(2),g.data===f.sendReceive&&this.allowDataChannel()&&this.mediaStateConfigurationHelper.enableModality(3),this.setIsSomeoneSharing(g.sharing===f.receive,!0),this.isSomeoneStreamingVideo=g.video===f.receive||g.video===f.sendReceive}getRenegotiationOfferType(g){if(g)if(5===this.state){if("sendrecv"===g.audio)return 2}else if(this.modalitiesAreHold(g))return 1;return 0}isRenegotiationHoldOrResume(g){return 1===this.getRenegotiationOfferType(g)||2===this.getRenegotiationOfferType(g)}isValidHoldResumeCallState(g){return[3,5,10,13].includes(g)}onNegotiationCompletion(g,m,f={},S,v){const C=this.logger.createFnLogger("onNegotiationCompletion",S);C.info(`byLocal=${m}, result=${safeJsonStringify(g)}`),this.callTelemetry.recordEvent("NegotiationCompletion",{phaseTelemetryBag:v,...this.prepareNegotiationResultForTelemtry(g)},S);const _=this.isOneToOneCall();if(_){const m=this.modalitiesAreHold(g.activeModalities)?5:3;this.participants[0].setState(m,void 0,S),C.info(`isOneToOneCall: participant[0] state set to ${m}`)}const E=this.modalitiesAreHold(g.configuredModalities),T=this.modalitiesAreHold(g.activeModalities);let I;const b=this.signalingSession.participantManager.localParticipant.isStaging;C.info(`isStaging= ${b}`),this.requestedHoldState?(E&&T||C.info(`Not expected modalities when processing local hold: ${E} ${T}`),4!==this.state&&C.info(`Not expected state when processing local hold: ${this.state}, switching back to LocalHold`)):m||this.callHoldResumeDeferred?!E&&T?I=5:E||T||this._callInLobby||this.isPreheatedOnly()||(I=b?13:3):4===this.state||this._callInLobby||this.isPreheatedOnly()||(I=_&&5===this.participants[0].state?5:b?13:3),I&&this.setCallState(I,S),this.callHoldResumeDeferred&&(C.info(`isHoldInProgress=${this.isHoldInProgress}, state=${this.state}, completed=${T}`),this.isHoldInProgress?T&&this.finishCallHoldResume():this.inLocalHold()||this.finishCallHoldResume(this.isValidHoldResumeCallState(I)?void 0:new Error(`Call state changed to ${I} instead of Connected, Lobby, Staging or RemoteHold`))),this.requestedHoldState||(this.setIsSomeoneSharing((0,Mi.some)(this.participants,(g=>(0,Mi.some)(g.streams[1],(g=>g.isAvailable))))),this.isSomeoneStreamingVideo=(0,Mi.some)(this.participants,(g=>(0,Mi.some)(g.streams[0],(g=>g.isAvailable)))));const A=f&&f.sharing===this.mediaAgent.constants.MEDIA_STATE.send,P=g?.activeModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(this.resolveScreenSharingRenegotiation(S,A,P,g.isComplete),this.retryOutgoingRenegotiation.retry){const g=this.retryOutgoingRenegotiation.causeId;this._callOperationHandler.executeChained((()=>this.updateMediaModalities(void 0,g)),"_Renegotiate",g,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),this.retryOutgoingRenegotiation.retry=!1}}onUpdateMediaDescriptionsFailure(g,m,f){const S=m?.requestedModalities.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.screenSharingRenegotiationDeferred&&S&&(this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null)}onUpdateMediaDescriptionsCompletion(g,m){this.logger.createFnLogger("onUpdateMediaDescriptionsCompletion",m).info(`result=${safeJsonStringify(g)}`),this.callTelemetry.recordEvent("UpdateMediaDescriptionsCompletion",g,m);const f=g?.requestedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send,S=g?.appliedModalities?.sharing===this.mediaAgent.constants.MEDIA_STATE.send;this.resolveScreenSharingRenegotiation(m,f,S,!0)}resolveScreenSharingRenegotiation(g,m,f,S){const v=this.logger.createFnLogger("resolveScreenShareRenegotiation",g);if(this.screenSharingRenegotiationDeferred)if(m&&f)v.info("resolving screenSharingRenegotiationDeferred"),this.screenSharingRenegotiationDeferred.resolve(),this.screenSharingRenegotiationDeferred=null;else if(this._enableResolveScreenSharingWhenNegotiationComplete&&S&&!this.retryOutgoingRenegotiation.retry&&this.canToggleScreenSharing){const g=new Error(`screenSharing error: wasSharingOfferred: ${m}, isSharingActive: ${f}`);v.error(`reject screenSharingRenegotiationDeferred ${g}`),this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null}}async updateMediaStatus(g){if(this.calculateIsSomeoneStreaming(g),this.mediaSession){const m=await this.updateMediaModalities(void 0,g);this.callTelemetry.updateOperationData("_UpdateLocalMediaStatus",m,g)}}calculateIsSomeoneStreaming(g){let m=!1,f=!1;for(const g of this.participants)if(m||(m=(0,Mi.some)(g.streams[1],(g=>g.isAvailable))),f||(f=(0,Mi.some)(g.streams[0],(g=>g.isAvailable))),m&&f)break;this._hasDelayedReconnect&&(m||f)&&(this.logger.info("Reconnecting with delay"),this._hasDelayedReconnect=!1,this._callOperationHandler.executeChained((()=>this.mediaSession.reconnectAsync(g,!0)),"_RenegotiateOutgoing",g,g,void 0,void 0,{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})),this.setIsSomeoneSharing(m),this.isSomeoneStreamingVideo=f}onNegotiationFailure(g,m,f,S){const v=S&&S.sharing===this.mediaAgent.constants.MEDIA_STATE.send;if(m===this.mediaAgent.constants.RENEGOTIATION_ERROR.glare)return this.screenSharingRenegotiationDeferred&&v&&this.callStats.localStats.screenShare.negotiationStateChanged("rejected","glare"),void(this.retryOutgoingRenegotiation={retry:!0,causeId:f});const C=new Error(`Error in renegotiateOutgoing() -> rejecting hold for callId = ${this.callId}, reason=${m}`);C.innerError=g,this.finishCallHoldResume(C),this.screenSharingRenegotiationDeferred&&v&&(this.screenSharingRenegotiationDeferred.reject(g),this.screenSharingRenegotiationDeferred=null)}static getParticipantReasonFromTerminatedReason(g){switch(g){case 1:return 0;case 9:return 2;case 10:return 3;case 2:return 4;case 24:return 8;case 3:return 9;case 4:return 10;case 14:return 12;case 0:default:return 11;case 15:return 13;case 16:return 14;case 17:return 15;case 18:return 16;case 19:return 17;case 20:return 18;case 11:return 19;case 21:return 20;case 22:return 21;case 23:return 22;case 33:return 25;case 36:return 26;case 37:return 27;case 41:return 30;case 39:return 28;case 42:return 31;case 40:return 29;case 43:return 32;case 44:return 33;case 45:return 34;case 46:return 35;case 47:return 36;case 48:return 37;case 49:return 38;case 50:return 39;case 51:return 40;case 52:return 41;case 54:return 42;case 55:return 44;case 56:return 45;case 12:return 23;case 59:return 46;case 73:return 59;case 61:return 47;case 60:return 48;case 62:return 49;case 63:return 50;case 64:return 5;case 65:return 51;case 8:return 52}}isRemoteParticipantInStaging(g){if(!g.endpointDetails)return!1;for(const m of g.endpointDetails)if(!hasStagingGroup(m))return!1;return!0}updateCallParticipantFromSignalingParticipant(g,m,f){if((0,Mi.every)(m.endpointDetails,(g=>g?.isLobby||g?.streamLobby)))return void g.setState(7,void 0,f);const S=(0,Mi.some)(m.endpointDetails,(g=>g?.streamInformation)),v=m.endpointDetails&&(0,Mi.some)(m.endpointDetails,(g=>g.mappedTo)),C=_PluginlessCall.filterVirtualEndpoints(m.endpointDetails),_=C&&C[0].mediaStreams,E=this.isRemoteParticipantInStaging(m);if(_&&_.length>0){const m=_.every((g=>"inactive"===g.direction));let S=m?5:E?8:3;1!==this.state||m||this.callUsesMixer||(S=2),this.logger.info(`[updateCallParticipantFromSignalingParticipant]: with mediaStreams is not empty, ParticipantState is set to ${S}`),g.setState(S,void 0,f)}else if(_||v||S){const m=E?8:3;this.logger.info(`[updateCallParticipantFromSignalingParticipant]: ParticipantState is set to ${m}, mediaStreams=${!!_}, hasMappedEndpoints=${v}, hasPlayerStreams=${S}`),g.setState(m,void 0,f)}}handleSelfServerMutedState(g){const m=_PluginlessCall.filterVirtualEndpoints(this.localSignalingParticipant.endpointDetails),f=(0,Mi.find)(m,(g=>this._endpointId===g.endpointId)),S=f&&f.mediaStreams,v=S&&S.filter((g=>"audio"===g.type||"audio-teleconferencing"===g.type)),C=f&&(f.stream||f.streamLobby);if(C){const m=C.serverMuted??!1;f.serverMuteVersion=0,m!==this.isServerMuted&&(this.isServerMuted=m,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${m}`),this.event("serverMutedChanged").raise(m),this.updateCapabilities(g,!0),this.isServerMuted&&this.setMuted(1,g))}else if(v&&v.length>0){const m=v.some((g=>g.serverMuted));m!==this.isServerMuted&&(this.isServerMuted=m,this.callTelemetry.recordEvent("_SelfParticipantUpdated",{isServerMuted:this.isServerMuted}),this.logger.info(`updateLocalParticipant: server muted set to ${m}`),this.event("serverMutedChanged").raise(m),this.updateCapabilities(g,!0),this.handleServerMutedState(g))}}checkIfIncomingServerMutedIsUpdated(g){const m=(0,Mi.find)(this.localSignalingParticipant.endpointDetails,(g=>g.participantId===this.localSignalingParticipant.participantId));if(void 0===m)return;const f=(0,Mi.find)(g.endpointDetails,(g=>g.participantId===this.localSignalingParticipant.participantId));handleServerMutedVersion(this.logger,m,f)}convertWiredPublishedState(g){if(!g)return;const m=getPluginlessStateTypeFromWire(g.stateType);return{content:g.content,stateType:m,typeRank:g.typeRank,stateId:g.stateId}}updatePublishedStateModified(g,m){g!==this.currentUserSkypeIdentity.id||m&&m!==this.participantId?this._publishedStatesModified=2|this._publishedStatesModified:this._publishedStatesModified=1|this._publishedStatesModified}updatePublishedStates(g){try{let m=[];(0,Mi.forEach)(g.publishedStates,(g=>{m.push(this.convertWiredPublishedState(g))})),(0,Mi.isEqual)(this._participantPublishedStatesMap[g.id],m)||(0!==m.length||void 0!==this._participantPublishedStatesMap[g.id]&&null!==this._participantPublishedStatesMap[g.id])&&(this._participantPublishedStatesMap[g.id]=m,this.updatePublishedStateModified(g.id));const f=[];(0,Mi.forEach)(g.endpointDetails,(S=>{f.push(S.participantId),m=[],(0,Mi.forEach)(S.publishedStates,(f=>{const v=this.convertWiredPublishedState(f);this._endpointPublishedStatesMap[g.id]||(this._endpointPublishedStatesMap[g.id]={},this._endpointPublishedStatesMap[g.id][S.participantId]=[]),m.push(v)})),this._endpointPublishedStatesMap[g.id]&&!(0,Mi.isEqual)(this._endpointPublishedStatesMap[g.id][S.participantId],m)&&(0!==m.length||null!==this._endpointPublishedStatesMap[g.id][S.participantId]&&void 0!==this._endpointPublishedStatesMap[g.id][S.participantId])&&(this._endpointPublishedStatesMap[g.id][S.participantId]=m,this.updatePublishedStateModified(g.id,S.participantId))})),this._endpointPublishedStatesMap[g.id]&&Object.keys(this._endpointPublishedStatesMap[g.id]).forEach((m=>{f.some((g=>g===m))||(delete this._endpointPublishedStatesMap[g.id][m],this.updatePublishedStateModified(g.id,m))}))}catch(g){this.logger.error(`updatePublishedStates ${JSON.stringify(g)}`)}this.logger.info(`updatePublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`updatePublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`)}removePublishedStatesByParticipant(g){this._endpointPublishedStatesMap[g]&&delete this._endpointPublishedStatesMap[g],this._participantPublishedStatesMap[g]&&delete this._participantPublishedStatesMap[g],this.updatePublishedStateModified(g)}findOrCreateTypeState(g){let m=this._publishedStates.typeStates.findIndex((m=>m.type===g));if(-1===m){const f={participantStates:[],type:g};this._publishedStates.typeStates.push(f),m=this._publishedStates.typeStates.length-1}return m}processPublishedStates(){this.logger.info(`processPublishedStates ${JSON.stringify(this._participantPublishedStatesMap)}`),this.logger.info(`processPublishedStates ${JSON.stringify(this._endpointPublishedStatesMap)}`);try{this._publishedStates||(this._publishedStates={typeStates:[]}),this._publishedStates.typeStates=[];for(const g of Object.keys(this._participantPublishedStatesMap)){const m=this._participantPublishedStatesMap[g];(0,Mi.forEach)(m,(m=>{const f=this.findOrCreateTypeState(m.stateType),S={id:g,publishedState:{content:m.content,stateId:m.stateId,typeRank:m.typeRank}};this._publishedStates.typeStates[f].participantStates.push(S)}))}for(const g of Object.keys(this._endpointPublishedStatesMap))for(const m of Object.keys(this._endpointPublishedStatesMap[g])){this._endpointPublishedStatesMap[g][m].forEach((f=>{const S=this.findOrCreateTypeState(f.stateType),v={id:m,publishedState:{content:f.content,stateId:f.stateId,typeRank:f.typeRank}},C={id:g,endpoints:[v]},_=this._publishedStates.typeStates[S].participantStates.filter((m=>m.id===g));_&&_.length>0?(_[0].endpoints||(_[0].endpoints=[]),_[0].endpoints.push(v)):this._publishedStates.typeStates[S].participantStates.push(C)}))}this.event("publishedStatesChanged").raise(this._publishedStates),this.raiseChanged()}catch(g){this.logger.error(`processPublishedStates ${g}}`)}}updateLocalParticipant(g,m){const f=this.logger.createFnLogger("updateLocalParticipant",m);this.checkIfIncomingServerMutedIsUpdated(g),this.localSignalingParticipant.endpointDetails=g.endpointDetails,this.localSignalingParticipant.role=g.role,this.setMeetingRole(g.meetingRole),this.setAdvancedMeetingRole(g.advancedMeetingRole),this.setParticipantType(g.participantType),this.setPropertyBag(g.propertyBag),this.setPropertyRosterVersion(g.version),this.setMaskedIdentityDetails(g.isIdentityMasked,g.maskedIdSeqNumber,g.maskedId),this.localSignalingParticipant.tenantId=g.tenantId,this.localSignalingParticipant.isLobby=g.isLobby,this.callTelemetry.setTenantId(g.tenantId),this.callStats.setTenantId(g.tenantId);const S=this.localSignalingParticipant.isLobby;g.endpointDetails&&this.updateLocalParticipantEndpoints(g.endpointDetails),this.updatePublishedStates(g),this.handleSelfServerMutedState(m);const v=this.getLocalSignalingEndpointDetails();this._callInLobby=S||!!v?.streamLobby,this.signalingSession.participantManager.localParticipant.isStaging=g.isStaging;const C=this.signalingSession.participantManager.localParticipant.isStaging;f.info(`callInLobby = ${S}, callSetupComplete = ${this._callIsSetupComplete}, callIsHeld = ${this.callIsHeld()}, isStaging = ${C}`),!this._callIsSetupComplete||this.callIsHeld()||callStateIsAnyOf(this.state,[11,12])||(S?this.setCallState(10,m):C&&callStateIsAnyOf(this.state,[3,13,10,9,2])?this.setCallState(13,m):this.setCallState(3,m));const _=_PluginlessCall.getStreamsFromEndpoints(g.endpointDetails);if(this.callTelemetry.recordEvent("_UpdateLocalParticipantStream",getStreamInformation(_),m),this.streamManager.updateStreams(_,m),this.updateCapabilities(m,!0),this.allowScreenSharingControl()){const m=g.endpointDetails.find((g=>this._endpointId===g.endpointId)),f=this.participants.find((g=>g.streams[1].some((g=>g.isAvailable))));this.screenSharingControl.startOrStopControlForViewer(this.isSomeoneSharing,f,m)}}modalitiesAreHold(g){return!(g.audio&&"inactive"!==g.audio||g.video&&"inactive"!==g.video||g.sharing&&"inactive"!==g.sharing)}toneToString(g){switch(g){case 0:return"0";case 1:return"1";case 2:return"2";case 3:return"3";case 4:return"4";case 5:return"5";case 6:return"6";case 7:return"7";case 8:return"8";case 9:return"9";case 10:return"*";case 11:return"#";default:return null}}static streamingStatetoMediaStreamState(g){switch(g){case"started":return 0;case"active":return 2;case"inactive":return 1;case"stopped":return 3;default:return 4}}static streamingDirectionToMediaDirectionMapping(g){switch(g){case"send":return 1;case"receive":return 0;default:return}}static convertMuteScope(g){switch(g){case 0:return"EveryoneElse";case 1:return"SpecifiedParticipants";default:return}}callIsHeld(){return 4===this.state||5===this.state}inLocalHold(){return this.isHoldInProgress||4===this.state}telemetryDataFromCallStartOptions(g){const m={};return g.muteFlags&&(m.muteMicrophone=!!(1&g.muteFlags),m.muteSpeaker=!!(2&g.muteFlags)),Object.keys(m).length?m:void 0}reconnect(){const g=generateCauseId();return this.mediaSession.reconnectAsync(g)}async provideCallQualityFeedback(g,m,f,S){}async showCQFInfo(g,m){throw new Error("Not implemented")}async isCqfRendered(g){}async provideCallQualityFeedbackEx(g,m,f,S,v,C){}testTriggerMediaRelayWhiteListingIssue(){this.logger.info("Simulating media relay whitelisting issue for test purposes");const g=this.mediaSession.mediaSession.callback,m={type:"NetworkRelaysNotReachable",value:"Bad",isLocalSource:!0,mediaType:"Audio"};g.onQualityChanged(m);const f={direction:"send",stream:"failed",content:"audio"};g.onAudioStateChanged(f)}async getMediaTelemetry(g=!1){return this.mediaSession&&(this.callStats.setMediaStats(await this.mediaSession.getStatsAsync(g)),this.appendInfoToCallStats()),this.callStats.buildMediaTelemetry()}getMediaSessionStats(){return this.mediaSession?.getMediaStatsReport()}getDiagnosticsForE2E(){return this.mediaSession?.getDiagnostics().e2eDiagnostics}appendInfoToCallStats(){this.callStats.appendDataChannelInfo(this.dataChannel.getTelemetry()),this.callStats.appendSharingControlInfo(this.screenSharingControl?.isScreenSharingControlEnabled()),this.callStats.appendMediaControlPaneInfo(JSON.stringify(this.mediaControlPlane.getTelemetryReport()))}getMediaLogs(){return this.mediaAgent.getMediaLogs()}testSetCallState(g){this.logger.info(`Overwriting call state for test purposes: ${this.state} -> ${g} `),this.state=g}testSetCallType(g){this.logger.info(`Overwriting call state for test purposes: ${this.callType} -> ${g} `),this.callType=g}addGroupModality(g,m=generateCauseId()){const f=this.logger.createFnLogger("AddGroupModality",m);if(!g.threadId&&!g.groupId)return Promise.reject(getRejectTransactionEnd("No threadId/groupId was provided."));if(6===this.state||7===this.state)return f.info(`Not adding modality because CallState is ${this.state} groupId=${scrubMriOrOmit(g.groupId)}, threadId = ${getLoggableThreadId(g.threadId)} messageId = ${g.messageId}`),Promise.reject(getRejectTransactionEnd("TransactionDisallowed"));let S;if(g.additionalData)try{S=JSON.stringify(g.additionalData)}catch(m){f.logFailure(`additionalData: ${g.additionalData} is not valid Json, error: ${m}`);const S={code:vi.BadRequest,subCode:0,phrase:`additionalData is not valid Json, error: ${m}`};return Promise.reject(S)}f.info(`groupId=${scrubMriOrOmit(g.groupId)}, threadId = ${getLoggableThreadId(g.threadId)} messageId = ${g.messageId} additionalData = ${scrubMriOrOmit(S)}`);const v={groupId:g.groupId,threadId:g.threadId,messageId:g.messageId,additionalData:S};return this.signalingSession.addGroupModalityAsync(v,m).catch((g=>(f.logFailure(getPrintableObject(g)),Promise.reject(g))))}addBroadcastModality(g,m){const f=this.logger.createFnLogger("AddBroadcastModality",m);return Promise.resolve().then((()=>{this.signalingSession.addBroadcastModalityAsync(g,m)})).catch((g=>(f.logFailure(getPrintableObject(g)),Promise.reject(getRejectTransactionEnd(g))))).then((()=>this._callOperationHandler.waitForOperation("AddBroadcastModality"))).catch((g=>{throw this.callTelemetry.updateOperationData("AddBroadcastModality",{error:getPIISafeObject(g)},m),f.logFailure(g),g}))}static convertQualityEventType(g){switch(g){case"NetworkSendQuality":return 1;case"NetworkRecvQuality":return 2;case"NetworkDelay":return 3;case"NetworkBandwidthLow":return 4;case"NetworkReconnect":return 5;case"NetworkPacketLoss":return 6;case"NetworkJitter":return 7;case"NetworkRateMatching":return 8;case"DeviceCaptureNotFunctioning":return 9;case"DeviceRenderNotFunctioning":return 10;case"DeviceRenderGlitches":return 11;case"DeviceLowSNR":return 12;case"DeviceLowSpeechLevel":return 13;case"DeviceClipping":return 14;case"DeviceEcho":return 15;case"DeviceNearEndToEchoRatio":return 16;case"DeviceHalfDuplexAec":return 17;case"DeviceMultipleEndpoints":return 18;case"DeviceHowling":return 19;case"DeviceRenderZeroVolume":return 20;case"DeviceRenderMute":return 21;case"NetworkSendCatastrophic":return 22;case"NetworkRecvCatastrophic":return 23;case"CpuInsufficient":return 24;case"DeviceCaptureMute":return 25;case"DeviceCaptureNotMuteButSilent":return 26;case"DeviceSpeakWhileMuted":return 27;case"VideoVbssRendered":return 28;case"NetworkEthernetInterfaceUsed":return 29;case"NetworkWlanInterfaceUsed":return 30;case"NetworkWwanInterfaceUsed":return 31;case"NetworkRelaysNotReachable":return 32;case"VideoCapturerDeviceStartFailed":return 33;case"VideoCapturerDeviceStartTimedOut":return 34;case"VideoCapturerDeviceStartFailureLackSystemRes":return 35;case"VideoCapturerDeviceStartFailureMFResConflict":return 36;case"NoNetwork":return 37;case"NetworkNotWorking":return 38;case"DeviceCaptureNotFunctioningDeviceInUse":return 39;case"DeviceRenderNotFunctioningDeviceInUse":return 40;case"VideoCaptureDeviceFreeze":return 45;case"ZeroCaptureDevicesEnumerated":return 43;case"ZeroRenderDevicesEnumerated":return 44;case"VideoCapturePermissionDenied":return 47;case"ScreenshareRecordingDisabled":return 55;case"AudioCapturePermissionDenied":return 46;case"VideoCaptureFreezeRecovered":return 48;case"DeviceRenderHowling":return 49;case"PresentationAudioLoopbackDeviceState":return 53;case"RemoteNetworkConnectivityIssue":return 52;case"AudioCaptureUltrasoundDetected":return 54;case"MusicModeNotAvailable":return 57;case"CameraLighting":return 61;case"AudioLoopbackDeviceReady":return 63;case"NoRequiredVideoCodecs":return 64;case"SpatialAudioMUCHUnavailable":return 65;default:return}}static convertQualityLevel(g){switch(g){case"Unknown":return 0;case"Good":return 1;case"Poor":return 2;case"Bad":return 3;default:return}}static convertMediaType(g){switch(g){case"Audio":return 0;case"Video":return 1;case"ScreenShare":return 2;case"Data":return 3;default:return}}getPluginlessPublishLevel(g){switch(g){case"user":return"user";case"endpoint":return"endpoint";default:throw"Invalid level type."}}setIsEmergency(g){this.logger.info(`Set isEmergency:${g}`),this.isEmergency=g,this.callTelemetry.setIsEmergency(g)}static filterVirtualEndpoints(g){return g&&(0,Mi.filter)(g,(g=>!g.mappedTo))}mapDataChannelSourceIdToParticipant(g){let m=null;return m=1===this.callType?this.participants[0]:(0,Mi.find)(this.participants,(m=>m.hasSourceId(3,g))),m?.id?this.logger.info(`ParticipantId: ${scrubMriOrOmit(m.id)} to SourceId: ${g}`):this.logger.warn(`No Participant found for SourceId: ${g}`),m}getDataChannelSourceId(){const g=(0,Mi.find)(this.endpoints.endpointDetails,(g=>null!==g&&g.participantId===this._participantId));if(!g)return this.logger.warn(`No participantLeg found for participantId: ${this._participantId}`),-1;if(!g.mediaStreams)return this.logger.warn(`ParticipantLeg ${this._participantId} does not have valid mediaStreams`),-1;const m=(0,Mi.find)(g.mediaStreams,(g=>3===mapMediaTypeStringToMediaType(g.type)));return m?m.sourceId:(this.logger.warn(`participantLeg ${this._participantId} has no data channel`),-1)}initializeMediaControlPlane(){this.mediaControlPlane=new Er(this.dataChannel,this.logger.createChild("MediaControlPlane"),this.mediaAgent.getConfigProvider().config.mediaControlPlaneConfig),this.mediaControlPlane.on("mpSendBandwidthChanged",(g=>{this.mediaSession?.processNotification("BandwithNotification",{bw:g});const m=this.mediaSession?.getExtensionsManager();m?.processNotification("BandwithNotification",{bw:g})})),this.mediaControlPlane.on("mpDshStatusChanged",(g=>{this.updateSignalingDSHMessageSubscription(!g),g&&this.mediaSession?.getDiagnostics()?.dshDiagnostics.setCurrentActiveStrategy("server")})),this.mediaControlPlane.on("onHandshakeTimeout",(()=>{this.isSignalingDSHFallbackEnabled()&&this.updateSignalingDSHMessageSubscription(!0)})),this.mediaControlPlane.on("mpDshChanged",(g=>{const m=this.mediaSession?.getExtensionsManager();m?.processNotification("McpDominantSpeakerInfo",{history:g})}))}initializeLiveStreamConfigProvider(){const g="MDN_MIDDLELANE_TEAMS",m="liveStream",f=this.ecsProvider.getEcsConfig(g,m),S=this.ecsProvider.getEcsConfig("ConfigIDs",g);this._liveStreamConfigProvider=new tt(f,null,S,this.logger.createChild("LiveStreamConfigProvider"))}isMediaSending(g){return this.mediaStateConfigurationHelper.isSending(g)}};na.instanceCount=0,__decorateClass([callOperation("Initialize",{type:"Sync",convertError:!0,idempotencyLevel:"NoOp"})],na.prototype,"init",1),__decorateClass([callOperation("StartVideo",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"startVideo",1),__decorateClass([callOperation("StopVideo",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"stopVideo",1),__decorateClass([callOperation("DumpVideoSourceImages")],na.prototype,"dumpVideoSourceImages",1),__decorateClass([__decorateParam(1,causeId)],na.prototype,"hold",1),__decorateClass([callOperation("Hold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],na.prototype,"holdWithRenegotiate",1),__decorateClass([callOperation("LocalHold",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],na.prototype,"localHold",1),__decorateClass([callOperation("Unhold",{waitFor:["Hold","LocalHold"],preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"unhold",1),__decorateClass([callOperation("UpdateEndpointMetadata"),__decorateParam(1,causeId)],na.prototype,"updateEndpointMetadata",1),__decorateClass([callOperation("SendDtmfTone",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],na.prototype,"sendDtmfTone",1),__decorateClass([callOperation("SetAudioUsage")],na.prototype,"setAudioUsageMode",1),__decorateClass([callOperation("SetAudioMidcallConfig")],na.prototype,"setAudioMidcallConfig",1),__decorateClass([callOperation("SetAudioMidcallConfigJon",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"setAudioMidcallConfigJson",1),__decorateClass([callOperation("SetParticipantSpatialAudioPositions",{waitFor:"_ElectronSlimcoreReady",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"setParticipantSpatialAudioPositions",1),__decorateClass([callOperation("BlindTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"callBlindTransfer",1),__decorateClass([callOperation("SafeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"callSafeTransfer",1),__decorateClass([callOperation("TransferToVoicemail",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"transferCallToVoicemail",1),__decorateClass([callOperation("ConsultativeTransfer",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"callConsultativeTransfer",1),__decorateClass([callOperation("ConsultativeTransferWithPickupCode",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],na.prototype,"consultativeTransferWithPickupCode",1),__decorateClass([callOperation("CallRedirect",{singular:!0,type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"callRedirect",1),__decorateClass([callOperation("ParkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"park",1),__decorateClass([callOperation("UnparkCall",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"unpark",1),__decorateClass([callOperation("getTechnicalInformationJson",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]})],na.prototype,"getTechnicalInformationJson",1),__decorateClass([callOperation("StartScreenSharing",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(3,causeId)],na.prototype,"startScreenSharing",1),__decorateClass([callOperation("StopScreenSharing",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,causeId)],na.prototype,"stopScreenSharing",1),__decorateClass([callOperation("StartDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"startDataChannel",1),__decorateClass([callOperation("StopDataChannel",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"stopDataChannel",1),__decorateClass([callOperation("ShareSystemSounds",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"shareSystemSound",1),__decorateClass([callOperation("Mute",{waitFor:"JoinPreheatedCall",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],na.prototype,"mute",1),__decorateClass([callOperation("Unmute",{waitFor:["JoinPreheatedCall"]}),__decorateParam(0,causeId)],na.prototype,"unmute",1),__decorateClass([callOperation("MuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],na.prototype,"muteSpeaker",1),__decorateClass([callOperation("UnmuteSpeaker",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId)],na.prototype,"unmuteSpeaker",1),__decorateClass([callOperation("MuteParticipants"),__decorateParam(2,causeId)],na.prototype,"muteParticipants",1),__decorateClass([callOperation("StartAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"startAudio",1),__decorateClass([callOperation("StopAudio",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"stopAudio",1),__decorateClass([callOperation("Assimilate"),__decorateParam(3,causeId)],na.prototype,"assimilate",1),__decorateClass([__decorateParam(2,causeId)],na.prototype,"merge",1),__decorateClass([callOperation("MergeParticipants"),__decorateParam(1,operationId),__decorateParam(3,causeId)],na.prototype,"mergeParticipants",1),__decorateClass([callOperation("MergeWithPickupCode"),__decorateParam(0,operationId),__decorateParam(2,causeId)],na.prototype,"mergeWithPickupCode",1),__decorateClass([callOperation("SetMaxVideoChannels")],na.prototype,"setMaxVideoChannels",1),__decorateClass([callOperation("StopCall"),__decorateParam(1,causeId),__decorateParam(3,reason)],na.prototype,"stop",1),__decorateClass([callOperation("PublishState"),__decorateParam(1,operationId)],na.prototype,"publishState",1),__decorateClass([callOperation("PublishState"),__decorateParam(1,operationId)],na.prototype,"publishStatesForEveryone",1),__decorateClass([callOperation("RemoveState"),__decorateParam(1,operationId)],na.prototype,"removeState",1),__decorateClass([callOperation("RemoveState"),__decorateParam(1,operationId)],na.prototype,"removeStatesForEveryone",1),__decorateClass([callOperation("UpdateMeetingSettings"),__decorateParam(1,operationId)],na.prototype,"updateMeetingSettings",1),__decorateClass([callOperation("UpdateMeetingGroups"),__decorateParam(0,operationId)],na.prototype,"updateMeetingGroups",1),__decorateClass([callOperation("UpdateMeetingLiveState"),__decorateParam(0,operationId)],na.prototype,"updateMeetingLiveState",1),__decorateClass([callOperation("UpdateMeetingStates"),__decorateParam(1,operationId)],na.prototype,"updateMeetingStates",1),__decorateClass([callOperation("UpdateParticipantInterpretationState"),__decorateParam(0,operationId)],na.prototype,"updateParticipantInterpretationState",1),__decorateClass([callOperation("UpdateParticipantsProperties")],na.prototype,"updateParticipantsProperties",1),__decorateClass([callOperation("JoinMeetingGroup"),__decorateParam(0,operationId)],na.prototype,"joinMeetingGroup",1),__decorateClass([callOperation("LeaveMeetingGroup"),__decorateParam(0,operationId)],na.prototype,"leaveMeetingGroup",1),__decorateClass([callOperation("SendMessages"),__decorateParam(0,operationId)],na.prototype,"sendMessages",1),__decorateClass([callOperation("UpdateMonitorSession"),__decorateParam(1,causeId)],na.prototype,"updateMonitorSession",1),__decorateClass([callOperation("UpdateMeetingRole")],na.prototype,"updateMeetingRoles",1),__decorateClass([callOperation("CreateContentSharingSession"),__decorateParam(4,causeId)],na.prototype,"createContentSharingSession",1),__decorateClass([callOperation("StopCallWithBeacon",{type:"Sync"}),__decorateParam(0,causeId)],na.prototype,"stopWithBeacon",1),__decorateClass([callOperation("Acknowledge",{type:"Chained",convertError:!0,idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,causeId)],na.prototype,"acknowledge",1),__decorateClass([callOperation("Accept",{type:"Chained",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(1,causeId)],na.prototype,"accept",1),__decorateClass([callOperation("Reject",{preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(0,causeId),__decorateParam(1,reason)],na.prototype,"reject",1),__decorateClass([callOperation("JoinCall",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,callStartOptions),__decorateParam(2,causeId)],na.prototype,"join",1),__decorateClass([callOperation("JoinPreheatedCall",{waitFor:"_CallStartOrJoinInitiated"})],na.prototype,"joinPreheatedCall",1),__decorateClass([callOperation("StartCall",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(0,callStartOptions),__decorateParam(1,causeId)],na.prototype,"start",1),__decorateClass([callOperation("StartCallToVoiceMail",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,causeId)],na.prototype,"startCallToVoicemail",1),__decorateClass([callOperation("Subscribe",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(2,causeId)],na.prototype,"joinCallWithoutCallModality",1),__decorateClass([callOperation("StartWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],na.prototype,"startWithMeetingData",1),__decorateClass([callOperation("JoinWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],na.prototype,"joinWithMeetingData",1),__decorateClass([callOperation("SubscribeWithMeetingData",{type:"Chained",idempotencyLevel:"Error"})],na.prototype,"subscribeWithMeetingData",1),__decorateClass([callOperation("StartCallWithNudge",{type:"Chained",idempotencyLevel:"Error"}),__decorateParam(1,callStartOptions),__decorateParam(2,causeId)],na.prototype,"startCallWithNudge",1),__decorateClass([callOperation("StartCallAndUnpark",{type:"Chained",idempotencyLevel:"Error",preconditionTags:["NOT_SUPPORTED_IN_STREAMING_MODE"]}),__decorateParam(2,callStartOptions),__decorateParam(3,causeId)],na.prototype,"startAndUnpark",1),__decorateClass([participantOperation("AdmitParticipant"),__decorateParam(0,operationId),__decorateParam(1,causeId)],na.prototype,"admitParticipant",1),__decorateClass([callOperation("Admit")],na.prototype,"admit",1),__decorateClass([participantOperation("CallMeBack"),__decorateParam(0,operationId),__decorateParam(2,causeId)],na.prototype,"callMeBack",1),__decorateClass([__decorateParam(0,operationId),__decorateParam(2,causeId)],na.prototype,"addParticipant",1),__decorateClass([participantOperation("AddParticipants"),__decorateParam(0,operationId),__decorateParam(2,causeId)],na.prototype,"addParticipants",1),__decorateClass([__decorateParam(0,operationId),__decorateParam(2,causeId)],na.prototype,"addParticipantsImpl",1),__decorateClass([participantOperation("NudgeParticipants"),__decorateParam(0,operationId),__decorateParam(3,causeId)],na.prototype,"nudgeParticipants",1),__decorateClass([participantOperation("RemoveParticipant"),__decorateParam(0,operationId),__decorateParam(1,causeId)],na.prototype,"removeParticipant",1),__decorateClass([callOperation("SearchParticipants"),__decorateParam(1,operationId),__decorateParam(1,causeId)],na.prototype,"searchParticipants",1),__decorateClass([callOperation("GetAllParticipants"),__decorateParam(1,operationId),__decorateParam(1,causeId)],na.prototype,"getAllParticipants",1),__decorateClass([callOperation("_PromotionToRealtime"),__decorateParam(1,causeId)],na.prototype,"promoteToRealtime",1),__decorateClass([__decorateParam(0,causeId)],na.prototype,"turnOffLocalVideoPreview",1),__decorateClass([callOperation("_StartPreviewVideo"),__decorateParam(0,causeId)],na.prototype,"turnOnLocalVideoPreview",1),__decorateClass([callOperation("_UpdateLocalMediaStatus",{type:"Chained"}),__decorateParam(0,causeId)],na.prototype,"updateMediaStatus",1),__decorateClass([__decorateParam(0,causeId)],na.prototype,"calculateIsSomeoneStreaming",1),__decorateClass([callOperation("_Reconnect")],na.prototype,"reconnect",1),__decorateClass([callOperation("AddGroupModality"),__decorateParam(1,causeId)],na.prototype,"addGroupModality",1),__decorateClass([callOperation("AddBroadcastModality")],na.prototype,"addBroadcastModality",1);var ra=na,sa=__toESM(ye()),aa=new RegExp("/callAgent/","i"),oa=class{constructor(g,m){this.signalingAgentProvider=g,this.callRegistry=m}handleMessage(g){if(!g.eventId){if(g.url.search(aa)>-1){const m=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(g);return"number"==typeof m?{isHandled:!0,resultCode:m}:{isHandled:!0,resultCode:m.resultCode,responseBody:m.responseBody,responseHeaders:m.responseHeaders}}return{isHandled:!1}}if(g.eventId in bi){this.callRegistry.logUploadNotification(g);const m=this.signalingAgentProvider.getSignalingAgent().handleIncomingNotification(g);return"number"==typeof m?{isHandled:!0,resultCode:m}:{isHandled:!0,resultCode:m.resultCode,responseBody:m.responseBody,responseHeaders:m.responseHeaders}}return{isHandled:!1}}},la=class{constructor(g,m,f){this.callRegistry=g,this.recentInvitations=[],this.logger=m.createChild("IncomingCallMessageHandler"),this.ecsProvider=f}handleMessage(g){const m=this.handleIncomingCall(g);return m?{isHandled:m,resultCode:200}:{isHandled:m}}handleIncomingCall(g){const m=generateCauseId(),f=this.logger.createFnLogger("handleIncomingCall",m);if(this.isProxiableNotification(g))return this.callRegistry.proxyPushNotification(g),!0;if(!this.isIncomingCallMessage(g))return!1;let S;try{if(g?.body?.gp&&!isStringBase64(g.body.gp))f.info("unencoded payload, skipping decoding."),S=g.body.gp;else{const m=decodeNotificationPayload(g);S=JSON.parse(m)}S.body=g.body}catch(g){return f.logFailure(`Error parsing notification payload: ${g}`),!1}const v=this.isCallTransferNotification(g)?this.buildTransferCallPayload(S):this.buildNGCCallPayload(S);if(!v)return!1;if(this.callRegistry.calls.some((g=>g.callId===v.convoCallId&&g.participantId===v.participantId)))return f.logFailure(`Duplicate call filtered because it was in the call registry, callId = ${v.convoCallId}, participantId = ${v.participantId}`),!1;const C=this.isCallReplacementNotification(g);if(f.log(`replacementCall=${C}`),!C&&this.recentInvitations.some((g=>g.convoCallId===v.convoCallId&&g.participantId===v.participantId)))return f.logFailure(`Duplicate call filtered because it was in the recent calls list, callId = ${v.convoCallId}, participantId = ${v.participantId}`),!1;5===this.recentInvitations.length&&this.recentInvitations.shift(),this.recentInvitations.push({convoCallId:v.convoCallId,participantId:v.participantId});let _=this.callRegistry.calls.find((g=>g.callId===v.convoCallId&&8===g.state));return _||(_=v.groupId?this.callRegistry.createCallWithGroupId(v.groupId,v.convoCallId,v.participantId,m):this.callRegistry.createCall(v.conversationId,v.convoCallId,v.participantId,void 0,m)),_.init({threadId:v.conversationId,messageId:v.messageId,mediaPeerType:2}),this.callRegistry.testEndpointMetadata?_.acknowledge(v,this.callRegistry.testEndpointMetadata,m):_.acknowledge(v,void 0,m),!0}isIncomingCallMessage(g){return Object.keys(Ti).some((m=>Ti[m]===g.eventId))?g.eventId!==Ti.INCOMING_TFL_TFW_CALL||this.ecsProvider?.getEcsConfig("SkypeCalling","enableTFWTFLOneToOneCall"):this.isCallTransferNotification(g)}isCallTransferNotification(g){return g.callNotification&&("transfer"===g.callNotification.callType||"replaces"===g.callNotification.callType)}isCallReplacementNotification(g){return g.callNotification&&"replaces"===g.callNotification.callType}isProxiableNotification(g){return Object.keys(Ii).some((m=>Ii[m]===g.eventId))}buildTransferCallPayload(g){const m={body:g.body,callerId:g.callNotification.from.id,groupId:null,conversationId:null,convoCallId:g.debugContent.callId,isMultiParty:g.conversationInvitation?.isMultiParty,fromMixer:g.callNotification.fromMixer,ngcCall:!0,participantId:g.callNotification.to.participantId,transferorId:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.id,transferorType:g.callNotification.transferor&&g.callNotification.transferor.transferorType,transferorDisplayName:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.displayName,callType:g.callNotification.callType,consultativeCallId:g.callNotification.consultativeCallId,messageId:null,callQueueInfo:g.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0};return this.logger.info("Incoming transfer paylod",m),m}buildNGCCallPayload(g){if(!g.callNotification)return this.logger.error("Missing callNotification in parsed incoming NGC call payload"),null;const m={groupId:g.groupContext?.id,conversationId:g.groupChat?.threadId,messageId:g.groupChat?.messageId,callerId:g.callNotification.from.id,isMultiParty:g.conversationInvitation.isMultiParty,fromMixer:g.callNotification.fromMixer,convoCallId:g.debugContent.callId,participantId:g.debugContent.participantId,ngcCall:!0,body:g.body,transferorId:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.id,transferorType:g.callNotification.transferor&&g.callNotification.transferor.transferorType,transferorDisplayName:g.callNotification.transferor&&g.callNotification.transferor.details&&g.callNotification.transferor.details.displayName,callType:g.callNotification.callType,callQueueInfo:g.callNotification.applicationContent,videoCall:void 0,launchTime:void 0,pushReceivedTime:void 0,registrationId:void 0,fromApplicationType:g.callNotification.fromApplicationType};return this.logger.info("Incoming NGC payload",m),m}},ca=class extends Ve{constructor(g,m,f,S,v,C=null,_,E){super(),this.trouterService=g,this.signalingAgentProvider=m,this.mediaAgent=f,this.callingLogger=S,this.telemetryLoggers=v,this.ecsProvider=C,this.skypeIdentity=_,this.oneDsTelemetryLoggers=E,this.calls=[],this.isDisposing=!1,this._disposedPromise=defer(),this.testEndpointMetadata=null,this._disconnectingPromiseDefers=new Map,this.addCallSubscriptionToMap=(g,m)=>{this.callSubscriptionsMap.set(g,(this.callSubscriptionsMap.get(g)||[]).concat(m))},this.clearCallSubscription=()=>{this.callSubscriptionsMap.forEach((g=>{g.forEach((g=>{g.dispose()}))})),this.callSubscriptionsMap.clear()},this.skypeIdentity&&(this.identity=this.skypeIdentity.id),this.callSubscriptionsMap=new Map,this.logger=new Je(this.callingLogger).createChild(`CallRegistry/${generateCauseId()}`),this.registryTelemetry=new si(this.logger,(new Date).getTime()),this._callOperationHandler||(this._callOperationHandler=new Si(this.logger,this.registryTelemetry,{},(g=>{this._publishTelemetry(g)})));const T=this.mediaAgent.getConfig().disconnectOnPageHide;this._windowUninitEvent=T?"pagehide":"beforeunload",this.signalingAgentProvider.getSignalingAgent().setTokenRequiredCallBack(this.onTokenRequired.bind(this)),this._createNewCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","createNewCallInDisconnectedState"),this._invokeDeleteCallInDisconnectedState=this.ecsProvider.getEcsConfig("SkypeCalling","invokeDeleteCallInDisconnectedState")}init(g,m,f=generateCauseId()){return this.logger.createFnLogger("init",f).info("init"),this.login(g)}uninit(){return this.logout()}login(g,m=generateCauseId()){return this.logger.createFnLogger("login",m).info("login"),this.skypeIdentity=g,this.identity=this.skypeIdentity.id,this.initialize(m)}initialize(g=generateCauseId(),m){const f=this.logger.createFnLogger("initialize",g),S=m&&m.applicationType?m.applicationType:"null";f.info(`initialize with applicationType: ${S}`),this.accountConfiguration=m,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(m),this.incomingCallMessageHandler=new la(this,this.logger,this.ecsProvider),this.trouterService.registerMessageHandler(new oa(this.signalingAgentProvider,this)),this.trouterService.registerMessageHandler(this.incomingCallMessageHandler),f.info("Call registry init, endpointMetadata",this.testEndpointMetadata);try{this.windowUninitListener=()=>{this._disregardWindowUninitEvents||this.stopCallsWithBeacon()},window.addEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(g){f.logFailure(`Not adding beforeunload listener: ${g}`)}return Promise.resolve(void 0)}logout(g=generateCauseId()){const m=this.logger.createFnLogger("logout",g);m.info("logout");try{this.trouterService.clearMessageHandlers(),window.removeEventListener(this._windowUninitEvent,this.windowUninitListener)}catch(g){m.info(`Not removing beforeunload listener: ${g}`)}return Promise.resolve(void 0)}_publishTelemetry(g){if(!this.telemetryLoggers?.signaling)return;this.registryTelemetry.setSkypeId(this.identity);try{const g=this.signalingAgentProvider.getSignalingAgent();this.registryTelemetry.setEndpointId(g.endpointId)}catch(g){this.logger.warn("Could not get end point ID from signaling agent for call registry telemetry.")}this.accountConfiguration&&(this.registryTelemetry.setAcsResourceId(this.accountConfiguration.acsResourceId),this.registryTelemetry.setApplicationType(this.accountConfiguration.applicationType),this.registryTelemetry.setPartition(this.accountConfiguration.partition),this.registryTelemetry.setRegion(this.accountConfiguration.region),this.registryTelemetry.setRing(this.accountConfiguration.ring),this.registryTelemetry.setTenantId(this.accountConfiguration.tenantId),this.registryTelemetry.setUserHexCID(this.accountConfiguration.userHexCID),this.registryTelemetry.setClientType(this.accountConfiguration.clientType));const m=Qt.REGISTRY_WEB;this.telemetryLoggers.signaling.sendEvent({eventName:m,props:this.registryTelemetry.getEvent(null,g)})}async dispose(g=generateCauseId()){const m=this.logger.createFnLogger("dispose",g);if(m.info("dispose"),this.isDisposing)return m.warn("call registry is already in disposing stage!"),this._disposedPromise.promise;this.isDisposing=!0;const always=()=>{this.calls=[],this.event("disposed").raise(),super.dispose(),this._disposedPromise.resolve()},f=this.calls.map((g=>g.stop())),logout=()=>this.logout();return this.clearCallSubscription(),this.signalingAgentProvider.getSignalingAgent().resetAuthTokenManager(),Promise.all(f).then(logout,logout).then(always,always),this._disposedPromise.promise}get disposePromise(){return this._disposedPromise.promise}createCallAsync(g){const m=this.logger.createFnLogger("createCallAsync",g.causeId),f=`callId:${g.callId}, localParticipantId: ${scrubMriOrOmit(g.localParticipantId)},\n            causeId:${g.causeId}, type:${g.type}, `;switch(g.type){case"MeetingData":f.concat(`meetingUrl:${!!g.meetingData?.meetingUrl}, meetingCode:${!!g.meetingData?.meetingCode}`);break;case"GroupId":f.concat(`groupId:${scrubMriOrOmit(g.groupId)}`);break;case"ThreadId":f.concat(`threadId:${getLoggableThreadId(g.threadId)}, messageId:${g.messageId}`);break;default:throw new Error("Invalid type in passing parameter.")}m.info(f);const S=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers,v=this._getCurrentCall(g,m);if(v){if(6===v.state){const g=defer();return this._disconnectingPromiseDefers.set(v.callId,g),g.promise}return Promise.resolve(v)}return Promise.resolve(this._createNewCall(g,S,m))}createCallWithMeetingData(g,m,f,S){const v=this.logger.createFnLogger("createCallWithMeetingData",S);if(v.info(`meetingData:${safeJsonStringify(g)}, callId:${m}, localParticipantId: ${scrubMriOrOmit(f)}`),!g)return v.info("meetingData cannot be null"),null;const C=this._generateCreateCallOptions(S,m,f,null,null,null,g),_=this._getCurrentCall(C,v);if(_)return _;const E=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(C,E,v)}createCall(g,m,f,S,v=generateCauseId()){return this._createCall(g,m,f,S,v)}createCallWithGroupId(g,m,f,S){return this._createCall("",m,f,void 0,S,g)}_createNewCall(g,m,f){let S=null,v=null,C=null,_=null;switch(g.type){case"MeetingData":_=g.meetingData;break;case"GroupId":S=g.groupId;break;case"ThreadId":v=g.threadId,C=g.messageId}const E=new ra(this.signalingAgentProvider.getSignalingAgent(),this.mediaAgent,new Je(this.callingLogger),m,this.skypeIdentity,S,v,g.callId,g.localParticipantId,this.ecsProvider,this.trouterService,this.accountConfiguration,C,this.locationInfoContent,this.networkInfoContent,_,this.areaContent);E.on("callStateChanged",(async()=>{if(7===E.state&&this._createNewCallInDisconnectedState){const S=this._disconnectingPromiseDefers.get(E.callId);S&&(this._disconnectingPromiseDefers.delete(E.callId),S.resolve(this._createNewCall(g,m,f))),this._invokeDeleteCallInDisconnectedState&&setTimeout((()=>{this.deleteCall(E)}),0)}})),this.calls.push(E),this.event("callAdded").raise(E),this.raiseChanged(),f.info(`creating new call, ${E.callId}, ${safeJsonStringify(_)}, ${safeJsonStringify(E.meetingData)}`);const T=E.on("replacementRequested",(g=>{this.incomingCallMessageHandler.handleMessage(g)}));return this.addCallSubscriptionToMap(E,T),E}_getCurrentCall(g,m){let f=null;return"MeetingData"===g.type&&(f=this.getCallUsingMeetingData(g.meetingData,g.callId,g.localParticipantId,void 0,void 0,g.causeId),f)?(m.info("Call Registry has an entry for this call's meeting data"),f):(f=this.getCall(g.callId,g.localParticipantId,g.causeId),f?(m.info("Call Registry has an entry for this callId, participantId"),f):"ThreadId"===g.type&&(f=this.getCallUsingThreadIdMessageId(g.threadId,g.callId,g.messageId,g.causeId),f)?(m.info("Call Registry has an entry for this threadId, messageId"),f):"GroupId"===g.type&&(f=this.calls.find((m=>m.groupId===g.groupId)),f)?(m.info("Call Registry has an entry for this groupId"),f):f)}_generateCreateCallOptions(g,m,f,S,v,C,_){let E=null;return E=S?{type:"GroupId",callId:m,localParticipantId:f,causeId:g,groupId:S}:v?{type:"ThreadId",callId:m,localParticipantId:f,causeId:g,threadId:v,messageId:C}:{type:"MeetingData",callId:m,localParticipantId:f,causeId:g,meetingData:_},E}_createCall(g,m,f,S,v=generateCauseId(),C){const _=this.logger.createFnLogger("createCall",v);_.info(`threadId:${getLoggableThreadId(g)}, callId:${m}, localParticipantId: ${scrubMriOrOmit(f)}, messageId:${S}, groupId:${scrubMriOrOmit(C)}`);const E=this._generateCreateCallOptions(v,m,f,C,g,S,null),T=this._getCurrentCall(E,_);if(T)return T;const I=this.mediaAgent?.getConfig().useOneDsLogger?this.oneDsTelemetryLoggers:this.telemetryLoggers;return this._createNewCall(E,I,_)}getCall(g,m,f=generateCauseId()){const S=this.logger.createFnLogger(`getCall[callId=${g}][participantId=${scrubMriOrOmit(m)}]`,f);if(!g)return S.logFailure("callId is undefined"),null;const v=this.calls.find((m=>m.callId===g));return v&&S.info("Call Registry already has an entry for this call"),v}deleteCall(g){const m=this.calls.indexOf(g);return-1!==m&&(this.callSubscriptionsMap.get(g).forEach((g=>{g.dispose()})),this.callSubscriptionsMap.delete(g),this.calls.splice(m,1),this.event("callRemoved").raise(g),this.raiseChanged(),!0)}async setConfiguration(g){this.accountConfiguration=g,this.accountConfiguration&&this.event("accountConfigurationReceived").raise(this.accountConfiguration),this.signalingAgentProvider.getSignalingAgent().update(g)}updateDisplayName(g){return this.skypeIdentity.displayName=g,this.calls.forEach((m=>{m.updateDisplayName(g)})),Promise.resolve()}fireIntent(g,m){return Promise.resolve()}getCallState(g,m){return Promise.reject("Not implemented")}getSetup(){}getEcsConfig(){return Promise.reject()}updateSkypeToken(g){this.logger.debug("CallRegistry.updateSkypeToken() called but not supported in the current set up.")}updateToken(g,m,f,S,v){this.logger.info(`[updateToken], causeId = ${S} tokenType = ${m.tokenType}, factorsJson = ${g}, tokenExpiredTime = ${v}`);try{return this.signalingAgentProvider.getSignalingAgent().updateToken(g,m,f,S,v),Promise.resolve(getSuccessTransactionEnd())}catch(m){return this.logger.info(`Failed to update token with ${g}, error is ${m}`),Promise.reject(getRejectTransactionEnd(`Failed to update token with ${g}, error is ${m}`))}}onTokenRequired(g){const{requestMetadataJson:m,factorsJson:f,tokenType:S,invalidToken:v}=g;this.logger.info(`[onTokenRequired], tokenType ${S}, factorsJson ${f}, requestMetadataJson ${JSON.stringify(m)}`),this.event("tokenRequired").raise(f,S,m,v)}debugInformation(g){const m=g?`CallInformation\n * CallId=${g.callId}`:void 0;return Promise.resolve(m)}setLocationInfo(g,m,f=generateCauseId()){if(this.logger.info(`setLocationInfo, ${f}, infoType:${g}, contentJson ${m?"is set":"is undefined"}`),m)try{JSON.parse(m)}catch(g){return Promise.reject(`invalid contentJson: ${g}`)}return this.locationInfoType=g,1===this.locationInfoType&&(this.locationInfoContent=m,this.logger.info(`locationInfoContent set to ${this.locationInfoContent}`)),2===this.locationInfoType&&(this.networkInfoContent=m,this.logger.info(`networkInfoContent set to ${this.networkInfoContent}`)),3===this.locationInfoType&&(this.areaContent=m,this.logger.info(`areaContent set to ${this.areaContent}`)),this.event("locationInfoSet").raise(g,m),Promise.resolve()}createDownloader(){return null}extendBrbFeedback(g,m){return Promise.reject("Not implemented")}proxyPushNotification(g){this.logger.info(`Proxying push notification with event ID ${g.eventId}`);try{const m={eventId:g.eventId,payload:decodeNotificationPayload(g)};this.event("proxiedPushNotification").raise(m)}catch(g){this.logger.error(`Error proxying push notification: ${g}`)}}logUploadNotification(g){this.logger.info(`Log upload notification with event ID ${g.eventId}`);try{const m={eventId:g.eventId,payload:decodeNotificationPayload(g)};this.event("logUploadNotification").raise(m)}catch(g){this.logger.error(`Error raising log upload notification: ${g}`)}}sendPush(g,m,f,S){const v={id:g},C=[];return m.forEach((g=>{C.push({id:g})})),this.signalingAgentProvider.getSignalingAgent().sendPushAsync(v,C,f,S)}enableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!1}disableWindowUninitEventHandler(){this._disregardWindowUninitEvents=!0}getCallUsingThreadIdMessageId(g,m,f,S){this.logger.info(`[getCallUsingThreadIdMessageId][${S}] threadID: ${getLoggableThreadId(g)} callId: ${m} messageId: ${f}`);let v=null;return g&&(v=this.calls.find((S=>S.threadId===g&&(m&&S.callId===m||f&&S.messageId===f))),v)?(this.logger.logFailure(`[getCallUsingThreadIdMessageId][${S}]Call Registry already has an entry for threadId: ${getLoggableThreadId(v.threadId)}, callId: ${v.callId}, messageId: ${v.messageId}`),v):v}getCallUsingMeetingData(g,m,f,S,v,C=generateCauseId()){const _=this.logger.createFnLogger("getCallUsingMeetingData",C);if(_.info(`[callId=${m}][participantId=${scrubMriOrOmit(f)}] meetingData: ${safeJsonStringify(g)} threadId: ${getLoggableThreadId(S)} messageId: ${v}`),!m)return _.logFailure("callId is undefined"),null;let E;for(const f of this.calls){if(f.callId===m){E=f;break}if(compareMeetingData(f.meetingData,g,C,this.logger)){E=f;break}}return E}stopCallsWithBeacon(){for(const g of this.calls)g.stopWithBeacon()}};function decodeNotificationPayload(g){if(g?.body){if(g.body.gp)return atob(g.body.gp);if(g.body.cp)return sa.inflate(atob(g.body.cp),{to:"string"})}return"{}"}__decorateClass([callOperation("Initialize",{enableInstantTelemetry:!0})],ca.prototype,"initialize",1),__decorateClass([callOperation("Logout",{enableInstantTelemetry:!0})],ca.prototype,"logout",1);var da=R,ha=class{constructor(g){this.deviceManager=g}get childDeviceManagers(){return this.deviceManager.getRegisteredDevices()}createPreview(g,m,f,S){return this.executeOnVirtualDeviceManager((S=>f(g,m,S)),S)}getRawDeviceMediaStream(g,m,f){return this.executeOnVirtualDeviceManager((f=>f.getRawDeviceMediaStream(g,m)),f)}setDeviceEffectsAsync(g,m){return this.executeOnVirtualDeviceManager((g=>g.setVideoEffects(m)),g)}setRawMediaStream(g,m,f){this.executeOnVirtualDeviceManager((f=>f.setRawMediaStream(g,m)),f)}unsetRawMediaStream(g,m){this.executeOnVirtualDeviceManager((m=>m.unsetRawMediaStream(g)),m)}getVirtualDevice(g){return this.childDeviceManagers.find((m=>m.id===g))}executeOnVirtualDeviceManager(g,m){return this.getVirtualDevice(m).getDeviceManagers().map((m=>g(m)))}},ua="default_output_device",ga=class _DeviceManagerAdapter extends Ve{constructor(g){super(),this._deviceManager=g,this.virtualDeviceAdapter=new ha(this._deviceManager),g.on("onDevicesChanged",(g=>{const m=this._deviceManager.getDeviceDescriptions(g),f=this._mapDevices(m);this._raiseDevicesChanged(f)})),g.on("onSelectedDevicesChanged",(g=>this._raiseDevicesChanged())),g.on("onPermissionStateChanged",(()=>this.event("onPermissionStateChanged").raise())),g.on("onVideoEffectsEvent",((g,m)=>this.event("videoEffectsEvent").raise(g,m))),g.on("onVideoEffectApplied",(()=>this.event("videoEffectApplied").raise()))}get isAudioOutputSelectionSupported(){return this._deviceManager.isAudioOutputSelectionSupported}getPermissionState(g){return"camera"===g?this.getPermissionStateHelper(this._deviceManager.getPermissionState("camera")):"microphone"===g?this.getPermissionStateHelper(this._deviceManager.getPermissionState("microphone")):"unknown"}askDevicePermission(g){return this._deviceManager.askDevicePermission?this._deviceManager.askDevicePermission(g):Promise.resolve({audio:!0,video:!0})}enumerateDevicesAsync(){return this._deviceManager.enumerateDevicesAsync().then((g=>this._mapDevices(g)))}getPreferredCamera(){throw new Error("Not implemented")}selectDevices(g){if(Object.keys(g).some((g=>this.isVirtualDevice(g))))throw new Error("Virtual Device selection on DM is not supported");const m=(0,da.assign)({},this._deviceManager.getSelectedDevices(),g);this._deviceManager.selectDevices(m)}getSelectedDevices(){return this._deviceManager.getSelectedDevices()}getDeviceNameAsync(g){return this._deviceManager.getDeviceNameAsync(g)}getSpeakerDeviceDomIdAsync(g,m){return this._deviceManager.getSpeakerDeviceDomIdAsync(g)}async setDeviceEffectsAsync(g,m){if(!this.isVirtualDevice(g))return this._deviceManager.setVideoEffects(m);Promise.all(this.virtualDeviceAdapter.setDeviceEffectsAsync(g,m))}getDeviceEffectsCapabilityAsync(g,m){return this._deviceManager.effectsManager.getEffectsCapability("Video")}setBackgroundImageAsync(g,m,f){return this._deviceManager.effectsManager.configure("Video",{imagePath:m,headers:f})}getImagePropertyAsync(g){return Promise.reject(new Error("Not implemented"))}getMicrophoneGeometryArrayInfoAsync(g){return Promise.reject(new Error("Not implemented"))}transformImageAsync(g,m,f,S){return Promise.reject(new Error("Not implemented"))}setAudioProcessingFlags(g){return this._deviceManager.setAudioProcessingFlags(g)}sendMessageDeviceVideoEffectsAsync(g,m){return Promise.reject(new Error("Not implemented"))}sendMessageDeviceVideoExtensibilityAsync(g,m){return Promise.reject(new Error("Not implemented"))}setVideoCaptureConfigAsync(g,m){return Promise.reject(new Error("Not implemented"))}captureVideoFrameWithoutEffectsAsync(g,m,f){return Promise.reject(new Error("Not implemented"))}getSpeakerVolume(){return Promise.reject(new Error("Not implemented"))}getSpeakerSystemVolume(){return Promise.reject(new Error("Not implemented"))}setSpeakerVolume(g){return Promise.reject(new Error("Not implemented"))}setSpeakerSystemVolume(g){return Promise.reject(new Error("Not implemented"))}unmuteMicrophone(){return Promise.reject(new Error("Not implemented"))}unmuteSpeaker(){return Promise.reject(new Error("Not implemented"))}getNrgLevelsForDeviceTuner(g){return Promise.reject(new Error("Not implemented"))}setAudioEffectsAsync(g,m){return this._deviceManager.setAudioEffects(m)}getAudioFeatureCapability(g){return this._deviceManager.effectsManager.getEffectsCapability("Audio")}getMicrophoneVolume(){return Promise.reject(new Error("Not implemented"))}setMicrophoneVolume(g){return Promise.reject(new Error("Not implemented"))}setDeviceTelemetryData(g,m,f,S=0){return Promise.reject(new Error("Not implemented"))}getSourceFormats(g){return Promise.reject(new Error("Not implemented"))}enableShellSharing(){return Promise.reject(new Error("Not implemented"))}disableShellSharing(){return Promise.reject(new Error("Not implemeted"))}enableParticipantCameras(){return Promise.reject(new Error("Not implemeted"))}async createPreview(g,m,f){return"camera"===m.kind&&this.isVirtualDevice(m.device)?this.virtualDeviceAdapter.createPreview(g,f,this.getRenderer,m.device)[0]:"camera"===m.kind&&(0,da.isUndefined)(m.device)?this.createPreviewRenderer(g,f):Promise.reject(new Error("Not yet supported"))}async createPreviewRenderer(g,m){return this.getRenderer(g,m,this._deviceManager)}createScreenSharingPreviewRenderer(g,m){return Promise.reject(new Error("Not yet supported"))}getRawDeviceMediaStream(g,m,f){const S=getAgentMediaType(g);return this.isVirtualDevice(f)?this.virtualDeviceAdapter.getRawDeviceMediaStream(S,m,f)[0]:this._deviceManager.getRawDeviceMediaStream(S,m)}setRawMediaStream(g,m,f){const S=getAgentMediaType(m);return this.isVirtualDevice(f)?this.virtualDeviceAdapter.setRawMediaStream(g,S,f):this._deviceManager.setRawMediaStream(g,S)}unsetRawMediaStream(g,m){const f=getAgentMediaType(g);return this.isVirtualDevice(m)?this.virtualDeviceAdapter.unsetRawMediaStream(f,m):this._deviceManager.unsetRawMediaStream(f)}createAudioRenderer(){return this._deviceManager.createAudioRenderer()}startAudioLoopbackDevice(g){return Promise.reject(new Error("Not implemented"))}async dispose(g){return this._deviceManager.dispose(g)}async registerCompositeVideoDevice(g,m,f){return this._deviceManager.registerVirtualDevice(g,m,f)}async unregisterCompositeVideoDevice(g){return this._deviceManager.unregisterVirtualDevice(g)}async createAudioPlayer(){return Promise.reject(new Error("Not implemented"))}_raiseDevicesChanged(g){(g?Promise.resolve(g):this.enumerateDevicesAsync()).then((g=>{this.raiseChanged(),this.event("devicesChanged").raise(g)}))}getPermissionStateHelper(g){switch(g){case"granted":return"granted";case"denied":return"denied";case"prompt":return"prompt";default:return"unknown"}}_mapDevices(g){return g?.map((g=>this._mapDeviceDesc(g)))}_mapDeviceDesc(g){const m=_DeviceManagerAdapter._mapDeviceType(g.kind);if(6===m){return{id:g.id,label:g.label,kind:m,position:0,defaultVideoId:g.id,devicesIds:[]}}if(1===m){return{id:g.id,browserId:g.browserId,label:g.label,kind:m,position:_DeviceManagerAdapter._mapCameraPosition(g.position)}}if(4===m){return{id:null,browserId:null,label:g.label,kind:m,formFactor:g.formFactor,isPcInternalDevice:g.isPcInternalDevice,microphoneId:g.microphoneId,speakerId:g.speakerId}}return{id:g.id,browserId:g.browserId===ua?"default":g.browserId,label:g.label,kind:m,isSystemDefault:!!g.isSystemDefault}}static _mapDeviceType(g){switch(g){case"camera":return 1;case"microphone":return 2;case"speaker":return 3;case"compositeAudio":return 4;case"virtualDevice":return 6;default:throw new Error(`Invalid device type '${g}'`)}}static _mapCameraPosition(g){switch(g){case"front":return 1;case"back":return 2;case"external":return 3;default:return 0}}isVirtualDevice(g){return g&&this._deviceManager.getRegisteredDevices().some((m=>m.id===g))}async getRenderer(g,m,f){const S=new Vr(g,f);try{await S.startVideoAsync(),m&&(S.setScalingMode(m.scalingMode),S.setVideoMirroring(!m.ignoreMirroring))}catch(g){throw S.dispose(),g}return S}},pa=P,ma=P,fa=class extends ma.AbstractLogAppender{constructor(g){super(new ma.StandardLogFormatter(ma.SLF_Flags.Component)),this._logger=g}log(g,m,f,S){if(!this._logger)return;const v=g.level<=ma.LogLevel.Debug4?this._logger.debug:g.level<=ma.LogLevel.Debug2?this._logger.log:g.level<=ma.LogLevel.Debug1?this._logger.info:g.level<=ma.LogLevel.Warning?this._logger.warn:this._logger.error;v&&v.apply(this._logger,[this.formatter().format(g,m,f,S)])}},Sa=P,va=__toESM(be()),ya=["CorrelationId","agent_environment_id","UserInfo_TenantId","participant_id","endpoint_id","mediaLegId","metrics_ConfigIds","ts_calling_version","uiVersion"],Ca={video:[...ya,"Extensions_WebRTCStats_ssrc_video_recv_framesDecoded","Extensions_WebRTCStats_ssrc_video_recv_packetsReceived","Extensions_WebRTCStats_ssrc_video_recv_ssrc","Extensions_WebRTCStats_ssrc_video_recv_bytesReceived","Extensions_WebRTCStats_ssrc_video_recv_googFrameRateDecoded","Extensions_Video_SubscriptionEvents","Extensions_Video_recv_ResolutionDurations","Extensions_Video_recv_StreamsMax","Extensions_Video_recv_frameRateAvg","Extensions_Video_recv_DurationSeconds","Extensions_Video_recv_FreezeHistogram","Extensions_Video_recv_FreezeTimestamps","Extensions_WebRTCStats_ssrc_video_recv_keyFramesDecoded","Extensions_Video_recv_TotalFreezeDurationMs","Extensions_Video_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"],sharing:[...ya,"Extensions_WebRTCStats_ssrc_sharing_recv_framesDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_packetsReceived","Extensions_WebRTCStats_ssrc_sharing_recv_ssrc","Extensions_WebRTCStats_ssrc_sharing_recv_bytesReceived","Extensions_WebRTCStats_ssrc_sharing_recv_googFrameRateDecoded","Extensions_WebRTCStats_ssrc_sharing_recv_keyFramesDecoded","Extensions_Sharing_SubscriptionEvents","Extensions_Sharing_recv_ResolutionDurations","Extensions_Sharing_recv_StreamsMax","Extensions_Sharing_recv_frameRateAvg","Extensions_Sharing_recv_DurationSeconds","Extensions_Sharing_recv_FreezeHistogram","Extensions_Sharing_recv_FreezeTimestamps","Extensions_Sharing_recv_TotalFreezeDurationMs","Extensions_Sharing_recv_packetsLostRateMax","metrics_ReconnectAttempts","metrics_ReconnectConnectedCount","metrics_RetargetCompletedCount","metrics_UFDs","Payload"]},_a=class extends Ve{constructor(){super(...arguments),this.stabilizationTimeInAvg=2e4}send(g){g&&setTimeout((()=>{this.event("sendMidCallTelemetry").raise(Ca[g])}),this.stabilizationTimeInAvg)}},Ea=class extends Ve{constructor(g,m){super(),this._telemetryService=g,this._ecsProvider=m,this._ecsProvider.on("OnECSChanged",(()=>Sa.RootToolsManager.OnEcsChange()))}fetchEcsConfig(g,m){return va.Resolved().then((()=>this._ecsProvider.getEcsConfig(g,m)))}sendTelemetry(g,m){this._telemetryService.getGenericTelemetryLogger&&g?this._telemetryService.getGenericTelemetryLogger(g).sendEvent({eventName:"rt_log",props:m}):this._telemetryService.sendEvents([{eventName:"rt_log",props:m}])}sendMidCallTelemetry(g){Object.keys(Ca).includes(g)&&this.event("onMidCallTelemetry").raise(g)}};function initLogger(g,m,f){if(!pa.RootToolsManager.isDelegateSet()){const S=new Ea(g.telemetryService,m);if(pa.RootToolsManager.setDelegate(S),S.on("onMidCallTelemetry",(g=>f.send(g))),g.logger){const m=new fa(g.logger);pa.LogFactory.instance().addAppender(m)}}g.logger=new De("JS.TsCalling.Pluginless",!0),g.mediaAgentFactoryConfig.logger=new De("JS.TsCalling.MediaAgentUnsafe",!1),g.mediaAgentFactoryConfig.safeLogger=new De("JS.TsCalling.MediaAgent",!0),g.signalingAgentConfig.logger=new De("JS.TsCalling.SignalingAgent",!0)}var Ta=R,Ia=class _NoopLogger{constructor(g){this._prefix=g,this._children=[],this._useConsoleLogger=!1,this.createChild=(g,m)=>{const f="function"==typeof g?"":g,S=new _NoopLogger((this._prefix||"")+f);return this._children.push(S),this._useConsoleLogger&&S.useConsoleLogger(),S},this.createFnLogger=(g,m,...f)=>{const S=`[${m}][${g}]`,v=new _NoopLogger((this._prefix||"")+S);return this._children.push(v),this._useConsoleLogger&&v.useConsoleLogger(),v}}logInfo(){}logFailure(){}logSuccess(){}log(...g){}debug(...g){}info(...g){}warn(...g){}error(...g){}useConsoleLogger(){this._useConsoleLogger=!0;const logWithConsole=(...g)=>{console.info(this._prefix||"",...g)};this.log=logWithConsole,this.debug=logWithConsole,this.info=logWithConsole,this.warn=logWithConsole,this.error=logWithConsole,(0,Ta.each)(this._children,(g=>g.useConsoleLogger()))}},ba=class{constructor(g){this.configProvider=g,this.window=Ws.window,this.updateCapabilityOverrides(),this.configProviderSub=g.on("configUpdated",(()=>this.updateCapabilityOverrides()))}get audio(){return this.getCapability("audio")}get video(){return this.getCapability("video")}get screensharing(){return this.getCapability("screensharing")}get retargeting(){return this.getCapability("retargeting")}dispose(){this.configProviderSub&&this.configProviderSub.dispose()}updateCapabilityOverrides(){let g;this.configProvider.config.capabilities&&(g=this.configProvider.config.capabilities),this.overrides=g||{}}hasMediaCapture(){return!!this.window.navigator.getUserMedia}getCapability(g){return void 0!==this.overrides[g]?!!this.overrides[g]:this.hasMediaCapture()&&this.hasWebRtc()}hasWebRtc(){return void 0!==this.window.RTCPeerConnection}},Aa=class _UFDManager extends Be{constructor(g,m){super(g),this.logger=g,this.configProvider=m,this.eventStates=new Map,this.swMuted=!1,this.logger.safe.info("Initialized")}signalEvent(g,m,f="Audio",S=!0,v=generateCauseId(),C,_){const E={type:g,value:m,isLocalSource:S,mediaType:f,deviceManagerId:C,diagnosticData:_},T=this.getEventKey(E),I=this.eventStates.get(T);(!I||I.value!==m||this.configProvider.config.alwaysRaiseBadDeviceEvents&&"Good"!==m)&&(I||"Good"!==m)&&(this.eventStates.set(T,E),this.shouldRaiseEvent(E,I)&&(this.logger.safe.info(`[${v}] Raising UFD ${g} for ${f}: ${m}`),this.event("onQualityChanged").raise(E)))}signalDeviceEvent(g,m,f,S){const v=_UFDManager.getQualityEventType(g,f,this.configProvider);v?this.signalEvent(v,m,f,void 0,generateCauseId(),S):this.logger.warn(`Unknown device quality event type: ${g}`)}raisePendingWhitelistingUFD(){this.lastWhitelistingUFD&&(this.logger.safe.debug(`Raising whitelisting UFD ${this.lastWhitelistingUFD.type}: ${this.lastWhitelistingUFD.value}`),this.event("onQualityChanged").raise(this.lastWhitelistingUFD),this.cancelPendingWhitelistingUFD())}cancelPendingWhitelistingUFD(){if(this.lastWhitelistingUFD){const g=this.getEventKey(this.lastWhitelistingUFD);this.eventStates.delete(g)}this.lastWhitelistingUFD=void 0}setSwMute(g){if(this.swMuted=g,g){const g=this.eventStates.get(this.getEventKey({type:"DeviceSpeakWhileMuted",mediaType:"Audio"}));g&&"Good"!==g.value&&this.event("onQualityChanged").raise(g)}}applyCurrentState(g){this.cancelPendingWhitelistingUFD();let m=0;for(const f of this.eventStates.values())"Good"!==f.value&&(g(f),m++);m>0&&this.logger.safe.info(`Applied ${m} UFDs`)}reset(){this.logger.safe.info("Resetting UFD states");for(const[g,m]of this.eventStates.entries())_UFDManager.persistent.has(m.type)||this.eventStates.delete(g);this.lastWhitelistingUFD=void 0,this.swMuted=!1}getEventKey(g){return`${g.type}:${g.mediaType}`}shouldRaiseEvent(g,m){return"NetworkRelaysNotReachable"===g.type?(this.lastWhitelistingUFD=g,!1):!!("DeviceSpeakWhileMuted"!==g.type||this.swMuted||"Good"===g.value&&"Good"!==m?.value)&&(!("NetworkRecvQuality"===g.type&&!this.configProvider.config.webrtcStatNetworkDetectionEnabled)&&!(this.configProvider.config.alwaysRaiseBadDeviceEvents&&!_UFDManager.deviceQualityEvents.has(g.type)&&g.value===m?.value))}static getQualityEventType(g,m,f){switch(g){case 0:return"Audio"===m?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartFailed";case 1:return"Audio"===m?"DeviceCaptureNotFunctioning":"VideoCapturerDeviceStartTimedOut";case 2:return"DeviceCaptureMute";case 3:switch(m){case"ScreenShare":return"ScreenshareRecordingDisabled";case"Audio":return f.config.enableSignalingAudioPermissionDeniedUFD?"AudioCapturePermissionDenied":"DeviceCaptureNotMuteButSilent";case"Video":return"VideoCapturePermissionDenied";default:return}default:return}}};Aa.persistent=new Set(["ZeroCaptureDevicesEnumerated","ZeroRenderDevicesEnumerated"]),Aa.deviceQualityEvents=new Set(["DeviceCaptureNotFunctioning","VideoCapturerDeviceStartFailed","DeviceCaptureNotFunctioning","VideoCapturerDeviceStartTimedOut","DeviceCaptureMute","ScreenshareRecordingDisabled","DeviceCaptureNotMuteButSilent","VideoCapturePermissionDenied"]);var Pa=Aa,Ra=R,wa=R,Ma=R,Da={maxOutgoingResolution:({settings:g})=>getMaxOutgoingResolution(g),maxParticipantResolutions:({settings:g})=>getMaxParticipantResolutions2(g),maxIncomingStreams:({settings:g})=>getMaxIncomingStreams2(g),maxSimulcastLayers:({settings:g})=>getMaxSimulcastLayers2(g),outgoingVideoLimit:({settings:g,constraints:m})=>getOutgoingVideoLimit2(g,m)},convertSettingsToCallConstraints=(g,m,f)=>(g.info(`Converting settings to constraints and mapping, [requestedConstraints=${JSON.stringify(f)}], [settings=${JSON.stringify(m)}]`),convertConstraints((0,Ma.cloneDeep)(f),(0,Ma.cloneDeep)(m))),convertConstraints=(g,m)=>Object.keys(g).reduce(((f,S)=>{const v=Da[S]?Da[S]({constraints:g,settings:m}):void 0;return v&&(f[S]=v),f}),{}),getMaxParticipantResolutions2=g=>g.multiviewResolutionLimits,getMaxOutgoingResolution=g=>g.outgoingVideoLimit?.maxResolution,getOutgoingVideoLimit2=(g,m)=>{const f=m?.outgoingVideoLimit;if(!f)return;const{outgoingVideoLimit:S={}}=deepClone(g);if("number"==typeof f)return S?.maxResolution;const v=Object.keys(f).reduce(((g,m)=>{const f=S?.[m];return f&&(g[m]=f),g}),{});return Object.keys(v).length?v:void 0},getMaxIncomingStreams2=g=>g.numVideoChannelsGvc,getMaxSimulcastLayers2=g=>{const m=g.specCompliantSimulcast,f=m.video?.layerScaleFactors,S=m.sharing?.layerScaleFactors,v=f?.length?Math.max(...f):1,C=S?.length?Math.max(...f):1;return Math.min(v,C)},Oa=R,isVideoLimit=g=>{const m=["maxResolution","maxBitrate","maxFramerate"],isValidVideoLimitKey=g=>m.includes(g),f=Object.entries(g);return 0!==f.length&&f.every((([g,m])=>(0,Oa.isNumber)(m)&&isValidVideoLimitKey(g)))},isVideoLimitOrResolution=g=>!!(0,Oa.isNumber)(g)||!!isVideoLimit(g)&&!isEmpty(g),Na={maxIncomingStreams:Oa.isNumber,maxSimulcastLayers:Oa.isNumber,maxOutgoingResolution:Oa.isNumber,maxParticipantResolutions:g=>!!isDefined(g)&&(!!(0,Oa.isNumber)(g)||"more"in g&&Object.values(g).every((g=>(0,Oa.isNumber)(g)))),outgoingVideoLimit:g=>!!isDefined(g)&&isVideoLimitOrResolution(g),incomingVideoLimit:g=>!!isDefined(g)&&(!!isVideoLimitOrResolution(g)||"more"in g&&Object.values(g).every((g=>isVideoLimitOrResolution(g))))},removeInvalidConstraints=g=>(g=JSON.parse(JSON.stringify(g)),Object.entries(Na).reduce(((m,[f,S])=>(S(g[f])&&(m[f]=g[f]),m)),{})),deepMergeConstraints=(g,m)=>{for(const f in m){const S=g[f],v=m[f];g[f]="object"==typeof v?deepMergeConstraints({...S},v):getMinDefined(S,v)}return g},ka=class{constructor(g,m,f,S,v,C,_){this.logger=g,this.defaultSettings=m,this._mediaConfig=f,this._userAgentConfig=S,this._countryCode=v,this.platformCallConstraintsProvider=C,this.currentCallConstraints=_,this.mergedConstraints={},this.callConstraintsTelemetry=[],this.iceTransportPolicy=je.ICE_TRANSPORT_POLICY.all,this.validIceTransportPolicies=[je.ICE_TRANSPORT_POLICY.all,je.ICE_TRANSPORT_POLICY.relay],this.mergeConstraintsTelemetryWithGlobal(),this.mergedConstraints=this.mergeConstraintsWithGlobal(this.currentCallConstraints),this.settings=this.mergeSettings((0,wa.cloneDeep)(this.defaultSettings))}get config(){return this.settings}get mediaConfig(){return this._mediaConfig}get userAgentConfig(){return this._userAgentConfig}get countryCode(){return this._countryCode}addCallConstraintsTelemetryEvent(g,m){const f={timestamp:(new Date).getTime(),type:m,value:g};arrayLimitedPush(this.callConstraintsTelemetry,f,this.config.numCallConstraintsEvents)}getCallConstraintsTelemetry(){return this.callConstraintsTelemetry}getCallConstraints(){return this.mergedConstraints}setCallConstraints(g={}){this.addCallConstraintsTelemetryEvent(g,"requested"),this.logger.safe.debug("Saving new call constraints",JSON.stringify(g));const m=this.transformConstraints(removeInvalidConstraints(g));return this.logger.safe.debug("Validated call constraints",JSON.stringify(m)),this.mergedConstraints=this.mergeConstraintsWithGlobal(m),this.settings=this.mergeSettings((0,wa.cloneDeep)(this.defaultSettings)),convertSettingsToCallConstraints(this.logger,this.settings,m)}getIceTransportPolicy(){return this.settings.iceTransportPolicyForced||this.iceTransportPolicy}setIceTransportPolicy(g){this.validIceTransportPolicies.includes(g)?(this.logger.info(`Setting transport policy to ${this.iceTransportPolicy}`),this.iceTransportPolicy=g):this.logger.debug(`Unknown incoming transport policy, using ${this.iceTransportPolicy}`)}transformConstraints(g){const m=(0,wa.cloneDeep)(g);return"maxOutgoingResolution"in m&&(m.outgoingVideoLimit={maxResolution:m.maxOutgoingResolution},delete m.maxOutgoingResolution),"number"==typeof m.outgoingVideoLimit&&(m.outgoingVideoLimit={maxResolution:m.outgoingVideoLimit}),m}mergeConstraintsTelemetryWithGlobal(){this.platformCallConstraintsProvider.callConstraintsTelemetry.forEach((g=>arrayLimitedPush(this.callConstraintsTelemetry,g,this.defaultSettings.numCallConstraintsEvents)))}mergeConstraintsWithGlobal(g={}){const m=this.transformConstraints(this.platformCallConstraintsProvider.constraints);if(!Object.keys(m).length)return g;const f=(0,wa.cloneDeep)(g);return deepMergeConstraints(f,m),this.logger.safe.debug(`Merging call constraints ${JSON.stringify(g)} and global constraints ${JSON.stringify(m)}. Result: ${JSON.stringify(f)}`),f}mergeSettings(g){if(!g.enablePlatformCallConstraints||!g.enablePlatformCallConstraintsPerCall)return g;const m=convertCallConstraintsToSettings(this.logger,g,this.mergedConstraints);return this.logger.safe.info(`Merging settings with platform call constraints: ${stringifyObject(m)}`),(0,wa.assign)({},g,m,arrayMergeCustomizer2)}},La="function",Fa="object",xa="undefined",Ua="prototype",Va="hasOwnProperty",Ba=Object,Ha=Ba[Ua],$a=Ba.assign,Ga=Ba.create,ja=Ba.defineProperty,Wa=Ha[Va],qa=null;function getGlobal(g){void 0===g&&(g=!0);var m=!1===g?null:qa;return m||(typeof globalThis!==xa&&(m=globalThis),m||typeof self===xa||(m=self),m||typeof window===xa||(m=window),m||typeof f===xa||(m=f),qa=m),m}function throwTypeError(g){throw new TypeError(g)}function objCreateFn(g){if(Ga)return Ga(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==Fa&&m!==La&&throwTypeError("Object prototype may only be an Object:"+g),tmpFunc[Ua]=g,new tmpFunc}(getGlobal()||{}).Symbol,(getGlobal()||{}).Reflect;var za,__objAssignFnImpl=function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Ha[Va].call(m,v)&&(g[v]=m[v]);return g},Ka=$a||__objAssignFnImpl,extendStaticsFn=function(g,m){return(extendStaticsFn=Ba.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m[Va](f)&&(g[f]=m[f])})(g,m)};function __extendsFn(g,m){function __(){this.constructor=g}typeof m!==La&&null!==m&&throwTypeError("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn(g,m),g[Ua]=null===m?objCreateFn(m):(__[Ua]=m[Ua],new __)}function __spreadArrayFn(g,m){for(var f=0,S=m.length,v=g.length;f<S;f++,v++)g[v]=m[f];return g}var Ja="undefined",Ya="constructor",Qa="prototype",Xa="function",Za="_dynInstFuncs",eo="_isDynProxy",to="_dynClass",io="_dynCls$",no="_dynInstChk",ro=no,so="_dfOpts",ao="_unknown_",oo="__proto__",lo="_dyn"+oo,co="__dynProto$Gbl",ho="_dynInstProto",uo="useBaseInst",go="setInstFuncs",po=Object,mo=po.getPrototypeOf,fo=po.getOwnPropertyNames;function _getGlobal(){var g;return typeof globalThis!==Ja&&(g=globalThis),g||typeof self===Ja||(g=self),g||typeof window===Ja||(g=window),g||typeof f===Ja||(g=f),g||{}}var So=_getGlobal(),vo=So[co]||(So[co]={o:(za={},za[go]=!0,za[uo]=!0,za),n:1e3});function _hasOwnProperty(g,m){return g&&po[Qa].hasOwnProperty.call(g,m)}function _isObjectOrArrayPrototype(g){return g&&(g===po[Qa]||g===Array[Qa])}function _isObjectArrayOrFunctionPrototype(g){return _isObjectOrArrayPrototype(g)||g===Function[Qa]}function _getObjProto(g){var m;if(g){if(mo)return mo(g);var f=g[oo]||g[Qa]||(g[Ya]?g[Ya][Qa]:null);m=g[lo]||f,_hasOwnProperty(g,lo)||(delete g[ho],m=g[lo]=g[ho]||g[lo],g[ho]=f)}return m}function _forEachProp(g,m){var f=[];if(fo)f=fo(g);else for(var S in g)"string"==typeof S&&_hasOwnProperty(g,S)&&f.push(S);if(f&&f.length>0)for(var v=0;v<f.length;v++)m(f[v])}function _isDynamicCandidate(g,m,f){return m!==Ya&&typeof g[m]===Xa&&(f||_hasOwnProperty(g,m))}function _throwTypeError(g){throw new TypeError("DynamicProto: "+g)}function _getInstanceFuncs(g){var m={};return _forEachProp(g,(function(f){!m[f]&&_isDynamicCandidate(g,f,!1)&&(m[f]=g[f])})),m}function _hasVisited(g,m){for(var f=g.length-1;f>=0;f--)if(g[f]===m)return!0;return!1}function _getBaseFuncs(g,m,f,S){function _instFuncProxy(g,m,f){var v=m[f];if(v[eo]&&S){var C=g[Za]||{};!1!==C[ro]&&(v=(C[m[to]]||{})[f]||v)}return function(){return v.apply(g,arguments)}}var v={};_forEachProp(f,(function(g){v[g]=_instFuncProxy(m,f,g)}));for(var C=_getObjProto(g),_=[];C&&!_isObjectArrayOrFunctionPrototype(C)&&!_hasVisited(_,C);)_forEachProp(C,(function(g){!v[g]&&_isDynamicCandidate(C,g,!mo)&&(v[g]=_instFuncProxy(m,C,g))})),_.push(C),C=_getObjProto(C);return v}function _getInstFunc(g,m,f,S){var v=null;if(g&&_hasOwnProperty(f,to)){var C=g[Za]||{};if((v=(C[f[to]]||{})[m])||_throwTypeError("Missing ["+m+"] "+Xa),!v[no]&&!1!==C[ro]){for(var _=!_hasOwnProperty(g,m),E=_getObjProto(g),T=[];_&&E&&!_isObjectArrayOrFunctionPrototype(E)&&!_hasVisited(T,E);){var I=E[m];if(I){_=I===S;break}T.push(E),E=_getObjProto(E)}try{_&&(g[m]=v),v[no]=1}catch(g){C[ro]=!1}}}return v}function _getProtoFunc(g,m,f){var S=m[g];return S===f&&(S=_getObjProto(m)[g]),typeof S!==Xa&&_throwTypeError("["+g+"] is not a "+Xa),S}function _populatePrototype(g,m,f,S,v){function _createDynamicPrototype(g,m){var dynProtoProxy=function(){return(_getInstFunc(this,m,g,dynProtoProxy)||_getProtoFunc(m,g,dynProtoProxy)).apply(this,arguments)};return dynProtoProxy[eo]=1,dynProtoProxy}if(!_isObjectOrArrayPrototype(g)){var C=f[Za]=f[Za]||{},_=C[m]=C[m]||{};!1!==C[ro]&&(C[ro]=!!v),_forEachProp(f,(function(m){_isDynamicCandidate(f,m,!1)&&f[m]!==S[m]&&(_[m]=f[m],delete f[m],(!_hasOwnProperty(g,m)||g[m]&&!g[m][eo])&&(g[m]=_createDynamicPrototype(g,m)))}))}}function _checkPrototype(g,m){if(mo){for(var f=[],S=_getObjProto(m);S&&!_isObjectArrayOrFunctionPrototype(S)&&!_hasVisited(f,S);){if(S===g)return!0;f.push(S),S=_getObjProto(S)}return!1}return!0}function _getObjName(g,m){return _hasOwnProperty(g,Qa)?g.name||m||ao:((g||{})[Ya]||{}).name||m||ao}function dynamicProto(g,m,f,S){_hasOwnProperty(g,Qa)||_throwTypeError("theClass is an invalid class definition.");var v=g[Qa];_checkPrototype(v,m)||_throwTypeError("["+_getObjName(g)+"] not in hierarchy of ["+_getObjName(m)+"]");var C=null;_hasOwnProperty(v,to)?C=v[to]:(C=io+_getObjName(g,"_")+"$"+vo.n,vo.n++,v[to]=C);var _=dynamicProto[so],E=!!_[uo];E&&S&&void 0!==S[uo]&&(E=!!S[uo]);var T=_getInstanceFuncs(m);f(m,_getBaseFuncs(v,m,T,E));var I=!!mo&&!!_[go];I&&S&&(I=!!S[go]),_populatePrototype(v,C,m,T,!1!==I)}dynamicProto[so]=vo.o;var yo="initialize",Co="name",_o="getNotifyMgr",Eo="identifier",To="push",Io="isInitialized",bo="config",Ao="instrumentationKey",Po="logger",Ro="length",wo="time",Mo="processNext",Do="getProcessTelContext",Oo="addNotificationListener",No="removeNotificationListener",ko="stopPollingInternalLogs",Lo="onComplete",Fo="getPlugin",xo="flush",Uo="_extensions",Vo="splice",Bo="teardown",Ho="messageId",$o="message",Go="isAsync",jo="_doTeardown",Wo="update",qo="getNext",zo="diagLog",Ko="setNextPlugin",Jo="createNew",Yo="cookieCfg",Qo="indexOf",Xo="substring",Zo="userAgent",el="split",tl="setEnabled",il="substr",nl="nodeType",rl="apply",sl="replace",al="enableDebugExceptions",ol="logInternalMessage",ll="toLowerCase",cl="call",dl="type",hl="handler",ul="listeners",gl="isChildEvt",pl="getCtx",ml="setCtx",fl="complete",Sl="traceId",vl="spanId",yl="traceFlags",Cl="",_l="channels",El="core",Tl="createPerfMgr",Il="disabled",bl="extensionConfig",Al="extensions",Pl="processTelemetry",Rl="priority",wl="eventsSent",Ml="eventsDiscarded",Dl="eventsSendRequest",Ol="perfEvent",Nl="errorToConsole",kl="warnToConsole",Ll="getPerfMgr",Fl="toISOString",xl="endsWith",Ul="startsWith",Vl="indexOf",Bl="trim",Hl="toString",$l="__proto__",Gl="constructor",jl=ja,Wl=Ba.freeze,ql=Ba.keys,zl=String[Ua],Kl=zl[Bl],Jl=zl[xl],Yl=zl[Ul],Ql=Date[Ua][Fl],Xl=Array.isArray,Zl=Ha[Hl],ec=Wa[Hl],tc=ec[cl](Ba),ic=/-([a-z])/g,nc=/([^\w\d_$])/g,rc=/^(\d+[\w\d_$])/,sc=Object.getPrototypeOf;function _getObjProto2(g){if(g){if(sc)return sc(g);var m=g[$l]||g[Ua]||g[Gl];if(m)return m}return null}function isUndefined3(g){return void 0===g||typeof g===xa}function isNullOrUndefined(g){return null===g||isUndefined3(g)}function isNotNullOrUndefined(g){return!isNullOrUndefined(g)}function hasOwnProperty(g,m){return!(!g||!Wa[cl](g,m))}function isObject3(g){return!(!g||typeof g!==Fa)}function isFunction2(g){return!(!g||typeof g!==La)}function normalizeJsName(g){var m=g;return m&&isString2(m)&&(m=(m=(m=m[sl](ic,(function(g,m){return m.toUpperCase()})))[sl](nc,"_"))[sl](rc,(function(g,m){return"_"+m}))),m}function objForEachKey(g,m){if(g)for(var f in g)Wa[cl](g,f)&&m[cl](g,f,g[f])}function strEndsWith(g,m){var f=!1;return g&&m&&!(f=g===m)&&(f=Jl?g[xl](m):_strEndsWithPoly(g,m)),f}function _strEndsWithPoly(g,m){var f=!1,S=m?m[Ro]:0,v=g?g[Ro]:0;if(S&&v&&v>=S&&!(f=g===m)){for(var C=v-1,_=S-1;_>=0;_--){if(g[C]!=m[_])return!1;C--}f=!0}return f}function strStartsWith(g,m){var f=!1;return g&&m&&!(f=g===m)&&(f=Yl?g[Ul](m):_strStartsWithPoly(g,m)),f}function _strStartsWithPoly(g,m){var f=!1,S=m?m[Ro]:0;if(g&&S&&g[Ro]>=S&&!(f=g===m)){for(var v=0;v<S;v++)if(g[v]!==m[v])return!1;f=!0}return f}function strContains(g,m){return!(!g||!m)&&-1!==g[Qo](m)}var ac=Xl||_isArrayPoly;function _isArrayPoly(g){return!(!g||"[object Array]"!==Zl[cl](g))}function isError(g){return!(!g||"[object Error]"!==Zl[cl](g))}function isString2(g){return"string"==typeof g}function isNumber3(g){return"number"==typeof g}function isBoolean2(g){return"boolean"==typeof g}function isPlainObject(g){var m=!1;if(g&&"object"==typeof g){var f=sc?sc(g):_getObjProto2(g);f?(f[Gl]&&Wa[cl](f,Gl)&&(f=f[Gl]),m=typeof f===La&&ec[cl](f)===tc):m=!0}return m}function toISOString(g){if(g)return Ql?g[Fl]():_toISOStringPoly(g)}function _toISOStringPoly(g){if(g&&g.getUTCFullYear){var pad=function(g){var m=String(g);return 1===m[Ro]&&(m="0"+m),m};return g.getUTCFullYear()+"-"+pad(g.getUTCMonth()+1)+"-"+pad(g.getUTCDate())+"T"+pad(g.getUTCHours())+":"+pad(g.getUTCMinutes())+":"+pad(g.getUTCSeconds())+"."+String((g.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}function arrForEach(g,m,f){var S=g[Ro];try{for(var v=0;v<S&&(!(v in g)||-1!==m[cl](f||g,g[v],v,g));v++);}catch(g){}}function arrIndexOf(g,m,f){if(g){if(g[Vl])return g[Vl](m,f);var S=g[Ro],v=f||0;try{for(var C=Math.max(v>=0?v:S-Math.abs(v),0);C<S;C++)if(C in g&&g[C]===m)return C}catch(g){}}return-1}function strTrim(g){return g&&(g=Kl&&g[Bl]?g[Bl]():g[sl]?g[sl](/^\s+|(?=\s)\s+$/g,Cl):g),g}var oc=!{toString:null}.propertyIsEnumerable("toString"),lc=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys(g){var m=typeof g;if(m===La||m===Fa&&null!==g||throwTypeError("objKeys called on non-object"),!oc&&ql)return ql(g);var f=[];for(var S in g)g&&Wa[cl](g,S)&&f[To](S);if(oc)for(var v=lc[Ro],C=0;C<v;C++)g&&Wa[cl](g,lc[C])&&f[To](lc[C]);return f}function objDefineAccessors(g,m,f,S){if(jl)try{var v={enumerable:!0,configurable:!0};return f&&(v.get=f),S&&(v.set=S),jl(g,m,v),!0}catch(g){}return!1}function _doNothing(g){return g}function deepFreeze(g){return Wl&&objForEachKey(g,(function(g,m){(ac(m)||isObject3(m))&&Wl(m)})),cc(g)}var cc=Wl||_doNothing;function dateNow(){var g=Date;return g.now?g.now():(new g).getTime()}function getExceptionName(g){return isError(g)?g[Co]:Cl}function setValue(g,m,f,S,v){var C=f;return g&&((C=g[m])===f||v&&!v(C)||S&&!S(f)||(C=f,g[m]=C)),C}function getSetValue(g,m,f){var S;return g?!(S=g[m])&&isNullOrUndefined(S)&&(S=isUndefined3(f)?{}:f,g[m]=S):S=isUndefined3(f)?{}:f,S}function getCfgValue(g,m){return isNullOrUndefined(g)?m:g}function isTruthy(g){return!!g}function throwError(g){throw new Error(g)}function _createProxyFunction(g,m){var f=null,S=null;return isFunction2(g)?f=g:S=g,function(){var g=arguments;if(f&&(S=f()),S)return S[m][rl](S,g)}}function proxyFunctionAs(g,m,f,S,v){g&&m&&f&&(!1!==v||isUndefined3(g[m]))&&(g[m]=_createProxyFunction(f,S))}function proxyFunctions(g,m,f,S){return g&&m&&isObject3(g)&&ac(f)&&arrForEach(f,(function(f){isString2(f)&&proxyFunctionAs(g,f,m,f,S)})),g}function optimizeObject(g){return g&&$a&&(g=Ba($a({},g))),g}function objExtend(g,m,f,S,v,C){var _=arguments,E=_[0]||{},T=_[Ro],I=!1,b=1;for(T>0&&isBoolean2(E)&&(I=E,E=_[b]||{},b++),isObject3(E)||(E={});b<T;b++){var A=_[b],P=ac(A),R=isObject3(A);for(var w in A){if(P&&w in A||R&&Wa[cl](A,w)){var M=A[w],D=void 0;if(I&&M&&((D=ac(M))||isPlainObject(M))){var O=E[w];D?ac(O)||(O=[]):isPlainObject(O)||(O={}),M=objExtend(I,O,M)}void 0!==M&&(E[w]=M)}}}return E}function createEnumStyle(g){var m={};return objForEachKey(g,(function(g,f){m[g]=f,m[f]=g})),deepFreeze(m)}function createValueMap(g){var m={};return objForEachKey(g,(function(g,f){m[g]=f[1],m[f[0]]=f[1]})),deepFreeze(m)}var dc=createEnumStyle({Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5}),hc="window",uc="document",gc="navigator",pc="location",mc="console",fc="performance",Sc="JSON",vc="crypto",yc="msCrypto",Cc="ReactNative",_c="msie",Ec="trident/",Tc="XMLHttpRequest",Ic=null,bc=null,Ac=!1,Pc=null,Rc=null;function _hasProperty(g,m){var f=!1;if(g){try{if(!(f=m in g)){var S=g[Ua];S&&(f=m in S)}}catch(g){}if(!f)try{f=!isUndefined3((new g)[m])}catch(g){}}return f}function getGlobalInst(g){var m=getGlobal();return m&&m[g]?m[g]:g===hc&&hasWindow()?window:null}function hasWindow(){return Boolean(typeof window===Fa&&window)}function getWindow(){return hasWindow()?window:getGlobalInst(hc)}function hasDocument(){return Boolean(typeof document===Fa&&document)}function getDocument(){return hasDocument()?document:getGlobalInst(uc)}function hasNavigator(){return Boolean(typeof navigator===Fa&&navigator)}function getNavigator(){return hasNavigator()?navigator:getGlobalInst(gc)}function getLocation(g){if(g&&Ac){var m=getGlobalInst("__mockLocation");if(m)return m}return typeof location===Fa&&location?location:getGlobalInst(pc)}function getConsole(){return typeof console!==xa?console:getGlobalInst(mc)}function getPerformance(){return getGlobalInst(fc)}function hasJSON(){return Boolean(typeof JSON===Fa&&JSON||null!==getGlobalInst(Sc))}function getJSON(){return hasJSON()?JSON||getGlobalInst(Sc):null}function getCrypto(){return getGlobalInst(vc)}function getMsCrypto(){return getGlobalInst(yc)}function isReactNative(){var g=getNavigator();return!(!g||!g.product)&&g.product===Cc}function isIE(){var g=getNavigator();if(g&&(g[Zo]!==bc||null===Ic)){var m=((bc=g[Zo])||Cl)[ll]();Ic=strContains(m,_c)||strContains(m,Ec)}return Ic}function dumpObj(g){var m=Object[Ua].toString[cl](g),f=Cl;return"[object Error]"===m?f="{ stack: '"+g.stack+"', message: '"+g.message+"', name: '"+g[Co]+"'":hasJSON()&&(f=getJSON().stringify(g)),m+f}function isBeaconsSupported(){return null===Rc&&(Rc=hasNavigator()&&Boolean(getNavigator().sendBeacon)),Rc}function isFetchSupported(g){var m=!1;try{m=!!getGlobalInst("fetch");var f=getGlobalInst("Request");m&&g&&f&&(m=_hasProperty(f,"keepalive"))}catch(g){}return m}function useXDomainRequest(){return null===Pc&&(Pc=typeof XDomainRequest!==xa)&&isXhrSupported()&&(Pc=Pc&&!_hasProperty(getGlobalInst(Tc),"withCredentials")),Pc}function isXhrSupported(){var g=!1;try{g=!!getGlobalInst(Tc)}catch(g){}return g}var wc,Mc=["eventsSent","eventsDiscarded","eventsSendRequest","perfEvent"],Dc=null;function _listenerProxyFunc(g,m){return function(){var f=arguments,S=getDebugExt(m);if(S){var v=S.listener;v&&v[g]&&v[g][rl](v,f)}}}function _getExtensionNamespace(){var g=getGlobalInst("Microsoft");return g&&(Dc=g.ApplicationInsights),Dc}function getDebugExt(g){var m=Dc;return m||!0===g.disableDbgExt||(m=Dc||_getExtensionNamespace()),m?m.ChromeDbgExt:null}function getDebugListener(g){if(!wc){wc={};for(var m=0;m<Mc[Ro];m++)wc[Mc[m]]=_listenerProxyFunc(Mc[m],g)}return wc}var Oc="AI (Internal): ",Nc="AI: ",kc="AITR_";function _sanitizeDiagnosticText(g){return g?'"'+g[sl](/\"/g,Cl)+'"':Cl}function _logToConsole(g,m){var f=getConsole();if(f){var S="log";f[g]&&(S=g),isFunction2(f[S])&&f[S](m)}}var Lc=function(){function _InternalLogMessage2(g,m,f,S){void 0===f&&(f=!1);var v=this;v[Ho]=g,v[$o]=(f?Nc:Oc)+g;var C=Cl;hasJSON()&&(C=getJSON().stringify(S));var _=(m?" message:"+_sanitizeDiagnosticText(m):Cl)+(S?" props:"+_sanitizeDiagnosticText(C):Cl);v[$o]+=_}return _InternalLogMessage2.dataType="MessageData",_InternalLogMessage2}();function safeGetLogger(g,m){return(g||{})[Po]||new Fc(m)}var Fc=function(){function DiagnosticLogger2(g){this.identifier="DiagnosticLogger",this.queue=[];var m,f,S,v,C=0,_={};dynamicProto(DiagnosticLogger2,this,(function(E){function _logInternalMessage2(g,m){if(!_areInternalMessagesThrottled()){var v=!0,T=kc+m[Ho];if(_[T]?v=!1:_[T]=!0,v&&(g<=f&&(E.queue[To](m),C++,_debugExtMsg(1===g?"error":"warn",m)),C===S)){var I="Internal events throttle limit per PageView reached for this app.",b=new Lc(23,I,!1);E.queue[To](b),1===g?E[Nl](I):E[kl](I)}}}function _setDefaultsFromConfig(g){m=getCfgValue(g.loggingLevelConsole,0),f=getCfgValue(g.loggingLevelTelemetry,1),S=getCfgValue(g.maxMessageLimit,25),v=getCfgValue(g[al],!1)}function _areInternalMessagesThrottled(){return C>=S}function _debugExtMsg(m,f){var S=getDebugExt(g||{});S&&S[zo]&&S[zo](m,f)}_setDefaultsFromConfig(g||{}),E.consoleLoggingLevel=function(){return m},E.telemetryLoggingLevel=function(){return f},E.maxInternalMessageLimit=function(){return S},E[al]=function(){return v},E.throwInternal=function(g,f,S,C,T){void 0===T&&(T=!1);var I=new Lc(f,S,T,C);if(v)throw dumpObj(I);var b=1===g?Nl:kl;if(isUndefined3(I[$o]))_debugExtMsg("throw"+(1===g?"Critical":"Warning"),I);else{if(T){var A=+I[Ho];!_[A]&&m>=g&&(E[b](I[$o]),_[A]=!0)}else m>=g&&E[b](I[$o]);_logInternalMessage2(g,I)}},E[kl]=function(g){_logToConsole("warn",g),_debugExtMsg("warning",g)},E[Nl]=function(g){_logToConsole("error",g),_debugExtMsg("error",g)},E.resetInternalMessageCount=function(){C=0,_={}},E[ol]=_logInternalMessage2}))}return DiagnosticLogger2.__ieDyn=1,DiagnosticLogger2}();function _getLogger(g){return g||new Fc}function _throwInternal(g,m,f,S,v,C){void 0===C&&(C=!1),_getLogger(g).throwInternal(m,f,S,v,C)}function _warnToConsole(g,m){_getLogger(g)[kl](m)}var xc="ctx",Uc="ParentContextKey",Vc="ChildrenContextKey",Bc=null,Hc=function(){function PerfEvent2(g,m,f){var S,v=this,C=!1;(v.start=dateNow(),v[Co]=g,v[Go]=f,v[gl]=function(){return!1},isFunction2(m))&&(C=objDefineAccessors(v,"payload",(function(){return!S&&isFunction2(m)&&(S=m(),m=null),S})));v[pl]=function(g){return g?g===PerfEvent2[Uc]||g===PerfEvent2[Vc]?v[g]:(v[xc]||{})[g]:null},v[ml]=function(g,m){if(g)if(g===PerfEvent2[Uc])v[g]||(v[gl]=function(){return!0}),v[g]=m;else if(g===PerfEvent2[Vc])v[g]=m;else{(v[xc]=v[xc]||{})[g]=m}},v[fl]=function(){var g=0,f=v[pl](PerfEvent2[Vc]);if(ac(f))for(var S=0;S<f[Ro];S++){var _=f[S];_&&(g+=_[wo])}v[wo]=dateNow()-v.start,v.exTime=v[wo]-g,v[fl]=function(){},!C&&isFunction2(m)&&(v.payload=m())}}return PerfEvent2.ParentContextKey="parent",PerfEvent2.ChildrenContextKey="childEvts",PerfEvent2}(),$c=function(){function PerfManager2(g){this.ctx={},dynamicProto(PerfManager2,this,(function(m){m.create=function(g,m,f){return new Hc(g,m,f)},m.fire=function(m){m&&(m[fl](),g&&isFunction2(g[Ol])&&g[Ol](m))},m[ml]=function(g,f){g&&((m[xc]=m[xc]||{})[g]=f)},m[pl]=function(g){return(m[xc]||{})[g]}}))}return PerfManager2.__ieDyn=1,PerfManager2}(),Gc="CoreUtils.doPerf";function doPerf(g,m,f,S,v){if(g){var C=g;if(C[Ll]&&(C=C[Ll]()),C){var _=void 0,E=C[pl](Gc);try{if(_=C.create(m(),S,v)){if(E&&_[ml]&&(_[ml](Hc[Uc],E),E[pl]&&E[ml])){var T=E[pl](Hc[Vc]);T||(T=[],E[ml](Hc[Vc],T)),T[To](_)}return C[ml](Gc,_),f(_)}}catch(g){_&&_[ml]&&_[ml]("exception",g)}finally{_&&C.fire(_),C[ml](Gc,E)}}}return f()}function getGblPerfMgr(){return Bc}var jc=4294967296,Wc=4294967295,qc=!1,zc=123456789,Kc=987654321;function _mwcSeed(g){g<0&&(g>>>=0),zc=123456789+g&Wc,Kc=987654321-g&Wc,qc=!0}function _autoSeedMwc(){try{var g=2147483647&dateNow();_mwcSeed((Math.random()*jc^g)+g)}catch(g){}}function random32(g){var m=0,f=getCrypto()||getMsCrypto();return f&&f.getRandomValues&&(m=f.getRandomValues(new Uint32Array(1))[0]&Wc),0===m&&isIE()&&(qc||_autoSeedMwc(),m=mwcRandom32()&Wc),0===m&&(m=Math.floor(jc*Math.random()|0)),g||(m>>>=0),m}function mwcRandom32(g){var m=((Kc=36969*(65535&Kc)+(Kc>>16)&Wc)<<16)+(65535&(zc=18e3*(65535&zc)+(zc>>16)&Wc))>>>0&Wc|0;return g||(m>>>=0),m}function newId(g){void 0===g&&(g=22);for(var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f=random32()>>>0,S=0,v=Cl;v[Ro]<g;)S++,v+=m.charAt(63&f),f>>>=6,5===S&&(f=(random32()<<2&4294967295|3&f)>>>0,S=0);return v}var Jc=ja,Yc="2.8.10",Qc="."+newId(6),Xc=0;function _createAccessor(g,m,f){if(Jc)try{return Jc(g,m,{value:f,enumerable:!1,configurable:!0}),!0}catch(g){}return!1}function _canAcceptData(g){return 1===g[nl]||9===g[nl]||!+g[nl]}function _getCache(g,m){var f=m[g.id];if(!f){f={};try{_canAcceptData(m)&&(_createAccessor(m,g.id,f)||(m[g.id]=f))}catch(g){}}return f}function createUniqueNamespace(g,m){return void 0===m&&(m=!1),normalizeJsName(g+Xc+++(m?"."+Yc:Cl)+Qc)}function createElmNodeData(g){var m={id:createUniqueNamespace("_aiData-"+(g||Cl)+"."+Yc),accept:function(g){return _canAcceptData(g)},get:function(g,f,S,v){var C=g[m.id];return C?C[normalizeJsName(f)]:(v&&((C=_getCache(m,g))[normalizeJsName(f)]=S),S)},kill:function(g,m){if(g&&g[m])try{delete g[m]}catch(g){}}};return m}var Zc="toGMTString",ed="toUTCString",td="cookie",id="expires",nd="enabled",rd="isCookieUseDisabled",sd="disableCookiesUsage",ad="_ckMgr",od=null,ld=null,cd=null,dd=getDocument(),hd={},ud={};function _gblCookieMgr(g,m){var f=createCookieMgr[ad]||ud[ad];return f||(f=createCookieMgr[ad]=createCookieMgr(g,m),ud[ad]=f),f}function _isMgrEnabled(g){return!g||g.isEnabled()}function _createCookieMgrConfig(g){var m=g[Yo]=g[Yo]||{};if(setValue(m,"domain",g.cookieDomain,isNotNullOrUndefined,isNullOrUndefined),setValue(m,"path",g.cookiePath||"/",null,isNullOrUndefined),isNullOrUndefined(m[nd])){var f=void 0;isUndefined3(g[rd])||(f=!g[rd]),isUndefined3(g[sd])||(f=!g[sd]),m[nd]=f}return m}function _isIgnoredCookie(g,m){return!!(m&&g&&ac(g.ignoreCookies))&&-1!==g.ignoreCookies[Qo](m)}function _isBlockedCookie(g,m){return!!(m&&g&&ac(g.blockedCookies)&&-1!==g.blockedCookies[Qo](m))||_isIgnoredCookie(g,m)}function safeGetCookieMgr(g,m){var f;if(g)f=g.getCookieMgr();else if(m){var S=m[Yo];f=S[ad]?S[ad]:createCookieMgr(m)}return f||(f=_gblCookieMgr(m,(g||{})[Po])),f}function createCookieMgr(g,m){var f,S=_createCookieMgrConfig(g||ud),v=S.path||"/",C=S.domain,_=!1!==S[nd],E=((f={isEnabled:function(){var g=_&&areCookiesSupported(m),f=ud[ad];return g&&f&&E!==f&&(g=_isMgrEnabled(f)),g}})[tl]=function(g){_=!1!==g},f.set=function(g,m,f,_,T){var I=!1;if(_isMgrEnabled(E)&&!_isBlockedCookie(S,g)){var b={},A=strTrim(m||Cl),P=A[Qo](";");if(-1!==P&&(A=strTrim(m[Xo](0,P)),b=_extractParts(m[Xo](P+1))),setValue(b,"domain",_||C,isTruthy,isUndefined3),!isNullOrUndefined(f)){var R=isIE();if(isUndefined3(b[id])){var w=dateNow()+1e3*f;if(w>0){var M=new Date;M.setTime(w),setValue(b,id,_formatDate(M,R?Zc:ed)||_formatDate(M,R?Zc:ed)||Cl,isTruthy)}}R||setValue(b,"max-age",Cl+f,null,isUndefined3)}var D=getLocation();D&&"https:"===D.protocol&&(setValue(b,"secure",null,null,isUndefined3),null===ld&&(ld=!uaDisallowsSameSiteNone((getNavigator()||{})[Zo])),ld&&setValue(b,"SameSite","None",null,isUndefined3)),setValue(b,"path",T||v,null,isUndefined3),(S.setCookie||_setCookieValue)(g,_formatCookieValue(A,b)),I=!0}return I},f.get=function(g){var m=Cl;return _isMgrEnabled(E)&&!_isIgnoredCookie(S,g)&&(m=(S.getCookie||_getCookieValue)(g)),m},f.del=function(g,m){var f=!1;return _isMgrEnabled(E)&&(f=E.purge(g,m)),f},f.purge=function(g,f){var v,C=!1;if(areCookiesSupported(m)){var _=((v={}).path=f||"/",v[id]="Thu, 01 Jan 1970 00:00:01 GMT",v);isIE()||(_["max-age"]="0"),(S.delCookie||_setCookieValue)(g,_formatCookieValue(Cl,_)),C=!0}return C},f);return E[ad]=E,E}function areCookiesSupported(g){if(null===od){od=!1;try{od=void 0!==(dd||{})[td]}catch(m){_throwInternal(g,2,68,"Cannot access document.cookie - "+getExceptionName(m),{exception:dumpObj(m)})}}return od}function _extractParts(g){var m={};g&&g[Ro]&&arrForEach(strTrim(g)[el](";"),(function(g){if(g=strTrim(g||Cl)){var f=g[Qo]("=");-1===f?m[g]=null:m[strTrim(g[Xo](0,f))]=strTrim(g[Xo](f+1))}}));return m}function _formatDate(g,m){return isFunction2(g[m])?g[m]():null}function _formatCookieValue(g,m){var f=g||Cl;return objForEachKey(m,(function(g,m){f+="; "+g+(isNullOrUndefined(m)?Cl:"="+m)})),f}function _getCookieValue(g){var m=Cl;if(dd){var f=dd[td]||Cl;cd!==f&&(hd=_extractParts(f),cd=f),m=strTrim(hd[g]||Cl)}return m}function _setCookieValue(g,m){dd&&(dd[td]=g+"="+m)}function uaDisallowsSameSiteNone(g){return!!isString2(g)&&(!(!strContains(g,"CPU iPhone OS 12")&&!strContains(g,"iPad; CPU OS 12"))||(!!(strContains(g,"Macintosh; Intel Mac OS X 10_14")&&strContains(g,"Version/")&&strContains(g,"Safari"))||(!(!strContains(g,"Macintosh; Intel Mac OS X 10_14")||!strEndsWith(g,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))||(!(!strContains(g,"Chrome/5")&&!strContains(g,"Chrome/6"))||(!(!strContains(g,"UnrealEngine")||strContains(g,"Chrome"))||!(!strContains(g,"UCBrowser/12")&&!strContains(g,"UCBrowser/11")))))))}var gd="on",pd="attachEvent",md="addEventListener",fd="detachEvent",Sd="removeEventListener",vd="events",yd="visibilitychange",Cd="pagehide",_d="pageshow",Ed="unload",Td="beforeunload",Id=createUniqueNamespace("aiEvtPageHide"),bd=createUniqueNamespace("aiEvtPageShow"),Ad=/\.[\.]+/g,Pd=/[\.]+$/,Rd=1,wd=createElmNodeData("events"),Md=/^([^.]*)(?:\.(.+)|)/;function _normalizeNamespace(g){return g&&g[sl]?g[sl](/^[\s\.]+|(?=[\s\.])[\.\s]+$/g,Cl):g}function _getEvtNamespace(g,m){var f;if(m){var S=Cl;ac(m)?(S=Cl,arrForEach(m,(function(g){(g=_normalizeNamespace(g))&&("."!==g[0]&&(g="."+g),S+=g)}))):S=_normalizeNamespace(m),S&&("."!==S[0]&&(S="."+S),g=(g||Cl)+S)}var v=Md.exec(g||Cl)||[];return(f={})[dl]=v[1],f.ns=(v[2]||Cl).replace(Ad,".").replace(Pd,Cl)[el](".").sort().join("."),f}function _getRegisteredEvents(g,m,f){void 0===f&&(f=!0);var S=wd.get(g,vd,{},f),v=S[m];return v||(v=S[m]=[]),v}function _doDetach(g,m,f,S){g&&m&&m[dl]&&(g[Sd]?g[Sd](m[dl],f,S):g[fd]&&g[fd](gd+m[dl],f))}function _doAttach(g,m,f,S){var v=!1;return g&&m&&m[dl]&&f&&(g[md]?(g[md](m[dl],f,S),v=!0):g[pd]&&(g[pd](gd+m[dl],f),v=!0)),v}function _doUnregister(g,m,f,S){for(var v=m[Ro];v--;){var C=m[v];C&&(f.ns&&f.ns!==C.evtName.ns||S&&!S(C)||(_doDetach(g,C.evtName,C[hl],C.capture),m[Vo](v,1)))}}function _unregisterEvents(g,m,f){if(m[dl])_doUnregister(g,_getRegisteredEvents(g,m[dl]),m,f);else{var S=wd.get(g,vd,{});objForEachKey(S,(function(S,v){_doUnregister(g,v,m,f)})),0===objKeys(S)[Ro]&&wd.kill(g,vd)}}function mergeEvtNamespace(g,m){return m?_getEvtNamespace("xx",ac(m)?[g].concat(m):[g,m]).ns[el]("."):g}function eventOn(g,m,f,S,v){var C;void 0===v&&(v=!1);var _=!1;if(g)try{var E=_getEvtNamespace(m,S);if((_=_doAttach(g,E,f,v))&&wd.accept(g)){var T=((C={guid:Rd++,evtName:E})[hl]=f,C.capture=v,C);_getRegisteredEvents(g,E.type)[To](T)}}catch(g){}return _}function eventOff(g,m,f,S,v){if(void 0===v&&(v=!1),g)try{var C=_getEvtNamespace(m,S),_=!1;_unregisterEvents(g,C,(function(g){return!((!C.ns||f)&&g[hl]!==f)&&(_=!0,!0)})),_||_doDetach(g,C,f,v)}catch(g){}}function addEventHandler(g,m,f){var S=!1,v=getWindow();v&&(S=eventOn(v,g,m,f),S=eventOn(v.body,g,m,f)||S);var C=getDocument();return C&&(S=eventOn(C,g,m,f)||S),S}function removeEventHandler(g,m,f){var S=getWindow();S&&(eventOff(S,g,m,f),eventOff(S.body,g,m,f));var v=getDocument();v&&eventOff(v,g,m,f)}function _addEventListeners(g,m,f,S){var v=!1;return m&&g&&g[Ro]>0&&arrForEach(g,(function(g){g&&(f&&-1!==arrIndexOf(f,g)||(v=addEventHandler(g,m,S)||v))})),v}function addEventListeners(g,m,f,S){var v=!1;return m&&g&&ac(g)&&!(v=_addEventListeners(g,m,f,S))&&f&&f[Ro]>0&&(v=_addEventListeners(g,m,null,S)),v}function removeEventListeners(g,m,f){g&&ac(g)&&arrForEach(g,(function(g){g&&removeEventHandler(g,m,f)}))}function addPageUnloadEventListener(g,m,f){return addEventListeners([Td,Ed,Cd],g,m,f)}function removePageUnloadEventListener(g,m){removeEventListeners([Td,Ed,Cd],g,m)}function addPageHideEventListener(g,m,f){function _handlePageVisibility(m){var f=getDocument();g&&f&&"hidden"===f.visibilityState&&g(m)}var S=mergeEvtNamespace(Id,f),v=_addEventListeners([Cd],g,m,S);return m&&-1!==arrIndexOf(m,yd)||(v=_addEventListeners([yd],_handlePageVisibility,m,S)||v),!v&&m&&(v=addPageHideEventListener(g,null,f)),v}function removePageHideEventListener(g,m){var f=mergeEvtNamespace(Id,m);removeEventListeners([Cd],g,f),removeEventListeners([yd],null,f)}function addPageShowEventListener(g,m,f){function _handlePageVisibility(m){var f=getDocument();g&&f&&"visible"===f.visibilityState&&g(m)}var S=mergeEvtNamespace(bd,f),v=_addEventListeners([_d],g,m,S);return!(v=_addEventListeners([yd],_handlePageVisibility,m,S)||v)&&m&&(v=addPageShowEventListener(g,null,f)),v}function removePageShowEventListener(g,m){var f=mergeEvtNamespace(bd,m);removeEventListeners([_d],g,f),removeEventListeners([yd],null,f)}function newGuid2(){var g=generateW3CId();return g[Xo](0,8)+"-"+g[Xo](8,12)+"-"+g[Xo](12,16)+"-"+g[Xo](16,20)+"-"+g[Xo](20)}function perfNow(){var g=getPerformance();return g&&g.now?g.now():dateNow()}function generateW3CId(){for(var g,m=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],f=Cl,S=0;S<4;S++)f+=m[15&(g=random32())]+m[g>>4&15]+m[g>>8&15]+m[g>>12&15]+m[g>>16&15]+m[g>>20&15]+m[g>>24&15]+m[g>>28&15];var v=m[8+(3&random32())|0];return f[il](0,8)+f[il](9,4)+"4"+f[il](13,3)+v+f[il](16,3)+f[il](19,12)}var Dd="00000000000000000000000000000000",Od="0000000000000000";function _isValid(g,m,f){return!(!g||g[Ro]!==m||g===f)&&!!g.match(/^[\da-f]*$/)}function isValidTraceId(g){return _isValid(g,32,Dd)}function isValidSpanId(g){return _isValid(g,16,Od)}var Nd=createElmNodeData("plugin");function _getPluginState(g){return Nd.get(g,"state",{},!0)}function initializePlugins(g,m){for(var f,S=[],v=null,C=g[qo]();C;){var _=C[Fo]();if(_){v&&isFunction2(v[Ko])&&isFunction2(_[Pl])&&v[Ko](_);(isFunction2(_[Io])?_[Io]():(f=_getPluginState(_))[Io])||S[To](_),v=_,C=C[qo]()}}arrForEach(S,(function(S){var v=g[El]();S[yo](g.getCfg(),v,m,g[qo]()),f=_getPluginState(S),S[El]||f[El]||(f[El]=v),f[Io]=!0,delete f[Bo]}))}function sortPlugins(g){return g.sort((function(g,m){var f=0;if(m){var S=isFunction2(m[Pl]);isFunction2(g[Pl])?f=S?g[Rl]-m[Rl]:1:S&&(f=-1)}else f=g?1:-1;return f}))}function createDistributedTraceContext(g){var m={};return{getName:function(){return m[Co]},setName:function(f){g&&g.setName(f),m[Co]=f},getTraceId:function(){return m[Sl]},setTraceId:function(f){g&&g.setTraceId(f),isValidTraceId(f)&&(m[Sl]=f)},getSpanId:function(){return m[vl]},setSpanId:function(f){g&&g.setSpanId(f),isValidSpanId(f)&&(m[vl]=f)},getTraceFlags:function(){return m[yl]},setTraceFlags:function(f){g&&g.setTraceFlags(f),m[yl]=f}}}var kd="TelemetryPluginChain",Ld="_hasRun",Fd="_getTelCtx",xd=0;function _getNextProxyStart(g,m,f){for(;g;){if(g[Fo]()===f)return g;g=g[qo]()}return createTelemetryProxyChain([f],m[bo]||{},m)}function _createInternalContext(g,m,f,S){var v=null,C=[];null!==S&&(v=S?_getNextProxyStart(g,f,S):g);var _={_next:_moveNext,ctx:{core:function(){return f},diagLog:function(){return safeGetLogger(f,m)},getCfg:function(){return m},getExtCfg:_getExtCfg,getConfig:_getConfig,hasNext:function(){return!!v},getNext:function(){return v},setNext:function(g){v=g},iterate:_iterateChain,onComplete:_addOnComplete}};function _addOnComplete(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];g&&C[To]({func:g,self:isUndefined3(m)?_.ctx:m,args:f})}function _moveNext(){var g=v;if(v=g?g[qo]():null,!g){var m=C;m&&m[Ro]>0&&(arrForEach(m,(function(g){try{g.func[cl](g.self,g.args)}catch(g){_throwInternal(f[Po],2,73,"Unexpected Exception during onComplete - "+dumpObj(g))}})),C=[])}return g}function _getExtCfg(g,f,S){var v;if(void 0===f&&(f={}),void 0===S&&(S=0),m){var C=m[bl];C&&g&&(v=C[g])}if(v){if(isObject3(f)&&0!==S){var _=objExtend(!0,f,v);m&&2===S&&objForEachKey(f,(function(g){if(isNullOrUndefined(_[g])){var f=m[g];isNullOrUndefined(f)||(_[g]=f)}})),v=_}}else v=f;return v}function _getConfig(g,f,S){var v;void 0===S&&(S=!1);var C=_getExtCfg(g,null);return C&&!isNullOrUndefined(C[f])?v=C[f]:m&&!isNullOrUndefined(m[f])&&(v=m[f]),isNullOrUndefined(v)?S:v}function _iterateChain(g){for(var m;m=_._next();){var f=m[Fo]();f&&g(f)}}return _}function createProcessTelemetryContext(g,m,f,S){var v=_createInternalContext(g,m,f,S),C=v.ctx;function _processNext(g){var m=v._next();return m&&m[Pl](g,C),!m}function _createNew(g,S){return void 0===g&&(g=null),ac(g)&&(g=createTelemetryProxyChain(g,m,f,S)),createProcessTelemetryContext(g||C[qo](),m,f,S)}return C[Mo]=_processNext,C[Jo]=_createNew,C}function createProcessTelemetryUnloadContext(g,m,f){var S=m[bo]||{},v=_createInternalContext(g,S,m,f),C=v.ctx;function _processNext(g){var m=v._next();return m&&m.unload(C,g),!m}function _createNew(g,f){return void 0===g&&(g=null),ac(g)&&(g=createTelemetryProxyChain(g,S,m,f)),createProcessTelemetryUnloadContext(g||C[qo](),m,f)}return C[Mo]=_processNext,C[Jo]=_createNew,C}function createProcessTelemetryUpdateContext(g,m,f){var S=m[bo]||{},v=_createInternalContext(g,S,m,f).ctx;function _processNext(g){return v.iterate((function(m){isFunction2(m[Wo])&&m[Wo](v,g)}))}function _createNew(g,f){return void 0===g&&(g=null),ac(g)&&(g=createTelemetryProxyChain(g,S,m,f)),createProcessTelemetryUpdateContext(g||v[qo](),m,f)}return v[Mo]=_processNext,v[Jo]=_createNew,v}function createTelemetryProxyChain(g,m,f,S){var v=null,C=!S;if(ac(g)&&g[Ro]>0){var _=null;arrForEach(g,(function(g){if(C||S!==g||(C=!0),C&&g&&isFunction2(g[Pl])){var E=createTelemetryPluginProxy(g,m,f);v||(v=E),_&&_._setNext(E),_=E}}))}return S&&!v?createTelemetryProxyChain([S],m,f):v}function createTelemetryPluginProxy(g,m,f){var S,v=null,C=isFunction2(g[Pl]),_=isFunction2(g[Ko]),E={getPlugin:function(){return g},getNext:function(){return v},processTelemetry:_processTelemetry,unload:_unloadPlugin,update:_updatePlugin,_id:S=g?g[Eo]+"-"+g[Rl]+"-"+xd++:"Unknown-0-"+xd++,_setNext:function(g){v=g}};function _getTelCtx(){var S;return g&&isFunction2(g[Fd])&&(S=g[Fd]()),S||(S=createProcessTelemetryContext(E,m,f)),S}function _processChain(m,f,C,_,E){var T=!1,I=g?g[Eo]:kd,b=m[Ld];return b||(b=m[Ld]={}),m.setNext(v),g&&doPerf(m[El](),(function(){return I+":"+C}),(function(){b[S]=!0;try{var g=v?v._id:Cl;g&&(b[g]=!1),T=f(m)}catch(g){var _=!v||b[v._id];_&&(T=!0),v&&_||_throwInternal(m[zo](),1,73,"Plugin ["+I+"] failed during "+C+" - "+dumpObj(g)+", run flags: "+dumpObj(b))}}),_,E),T}function _processTelemetry(m,f){function _callProcessTelemetry(f){if(!g||!C)return!1;var S=_getPluginState(g);return!S[Bo]&&!S[Il]&&(_&&g[Ko](v),g[Pl](m,f),!0)}_processChain(f=f||_getTelCtx(),_callProcessTelemetry,"processTelemetry",(function(){return{item:m}}),!m.sync)||f[Mo](m)}function _unloadPlugin(m,f){function _callTeardown(){var S=!1;if(g){var v=_getPluginState(g),C=g[El]||v[El];!g||C&&C!==m.core()||v[Bo]||(v[El]=null,v[Bo]=!0,v[Io]=!1,g[Bo]&&!0===g[Bo](m,f)&&(S=!0))}return S}_processChain(m,_callTeardown,"unload",(function(){}),f[Go])||m[Mo](f)}function _updatePlugin(m,f){function _callUpdate(){var S=!1;if(g){var v=_getPluginState(g),C=g[El]||v[El];!g||C&&C!==m.core()||v[Bo]||g[Wo]&&!0===g[Wo](m,f)&&(S=!0)}return S}_processChain(m,_callUpdate,"update",(function(){}),!1)||m[Mo](f)}return cc(E)}var Ud=function(){function ProcessTelemetryContext2(g,m,f,S){var v=this,C=createProcessTelemetryContext(g,m,f,S);proxyFunctions(v,C,objKeys(C))}return ProcessTelemetryContext2}(),Vd=500,Bd="Channel has invalid priority - ";function _addChannelQueue(g,m,f){m&&ac(m)&&m[Ro]>0&&(arrForEach(m=m.sort((function(g,m){return g[Rl]-m[Rl]})),(function(g){g[Rl]<Vd&&throwError(Bd+g[Eo])})),g[To]({queue:cc(m),chain:createTelemetryProxyChain(m,f[bo],f)}))}function createChannelControllerPlugin(g,m){function _getTelCtx(){return createProcessTelemetryContext(null,m[bo],m,null)}function _processChannelQueue(g,m,f,S){var v=g?g[Ro]+1:1;function _runChainOnComplete(){0===--v&&(S&&S(),S=null)}v>0&&arrForEach(g,(function(g){if(g&&g.queue[Ro]>0){var S=g.chain,C=m[Jo](S);C[Lo](_runChainOnComplete),f(C)}else v--})),_runChainOnComplete()}function _doUpdate(m,f){var S=f||{reason:0};return _processChannelQueue(g,m,(function(g){g[Mo](S)}),(function(){m[Mo](S)})),!0}function _doTeardown(m,S){var v=S||{reason:0,isAsync:!1};return _processChannelQueue(g,m,(function(g){g[Mo](v)}),(function(){m[Mo](v),f=!1})),!0}function _getChannel(m){var f=null;return g&&g[Ro]>0&&arrForEach(g,(function(g){if(g&&g.queue[Ro]>0&&(arrForEach(g.queue,(function(g){if(g[Eo]===m)return f=g,-1})),f))return-1})),f}var f=!1;return{identifier:"ChannelControllerPlugin",priority:Vd,initialize:function(m,S,v,C){f=!0,arrForEach(g,(function(g){g&&g.queue[Ro]>0&&initializePlugins(createProcessTelemetryContext(g.chain,m,S),v)}))},isInitialized:function(){return f},processTelemetry:function(m,f){_processChannelQueue(g,f||_getTelCtx(),(function(g){g[Mo](m)}),(function(){f[Mo](m)}))},update:_doUpdate,pause:function(){_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){g.pause&&g.pause()}))}),null)},resume:function(){_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){g.resume&&g.resume()}))}),null)},teardown:_doTeardown,getChannel:_getChannel,flush:function(m,f,S,v){var C=1,_=!1,E=null;function doCallback(){C--,_&&0===C&&(E&&(clearTimeout(E),E=null),f&&f(_),f=null)}return v=v||5e3,_processChannelQueue(g,_getTelCtx(),(function(g){g.iterate((function(g){if(g[xo]){C++;var f=!1;g[xo](m,(function(){f=!0,doCallback()}),S)||f||(m&&null==E?E=setTimeout((function(){E=null,doCallback()}),v):doCallback())}}))}),(function(){_=!0,doCallback()})),!0},_setQueue:function(m){g=m}}}function createChannelQueues(g,m,f){var S=[];if(g&&arrForEach(g,(function(g){return _addChannelQueue(S,g,f)})),m){var v=[];arrForEach(m,(function(g){g[Rl]>Vd&&v[To](g)})),_addChannelQueue(S,v,f)}return S}function createUnloadHandlerContainer(){var g=[];function _addHandler(m){m&&g[To](m)}function _runHandlers(m,f){arrForEach(g,(function(g){try{g(m,f)}catch(g){_throwInternal(m[zo](),2,73,"Unexpected error calling unload handler - "+dumpObj(g))}})),g=[]}return{add:_addHandler,run:_runHandlers}}var Hd="getPlugin",$d=function(){function BaseTelemetryPlugin2(){var g,m,f,S,v,C=this;function _getTelCtx(g){void 0===g&&(g=null);var S=g;if(!S){var v=m||createProcessTelemetryContext(null,{},C[El]);S=f&&f[Hd]?v[Jo](null,f[Hd]):v[Jo](null,f)}return S}function _setDefaults(g,S,v){g&&setValue(g,bl,[],null,isNullOrUndefined),!v&&S&&(v=S[Do]()[qo]());var _=f;f&&f[Hd]&&(_=f[Hd]()),C[El]=S,m=createProcessTelemetryContext(v,g,S,_)}function _initDefaults(){g=!1,C[El]=null,m=null,f=null,v=[],S=createUnloadHandlerContainer()}_initDefaults(),dynamicProto(BaseTelemetryPlugin2,C,(function(m){m[yo]=function(m,f,S,v){_setDefaults(m,f,v),g=!0},m[Bo]=function(g,C){var _,E=m[El];if(E&&(!g||E===g[El]())){var T,I=!1,b=g||createProcessTelemetryUnloadContext(null,E,f&&f[Hd]?f[Hd]():f),A=C||((_={reason:0})[Go]=!1,_);return m[jo]&&!0===m[jo](b,A,_unloadCallback)?T=!0:_unloadCallback(),T}function _unloadCallback(){if(!I){I=!0,S.run(b,C);var g=v;v=[],arrForEach(g,(function(g){g.rm()})),!0===T&&b[Mo](A),_initDefaults()}}},m[Wo]=function(g,S){var v=m[El];if(v&&(!g||v===g[El]())){var C,_=!1,E=g||createProcessTelemetryUpdateContext(null,v,f&&f[Hd]?f[Hd]():f),T=S||{reason:0};return m._doUpdate&&!0===m._doUpdate(E,T,_updateCallback)?C=!0:_updateCallback(),C}function _updateCallback(){_||(_=!0,_setDefaults(E.getCfg(),E.core(),E[qo]()))}},m._addHook=function(g){g&&(ac(g)?v=v.concat(g):v[To](g))},proxyFunctionAs(m,"_addUnloadCb",(function(){return S}),"add")})),C[zo]=function(g){return _getTelCtx(g)[zo]()},C[Io]=function(){return g},C.setInitialized=function(m){g=m},C[Ko]=function(g){f=g},C[Mo]=function(g,m){m?m[Mo](g):f&&isFunction2(f[Pl])&&f[Pl](g,null)},C._getTelCtx=_getTelCtx}return BaseTelemetryPlugin2.__ieDyn=1,BaseTelemetryPlugin2}(),Gd=function(g){function TelemetryInitializerPlugin2(){var m,f,S=g.call(this)||this;function _initDefaults(){m=0,f=[]}return S.identifier="TelemetryInitializerPlugin",S.priority=199,_initDefaults(),dynamicProto(TelemetryInitializerPlugin2,S,(function(g,S){g.addTelemetryInitializer=function(g){var S={id:m++,fn:g};return f[To](S),{remove:function(){arrForEach(f,(function(g,m){if(g.id===S.id)return f[Vo](m,1),-1}))}}},g[Pl]=function(m,S){for(var v=!1,C=f[Ro],_=0;_<C;++_){var E=f[_];if(E)try{if(!1===E.fn[rl](null,[m])){v=!0;break}}catch(g){_throwInternal(S[zo](),1,64,"One of telemetry initializers failed, telemetry item will not be sent: "+getExceptionName(g),{exception:dumpObj(g)},!0)}}v||g[Mo](m,S)},g[jo]=function(){_initDefaults()}})),S}return __extendsFn(TelemetryInitializerPlugin2,g),TelemetryInitializerPlugin2.__ieDyn=1,TelemetryInitializerPlugin2}($d),jd="Plugins must provide initialize method",Wd="_notificationManager",qd="SDK is still unloading...",zd="SDK is not initialized",Kd={loggingLevelConsole:1};function _createPerfManager(g,m){return new $c(m)}function _validateExtensions(g,m,f){var S,v=[],C={};return arrForEach(f,(function(f){(isNullOrUndefined(f)||isNullOrUndefined(f[yo]))&&throwError(jd);var S=f[Rl],_=f[Eo];f&&S&&(isNullOrUndefined(C[S])?C[S]=_:_warnToConsole(g,"Two extensions have same priority #"+S+" - "+C[S]+", "+_)),(!S||S<m)&&v[To](f)})),(S={all:f})[El]=v,S}function _isPluginPresent(g,m){var f=!1;return arrForEach(m,(function(m){if(m===g)return f=!0,-1})),f}function _createDummyNotificationManager(){var g;return objCreateFn(((g={})[Oo]=function(g){},g[No]=function(g){},g[wl]=function(g){},g[Ml]=function(g,m){},g[Dl]=function(g,m){},g))}var Jd=function(){function BaseCore2(){var g,m,f,S,v,C,_,E,T,I,b,A,P,R,w,M,D,O,N,k,L=0;dynamicProto(BaseCore2,this,(function(F){function _initDefaults(){m=!1,g=objExtend(!0,{},Kd),F[bo]=g,F[Po]=new Fc(g),F[Uo]=[],w=new Gd,f=[],S=null,v=null,C=null,_=null,E=null,I=null,T=[],b=null,A=null,P=null,R=!1,M=null,D=createUniqueNamespace("AIBaseCore",!0),O=createUnloadHandlerContainer(),k=null}function _createTelCtx(){return createProcessTelemetryContext(_getPluginChain(),g,F)}function _initPluginChain(m){var f=_validateExtensions(F[Po],Vd,T);I=f[El],E=null;var S=f.all;if(P=cc(createChannelQueues(A,S,F)),b){var v=arrIndexOf(S,b);-1!==v&&S[Vo](v,1),-1!==(v=arrIndexOf(I,b))&&I[Vo](v,1),b._setQueue(P)}else b=createChannelControllerPlugin(P,F);S[To](b),I[To](b),F[Uo]=sortPlugins(S),b[yo](g,F,S),initializePlugins(_createTelCtx(),S),F[Uo]=cc(sortPlugins(I||[])).slice(),m&&_doUpdate(m)}function _getPlugin(g){var m,f=null,S=null;return arrForEach(F[Uo],(function(m){if(m[Eo]===g&&m!==b&&m!==w)return S=m,-1})),!S&&b&&(S=b.getChannel(g)),S&&((m={plugin:S})[tl]=function(g){_getPluginState(S)[Il]=!g},m.isEnabled=function(){var g=_getPluginState(S);return!g[Bo]&&!g[Il]},m.remove=function(g,m){var f;void 0===g&&(g=!0);var v=[S],C=((f={reason:1})[Go]=g,f);_removePlugins(v,C,(function(g){g&&_initPluginChain({reason:32,removed:v}),m&&m(g)}))},f=m),f}function _getPluginChain(){if(!E){var m=(I||[]).slice();-1===arrIndexOf(m,w)&&m[To](w),E=createTelemetryProxyChain(sortPlugins(m),g,F)}return E}function _removePlugins(m,f,S){if(m&&m[Ro]>0){var v=createProcessTelemetryUnloadContext(createTelemetryProxyChain(m,g,F),F);v[Lo]((function(){var g=!1,f=[];arrForEach(T,(function(S,v){_isPluginPresent(S,m)?g=!0:f[To](S)})),T=f;var v=[];A&&(arrForEach(A,(function(f,S){var C=[];arrForEach(f,(function(f){_isPluginPresent(f,m)?g=!0:C[To](f)})),v[To](C)})),A=v),S&&S(g)})),v[Mo](f)}else S(!1)}function _flushInternalLogs(){var m=F[Po]?F[Po].queue:[];m&&(arrForEach(m,(function(m){var f,S=((f={})[Co]=M||"InternalMessageId: "+m[Ho],f.iKey=getCfgValue(g[Ao]),f.time=toISOString(new Date),f.baseType=Lc.dataType,f.baseData={message:m[$o]},f);F.track(S)})),m[Ro]=0)}function _flushChannels(g,m,f,S){return b?b[xo](g,m,f||6,S):(m&&m(!1),!0)}function _initDebugListener(){var m=getCfgValue(g.disableDbgExt);!0===m&&N&&(S[No](N),N=null),S&&!N&&!0!==m&&(N=getDebugListener(g),S[Oo](N))}function _initPerfManager(){var m=getCfgValue(g.enablePerfMgr);!m&&C&&(C=null),m&&getSetValue(g,Tl,_createPerfManager)}function _initExtConfig(){getSetValue(g,bl,{}).NotificationManager=S}function _doUpdate(g){var m=createProcessTelemetryUpdateContext(_getPluginChain(),F);F._updateHook&&!0===F._updateHook(m,g)||m[Mo](g)}function _logOrThrowError(g){var m=F[Po];m?_throwInternal(m,2,73,g):throwError(g)}_initDefaults(),F[Io]=function(){return m},F[yo]=function(f,v,C,_){R&&throwError(qd),F[Io]()&&throwError("Core should not be initialized more than once"),g=f||{},F[bo]=g,isNullOrUndefined(f[Ao])&&throwError("Please provide instrumentation key"),S=_,F[Wd]=_,_initDebugListener(),_initPerfManager(),_initExtConfig(),C&&(F[Po]=C);var E=getSetValue(g,Al,[]);(T=[])[To].apply(T,__spreadArrayFn(__spreadArrayFn([],v,!1),E)),A=getSetValue(g,_l,[]),_initPluginChain(null),P&&0!==P[Ro]||throwError("No "+_l+" available"),m=!0,F.releaseQueue()},F.getTransmissionControls=function(){var g=[];return P&&arrForEach(P,(function(m){g[To](m.queue)})),cc(g)},F.track=function(m){m.iKey=m.iKey||g[Ao],m[wo]=m[wo]||toISOString(new Date),m.ver=m.ver||"4.0",!R&&F[Io]()?_createTelCtx()[Mo](m):f[To](m)},F[Do]=_createTelCtx,F[_o]=function(){return S||(S=_createDummyNotificationManager(),F[Wd]=S),S},F[Oo]=function(g){S&&S[Oo](g)},F[No]=function(g){S&&S[No](g)},F.getCookieMgr=function(){return _||(_=createCookieMgr(g,F[Po])),_},F.setCookieMgr=function(g){_=g},F[Ll]=function(){if(!v&&!C&&getCfgValue(g.enablePerfMgr)){var m=getCfgValue(g[Tl]);isFunction2(m)&&(C=m(F,F[_o]()))}return v||C||getGblPerfMgr()},F.setPerfMgr=function(g){v=g},F.eventCnt=function(){return f[Ro]},F.releaseQueue=function(){if(m&&f[Ro]>0){var g=f;f=[],arrForEach(g,(function(g){_createTelCtx()[Mo](g)}))}},F.pollInternalLogs=function(m){M=m||null;var f=getCfgValue(g.diagnosticLogInterval);return f&&f>0||(f=1e4),L&&clearInterval(L),L=setInterval((function(){_flushInternalLogs()}),f)},F[ko]=function(){L&&(clearInterval(L),L=0,_flushInternalLogs())},proxyFunctions(F,(function(){return w}),["addTelemetryInitializer"]),F.unload=function(g,f,S){var v;void 0===g&&(g=!0),m||throwError(zd),R&&throwError(qd);var C=((v={reason:50})[Go]=g,v.flushComplete=!1,v),_=createProcessTelemetryUnloadContext(_getPluginChain(),F);function _doUnload(g){C.flushComplete=g,R=!0,O.run(_,C),F[ko](),_[Mo](C)}_[Lo]((function(){_initDefaults(),f&&f(C)}),F),_flushChannels(g,_doUnload,6,S)||_doUnload(!1)},F[Fo]=_getPlugin,F.addPlugin=function(g,m,f,S){if(!g)return S&&S(!1),void _logOrThrowError(jd);var v=_getPlugin(g[Eo]);if(v&&!m)return S&&S(!1),void _logOrThrowError("Plugin ["+g[Eo]+"] is already loaded!");var C={reason:16};function _addPlugin(m){T[To](g),C.added=[g],_initPluginChain(C),S&&S(!0)}if(v){var _=[v.plugin];_removePlugins(_,{reason:2,isAsync:!!f},(function(g){g?(C.removed=_,C.reason|=32,_addPlugin()):S&&S(!1)}))}else _addPlugin()},F.evtNamespace=function(){return D},F[xo]=_flushChannels,F.getTraceCtx=function(g){return k||(k=createDistributedTraceContext()),k},F.setTraceCtx=function(g){k=g||null},proxyFunctionAs(F,"addUnloadCb",(function(){return O}),"add")}))}return BaseCore2.__ieDyn=1,BaseCore2}();function _runListeners(g,m,f,S){arrForEach(g,(function(g){if(g&&g[m])if(f)setTimeout((function(){return S(g)}),0);else try{S(g)}catch(g){}}))}var Yd,Qd,Xd=function(){function NotificationManager2(g){this.listeners=[];var m=!!(g||{}).perfEvtsSendAll;dynamicProto(NotificationManager2,this,(function(g){g[Oo]=function(m){g.listeners[To](m)},g[No]=function(m){for(var f=arrIndexOf(g[ul],m);f>-1;)g.listeners[Vo](f,1),f=arrIndexOf(g[ul],m)},g[wl]=function(m){_runListeners(g[ul],wl,!0,(function(g){g[wl](m)}))},g[Ml]=function(m,f){_runListeners(g[ul],Ml,!0,(function(g){g[Ml](m,f)}))},g[Dl]=function(m,f){_runListeners(g[ul],Dl,f,(function(g){g[Dl](m,f)}))},g[Ol]=function(f){f&&(!m&&f[gl]()||_runListeners(g[ul],Ol,!1,(function(g){f[Go]?setTimeout((function(){return g[Ol](f)}),0):g[Ol](f)})))}}))}return NotificationManager2.__ieDyn=1,NotificationManager2}(),Zd=function(g){function AppInsightsCore3(){var m=g.call(this)||this;return dynamicProto(AppInsightsCore3,m,(function(g,m){function _validateTelemetryItem(g){isNullOrUndefined(g[Co])&&(_notifyInvalidEvent(g),throwError("telemetry name required"))}function _notifyInvalidEvent(m){var f=g[_o]();f&&f[Ml]([m],2)}g[yo]=function(g,f,S,v){m[yo](g,f,S||new Fc(g),v||new Xd(g))},g.track=function(f){doPerf(g[Ll](),(function(){return"AppInsightsCore:track"}),(function(){null===f&&(_notifyInvalidEvent(f),throwError("Invalid telemetry item")),_validateTelemetryItem(f),m.track(f)}),(function(){return{item:f}}),!f.sync)}})),m}return __extendsFn(AppInsightsCore3,g),AppInsightsCore3.__ieDyn=1,AppInsightsCore3}(Jd),eh="Failed",th=eh+"MonitorAjax",ih="Track",nh="Start",rh="Stop",sh="Event",ah="AuthContext",oh="Exception",lh="Local",ch="Session",dh="Storage",hh="Browser",uh="Cannot",gh="Buffer",ph="InstrumentationKey",mh=(createEnumStyle({CRITICAL:1,WARNING:2}),createEnumStyle(((Yd={})[hh+"DoesNotSupport"+lh+dh]=0,Yd[hh+uh+"Read"+lh+dh]=1,Yd[hh+uh+"Read"+ch+dh]=2,Yd[hh+uh+"Write"+lh+dh]=3,Yd[hh+uh+"Write"+ch+dh]=4,Yd[hh+eh+"RemovalFrom"+lh+dh]=5,Yd[hh+eh+"RemovalFrom"+ch+dh]=6,Yd[uh+"SendEmptyTelemetry"]=7,Yd.ClientPerformanceMathError=8,Yd["ErrorParsingAI"+ch+"Cookie"]=9,Yd.ErrorPVCalc=10,Yd[oh+"WhileLoggingError"]=11,Yd[eh+"AddingTelemetryTo"+gh]=12,Yd[th+"Abort"]=13,Yd[th+"Dur"]=14,Yd[th+"Open"]=15,Yd[th+"RSC"]=16,Yd[th+"Send"]=17,Yd[th+"GetCorrelationHeader"]=18,Yd[eh+"ToAddHandlerForOnBeforeUnload"]=19,Yd[eh+"ToSendQueuedTelemetry"]=20,Yd[eh+"ToReportDataLoss"]=21,Yd["Flush"+eh]=22,Yd.MessageLimitPerPVExceeded=23,Yd.MissingRequiredFieldSpecification=24,Yd.NavigationTimingNotSupported=25,Yd.OnError=26,Yd[ch+"RenewalDateIsZero"]=27,Yd.SenderNotInitialized=28,Yd[nh+ih+sh+eh]=29,Yd[rh+ih+sh+eh]=30,Yd[nh+ih+eh]=31,Yd[rh+ih+eh]=32,Yd.TelemetrySampledAndNotSent=33,Yd[ih+sh+eh]=34,Yd[ih+oh+eh]=35,Yd[ih+"Metric"+eh]=36,Yd[ih+"PV"+eh]=37,Yd[ih+"PV"+eh+"Calc"]=38,Yd[ih+"Trace"+eh]=39,Yd["Transmission"+eh]=40,Yd[eh+"ToSet"+dh+gh]=41,Yd[eh+"ToRestore"+dh+gh]=42,Yd.InvalidBackendResponse=43,Yd[eh+"ToFixDepricatedValues"]=44,Yd.InvalidDurationValue=45,Yd.TelemetryEnvelopeInvalid=46,Yd.CreateEnvelopeError=47,Yd[uh+"SerializeObject"]=48,Yd[uh+"SerializeObjectNonSerializable"]=49,Yd.CircularReferenceDetected=50,Yd["Clear"+ah+eh]=51,Yd[oh+"Truncated"]=52,Yd.IllegalCharsInName=53,Yd.ItemNotInArray=54,Yd.MaxAjaxPerPVExceeded=55,Yd.MessageTruncated=56,Yd.NameTooLong=57,Yd.SampleRateOutOfRange=58,Yd["Set"+ah+eh]=59,Yd["Set"+ah+eh+"AccountName"]=60,Yd.StringValueTooLong=61,Yd.StartCalledMoreThanOnce=62,Yd.StopCalledWithoutStart=63,Yd["TelemetryInitializer"+eh]=64,Yd.TrackArgumentsNotSpecified=65,Yd.UrlTooLong=66,Yd[ch+dh+gh+"Full"]=67,Yd[uh+"AccessCookie"]=68,Yd.IdTooLong=69,Yd.InvalidEvent=70,Yd[th+"SetRequestHeader"]=71,Yd["Send"+hh+"InfoOnUserInit"]=72,Yd["Plugin"+oh]=73,Yd["Notification"+oh]=74,Yd.SnippetScriptLoadFailure=99,Yd["Invalid"+ph]=100,Yd[uh+"ParseAiBlobValue"]=101,Yd.InvalidContentBlob=102,Yd[ih+"PageAction"+sh+eh]=103,Yd[eh+"AddingCustomDefinedRequestContext"]=104,Yd["InMemory"+dh+gh+"Full"]=105,Yd[ph+"Deprecation"]=106,Yd))),fh=(createEnumStyle({NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32}),createEnumStyle({Normal:1,CostDeferred:2,RealTime:3,Immediate:4})),Sh=(createEnumStyle({Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9}),createEnumStyle({Normal:1,Critical:2})),vh=(createEnumStyle({NONE:0,ERROR:1,WARNING:2,INFORMATION:3}),cc(Ka(Ka({},mh),createEnumStyle({AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}))),""),yh="https://browser.events.data.microsoft.com/OneCollector/1.0/",Ch="version",_h="properties",Eh="1DS-Web-JS-"+"3.2.9",Th="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",Ih="withCredentials",bh="timeout",Ah=((Qd={})[0]=0,Qd[2]=6,Qd[1]=1,Qd[3]=7,Qd[4098]=6,Qd[4097]=1,Qd[4099]=7,Qd);Boolean(getDocument()),Boolean(getWindow());function isValueAssigned(g){return!(g===vh||isNullOrUndefined(g))}function getTenantId(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return vh}function isLatency(g){return!!(g&&isNumber3(g)&&g>=1&&g<=4)}function sanitizeProperty(g,m,f){if(!m&&!isValueAssigned(m)||"string"!=typeof g)return null;var S=typeof m;if("string"===S||"number"===S||"boolean"===S||ac(m))m={value:m};else if("object"!==S||Wa.call(m,"value")){if(isNullOrUndefined(m.value)||m.value===vh||!isString2(m.value)&&!isNumber3(m.value)&&!isBoolean2(m.value)&&!ac(m.value))return null}else m={value:f?JSON.stringify(m):m};if(ac(m.value)&&!isArrayValid(m.value))return null;if(!isNullOrUndefined(m.kind)){if(ac(m.value)||!isValueKind(m.kind))return null;m.value=m.value.toString()}return m}function getCommonSchemaMetaData(g,m,f){var S=-1;if(!isUndefined3(g))if(m>0&&(32===m?S=8192:m<=13&&(S=m<<5)),isDataType(f))-1===S&&(S=0),S|=f;else{var v=Ah[getFieldValueType(g)]||-1;-1!==S&&-1!==v?S|=v:6===v&&(S=v)}return S}function getCookieValue(g,m,f){var S;return void 0===f&&(f=!0),g&&(S=g.get(m),f&&S&&decodeURIComponent&&(S=decodeURIComponent(S))),S||vh}function createGuid(g){void 0===g&&(g="D");var m=newGuid2();return"B"===g?m="{"+m+"}":"P"===g?m="("+m+")":"N"===g&&(m=m.replace(/-/g,vh)),m}function extend(g,m,f,S,v){var C={},_=!1,E=0,T=arguments.length,I=arguments;for("[object Boolean]"===Object[Ua].toString.call(I[0])&&(_=I[0],E++);E<T;E++){objForEachKey(I[E],(function(g,m){_&&m&&isObject3(m)?ac(m)?(C[g]=C[g]||[],arrForEach(m,(function(m,f){m&&isObject3(m)?C[g][f]=extend(!0,C[g][f],m):C[g][f]=m}))):C[g]=extend(!0,C[g],m):C[g]=m}))}return C}var Ph=perfNow;function isValueKind(g){return 0===g||g>0&&g<=13||32===g}function isDataType(g){return g>=0&&g<=9}function isArrayValid(g){return g.length>0}function setProcessTelemetryTimings(g,m){var f=g;f.timings=f.timings||{},f.timings.processTelemetryStart=f.timings.processTelemetryStart||{},f.timings.processTelemetryStart[m]=Ph()}function getFieldValueType(g){var m=0;if(null!=g){var f=typeof g;"string"===f?m=1:"number"===f?m=2:"boolean"===f?m=3:f===Fa&&(m=4,ac(g)?(m=4096,g.length>0&&(m|=getFieldValueType(g[0]))):Wa.call(g,"value")&&(m=8192|getFieldValueType(g.value)))}return m}function isChromium(){return!!getGlobalInst("chrome")}function openXhr(g,m,f,S,v,C){function _wrapSetXhrProp(g,m,f){try{g[m]=f}catch(g){}}void 0===S&&(S=!1),void 0===v&&(v=!1);var _=new XMLHttpRequest;return S&&_wrapSetXhrProp(_,Th,S),f&&_wrapSetXhrProp(_,Ih,f),_.open(g,m,!v),f&&_wrapSetXhrProp(_,Ih,f),!v&&C&&_wrapSetXhrProp(_,bh,C),_}var Rh=function(g){function AppInsightsCore3(){var m=g.call(this)||this;return m.pluginVersionStringArr=[],dynamicProto(AppInsightsCore3,m,(function(g,m){g.logger&&g.logger.queue||(g.logger=new Fc({loggingLevelConsole:1})),g.initialize=function(f,S,v,C){doPerf(g,(function(){return"AppInsightsCore.initialize"}),(function(){var _=g.pluginVersionStringArr;if(f){f.endpointUrl||(f.endpointUrl=yh);var E=f.propertyStorageOverride;!E||E.getProperty&&E.setProperty||throwError("Invalid property storage override passed."),f.channels&&arrForEach(f.channels,(function(g){g&&arrForEach(g,(function(g){if(g.identifier&&g.version){var m=g.identifier+"="+g.version;_.push(m)}}))}))}g.getWParam=function(){return"undefined"!=typeof document||f.enableWParam?0:-1},S&&arrForEach(S,(function(g){if(g&&g.identifier&&g.version){var m=g.identifier+"="+g.version;_.push(m)}})),g.pluginVersionString=_.join(";"),g.pluginVersionStringArr=_;try{m.initialize(f,S,v,C),g.pollInternalLogs("InternalLog")}catch(m){var T=g.logger,I=dumpObj(m);-1!==I.indexOf("channels")&&(I+="\n - Channels must be provided through config.channels only!"),_throwInternal(T,1,514,"SDK Initialization Failed - no telemetry will be sent: "+I)}}),(function(){return{config:f,extensions:S,logger:v,notificationManager:C}}))},g.track=function(f){doPerf(g,(function(){return"AppInsightsCore.track"}),(function(){var S=f;if(S){S.timings=S.timings||{},S.timings.trackStart=Ph(),isLatency(S.latency)||(S.latency=1);var v=S.ext=S.ext||{};v.sdk=v.sdk||{},v.sdk.ver=Eh;var C=S.baseData=S.baseData||{};C[_h]=C[_h]||{};var _=C[_h];_[Ch]=_[Ch]||g.pluginVersionString||vh}m.track(S)}),(function(){return{item:f}}),!f.sync)}})),m}return __extendsFn(AppInsightsCore3,g),AppInsightsCore3.__ieDyn=1,AppInsightsCore3}(Zd),wh=isFunction2;function _createPromiseAllOnResolvedFunction(g,m,f){return function(S){g[m]=S,f()}}var Mh=function(){function ESPromise2(g){var m=0,f=null,S=[];function _enqueue(g,v,C,_){S.push((function(){var S;try{(S=1===m?wh(g)?g(f):f:wh(v)?v(f):f)instanceof ESPromise2?S.then(C,_):2!==m||wh(v)?C(S):_(S)}catch(g){return void _(g)}})),0!==m&&_processQueue()}function _processQueue(){if(S.length>0){var g=S.slice();S=[],setTimeout((function(){for(var m=0,f=g.length;m<f;++m)try{g[m]()}catch(g){}}),0)}}function _resolve(g){0===m&&(f=g,m=1,_processQueue())}function _reject(g){0===m&&(f=g,m=2,_processQueue())}dynamicProto(ESPromise2,this,(function(g){g.then=function(g,m){return new ESPromise2((function(f,S){_enqueue(g,m,f,S)}))},g.catch=function(m){return g.then(null,m)}})),function _initialize(){if(!wh(g))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{g(_resolve,_reject)}catch(g){_reject(g)}}()}return ESPromise2.resolve=function(g){return g instanceof ESPromise2?g:g&&wh(g.then)?new ESPromise2((function(m,f){try{g.then(m,f)}catch(g){f(g)}})):new ESPromise2((function(m){m(g)}))},ESPromise2.reject=function(g){return new ESPromise2((function(m,f){f(g)}))},ESPromise2.all=function(g){if(g&&g.length)return new ESPromise2((function(m,f){try{for(var S=[],v=0,C=0;C<g.length;C++){var _=g[C];_&&wh(_.then)?(v++,_.then(_createPromiseAllOnResolvedFunction(S,C,(function(){0==--v&&m(S)})),f)):S[C]=_}0===v&&setTimeout((function(){m(S)}),0)}catch(g){f(g)}}))},ESPromise2.race=function(g){return new ESPromise2((function(m,f){if(g&&g.length)try{for(var _loop_1=function(S){var v=g[S];v&&wh(v.then)?v.then(m,f):setTimeout((function(){m(v)}),0)},S=0;S<g.length;S++)_loop_1(S)}catch(g){f(g)}}))},ESPromise2}(),Dh=Mh,Oh=6e5,Nh=0,kh=[],Lh=[],Fh=[];function _getTime(){return(new Date).getTime()}var xh,Uh=function(){function ESPromiseScheduler2(g,m){var f=0,S=(g||"<unnamed>")+"."+Nh;function _debugLog2(g){var m=getGlobal();m&&m.QUnit&&console&&console.log("ESPromiseScheduler["+S+"] "+g)}function _warnLog2(g){_warnToConsole(m,"ESPromiseScheduler["+S+"] "+g)}Nh++,dynamicProto(ESPromiseScheduler2,this,(function(g){var m=null,v=0;function _removeQueuedEvent(g,m){for(var f=0;f<g.length;f++)if(g[f].id===m)return g.splice(f,1)[0];return null}g.scheduleEvent=function(g,C,_){var E=S+"."+v;v++,C&&(E+="-("+C+")");var T=E+"{"+f+"}";f++;var I={evt:null,tm:_getTime(),id:T,isRunning:!1,isAborted:!1};return I.evt=m?_waitForPreviousEvent(I,m):_startWaitingEvent(I),(m=I).evt._schId=T,I.evt;function _abortAndRemoveOldEvents(g){for(var m=_getTime(),f=m-Oh,S=g.length,v=0;v<S;){var C=g[v];if(C&&C.tm<f){var _=null;C.abort?(_="Aborting ["+C.id+"] due to Excessive runtime ("+(m-C.tm)+" ms)",C.abort(_)):_="Removing ["+C.id+"] due to Excessive runtime ("+(m-C.tm)+" ms)",_warnLog2(_),g.splice(v,1),S--}else v++}}function _cleanup(g,f){var S=!1,v=_removeQueuedEvent(kh,g);if(v||(v=_removeQueuedEvent(Fh,g),S=!0),v){v.to&&(clearTimeout(v.to),v.to=null);var C=_getTime()-v.tm;f?S?_warnLog2("Timed out event ["+g+"] finally complete -- "+C+" ms"):_debugLog2("Promise ["+g+"] Complete -- "+C+" ms"):(Fh.push(v),_warnLog2("Event ["+g+"] Timed out and removed -- "+C+" ms"))}else _debugLog2("Failed to remove ["+g+"] from running queue");m&&m.id===g&&(m=null),_abortAndRemoveOldEvents(kh),_abortAndRemoveOldEvents(Lh),_abortAndRemoveOldEvents(Fh)}function _removeScheduledEvent(g,m){return function(f){return _cleanup(g,!0),m&&m(f),f}}function _waitForFinalResult(g,m,f,S){m.then((function(m){return m instanceof Dh?(_debugLog2("Event ["+g+"] returned a promise -- waiting"),_waitForFinalResult(g,m,f,S),m):_removeScheduledEvent(g,f)(m)}),_removeScheduledEvent(g,S))}function _createScheduledEvent(g,m){var f=g.id;return new Dh((function(S,v){_debugLog2("Event ["+f+"] Starting -- waited for "+(g.wTm||"--")+" ms"),g.isRunning=!0,g.abort=function(m){g.abort=null,g.isAborted=!0,_cleanup(f,!1),v(new Error(m))};var C=m(f);C instanceof Dh?(_&&(g.to=setTimeout((function(){_cleanup(f,!1),v(new Error("Timed out after ["+_+"] ms"))}),_)),_waitForFinalResult(f,C,(function(m){_debugLog2("Event ["+f+"] Resolving after "+(_getTime()-g.tm)+" ms"),S(m)}),v)):(_debugLog2("Promise ["+f+"] Auto completed as the start action did not return a promise"),S())}))}function _startWaitingEvent(m){var f=_getTime();return m.wTm=f-m.tm,m.tm=f,m.isAborted?Dh.reject(new Error("["+E+"] was aborted")):(kh.push(m),_createScheduledEvent(m,g))}function _waitForPreviousEvent(g,m){var f=new Dh((function(f,S){var v=_getTime()-m.tm,C=m.id;_debugLog2("["+E+"] is waiting for ["+C+":"+v+" ms] to complete before starting -- ["+Lh.length+"] waiting and ["+kh.length+"] running"),g.abort=function(m){g.abort=null,_removeQueuedEvent(Lh,E),g.isAborted=!0,S(new Error(m))},m.evt.then((function(m){_removeQueuedEvent(Lh,E),_startWaitingEvent(g).then(f,S)}),(function(m){_removeQueuedEvent(Lh,E),_startWaitingEvent(g).then(f,S)}))}));return Lh.push(g),f}}}))}return ESPromiseScheduler2.incomplete=function(){return kh},ESPromiseScheduler2.waitingToStart=function(){return Lh},ESPromiseScheduler2}(),Vh=Uh,Bh="locale",Hh="ver",$h="browser",Gh="browserVer",jh="popSample",Wh="eventFlags",qh="name",zh="serviceName",Kh=createValueMap({UserExt:[0,"user"],DeviceExt:[1,"device"],TraceExt:[2,"trace"],WebExt:[3,"web"],AppExt:[4,"app"],OSExt:[5,"os"],SdkExt:[6,"sdk"],IntWebExt:[7,"intweb"],UtcExt:[8,"utc"],LocExt:[9,"loc"],CloudExt:[10,"cloud"],DtExt:[11,"dt"]}),Jh=createValueMap({id:[0,"id"],ver:[1,Hh],appName:[2,qh],locale:[3,Bh],expId:[4,"expId"],env:[5,"env"]}),Yh=createValueMap({domain:[0,"domain"],browser:[1,$h],browserVer:[2,Gh],screenRes:[3,"screenRes"],userConsent:[4,"userConsent"],consentDetails:[5,"consentDetails"]}),Qh=createValueMap({locale:[0,Bh],localId:[1,"localId"],id:[2,"id"]}),Xh=createValueMap({osName:[0,qh],ver:[1,Hh]}),Zh=createValueMap({ver:[0,Hh],seq:[1,"seq"],installId:[2,"installId"],epoch:[3,"epoch"]}),eu=createValueMap({msfpc:[0,"msfpc"],anid:[1,"anid"],serviceName:[2,zh]}),tu=createValueMap({popSample:[0,jh],eventFlags:[1,Wh]}),iu=createValueMap({tz:[0,"tz"]}),nu=createValueMap({sessionId:[0,"sesId"]}),ru=createValueMap({localId:[0,"localId"],deviceClass:[1,"deviceClass"],make:[2,"make"],model:[3,"model"]}),su=createValueMap({role:[0,"role"],roleInstance:[1,"roleInstance"],roleVer:[2,"roleVer"]}),au=createValueMap({traceId:[0,"traceID"],traceName:[1,qh],parentId:[2,"parentID"]}),ou=createValueMap({traceId:[0,"traceId"],spanId:[1,"spanId"],traceFlags:[2,"traceFlags"]});function canUseLocalStorage(){return void 0===xh&&(xh=!!_getVerifiedStorageObject(0)),xh}function _getLocalStorageObject(){return canUseLocalStorage()?_getVerifiedStorageObject(0):null}function _getVerifiedStorageObject(g){var m,f,S=null;try{var v=getGlobal();if(!v)return null;f=new Date,(S=0===g?v.localStorage:v.sessionStorage)&&isFunction2(S.setItem)&&(S.setItem(f,f),m=S.getItem(f)!==f,S.removeItem(f),m&&(S=null))}catch(g){S=null}return S}function setStorage(g,m,f){var S=_getLocalStorageObject();if(null!==S)try{return S.setItem(m,f),!0}catch(m){xh=!1,_throwInternal(g,1,504,"Browser failed write to local storage. "+m)}return!1}function getStorage(g,m){var f=_getLocalStorageObject();if(null!==f)try{return f.getItem(m)}catch(m){xh=!1,_throwInternal(g,1,503,"Browser failed read of local storage. "+m)}return null}function _getId(){return this.getId()}function _setId(g){this.setId(g)}var lu=function(){function Session3(){dynamicProto(Session3,this,(function(g){g.setId=function(m){g.customId=m},g.getId=function(){return isString2(g.customId)?g.customId:g.automaticId}}))}return Session3._staticInit=void objDefineAccessors(Session3.prototype,"id",_getId,_setId),Session3}(),cu="ai_session",du=function(){function SessionManager2(g,m){var f,S,v=safeGetLogger(g),C=safeGetCookieMgr(g);dynamicProto(SessionManager2,this,(function(g){var _=getDefaultConfig(m);function getDefaultConfig(g){return{sessionRenewalMs:g.sessionRenewalMs&&function(){return g.sessionRenewalMs},sessionExpirationMs:g.sessionExpirationMs&&function(){return g.sessionExpirationMs},cookieDomain:g.cookieDomain&&function(){return g.cookieDomain},namePrefix:g.namePrefix&&function(){return g.namePrefix},sessionAsGuid:function(){return g.sessionAsGuid},idLength:function(){return g.idLength?g.idLength:22}}}function _initializeAutomaticSession(){var m=C.get(S());if(m&&isFunction2(m.split))_initializeAutomaticSessionWithData(m);else{var f=getStorage(v,S());f&&_initializeAutomaticSessionWithData(f)}g.automaticSession.getId()||_renew()}function _initializeAutomaticSessionWithData(m){var f=g.automaticSession,S=m.split("|");S.length>0&&f.setId(S[0]);try{if(S.length>1){var C=+S[1];f.acquisitionDate=+new Date(C),f.acquisitionDate=f.acquisitionDate>0?f.acquisitionDate:0}if(S.length>2){var _=+S[2];f.renewalDate=+new Date(_),f.renewalDate=f.renewalDate>0?f.renewalDate:0}}catch(g){_throwInternal(v,1,510,"Error parsing ai_session cookie, session will be reset: "+g)}0===f.renewalDate&&_throwInternal(v,2,517,"AI session renewal date is 0, session will be reset.")}function _renew(){var m=g.automaticSession,f=(new Date).getTime(),S=g.config.sessionAsGuid();!isUndefined3(S)&&S?isBoolean2(S)?m.setId(createGuid()):m.setId(createGuid(S)):m.setId(newId(_&&_.idLength?_.idLength():22)),m.acquisitionDate=f,m.renewalDate=f,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate),canUseLocalStorage()||_throwInternal(v,2,505,"Browser does not support local storage. Session durations will be inaccurate.")}function _setCookie(m,v,_){var E=v+g.config.sessionExpirationMs(),T=_+g.config.sessionRenewalMs(),I=new Date,b=[m,v,_];E<T?I.setTime(E):I.setTime(T);var A=g.config.cookieDomain?g.config.cookieDomain():null;C.set(S(),b.join("|")+";expires="+I.toUTCString(),null,A),f=(new Date).getTime()}function _setStorage(g,m,f){setStorage(v,S(),[g,m,f].join("|"))}isFunction2(m.sessionExpirationMs)||(_.sessionExpirationMs=function(){return SessionManager2.acquisitionSpan}),isFunction2(m.sessionRenewalMs)||(_.sessionRenewalMs=function(){return SessionManager2.renewalSpan}),g.config=_,S=function(){return g.config.namePrefix&&g.config.namePrefix()?cu+g.config.namePrefix():cu},g.automaticSession=new lu,g.update=function(){g.automaticSession.getId()||_initializeAutomaticSession();var m=g.automaticSession,S=g.config,v=(new Date).getTime(),C=v-m.acquisitionDate>S.sessionExpirationMs(),_=v-m.renewalDate>S.sessionRenewalMs();if(C||_)_renew();else{(!f||v-f>SessionManager2.cookieUpdateInterval)&&(m.renewalDate=v,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate))}},g.backup=function(){var m=g.automaticSession;_setStorage(m.getId(),m.acquisitionDate,m.renewalDate)}}))}return SessionManager2.acquisitionSpan=864e5,SessionManager2.renewalSpan=18e5,SessionManager2.cookieUpdateInterval=6e4,SessionManager2}(),hu=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function _validateAppExpId(g,m){void 0===m&&(m=hu);var f=null;if(g)for(var S=g.split(","),v=0;v<S.length;v++)_isValidAppFlightId(S[v],m)&&(f?f+=","+S[v]:f=S[v]);return f}function _isValidAppFlightId(g,m){if(void 0===m&&(m=hu),!g||g.length<4)return!1;for(var f=!1,S=256,v=g.substring(0,3).toString().toUpperCase(),C=0;C<m.length;C++)if(m[C]+":"===v&&g.length<=S){f=!0;break}return f}function _getExpId(){return this.getExpId()}var uu=function(){function Application2(g,m){var f=null,S=hu.slice(0),v="Treatments",C=safeGetCookieMgr(m),_=g;dynamicProto(Application2,this,(function(m){if(hasDocument()){var E=getDocument().documentElement;E&&(m.locale=E.lang)}function _getMetaDataFromDOM(g){var m,f={},S=getDocument();if(S){m=S&&S.querySelectorAll("meta");for(var v=0;v<m.length;v++){var C=m[v];if(C.name)if(0===C.name.toLowerCase().indexOf(g))f[C.name.replace(g,"")]=C.content}}return f}function _setAppExpId(g){g!==f&&(f=_validateAppExpId(g,S))}function _readExpIdFromCookie(){return _setAppExpId(getCookieValue(C,v)),f}function _readExpIdFromCoreData(g){return _setAppExpId(g),f}m.env=g.env?g.env:_getMetaDataFromDOM("awa-").env,m.getExpId=function(){return _.expId?_readExpIdFromCoreData(_.expId):_readExpIdFromCookie()}}))}return Application2.validateAppExpId=_validateAppExpId,Application2._staticInit=void objDefineAccessors(Application2.prototype,"expId",_getExpId),Application2}(),gu=function(){function Cloud2(){}return Cloud2}(),pu=function(){function Device3(){}return Device3}();function _getMsfpc(){return this.getMsfpc()}function _getAnid(){return this.getAnid()}var mu=function(){function IntWeb2(g,m){var f=safeGetCookieMgr(m);dynamicProto(IntWeb2,this,(function(m){g.serviceName&&(m.serviceName=g.serviceName),m.getMsfpc=function(){return getCookieValue(f,"MSFPC")},m.getAnid=function(){return getCookieValue(f,"ANON").slice(0,34)}}))}var g;return IntWeb2._staticInit=(objDefineAccessors(g=IntWeb2.prototype,"msfpc",_getMsfpc),void objDefineAccessors(g,"anid",_getAnid)),IntWeb2}(),fu=function(){function Loc2(){var g=(new Date).getTimezoneOffset(),m=g%60,f=(g-m)/60,S="+";f>0&&(S="-"),f=Math.abs(f),m=Math.abs(m),this.tz=S+(f<10?"0"+f:f.toString())+":"+(m<10?"0"+m:m.toString())}return Loc2}(),Su={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},vu={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},yu="([\\d,.]+)",Cu="([\\d,_,.]+)",_u="Unknown",Eu=[{r:Su.WINPHONE,os:"Windows Phone"},{r:Su.WINRT,os:"Windows RT"},{r:Su.WIN,os:"Windows"},{r:Su.IOS,os:"iOS"},{r:Su.ANDROID,os:"Android"},{r:Su.LINUX,os:"Linux"},{r:Su.CROS,os:"Chrome OS"},{s:"x11",os:"Unix"},{s:"blackberry",os:"BlackBerry"},{s:"symbian",os:"Symbian"},{s:"nokia",os:"Nokia"},{r:Su.OSX,os:"Mac OS X"}];function _getOsName(g){for(var m=0;m<Eu.length;m++){var f=Eu[m];if(f.r&&g.match(f.r))return f.os;if(f.s&&-1!==g.indexOf(f.s))return f.os}return _u}function _getOsVersion(g,m){return"Windows"===m?_getGenericOsVersion(g,"Windows NT"):"Android"===m?_getGenericOsVersion(g,m):"Mac OS X"===m?_getMacOsxVersion(g):"iOS"===m?_getIosVersion(g):_u}function _getGenericOsVersion(g,m){var f=g.match(new RegExp(m+" "+yu));return f?vu[f[1]]?vu[f[1]]:f[1]:_u}function _getMacOsxVersion(g){var m=g.match(new RegExp("Mac OS X "+Cu));if(m){var f=m[1].replace(/_/g,".");if(f){var S=_getDelimiter(f);return S?f.split(S)[0]:f}}return _u}function _getIosVersion(g){var m=g.match(new RegExp("OS "+Cu));if(m){var f=m[1].replace(/_/g,".");if(f){var S=_getDelimiter(f);return S?f.split(S)[0]:f}}return _u}function _getDelimiter(g){return g.indexOf(".")>-1?".":g.indexOf("_")>-1?"_":null}var Tu=function(){function OperatingSystem2(g){if(g.populateOperatingSystemInfo){var m=this,f=getNavigator()||{},S=g.userAgent||f.userAgent||"",v=g.userAgentData||f.userAgentData||{};if(S){var C=_getOsName(S.toLowerCase());m.name=C,m.ver=_getOsVersion(S,C)}m.name&&m.name!==_u||!isString2(v.platform)||(m.name=v.platform)}}return OperatingSystem2}(),Iu="MicrosoftApplicationsTelemetryDeviceId";function _saveData(g,m,f,S){m?m.setProperty(f,S):g.set(f,S,31536e3)}function _getData(g,m,f){return m?m.getProperty(f)||"":getCookieValue(g,f)}var bu=function(){function Sdk2(g,m){var f=0;dynamicProto(Sdk2,this,(function(S){var v=g.propertyStorageOverride;S.seq=f,S.epoch=random32(!1).toString();var C=safeGetCookieMgr(m,g);if(C.isEnabled()||v){var _=_getData(C,v,Iu);_||(_=newGuid2()),_saveData(C,v,Iu,_),S.installId=_}else C.purge(Iu);S.getSequenceId=function(){return++f}}))}return Sdk2.__ieDyn=1,Sdk2}(),Au=function(){function Trace2(g,m,f,S){var v=this;if(v.traceId=m||generateW3CId(),g.enableDistributedTracing&&!f&&(f=generateW3CId().substring(0,16)),v.parentId=f,g.enableApplicationInsightsTrace){v.name=S;var C=getLocation();C&&C.pathname&&(v.name=C.pathname)}}return Trace2}(),Pu="setLocalId";function _getLocalId(){return this.getLocalId()}function _setLocalId(g){this[Pu](g)}var Ru=function(){function User2(g,m,f){var S,v=m,C=safeGetCookieMgr(f,g);dynamicProto(User2,this,(function(m){if(C&&C.isEnabled()&&(_populateMuidFromCookie(),v.enableApplicationInsightsUser)){var f=getCookieValue(C,User2.userCookieName);if(f){var _=f.split(User2.cookieSeparator);_.length>0&&(m.id=_[0])}if(!m.id){m.id=newId(g&&!isUndefined3(g.idLength)?g.idLength:22);var E=toISOString(new Date);m.accountAcquisitionDate=E;var T=[m.id,E],I=v.cookieDomain?v.cookieDomain:void 0;C.set(User2.userCookieName,T.join(User2.cookieSeparator),31536e3,I)}}if("undefined"!=typeof navigator){var b=navigator;m.locale=b.userLanguage||b.language}function _populateMuidFromCookie(){if(!v.hashIdentifiers&&!v.dropIdentifiers){var g=getCookieValue(C,"MUID");g&&(S="t:"+g)}return S}m.getLocalId=function(){return S||_populateMuidFromCookie()},m[Pu]=function(g){S=g}}))}return User2.cookieSeparator="|",User2.userCookieName="ai_user",User2._staticInit=void objDefineAccessors(User2.prototype,"localId",_getLocalId,_setLocalId),User2}(),wu=1048576,Mu=2097152,Du=function(){function Utc2(g){var m=this;m.popSample=100,m.eventFlags=0,g.hashIdentifiers&&(m.eventFlags=m.eventFlags|wu),g.dropIdentifiers&&(m.eventFlags=m.eventFlags|Mu)}return Utc2}(),Ou="([\\d,.]+)",Nu="Unknown",ku="Edg/",Lu=[{ua:"OPR/",b:"Opera"},{ua:"PhantomJS",b:"PhantomJS"},{ua:"Edge",b:"Edge"},{ua:ku,b:"Edge"},{ua:"Electron",b:"Electron"},{ua:"Chrome",b:"Chrome"},{ua:"Trident",b:"MSIE"},{ua:"MSIE ",b:"MSIE"},{ua:"Firefox",b:"Firefox"},{ua:"Safari",b:"Safari"},{ua:"SkypeShell",b:"SkypeShell"}],Fu=[{br:"Microsoft Edge",b:"Edge"},{br:"Google Chrome",b:"Chrome"},{br:"Opera",b:"Opera"}];function _userAgentContainsString(g,m){return m.indexOf(g)>-1}function _getBrandVersion(g,m){for(var f=0;f<m.length;f++)if(g==m[f].brand)return m[f].version;return null}function _getBrowserName(g){if(g)for(var m=0;m<Lu.length;m++){if(_userAgentContainsString(Lu[m].ua,g))return Lu[m].b}return Nu}function _getBrowserVersion(g,m){return"MSIE"===m?_getIeVersion(g):_getOtherVersion(m,g)}function _getIeVersion(g){var m=g.match(new RegExp("MSIE "+Ou));if(m)return m[1];var f=g.match(new RegExp("rv:"+Ou));return f?f[1]:void 0}function _getOtherVersion(g,m){"Safari"===g?g="Version":"Edge"===g&&_userAgentContainsString(ku,m)&&(g="Edg");var f=m.match(new RegExp(g+"/"+Ou));return f||"Opera"===g&&(f=m.match(new RegExp("OPR/"+Ou)))?f[1]:Nu}function _getScreenResolution(){var g={h:0,w:0},m=getWindow();return m&&m.screen&&(g.h=screen.height,g.w=screen.width),g}function _getUserConsent(){return this.getUserConsent()}var xu=function(){function Web2(g,m){var f=safeGetCookieMgr(m),S=g||{};dynamicProto(Web2,this,(function(g){var m=getLocation();if(m){var v=m.hostname;v&&(g.domain="file:"===m.protocol?"local":v)}if(S.populateBrowserInfo){var C=S.userAgent,_=(S.userAgentData||{}).brands,E=getNavigator();E&&(C=C||E.userAgent||"",_=_||(E.userAgentData||{}).brands),_parseUserAgent(C,_);var T=_getScreenResolution();g.screenRes=T.w+"X"+T.h}function _parseUserAgent(m,f){if(ac(f))try{for(var S=0;S<Fu.length;S++){var v=_getBrandVersion(Fu[S].br,f);if(v)return g.browser=Fu[S].b,void(g.browserVer=v)}}catch(g){}if(m){var C=_getBrowserName(m);g.browser=C,g.browserVer=_getBrowserVersion(m,C)}}g.getUserConsent=function(){return S.userConsented||!!getCookieValue(f,S.userConsentCookieName||"MSCC")},g.getUserConsentDetails=function(){try{var g=S.callback;if(g&&g.userConsentDetails){var m=g.userConsentDetails();if(m)return JSON.stringify({Required:m.Required||!1,Analytics:m.Analytics||!1,SocialMedia:m.SocialMedia||!1,Advertising:m.Advertising||!1})}}catch(g){}return null},objDefineAccessors(g,"userConsent",g.getUserConsent)}))}return Web2._staticInit=void objDefineAccessors(Web2.prototype,"userConsent",_getUserConsent),Web2}();function _applyExtValues(g,m,f,S,v){var C=m.ext[Kh[g]];return C&&objForEachKey(S,(function(g,m){if(isString2(m)||isNumber3(m)||isBoolean2(m)){var S=C[f[g]];!v&&(S||isString2(S)||isNumber3(S)||isBoolean2(S))&&(m=S),C[f[g]]=m}})),C}var Uu=function(){function TelemetryContext4(g,m,f){dynamicProto(TelemetryContext4,this,(function(S){S.app=new uu(m,f),S.cloud=new gu,S.user=new Ru(g,m,f),S.os=new Tu(m),S.web=new xu(m,f);var v=new bu(g,f),C=new mu(m,f),_=new Du(m);S.loc=new fu,S.device=new pu;var E=new du(f,m);S.session=new lu;var T=createDistributedTraceContextFromTraceCtx(new Au(m),_getTraceCtx()),I=!(m||{}).eventContainExtFields;function _getSessionId(){var g=S.session;if(g&&isString2(g.customId))return g.customId;E.update();var m=E.automaticSession;if(m){var f=m.getId();f&&isString2(f)&&(g.automaticId=f)}return g.automaticId}function _getTraceCtx(){var g=T;return f&&f.getTraceCtx&&(g=f.getTraceCtx(!1)||T),g}S.getTraceCtx=function(){return T},S.getSessionId=_getSessionId,S.applyApplicationContext=function(g){var m,f=S.app;_applyExtValues(4,g,Jh,((m={})[0]=f.id,m[1]=f.ver,m[2]=f.name,m[3]=f.locale,m[4]=f.getExpId(),m[5]=f.env,m),I)},S.applyUserContext=function(g){var m,f=S.user;_applyExtValues(0,g,Qh,((m={})[1]=f.getLocalId(),m[0]=f.locale,m[2]=f.id,m),I)},S.applyWebContext=function(g){var m,f=S.web;_applyExtValues(3,g,Yh,((m={})[0]=f.domain,m[1]=f.browser,m[2]=f.browserVer,m[3]=f.screenRes,m[5]=f.getUserConsentDetails(),m[4]=f.getUserConsent(),m),I)},S.applyOsContext=function(g){var m,f=S.os;_applyExtValues(5,g,Xh,((m={})[0]=f.name,m[1]=f.ver,m),I)},S.applySdkContext=function(g){var m;_applyExtValues(6,g,Zh,((m={})[2]=v.installId,m[1]=v.getSequenceId(),m[3]=v.epoch,m),I)},S.applyIntWebContext=function(g){var m;_applyExtValues(7,g,eu,((m={})[0]=C.getMsfpc(),m[1]=C.getAnid(),m[2]=C.serviceName,m),I)},S.applyUtcContext=function(g){var m,f=((m={})[0]=_.popSample,m);_.eventFlags>0&&(f[1]=_.eventFlags),_applyExtValues(8,g,tu,f,I)},S.applyLocContext=function(g){var m;_applyExtValues(9,g,iu,((m={})[0]=S.loc.tz,m),I)},S.applySessionContext=function(g){var m;_applyExtValues(4,g,nu,((m={})[0]=_getSessionId(),m),I)},S.applyDeviceContext=function(g){var m,f=S.device;_applyExtValues(1,g,ru,((m={})[0]=f.localId,m[2]=f.make,m[3]=f.model,m[1]=f.deviceClass,m),I)},S.applyCloudContext=function(g){var m,f=S.cloud;_applyExtValues(10,g,su,((m={})[0]=f.role,m[1]=f.roleInstance,m[2]=f.roleVer,m),I)},S.applyAITraceContext=function(g){var f;if(m.enableApplicationInsightsTrace){var S=_getTraceCtx();S&&_applyExtValues(2,g,au,((f={})[0]=S.getTraceId(),f[1]=S.getName(),f[2]=S.getSpanId(),f),!1)}},S.applyDistributedTraceContext=function(g){var m,f=_getTraceCtx();if(f){var S=((m={})[0]=f.getTraceId(),m[1]=f.getSpanId(),m),v=f.getTraceFlags();isNullOrUndefined(v)||(S[2]=v),_applyExtValues(11,g,ou,S,!1)}}}))}return TelemetryContext4.__ieDyn=1,TelemetryContext4}();function createDistributedTraceContextFromTraceCtx(g,m){var f=g||{};return{getName:function(){return f.name},setName:function(g){m&&m.setName(g),f.name=g},getTraceId:function(){return f.traceId},setTraceId:function(g){m&&m.setTraceId(g),isValidTraceId(g)&&(f.traceId=g)},getSpanId:function(){return f.parentId},setSpanId:function(g){m&&m.setSpanId(g),isValidSpanId(g)&&(f.parentId=g)},getTraceFlags:function(){return f.traceFlags},setTraceFlags:function(g){m&&m.setTraceFlags(g),f.traceFlags=g}}}var Vu=[Kh[4],Kh[0],Kh[3],Kh[5],Kh[6],Kh[7],Kh[8],Kh[9],Kh[1],Kh[2],Kh[11],Kh[10]],Bu=function(g){function PropertiesPlugin2(){var m,f,S,v=g.call(this)||this;return v.identifier="SystemPropertiesCollector",v.priority=3,v.version="3.2.9",dynamicProto(PropertiesPlugin2,v,(function(g,v){function _initDefaults(){m=null,f={}}function _addPropertiesIfAbsent(g,m){g&&objForEachKey(g,(function(g,f){m[g]||(m[g]=f)}))}_initDefaults(),g.initialize=function(f,C,_){v.initialize(f,C,_),S=g._getTelCtx().getExtCfg(g.identifier),m=new Uu(f,S,C),C&&C.setTraceCtx&&C.setTraceCtx(m.getTraceCtx())},g.processTelemetry=function(v,C){setProcessTelemetryTimings(v,g.identifier),C=g._getTelCtx(C);var _=v.ext=v.ext?v.ext:{};v.data=v.data?v.data:{},arrForEach(Vu,(function(g){_[g]=_[g]||{}})),m&&(m.applyApplicationContext(v),m.applyUserContext(v),m.applyWebContext(v),m.applyOsContext(v),m.applySdkContext(v),m.applyIntWebContext(v),m.applyUtcContext(v),m.applyLocContext(v),m.applySessionContext(v),m.applyDeviceContext(v),S.enableApplicationInsightsTrace&&m.applyAITraceContext(v),S.enableDistributedTracing&&m.applyDistributedTraceContext(v),m.applyCloudContext(v)),arrForEach(objKeys(_),(function(g){0===objKeys(_[g]).length&&delete _[g]})),_addPropertiesIfAbsent(f,v.data),g.processNext(v,C)},g.getPropertiesContext=function(){return m},g.setProperty=function(g,m){f[g]=m},g._doTeardown=function(g,f){var S=(g||{}).core();if(S&&S.getTraceCtx&&m){var v=S.getTraceCtx(!1);v&&v===m.getTraceCtx()&&S.setTraceCtx(null)}_initDefaults()}})),v}return __extendsFn(PropertiesPlugin2,g),PropertiesPlugin2.__ieDyn=1,PropertiesPlugin2}($d),Hu=Bu,$u=function(){function BaseContext2(g){this._setOverride=function(m,f){g.setOverride(m,f)},this._getOverride=function(m){return g.getOverride(m)}}return BaseContext2}(),Gu=function(g){function ApplicationContext2(m,f){var S=g.call(this,m)||this,v=S;return v.setId=function(g){v._setOverride(Jh.id,g)},v.getId=function(){return v._getOverride(Jh.id)},v.setVer=function(g){v._setOverride(Jh.ver,g)},v.getVer=function(){return v._getOverride(Jh.ver)},v.setName=function(g){v._setOverride(Jh.appName,g)},v.getName=function(){return v._getOverride(Jh.appName)},v.setLocale=function(g){v._setOverride(Jh.locale,g)},v.getLocale=function(){return v._getOverride(Jh.locale)},v.setEnv=function(g){v._setOverride(Jh.env,g)},v.getEnv=function(){return v._getOverride(Jh.env)},v.setExpId=function(g){v._setOverride(Jh.expId,uu.validateAppExpId(g))},v.getExpId=function(){return v._getOverride(Jh.expId)},f&&(isUndefined3(f.env)||v.setEnv(f.env),isNullOrUndefined(f.expId)||v.setExpId(f.expId)),S}return __extendsFn(ApplicationContext2,g),ApplicationContext2}($u),ju=function(g){function CloudContext2(m){var f=g.call(this,m)||this,S=f;return S.setRole=function(g){S._setOverride(su.role,g)},S.getRole=function(){return S._getOverride(su.role)},S.setRoleInstance=function(g){S._setOverride(su.roleInstance,g)},S.getRoleInstance=function(){return S._getOverride(su.roleInstance)},S.setRoleVer=function(g){S._setOverride(su.roleVer,g)},S.getRoleVer=function(){return S._getOverride(su.roleVer)},f}return __extendsFn(CloudContext2,g),CloudContext2}($u),Wu=function(g){function DataContext2(m){var f=g.call(this,m)||this,S=f;return S.setProperty=function(g,m){S._setOverride(g,m)},S.getProperty=function(g){return S._getOverride(g)},f}return __extendsFn(DataContext2,g),DataContext2}($u),qu=function(g){function DeviceContext2(m){var f=g.call(this,m)||this,S=f;return S.setLocalId=function(g){S._setOverride(ru.localId,g)},S.getLocalId=function(){return S._getOverride(ru.localId)},S.setDeviceClass=function(g){S._setOverride(ru.deviceClass,g)},S.getDeviceClass=function(){return S._getOverride(ru.deviceClass)},S.setMake=function(g){S._setOverride(ru.make,g)},S.getMake=function(){return S._getOverride(ru.make)},S.setModel=function(g){S._setOverride(ru.model,g)},S.getModel=function(){return S._getOverride(ru.model)},f}return __extendsFn(DeviceContext2,g),DeviceContext2}($u),zu=function(g){function LocContext2(m){var f=g.call(this,m)||this,S=f;return S.setTz=function(g){S._setOverride(iu.tz,g)},S.getTz=function(){return S._getOverride(iu.tz)},f}return __extendsFn(LocContext2,g),LocContext2}($u),Ku=function(g){function OperatingSystemContext2(m,f){var S=g.call(this,m)||this,v=S;if(v.setOsName=function(g){v._setOverride(Xh.osName,g)},v.getOsName=function(){return v._getOverride(Xh.osName)},v.setVer=function(g){v._setOverride(Xh.ver,g)},v.getVer=function(){return v._getOverride(Xh.ver)},f&&f.userAgent&&f.populateOperatingSystemInfo){var C=new Tu(f);v.setOsName(C.name),v.setVer(C.ver)}return S}return __extendsFn(OperatingSystemContext2,g),OperatingSystemContext2}($u);function _getEventRoot(g,m){if(g)for(var f=0;f<m.length;f++){var S=m[f];isNullOrUndefined(g[S])&&(g[S]={}),g=g[S]}return g}function _setOverride(g,m,f){if(g&&m){var S=m.split("."),v=S[S.length-1];S.length>1&&(g=_getEventRoot(g,S.slice(0,-1))),isNullOrUndefined(f)?isUndefined3(g[v])||delete g[v]:g[v]=f}}var Ju=function(){function OverrideContainer2(g){var m=this,f=[];m.setOverride=function(g,m){g&&f.push({key:g,value:m})},m.hasOverride=function(g){var m=!1;return arrForEach(f,(function(f){f.key===g&&(m=!0)})),m},m.getOverride=function(g){var m;return arrForEach(f,(function(f){f.key===g&&(m=f.value)})),m},m.applyOverrides=function(m,S){if(f.length>0)try{var v=_getEventRoot(m,g);arrForEach(f,(function(g){_setOverride(v,g.key,g.value)}))}catch(g){}}}return OverrideContainer2}(),Yu=function(g){function UserContext2(m){var f=g.call(this,m)||this,S=f;return S.setLocalId=function(g){S._setOverride(Qh.localId,g)},S.getLocalId=function(){return S._getOverride(Qh.localId)},S.setLocale=function(g){S._setOverride(Qh.locale,g)},S.getLocale=function(){return S._getOverride(Qh.locale)},S.setId=function(g){S._setOverride(Qh.id,g)},S.getId=function(){return S._getOverride(Qh.id)},f}return __extendsFn(UserContext2,g),UserContext2}($u),Qu=function(g){function WebContext2(m,f){var S=g.call(this,m)||this,v=S;return v.setDomain=function(g){v._setOverride(Yh.domain,g)},v.getDomain=function(){return v._getOverride(Yh.domain)},v.setBrowser=function(g){v._setOverride(Yh.browser,g)},v.getBrowser=function(){return v._getOverride(Yh.browser)},v.setBrowserVer=function(g){v._setOverride(Yh.browserVer,g)},v.getBrowserVer=function(){return v._getOverride(Yh.browserVer)},v.setScreenRes=function(g){v._setOverride(Yh.screenRes,g)},v.getScreenRes=function(){return v._getOverride(Yh.screenRes)},v.setUserConsent=function(g){v._setOverride(Yh.userConsent,g)},v.getUserContext=function(){return v._getOverride(Yh.userConsent)},f&&(isUndefined3(f.userConsented)||v.setUserConsent(f.userConsented)),S}return __extendsFn(WebContext2,g),WebContext2}($u),Xu="ext",Zu="data",eg=function(){function OverrideContext2(g,m,f){var S=this,v={};function _getContainer(g){for(var m="",f=0;f<g.length;f++)m&&(m+="_"),m+=g[f];return isUndefined3(v[m])&&(v[m]=new Ju(g)),m?v[m]:null}S.data=new Wu(_getContainer([Zu])),S.app=new Gu(_getContainer([Xu,Kh.AppExt]),m),S.user=new Yu(_getContainer([Xu,Kh.UserExt])),S.os=new Ku(_getContainer([Xu,Kh.OSExt]),m),S.web=new Qu(_getContainer([Xu,Kh.WebExt]),m),S.device=new qu(_getContainer([Xu,Kh.DeviceExt])),S.loc=new zu(_getContainer([Xu,Kh.LocExt])),S.cloud=new ju(_getContainer([Xu,Kh.CloudExt])),S.applyOverrides=function(g,m){var f=objKeys(v);f&&f.length>0&&arrForEach(f,(function(f){v[f].applyOverrides(g,m)}))}}return OverrideContext2}(),tg=function(g){function OverridePropertiesPlugin2(){var m=g.call(this)||this;m.identifier="OverridePropertiesPlugin",m.priority=4,m.version="3.2.9";var f=null;return dynamicProto(OverridePropertiesPlugin2,m,(function(g,S){g.initialize=function(m,f,v){S.initialize(m,f,v),g._baseInit(m,f,v)},g.processTelemetry=function(f,S){setProcessTelemetryTimings(f,m.identifier),S=g._getTelCtx(S);var v=g.getOverrideContext();v&&v.applyOverrides(f,S),g.processNext(f,S)},g._baseInit=function(g,S,v){f=new eg(g,m._getTelCtx().getExtCfg(m.identifier),S)},g.setProperty=function(g,m){f&&f.data.setProperty(g,m)},g.getOverrideContext=function(){return f}})),m}return __extendsFn(OverridePropertiesPlugin2,g),OverridePropertiesPlugin2.__ieDyn=1,OverridePropertiesPlugin2}($d),ig=tg,ng="REAL_TIME",rg="NEAR_REAL_TIME",sg="BEST_EFFORT",ag="",og="POST",lg="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",cg="drop",dg="send",hg="requeue",ug="rspFail",gg="oth",pg="no-cache, no-store",mg="application/x-json-stream",fg="cache-control",Sg="content-type",vg="kill-tokens",yg="kill-duration",Cg="kill-duration-seconds",_g="time-delta-millis",Eg="client-version",Tg="client-id",Ig="time-delta-to-apply-millis",bg="upload-time",Ag="apikey",Pg="AuthMsaDeviceTicket",Rg="AuthXToken",wg="NoResponseBody",Mg="msfpc",Dg="trace",Og="user";function _getEventMsfpc(g){var m=(g.ext||{}).intweb;return m&&isValueAssigned(m[Mg])?m[Mg]:null}function _getMsfpc2(g){for(var m=null,f=0;null===m&&f<g.length;f++)m=_getEventMsfpc(g[f]);return m}var Ng=function(){function EventBatch2(g,m){var f=m?[].concat(m):[],S=this,v=_getMsfpc2(f);S.iKey=function(){return g},S.Msfpc=function(){return v||ag},S.count=function(){return f.length},S.events=function(){return f},S.addEvent=function(g){return!!g&&(f.push(g),v||(v=_getEventMsfpc(g)),!0)},S.split=function(m,S){var C;if(m<f.length){var _=f.length-m;isNullOrUndefined(S)||(_=S<_?S:_),C=f.splice(m,_),v=_getMsfpc2(f)}return new EventBatch2(g,C)}}return EventBatch2.create=function(g,m){return new EventBatch2(g,m)},EventBatch2}(),kg=function(){function ClockSkewManager2(){var g=!0,m=!0,f=!0,S="use-collector-delta",v=!1;dynamicProto(ClockSkewManager2,this,(function(C){C.allowRequestSending=function(){return g},C.firstRequestSent=function(){f&&(f=!1,v||(g=!1))},C.shouldAddClockSkewHeaders=function(){return m},C.getClockSkewHeaderValue=function(){return S},C.setClockSkew=function(f){v||(f?(S=f,m=!0,v=!0):m=!1,g=!0)}}))}return ClockSkewManager2.__ieDyn=1,ClockSkewManager2}(),Lg=1e3,Fg=function(){function KillSwitch2(){var g={};function _normalizeTenants(g){var m=[];return g&&arrForEach(g,(function(g){m.push(strTrim(g))})),m}dynamicProto(KillSwitch2,this,(function(m){m.setKillSwitchTenants=function(m,f){if(m&&f)try{var S=_normalizeTenants(m.split(","));if("this-request-only"===f)return S;for(var v=parseInt(f,10)*Lg,C=0;C<S.length;++C)g[S[C]]=dateNow()+v}catch(g){return[]}return[]},m.isTenantKilled=function(m){var f=g,S=strTrim(m);return void 0!==f[S]&&f[S]>dateNow()||(delete f[S],!1)}}))}return KillSwitch2.__ieDyn=1,KillSwitch2}(),xg=Fg,Ug=.8,Vg=1.2,Bg=3e3,Hg=6e5;function retryPolicyShouldRetryForStatus(g){return!(g>=300&&g<500&&408!=g&&429!=g||501==g||505==g)}function retryPolicyGetMillisToBackoffForRetry(g){var m=0,f=Bg*Ug,S=Bg*Vg,v=Math.floor(Math.random()*(S-f))+f;return m=Math.pow(2,g)*v,Math.min(m,Hg)}var $g,Gg=20,jg=3984588,Wg=65e3,qg=2e6,zg=Math.min(qg,Wg),Kg="metadata",Jg="f",Yg=/\./,Qg=function(){function Serializer2(g,m,f,S){var v="data",C="baseData",_="ext",E=!!S,T=!0,I=m,b={};dynamicProto(Serializer2,this,(function(m){function _isReservedField(g,m){var f=b[g];return void 0===f&&(g.length>=7&&(f=strStartsWith(g,"ext.metadata")||strStartsWith(g,"ext.web")),b[g]=f),f}function _processPathKeys(g,m,S,v,C,_,T){objForEachKey(g,(function(g,b){var A=null;if(b||isValueAssigned(b)){var P=S,R=g,w=C,M=m;if(E&&!v&&Yg.test(g)){var D=g.split("."),O=D.length;if(O>1){w&&(w=w.slice());for(var N=0;N<O-1;N++){var k=D[N];M=M[k]=M[k]||{},P+="."+k,w&&w.push(k)}R=D[O-1]}}if(A=!(v&&_isReservedField(P))&&I&&I.handleField(P,R)?I.value(P,R,b,f):sanitizeProperty(R,b,f)){var L=A.value;if(M[R]=L,_&&_(w,R,A),T&&"object"==typeof L&&!ac(L)){var F=w;F&&(F=F.slice()).push(R),_processPathKeys(b,L,P+"."+R,v,F,_,T)}}}}))}m.createPayload=function(g,m,f,S,v,C){return{apiKeys:[],payloadBlob:ag,overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:g,isTeardown:m,isSync:f,isBeacon:S,sendType:C,sendReason:v}},m.appendPayload=function(f,S,v){var C=f&&S&&!f.overflow;return C&&doPerf(g,(function(){return"Serializer:appendPayload"}),(function(){for(var g=S.events(),C=f.payloadBlob,_=f.numEvents,E=!1,T=[],I=[],b=f.isBeacon,A=b?Wg:jg,P=b?zg:qg,R=0,w=0;R<g.length;){var M=g[R];if(M){if(_>=v){f.overflow=S.split(R);break}var D=m.getEventBlob(M);if(D&&D.length<=P){var O=D.length;if(C.length+O>A){f.overflow=S.split(R);break}C&&(C+="\n"),C+=D,++w>Gg&&(C.substr(0,1),w=0),E=!0,_++}else D?T.push(M):I.push(M),g.splice(R,1),R--}R++}if(T&&T.length>0&&f.sizeExceed.push(Ng.create(S.iKey(),T)),I&&I.length>0&&f.failedEvts.push(Ng.create(S.iKey(),I)),E){f.batches.push(S),f.payloadBlob=C,f.numEvents=_;var N=S.iKey();-1===arrIndexOf(f.apiKeys,N)&&f.apiKeys.push(N)}}),(function(){return{payload:f,theBatch:{iKey:S.iKey(),evts:S.events()},max:v}})),C},m.getEventBlob=function(m){try{return doPerf(g,(function(){return"Serializer.getEventBlob"}),(function(){var g={};g.name=m.name,g.time=m.time,g.ver=m.ver,g.iKey="o:"+getTenantId(m.iKey);var f={},S=m[_];S&&(g[_]=f,objForEachKey(S,(function(g,m){_processPathKeys(m,f[g]={},"ext."+g,!0,null,null,!0)})));var E=g[v]={};E.baseType=m.baseType;var I=E[C]={};return _processPathKeys(m.baseData,I,C,!1,[C],(function(g,m,S){_addJSONPropertyMetaData(f,g,m,S)}),T),_processPathKeys(m.data,E,v,!1,[],(function(g,m,S){_addJSONPropertyMetaData(f,g,m,S)}),T),JSON.stringify(g)}),(function(){return{item:m}}))}catch(g){return null}}}))}return Serializer2.__ieDyn=1,Serializer2}();function _addJSONPropertyMetaData(g,m,f,S){if(S&&g){var v=getCommonSchemaMetaData(S.value,S.kind,S.propertyType);if(v>-1){var C=g[Kg];C||(C=g[Kg]={f:{}});var _=C[Jg];if(_||(_=C[Jg]={}),m)for(var E=0;E<m.length;E++){var T=m[E];_[T]||(_[T]={f:{}});var I=_[T][Jg];I||(I=_[T][Jg]={}),_=I}_=_[f]={},ac(S.value)?_.a={t:v}:_.t=v}}}var Xg="sendAttempt",Zg="&"+wg+"=true",ep=(($g={})[1]=hg,$g[100]=hg,$g[200]="sent",$g[8004]=cg,$g[8003]=cg,$g),tp={},ip={};function _addCollectorHeaderQsMapping(g,m,f){tp[g]=m,!1!==f&&(ip[m]=g)}function _getResponseText(g){try{return g.responseText}catch(g){}return ag}function _hasHeader(g,m){var f=!1;if(g&&m){var S=objKeys(g);if(S&&S.length>0)for(var v=m.toLowerCase(),C=0;C<S.length;C++){var _=S[C];if(_&&hasOwnProperty(m,_)&&_.toLowerCase()===v){f=!0;break}}}return f}function _addRequestDetails(g,m,f,S){m&&f&&f.length>0&&(S&&tp[m]?(g.hdrs[tp[m]]=f,g.useHdrs=!0):g.url+="&"+m+"="+f)}function _prependTransports(g,m){return m&&(isNumber3(m)?g=[m].concat(g):ac(m)&&(g=m.concat(g))),g}_addCollectorHeaderQsMapping(Pg,Pg,!1),_addCollectorHeaderQsMapping(Eg,Eg),_addCollectorHeaderQsMapping(Tg,"Client-Id"),_addCollectorHeaderQsMapping(Ag,Ag),_addCollectorHeaderQsMapping(Ig,Ig),_addCollectorHeaderQsMapping(bg,bg),_addCollectorHeaderQsMapping(Rg,Rg);var np=function(){function HttpManager2(g,m,f,S,v){this._responseHandlers=[];var C,_,E,T,I,b,A,P,R,w,M="?cors=true&"+Sg.toLowerCase()+"="+mg,D=new xg,O=!1,N=new kg,k=!1,L=0,F=!0,x=[],U={},V=[],B=null,H=!1,$=!1,G=!1;dynamicProto(HttpManager2,this,(function(j){var W=!0;function _getSenderInterface(g,m){for(var f=0,S=null,v=0;null==S&&v<g.length;)1===(f=g[v])?useXDomainRequest()?S=_xdrSendPost:isXhrSupported()&&(S=_xhrSendPost):2===f&&isFetchSupported(m)&&(!m||m&&!P)?S=_fetchSendPost:k&&3===f&&isBeaconsSupported()&&(S=_beaconSendPost),v++;return S?{_transport:f,_isSync:m,sendPOST:S}:null}function _xdrSendPost(g,m,f){var S=new XDomainRequest;S.open(og,g.urlString),g.timeout&&(S.timeout=g.timeout),S.onload=function(){var g=_getResponseText(S);_doOnComplete(m,200,{},g),_handleCollectorResponse(g)},S.onerror=function(){_doOnComplete(m,400,{})},S.ontimeout=function(){_doOnComplete(m,500,{})},S.onprogress=function(){},f?S.send(g.data):v.set((function(){S.send(g.data)}),0)}function _fetchSendPost(g,m,f){var S,C=g.urlString,_=!1,E=!1,T=((S={body:g.data,method:og})[lg]=!0,S);f&&(T.keepalive=!0,2===g._sendReason&&(_=!0,w&&(C+=Zg))),W&&(T.credentials="include"),g.headers&&objKeys(g.headers).length>0&&(T.headers=g.headers),fetch(C,T).then((function(g){var f={},S=ag,v=g.headers;v&&v.forEach((function(g,m){f[m]=g})),g.body&&g.text().then((function(g){S=g})),E||(E=!0,_doOnComplete(m,g.status,f,S),_handleCollectorResponse(S))})).catch((function(g){E||(E=!0,_doOnComplete(m,0,{}))})),_&&!E&&(E=!0,_doOnComplete(m,200,{})),!E&&g.timeout>0&&v.set((function(){E||(E=!0,_doOnComplete(m,500,{}))}),g.timeout)}function _xhrSendPost(g,m,f){var S=g.urlString;function _appendHeader(g,m,f){if(!g[f]&&m&&m.getResponseHeader){var S=m.getResponseHeader(f);S&&(g[f]=strTrim(S))}return g}function _getAllResponseHeaders(g){var m={};return g.getAllResponseHeaders?m=_convertAllHeadersToMap(g.getAllResponseHeaders()):(m=_appendHeader(m,g,_g),m=_appendHeader(m,g,yg),m=_appendHeader(m,g,Cg)),m}function xhrComplete(g,f){_doOnComplete(m,g.status,_getAllResponseHeaders(g),f)}f&&g.disableXhrSync&&(f=!1);var v=openXhr(og,S,W,!0,f,g.timeout);objForEachKey(g.headers,(function(g,m){v.setRequestHeader(g,m)})),v.onload=function(){var g=_getResponseText(v);xhrComplete(v,g),_handleCollectorResponse(g)},v.onerror=function(){xhrComplete(v)},v.ontimeout=function(){xhrComplete(v)},v.send(g.data)}function _doOnComplete(g,m,f,S){try{g(m,f,S)}catch(g){_throwInternal(_,2,518,dumpObj(g))}}function _beaconSendPost(g,m,f){var S=200,v=g._thePayload,C=g.urlString+(w?Zg:ag);try{var E=getNavigator();if(!E.sendBeacon(C,g.data))if(v){var T=[];arrForEach(v.batches,(function(g){if(T&&g&&g.count()>0){for(var m=g.events(),f=0;f<m.length;f++)if(!E.sendBeacon(C,B.getEventBlob(m[f]))){T.push(g.split(f));break}}else T.push(g.split(0))})),_sendBatchesNotification(T,8003,v.sendType,!0)}else S=0}catch(g){_warnToConsole(_,"Failed to send telemetry using sendBeacon API. Ex:"+dumpObj(g)),S=0}finally{_doOnComplete(m,S,{},ag)}}function _isBeaconPayload(g){return 2===g||3===g}function _adjustSendType(g){return $&&_isBeaconPayload(g)&&(g=2),g}function _hasIdleConnection(){return!O&&L<m}function _clearQueue(){var g=V;return V=[],g}function _canSendPayload(g,m,f){var S=!1;return g&&g.length>0&&!O&&E[m]&&B&&(S=0!==m||_hasIdleConnection()&&(f>0||N.allowRequestSending())),S}function _createDebugBatches(g){var m={};return g&&arrForEach(g,(function(g,f){m[f]={iKey:g.iKey(),evts:g.events()}})),m}function _sendBatches(m,f,S,v,C){if(m&&0!==m.length)if(O)_sendBatchesNotification(m,1,v);else{v=_adjustSendType(v);try{var I=m,b=0!==v;doPerf(T,(function(){return"HttpManager:_sendBatches"}),(function(_){_&&(m=m.slice(0));for(var T=[],I=null,A=Ph(),P=E[v]||(b?E[1]:E[0]),w=P&&P._transport,M=R&&($||_isBeaconPayload(v)||3===w||P._isSync&&2===w);_canSendPayload(m,v,f);){var O=m.shift();O&&O.count()>0&&(D.isTenantKilled(O.iKey())?T.push(O):(I=I||B.createPayload(f,S,b,M,C,v),B.appendPayload(I,O,g)?null!==I.overflow&&(m=[I.overflow].concat(m),I.overflow=null,_doPayloadSend(I,A,Ph(),C),A=Ph(),I=null):(_doPayloadSend(I,A,Ph(),C),A=Ph(),m=[O].concat(m),I=null)))}I&&_doPayloadSend(I,A,Ph(),C),m.length>0&&(V=m.concat(V)),_sendBatchesNotification(T,8004,v)}),(function(){return{batches:_createDebugBatches(I),retryCount:f,isTeardown:S,isSynchronous:b,sendReason:C,useSendBeacon:_isBeaconPayload(v),sendType:v}}),!b)}catch(g){_throwInternal(_,2,48,"Unexpected Exception sending batch: "+dumpObj(g))}}}function _buildRequestDetails(g,m){var f={url:M,hdrs:{},useHdrs:!1};m?(f.hdrs=extend(f.hdrs,U),f.useHdrs=objKeys(f.hdrs).length>0):objForEachKey(U,(function(g,m){ip[g]?_addRequestDetails(f,ip[g],m,!1):(f.hdrs[g]=m,f.useHdrs=!0)})),_addRequestDetails(f,Tg,"NO_AUTH",m),_addRequestDetails(f,Eg,Eh,m);var S=ag;arrForEach(g.apiKeys,(function(g){S.length>0&&(S+=","),S+=g})),_addRequestDetails(f,Ag,S,m),_addRequestDetails(f,bg,dateNow().toString(),m);var v=_getMsfpc3(g);if(isValueAssigned(v)&&(f.url+="&ext.intweb.msfpc="+v),N.shouldAddClockSkewHeaders()&&_addRequestDetails(f,Ig,N.getClockSkewHeaderValue(),m),T.getWParam){var C=T.getWParam();C>=0&&(f.url+="&w="+C)}for(var _=0;_<x.length;_++)f.url+="&"+x[_].name+"="+x[_].value;return f}function _setTimingValue(g,m,f){g[m]=g[m]||{},g[m][C.identifier]=f}function _doPayloadSend(g,m,f,S){if(g&&g.payloadBlob&&g.payloadBlob.length>0){var v=!!j.sendHook,C=E[g.sendType];!_isBeaconPayload(g.sendType)&&g.isBeacon&&2===g.sendReason&&(C=E[2]||E[3]||C);var I=G;(g.isBeacon||3===C._transport)&&(I=!1);var R=_buildRequestDetails(g,I);I=I||R.useHdrs;var w=Ph();doPerf(T,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var E=0;E<g.batches.length;E++)for(var M=g.batches[E].events(),D=0;D<M.length;D++){var O=M[D];if(H){var k=O.timings=O.timings||{};_setTimingValue(k,"sendEventStart",w),_setTimingValue(k,"serializationStart",m),_setTimingValue(k,"serializationCompleted",f)}O[Xg]>0?O[Xg]++:O[Xg]=1}_sendBatchesNotification(g.batches,1e3+(S||0),g.sendType,!0);var x={data:g.payloadBlob,urlString:R.url,headers:R.hdrs,_thePayload:g,_sendReason:S,timeout:b,disableXhrSync:A,disableFetchKeepAlive:P};I&&(_hasHeader(x.headers,fg)||(x.headers[fg]=pg),_hasHeader(x.headers,Sg)||(x.headers[Sg]=mg));var U=null;C&&(U=function(m){N.firstRequestSent();var onComplete=function(m,f){_retryRequestIfNeeded(m,f,g,S)},f=g.isTeardown||g.isSync;try{C.sendPOST(m,onComplete,f),j.sendListener&&j.sendListener(x,m,f,g.isBeacon)}catch(g){_warnToConsole(_,"Unexpected exception sending payload. Ex:"+dumpObj(g)),_doOnComplete(onComplete,0,{})}}),doPerf(T,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(U)if(0===g.sendType&&L++,v&&!g.isBeacon&&3!==C._transport){var m={data:x.data,urlString:x.urlString,headers:extend({},x.headers),timeout:x.timeout,disableXhrSync:x.disableXhrSync,disableFetchKeepAlive:x.disableFetchKeepAlive},f=!1;doPerf(T,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{j.sendHook(m,(function(g){f=!0,F||g._thePayload||(g._thePayload=g._thePayload||x._thePayload,g._sendReason=g._sendReason||x._sendReason),U(g)}),g.isSync||g.isTeardown)}catch(g){f||U(x)}}))}else U(x)}))}),(function(){return{thePayload:g,serializationStart:m,serializationCompleted:f,sendReason:S}}),g.isSync)}g.sizeExceed&&g.sizeExceed.length>0&&_sendBatchesNotification(g.sizeExceed,8003,g.sendType),g.failedEvts&&g.failedEvts.length>0&&_sendBatchesNotification(g.failedEvts,8002,g.sendType)}function _addEventCompletedTimings(g,m){H&&arrForEach(g,(function(g){_setTimingValue(g.timings=g.timings||{},"sendEventCompleted",m)}))}function _retryRequestIfNeeded(g,m,S,v){var C=9e3,_=null,E=!1,T=!1;try{var I=!0;if(typeof g!==xa){if(m){N.setClockSkew(m[_g]);var b=m[yg]||m["kill-duration-seconds"];arrForEach(D.setKillSwitchTenants(m[vg],b),(function(g){arrForEach(S.batches,(function(m){if(m.iKey()===g){_=_||[];var f=m.split(0);S.numEvents-=f.count(),_.push(f)}}))}))}if(200==g||204==g)return void(C=200);(!retryPolicyShouldRetryForStatus(g)||S.numEvents<=0)&&(I=!1),C=9e3+g%1e3}if(I){C=100;var A=S.retryCnt;0===S.sendType&&(A<f?(E=!0,_doAction((function(){0===S.sendType&&L--,_sendBatches(S.batches,A+1,S.isTeardown,$?2:S.sendType,5)}),$,retryPolicyGetMillisToBackoffForRetry(A))):(T=!0,$&&(C=8001)))}}finally{E||(N.setClockSkew(),_handleRequestFinished(S,C,v,T)),_sendBatchesNotification(_,8004,S.sendType)}}function _handleRequestFinished(g,m,f,S){try{S&&C._backOffTransmission(),200===m&&(S||g.isSync||C._clearBackOff(),_addCompleteTimings(g.batches)),_sendBatchesNotification(g.batches,m,g.sendType,!0)}finally{0===g.sendType&&(L--,5!==f&&j.sendQueuedRequests(g.sendType,f))}}function _addCompleteTimings(g){if(H){var m=Ph();arrForEach(g,(function(g){g&&g.count()>0&&_addEventCompletedTimings(g.events(),m)}))}}function _doAction(g,m,f){m?g():v.set(g,f)}function _convertAllHeadersToMap(g){var m={};isString2(g)&&arrForEach(strTrim(g).split(/[\r\n]+/),(function(g){if(g){var f=g.indexOf(": ");if(-1!==f){var S=strTrim(g.substring(0,f)).toLowerCase(),v=strTrim(g.substring(f+1));m[S]=v}else m[strTrim(g)]=1}}));return m}function _getMsfpc3(g){for(var m=0;m<g.batches.length;m++){var f=g.batches[m].Msfpc();if(f)return encodeURIComponent(f)}return ag}function _handleCollectorResponse(g){var m=j._responseHandlers;try{for(var f=0;f<m.length;f++)try{m[f](g)}catch(g){_throwInternal(_,1,519,"Response handler failed: "+g)}if(g){var S=JSON.parse(g);isValueAssigned(S.webResult)&&isValueAssigned(S.webResult[Mg])&&I.set("MSFPC",S.webResult[Mg],31536e3)}}catch(g){}}function _sendBatchesNotification(g,m,f,v){if(g&&g.length>0&&S){var C=S[_getNotificationAction(m)];if(C){var E=0!==f;doPerf(T,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){_doAction((function(){try{C.call(S,g,m,E,f)}catch(g){_throwInternal(_,1,74,"send request notification failed: "+g)}}),v||E,0)}),(function(){return{batches:_createDebugBatches(g),reason:m,isSync:E,sendSync:v,sendType:f}}),!E)}}}function _getNotificationAction(g){var m=ep[g];return isValueAssigned(m)||(m=gg,g>=9e3&&g<=9999?m=ug:g>=8e3&&g<=8999?m=cg:g>=1e3&&g<=1999&&(m=dg)),m}j.initialize=function(g,m,f,S,v){var D;v||(v={}),M=g+M,G=!!isUndefined3(v.avoidOptions)||!v.avoidOptions,T=m,I=m.getCookieMgr(),H=!T.config.disableEventTimings;var O=!!T.config.enableCompoundKey;_=(C=f).diagLog();var N=v.valueSanitizer,L=v.stringifyObjects;isUndefined3(v.enableCompoundKey)||(O=!!v.enableCompoundKey),b=v.xhrTimeout,A=!!v.disableXhrSync,P=!!v.disableFetchKeepAlive,w=!1!==v.addNoResponse,k=!isReactNative(),B=new Qg(T,N,L,O),isNullOrUndefined(v.useSendBeacon)||(k=!!v.useSendBeacon);var x=S,U=v.alwaysUseXhrOverride?S:null,V=v.alwaysUseXhrOverride?S:null,$=[3,2];if(!S){F=!1;var j=getLocation();j&&j.protocol&&"file:"===j.protocol.toLowerCase()&&(W=!1);var q=[];isReactNative()?(q=[2,1],$=[2,1,3]):q=[1,2,3],(S=_getSenderInterface(q=_prependTransports(q,v.transports),!1))||_warnToConsole(_,"No available transport to send events"),x=_getSenderInterface(q,!0)}U||(U=_getSenderInterface($=_prependTransports($,v.unloadTransports),!0)),R=!F&&(k&&isBeaconsSupported()||!P&&isFetchSupported(!0)),(D={})[0]=S,D[1]=x||_getSenderInterface([1,2,3],!0),D[2]=U||x||_getSenderInterface([1],!0),D[3]=V||_getSenderInterface([2,3],!0)||x||_getSenderInterface([1],!0),E=D},j._getDbgPlgTargets=function(){return[E[0],D,B,E]},j.addQueryStringParameter=function(g,m){for(var f=0;f<x.length;f++)if(x[f].name===g)return void(x[f].value=m);x.push({name:g,value:m})},j.addHeader=function(g,m){U[g]=m},j.canSendRequest=function(){return _hasIdleConnection()&&N.allowRequestSending()},j.sendQueuedRequests=function(g,m){isUndefined3(g)&&(g=0),$&&(g=_adjustSendType(g),m=2),_canSendPayload(V,g,0)&&_sendBatches(_clearQueue(),0,!1,g,m||0)},j.isCompletelyIdle=function(){return!O&&0===L&&0===V.length},j.setUnloading=function(g){$=g},j.addBatch=function(g){if(g&&g.count()>0){if(D.isTenantKilled(g.iKey()))return!1;V.push(g)}return!0},j.teardown=function(){V.length>0&&_sendBatches(_clearQueue(),0,!0,2,2)},j.pause=function(){O=!0},j.resume=function(){O=!1,j.sendQueuedRequests(0,4)},j.sendSynchronousBatch=function(g,m,f){g&&g.count()>0&&(isNullOrUndefined(m)&&(m=1),$&&(m=_adjustSendType(m),f=2),_sendBatches([g],0,!1,m,f||0))}}))}return HttpManager2.__ieDyn=1,HttpManager2}();function defaultSetTimeout(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];return setTimeout(g,m,f)}function defaultClearTimeout(g){clearTimeout(g)}function createTimeoutWrapper(g,m){return{set:g||defaultSetTimeout,clear:m||defaultClearTimeout}}var rp=.25,sp=500,ap=20,op=6,lp=2,cp=4,dp=2,hp=1,up="eventsDiscarded",gp="overrideInstrumentationKey",pp="maxEventRetryAttempts",mp="maxUnloadEventRetryAttempts",fp="addUnloadCb",Sp=function(g){function PostChannel2(){var m,f=g.call(this)||this;f.identifier="PostChannel",f.priority=1011,f.version="3.2.9";var S,v,C,_,E,T,I,b=!1,A=[],P=null,R=!1,w=0,M=500,D=0,O=1e4,N={},k=ng,L=null,F=null,x=0,U=0,V={},B=-1,H=!0,$=!1,G=op,j=lp;return dynamicProto(PostChannel2,f,(function(g,f){function _hookWParam(g){var f=g.getWParam;g.getWParam=function(){var g=0;return m.ignoreMc1Ms0CookieProcessing&&(g|=2),g|f()}}function _handleUnloadEvents(g){"beforeunload"!==(g||getWindow().event).type&&($=!0,v.setUnloading($)),_releaseAllQueues(2,2)}function _handleShowEvents(g){$=!1,v.setUnloading($)}function _addEventToQueues(g,m){if(g.sendAttempt||(g.sendAttempt=0),g.latency||(g.latency=1),g.ext&&g.ext[Dg]&&delete g.ext[Dg],g.ext&&g.ext[Og]&&g.ext[Og].id&&delete g.ext[Og].id,H&&(g.ext=optimizeObject(g.ext),g.baseData&&(g.baseData=optimizeObject(g.baseData)),g.data&&(g.data=optimizeObject(g.data))),g.sync)if(x||R)g.latency=3,g.sync=!1;else if(v)return H&&(g=optimizeObject(g)),void v.sendSynchronousBatch(Ng.create(g.iKey,[g]),!0===g.sync?1:g.sync,3);var f=g.latency,S=D,C=O;4===f&&(S=w,C=M);var _=!1;if(S<C)_=!_addEventToProperQueue(g,m);else{var E=1,T=ap;4===f&&(E=4,T=1),_=!0,_dropEventWithLatencyOrLess(g.iKey,g.latency,E,T)&&(_=!_addEventToProperQueue(g,m))}_&&_notifyEvents(up,[g],dc.QueueFull)}function _sendEventsForLatencyAndAbove(g,m,f){var S=_queueBatches(g,m,f);return v.sendQueuedRequests(m,f),S}function _hasEvents(){return D>0}function _scheduleTimer(){if(B>=0&&_queueBatches(B,0,E)&&v.sendQueuedRequests(0,E),w>0&&!F&&!R){var g=N[k][2];g>=0&&(F=_createTimer((function(){F=null,_sendEventsForLatencyAndAbove(4,0,1),_scheduleTimer()}),g))}var m=N[k][1];!L&&!P&&m>=0&&!R&&(_hasEvents()?L=_createTimer((function(){L=null,_sendEventsForLatencyAndAbove(0===U?3:1,0,1),U++,U%=2,_scheduleTimer()}),m):U=0)}function _initDefaults(){m=null,b=!1,A=[],P=null,R=!1,w=0,M=500,D=0,O=1e4,N={},k=ng,L=null,F=null,x=0,U=0,S=null,V={},C=void 0,_=0,B=-1,E=null,H=!0,$=!1,G=op,j=lp,T=null,I=createTimeoutWrapper(),v=new np(sp,dp,hp,{requeue:_requeueEvents,send:_sendingEvent,sent:_eventsSentEvent,drop:_eventsDropped,rspFail:_eventsResponseFail,oth:_otherEvent},I),_initializeProfiles(),_clearQueues(),_setAutoLimits()}function _createTimer(g,m){0===m&&x&&(m=1);var f=1e3;return x&&(f=retryPolicyGetMillisToBackoffForRetry(x-1)),I.set(g,m*f)}function _clearScheduledTimer(){return null!==L&&(I.clear(L),L=null,U=0,!0)}function _releaseAllQueues(g,m){_clearScheduledTimer(),P&&(I.clear(P),P=null),R||_sendEventsForLatencyAndAbove(1,g,m)}function _clearQueues(){V[4]={batches:[],iKeyMap:{}},V[3]={batches:[],iKeyMap:{}},V[2]={batches:[],iKeyMap:{}},V[1]={batches:[],iKeyMap:{}}}function _getEventBatch(g,m,f){var S=V[m];S||(S=V[m=1]);var v=S.iKeyMap[g];return!v&&f&&(v=Ng.create(g),S.batches.push(v),S.iKeyMap[g]=v),v}function _performAutoFlush(m,f){v.canSendRequest()&&!x&&(C>0&&D>C&&(f=!0),f&&null==P&&g.flush(m,null,20))}function _addEventToProperQueue(g,m){H&&(g=optimizeObject(g));var f=g.latency,S=_getEventBatch(g.iKey,f,!0);return!!S.addEvent(g)&&(4!==f?(D++,m&&0===g.sendAttempt&&_performAutoFlush(!g.sync,_>0&&S.count()>=_)):w++,!0)}function _dropEventWithLatencyOrLess(g,m,f,S){for(;f<=m;){var v=_getEventBatch(g,m,!0);if(v&&v.count()>0){var C=v.split(0,S),_=C.count();if(_>0)return 4===f?w-=_:D-=_,_notifyBatchEvents(up,[C],dc.QueueFull),!0}f++}return _resetQueueCounts(),!1}function _resetQueueCounts(){for(var g=0,m=0,_loop_1=function(f){var S=V[f];S&&S.batches&&arrForEach(S.batches,(function(S){4===f?g+=S.count():m+=S.count()}))},f=1;f<=4;f++)_loop_1(f);D=m,w=g}function _queueBatches(m,f,S){var C=!1,_=0===f;return!_||v.canSendRequest()?doPerf(g.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var g=[],f=4;f>=m;){var S=V[f];S&&S.batches&&S.batches.length>0&&(arrForEach(S.batches,(function(m){v.addBatch(m)?C=C||m&&m.count()>0:g=g.concat(m.events()),4===f?w-=m.count():D-=m.count()})),S.batches=[],S.iKeyMap={}),f--}g.length>0&&_notifyEvents(up,g,dc.KillSwitch),C&&B>=m&&(B=-1,E=0)}),(function(){return{latency:m,sendType:f,sendReason:S}}),!_):(B=B>=0?Math.min(B,m):m,E=Math.max(E,S)),C}function _flushImpl(g,m){_sendEventsForLatencyAndAbove(1,0,m),_resetQueueCounts(),_waitForIdleManager((function(){g&&g(),A.length>0?P=_createTimer((function(){P=null,_flushImpl(A.shift(),m)}),0):(P=null,_scheduleTimer())}))}function _waitForIdleManager(g){v.isCompletelyIdle()?g():P=_createTimer((function(){P=null,_waitForIdleManager(g)}),rp)}function _resetTransmitProfiles(){_clearScheduledTimer(),_initializeProfiles(),k=ng,_scheduleTimer()}function _initializeProfiles(){(N={})[ng]=[2,1,0],N[rg]=[6,3,0],N[sg]=[18,9,0]}function _requeueEvents(m,f){var S=[],v=G;$&&(v=j),arrForEach(m,(function(m){m&&m.count()>0&&arrForEach(m.events(),(function(m){m&&(m.sync&&(m.latency=4,m.sync=!1),m.sendAttempt<v?(setProcessTelemetryTimings(m,g.identifier),_addEventToQueues(m,!1)):S.push(m))}))})),S.length>0&&_notifyEvents(up,S,dc.NonRetryableStatus),$&&_releaseAllQueues(2,2)}function _callNotification(m,f){var S=g._notificationManager||{},v=S[m];if(v)try{v.apply(S,f)}catch(f){_throwInternal(g.diagLog(),1,74,m+" notification failed: "+f)}}function _notifyEvents(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];m&&m.length>0&&_callNotification(g,[m].concat(f))}function _notifyBatchEvents(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];m&&m.length>0&&arrForEach(m,(function(m){m&&m.count()>0&&_callNotification(g,[m.events()].concat(f))}))}function _sendingEvent(g,m,f){g&&g.length>0&&_callNotification("eventsSendRequest",[m>=1e3&&m<=1999?m-1e3:0,!0!==f])}function _eventsSentEvent(g,m){_notifyBatchEvents("eventsSent",g,m),_scheduleTimer()}function _eventsDropped(g,m){_notifyBatchEvents(up,g,m>=8e3&&m<=8999?m-8e3:dc.Unknown)}function _eventsResponseFail(g){_notifyBatchEvents(up,g,dc.NonRetryableStatus),_scheduleTimer()}function _otherEvent(g,m){_notifyBatchEvents(up,g,dc.Unknown),_scheduleTimer()}function _setAutoLimits(){_=m&&m.disableAutoBatchFlushLimit?0:Math.max(sp*(dp+1),O/6)}_initDefaults(),g._getDbgPlgTargets=function(){return[v]},g.initialize=function(_,E,b){doPerf(E,(function(){return"PostChannel:initialize"}),(function(){var A=E;f.initialize(_,E,b);try{E[fp];T=mergeEvtNamespace(createUniqueNamespace(g.identifier),E.evtNamespace&&E.evtNamespace());var P=g._getTelCtx();_.extensionConfig[g.identifier]=_.extensionConfig[g.identifier]||{},m=P.getExtCfg(g.identifier),I=createTimeoutWrapper(m.setTimeoutOverride,m.clearTimeoutOverride),H=!m.disableOptimizeObj&&isChromium(),_hookWParam(A),m.eventsLimitInMem>0&&(O=m.eventsLimitInMem),m.immediateEventLimit>0&&(M=m.immediateEventLimit),m.autoFlushEventsLimit>0&&(C=m.autoFlushEventsLimit),isNumber3(m[pp])&&(G=m[pp]),isNumber3(m[mp])&&(j=m[mp]),_setAutoLimits(),m.httpXHROverride&&m.httpXHROverride.sendPOST&&(S=m.httpXHROverride),isValueAssigned(_.anonCookieName)&&v.addQueryStringParameter("anoncknm",_.anonCookieName),v.sendHook=m.payloadPreprocessor,v.sendListener=m.payloadListener;var R=m.overrideEndpointUrl?m.overrideEndpointUrl:_.endpointUrl;g._notificationManager=E.getNotifyMgr(),v.initialize(R,g.core,g,S,m);var w=_.disablePageUnloadEvents||[];addPageUnloadEventListener(_handleUnloadEvents,w,T),addPageHideEventListener(_handleUnloadEvents,w,T),addPageShowEventListener(_handleShowEvents,_.disablePageShowEvents,T)}catch(m){throw g.setInitialized(!1),m}}),(function(){return{coreConfig:_,core:E,extensions:b}}))},g.processTelemetry=function(f,S){setProcessTelemetryTimings(f,g.identifier);var v=(S=g._getTelCtx(S)).getExtCfg(g.identifier),C=!!m.disableTelemetry;v&&(C=C||!!v.disableTelemetry);var _=f;C||b||(m[gp]&&(_.iKey=m[gp]),v&&v[gp]&&(_.iKey=v[gp]),_addEventToQueues(_,!0),$?_releaseAllQueues(2,2):_scheduleTimer()),g.processNext(_,S)},g._doTeardown=function(g,m){_releaseAllQueues(2,2),b=!0,v.teardown(),removePageUnloadEventListener(null,T),removePageHideEventListener(null,T),removePageShowEventListener(null,T),_initDefaults()},g.setEventQueueLimits=function(g,m){O=g>0?g:1e4,C=m>0?m:0,_setAutoLimits();var f=D>g;if(!f&&_>0)for(var S=1;!f&&S<=3;S++){var v=V[S];v&&v.batches&&arrForEach(v.batches,(function(g){g&&g.count()>=_&&(f=!0)}))}_performAutoFlush(!0,f)},g.pause=function(){_clearScheduledTimer(),R=!0,v.pause()},g.resume=function(){R=!1,v.resume(),_scheduleTimer()},g.addResponseHandler=function(g){v._responseHandlers.push(g)},g._loadTransmitProfiles=function(g){_resetTransmitProfiles(),objForEachKey(g,(function(g,m){var f=m.length;if(f>=2){var S=f>2?m[2]:0;if(m.splice(0,f-2),m[1]<0&&(m[0]=-1),m[1]>0&&m[0]>0){var v=m[0]/m[1];m[0]=Math.ceil(v)*m[1]}S>=0&&m[1]>=0&&S>m[1]&&(S=m[1]),m.push(S),N[g]=m}}))},g.flush=function(g,m,f){if(void 0===g&&(g=!0),!R)if(f=f||1,g)null==P?(_clearScheduledTimer(),_queueBatches(1,0,f),P=_createTimer((function(){P=null,_flushImpl(m,f)}),0)):A.push(m);else{var S=_clearScheduledTimer();_sendEventsForLatencyAndAbove(1,1,f),null!=m&&m(),S&&_scheduleTimer()}},g.setMsaAuthTicket=function(g){v.addHeader(Pg,g)},g.hasEvents=_hasEvents,g._setTransmitProfile=function(g){k!==g&&void 0!==N[g]&&(_clearScheduledTimer(),k=g,_scheduleTimer())},g._backOffTransmission=function(){x<cp&&(x++,_clearScheduledTimer(),_scheduleTimer())},g._clearBackOff=function(){x&&(x=0,_clearScheduledTimer(),_scheduleTimer())},objDefineAccessors(g,"_setTimeoutOverride",(function(){return I.set}),(function(g){I=createTimeoutWrapper(g,I.clear)})),objDefineAccessors(g,"_clearTimeoutOverride",(function(){return I.clear}),(function(g){I=createTimeoutWrapper(I.set,g)}))})),f}return __extendsFn(PostChannel2,g),PostChannel2.__ieDyn=1,PostChannel2}($d),vp=Sp,yp="_dropInst";function _copyObjProperties(g,m){if(m)for(var f=objKeys(m),S=0;S<f.length;S++){var v=f[S];hasOwnProperty(g,v)||(g[v]=m[v])}}function _isChannel(g){return g.pause&&g.teardown&&g.flush}function _getEndpointUrl(g,m){var f=null;if(m){m.endpointUrl&&(f=m.endpointUrl);var S=(m.extensionConfig||{})[g]||{};S.overrideEndpointUrl&&(f=S.overrideEndpointUrl)}return f}var Cp=function(g){function ChildNotificationManager2(m,f){var S=g.call(this)||this;return dynamicProto(ChildNotificationManager2,S,(function(g,S){function _getEvents(g){var f=[];return g&&arrForEach(g,(function(g){g.iKey===m&&f.push(g)})),f}function _hasListeners(m){if(g[m]&&g.listeners)for(var f=0;f<g.listeners.length;f++){var S=g.listeners[f];if(S&&S[m])return!0}return!1}var v={eventsSent:function(m){if(_hasListeners("eventsSent")){var f=_getEvents(m);f.length>0&&g.eventsSent(f)}},eventsDiscarded:function(m,f){if(_hasListeners("eventsDiscarded")){var S=_getEvents(m);S.length>0&&g.eventsDiscarded(S,f)}},eventsSendRequest:function(m,f){_hasListeners("eventsSendRequest")&&g.eventsSendRequest(m,f)},perfEvent:function(m){_hasListeners("perfEvent")&&g.perfEvent(m)}};f.addNotificationListener(v)})),S}return __extendsFn(ChildNotificationManager2,g),ChildNotificationManager2.__ieDyn=1,ChildNotificationManager2}(Xd),_p=function(){function ApplicationInsightsManager2(){var g,m,f,S,v,C,_,E,T,I,b,A,P,R,w=null,M=null;dynamicProto(ApplicationInsightsManager2,this,(function(D){function _initDefaults(){g={},m=[],f=null,S=null,v=[],C=[],_={},E=null,T=null,I=null,b=null,A=null,P=null,R=!1}function _registerPlugin(m,f){if(void 0===f&&(f=null),m){(_isChannel(m)?C:v).push(m);var S=m.identifier;g.extensionConfig[S]=g.extensionConfig[S]||{},_copyObjProperties(g.extensionConfig[S],f)}return m}function _initializeSharedChannels(){var m=g.channels||[[]],f=new vp,S=f.identifier,v=!1;T=null,I=null,arrForEach(m,(function(g){arrForEach(g,(function(g){isFunction2(g)||(_registerPlugin(g),g.identifier===S&&(v=!0,T=g))}))})),v||(m[0].push(f),T=_registerPlugin(f,g.channelConfiguration)),g.channels=m}function _initializeSharedExtensions(f){m=[],E=_registerPlugin(new Hu,g.propertyConfiguration),m.push(E),g.extensions&&arrForEach(g.extensions,(function(g){isFunction2(g)||_registerPlugin(g)})),f&&arrForEach(f,(function(g){g&&!isFunction2(g)&&m.push(_registerPlugin(g))}))}function _initializeSharedInstance(v){if(!f){R||_throwInternal(D.diagLog(),2,520,"The Shared Manager is not yet created, the returned shared instance will be overwritten");var C=_createMergedConfig(v||g.instrumentationKey||"_not_defined_",{});S=new Xd,(f=new Ep(D,D.diagLog(),S)).initialize(C,m),f.isInitialized()&&T&&(I=_getEndpointUrl(T.identifier,C)),w&&f.setCookieMgr(w)}}function _createMergedConfig(m,f){var S={};return S.instrumentationKey=m,S.channels=_createMergedChannels(f),_populateMergedConfigExtensions(S),_copyObjProperties(S,f),_copyObjProperties(S,g),S}function _createMergedChannels(m){var f=[[]];return g.channels&&arrForEach(g.channels,(function(g,m){isFunction2(g)||(f[m]=f[m]||[],f[m]=f[m].concat(g))})),m&&m.channels&&arrForEach(m.channels,(function(g,m){isFunction2(g)||(f[m]=f[m]||[],f[m]=f[m].concat(g))})),f}function _populateMergedConfigExtensions(m){var f=[];g.extensions&&g.extensions.length>0&&(f=f.concat(g.extensions)),m&&m.extensions&&m.extensions.length>0&&(f=f.concat(m.extensions)),f.length>0&&(m.extensions=f),m.extensionConfig=m.extensionConfig||{},_copyObjProperties(m.extensionConfig,g.extensionConfig)}function _createMergedExtensions(g){var f=[];return m&&m.length>0&&(f=f.concat(m)),g&&g.length>0&&(f=f.concat(g)),f}function _unloadInstance(g,m,f,S){var v=_[g];v&&(v.inst&&v.inst.isInitialized()?v.inst.unload(m,(function(m){f&&f(g,m)}),S):f&&f(g,{reason:50,isAsync:m,flushComplete:!1}))}_initDefaults(),D.diagLog=function(){return b||(b=new Fc(g)),b},D.getCookieMgr=function(){return _initializeSharedInstance(),w||f.getCookieMgr()},D.setCookieMgr=function(g){w=g,f&&f.setCookieMgr(g)},D.getPerfMgr=function(){return P||g&&g.enablePerfMgr&&(P=M||new $c(D.getNotifyMgr())),P},D.setPerfMgr=function(g){M=g,P=g},D.create=function(m,S){R?_throwInternal(D.diagLog(),2,514,"Shared Manager has already been initialized."):(g=m||{},f=null,_initializeSharedChannels(),_initializeSharedExtensions(S))},D.getInst=function(g){return(_[g]||{}).inst},D.newInst=function(g,m,v){var C=D.getInst(g);if(C)return _throwInternal(D.diagLog(),2,514,"Instance already exists for ["+g+"]"),C;if(_initializeSharedInstance(g),f.isInitialized()){var E=_createMergedConfig(g,m);if(T){var b=_getEndpointUrl(T.identifier,E);I&&b&&I!==b&&_throwInternal(D.diagLog(),2,511,"The endpointUrl mismatch, shared Url ["+I+"] is different from configured ["+b+"] shared will be used!")}var A=new Cp(g,S);C=new Ep(D,D.diagLog(),A),_[g]={iKey:g,inst:C,notifyMgr:A},C.setPerfMgr(D.getPerfMgr()),C.initialize(E,_createMergedExtensions(v)),C.isInitialized()||(_throwInternal(D.diagLog(),2,520,"Failed to initialize new instance!"),C=null,delete _[g])}return C},D.getSharedPlugin=function(g){_initializeSharedInstance();var m=null,S=f.getPlugin(g);return S&&(m=S.plugin),m},D.getPropertyManager=function(){return _initializeSharedInstance(),E},D.getPostChannel=function(){return _initializeSharedInstance(),T},D.getNotifyMgr=function(){return A||(A=new Xd),A},D.unload=function(g,m,S){var v=objKeys(_),C=v.length+1,E={reason:50,isAsync:g,flushComplete:!1};function _doUnload(g,f){0===--C&&(_initDefaults(),m&&m(f))}f&&(arrForEach(v,(function(m){_unloadInstance(m,g,(function(g,m){_doUnload(g,m)}),S)})),f.isInitialized()&&(f.unload(g,(function(g){_doUnload(null,E=g)}),S),f=null)),_doUnload(null,E)},D[yp]=function(g){g&&_.iKey&&delete _[g]}}))}return ApplicationInsightsManager2.__ieDyn=1,ApplicationInsightsManager2}(),Ep=function(g){function ApplicationInsights3(m,f,S){var v,C=g.call(this)||this,_=m;return dynamicProto(ApplicationInsights3,C,(function(g,m){g.getSharedPropertyManager=function(){return _.getPropertyManager()},g.getSharedPostChannel=function(){return _.getPostChannel()},g.getOverridePropertyManager=function(){return v},g.initialize=function(C,_){doPerf(g,(function(){return"ApplicationInsights:initialize"}),(function(){var E=[v=new ig];_&&(E=E.concat(_)),C.extensionConfig=C.extensionConfig||[];var T=C.propertyConfiguration||{};C.propertyConfiguration&&delete C.propertyConfiguration,C.extensionConfig[v.identifier]=T;try{m.initialize(C,E,f,S)}catch(m){_throwInternal(g.logger,1,514,"Failed to initialize SDK."+dumpObj(m))}}),(function(){return{config:C,extensions:_}}))},g.unload=function(f,S,v){_[yp]&&_[yp]((g.config||{}).instrumentationKey),m.unload(f,S,v)}})),C}return __extendsFn(ApplicationInsights3,g),ApplicationInsights3.__ieDyn=1,ApplicationInsights3}(Rh);function getPlatformConfig(){const g=getBrowserInfo();return"ChromiumAVD"===g.engine?new bp:"Safari"===g.engine?new Ap(g):"Firefox"===g.name?new Pp:isVdiBrowser(g)?new Rp:"Chromium"===g.engine?new wp(g):new Tp}var Tp=class{getInitialSettings(){return{resizeModeForSharing:void 0,enableAudioProcessingFallback:!1,allowVirtualDeviceInCall:!1,activeSpeaker:{timeToPromote:1e4},dtmf:{toneDuration:200,toneGap:100},mediaStreamHoldInterval:5e3,webrtcContributingSourcesPollingInterval:1e3,webrtcIceGatheringTimeoutMs:2e4,webrtcAllowedMediaContentType:je.ALLOWED_CONTENT_TYPES.SDP_NGC,webrtcMediaContentType:je.CONTENT_TYPE.SDP,webrtcScreensharingCapabilityMaxFS:8160,webrtcScreensharingCapabilityMaxFPS:1500,webrtcStatHwSilentDetectionDuration:5,webrtcStatHwSilentDetectionLevel:14,webrtcStatPollInterval:1e3,webrtcStatStoredRecordsNumber:60,webrtcStatNetworkDetectionDuration:10,webrtcHealedRatioExtendedWindowSize:20,webrtcStatNetworkDetectionHysteresis:.01,webrtcStatNetworkDetectionBadLevel:.17,webrtcStatNetworkDetectionGoodLevel:.15,webrtcMinAudioSamplesRecvForNetworkRecvQuality:48e4,webrtcVideoCapabilityCheckIntervalMin:2e4,webrtcVideoCapabilityCheckIntervalMinMultiparty:5e3,webrtcVideoCapabilityCheckIntervalMax:3e4,webrtcVideoCapabilityCheckIntervalMaxMultiparty:5500,webrtcScreensharingCapabilityCheckIntervalMin:0,webrtcScreensharingCapabilityCheckIntervalMax:0,webrtcVideoCapabilityMaxFS:3600,webrtcVideoCapabilityMaxFPS:3e3,webrtcMultiPartyRecvVideoMaxFS:3600,webrtcRecvVideoMaxFS:8160,webrtcCameraOpenFs:3600,minCameraOpenFps:15,maxCameraOpenFps:30,webrtcMultipartyMaxScalingFs:3600,webrtcMaxScalingFs:8160,webrtcVideoScaling:!1,webrtcVideoScalingMultiparty:!0,enableOptimalVideoCount:!1,ovcBandwidthPerVideoReceiver:2e5,ovcSlidingWindowPercentile:.3,ovcSlidingWindowSamples:20,nonEstimatedDefaultVideoReceiversCount:4,ovcMaxCount:4,ovcMaxCountXL:4,ovcXLParticipantsCount:100,ovcIgnoreFirstSamples:10,ovcAvailableConcurrencyForBiggerGrid:4,ovcMemoryForBiggerGrid:2,ovcRampUpCooldown:15e3,ovcRampDownCooldown:1e4,webrtcStatNetworkDetectionEnabled:!0,webrtcUseNewStatsApi:!0,useAudioAnalyzer:!0,webrtcVideoSubscriptionDisposeTimeout:2e3,webrtcCompareContentTypeInOffer:!0,iceServerTransport:"udp,tcp,tls",iceHostCandidateOnly:!0,iceUdpAddressType:"ip",iceTcpAddressType:"ip",renegotiationAttempts:3,reconnectTimeLimit:9e4,initialReconnectTimeLimit:0,maxReconnectDelayTime:5,waitForRelayOnReconnect:!0,relayWaitSaneTimeoutMs:25e3,reconnectOnDisconnect:!1,reconnectWithNoRelays:!1,reconnectWithProbes:!1,reconnectWaitTimeAfterProbe:1e3,reconnectOnPcClose:!0,reconnectWakeupTimeLimit:18e4,webrtcSpeakingWhileMutedBadDuration:3,webrtcSpeakingWhileMutedDetectionLevel:4e3,webrtcNegotiateDisabledDataModality:!1,recoverableMediaErrors:[je.MEDIA_ERROR.iceConnectionError,je.MEDIA_ERROR.noNetworkError,je.MEDIA_ERROR.srtpError,je.MEDIA_ERROR.incompatibleOffer,je.MEDIA_ERROR.internalError].join(","),forceReconnectErrors:[je.MEDIA_ERROR.audioPlaybackError].join(","),sendCallStartupTelemetry:!0,webrtcMultiPartyRecvVideoSignaling:!0,webrtcVideoDelayThreshold:10,webrtcEndOfCallFreezeThreshold:3,webrtcSubscriptionEventLimit:300,webrtcHandleRollback:!0,webrtcHandleRemoteRollback:!1,losingConnectivityTimeoutMs:-1,iceCandidateFilterMDns:!0,webrtcInjectTransportCCAudio:!1,webrtcInjectTransportCCAudioMultiparty:!0,webrtcRejectedFeatures:"byPass",webrtcRequiredFeatures:"nonByPass",webrtcSimulcastSessionEnabled:!1,webrtcSimulcastStreamsCountForVideo:1,webrtcSimulcastStreamsCountForSharing:1,webrtcFmtParamListSupported:!0,webrtcNegotiatedSsrcRangeForVideo:0,webrtcNegotiatedSsrcRangeForSharing:0,webrtcNegotiatedSsrcRangeForVideoOneToOne:0,webrtcNegotiatedSsrcRangeForSharingOneToOne:0,webrtcAllowRestoreKeyframe:!1,webrtcEnabledCustomBwEstimationForVideo:!1,webrtcDisabledSenderBitrate:1e3,maxStoredPreferredResolutionCount:4,maxStoredQualityLimitationReasonEvents:30,maxStoredUFDCount:50,simulcastTelemetryLayoutsPerSession:5,simulcastTelemetryNumModalitySessions:3,simulcastTelemetryNumFMTP:10,maxSendVideoCapabilitiesReportingForVideoEnabled:!1,maxSendVideoCapabilitiesReportingForSharingEnabled:!1,maxSendVideoCapabilitiesReportingUseMaximumWidthHeight:!0,maxSendVideoCapabilitiesReportingSendMaxFs:!1,maxSendVideoCapabilitiesReportingSendMaxMbps:!1,maxReportedOvershootingEvents:20,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!0,adpRequestAVLast:!0,rememberNegative:!1,persistOnDeniedError:!0,disableOnPermissionDeniedOnly:!1},devices:{blacklist:{microphone:"stereo mix \\(",camera:"(ir camera|avstream media device)",speaker:"stereo mix \\("},overrideDefault:!1,compositeLabelMatchingThreshold:.5,piiSafeWords:["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"],pollingIntervalActive:3e3,enumerateDevicesTimeout:25e3,enumerateDevicesAfterADP:!1},useGoogPrefixAudioConstraints:!0,multiviewResolutionLimits:{1:720,2:720,3:540,4:360,more:360},maxSpotlightResolution:720,multiviewResolutionLimitUpdateThrottleDelay:300,useMultiviewLimitsOnInitialRequest:!0,useApplyChannelParametersForSourceRequests:!1,maxVideoFreezeTimestampsInBucket:5,webrtcSendBandwidthNotificationsEnabled:!1,webrtcSendBandwidthIgnoredUpdateLimit:6,webrtcSendBandwidthThreshold:.1,checkSupportForWebrtc_1_0:!1,webrtcLastAppliedVideoCapabilitiesCount:5,webrtcLastAppliedVideoCapabilitiesSequenceCount:5,gumRequestTimeout:2e4,setMinFpsForWebkit:!1,videoCaptureFreezeTimeout:5e3,webrtcCloseAfterIceFailure:!0,audioBandwidthInKbps:90,videoBandwidthAllocation:.3,enableQosSupport:!1,forceUnbundledTransport:!1,allowedAudioCodecs:[],allowedVideoCodecs:[],allowedVideoCodecsMultiparty:[{clockRate:9e4,mimeType:"video/H264"},{clockRate:9e4,mimeType:"video/rtx"}],filterCodecsInSdp:!1,filterCodecsInSdpMultiparty:!0,filterCodecsInSdpV2:!1,reduceRtcpFbInSdp:[],reduceRtcpFbInSdpMultiparty:["goog-remb","transport-cc","ccm/fir","nack","nack/pli"],subscribeToSsrcForVideo:!1,audioRendererUsePauseOnDetach:!0,audioRendererRestartOnPause:!1,audioRendererRestartOnDeviceError:!0,disableAudioOutputSelection:!1,preferSdesSrtp:!1,preferSdesSrtpPstn:!1,useLocalStorageForOneDs:!0,useOneDsLogger:!1,useSendBeaconSync:!1,addTelemetryReportingCallback:!0,eventsLimitInMem:200,eventLatency:fh.Normal,eventLatencyRealTime:fh.RealTime,enableCompoundKey:!1,telemetryTenants:{signaling:"53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",media:"1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",realtimeMedia:"5aea257f81424f5d8574e57a50974ead-d3a768ce-590c-4595-ab85-3dd046114290-6701",tlePlayer:"2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326"},transmitProfileName:"REAL_TIME",transmitProfileTimings:[],waitReportStatsAtCallStop:!1,oneStreamPerDeviceType:!1,enableWebRtcInternalsLogs:!1,enableMultiViewStats:!0,webrtcBWJumpLowerLimit:1e5,webrtcBWJumpUpperLimit:3e5,uplinkBWStabilizationSlidingWindowSize:10,uplinkBWStabilizationMaxDeviation:.1,uplinkBWStabilizationMinBandwidth:1e5,downlinkBWStabilizationSlidingWindowSize:10,downlinkBWStabilizationMaxDeviation:.1,downlinkBWStabilizationMinBandwidth:1e5,maxKeyFrameTimestampsInBucket:5,enableAudioSharing:!1,enableStopSharingWithIncomingOffer:!0,enableDevtoolsAPI:!1,enableDataChannel:!1,enableDataChannelMultiparty:!0,enableDataChannelPstn:!1,alwaysNegotiateDataChannel:!0,webrtcDataChannel:{enableFragmentation:!1,fragmentationSize:0,enableSendScheduler:!1,rateLimiterCheckInterval:250,discardOnSendFailure:!1,bufferedAmountLowThreshold:65535,bufferedAmountHighThreshold:262144,maxBitrate:0,maxPacketRate:0,maxQueueSize:524288,dataIds:[]},acceptDisabledDataModality:!0,rejectUnbundledDataModality:!0,sctpPort:5e3,enableGiveControl:!1,maxStoredDataChannelValues:15,mediaControlPlaneConfig:{enableBweNotifications:!0,enableDominantSpeakerHistory:!0,enableSourceRequests:!1,sourceRequestsMessagesTimeout:1e4,storedSRRecordsCount:60,verboseTelemetry:!1,sendDuplicates:!1},localPreviewMirroringSupported:!1,enableVideoEffects:!0,useRawMediaApiForVideoEffects:!1,forceKeyFrameV2ScaleFactor:1.1,effectsTelemetryBufferSize:20,wasmdns:{pTime:10,goodPerfThreshold:8,poorPerfThreshold:10,badPerfThreshold:12,perfWindowLength:10,enableNoiseSuppression:!1,noiseSuppressionMode:"Off",backgroundMode:!1},wasmvqe:{enableAec:!1,enableVqe:!1,backgroundMode:!1,performanceThresholdMs:8,performanceWindowDurationSecs:10,defaultVqeMode:zn.VqeMode.Off,callType:zn.CallType.Conference,audioUsageMode:zn.AudioUsageMode.Default,performanceProfile:zn.AecPerfProfile.Normal},webcv:{qualityConfig:{outputFps:{min:15,max:30},outputResolution:720,preserveResolution:!0,degradationLadder:[{resolution:{width:1920,height:1080},fps:{min:15,max:30}},{resolution:{width:1280,height:720},fps:{min:15,max:30}},{resolution:{width:960,height:540},fps:{min:15,max:30}},{resolution:{width:640,height:360},fps:{min:13,max:30}},{resolution:{width:416,height:234},fps:{min:10,max:20}},{resolution:{width:320,height:180},fps:{min:10,max:20}}],initialLadderResolution:720,improvementFpsThresholdPercent:20,statsIntervalSec:5,enableMaskPropagation:!1,maskPropagationFramesInterval:30},powerPreference:qn.PowerPreference.HighPerformance,useInsertableStreams:!1,webGLUnsupportedRenderers:["Google SwiftShader"],webGLRequiredExtensions:["EXT_color_buffer_float","WEBGL_debug_renderer_info","OES_texture_float_linear"],usePreheat:!1,useSharedArrayBuffer:!0,useWasmEffects:!1,processorType:qn.ProcessorType.Webgl2},insertFakeCandidateIfNeeded:!0,useSdpCapabilitiesLegacySession:!0,useSdpCapabilities:!0,enableH264SpsPpsIdrKeyframe:!0,disableMsSdp:!1,disableSdes:!1,disableIceReinvite:!1,iceDisconnectedTimeoutMs:3e4,enableLocalVideoConstraints:!0,webrtcAudioChannelSignalingFeedback:"app recv:dsh",webrtcVideoChannelSignalingFeedback:"app send:src recv:src,vc",webrtcResolutionManagerCooldownTimeout:15e3,webrtcResolutionManagerRetryDelay:5e3,webrtcNativeCpuOveruseDisabled:!1,webrtcDisplayStreamContentHint:"text",h264SendProfileOverride:"42C02A",addFmtpToInitialSubscription:!0,h264SubscribeProfile:"64001f",notRenderingTimeInterval:{video:3,sharing:10},notRenderingLowBitrateThreshold:6,notRenderingLowFramerateThreshold:3,isBytesRecvUsedInIsRenderingCalculation:!0,useConnectionState:!0,useDtlsTrasportConnectionCheck:!1,enableNetworkRecvQualityUFD:!0,enableNetworkSendQualityUFD:!0,enableSignalingAudioPermissionDeniedUFD:!1,webrtcJitterLowThreshold:.2,webrtcJitterHighThreshold:.35,webrtcJitterSticknessTime:5e3,webrtcLossRateLowThreshold:.2,webrtcLossRateHighThreshold:.3,webrtcLossRateSticknessTime:5e3,webrtcMinPacketsSentForNetworkSendQuality:200,webrtcLossRateWindowSize:3,webrtcJitterWindowSize:3,networkSendQualityDiagnostics:!1,networkRecvQualityDiagnostics:!1,webrtcJitterExtendedWindowSize:6,webrtcLossRateExtendedWindowSize:6,freezeMinDuration:128,freezeIntervalFrequency:1e3,minPacketsReceivedToCalculatePacketLossRate:100,healedRatioPrecision:8,jitterPrecision:3,requestNewStreamOnUnmute:!0,raiseVideoMuteUfd:!1,useMediaQualityController:!1,useMediaQualityControllerForceKeyFrame:!1,layoutControlTimeout:1e4,extmapAllowMixed:!1,enableVla:!1,allowRemoteVla:!1,enableNonAdvVla:!1,specCompliantSimulcast:{},specCompliantSimulcastMultiparty:{video:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1],minFsForSimulcast:920,useApplyConstraints:!1},sharing:{enableLocally:!1,allowEnableRemotely:!1,layerScaleFactors:[1]},allowOverride:!1,constraintsDisableVla:!0,collectResolutionInfo:!0,maxBrControlEnabled:!1,allowedBweOvershootRatio:1,allowResLimit:!1},enforceOpusFmtpMultiparty:{usedtx:1},videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!1,mapSsrcToTrackForStats:!1,enableVideoOrientationExtension:!1,speakerGainLevel:0,ignoreClosedDtlsTransportState:!1,disconnectOnPageHide:!0,renderThroughCanvas:!1,isRenderingBasedOnRawStatistics:!1,enableDevicePixelRatio:!0,useSetParametersToApplyCapabilities:!1,enablePlatformCallConstraints:!1,enablePlatformCallConstraintsPerCall:!1,enableDynamicCallConstraints:!0,numCallConstraintsEvents:6,setParametersMaxBitrateUndefined:!1,onAddTrackRemoveOtherTracks:!0,avoidFakeStreamsDuringEscalation:!0,navConnectionPollingInterval:1e3,navConnectionNumSamplesToCollect:60,allowProvisionalAnswer:!1,allowProvisionalAnswerPstn:!0,acceptProvisionalAnswerFromPstnOnly:!0,disableIncomingDtlsRoleOverride:!1,disableOutgoingDtlsRoleOverride:!1,statsAllowAnyVideoSendTrack:!1,pictureInPicture:{enablePictureInPicture:!1,aspectRatioHorizontal:16,aspectRatioVertical:9,maxActiveStreams:1,minStreamGridCellWidth:160,dominantStreamChangeDebounce:3e3,statisticsBufferSize:20,multiStreamWorkerURL:""},showStatsInCall:!1,useSetStreamsForSender:!0,addPrefixForMsidInSdp:!1,enableMuteSpeakerUnmuteSpeakerWorkaround:!1,alwaysRaiseBadDeviceEvents:!1,removeRecvStreamOnEnded:!0,requiredVideoCodecs:["h264"],primaryVideoCodecs:["h264","vp8","vp9"],removeUnsupportedVideoModality:!1,enableActiveSpeakerBasedDSH:!0,enableInitialSignalingDSHSubscription:!0,enableSignalingDSHFallback:!1,emptyInitialDSH:!0,bwPercentiles:[5,50,95],enableTimerTracker:!1,diagnostics:{sideBySide:!0,useForTelemetry:!1,collectWhileNotConnected:!1,collectionLimits:{numDeviceEvents:200,numVideoEffectsEvents:100,numAudioEffectsEvents:100,numOvershootEvents:100,numIsRenderingEvents:100,numStatsReports:600,numStatsErrors:100,numSubscriptionEvents:100,numUFDs:100,numNativeSessions:3,numSessions:3,numNetworkEvents:50,numReconnects:50,numCapabilitiesRequested:60,numCapabilitiesApplied:60,maxVideoStatsAfterSubscription:30,numResolutionSwitches:10,numSamplesForE2E:4},telemetryLimits:{numDeviceEvents:50,numVideoEffectsEvents:50,numAudioEffectsEvents:50,numOvershootEvents:20,numIsRenderingEvents:4,numPreferredResolutions:3,numSubscriptionEvents:100,numUFDs:50,numAggregatedSamples:60,numStatsErrors:20,numCapabilitiesRequested:5,numCapabilitiesApplied:3,maxVideoStatsAfterSubscription:30,numNetworkEvents:20,numReconnects:10,numRendererStateChangedEvents:10},teamsRealtimeTelemetry:{pollingInterval:15},performanceMonitoring:{useComputePressure:!1,fluctuationSamplesNum:5,enableRemoteVideoCalculator:!1,enableLowerResolution:!1,monitoringStrategy:"decodeTime",decodeThresholds:{1080:{fps:30,maxDecodeTime:20},720:{fps:30,maxDecodeTime:15},540:{fps:30,maxDecodeTime:11},360:{fps:30,maxDecodeTime:9},234:{fps:15,maxDecodeTime:10},180:{fps:15,maxDecodeTime:10}},defaultThrehold:{fps:30,maxDecodeTime:60},fpsDiffThresholds:{1080:{fps:30,fpsDiff:4},720:{fps:30,fpsDiff:4},540:{fps:30,fpsDiff:4},360:{fps:30,fpsDiff:4},234:{fps:15,fpsDiff:2},180:{fps:15,fpsDiff:2}},defaultFpsDiffThreshold:{fps:30,fpsDiff:10},volatilityThresholds:{1080:10,720:10,540:10,360:10,234:5,180:5},defaultVolatilityThreshold:10,remoteVideoTrackInterval:10,telemetryResolutionRequestSpanMs:5e3,cpuMetricCollector:3},features:{takeFreezeTelemetryFromGathererV2:!0,useLastSampleDeltaPerSecondConverter:!1}},requireUserActionForAudioSharing:!1,postponeAudioMixerForAudioSharing:!1,reassignMediaStreamAudioTrackAfterCreation:!1,deactiveAudioSender:!1,webrtcForceSdesForS1:!1,webrtcPranswerWaitForMediaPollingInterval:1e3,webrctRemoveVideoModalitiesForPstn:!1,removeSendersOnConfigureModalities:!0,streamAvailabilityConsiderModalities:!1,setBWSeed:!1,bwSeedOptions:{mids:["*"],aggregation:"const",aggregateLastN:null,constValue:-1,cappingValue:-1,useLocalStorage:!1,localStorageKey:"bwSeed"},stopCallOnAcceptFailure:!0,allowMediaBypass:!0,enablePermissionsWorkaround:!1,disposeSendersSync:!1,disposeStreamsSync:!1,maxVideoStatsAfterSubscription:30,ecsConfigTimeout:2e4,contributingSourcesLogInterval:1e4,useNewTokenApi:!1,audioRendererFailedReconnectTimes:0,audioRendererFailedRetryCodes:[3],effectsApplyConstraintsRetryMs:1e3,isSpotlightEnabled:!0,addAudioStreamBeforeConnection:!1,redReceiveEnabled:!1,mediaEventDictionary:je.MEDIA_EVENT_FIELDS,useSenderV2:!0,applySenderParamsBeforeStart:!1,reuseLastSetParameters:!1,hevcCodecs:["hev1.1.6.L120.90","hev1.1.4.L93.B0","hev1.1.6.L93.B0"],useInactiveAudioTrack:!1,enableRollbackHandler:!1,disableImmidiateEscalationReconnect:!1,enableCachingFMTP:!0,setDisconnectAfterCleanUp:!1,sendResolutionTableOverride:je.RES_TABLE.SEND,recvResolutionTableOverride:je.RES_TABLE.RECV,maxSendVideoCapabilitiesReportingForVideoEnabledMultiparty:!0,participantStreamInitialSubscriptions:!0,holdRetryActivationDelay:-1,holdSkipActivation:!0,recoverOnStreamUnmute:!1,isAv1Allowed:!1,audioSharingMemoryLeakFix:!0,h264SdpProfileMultiparty:"64001f",rejectIncompatibleOriginator:!1,coeffOfValidTimeDelayBetweenFramesArrival:2,invalidFPSAboveMax:40,useWakeLockApi:!1}}getEnforcedSettings(){return{}}},Ip=class extends Tp{getInitialSettings(){const g=super.getInitialSettings();return g.oneStreamPerDeviceType=!0,g.removeUnsupportedVideoModality=!0,g}},bp=class extends Tp{constructor(){super()}getEnforcedSettings(){return{useAudioAnalyzer:!1,enableAudioSharing:!1}}},Ap=class extends Ip{constructor(g){super(),this.browserInfo=g}getEnforcedSettings(){const g={webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,permissions:{usePositiveInAdp:!1,useNegativeInAdp:!1,adpFallback:!0,adpFallbackAudio:!0,adpFallbackVideo:!1,adpRequestAVLast:!1,rememberNegative:!1},devices:{pollingIntervalIdle:1e4},audioRendererRestartOnPause:!0,subscribeToSsrcForVideo:!0};return isVersionGreaterOrEqual(this.browserInfo.version,"15.0")||(g.statsAllowAnyVideoSendTrack=!0),isVersionGreaterOrEqual(this.browserInfo.version,"16.0")&&"Mobile"===this.browserInfo.formFactor&&(g.enablePermissionsWorkaround=!0),isVersionGreaterOrEqual(this.browserInfo.version,"17.0")&&"Mobile"===this.browserInfo.formFactor&&(g.recoverOnStreamUnmute=!0),g}},Pp=class extends Ip{getEnforcedSettings(){return{webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useDtlsTrasportConnectionCheck:!0,videoIsRenderingCheck:!1,fixSdpForPartialIceRestart:!0,mapSsrcToTrackForStats:!0,ignoreClosedDtlsTransportState1on1:!0,subscribeToSsrcForVideo1on1:!0,devices:{enumerateDevicesTimeout:0,pollingIntervalIdle:1e4,idlePollingOnStart:!0},webrtcInjectTransportCCAudioMultiparty:!1,videoCaptureFreezeTimeout:0,filterCodecsInSdp:!0,useSetParametersToApplyCapabilities:!0,removeRecvStreamOnEnded:!0,webrtcDisabledSenderBitrate:0,disableAudioOutputSelection:!0}}},Rp=class extends Tp{constructor(){super()}getEnforcedSettings(){return{checkSupportForWebrtc_1_0:!0,requireUserActionForAudioSharing:!0,webrtcSimulcastSessionEnabled:!0,webrtcAllowRestoreKeyframe:!0,useAudioAnalyzer:!1,enablePlatformCallConstraints:!0,specCompliantSimulcastMultiparty:{video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!1,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0,allowOverride:!0},extmapAllowMixedMultiparty:!0,enableVlaMultiparty:!0,allowRemoteVlaMultiparty:!0,enableNonAdvVlaMultiparty:!0,useMediaQualityControllerMultiparty:!0,useSdpCapabilities:!1}}},wp=class extends Ip{constructor(g){super(),this.browserInfo=g}getEnforcedSettings(){const g={};return isVersionGreaterOrEqual(this.browserInfo.version,"74.0")&&(g.webrtcSimulcastSessionEnabled=!0,g.webrtcAllowRestoreKeyframe=!0,g.enableAudioSharing=!0),"RoomAudioProcessing"===this.browserInfo.formFactor&&(g.defaultAudioProcessingFlags=0,g.wasmvqe.enableAec=!1,g.wasmvqe.enableVqe=!1,g.wasmdns.enableNoiseSuppression=!1),"CiscoOS"===this.browserInfo.name&&(g.waitReportStatsAtCallStop=!0),"Mobile"===this.browserInfo.formFactor&&(g.enableAudioSharing=!1,g.audioRendererFailedReconnectTimes=3,g.devices={pollingIntervalIdle:1e4}),"SamsungTV"===this.browserInfo.name&&(g.useSetParametersToApplyCapabilities=!0),isVersionGreaterOrEqual(this.browserInfo.version,"98.0")&&"Desktop"===this.browserInfo.formFactor&&(g.specCompliantSimulcastMultiparty={video:{layerScaleFactors:[1,2],enableLocally:!0,allowEnableRemotely:!0,useApplyConstraints:!0,minFsForSimulcast:920},maxBrControlEnabled:!0,allowResLimit:!0},g.extmapAllowMixedMultiparty=!0,g.enableVlaMultiparty=!0,g.allowRemoteVlaMultiparty=!0,g.enableNonAdvVlaMultiparty=!0,g.useMediaQualityControllerMultiparty=!0),isVersionGreaterOrEqual(this.browserInfo.version,"100.0")&&(g.redReceiveEnabledMultiparty=!0),g.webcv={useWasmEffects:!0,processorType:qn.ProcessorType.Wasm},g}},Mp=class{constructor(g){this.settings=g,this.isTransportUnbundled=!1,this.webrtcRejectedFeatures="",this.webrtcRequiredFeatures="",this.spatialAudioEnabled=!1,this._maxBandwidthInKbps=0,this._noiseSuppressionMode="Auto",this._enableMediaBypass=!1,this.audioContext={enabledLocally:!1,disabledRemotely:!1,enabledForSend:!1,initFailed:!1,initSendFailed:!1,codec:"None",lastUsedCodec:"None"}}setMediaConfiguration(g){this.maxBandwidthInKbps=Math.floor((g.maxBandwidthInBps||0)/1e3),this.isTransportUnbundled=this.settings.forceUnbundledTransport||this.settings.enableQosSupport&&(g.enableMediaQoS||!!g.mediaPortRanges),this._mediaPortRanges=g.mediaPortRanges,this.simulcastSessionEnabled=this.settings.webrtcSimulcastSessionEnabled&&canUseWebrtc1_0(this.settings.checkSupportForWebrtc_1_0),this._noiseSuppressionMode=g.noiseSuppressionMode||"Auto",this._enableMediaBypass=this.settings.allowMediaBypass&&g.enableMediaBypass,this.webrtcRejectedFeatures=this._enableMediaBypass?"":this.settings.webrtcRejectedFeatures,this.webrtcRequiredFeatures=this._enableMediaBypass?"":this.settings.webrtcRequiredFeatures,this.spatialAudioEnabled=!!g.enableSpatialAudio}get mediaBypassEnabled(){return this._enableMediaBypass}get noiseSuppressionMode(){return this._noiseSuppressionMode}get maxBandwidthInKbps(){return this._maxBandwidthInKbps}set maxBandwidthInKbps(g){this._maxBandwidthInKbps=g,this.settings.maxBandwidthInKbps&&(this._maxBandwidthInKbps=Math.min(this.settings.maxBandwidthInKbps,this._maxBandwidthInKbps||Number.MAX_SAFE_INTEGER))}get audioPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.audioMin&&this._mediaPortRanges.audioMax)return{min:this._mediaPortRanges.audioMin,max:this._mediaPortRanges.audioMax}}get videoPortRange(){if(this.isTransportUnbundled&&this._mediaPortRanges&&this._mediaPortRanges.videoMin&&this._mediaPortRanges.videoMax)return{min:this._mediaPortRanges.videoMin,max:this._mediaPortRanges.videoMax}}get audioCodecContext(){return this.settings.useInsertableStreams?.audioWasmCodec?.enable?this.audioContext:void 0}};function arrayMergeCustomizer2(g,m){if(Array.isArray(g))return m.slice()}var Dp=class extends Be{constructor(g,m,f={}){super(g),this.logger=g,this.platformCallConstraintsProvider=m,this.platformConfig=getPlatformConfig(),this.sessionCount=0,this._consoleOverrides={},this.uaConfig=new qs(this),this.mediaConfiguration={},this.configReceivedDefer=defer4(),this.initialSettings=(0,Ra.mergeWith)({},(0,Ra.cloneDeep)(this.platformConfig.getInitialSettings()),(0,Ra.cloneDeep)(f),this.platformConfig.getEnforcedSettings(),arrayMergeCustomizer2),this.settings=this.initialSettings,this.settingsWithoutOverrides=this.initialSettings,this.stackSettings=(0,Ra.cloneDeep)(f),this.mediaSettings=new Mp(this.settings),this.platformCallConstraintsProvider.changed((()=>{this.updateSettings();const g=this.platformCallConstraintsProvider.constraints,m=this.logger.createChild("SettingsToCallConstraintsConverter"),f=convertSettingsToCallConstraints(m,this.settings,g);this.platformCallConstraintsProvider.addCallConstraintsTelemetryEvent(f,"applied")})),this.configReceivedTimeout=window.setTimeout((()=>{this.configReceivedTimeout=void 0,this.configReceivedDefer.resolve()}),this.settings.ecsConfigTimeout),this.logger.safe.info("Initialized")}getCallConstraints(){return this.platformCallConstraintsProvider.constraints}setCallConstraints(g){return this.platformCallConstraintsProvider.setConstraints(g),g}getCallConstraintsTelemetry(){return this.logger.error("Not supported globally, returning empty array"),[]}addCallConstraintsTelemetryEvent(g,m){this.logger.error("Not supported globally")}getIceTransportPolicy(){return this.logger.warn(`Not supported globally, returning default ${je.ICE_TRANSPORT_POLICY.all}`),je.ICE_TRANSPORT_POLICY.all}setIceTransportPolicy(g){this.logger.error("Not supported globally")}get configReceivedOrTimeout(){return this.configReceivedDefer.promise}getConfigView(g,m){const f=g?"Multiparty":"1on1",S=Object.entries((0,Ra.cloneDeep)(this.settings)).reduce(((g,[m,S])=>(g[m]=S,m.endsWith(f)&&(g[m.replace(f,"")]=S),g)),{}),v=new Mp(S);return v.setMediaConfiguration(this.mediaConfiguration),new ka(this.logger.createChild("ConfigProviderView"),S,v,this.userAgentConfig,this.countryCode,this.platformCallConstraintsProvider,m)}updateConfig(g,m,f,S){this.etag=m||this.etag,this.configIds=f||this.configIds,this.country=S||this.country,this.event("newConfigReceived").raise(g,m,f),this.settingsWithoutOverrides=(0,Ra.mergeWith)({},this.settingsWithoutOverrides,g,arrayMergeCustomizer2),this.updateSettings(),this.configReceivedTimeout&&(window.clearTimeout(this.configReceivedTimeout),this.configReceivedTimeout=void 0),this.configReceivedDefer.resolve()}updateSessionCount(g){this.sessionCount=g,0===g&&this.pendingSettings&&(this.logSettings("Applying pending configuration",this.pendingSettings),this.updateSettings(this.pendingSettings),this.pendingSettings=null),g>0&&this.configReceivedTimeout&&this.configReceivedDefer.resolve()}get config(){return this.settings}get stackConfig(){return this.stackSettings}get consoleOverrides(){return this._consoleOverrides}get defaultConfig(){return this.initialSettings}get userAgentConfig(){return this.uaConfig}get countryCode(){return this.country}setMediaConfiguration(g){this.mediaConfiguration=g,this.mediaSettings.setMediaConfiguration(g)}get mediaConfig(){return this.mediaSettings}get ETag(){return this.etag}get ecsConfigIds(){return this.configIds}setConsoleOverrides(g){this._consoleOverrides=(0,Ra.mergeWith)({},this._consoleOverrides,g,arrayMergeCustomizer2),this.updateSettings()}setConsoleOverride(g,m){this._consoleOverrides[g]=m,this.updateSettings()}clearConsoleOverride(g){delete this._consoleOverrides[g],this.updateSettings()}clearAllConsoleOverrides(){this._consoleOverrides={},this.updateSettings()}updateSettings(g=this.settingsWithoutOverrides){if(this.sessionCount>0)return this.pendingSettings=g,void this.logSettings("pendingSettings updated",g);this.settings=this.mergeSettings(g),this.event("configUpdated").raise(),this.logSettings("Settings updated",this.settings)}logSettings(g,m){const f=Object.entries(m).reduce(((g,[m,f])=>(f!==this.initialSettings[m]&&(g[m]=f),g)),{});this.logger.safe.info(`${g}: ${JSON.stringify(f)}`)}mergeSettings(g){if(!(g.enablePlatformCallConstraints||this._consoleOverrides.enablePlatformCallConstraints))return this.mergeSettingsWithConsoleOverrides(g);let m=g;const{setConsoleOverridesBeforeCallConstraints:f}=this._consoleOverrides;return f&&(m=this.mergeSettingsWithConsoleOverrides(m)),m=this.mergeSettingsWithPlatformConstraints(m),f||(m=this.mergeSettingsWithConsoleOverrides(m)),m}mergeSettingsWithConsoleOverrides(g){return this.logger.safe.info(`Merging settings with console overrides: ${stringifyObject(this._consoleOverrides)}`),(0,Ra.mergeWith)({},g,this._consoleOverrides,arrayMergeCustomizer2)}mergeSettingsWithPlatformConstraints(g){const m=this.platformCallConstraintsProvider.getSettings(g);return this.logger.safe.info(`Merging settings with platform call constraints: ${stringifyObject(m)}`),(0,Ra.assign)({},g,m,arrayMergeCustomizer2)}},Op=class{constructor(g,m){this.streamClient=g,this.logger=m,this.rawBaseClient=new Hr((()=>this.getStream()),(()=>this.activeRawInputMediaStreamClient?.dispose()),m)}client(){return this.rawBaseClient}disposeActiveMediaStreamClient(){this.logger.info("Disposing active media stream client"),this.activeRawInputMediaStreamClient?.dispose("Disposed by RawDeviceStreamManager"),this.activeRawInputMediaStreamClient=null}async getStream(){return this.activeRawInputMediaStreamClient?.originalMediaStream?.active?(this.logger.info("Returning stream from active mediaStreamClient"),this.activeRawInputMediaStreamClient.originalMediaStream):(this.activeRawInputMediaStreamClient=await this.streamClient(),await this.activeRawInputMediaStreamClient.start(),this.activeRawInputMediaStreamClient.originalMediaStream)}},Np=class{constructor(g,m){this.logger=g,this.raiseTelemetryEvent=m,this.handlerMap=new Map([["Audio",new Map],["Video",new Map],["ScreenShare",new Map]])}dispose(g){this.logger.info(`disposing IRawStream ${g}`),this.handlerMap.get(g).forEach((g=>g.client().dispose()))}disposeAll(){this.logger.info("Dispose All clients"),this.handlerMap.forEach((g=>g.forEach((g=>g.client().dispose()))))}notifyChange(g){this.handlerMap.get(g).forEach((g=>{g.disposeActiveMediaStreamClient(),g.client().notifyStreamChange()}))}createIRawStreamClient(g,m){this.logger.info(`Create new IRawStream client for ${m}`);const f=new Op(g,this.logger);this.handlerAdded(f,m);return f.client()}handlerAdded(g,m){const f=g.client();this.setClientSubscription(f,m),this.handlerMap.get(m).set(f.clientId,g)}deleteRawStreamManagerById(g,m){this.logger.info(`Deleting from map: ${m}`),this.handlerMap.get(m).delete(g)}setClientSubscription(g,m){this.logger.info(`Setting subscription on IRawStream client for ${m}`),g.on("clientDisposed",(f=>{this.deleteRawStreamManagerById(g.clientId,m),this.raiseTelemetryEvent("IRawStream_client_disposed",{mediaType:m,clientId:f})})),g.on("rawStreamRequested",(g=>{this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:m,clientId:g})})),g.on("notifiedOnStreamChanged",(g=>this.raiseTelemetryEvent("IRawStream_media_stream_changed",{mediaType:m,clientId:g})))}},kp=class extends Be{constructor(g,m){super(g),this.logger=g,this.configProvider=m,this.window=Ws.window,this.isMuted=!1,this.isPlayingAllowed=!1,this.hadPlaybackError=!1,this.audioContext=null,this.sourceNode=null,this.gainNode=null,this.onAudioError=g=>{const m=g&&g.target||this.audio;if(this.hadPlaybackError=!0,m?.error){const g=m.error.code,f=`error with rendering audio code: ${g}, message: ${m.error.message}`;this.event("onAudioPlaybackError").raise(g,je.MEDIA_ERROR.audioPlaybackError,f),this.logger.safe.error(f)}else this.logger.safe.error("error with audio rendering")},this.onAudioPaused=async()=>{if(this.configProvider.config.audioRendererRestartOnPause&&this.canPlay&&!this.isMuted){const g=generateCauseId();this.logger.safe.info(`[${g}] audio playback is paused by OS, resuming it`),await this.startStream(g)}}}get muted(){return this.isMuted}async setMuted(g,m){return this.isMuted=g,g?this.stopStream(m):this.startStream(m)}get canPlay(){return this.stream&&this.isPlayingAllowed}getStream(){return this.stream}getDeviceId(){return this.deviceId}async play(g){if(this.stream=g,this.isPlayingAllowed=!0,!this.isMuted)return this.startStream()}stop(){this.stopStream(),this.isPlayingAllowed=!1}async setOutputDevice(g,m=generateCauseId()){if(this.audio)if(this.configProvider.config.disableAudioOutputSelection)this.logger.safe.warn(`[${m}] audio-output selction is disabled, disableAudioOutputSelection: true`);else if(this.audio.setSinkId){if(g){this.logger.safe.info(`[${m}] setting audio output device ID to ${scrubMriOrOmit(g)}`),this.deviceId=g;try{await this.audio.setSinkId(g)}catch(g){this.logger.safe.warn(`[${m}] setSinkId operation was aborted with error ${stringifyObject(g)}`)}this.configProvider.config.audioRendererRestartOnDeviceError&&this.hadPlaybackError&&!this.isMuted&&(this.logger.safe.info(`[${m}] audio playback error happened, restarting audio stream on new device`),await this.startStream(m),this.hadPlaybackError=!1)}}else this.logger.safe.warn(`[${m}] setting output device is not supported`);else this.deviceId=g}dispose(){this.logger.safe.info("dispose"),super.dispose(),this.audio&&(this.stop(),this.stream=null,this.audio.removeEventListener("error",this.onAudioError),this.audio.removeEventListener("pause",this.onAudioPaused),this.window.document.body.removeChild(this.audio),this.event("onAudioElementRemoved").raise(this.audio),this.audio=null),this.detachGainNode()}async startStream(g=generateCauseId()){if(this.canPlay)try{await this.assureAudioElement(g),this.logger.safe.info(`[${g}] attaching stream to renderer: ${this.stream?.id}`),this.configProvider.config.speakerGainLevel&&this.reattachToGainNode(this.stream,this.configProvider.config.speakerGainLevel),this.audio.srcObject=this.stream,await this.audio.play()}catch(m){this.logger.safe.warn(`[${g}] play operation was aborted with error ${stringifyObject(m)}`)}}async assureAudioElement(g=generateCauseId()){if(!this.audio)return this.logger.safe.info(`[${g}] creating audio element`),this.audio=this.window.document.createElement("audio"),this.audio.addEventListener("error",this.onAudioError),this.audio.addEventListener("pause",this.onAudioPaused),this.window.document.body.appendChild(this.audio),this.audio.autoplay=!0,this.event("onAudioElementAdded").raise(this.audio),this.setOutputDevice(this.deviceId,g)}stopStream(g=generateCauseId()){this.audio&&this.canPlay&&(this.detachGainNode(),this.logger.safe.info(`[${g}] detaching stream from renderer: ${this.stream?.id}`),this.configProvider.config.audioRendererUsePauseOnDetach?this.audio.pause():this.audio.srcObject=null)}attachToGainNode(g,m){this.audioContext=new Ws.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(g),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=m,this.sourceNode.connect(this.gainNode),this.gainNode.connect(this.audioContext.destination)}detachGainNode(){this.sourceNode?.disconnect(),this.sourceNode=null,this.gainNode?.disconnect(),this.gainNode=null,this.audioContext?.close(),this.audioContext=null}reattachToGainNode(g,m){this.detachGainNode(),this.attachToGainNode(g,m)}},Lp=class{constructor(g){this.logger=g,this.queue=Promise.resolve()}add(g,m=generateCauseId()){let f;f=g instanceof Sr?()=>g.promise:g;const S=this.queue.then(f);return this.queue=S.catch((g=>{this.queue&&this.logger.safe.error(`[${m}] Error from promiseQueue! ${stringifyObject(g)}`)})),S}dispose(){this.queue=null}},Fp=class{constructor(g){this.container=g,this.elements={},this.createTableCell=(g,m)=>{this.elements[g]=document.createElement("td"),this.addElementStyle(g),this.elements[m].appendChild(this.elements[g])},this.topElement=g.ownerDocument.createElement("div"),this.topElement.classList.add("vdi-occlusion"),this.topElement.style.position="absolute",this.topElement.style.top="0px",this.topElement.style.left="0px",this.topElement.style.zIndex="100",this.topElement.style.transform="inherit",this.topElement.style.backgroundColor="rgba(0, 0, 0, 0.2)",this.container.appendChild(this.topElement),this.table=document.createElement("table"),this.table.style.borderCollapse="collapse",this.table.style.fontSize="smaller",this.topElement.appendChild(this.table)}dispose(){this.topElement.removeChild(this.table),this.container.removeChild(this.topElement),this.table=null,this.topElement=null,this.container=null}createTableColumn(g,m){for(const f of Object.keys(g))this.createTableRow(f,g[f],m)}createTableRow(g,m,f){this.elements[g]||(this.elements[g]=document.createElement("tr"),this.table.appendChild(this.elements[g]));const S=`${g}-title`;this.elements[S]||(this.createTableCell(S,g),this.elements[S].innerText=m.text?m.text:g);const v=`${g}-${f}`;this.elements[v]||this.createTableCell(v,g),this.elements[v].innerText=m.value?.toString(),"string"==typeof m.value&&(this.elements[v].innerText=m.value.substring(0,15),this.elements[v].title=m.value)}clearTable(){for(;this.table.hasChildNodes();)this.table.removeChild(this.table.lastChild);this.elements={}}addElementStyle(g){this.elements[g].title=g,this.elements[g].style.color="yellow",this.elements[g].style.maxWidth="fit-content",this.elements[g].style.whiteSpace="nowrap",this.elements[g].style.fontSize="smaller",this.elements[g].style.lineHeight="1",this.elements[g].style.padding="0px 1px 0px 1px"}},xp=class{constructor(g,m){this.container=g,this.renderer=m,this.subs=[]}initialize(){this.overlay||(this.overlay=new Fp(this.container),this.overlay.createTableRow("streamSize",{value:"0x0"},"streamSize"),this.subs.push(this.renderer.on("onVideoSizeChanged",((g,m)=>this.overlay?.createTableRow("streamSize",{value:`${g}x${m}`},"streamSize")))),this.overlay.createTableRow("rendererSize",{value:"0x0"},"rendererSize"),this.subs.push(this.renderer.on("onRendererSizeChanged",((g,m)=>this.overlay?.createTableRow("rendererSize",{value:`${Math.ceil(m.width)}x${Math.ceil(m.height)}`},"rendererSize")))))}clear(){this.subs.forEach((g=>g.dispose())),this.subs=[],this.overlay?.dispose(),this.overlay=null}setStats(g){if(!this.overlay)return;const m=g.inboundRTP,f={ssrc:{value:m.ssrc},msid:{text:"sourceId/msid",value:`${this.renderer?.getMsi()}/${this.renderer?.getLocalMsi()}`},fps:{text:"FPS(r/d)",value:`${g.extensions?.frameRateReceived}/${g.extensions?.frameRateDecoded}`},bitrate:{value:g.extensions?.bitrate},decodeTime:{value:`${g.extensions?.decodeTime} ms`},keyFramesDecoded:{text:"KFs",value:m.keyFramesDecoded},nacksFirsPlisSent:{text:"N/F/P",value:`${m.nackCount}/${m.firCount}/${m.pliCount}`},packetsLost:{text:"lost",value:m.packetsLost},codecImplementationName:{text:"decoder",value:m.decoderImplementation}};this.overlay.createTableColumn(f,m.id)}dispose(){this.clear(),this.container=null,this.renderer=null}},Up=class{constructor(g){this.container=g}initialize(){this.overlay??(this.overlay=new Fp(this.container))}clear(){this.overlay?.dispose(),this.overlay=null}setStats(g){if(!this.overlay)return;const getStatsValues=g=>{const m=g.outboundRTP,f={rid:{value:m.rid},inputSize:{value:getResolution(g.mediaSource?.width,g.mediaSource?.height)},sentSize:{value:getResolution(m.frameWidth,m.frameHeight)},ssrc:{value:m.ssrc},fps:{text:"FPS(i/e/s)",value:`${m.framesPerSecond}/${g.extensions?.frameRateEncoded}/${g.extensions?.frameRateSent}`},bitrate:{value:g.extensions?.bitrate},encodeTime:{value:`${g.extensions?.encodeTime} ms`},keyFramesEncoded:{text:"KFs",value:m.keyFramesEncoded},qp:{value:g.extensions?.qp},nacksFirsPlisRecv:{text:"N/F/P",value:`${m.nackCount}/${m.firCount}/${m.pliCount}`},codecImplementationName:{text:"encoder",value:m.encoderImplementation},qualityLimitationReason:{text:"limited",value:m.qualityLimitationReason},bwe:{value:`${Math.floor((g.transport?.selectedCandidatePair?.availableOutgoingBitrate||0)/1e3)} kbps`}};this.overlay.createTableColumn(f,m.id)};this.overlay.clearTable(),g.forEach((g=>getStatsValues(g)))}dispose(){this.clear(),this.container=null}};function createLocalRendererStatsOverlay(g,m){return new Vp(new Up(m),g)}function createRemoteRendererStatsOverlay(g,m,f){return new Vp(new xp(m,f),g)}var Vp=class{constructor(g,m){this.overlay=g;const f=window?.webMA;f&&(f.stats??(f.stats={show:m})),m&&this.overlay.initialize()}setStats(g){this.initOrClear(),this.overlay.setStats(g)}dispose(){this.overlay.dispose()}initOrClear(){const g=window?.webMA;g?.stats?.show?this.overlay.initialize():g&&!g.stats.show&&this.overlay.clear()}};function getResolution(g,m){return g&&m&&`${g}x${m}`}function getObjectFitValue(g){switch(g){case"crop":return"cover";case"stretch":return"fill";default:return"contain"}}var Bp=class _VideoRendererBase extends Be{constructor(g,m,f){const S=m.createChild(""+_VideoRendererBase.rendererId++);super(S),this.container=g,this.configProvider=f,this.video=this.container.ownerDocument.createElement("video"),this.lastNotifiedVideoWidth=0,this.lastNotifiedVideoHeight=0,this.isVideoAttached=!1,this.onVideoDataUpdated=()=>{let g=this.video.videoWidth,m=this.video.videoHeight;(g<32||m<32)&&(g=m=0),this.lastNotifiedVideoWidth===g&&this.lastNotifiedVideoHeight===m||(this.lastNotifiedVideoWidth=g,this.lastNotifiedVideoHeight=m,this.event("onVideoSizeChanged").raise(g,m)),this.video?.paused&&this.video.play()},this.onVideoError=()=>{this.logger.safe.info(`onVideoError: error with video rendering: ${JSON.stringify(this.video.error)||"no video"}`),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onError",payload:JSON.stringify(this.video.error)||"no video"})},this.onVideoPaused=()=>{this.logger.safe.info("onVideoPaused: video playback is paused"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPaused"}),this.video.play()},this.onVideoPlayed=()=>{this.logger.safe.info("onVideoPlayed"),this.event("onVideoRendererStateChanged").raise({timestamp:Date.now(),state:"onVideoPlayed"})},this.onContextMenu=g=>{g.preventDefault()},this.logger=S,this.video.style.width="100%",this.video.style.height="100%",this.video.setAttribute("playsinline","true"),this.video.disablePictureInPicture=!0,this.video.autoplay=!0,this.video.muted=!0,this.attachEventListeners(),this.logger.safe.info("created")}getVideoElement(){return this.video}dispose(){super.dispose(),this.isVideoAttached&&(this.container.removeChild(this.video),this.isVideoAttached=!1),this.sizeTracker?.dispose(),this.detachEventListeners(),this.attachMediaStream(null),this.video=null,this.stream=null,this.canvas=null,this.context=null}attachMediaStream(g){this.stream!==g&&(this.stream&&(this.video.srcObject=null),g&&(this.video.hidden=0===g.getVideoTracks().length,this.video.srcObject=g,this.isVideoAttached||(this.container.appendChild(this.video),this.isVideoAttached=!0)),this.stream=g)}setScalingMode(g){this.video.style.objectFit=getObjectFitValue(g)}getMediaStream(){return this.stream}getTrackId(){return this.stream?.getTracks()[0]?.id??void 0}async captureFrame(){const g=this.stream;if(!g)throw this.logger.safe.error("Mediastream not found"),new Error("Mediastream not found");const m=g.getVideoTracks?.()?.[0]?.getSettings(),f=m?.width,S=m?.height;if(!f||!S)throw this.logger.safe.error("Failed to get video track width/height"),new Error("Failed to get video track width/height");const v=this.getImageData(f,S);return{getSize:()=>({width:f,height:S}),isMirrored:()=>!1,getImageData:()=>v}}getImageData(g,m){if(this.canvas??(this.canvas=this.container.ownerDocument.createElement("canvas")),this.context??(this.context=this.canvas.getContext("2d")),!this.context)throw this.logger.safe.error("Failed to get canvas 2d context"),new Error("Failed to get canvas 2d context");this.canvas.width=g,this.canvas.height=m,this.context.drawImage(this.video,0,0,g,m);return this.context.getImageData(0,0,g,m)}attachEventListeners(){this.video.addEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.addEventListener("timeupdate",this.onVideoDataUpdated),this.video.addEventListener("error",this.onVideoError),this.video.addEventListener("pause",this.onVideoPaused),this.video.addEventListener("contextmenu",this.onContextMenu),this.video.addEventListener("play",this.onVideoPlayed)}detachEventListeners(){this.video.removeEventListener("loadedmetadata",this.onVideoDataUpdated),this.video.removeEventListener("timeupdate",this.onVideoDataUpdated),this.video.removeEventListener("error",this.onVideoError),this.video.removeEventListener("pause",this.onVideoPaused),this.video.removeEventListener("contextmenu",this.onContextMenu),this.video.removeEventListener("play",this.onVideoPlayed)}};Bp.rendererId=0;var Hp=Bp;function createResolutionTable(g){return g.map((g=>new $p(g.w,g.h,g.minBr,g.maxBr)))}var $p=class{constructor(g,m,f=0,S=0){this.width=g,this.height=m,this.minBitrate=f,this.maxBitrate=S,this.fs=Math.ceil(g/je.MACROBLOCK_SIZE)*Math.ceil(m/je.MACROBLOCK_SIZE)}toString(){return this.height?`${this.height}p`:`${this.fs}fs`}},Gp=class _ResolutionTable{constructor(g){g||(this.resolutions=createResolutionTable(je.RES_TABLE.SEND)),this.resolutions=createResolutionTable(g)}static initialize(g){_ResolutionTable.Send=new _ResolutionTable(g.config.sendResolutionTableOverride),_ResolutionTable.Recv=new _ResolutionTable(g.config.recvResolutionTableOverride),g.on("configUpdated",(()=>{_ResolutionTable.Send=new _ResolutionTable(g.config.sendResolutionTableOverride),_ResolutionTable.Recv=new _ResolutionTable(g.config.recvResolutionTableOverride)}))}get initialResolution(){return this.resolutions[this.resolutions.length-1]}getResolutionByFs(g){for(let m=this.resolutions.length-1;m>=0;m--)if(this.resolutions[m].fs<=g)return this.resolutions[m];return this.resolutions[0]}getMaxFS(g,m){return this.getResolutionRecord(g,m).fs}getResolutionForBitrate(g){let m=this.resolutions.filter((m=>m.maxBitrate&&m.maxBitrate>=g)).shift(),f=this.resolutions.filter((m=>m.minBitrate&&m.minBitrate<=g)).pop();return m=m??f,f=f??m,{lowRes:m,highRes:f}}getBitrateForResolution(g,m){const f=this.getResolutionRecord(g,m);return{minBitrate:f.minBitrate,maxBitrate:f.maxBitrate}}getResolutionForHeight(g){for(let m=this.resolutions.length-1;m>=0;m--)if(this.resolutions[m].height<=g)return this.resolutions[m];return this.resolutions[0]}getResolutionRecord(g,m){const f=Math.max(g,m),S=Math.min(g,m);for(const g of this.resolutions)if(g.width>=f&&g.height>=S)return g;return this.resolutions[this.resolutions.length-1]}getNextLowerResolution(g,m){const f=Math.min(g,m),S=this.getResolutionForHeight(f),v=this.resolutions.indexOf(S);return this.resolutions[v-1]}getNextHigherResolution(g,m){const f=Math.min(g,m),S=this.getResolutionForHeight(f),v=this.resolutions.indexOf(S);return this.resolutions[v+1]}getResolutions(){return this.resolutions}};Gp.Recv=new Gp(je.RES_TABLE.RECV),Gp.Send=new Gp(je.RES_TABLE.SEND);var jp=Gp,Wp=class extends Be{constructor(g,m,f,S){super(),this.videoElement=g,this.minInterval=m,this.maxInterval=f,this.window=Ws.window,this.devicePixelRatio=S&&window.devicePixelRatio||1,this.originalVideoElementSize={width:g.offsetWidth,height:g.offsetHeight},this.initializeSizeTracking()}get width(){return this.originalVideoElementSize.width*this.devicePixelRatio}get height(){return this.originalVideoElementSize.height*this.devicePixelRatio}initializeSizeTracking(){const g=Math.floor(Math.random()*Math.abs(this.maxInterval-this.minInterval))+this.minInterval;this.elementSizeTrackingRef=this.window.setInterval((()=>{this.videoElementSizeChanged()&&(this.saveCurrentVideoElementSize(),this.raiseChanged())}),g)}triggerVideoElementSizeChange(){this.originalVideoElementSize.height&&this.originalVideoElementSize.width&&this.raiseChanged()}dispose(){this.elementSizeTrackingRef&&this.window.clearInterval(this.elementSizeTrackingRef)}videoElementSizeChanged(){return this.originalVideoElementSize.width!==this.videoElement.offsetWidth||this.originalVideoElementSize.height!==this.videoElement.offsetHeight}saveCurrentVideoElementSize(){this.originalVideoElementSize.width=this.videoElement.offsetWidth,this.originalVideoElementSize.height=this.videoElement.offsetHeight}},qp=class extends Hp{constructor(g,m,f,S){super(g,f.createChild("local"),S),this.mediaStreamProvider=m,this.isDisposed=!1,this.serialQueue=new Lp(this.logger.createChild("rendererQueue")),this.lastNotifiedRendererResolution={width:0,height:0},this.logger.safe.info("ctor"),this.overlayStats=createLocalRendererStatsOverlay(this.configProvider.config.showStatsInCall,g)}getResolution(){return this.lastNotifiedRendererResolution}dispose(){this.logger.safe.info("dispose"),this.isDisposed=!0,this.event("onRendererDisposed").raise(this),super.dispose(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),this.statsSub?.dispose(),this.overlayStats.dispose()}setVideoMirroring(g){this.configProvider.config.localPreviewMirroringSupported&&(this.getVideoElement().style.transform=g?"scaleX(-1)":void 0)}startVideoAsync(g=generateCauseId()){return this.logger.safe.info(`[${g}] starting local video`),this.event("onRendererStarted").raise(this),this.sizeTracker=new Wp(this.getVideoElement(),this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged())),this.serialQueue.add((()=>this.restartVideo()),g)}updateStreamAsync(g=generateCauseId()){return this.logger.safe.info(`[${g}] updating local video`),this.serialQueue.add((()=>this.restartVideo()),g)}setStatsProvider(g,m){this.statsSub?.dispose(),this.statsSub=g.on("onDiagnosticUpdated",(g=>{if(!g.video?.send?.length||!g.video?.send[0])return;const f=g.video?.send[0],S=[f,...f.altLayouts??[]].filter((g=>{const f=g.mediaSource?.trackIdentifier??g.track?.trackIdentifier;return m.some((g=>g.trackId===f))}));S.length&&this.overlayStats.setStats(S)}))}onSizeTrackerChanged(){const g=this.sizeTracker.width,m=this.sizeTracker.height,f=jp.Send.getResolutionForHeight(Math.min(m,g));this.lastNotifiedRendererResolution.width===f.width&&this.lastNotifiedRendererResolution.height===f.height||(this.lastNotifiedRendererResolution.width=f.width,this.lastNotifiedRendererResolution.height=f.height,this.event("onRendererSizeChanged").raise(this,{height:f.height,width:f.width}))}async restartVideo(){const g=await this.mediaStreamProvider.getVideoStream(!1,"localVideoRenderer");try{if(await g.start(),this.isDisposed)throw g.dispose(),new Error("local video renderer is disposed");this.attachStream(g)}catch(g){throw this.mediaStreamProvider.raiseTelemetryEvent("video_preview_error",{mediaType:"Video",error:stringifyObject(g)}),g}}attachStream(g){if(this.mediaStream!==g)if(this.mediaStream?.parentId!==g?.parentId){this.logger.safe.info(`attach media stream ${g?.id}`);try{this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null),g&&super.attachMediaStream(g.rawStream),this.mediaStream=g}catch(m){throw g&&g.dispose(),m}}else g.dispose()}},zp=R;function adjustResolutionToAspectRatio(g,m){const f=g.width/g.height,S=(0,zp.clone)(g);return f>m?S.width=Math.floor(g.height*m):f<m&&(S.height=Math.floor(g.width/m)),S}var Kp=class _ConstraintsObject{constructor(g,m,f=!0,S=!1,v){this.audio=g,this.video=m,this.withTimeout=f,this.withEffect=S,this.withOverridenStream=v}clone(){const g=deepClone(this.video),m=deepClone(this.audio);return new _ConstraintsObject(m,g,this.withTimeout,this.withEffect,this.withOverridenStream)}},Jp=class{constructor(g){this.logger=g}dispose(){}updateVideoConstraints(g,m,f){const S=this.calculateConstraints(m,f);this.logger.safe.info(`Calculated constraints: ${JSON.stringify(S)} from capabilities: ${JSON.stringify(m)}`);const v=S.resolution,C=S.fps,_=v&&(!isInRange(v.width,g.video.minWidth,g.video.maxWidth)||!isInRange(v.height,g.video.minHeight,g.video.maxHeight)),E=g.video.fps!==C;if(!_&&!E)return g;const T=g.clone();return _&&this.setResolution(T,v),E&&(T.video.fps=C),T}updateResolution(g,m){const f=g.clone();return this.setResolution(f,m),f}setResolution(g,m){g.video.maxWidth=m.width,g.video.minWidth=m.width,g.video.maxHeight=m.height,g.video.minHeight=m.height}getKey(g){return g.video?isEmpty(g.video)?"video":g.video.deviceId&&g.video.minWidth&&g.video.minHeight?`${g.video.deviceId}x${g.video.minWidth}x${g.video.minHeight}`:g.video.minWidth&&g.video.minHeight?`${g.video.minWidth}x${g.video.minHeight}`:g.video.deviceId?`${g.video.deviceId}`:(this.logger.safe.error(`Cannot create key for constraints: ${scrubConstraints(g)}`),""):"audio"}convertConstraints(g,m={}){if(!g)return null;const f=deepClone(m);return g?.deviceId&&(f.deviceId=g.deviceId),f}},Yp=class{constructor(){this.MAX_SHARING_WIDTH=1920,this.MAX_SHARING_HEIGHT=1080}getResolutionTable(g,m){const f=this.constraintToMaxResolution(g,m);return this.generateResolutionTable(f)}constraintToMaxResolution(g,m){const f=this.getPortraitOrLandscapeMaxResolution(g),S=adjustResolutionToAspectRatio({width:g.width,height:g.height},m),v=f.width/S.width,C=f.height/S.height,_=Math.min(v,C);return this.resizeResolution(S,_)}resizeResolution(g,m){return{width:Math.round(g.width*m),height:Math.round(g.height*m)}}getPortraitOrLandscapeMaxResolution(g){return g.width>g.height?{width:this.MAX_SHARING_WIDTH,height:this.MAX_SHARING_HEIGHT}:{width:this.MAX_SHARING_HEIGHT,height:this.MAX_SHARING_WIDTH}}ceilToMackroblockSize(g){const m=g.width,f=g.height;return{width:Math.ceil(m/je.MACROBLOCK_SIZE)*je.MACROBLOCK_SIZE,height:Math.ceil(f/je.MACROBLOCK_SIZE)*je.MACROBLOCK_SIZE}}generateResolutionTable(g){return[1,2/3,1/3,1/6].map((m=>this.resizeResolution(g,m))).map((g=>this.ceilToMackroblockSize(g)))}},Qp=class{constructor(g){this.logger=g,this.FPS_TABLE=[15,7.5,3.75,1.875],this.resolutionTableCalculator=new Yp,this.initialAspectRatio=null}calculateConstraints(g,m){this.initialAspectRatio||(this.initialAspectRatio=m.width/m.height);const f=this.resolutionTableCalculator.getResolutionTable(m,this.initialAspectRatio);let S={resolution:f[f.length-1],fps:this.FPS_TABLE[this.FPS_TABLE.length-1]};return f.some((m=>{const f=this.getFs(m);return this.FPS_TABLE.some((v=>{const C=this.getMbps(f,v);return f<=g.maxFs&&v<=g.maxFps&&C<=g.maxMbps&&(S={resolution:m,fps:v},!0)}))}))?this.logger.safe.info(`Calculated resolution: ${JSON.stringify(S)}`):this.logger.safe.error(`None of available resolutions are suitable: ${JSON.stringify(f)}. Fallback to: ${JSON.stringify(S)}`),S}getMbps(g,m){return g*m}getFs(g){return Math.ceil(g.width/je.MACROBLOCK_SIZE)*Math.ceil(g.height/je.MACROBLOCK_SIZE)}},Xp=class{constructor(g,m){this.logger=g,this.maxCapabilities=m}ensureValidity(g){this.throwIfMissing(g);const m=this.calculateMissing(g);return this.maxCapabilities&&this.applyMaxCapabilities(m),this.logger.safe.info(`Validating capabilities ${JSON.stringify(m)}`),m}throwIfMissing(g){if(!g.maxFs&&!g.maxMbps&&!g.maxFps||g.maxFs&&!g.maxMbps&&!g.maxFps||!g.maxFs&&g.maxMbps&&!g.maxFps||!g.maxFs&&!g.maxMbps&&g.maxFps)throw new Error(`Missing video capabilities ${JSON.stringify(g)}`)}calculateMissing(g){const m=shallowClone(g);return!g.maxFs&&g.maxMbps&&g.maxFps&&(m.maxFs=g.maxMbps/g.maxFps),g.maxFs&&!g.maxMbps&&g.maxFps&&(m.maxMbps=g.maxFs*g.maxFps),g.maxFs&&g.maxMbps&&!g.maxFps&&(m.maxFps=g.maxMbps/g.maxFs),m}applyMaxCapabilities(g){this.maxCapabilities.maxFs&&(g.maxFs=Math.min(g.maxFs,this.maxCapabilities.maxFs)),this.maxCapabilities.maxMbps&&(g.maxMbps=Math.min(g.maxMbps,this.maxCapabilities.maxMbps)),this.maxCapabilities.maxFps&&(g.maxFps=Math.min(g.maxFps,this.maxCapabilities.maxFps))}},Zp=8160,em=15,tm=class extends Jp{constructor(g,m){super(g),this.initialConstraints={maxWidth:1920,minWidth:1920,maxHeight:1080,minHeight:1080,fps:15},this.maxCapabilities={maxFs:Zp,maxFps:em},this.validator=new Xp(this.logger.createChild("CV"),this.maxCapabilities),this.constraintsCalculator=new Qp(this.logger.createChild("CC")),m.config.resizeModeForSharing&&(this.initialConstraints.resizeMode=m.config.resizeModeForSharing)}createConstraintsObject(g){if(!g.sharing)throw new Error(`Sharing constraints are not presented: ${JSON.stringify(g)}`);const m=this.convertConstraints(g.sharing,this.initialConstraints),f=g.audio?g.audio:null;return f?.deviceId===je.SYSTEM_AUDIO_SOURCE_ID&&delete f.deviceId,new Kp(f,m,!1,!1,g.withOverridenStream)}generatePolicies(g){return[g]}calculateConstraints(g,m){this.logger.safe.info(`Stream resolution is ${JSON.stringify(m)}`);const f=this.validator.ensureValidity(g);return this.constraintsCalculator.calculateConstraints(f,m)}},im=class extends tm{constructor(g,m,f){super(g,f);const S=m.screen.width/m.screen.height;S<1&&([this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[this.initialConstraints.maxHeight,this.initialConstraints.maxWidth],[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[this.initialConstraints.minHeight,this.initialConstraints.minWidth]);let v=adjustResolutionToAspectRatio({width:this.initialConstraints.maxWidth,height:this.initialConstraints.maxHeight},S);[this.initialConstraints.maxWidth,this.initialConstraints.maxHeight]=[v.width,v.height],v=adjustResolutionToAspectRatio({width:this.initialConstraints.minWidth,height:this.initialConstraints.minHeight},S),[this.initialConstraints.minWidth,this.initialConstraints.minHeight]=[v.width,v.height]}},nm=class extends Jp{constructor(g,m){super(m),this.configProvider=g}createConstraintsObject(g){const m={},f=getBrowserInfo().engine;void 0!==g.audioProcessingFlags&&("Chromium"===f||"ChromiumAVD"===f?(m.autoGainControl=!!(1&g.audioProcessingFlags),m.echoCancellation=!!(2&g.audioProcessingFlags),m.noiseSuppression=!!(4&g.audioProcessingFlags),this.configProvider.config.useGoogPrefixAudioConstraints&&(m.googAutoGainControl=!!(1&g.audioProcessingFlags),m.googAutoGainControl2=!!(1&g.audioProcessingFlags),m.googEchoCancellation=!!(2&g.audioProcessingFlags),m.googHighpassFilter=!!(4&g.audioProcessingFlags),m.googNoiseSuppression=!!(4&g.audioProcessingFlags),m.googTypingNoiseDetection=!!(4&g.audioProcessingFlags))):"Safari"===f||"Firefox"===f?(m.autoGainControl=!!(1&g.audioProcessingFlags),m.echoCancellation=!!(2&g.audioProcessingFlags),m.noiseSuppression=!!(4&g.audioProcessingFlags)):this.logger.warn(`Unsupported browser for audio processing flags ${f}`));const S=this.convertConstraints(g.audio,m),v=this.convertConstraints(g.video,this.initialVideoConstraints);return new Kp(S,v,g.withTimeout,g.withEffect,g.withOverridenStream)}calculateConstraints(g){const m=Math.min(g.maxFs,this.configProvider.config.webrtcCameraOpenFs);return{resolution:jp.Send.getResolutionByFs(m),fps:g.maxFps}}get initialVideoConstraints(){const g=jp.Send.getResolutionByFs(this.configProvider.config.webrtcCameraOpenFs);return{maxWidth:g.width,minWidth:g.width,maxHeight:g.height,minHeight:g.height,fps:this.configProvider.config.maxCameraOpenFps}}},rm=class{static getProvider(g,m,f){if("ScreenShare"===g){const g=f.createChild("SharingCP");return"Safari"===getBrowserInfo().name?new im(g,Ws.window,m):new tm(g,m)}return new nm(m,f.createChild("VideoCP"))}},sm=class{constructor(){}getPolicies(g){if(g.audio&&!g.video&&this.hasAudioProcessingConstraints(g))return[g,new Kp({deviceId:g.audio.deviceId},null)];if(!g.video)return[g];const m=this.getSuitableResolutions(g).map((m=>this.getConstraintsForResolution(g,m))),f=g.audio,S={deviceId:g.video.deviceId},v=new Kp(f,S,g.withTimeout);return m.push(v),m}getSuitableResolutions(g){return jp.Send.getResolutions().filter((m=>m.width<=g.video.maxWidth&&m.height<=g.video.maxHeight)).reverse()}getConstraintsForResolution(g,m){const f=g.clone();return f.video.minWidth=m.width,f.video.minHeight=m.height,f}hasAudioProcessingConstraints(g){const m=g&&g.audio;return m&&(void 0!==m.echoCancellation||void 0!==m.autoGainControl||void 0!==m.noiseSuppression)}},am=class{constructor(g,m){this.error=g,this.constraints=m,this.permissionDeniedBySystemErrorMsg=["Permission denied by system","The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission."]}getMediaError(){let g;switch(this.error.name){case"SourceUnavailableError":case"TrackStartError":case"NotReadableError":case"AbortError":g={type:je.MEDIA_ERROR.sourceUnavailableError,detail:`media device is already used by another process: ${stringifyObject(this.error)}`};break;case"ConstraintNotSatisfiedError":case"OverconstrainedError":g={type:je.MEDIA_ERROR.constraintNotSatisfiedError,detail:`could not obtain constrained media stream: ${stringifyObject(this.error)}`};break;case"DevicesNotFoundError":case"NotFoundError":g={type:je.MEDIA_ERROR.devicesNotFoundError,detail:`specified device not found: ${stringifyObject(this.error)}`};break;case"NotAllowedError":g=this.permissionDeniedBySystemErrorMsg.some((g=>g===this.error.message))?{type:je.MEDIA_ERROR.permissionDeniedBySystemError,detail:`no system permissions: ${stringifyObject(this.error)}`}:{type:je.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${stringifyObject(this.error)}`};break;case"PermissionDeniedError":case"PermissionDismissedError":g={type:je.MEDIA_ERROR.permissionDeniedError,detail:`permission to use media device was denied: ${stringifyObject(this.error)}`};break;case je.MEDIA_ERROR.extensionNotFoundError:g={type:je.MEDIA_ERROR.extensionNotFoundError,detail:`extension is not found: ${stringifyObject(this.error)}`};break;case je.MEDIA_ERROR.chromeRuntimeNotDefinedError:g={type:je.MEDIA_ERROR.chromeRuntimeNotDefinedError,detail:`chrome runtime is not defined: ${stringifyObject(this.error)}`};break;case je.MEDIA_ERROR.sharingCancelledError:g=this.getSharingCancelledError(this.error);break;case je.MEDIA_ERROR.mediaStreamRequestTimedOut:g={type:je.MEDIA_ERROR.mediaStreamRequestTimedOut,detail:"Media Stream request timed out."};break;default:g=this.error.message===je.MEDIA_ERROR.sharingCancelledError?this.getSharingCancelledError(this.error):{type:je.MEDIA_ERROR.mediaStreamRequestError,detail:`media stream request error: ${stringifyObject(this.error)}`}}return g.isAudio=!!this.constraints.audio,g.detail+=` constraints: ${stringifyObject(scrubConstraints(this.constraints))}`,g.message=g.detail,g}getSharingCancelledError(g){return{type:je.MEDIA_ERROR.sharingCancelledError,detail:`screen sharing cancelled: ${stringifyObject(g)}`}}},om=class{constructor(g){this.logger=g}static isSupported(){return!0}getStream(g){const m=this.constraintsAdapter.toGumConstraints(g);return this.logger.safe.info(`Constraints to be applied: ${JSON.stringify(scrubConstraints(m))}`),new Promise(((g,f)=>{Ws.window.navigator.getUserMedia(m,g,f)})).catch((m=>{throw new am(m,g).getMediaError()}))}applyConstraints(g,m){if(!g||!g.getVideoTracks()||!g.getVideoTracks()[0])return Promise.reject("No video tracks found");const f=g.getVideoTracks()[0];return this.applyConstraintsForTrack(f,m)}applyConstraintsForTrack(g,m){const f=this.constraintsAdapter.toTrackConstraints(m);return g.applyConstraints?(this.logger.safe.info(`Apply constraints: ${JSON.stringify(f)} on ${JSON.stringify(g.id)}`),g.applyConstraints(f).catch((g=>{throw new am(g,m).getMediaError()}))):Promise.reject("track.applyConstraints() is not supported")}},lm=class{constructor(g){this.configProvider=g}toGumConstraints(g){const m={};return g.audio&&(m.audio=deepClone(g.audio),m.audio.deviceId&&delete m.audio.deviceId,g.audio.deviceId&&g.audio.deviceId!==je.MEDIA_DEVICE.defaultId&&(m.audio.deviceId=g.audio.deviceId)),g.video&&(m.video={mandatory:{}},g.video.deviceId&&(m.video.mandatory.sourceId=g.video.deviceId),g.video.minWidth&&(m.video.mandatory.minWidth=g.video.minWidth),g.video.maxWidth&&(m.video.mandatory.maxWidth=g.video.maxWidth),g.video.minHeight&&(m.video.mandatory.minHeight=g.video.minHeight),g.video.maxHeight&&(m.video.mandatory.maxHeight=g.video.maxHeight),g.video.fps&&(m.video.mandatory.maxFrameRate=g.video.fps,this.configProvider?.config.setMinFpsForWebkit&&(m.video.mandatory.minFrameRate=this.configProvider.config.minCameraOpenFps,m.video.mandatory.idealFrameRate=g.video.fps)),isEmpty(m.video.mandatory)&&delete m.video.mandatory),m}toTrackConstraints(g){const m={};return g.video&&(g.video.minWidth&&(m.width=g.video.minWidth),g.video.minHeight&&(m.height=g.video.minHeight),g.video.fps&&(m.frameRate=g.video.fps)),m}},cm=class{constructor(g){this.configProvider=g}toGumConstraints(g){const m={};if(g.audio&&(m.audio=deepClone(g.audio),m.audio.deviceId&&delete m.audio.deviceId,g.audio.deviceId&&g.audio.deviceId!==je.MEDIA_DEVICE.defaultId&&(m.audio.deviceId={exact:g.audio.deviceId})),g.video){m.video={width:{},height:{},frameRate:{}},g.video.deviceId&&(m.video.deviceId={exact:g.video.deviceId}),g.video.minWidth&&(m.video.width.min=g.video.minWidth),g.video.maxWidth&&(m.video.width.max=g.video.maxWidth),g.video.minHeight&&(m.video.height.min=g.video.minHeight),g.video.maxHeight&&(m.video.height.max=g.video.maxHeight),g.video.fps&&(m.video.frameRate.max=g.video.fps,m.video.frameRate.min=this.configProvider.config.minCameraOpenFps,m.video.frameRate.ideal=g.video.fps);for(const g in m.video)isEmpty(m.video[g])&&delete m.video[g]}return m}toTrackConstraints(g){const m={};return g.video&&(g.video.minWidth&&(m.width=g.video.minWidth),g.video.minHeight&&(m.height=g.video.minHeight),g.video.fps&&(m.frameRate=g.video.fps)),m}},dm=class{toGumConstraints(g){if(!g||!g.video)throw new Error(`constraints cannot be applied: ${g}`);const m={video:{}},f=g.video.deviceId&&g.video.deviceId!==je.DISPLAY_SOURCE_ID;return g.video.resizeMode&&(m.video.resizeMode=g.video.resizeMode),f&&(m.video.deviceId={exact:g.video.deviceId}),g.video.maxWidth&&(m.video.width={max:g.video.maxWidth},f&&(m.video.width.ideal=g.video.maxWidth)),g.video.maxHeight&&(m.video.height={max:g.video.maxHeight},f&&(m.video.height.ideal=g.video.maxHeight)),g.video.fps&&(m.video.frameRate=g.video.fps),g.audio&&(m.audio=!g.audio.deviceId||{deviceId:{exact:g.audio.deviceId}}),m}toTrackConstraints(g){const m=navigator.mediaDevices.getSupportedConstraints();if(!m)throw new Error("Constraints are not supported by browser");const f={};return m.width&&g.video.minWidth&&(f.width=g.video.minWidth),m.height&&g.video.minHeight&&(f.height=g.video.minHeight),m.frameRate&&g.video.fps&&(f.frameRate=g.video.fps),f.resizeMode=g.video.resizeMode,f}},hm=class extends om{constructor(g,m){super(m.createChild("WebRTCProvider")),this.configProvider=g,this.timeoutId=null;const f=getBrowserInfo();void 0!==navigator.webkitGetUserMedia&&void 0!==webkitRTCPeerConnection&&isVdiBrowser(f)?this.constraintsAdapter=new lm(g):void 0!==navigator.mediaDevices?.getUserMedia&&(this.constraintsAdapter=new cm(g))}getStream(g){if(!g.withTimeout||!this.configProvider.config.gumRequestTimeout)return super.getStream(g);const m=this.startGumRequestTimer(g),f=super.getStream(g).then((m=>{if(!this.timeoutId)throw this.stopStreamAfterTimeout(m,g),this.getMediaStreamTimeoutError(g);return this.stopGumRequestTimer(),m}));return Promise.race([m,f]).catch((g=>{throw this.stopGumRequestTimer(),g}))}getMediaStreamTimeoutError(g){const m={name:je.MEDIA_ERROR.mediaStreamRequestTimedOut,message:`Media stream request timed out. Constraints: ${stringifyObject(scrubConstraints(g))}`};return new am(m,g).getMediaError()}startGumRequestTimer(g){return new Promise(((m,f)=>{this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,f(this.getMediaStreamTimeoutError(g))}),this.configProvider.config.gumRequestTimeout)}))}stopGumRequestTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}stopStreamAfterTimeout(g,m){this.logger.safe.info(`Stopping media stream acquired after timeout: ${JSON.stringify(g.id)} with constraints: ${JSON.stringify(m)}`);try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.stop()})),this.logger.safe.info(`Media stream stopped: ${g.id}`)}catch(g){this.logger.safe.warn(`Failed to stop media stream: ${stringifyObject(g)}`)}}},um=class extends om{constructor(g){super(g.createChild("WebRTCDispProvider")),this.constraintsAdapter=new dm}static isSupported(){return!!window.navigator.mediaDevices.getDisplayMedia}getStream(g){const m=this.constraintsAdapter.toGumConstraints(g);return this.logger.safe.info(`Constraints to be used: ${JSON.stringify(m)}`),Promise.resolve().then((()=>g.video?.deviceId&&g.video?.deviceId!==je.DISPLAY_SOURCE_ID?Ws.window.navigator.mediaDevices.getUserMedia(m):Ws.window.navigator.mediaDevices.getDisplayMedia(m))).catch((m=>{throw new am(m,g).getMediaError()}))}},gm=class{constructor(g){this.detail=g}getStream(g){throw this.getError(g)}applyConstraints(g,m){throw this.getError(m)}applyConstraintsForTrack(g,m){throw this.getError(m)}getError(g){return{type:je.MEDIA_ERROR.unsupportedStream,detail:this.detail,message:this.detail,isAudio:!!g.audio}}},pm=class{static getStreamProvider(g,m,f){return"ScreenShare"===g?um.isSupported()?new um(f):(f.error("GUM stream provider cannot be created for display stream"),new gm("Sharing not supported")):new hm(m,f)}},mm=class extends Be{constructor(g,m,f){super(f),this.mediaStream=g,this.logger=f,this.mediaStreamSubscriptions=[],this.isHold=!1,this.isMuted=this.mediaStream.getMuted(),this._isDisposed=!1,this.originalId=g.id,this.subscribeOnMediaStreamEvents(),this.update(m),this.logger.safe.info("ctor"),this.mediaType=this.mediaStream.mediaType}get id(){return this.originalId}get parentId(){return this.originalId}get rawStream(){return this.gumStream}get rawTrack(){return this.getTrackByMediaType(this.rawStream,this.mediaType)}get deviceId(){return this.mediaStream.deviceId}update(g){g&&(this.gumStream=g,this.enableDisableTracks())}dispose(){this._isDisposed?this.logger.safe.info("already disposed"):(this._isDisposed=!0,this.logger.safe.info("dispose"),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaStream&&(this.mediaStream.disposeClient(this),this.unsubscribeFromMediaStreamEvents(),this.mediaStream=null),this.event("onStreamClientDisposed").raise(this))}clone(){const g=this.mediaStream.getClient();return this.isMuted&&g.setMuted(!0),this.isHold&&g.setHold(!0),g}applyCapabilities(g){return this.mediaStream.applyCapabilities(g)}setMuted(g,m=generateCauseId()){this.isMuted=g||this.mediaStream.getMuted(),this.logger.safe.info(`[${m}] setMuted => ${this.isMuted}`),this.enableDisableTracks()}setHold(g){this.isHold=g,this.enableDisableTracks()}start(){return this.mediaStream.start()}hasAudio(){return this.mediaStream.hasAudio()}hasVideo(){return this.mediaStream.hasVideo()}hasDisplay(){return this.mediaStream.hasDisplay()}isSameStream(g){return this.parentId===g.parentId}getResolution(){return this.mediaStream.getResolution()}getFrameRate(){return this.mediaStream.getFrameRate()}isActive(){return!0}isDisposed(){return this._isDisposed}subscribeOnMediaStreamEvents(){this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamStarted",((g,m)=>{this.event("onStreamClientStarted").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamError",((g,m)=>{this.event("onStreamClientError").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackMuted",((g,m)=>{this.event("onStreamClientMuted").raise(this,m)}))),this.mediaStreamSubscriptions.push(this.mediaStream.on("onStreamTrackEnded",((g,m)=>{this.event("onStreamClientEnded").raise(this,m)})))}unsubscribeFromMediaStreamEvents(){this.mediaStreamSubscriptions.forEach((g=>g.dispose())),this.mediaStreamSubscriptions=[]}enableDisableTracks(){this.gumStream?this.gumStream.getTracks().forEach((g=>{void 0!==g.enabled&&(g.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`Track ${JSON.stringify(g.id)} enabled state set to => ${g.enabled}`))})):this.logger.safe.warn("gumStream stream doesn't exist")}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}},fm=[30,15,7.5,3.75,1.875];function getResolutionForStream(g){return g&&g.getVideoTracks()[0]?getResolutionForTrack(g.getVideoTracks()[0]):null}function getResolutionForTrack(g){if(g&&g.getSettings){const m=g.getSettings();if(m)return{width:m.width,height:m.height}}return null}function getFrameRateForStream(g){return g&&g.getVideoTracks()[0]?getFrameRateForTrack(g.getVideoTracks()[0]):0}function getFrameRateForTrack(g){if(g&&g.getSettings){const m=g.getSettings();if(m)return getClosestValue(fm,m.frameRate,!0)}return 0}var Sm=class _MediaStreamInternal extends Be{constructor(g,m,f,S){super(f),this.streamConstraints=g,this.serialQueue=m,this.configProvider=S,this.clientId=0,this.clients=[],this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.isMuted=!1,this.isHold=!1,this.gumStartTime=0,this.streamId=_MediaStreamInternal.streamGeneration++,this.logger=f.createChild(`MediaStream:${this.streamId}`),this.mediaType=this.getMediaType(this.streamConstraints),this.constraintsProvider=rm.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(g)}get id(){return this.streamId}get rawStream(){return this.currentGumStream}get deviceId(){return this.rawStream?.getTracks()?.[0]?.getSettings?.()?.deviceId??null}applyCapabilities(g){if(this.currentGumStream){const m=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,g,this.getResolution());if(!m)return Promise.resolve(!1);if(this.currentConstraints!==m){this.currentConstraints=m;const g=this.currentConstraints;return this.hasDisplay()?this.applyConstraints(this.currentConstraints).then((()=>deepEqual(this.currentConstraints,g))).catch((g=>(this.logger.safe.error(`Apply constraints error: ${stringifyObject(g)}`),!1))):this.applyConstraintsInternal().then((()=>deepEqual(this.currentConstraints,g)))}}return Promise.resolve(!1)}getClient(){let g;this.currentGumStream?(g=this.getClone(),this.clientGumStreams.push({[this.constraintsProvider.getKey(this.currentConstraints)]:g})):this.clientGumStreams.push({});const m=new mm(this,g,this.logger.createChild("Client:"+this.clientId++));return this.clients.push(m),m}getClone(){return this.hasDisplay()?this.currentGumStream:this.currentGumStream.clone()}setMuted(g){this.isMuted=g,this.clients.forEach((m=>{m.setMuted(g)})),this.enableDisableTracks()}getMuted(){return this.isMuted}setHold(g){this.isHold=g,this.clients.forEach((m=>{m.setHold(g)})),this.enableDisableTracks()}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(){for(let g=this.clients.length-1;g>=0;g--)this.clients[g].dispose()}disposeClient(g){const m=this.clients.indexOf(g);m>=0&&(this.clients.splice(m,1),this.streamsDump.push(this.clientGumStreams[m]),this.clientGumStreams.splice(m,1),0===this.clients.length)&&this.disposeStream()}async disposeStream(){this.event("onStreamDisposing").raise(this);try{await this.stopGumStream(),this.event("onStreamDisposed").raise(this)}catch(g){this.event("onStreamError").raise(this,g)}this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),super.dispose()}hasAudio(){return!!this.currentGumStream&&0!==this.currentGumStream.getAudioTracks().length}hasVideo(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId!==je.DISPLAY_SOURCE_ID}hasDisplay(){return!!this.currentGumStream&&0!==this.currentGumStream.getVideoTracks().length&&this.currentConstraints.video&&this.currentConstraints.video.deviceId===je.DISPLAY_SOURCE_ID}getVideoDeviceId(){return this.currentConstraints.video.deviceId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForStream(this.currentGumStream),f=m??g,S=`Stream resolution is ${f.width}x${f.height}.`;return m?this.logger.safe.info(S):this.logger.safe.error(`${S}. Resolution not found, assuming default resolution.'`),f}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForStream(this.currentGumStream);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}async startStream(g){let m;m=g.video?this.applyConstraintsInternal():this.updateGumStreamInternal(g);try{await m,this.event("onStreamStarted").raise(this,g)}catch(g){throw this.event("onStreamError").raise(this,g),g}}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(g)}`)}updateClients(g){const m=this.constraintsProvider.getKey(g);this.clients.forEach(((g,f)=>{this.clientGumStreams[f][m]||(this.clientGumStreams[f][m]=this.getClone()),g.update(this.clientGumStreams[f][m])}))}applyConstraints(g){const m=this.getGumStreamProvider();return Promise.all(this.clients.map((f=>m.applyConstraints(f.rawStream,g)))).then((()=>{}))}applyConstraintsInternal(){return new Promise(((g,m)=>{this.logger.safe.info(`applying stream constraints: ${JSON.stringify(scrubConstraints(this.currentConstraints))}`);const f=new Sr;this.clients.forEach((g=>{g.onApplyConstraints&&g.onApplyConstraints(f.promise)}));const S=this.serialQueue.add((()=>{const g=(new sm).getPolicies(this.currentConstraints);return this.mediaStreamStartPromise=this.updateGumStreamInternal(g[0]),g.slice(1).forEach((g=>{this.mediaStreamStartPromise=this.mediaStreamStartPromise.catch((m=>{if(je.MEDIA_ERROR.constraintNotSatisfiedError===m.type)return this.logger.safe.warn("could not obtain constrained media stream, will attempt weaker policy"),this.updateGumStreamInternal(g);throw m.constraints=g,m}))})),this.mediaStreamStartPromise})).then((()=>{f.resolve()})).catch((g=>{throw this.logger.safe.error(`failed to apply constraints: ${JSON.stringify(scrubConstraints(g.constraints))} error: ${stringifyObject(g)}`),f.reject(g),g}));g(S)}))}enableDisableTracks(){this.currentGumStream&&this.currentGumStream.getTracks().forEach((g=>{void 0!==g.enabled&&(g.enabled=!("audio"===g.kind&&this.isMuted||this.isHold),this.logger.safe.info(`control media stream track kind: ${g.kind} enabled: ${g.enabled} muted: ${g.muted}`))}))}getGumStreamProvider(){return pm.getStreamProvider(this.mediaType,this.configProvider,this.logger.createChild("MSProvider"))}async updateGumStreamInternal(g){this.logger.safe.info(`querying user media for stream: ${JSON.stringify(g)}`),this.logger.safe.info("Getting GUM stream");const m=await this.getGumStream(g);this.logger.safe.info("Updating gum stream audio tracks"),this.updateGumStreamAudioTracks(m),this.currentGumStream=m,this.logger.safe.info("Updating stream constraints"),this.updateConstraints(g,m),this.logger.safe.info("Caching GUM stream"),this.cacheGumStream(this.currentConstraints,m),this.updateClients(this.currentConstraints),this.updateGumStreamVideoTracks(m),this.enableDisableTracks(),this.logger.safe.info("media stream updated");const f=this.stopRequestCalculation();this.event("onStreamAcquired").raise(this,f,(this.hasVideo()||this.hasDisplay())&&this.getResolution()||void 0)}async getGumStream(g){const m=this.gumStreams[this.constraintsProvider.getKey(g)];if(m)return m;const f=this.getGumStreamProvider();return this.startRequestCalculation(),f.getStream(g)}updateGumStreamAudioTracks(g){g.getAudioTracks().forEach((g=>{g.onended=g=>{this.logger.safe.info(`Audio stream track ended: ${JSON.stringify(g.error?.name||g)}`),this.event("onStreamTrackEnded").raise(this,g)},g.onmute=()=>{this.logger.safe.info("Audio stream track muted"),this.event("onStreamTrackMuted").raise(this,!0)},g.onunmute=()=>{this.logger.safe.info("Audio stream track unmuted"),this.event("onStreamTrackMuted").raise(this,!1)},g.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(g.id)}`)}))}updateGumStreamVideoTracks(g){const[m]=g.getVideoTracks();m&&(m.onmute=g=>{this.logger.safe.error(`Video stream track muted: ${JSON.stringify(scrubConstraints(this.currentConstraints))}; ${JSON.stringify(g)}`)},m.onended=g=>{this.logger.safe.info(`Video stream track ended: ${JSON.stringify(scrubConstraints(this.currentConstraints))}; ${JSON.stringify(g?.error.name||g)}`),this.event("onStreamTrackEnded").raise(this,g)},this.hasDisplay()&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(m,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(m.id)}`))}cacheGumStream(g,m){const f=this.constraintsProvider.getKey(g);this.gumStreams[f]!==m&&(this.gumStreams[f]&&(this.logger.safe.info(`Stream cache hit for ${f}, stopping old stream`),this.stopOneGumStream(this.gumStreams[f])),this.gumStreams[f]=m)}updateConstraints(g,m){this.currentConstraints=g.video?this.constraintsProvider.updateResolution(g,this.getResolution()):g,this.logger.safe.info(`Stream constraints updated: ${JSON.stringify(this.currentConstraints)}`)}applyContentHint(g,m){["","text","detail","motion"].indexOf(m)<0?this.logger.safe.error(`Cannot apply content hint: ${m}`):(this.logger.safe.info(`Apply content hint: ${m}`),g.contentHint=m)}startRequestCalculation(){this.gumStartTime=Date.now()}stopRequestCalculation(){if(0===this.gumStartTime)return 0;const g=Date.now()-this.gumStartTime;return this.gumStartTime=0,g}stopGumStream(){return this.mediaStreamStartPromise?(this.logger.safe.info("queueing media stream stop"),this.serialQueue.add((()=>{this.stopGumStreamInternal()}))):Promise.resolve()}stopOneGumStream(g){try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.onended=null,g.onmute=null,g.stop()})),this.logger.safe.info("media stream stopped")}catch(g){this.logger.safe.warn(`failed to stop media stream: ${stringifyObject(g)}`)}}stopGumStreamInternal(){this.currentGumStream&&([...this.clientGumStreams,...this.streamsDump,this.gumStreams].forEach((g=>{forOwn(g,(g=>{this.stopOneGumStream(g)}))})),this.gumStreams={},this.clientGumStreams=[],this.streamsDump=[],this.currentGumStream=null)}};Sm.streamGeneration=0;var vm=Sm,ym=class extends Be{constructor(g,m,f,S,v,C,_){super(_),this.id=g,this.masterStream=m,this.currentConstraints=f,this.constraintsProvider=S,this.streamProvider=v,this.configProvider=C,this._isDisposed=!1,this.masterStreamSubscriptions=[],this.mixerSubscriptions=[],this.parentId=m.id,this.logger=_.createChild(`C:${this.parentId}:${this.id}`),this.subscribeOnMasterStreamEvents()}get rawTrack(){return this.mediaTrack}get rawStream(){return this.rawMediaStream||(this.rawMediaStream=new MediaStream([this.mediaTrack]),this.configProvider.config.reassignMediaStreamAudioTrackAfterCreation&&this.rawMediaStream.getAudioTracks().length>0&&(this.rawMediaStream.removeTrack(this.rawMediaStream.getAudioTracks()[0]),this.rawMediaStream.addTrack(this.mediaTrack))),this.rawMediaStream}get deviceId(){return this.masterStream.deviceId}get mediaType(){return this.masterStream.mediaType}get originalMediaStream(){return this.masterStream.getOriginalMediaStream()}getCurrentConstraints(){return this.currentConstraints}dispose(g){this._isDisposed||(this._isDisposed=!0,this.logger.safe.info(`dispose: ${g}`),this.logger=this.logger.createChild("DISPOSED"),this.event("onStreamClientDisposing").raise(this),this.mediaTrack&&(this.unsubscribeFromMediaTrackEvents(),this.mediaTrack=null),this.masterStream&&(this.unsubscribeFromMasterStreamEvents(),this.masterStream.disposeClient(this),this.masterStream=null),this.unsubscribeFromMixerTrackEvents(),super.dispose(),this.event("onStreamClientDisposed").raise(this))}async applyCapabilities(g){if(!this.mediaTrack)return!1;const m=this.constraintsProvider.updateVideoConstraints(this.currentConstraints,g,this.getResolution());if(!m||!this.configProvider.config.recoverOnStreamUnmute&&this.currentConstraints===m)return!1;const applyConstraints=async g=>{try{return await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,m),this.currentConstraints=m,!0}catch(m){if(g)throw this.logger.safe.error(`Apply constraints error: ${JSON.stringify(m)}`),m;return this.logger.safe.warn(`Apply constraints failed and will be re-tried, error ${JSON.stringify(m)}`),!1}},f=this.currentConstraints.withEffect&&this.configProvider.config.effectsApplyConstraintsRetryMs;return!await applyConstraints(!f)&&f&&(await delay2(this.configProvider.config.effectsApplyConstraintsRetryMs),await applyConstraints(!0)),!0}start(){return this.masterStream.start()}clone(g){return null===this.masterStream&&this.logger.safe.error(`clone: master stream is null, reason: ${g}`),this.masterStream.getClient(`streamclient: ${g}`)}setMuted(g,m){this.isMuted=g,this.applyState(m)}setHold(g,m){this.isHold=g,this.applyState(m)}isSameStream(g){return this.parentId===g.parentId}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForTrack(this.mediaTrack),f=m?.width?m:g,S=`Track resolution is ${f.width}x${f.height}.`;return m?.width?this.logger.safe.info(S):this.logger.safe.error(`${S}. Resolution not found, assuming default resolution.'`),f}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForTrack(this.mediaTrack);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}update(g){g?this.mediaTrack?this.logger.safe.error(`Media track is already created: ${this.mediaTrack.id}`):(this.mediaTrack=this.getTrackByMediaType(g,this.mediaType),this.updateTrackConstraints(),this.subscribeOnMediaTrackEvents(this.mediaTrack),this.hasMasterAudio=g&&g.getAudioTracks().length>0,this.hasMasterVideo=g&&g.getVideoTracks().length>0,this.hasMasterAudio&&this.hasMasterVideo&&(this.rawMediaStream=g),this.logger.safe.info(`Updated: ${printMediaStream(g)}`)):this.logger.safe.error("No master media stream, skipping update")}resetEffectsOutputConstraints(g){this.masterStream.resetEffectsOutputConstraints(g)}async updateTrackConstraints(){if("ScreenShare"!==this.mediaType)return;const g=this.masterStream.getResolution();if(g){const m=this.currentConstraints.clone();m.video.maxWidth=g.width,m.video.minWidth=g.width,m.video.maxHeight=g.height,m.video.minHeight=g.height;try{await this.streamProvider.applyConstraintsForTrack(this.mediaTrack,m),this.currentConstraints=m}catch(g){this.logger.safe.error(`Apply constraints error: ${JSON.stringify(g)}`)}}}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}applyState(g){this.mediaTrack&&void 0!==this.mediaTrack.enabled&&(this.mediaTrack.enabled=!this.isMuted&&!this.isHold,this.logger.safe.info(`[${g}] Track ${JSON.stringify(this.mediaTrack.id)} enabled state set to => ${this.mediaTrack.enabled}`))}subscribeOnMediaTrackEvents(g){g.onended=m=>{this.logger.safe.info(`Track ${g.id} ended: ${JSON.stringify(m)}`),this.event("onStreamClientEnded").raise(this,m)},g.onmute=()=>{this.logger.safe.info(`Track ${g.id} muted`),this.event("onStreamClientMuted").raise(this,!0)},g.onunmute=()=>{this.logger.safe.info(`Track ${g.id} unmuted`),this.event("onStreamClientMuted").raise(this,!1)}}unsubscribeFromMediaTrackEvents(){this.mediaTrack.onended=null,this.mediaTrack.onmute=null,this.mediaTrack.onunmute=null}unsubscribeFromMixerTrackEvents(){this.mixerSubscriptions.forEach((g=>g.dispose())),this.mixerSubscriptions=[]}subscribeOnMasterStreamEvents(){this.masterStreamSubscriptions.push(this.masterStream.on("onStreamStarted",((g,m)=>this.event("onStreamClientStarted").raise(this,m))),this.masterStream.on("onStreamError",((g,m)=>this.event("onStreamClientError").raise(this,m))),this.masterStream.on("onStreamTrackMuted",((g,m)=>this.event("onStreamClientMuted").raise(this,m))),this.masterStream.on("onStreamDisposing",(g=>this.dispose())),this.masterStream.on("onStreamQualityChanged",((g,m,f,S)=>this.event("onStreamQualityChanged").raise(this,m,f,S))),this.masterStream.on("onStreamTrackEnded",((g,m)=>this.event("onStreamClientEnded").raise(this,m))))}unsubscribeFromMasterStreamEvents(){this.masterStreamSubscriptions.forEach((g=>g.dispose())),this.masterStreamSubscriptions=[]}hasAudio(){return this.hasMasterAudio}hasVideo(){return this.hasMasterVideo}isActive(){return this.mediaTrack?.enabled&&!this.mediaTrack?.muted&&"live"===this.mediaTrack?.readyState}onVideoStreamQualityChanged(g,m,f){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(g)}@${m}, reason=${f}`),this.masterStream.onVideoStreamQualityChanged(g,m,f)}isDisposed(){return this._isDisposed}},Cm=class extends Be{constructor(g,m,f,S,v,C){super(C),this.stream=g,this.constraints=m,this.constraintsProvider=f,this.gumStreamProvider=S,this.configProvider=v,this.logger=C,this.clients=[],this.streams=[],this.clientId=0,this.mediaStreamSubscription=this.stream.on("onStreamAcquired",(()=>this.onStreamAcquired()))}getClient(){const g=new ym(this.clientId++,this.stream,this.constraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger);return this.addClient(g),g}disposeClient(g){this.removeClient(g),this.clients.length||this.event("onAllClientsDisposed").raise()}dispose(){this.mediaStreamSubscription.dispose(),this.clients.length&&this.logger.safe.error(`Not all clients are disposed! ${JSON.stringify(this.clients.map((g=>g.id)))}`),this.streams.forEach((g=>this.disposeStream(g))),super.dispose()}getOrCreateStream(){const g=this.streams.length?this.streams[this.streams.length-1]:this.stream.rawStream;if(!g)return null;const m=g.clone();return this.logger.safe.info(`Cloned: ${printMediaStream(g)} -> ${printMediaStream(m)}`),this.resetStream(m),this.streams.push(m),m}addClient(g){this.updateClient(g),this.clients.push(g)}updateClient(g){const m=this.getOrCreateStream();m&&g.update(m)}removeClient(g){const m=this.clients.indexOf(g);this.clients.splice(m,1)}addStream(){this.clients.forEach((g=>this.updateClient(g)))}disposeStream(g){g.getTracks().forEach((g=>{this.logger.safe.info(`Stopping track: ${JSON.stringify(g.id)}`),g.stop()}))}onStreamAcquired(){this.addStream()}resetStream(g){g.getTracks().forEach((g=>{this.logger.safe.info(`Resetting state for track: ${g.id}`),g.enabled=!0}))}},_m=class{static getStrategy(g,m,f,S,v,C){return C?new bm(f,S):"Video"===g?new Im(m,f,S,v):new Tm(m,f,S)}},Em=class{constructor(g,m,f){this.gumStreamProvider=g,this.serialQueue=m,this.logger=f}getStream(g){return this.logger.safe.info(`Requesting stream with constraints: ${JSON.stringify(scrubConstraints(g))}`),this.serialQueue.add((()=>this.request(g)))}},Tm=class extends Em{constructor(g,m,f){super(g,m,f.createChild("SimpleStrat"))}request(g){return this.gumStreamProvider.getStream(g)}},Im=class extends Em{constructor(g,m,f,S){super(g,m,f.createChild("MultStrat")),this.policyGenerator=new sm}request(g){const m=this.policyGenerator.getPolicies(g);return this.makeRequests(m)}makeRequests(g){const m=g[0];return this.logger.safe.info(`Requesting media stream with policy: ${JSON.stringify(m)}`),this.makeRequestWithPolicy(m).catch((m=>{const f=g.slice(1);if(f.length&&je.MEDIA_ERROR.constraintNotSatisfiedError===m.type)return this.logger.safe.warn("Could not obtain constrained media stream, will attempt weaker policy"),this.makeRequests(f);throw m}))}makeRequestWithPolicy(g){return this.gumStreamProvider.getStream(g)}},bm=class extends Em{constructor(g,m){super(null,g,m.createChild("WithOveriddenStreamStart"))}request(g){return new Promise(((m,f)=>m(g.withOverridenStream)))}},Am=class _SimulcastMediaStream extends Be{constructor(g,m,f,S,v){super(S),this.serialQueue=m,this.configProvider=f,this.effectManager=v,this.gumRequestTime=0,this.id=_SimulcastMediaStream.streamId++,this.logger=S.createChild(`MediaStream:${this.id}`),this.mediaType=this.getMediaType(g),this.initialize(g)}get rawStream(){return this.mediaStream}get deviceId(){return this.originalMediaStream?this.originalMediaStream.getTracks()?.[0]?.getSettings?.()?.deviceId:null}start(){return this.mediaStreamStartPromise||(this.mediaStreamStartPromise=this.startStream(this.currentConstraints)),this.mediaStreamStartPromise}dispose(g){this.event("onStreamDisposing").raise(this),this.stopMediaStream(g).catch((g=>{this.event("onStreamError").raise(this,g)})).finally((()=>{this.constraintsProvider=null,this.serialQueue=null,this.configProvider=null,this.logger=this.logger.createChild("DISPOSED"),this.clientGenerationStrategy.dispose(),this.event("onStreamDisposed").raise(this),super.dispose()}))}disposeClient(g){this.clientGenerationStrategy.disposeClient(g)}getClient(g){return this.logger.safe.debug(`getClient: ${g}`),this.clientGenerationStrategy.getClient()}getOriginalMediaStream(){return this.originalMediaStream}getResolution(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g={width:this.currentConstraints.video.minWidth,height:this.currentConstraints.video.minHeight},m=getResolutionForStream(this.mediaStream),f=m??g,S=`Stream resolution is ${f.width}x${f.height}.`;return m?this.logger.safe.info(S):this.logger.safe.error(`${S}. Resolution not found, assuming default resolution.'`),f}getFrameRate(){if(!["Video","ScreenShare","PanoramicVideo"].some((g=>g===this.mediaType)))return null;const g=getFrameRateForStream(this.mediaStream);return 0===g?this.logger.safe.error("Stream frame rate is not avalable, returning 0"):this.logger.safe.info(`Stream fps is ${g}`),g}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`Media type is not defined: ${JSON.stringify(g)}`)}resetEffectsOutputConstraints(g){const m=getResolutionForStream(this.originalMediaStream);this.effectManager.resetOutputConstraints("Video",{width:Math.min(g.width,m.width||Number.MAX_SAFE_INTEGER),height:Math.min(g.height,m.height||Number.MAX_SAFE_INTEGER)})}initialize(g){this.constraintsProvider=rm.getProvider(this.mediaType,this.configProvider,this.logger),this.currentConstraints=this.constraintsProvider.createConstraintsObject(g),this.gumStreamProvider=pm.getStreamProvider(this.mediaType,this.configProvider,this.logger),this.mediaStreamRequestStrategy=_m.getStrategy(this.mediaType,this.gumStreamProvider,this.serialQueue,this.logger,this.configProvider,!!this.currentConstraints.withOverridenStream),this.clientGenerationStrategy=new Cm(this,this.currentConstraints,this.constraintsProvider,this.gumStreamProvider,this.configProvider,this.logger),this.clientGenerationStrategy.on("onAllClientsDisposed",(()=>this.onAllClientsDisposed()))}onAllClientsDisposed(){this.logger.safe.info("All clients are disposed, disposing master stream"),this.dispose()}async startStream(g){try{await this.getOrCreateMediaStream(g),this.event("onStreamStarted").raise(this,this.currentConstraints)}catch(g){throw this.event("onStreamError").raise(this,g),g}}async getOrCreateMediaStream(g){if(this.mediaStream)return Promise.resolve();const m=this.getRequestStartTimestamp(),f=await this.mediaStreamRequestStrategy.getStream(g);return this.gumRequestTime=this.getRequestDuration(m),this.handleMediaStreamRequestSuccess(f,g)}async handleMediaStreamRequestSuccess(g,m){const f=m.withOverridenStream&&m.withEffect&&this.configProvider.config.useRawMediaApiForVideoEffects;this.logger.safe.info(`Media stream acquired: ${printMediaStream(g)} with constraints: ${JSON.stringify(scrubConstraints(m))}`),this.originalMediaStream=g,this.subscribeToTrackEvents(this.originalMediaStream),m.withEffect&&!f?this.mediaStream=await this.getVideoEffectStream(g):this.mediaStream=g,"Audio"===this.mediaType&&await this.startNoiseSuppression(),this.currentConstraints=m,this.applyState(this.mediaStream),this.event("onStreamAcquired").raise(this,this.gumRequestTime,"Audio"!==this.mediaType&&this.getResolution()||void 0)}async getVideoEffectStream(g){this.sub=this.effectManager.on("onVideoStreamQualityChanged",((g,m,f)=>this.onVideoStreamQualityChanged(g,m,f)));const m=await this.effectManager.startEffect("Video",g);return this.logger.safe.info(`Media stream switched: ${printMediaStream(g)} -> ${printMediaStream(m)}`),m}subscribeToTrackEvents(g){const m=g?this.getTrackByMediaType(g,this.mediaType):null;m&&(m.onended=g=>{this.logger.safe.info(`Track ${m.id} ended: ${JSON.stringify(g)}`),this.event("onStreamTrackEnded").raise(this,g)},m.onmute=()=>{this.logger.safe.info(`Track ${m.id} muted`),this.event("onStreamTrackMuted").raise(this,!0)},m.onunmute=()=>{this.logger.safe.info(`Track ${m.id} unmute`),this.event("onStreamTrackMuted").raise(this,!1)})}unsubscribeFromTrackEvents(g){const m=g?this.getTrackByMediaType(g,this.mediaType):null;m&&(m.onended=null,m.onmute=null,m.onunmute=null)}getTrackByMediaType(g,m){return"Audio"===m?g.getAudioTracks()[0]:g.getVideoTracks()[0]}removeVideoEffectStream(){this.sub?.dispose(),this.effectManager.stopEffect("Video",this.mediaStream)}applyState(g){g.getAudioTracks()?.forEach((g=>this.applyAudioState(g)));const m=g.getVideoTracks()[0];this.applyVideoState(m)}applyAudioState(g){g&&(this.hasNonDefaultAudioProcessingConstraints()||"ScreenShare"===this.mediaType?this.applyContentHint(g,"music"):this.configProvider.config.defaultAudioContentHint&&this.applyContentHint(g,this.configProvider.config.defaultAudioContentHint),g.muted&&this.event("onStreamTrackMuted").raise(this,!0),this.logger.safe.info(`Audio track added: ${JSON.stringify(g.id)}`))}applyVideoState(g){g&&("ScreenShare"===this.mediaType&&this.configProvider.config.webrtcDisplayStreamContentHint&&this.applyContentHint(g,this.configProvider.config.webrtcDisplayStreamContentHint),this.logger.safe.info(`Video track added: ${JSON.stringify(g.id)}`))}applyContentHint(g,m){this.logger.safe.info(`Apply content hint: ${m}`),g.contentHint=m}hasNonDefaultAudioProcessingConstraints(){const g=this.currentConstraints.audio;if(g){const m=this.configProvider.config.defaultAudioProcessingFlags;let f;return void 0===g.echoCancellation&&void 0===g.autoGainControl&&void 0===g.noiseSuppression||(f=0,void 0!==g.echoCancellation&&(f+=g.echoCancellation?2:0),void 0!==g.autoGainControl&&(f+=g.autoGainControl?1:0),void 0!==g.noiseSuppression&&(f+=g.noiseSuppression?4:0)),f!==m}return!1}getRequestStartTimestamp(){return Date.now()}getRequestDuration(g){return 0===g?0:Date.now()-g}async startNoiseSuppression(){this.logger.safe.info(`ECS keys for wasmvqe are: ${JSON.stringify(this.configProvider.config.wasmvqe)}`),this.logger.safe.info(`ECS keys for wasmdns are: ${JSON.stringify(this.configProvider.config.wasmdns)}`),this.mediaStream=await this.effectManager.startEffect("Audio",this.mediaStream)}stopMediaStream(g){return this.mediaStreamStartPromise?(this.logger.safe.info(`Queueing media stream stop: ${g}`),this.serialQueue.add((()=>this.stopMediaStreamInternal()))):Promise.resolve()}stopOneMediaStream(g){try{g.getTracks().forEach((g=>{this.logger.safe.info(`Track is stopped: ${JSON.stringify(g.id)}`),g.stop()})),this.logger.safe.info(`Media stream stopped: ${g.id}`)}catch(g){this.logger.safe.warn(`Failed to stop media stream: ${stringifyObject(g)}`)}}stopMediaStreamInternal(){"Video"===this.mediaType&&this.configProvider.config.enableVideoEffects&&this.removeVideoEffectStream(),this.mediaStream&&(this.stopOneMediaStream(this.mediaStream),this.mediaStream=null),this.originalMediaStream&&(this.stopOneMediaStream(this.originalMediaStream),this.unsubscribeFromTrackEvents(this.originalMediaStream),this.originalMediaStream=null)}onVideoStreamQualityChanged(g,m,f){this.logger.safe.debug(`onStreamQualityChanged: ${JSON.stringify(g)}@${m}, reason=${f}`),this.event("onStreamQualityChanged").raise(this,g,m,f)}};Am.streamId=0;var Pm=Am,Rm=class _MediaStreamManager extends Be{constructor(g,m,f){super(g),this.logger=g,this.configProvider=m,this.effectsManager=f,this.cachedStreamsSubs=new Map,this.cachedStreamsMap=new Map,this.mediaStreamSerialQueue=new Lp(this.logger),this.couldUseWebrtc_1_0=!1}getMediaStream(g,m){this.logger.safe.info(`retrieving media stream: ${JSON.stringify(scrubConstraints(g))}`),this.cachedStreamsMap.size||(this.couldUseWebrtc_1_0=canUseWebrtc1_0(this.configProvider.config.checkSupportForWebrtc_1_0));let f=this.getSuitableStream(g);f||(this.logger.safe.info(`cached stream is not found. Creating a new one with constraints: ${stringifyObject(scrubConstraints(g))}`),f=this.createCachedStream(g)),this.logger.safe.info(`starting cached stream id=${f.id}`,m);const S=f.getClient(m);return S.start().catch((g=>{this.logger.safe.error(`could not start media stream: ${f.id}, total streams: ${this.cachedStreamsMap.size}, error: ${stringifyObject(g)}`),this.removeStream(f)})),S}dispose(){this.cachedStreamsSubs&&(this.cachedStreamsSubs.forEach((g=>{g.forEach((g=>{g.dispose()}))})),this.cachedStreamsSubs=null),this.cachedStreamsMap&&(this.cachedStreamsMap.forEach((g=>g.dispose("MSM dispose"))),this.cachedStreamsMap=null),this.mediaStreamSerialQueue&&(this.mediaStreamSerialQueue.dispose(),this.mediaStreamSerialQueue=null),super.dispose()}getCachedStreams(){return this.cachedStreamsMap}getActiveConstraints(){const g={audio:!1,video:!1,sharing:!1};return this.cachedStreamsMap.forEach(((m,f)=>{f.audio&&(g.audio=!0),f.video&&(g.video=!0),f.sharing&&(g.sharing=!0)})),g}onDevicesChanged(g){this.configProvider.config.enablePermissionsWorkaround&&_MediaStreamManager.isDeviceListEmpty(g)?this.logger.safe.info("Device list is empty, permission workaround enabled"):this.cachedStreamsMap.forEach(((m,f)=>{if(!f.sharing){const m=this.isDeviceOutdated(f.audio,g),S=this.isDeviceOutdated(f.video,g);(m||S)&&this.cachedStreamsMap.delete(f)}}))}getSuitableStream(g){let m;return this.cachedStreamsMap.forEach(((f,S)=>{this.isSuitable(this.addDeviceIdIfNecessary(f,S),g)&&(m=S)})),m&&this.cachedStreamsMap.get(m)}addDeviceIdIfNecessary(g,m){if(!g.deviceId)return m;const f=this.cloneStreamConstraints(m);return m.audio&&void 0===m.audio.deviceId&&(f.audio.deviceId=g.deviceId),m.video&&void 0===m.video.deviceId&&(f.video.deviceId=g.deviceId),m.sharing&&(f.sharing.deviceId=je.DISPLAY_SOURCE_ID),f}cloneStreamConstraints(g){return{...deepClone(g),withOverridenStream:g.withOverridenStream}}createCachedStream(g){const m=this.createStream(g);return this.event("onStreamCreated").raise(m.id,m.mediaType),this.subscribeOnStreamEvents(m),this.logger.safe.info(`created media stream, id: ${m.id} total: ${this.cachedStreamsMap.size}`),this.cachedStreamsMap.set(g,m),m}disposeCurrentDeviceStream(g){for(const[m,f]of this.cachedStreamsMap.entries())g.sharing||m.sharing||(_MediaStreamManager.deviceChanged(g.audio,m.audio)||_MediaStreamManager.deviceChanged(g.video,m.video))&&f.dispose("MSM dispose oneStreamPerDeviceType")}createStream(g){return this.configProvider.config.oneStreamPerDeviceType&&this.couldUseWebrtc_1_0&&this.disposeCurrentDeviceStream(g),this.configProvider.config.webrtcSimulcastSessionEnabled&&qs.hasApplyConstraints()&&this.couldUseWebrtc_1_0?new Pm(g,this.mediaStreamSerialQueue,this.configProvider,this.logger,this.effectsManager):new vm(g,this.mediaStreamSerialQueue,this.logger,this.configProvider)}subscribeOnStreamEvents(g){const m=[];m.push(g.on("onStreamAcquired",((g,m,f)=>this.onStreamAcquired(g,m,f)))),m.push(g.on("onStreamDisposing",(g=>this.onStreamDisposing(g)))),this.cachedStreamsSubs.set(g,m)}unsubscribeFromStreamEvents(g){this.cachedStreamsSubs.get(g).forEach((g=>g.dispose())),this.cachedStreamsSubs.delete(g)}removeStream(g){this.logger.safe.info(`release media stream generation: ${g.id} cached: ${this.cachedStreamsMap.size}`),this.cachedStreamsSubs.has(g)?(this.unsubscribeFromStreamEvents(g),this.cachedStreamsMap.delete(this.getConstraintsForStream(g)),this.getStreamsCountByType("Audio")||this.effectsManager.stopEffect("Audio"),this.cachedStreamsMap.size||this.event("onAllStreamsRemoved").raise()):this.logger.safe.warn(`skipping unknown stream ${g.id}`)}getConstraintsForStream(g){let m;return this.cachedStreamsMap.forEach(((f,S)=>{g===f&&(m=S)})),m}isSuitable(g,m){const f=!(!g.withOverridenStream||!m.withOverridenStream),S=f||m.sharing||this.isAcceptable(g.audio,m.audio)&&g.audioProcessingFlags===m.audioProcessingFlags,v=f||this.isAcceptable(g.video,m.video),C=this.configProvider.config.requireUserActionForAudioSharing&&m.sharing&&!!g.audio!=!!m.audio,_=this.isAcceptable(g.sharing,m.sharing),E=_&&this.isAcceptable(g.audio,m.audio),T=C?E:_,I=g.withEffect===m.withEffect,b=g.withOverridenStream?.id===m.withOverridenStream?.id;return!m.force&&S&&v&&T&&I&&b}isAcceptable(g,m){return!g&&!m||g&&m&&g.deviceId===m.deviceId}isDeviceOutdated(g,m){return g?.deviceId&&!m.some((m=>m.deviceId===g.deviceId))}onStreamDisposing(g){this.logger.safe.info(`onStreamDisposing event ${g.id}`),this.event("onStreamDisposing").raise(g.id,g.mediaType),this.removeStream(g)}onStreamAcquired(g,m,f){const S="Audio"===g.mediaType?void 0:!!g.rawStream.getAudioTracks()[0],v="ScreenShare"===g.mediaType?this.getSharingSource(g):void 0;this.event("onStreamAcquired").raise(g.id,g.mediaType,m,f,S,v)}getSharingSource(g){const m=g.rawStream.getVideoTracks()[0],f=m.getConstraints();if(f?.deviceId)return"camera";const S=m.getSettings();return S?.displaySurface??"unknown"}static deviceChanged(g,m){return!(!g||!m)&&g.deviceId!==m.deviceId}static isDeviceListEmpty(g){return g.every((g=>""===g.label))}getStreamsCountByType(g){let m=0;return this.cachedStreamsMap.forEach((f=>{m+=f.mediaType===g?1:0})),m}},wm=class{constructor(g,m,f,S,v){this.deviceId=g,this.label=m,this.kind=f,this.groupId=S,this.capabilities=v,this.type=this.getType(this.kind),this.guid=`${this.type}:${this.deviceId}`,this.isSystemDefault=this.deviceId===je.MEDIA_DEVICE.defaultId}toDeviceDesc(){return{id:this.guid,browserId:this.deviceId,label:this.label,kind:this.type}}getType(g){switch(g){case je.MEDIA_DEVICE_KIND.audioInput:return je.MEDIA_DEVICE.microphone;case je.MEDIA_DEVICE_KIND.audioOutput:return je.MEDIA_DEVICE.speaker;case je.MEDIA_DEVICE_KIND.videoInput:return je.MEDIA_DEVICE.camera;case je.MEDIA_DEVICE_KIND.compositeAudio:return je.MEDIA_DEVICE.compositeAudio;case je.MEDIA_DEVICE_KIND.virtualDevice:return je.MEDIA_DEVICE.virtualDevice;default:throw new Error(`Device kind to recognized: ${g}`)}}},Mm=class extends wm{constructor(g,m,f,S){super(g,m,f,S)}},Dm=class extends wm{constructor(g,m,f,S,v){super(g,m,f,S,v)}toDeviceDesc(){const g=super.toDeviceDesc();return g.isSystemDefault=this.isSystemDefault,g}},Om=class extends wm{constructor(g,m,f,S,v){if(super(g,m,f,S,v),this.position="unknown",v&&v.facingMode&&1===v.facingMode.length)switch(v.facingMode[0]){case"user":this.position="front";break;case"environment":this.position="back"}}toDeviceDesc(){const g=super.toDeviceDesc();return g.position=this.position,g}},Nm=class extends wm{constructor(g,m,f,S,v,C){super(null,f,S,""),this.micDevice=g,this.speakerDevice=m,this.formFactor=v,this.isPcInternalDevice=C,this.guid=null,this.isSystemDefault=!1}get micDeviceId(){return this.micDevice.guid}get speakerDeviceId(){return this.speakerDevice.guid}toDeviceDesc(){const g=super.toDeviceDesc();return g.microphoneId=this.micDeviceId,g.speakerId=this.speakerDeviceId,g.formFactor=this.formFactor,g.isPcInternalDevice=this.isPcInternalDevice,g}};function createDevice(g){const m=g.getCapabilities&&g.getCapabilities();switch(m&&(delete m.groupId,delete m.deviceId),g.kind){case je.MEDIA_DEVICE_KIND.audioInput:case je.MEDIA_DEVICE_KIND.audioOutput:return new Dm(g.deviceId,g.label,g.kind,g.groupId,m);case je.MEDIA_DEVICE_KIND.videoInput:return new Om(g.deviceId,g.label,g.kind,g.groupId,m);default:throw new Error(`Device kind is not recognized: ${g.kind}`)}}function createCompositeAudioDevice(g,m,f){return new Nm(g,m,f,"compositeAudio",0,!1)}function createDefaultDevice(g){const m={deviceId:je.MEDIA_DEVICE.defaultId,label:je.MEDIA_DEVICE.defaultDeviceLabel,kind:getKind(g),groupId:"",toJSON:()=>JSON.stringify(m)};return createDevice(m)}function getKind(g){switch(g){case je.MEDIA_DEVICE.microphone:return je.MEDIA_DEVICE_KIND.audioInput;case je.MEDIA_DEVICE.speaker:return je.MEDIA_DEVICE_KIND.audioOutput;case je.MEDIA_DEVICE.camera:return je.MEDIA_DEVICE_KIND.videoInput;default:throw new Error(`Device type to recognized: ${g}`)}}function compilePrimitiveDeviceList(g,m,f,S,v={str:""}){v.str+=`|input(${m.length})`;let C=[];const _=[S.config.devices.blacklist[g],S.defaultConfig.devices.blacklist[g]];for(const g of _)try{const f=new RegExp(g,"i");C=m.filter((m=>g&&m.label.match(f)?(v.str+=`|-blacklisted(${m.label})`,!1):m.deviceId!==je.MEDIA_DEVICE.communicationsId||(v.str+="|-communications",!1)));break}catch(f){v.str+=`|filterError('${g}', ${stringifyObject(f)})`,C=m}if(C.length){const m=deductDefaultDevice(f,C,v);if(m&&(m.isSystemDefault=!0,v.str+=`|default(${scrubMriOrOmit(m.guid)})`),m&&m.deviceId!==je.MEDIA_DEVICE.defaultId&&C.length>1&&(C=C.filter((g=>g.deviceId!==je.MEDIA_DEVICE.defaultId||(v.str+="|-defaultId",!1)))),g===je.MEDIA_DEVICE.camera||m||(v.str+="|+syntheticDefault",C.unshift(createDefaultDevice(g))),f.forEach((g=>{const m=C.find((m=>m.guid===g.guid));m&&!m.label&&g.label&&(v.str+=`|migrateLabel(${scrubMriOrOmit(m.guid)})`,m.label=g.label)})),g===je.MEDIA_DEVICE.speaker){const g=C.filter((g=>""===g.label));g.length>1&&g.length===C.length&&(C=m?[m]:[C[0]],v.str+=`|-filteredEmptyLabels(${g.length})`)}}return C}function deductDefaultDevice(g,m,f){if(1===m.length)return f.str+="|default:only",m[0];const S=m.find((g=>g.isSystemDefault&&g.deviceId===je.MEDIA_DEVICE.defaultId));if(!S)return f.str+="|default:noSynthetic",m.find((g=>g.isSystemDefault))||m[0];{const v=m.filter((g=>g!==S));if(1===v.length)return f.str+="|default:firstNonDefault",v[0];if(""!==S.groupId){const g=v.filter((g=>g.groupId===S.groupId));if(1===g.length)return f.str+=`|default:groupId(${scrubMriOrOmit(g[0].guid)})`,g[0]}const C=v.map((g=>g.label)),_=getMaxSubstring(S.label,C),E=v.find((g=>g.label===_));if(E)return f.str+=`|default:label(${scrubMriOrOmit(E.guid)})`,E;const T=g.find((g=>g.isSystemDefault));if(T){const g=v.find((g=>g.deviceId===T.deviceId));if(g)return f.str+=`|default:previousList(${scrubMriOrOmit(g.guid)})`,g}}return f.str+="|default:anyOrNull",m.find((g=>g.isSystemDefault))||null}function compileAudioDeviceList(g,m,f=.5,S={str:""}){const v=[];if(g.length&&m.length){const C=getGroupedPairs(g.filter((g=>""!==g.groupId)),m.filter((g=>""!==g.groupId)),S);C.length&&(v.push(...C.map((g=>createCompositeAudioDevice(g.microphone,g.speaker,createCompositeDeviceLabel(g.microphone.label,g.speaker.label))))),S.str+=`|directMatched(${v.length})`);const _=v.length;v.push(...composeAudioDevicesFromLabels(g.filter((g=>!v.some((m=>m.micDeviceId===g.guid)))),m.filter((g=>!v.some((m=>m.speakerDeviceId===g.guid)))),f,S)),S.str+=`|otherMatched(${v.length-_})`}return v}function getGroupedPairs(g,m,f={str:""}){const S=new Set;for(const f of[...g,...m])S.add(f.groupId);const v=[];for(const C of S.values()){let S=g.filter((g=>g.groupId===C)),_=m.filter((g=>g.groupId===C));if(S&&_)if(1===S.length&&1===_.length)v.push({microphone:S[0],speaker:_[0]}),f.str+=`|pairSimple(${scrubMriOrOmit(S[0].guid)}, ${scrubMriOrOmit(_[0].guid)})`;else if(S.length>1||_.length>1){let g=getMostSimilarPair(S,_);for(;g;)f.str+=`|pairComplex(${scrubMriOrOmit(g.microphone.guid)}, ${scrubMriOrOmit(g.speaker.guid)})`,v.push(g),S=S.filter((m=>m!==g.microphone)),_=_.filter((m=>m!==g.speaker)),g=getMostSimilarPair(S,_)}}return v}function getMostSimilarPair(g,m){let f=999,S=null;if(g.length>0&&m.length>0)for(const v of g)for(const g of m){const m=levenshteinDistance(v.label,g.label);m<f&&(f=m,S={microphone:v,speaker:g})}return S}function composeAudioDevicesFromLabels(g,m,f,S){const v=[];return g.length&&m.length?(g.forEach((g=>{const C=m.filter((m=>m.groupId===g.groupId));if(!C.length)return void(S.str+=`|lbl_nocand(${scrubMriOrOmit(g.guid)})`);let _=getLongestCommonContiguousSubstring(g.label,C[0].label).length;const E=C.sort(((m,f)=>{const S=getLongestCommonContiguousSubstring(g.label,m.label),v=getLongestCommonContiguousSubstring(g.label,f.label);return S.length>_&&(_=S.length),v.length>_&&(_=v.length),v.length-S.length}));if(E.length){const m=_/g.label.length;m>f&&(v.push(createCompositeAudioDevice(g,E[0],createCompositeDeviceLabel(g.label,E[0].label))),S.str+=`|lbl_matched(${scrubMriOrOmit(g.guid)} & ${scrubMriOrOmit(E[0].guid)}, ${Math.round(1e4*m)/100}%)`)}})),v):v}function createCompositeDeviceLabel(g,m){if(g===m)return g;let f=getLongestCommonContiguousSubstring(g,m);f=f.trim().replace(/^\((.+)\)$/,"$1");let S="",v="",C=0;const _=[countBraces(g),countBraces(m)];if(0===_[0]||0===_[1])return f;for(let g=0;g<f.length;g++)if("("===f[g])C++,v+=f[g];else if(")"===f[g]){if(!(C>0))break;C--,v+=f[g],S+=v,v=""}else C>0?v+=f[g]:S+=f[g];const E=countBraces(S);return E!==_[0]&&E!==_[1]||(S=S.replace(/\w+\s?\((.+)\)/,"$1"),S=createCompositeDeviceLabel(f,S)),S.trim()}function countBraces(g){const m=["(",")"];let f=0;for(let S=0;S<g.length;S++)m.some((m=>g[S]===m))&&f++;return f}var km={microphone:"",camera:"",speaker:"",compositeAudio:"",audioIngestDevice:"",virtualDevice:""},Lm=class extends Be{constructor(g,m){super(m),this.configProvider=g,this.logger=m,this.debugInfo=km,this.lists=new Map,this.lists.set(je.MEDIA_DEVICE.microphone,[]),this.lists.set(je.MEDIA_DEVICE.camera,[]),this.configProvider.userAgentConfig.isAudioOutputSelectionSupported&&(this.lists.set(je.MEDIA_DEVICE.speaker,[]),this.lists.set(je.MEDIA_DEVICE.compositeAudio,[])),g.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>this.onConfigUpdated())),this.logger.safe.info("Initialized")}get devices(){const g=[];return this.lists.forEach((m=>g.push(...m))),g}getDevicesByType(g){return this.lists.get(g)??[]}updateDevices(g,m=!1){if(deepEqual(this.latestRawList,g))return;this.latestRawList=g;const f=this.devices;this.debugInfo.microphone="microphone",this.debugInfo.camera="camera",this.debugInfo.speaker="speaker",this.debugInfo.compositeAudio="compositeAudio",this.updatePrimitiveDeviceList(je.MEDIA_DEVICE.microphone,g.filter((g=>g.type===je.MEDIA_DEVICE.microphone))),this.updatePrimitiveDeviceList(je.MEDIA_DEVICE.camera,g.filter((g=>g.type===je.MEDIA_DEVICE.camera))),this.lists.get(je.MEDIA_DEVICE.speaker)&&(this.updatePrimitiveDeviceList(je.MEDIA_DEVICE.speaker,g.filter((g=>g.type===je.MEDIA_DEVICE.speaker))),this.lists.get(je.MEDIA_DEVICE.compositeAudio)&&this.updateCompositeAudioDeviceList(this.lists.get(je.MEDIA_DEVICE.microphone),this.lists.get(je.MEDIA_DEVICE.speaker)));const S=this.lists.get(je.MEDIA_DEVICE.compositeAudio)||[];this.lists.set(je.MEDIA_DEVICE.microphone,this.orderDeviceList(this.lists.get(je.MEDIA_DEVICE.microphone),S)),this.lists.get(je.MEDIA_DEVICE.speaker)&&this.lists.set(je.MEDIA_DEVICE.speaker,this.orderDeviceList(this.lists.get(je.MEDIA_DEVICE.speaker),S));const v=this.lists.get(je.MEDIA_DEVICE.microphone);this.setTopItemToDefault(v);const C=this.lists.get(je.MEDIA_DEVICE.speaker);this.setTopItemToDefault(C),deepEqual(f,this.devices)||(this.logger.safe.info("Device lists updated and changed"),this.logger.safe.info(this.debugInfo.microphone),this.logger.safe.info(this.debugInfo.camera),this.logger.safe.info(this.debugInfo.speaker),this.logger.safe.info(this.debugInfo.compositeAudio),this.event("onDevicesChanged").raise(this.devices,m))}updateVirtualDeviceList(g){const m=this.lists.get(je.MEDIA_DEVICE.virtualDevice),f=g.map((g=>new Mm(g.id,g.label,"virtualDevice","")));deepEqual(m,f)?this.logger.safe.info("Device lists did not change."):(this.lists.set(je.MEDIA_DEVICE.virtualDevice,f),this.event("onDevicesChanged").raise(this.devices,!1))}updateActiveMicrophone(g){if(!g||g.deviceId===je.MEDIA_DEVICE.defaultId)return;const m=this.lists.get(je.MEDIA_DEVICE.microphone),f=m.findIndex((g=>g.isSystemDefault));-1!==f&&m[f]!==g?(this.logger.safe.info("Removing synthetic default microphone"),g.isSystemDefault=!0,m.splice(f,1),this.lists.set(je.MEDIA_DEVICE.microphone,m),this.event("onDevicesChanged").raise(this.devices,!1)):g.isSystemDefault=!0}updatePrimitiveDeviceList(g,m){const f={str:this.debugInfo[g]};this.lists.set(g,compilePrimitiveDeviceList(g,m,this.lists.get(g)||[],this.configProvider,f)),this.debugInfo[g]=f.str}updateCompositeAudioDeviceList(g,m){const f={str:this.debugInfo.compositeAudio};this.lists.set(je.MEDIA_DEVICE.compositeAudio,compileAudioDeviceList(g,m,this.configProvider.config.devices.compositeLabelMatchingThreshold,f)),this.debugInfo.compositeAudio=f.str}orderDeviceList(g,m){return g.sort(((g,f)=>this.getDevicePriority(f,this.getCompositeAudioDeviceCounterpart(f,m))-this.getDevicePriority(g,this.getCompositeAudioDeviceCounterpart(g,m))))}getCompositeAudioDeviceCounterpart(g,m){const f=m.find((m=>m.micDeviceId===g.guid||m.speakerDeviceId===g.guid));return f?f[g.type===je.MEDIA_DEVICE.speaker?"micDevice":"speakerDevice"]:null}getDevicePriority(g,m){let f=0;return this.configProvider.config.devices.overrideDefault&&m&&(!g.isSystemDefault&&m.isSystemDefault?(this.debugInfo[g.type]+=`|overrideDefault(${scrubMriOrOmit(g.guid)})`,f+=10):g.isSystemDefault&&!m.isSystemDefault&&"microphone"===g.type&&(f+=15)),g.isSystemDefault&&(f+=5),m&&(f+=1,m.isSystemDefault&&(f+=2)),f}setTopItemToDefault(g){g?.length&&(g.forEach((g=>g.isSystemDefault=!1)),g[0].isSystemDefault=!0)}onConfigUpdated(){let g=!1;this.configProvider.userAgentConfig.isAudioOutputSelectionSupported?this.lists.has(je.MEDIA_DEVICE.speaker)||(this.lists.set(je.MEDIA_DEVICE.speaker,[]),this.lists.set(je.MEDIA_DEVICE.compositeAudio,[]),g=!0):(this.lists.has(je.MEDIA_DEVICE.speaker)&&(this.lists.delete(je.MEDIA_DEVICE.speaker),g=!0),this.lists.has(je.MEDIA_DEVICE.compositeAudio)&&(this.lists.delete(je.MEDIA_DEVICE.compositeAudio),g=!0)),g&&(this.logger.safe.info("Updating device list due to config update"),this.updateDevices(this.latestRawList||[]))}},Fm=class _DeviceEnumerator extends Be{constructor(g,m){super(m),this.pollingInterval=0,_DeviceEnumerator.enumeratorUsers.add(this),_DeviceEnumerator.initialize(this,g,m)}startDevicePolling(g){this.pollingInterval=g?_DeviceEnumerator.configProvider.config.devices.pollingIntervalIdle:_DeviceEnumerator.configProvider.config.devices.pollingIntervalActive,_DeviceEnumerator.updatePollingTask()}stopDevicePolling(g){this.pollingInterval=g?0:_DeviceEnumerator.configProvider.config.devices.pollingIntervalIdle,_DeviceEnumerator.updatePollingTask()}dispose(){super.dispose(),this.stopDevicePolling(!0),_DeviceEnumerator.enumeratorUsers.delete(this),0===_DeviceEnumerator.enumeratorUsers.size&&(_DeviceEnumerator.logger.safe.info("disposing"),_DeviceEnumerator.initializeCalled=!1,_DeviceEnumerator.isInitialized=new Sr,_DeviceEnumerator.list=void 0,_DeviceEnumerator.window.navigator.mediaDevices.ondevicechange=void 0)}static get isPolling(){return 0!==_DeviceEnumerator.currentPollingInterval}static initialize(g,m,f){_DeviceEnumerator.initializeCalled||(_DeviceEnumerator.initializeCalled=!0,_DeviceEnumerator.window=Ws.window,_DeviceEnumerator.configProvider=m,_DeviceEnumerator.logger=f,_DeviceEnumerator.list=new Lm(m,f.createChild("DeviceList")),m.userAgentConfig.on("isAudioOutputSelectionSupportedChanged",(()=>_DeviceEnumerator.enumerateDevices())),m.on("configUpdated",(()=>{void 0!==m.config.devices.pollingIntervalIdle&&null!==_DeviceEnumerator.pollingTimer&&g.startDevicePolling(!0)})),m.config.devices.pollingIntervalIdle&&m.config.devices.idlePollingOnStart&&g.startDevicePolling(!0),_DeviceEnumerator.window.navigator.mediaDevices&&(_DeviceEnumerator.window.navigator.mediaDevices.ondevicechange=()=>{f.safe.info("enumerating due to ondevicechange callback"),_DeviceEnumerator.enumerateDevices().catch((g=>{f.safe.error(`unable to enumerate ondevicechange: ${stringifyObject(g)}`)}))}),_DeviceEnumerator.enumerateDevices().then((()=>_DeviceEnumerator.isInitialized.resolve())).catch((g=>_DeviceEnumerator.isInitialized.reject(g))))}static async enumerateDevices(g=!1){if(!_DeviceEnumerator.window.navigator?.mediaDevices?.enumerateDevices)throw new Error("device enumeration unsupported");if(_DeviceEnumerator.enumerateDevicesPromise&&!g)return _DeviceEnumerator.logger.safe.info("enumeration request postponed"),void(_DeviceEnumerator.hasPendingUpdate=!0);try{_DeviceEnumerator.enumerateDevicesPromise??(_DeviceEnumerator.enumerateDevicesPromise=_DeviceEnumerator.configProvider.config.devices.enumerateDevicesTimeout?timeout(_DeviceEnumerator.window.navigator.mediaDevices.enumerateDevices(),_DeviceEnumerator.configProvider.config.devices.enumerateDevicesTimeout,"enumerateDevices"):_DeviceEnumerator.window.navigator.mediaDevices.enumerateDevices());const m=await _DeviceEnumerator.enumerateDevicesPromise;_DeviceEnumerator.list.updateDevices(m.map((g=>createDevice(g))),g)}catch(g){const m=stringifyObject(g);throw _DeviceEnumerator.logger.safe.warn(`error with enumerating devices: ${m}`),_DeviceEnumerator.raiseFailedEnumeration(m),g}finally{_DeviceEnumerator.enumerateDevicesPromise=void 0,_DeviceEnumerator.hasPendingUpdate&&(_DeviceEnumerator.hasPendingUpdate=!1,_DeviceEnumerator.logger.safe.info("running postponed enumeration"),_DeviceEnumerator.enumerateDevices())}}static updatePollingTask(){let g=Number.MAX_SAFE_INTEGER;for(const m of _DeviceEnumerator.enumeratorUsers.values())m.pollingInterval<g&&(g=m.pollingInterval);if(g===Number.MAX_SAFE_INTEGER&&(g=0),(_DeviceEnumerator.pollingTimer||_DeviceEnumerator.currentPollingInterval!==g)&&_DeviceEnumerator.pollingTimer&&(_DeviceEnumerator.window.clearTimeout(_DeviceEnumerator.pollingTimer),_DeviceEnumerator.pollingTimer=void 0),_DeviceEnumerator.currentPollingInterval=g,0===g)return;const pollingTask=async()=>{if(_DeviceEnumerator.currentPollingInterval)try{await _DeviceEnumerator.enumerateDevices(!0),_DeviceEnumerator.pollingTimer=_DeviceEnumerator.window.setTimeout(pollingTask,_DeviceEnumerator.currentPollingInterval)}catch(g){throw _DeviceEnumerator.pollingTimer=null,g}};_DeviceEnumerator.logger.safe.info(`starting device polling with interval ${g}ms`),_DeviceEnumerator.pollingTimer=1,pollingTask()}static raiseFailedEnumeration(g){for(const m of _DeviceEnumerator.enumeratorUsers.values())m.event("onDeviceEnumerationfailed").raise(g)}};Fm.isInitialized=new Sr,Fm.initializeCalled=!1,Fm.currentPollingInterval=0,Fm.hasPendingUpdate=!1,Fm.enumeratorUsers=new Set;var xm=Fm,Um=class extends Be{constructor(g,m,f){super(f),this.deviceList=g,this.configProvider=m,this.logger=f,this.userSelectedDevices={microphone:null,camera:null,speaker:null},this.currentlySelectedDevices={microphone:null,camera:null,speaker:null,audioIngestDevice:null},this.deviceList.on("onDevicesChanged",(g=>this.onDevicesChanged(g))),g.devices.length>0&&this.onDevicesChanged(g.devices),this.logger.safe.info("Initialized")}get selectedDevices(){return deepClone(this.currentlySelectedDevices)}selectDevices(g){let m=!1;if(forOwn(g,((g,f)=>{const S=this.getDeviceToSelect(f,this.deviceList.getDevicesByType("audioIngestDevice"===f?"microphone":f),g);"camera"===f&&(this.userSelectedDevices[f]=S?.guid||this.userSelectedDevices[f]),S?.guid!==this.currentlySelectedDevices[f]?.guid&&(this.userSelectedDevices[f]=S?.guid||this.userSelectedDevices[f],m=!0),this.currentlySelectedDevices[f]=S})),m){const g=values(this.currentlySelectedDevices).map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed from public interface: ${g}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!0)}}getDeviceToSelect(g,m,f){let S;const v=this.userSelectedDevices[g];return f?S=m.find((g=>g.guid===f)):v&&(S=m.find((g=>g.guid===v))),"audioIngestDevice"===g?S:S||m[0]}onDevicesChanged(g){let m=!1;if(Object.keys(this.currentlySelectedDevices).forEach((f=>{const S="audioIngestDevice"===f?"microphone":f,v=g.filter((g=>g.type===S));if(v.length>0){const g=this.getDeviceToSelect(f,v);g?.guid!==this.currentlySelectedDevices[f]?.guid&&(this.currentlySelectedDevices[f]=g,m=!0)}else this.currentlySelectedDevices[f]&&(this.currentlySelectedDevices[f]=null,m=!0)})),m){const g=values(this.currentlySelectedDevices).map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))));this.logger.safe.info(`Changed due to device list change: ${g}`),this.event("onSelectedDevicesChanged").raise(this.selectedDevices,!1)}}},Vm=class extends Be{constructor(g,m){super(g),this.logger=g,this.mediaStream=m,this.subs=[],this.subscribeOnMediaStreamEvents(m)}acquire(){return this.mediaStream?this.mediaStream.start().then((()=>this.logger.safe.info("Stream acquired"))).catch((g=>{throw this.logger.safe.warn(`Failed to acquire the stream: ${stringifyObject(g)}`),g})):Promise.reject("Disposed")}dispose(){this.logger.safe.info("Disposing stream"),this.unsubscribeFromMediaStreamEvents(),this.mediaStream&&(this.mediaStream.dispose(),this.mediaStream=null)}subscribeOnMediaStreamEvents(g){this.subs=[g.on("onStreamClientStarted",(()=>this.event("onStreamStateChanged").raise("active"))),g.on("onStreamClientMuted",((g,m)=>this.event("onStreamStateChanged").raise(m?"inactive":"active"))),g.on("onStreamClientEnded",(()=>this.event("onStreamStateChanged").raise("stopped"))),g.on("onStreamClientError",((g,m)=>{const f=m.type===je.MEDIA_ERROR.permissionDeniedError||m.type===je.MEDIA_ERROR.sharingCancelledError;this.event("onStreamStateChanged").raise(f?"cancelled":"failed")}))]}unsubscribeFromMediaStreamEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}},Bm=[je.MEDIA_STATE.inactive,je.MEDIA_STATE.receive,je.MEDIA_STATE.send,je.MEDIA_STATE.sendReceive],Hm=[je.MEDIA_STATE.inactive,je.MEDIA_STATE.receive],$m=class extends Be{constructor(g,m,f){super(f),this.configProvider=g,this.deviceManager=m,this.logger=f,this.currentState={microphone:"unknown",camera:"unknown"},this.lastGum={audio:!1,video:!1},this.registeredTrackers=new Set,this.accessIssuePermissionOther={audio:!1,video:!1},this.window=Ws.window,this.permittedModalities={audio:Bm,video:Bm,sharing:Bm},this.initialize()}async initialize(){!qs.hasPermissionsApi()||"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera?"unknown"!==this.currentState.microphone&&"unknown"!==this.currentState.camera||this.logger.safe.warn(`Permissions API is not supported in this browser. Microphone: ${this.currentState.microphone}, camera: ${this.currentState.camera}`):(this.logger.safe.info("Initializing"),await this.registerPermissionTracker("microphone"),await this.registerPermissionTracker("camera"))}getPermissionState(g){return this.currentState[g]||"unknown"}isPermissionKnown(g){const m=this.getPermissionState(g);return"unknown"!==m&&"prompt"!==m}get browserPermittedModalities(){return this.permittedModalities}get knownPermissionStates(){return deepClone(this.currentState)}update(g,m){const f=deepClone(m);g.audio||delete f.audio,g.video||delete f.video;const S=deepClone(this.permittedModalities);forOwn(f,((g,m)=>{this.permittedModalities[m]=g?Bm:Hm})),deepEqual(S,this.permittedModalities)||this.event("onDevicesPermissionChanged").raise()}async askDevicePermission(g){const m=g?deepClone(g):{audio:!0,video:this.deviceManager.hasCamera()};if(this.accessIssuePermissionOther={audio:!1,video:!1},this.configProvider.config.permissions.rememberNegative&&(m.audio=m.audio&&this.permittedModalities.audio===Bm,m.video=m.video&&this.permittedModalities.video===Bm),m.sharing)throw new Error("askDevicePermission does not support sharing constraints.");const f={audio:!1,video:!1};this.lastGum={audio:!1,video:!1};const resolve=async(f,S,v)=>{const C={audio:!!f.audio,video:!!f.video,sharing:!0};return!(this.configProvider.config.permissions.adpRequestAVLast&&m.audio&&m.video)||this.lastGum.audio&&this.lastGum.video||(this.logger.safe.info("Prompting for audio and video to ensure omnibar state"),await this.askDevicePermissionPrompt({audio:!0,video:!0},!1)),this.update(m,C),this.deviceManager.raiseTelemetryEvent("ask_device_permission",{constraints:g,resultConstraints:f,error:v,reason:S}),C};await this.initialize();const S=this.getPermissionState("microphone"),v=this.getPermissionState("camera");if(this.logger.safe.info(`Permission state { audio: ${S}, video: ${v} }`),this.configProvider.config.permissions.useNegativeInAdp&&(!m.audio||"denied"===S)&&(!m.video||"denied"===v))return resolve(f,"navigator_permissions_denied");if(this.configProvider.config.permissions.usePositiveInAdp&&(!m.audio||m.audio&&"granted"===S)&&(!m.video||m.video&&"granted"===v))return resolve(m,"navigator_permissions_granted");try{return resolve(this.getConstrainsWithPermissionError(await this.askDevicePermissionPrompt(m,this.configProvider.config.permissions.adpFallback)),"stream_acquisition")}catch(g){return resolve(f,"stream_acquisition",g)}}async askDevicePermissionPrompt(g,m=!0){const f={audio:!1,video:!1};try{const m=await this.deviceManager.getMediaStream(g);return m&&(this.lastGum=deepClone(g),await m.start(),f.audio=m.hasAudio(),f.video=m.hasVideo(),this.disposeLater(m)),f}catch(S){if(g.audio&&g.video&&m){try{f.video=this.configProvider.config.permissions.adpFallbackVideo&&(await this.askDevicePermissionPrompt({video:!0})).video}catch(g){g.type!==je.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.video=!0)}try{f.audio=this.configProvider.config.permissions.adpFallbackAudio&&(await this.askDevicePermissionPrompt({audio:!0})).audio}catch(g){g.type!==je.MEDIA_ERROR.permissionDeniedError&&(this.accessIssuePermissionOther.audio=!0)}}else if(m)throw S;return f}}getConstrainsWithPermissionError(g){return this.configProvider.config.permissions.disableOnPermissionDeniedOnly?{audio:this.accessIssuePermissionOther.audio||g.audio,video:this.accessIssuePermissionOther.video||g.video}:g}disposeLater(g){setTimeout((()=>{g.dispose()}),this.configProvider.config.mediaStreamHoldInterval)}async registerPermissionTracker(g){if(!this.registeredTrackers.has(g))try{const m=await this.window.navigator.permissions.query({name:g});this.handlePermissionStateChanged(g,m.state),m.onchange=()=>this.handlePermissionStateChanged(g,m.state),this.registeredTrackers.add(g)}catch(m){this.logger.safe.error(`Error querying permissions for ${g}: ${stringifyObject(m)}`)}}handlePermissionStateChanged(g,m){this.logger.safe.info(`Permission state for ${g} changed ${this.currentState[g]} -> ${m}`),this.currentState[g]=m,this.deviceManager.raiseTelemetryEvent("permissions_state_changed",this.knownPermissionStates),this.deviceManager.handlePermissionStateChange()}},Gm=class extends Ve{constructor(g,m=uniqueId()){super(),this.dms=g,this.label=m,this.id=uniqueId(),this.receivedEvents=new Map,this.subscribeToDeviceManagers(g)}getDeviceManagers(){return this.dms}dispose(){super.dispose(),this.dms?.forEach((g=>g.dispose())),this.dms=null}subscribeToDeviceManagers(g){g.forEach(((g,m)=>{g.on("onVideoEffectsEvent",((...m)=>this.eventHandler("onVideoEffectsEvent",g,(()=>this.event("onVideoEffectsEvent").raise(...m))))),g.on("onVideoEffectApplied",((...m)=>this.eventHandler("onVideoEffectApplied",g,(()=>this.event("onVideoEffectApplied").raise(...m))))),g.on("onDeviceTelemetryEvent",(g=>this.event("onDeviceTelemetryEvent").raise({deviceId:`${this.id}/${m}`,...g}))),g.on("onVideoEffectsTelemetryEvent",(g=>this.event("onVideoEffectsTelemetryEvent").raise({deviceId:`${this.id}/${m}`,...g}))),g.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise(`${this.id}/${m}`))),g.on("onStreamUpdateRequested",((...g)=>this.event("onStreamUpdateRequested").raise(...g)))}))}eventHandler(g,m,f){let S=this.receivedEvents.get(g);S??(S=new Set),S.add(m);if(this.dms.every((g=>S.has(g))))return f(),void S.clear();this.receivedEvents.set(g,S)}},sequentialize=()=>(g,m,f)=>{const S=f.value;return f.value=function(...g){return this.serialQueue.add(S.bind(this,...g))},f},jm=class{constructor(g){this.size=g,this.items=[]}clear(){this.items=[]}},Wm=class extends jm{get isFull(){return this.items.length>=this.size}add(g){return this.isFull&&this.items.shift(),this.items.push(g),!0}},qm=class extends jm{add(g){return!(this.items.length>=this.size)&&(this.items.push(g),!0)}},zm=class{constructor(g){this.error=new qm(g)}startLoadTimer(){this.loadStartTimestamp=Date.now()}stopLoadTimer(){this.loadDuration=Date.now()-this.loadStartTimestamp}clearErrors(){this.error.clear()}setError(g,m){this.error.add({type:g,message:m})}getReport(){return{loadDuration:this.loadDuration,error:this.error.items}}},Km=class{constructor(g,m,f){this.configProvider=g,this.statistics=m,this.logger=f}isWasmEffectSupported(){return this.configProvider.config.webcv.useWasmEffects?!!window.MediaStreamTrackProcessor||(this.logger.info("wasmEffects disabled, insertable streams are not supported"),!1):(this.logger.info("wasmEffects disabled by feature flag"),!1)}isWebgl2EffectSupported(){return this.isCurrentRendererSupported()&&this.isWebGL2Supported()}isCurrentRendererSupported(){const g=this.configProvider.config.webcv.webGLUnsupportedRenderers;let m=!1;const f=qs.unmaskedGlRenderer;return f&&!g.some((g=>g===f))?m=!0:(this.statistics.setError("RendererIsNotSupported",`Blacklisted from ${JSON.stringify(g)}`),this.logger.info(`Unsupported renderer: ${stringifyObject(f)}`)),m}isWebGL2Supported(){try{const g=document.createElement("canvas").getContext("webgl2");if(!g)return this.statistics.setError("WebGL2IsNotSupported"),this.logger.info("WebGL2 context is not supported"),!1;const m=g.getSupportedExtensions(),f=this.configProvider.config.webcv.webGLRequiredExtensions.filter((g=>!m.includes(g)));if(f.length>0)return this.statistics.setError("WebGL2RequiredExtensionsNotSupported","Required WebGL2 extensions not supported."),this.logger.info(`Unsupported WebGL2 extensions: ${stringifyObject(f)}`),!1}catch(g){return this.statistics.setError("WebGL2IsNotSupported",`Error: ${stringifyObject(g)}`),this.logger.error(`isWebGL2Supported: ${stringifyObject(g)}`),!1}return!0}},Jm=class extends Be{constructor(g,m,f,S){super(f),this.webcvProvider=g,this.configProvider=m,this.logger=f,this.createWasmCVWorker=S,this.serialQueue=new Lp(this.logger),this.videoEffectToWebCVEffectMapping={0:qn.VideoEffectType.Off,1:qn.VideoEffectType.BackgroundBlur,16:qn.VideoEffectType.BackgroundReplacement},this.effectType=0,this.isPortrait=!1,this.effectProviderSubs=[],this.statistics=new zm(this.configProvider.config.effectsTelemetryBufferSize),this.processorType=qn.ProcessorType.Webgl2,this.lastNotifiedResolutions=new Map}get isEffectEnabled(){return 0!==this.effectType}async init(){if(!this.effectProvider){this.logger.safe.debug("Init");try{this.effectProvider=await this.initializeVideoEffectProvider()}catch(g){throw this.notifyError("FailedToInitialize",`Initialization failed, error:${stringifyObject(g)}`),g}}}async dispose(){this.logger.safe.debug("Dispose"),this.effectProvider&&(this.effectProviderSubs.forEach((g=>g.dispose())),this.effectProviderSubs=null,await this.effectProvider.disposeAsync()),this.lastNotifiedResolutions.clear(),super.dispose()}async configure(g){if(this.logger.safe.debug(`Set config: ${JSON.stringify(g)}`),this.effectConfig={backgroundImageUrl:g.imagePath,headers:g.headers},this.effectProvider)return this.effectProvider.configureEffect(this.effectConfig);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setEffectAsync(g){if(!this.shouldApplyEffect(g))return void this.logger.safe.debug(`Effect ${this.effectType} is already set`);this.effectProvider||(this.logger.safe.debug("Initializing effect provider"),await this.init()),this.logger.safe.debug(`Set effect: ${g}`);const m=this.getWebCVEffect(g);if(!m)throw new Error(`Effect with type ${g} is not supported`);if(this.shouldCollectStats(g)&&this.notifyAboutLastSessionStats("EffectChanged"),this.effectType=g,this.effectProvider)try{await this.effectProvider.setEffectAsync(m)}catch(g){throw await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to apply ${m}, error:${stringifyObject(g)}`),g}else this.logger.safe.debug("WebCV is not initialized. Do nothing")}async setSourceAsync(g){if(this.logger.safe.debug(`Set source: ${g?g.id:"no stream"}`),!this.effectProvider)return this.logger.safe.debug("WebCV is not initialized. Do nothing"),g;if(g.getTracks().length>0){const m=g.getVideoTracks()[0].getSettings();this.isPortrait=m.height>m.width}let m=g;try{m=await this.effectProvider.setSourceAsync(g)}catch(g){await this.handleFailedProcessing(),this.notifyError("FailedToInitialize",`Failed to set source, error:${stringifyObject(g)}`)}return m}async removeSourceAsync(g){if(this.logger.safe.debug(`Remove source: ${g?g.id:"no stream"}`),this.effectProvider)return this.effectProvider.removeSourceAsync(g);this.logger.safe.debug("WebCV is not initialized. Do nothing")}async getEffectsCapability(){let g=0;const m=await this.getCapability();this.logger.safe.debug(`Get capabilty with return: ${JSON.stringify(m)}`);for(const f of m){const m=this.getVideoEffectType(f);if(!m)throw new Error(`Cannot convert WebCV effect to VideoEffect ${f}`);g|=m}return g}getStats(g){if(!this.effectProvider)return;const m=this.effectProvider.getStats(),f=this.statistics.getReport();return m||f.error.length?{timestamp:Date.now(),statsReason:g,...this.createTelemetryEvent(m,f)}:void 0}getVersion(){return this.effectProvider?.getVersion?.()??"Unknown"}async resetOutputConstraints(g,m=qn.EffectQualityChangeReason.ExternalParam){const f=this.getNewResolution(g,m),S={...this.configProvider.config.webcv.qualityConfig};return this.isPortrait?S.outputResolution=f.width:S.outputResolution=f.height,this.effectProvider?.configureStreamProcessor(S,qn.EffectQualityChangeReason.ExternalParam)}getNewResolution(g,m){let f;switch(m){case qn.EffectQualityChangeReason.ExternalParam:f=this.lastNotifiedResolutions.get(qn.EffectQualityChangeReason.RendererSize),this.lastNotifiedResolutions.set(qn.EffectQualityChangeReason.ExternalParam,g);break;case qn.EffectQualityChangeReason.RendererSize:f=this.lastNotifiedResolutions.get(qn.EffectQualityChangeReason.ExternalParam),this.lastNotifiedResolutions.set(qn.EffectQualityChangeReason.RendererSize,g)}return{width:Math.max(g.width,f?.width||Number.MIN_SAFE_INTEGER),height:Math.max(g.height,f?.height||Number.MIN_SAFE_INTEGER)}}createTelemetryEvent(g,m){return{payload:{version:this.getVersion(),...m,...g,isWasmEnabled:this.processorType===qn.ProcessorType.Wasm}}}notifyError(g,m){this.statistics.setError(g,m),this.notifyAboutLastSessionStats("EffectError")}notifyAboutLastSessionStats(g){const m=this.getStats(g);m&&this.event("onVideoEffectTelementyEvent").raise(m)}async initializeVideoEffectProvider(){if(!this.webcvProvider)return this.logger.safe.debug("WebCV provider is not set"),null;this.statistics.startLoadTimer();const g=await this.webcvProvider.getVideoEffectProvider();if(this.statistics.stopLoadTimer(),!g)return this.statistics.setError("FailedToInitialize"),this.logger.safe.warn("WebCV is not initialized"),null;this.logger.safe.debug(`WebCV v${g.getVersion?.()} is initialized`);const m=await this.webcvProvider.getModelConfig();return await g.configureModel(m),this.configProvider.config.webcv.loadWorkerCallback=this.createWasmCVWorker,await g.configure({...this.configProvider.config.webcv,processorType:this.processorType}),this.effectConfig&&await g.configureEffect(this.effectConfig),this.effectProviderSubs=[g.on("onEffectApplied",(()=>this.event("onMediaStreamUpdateRequested").raise("Video"))),g.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats("EffectStopped"))),g.on("onVideoEffectQualityChanged",(g=>this.event("onVideoEffectQualityChanged").raise(g))),g.on("onVideoStreamQualityChanged",(g=>this.event("onVideoStreamQualityChanged").raise(g.resolution,g.fps,g.reason))),g.on("onCapabilitiesChanged",(()=>this.event("onVideoEffectCapabilitiesChanged").raise())),g.on("onFirstFrameProcessed",(()=>this.onPreheatCompleted())),g.on("onErrorNotified",(g=>this.notifyError("WebcvProccessorError",g))),g.on("videoFreezeDetected",(g=>this.event("videoFreezeDetected").raise(g)))],g}async getCapability(){if(!this.configProvider.config.enableVideoEffects)return this.logger.debug("Video effects disabled"),[qn.VideoEffectType.Off];if(!this.webcvProvider)return this.logger.debug("WebCVProvider is not configured"),[qn.VideoEffectType.Off];const g=new Km(this.configProvider,this.statistics,this.logger.createChild("CapabilityChecker"));let m=[qn.VideoEffectType.Off];return g.isWasmEffectSupported()?(m=[qn.VideoEffectType.Off,qn.VideoEffectType.BackgroundBlur,qn.VideoEffectType.BackgroundReplacement],this.processorType=qn.ProcessorType.Wasm):g.isWebgl2EffectSupported()&&(m=[qn.VideoEffectType.Off,qn.VideoEffectType.BackgroundBlur,qn.VideoEffectType.BackgroundReplacement],this.processorType=qn.ProcessorType.Webgl2),this.effectProvider?this.effectProvider.getCapability():m}getWebCVEffect(g){return this.videoEffectToWebCVEffectMapping[g]}getVideoEffectType(g){return keys(this.videoEffectToWebCVEffectMapping).find((m=>this.videoEffectToWebCVEffectMapping[m]===g))}onPreheatCompleted(){this.event("onVideoEffectApplied").raise(),this.logger.safe.debug("onVideoEffectApplied event raised")}async handleFailedProcessing(){this.effectType=0;try{await this.effectProvider.setEffectAsync(qn.VideoEffectType.Off)}catch(g){this.notifyError("WebcvProccessorError",`Failed to handle error state, error:${stringifyObject(g)}`)}}shouldApplyEffect(g){return this.effectType!==g}shouldCollectStats(g){return 0!==this.effectType&&0!==g&&this.effectType!==g}};__decorateClass([sequentialize()],Jm.prototype,"init",1),__decorateClass([sequentialize()],Jm.prototype,"dispose",1),__decorateClass([sequentialize()],Jm.prototype,"configure",1),__decorateClass([sequentialize()],Jm.prototype,"setSourceAsync",1),__decorateClass([sequentialize()],Jm.prototype,"removeSourceAsync",1),__decorateClass([sequentialize()],Jm.prototype,"getEffectsCapability",1);var Ym=class extends Be{constructor(g,m,f,S,v,C){super(v),this.wasmdnsProvider=g,this.wasmaecProvider=m,this.wasmVqeProvider=f,this.configProvider=S,this.logger=v,this.createWasmAudioWorkletCbs=C,this.serialQueue=new Lp(this.logger),this.stopped=!0,this.hasError=!1,this.statistics=new zm(this.configProvider.config.effectsTelemetryBufferSize),this.currentEffect=zn.AudioEffectType.Off,this.userNoiseSuppressionMode=0,this.currentEffectCapability=0,this.nsModeToUserNsMode={Off:0,Auto:1,Low:2,High:3},this.audioEffectToWasmAudioEffectType={0:zn.AudioEffectType.Off,1:zn.AudioEffectType.NoiseSuppressionClassic,2:zn.AudioEffectType.NoiseSuppressionDeep,4:zn.AudioEffectType.EchoCancellationClassic,8:zn.AudioEffectType.VoiceQualityEnhancementClassic,16:zn.AudioEffectType.VoiceQualityEnhancementDeep},this.audioEffectTypeToUserNsMode={[zn.AudioEffectType.Off]:0,[zn.AudioEffectType.NoiseSuppressionClassic]:2,[zn.AudioEffectType.NoiseSuppressionDeep]:3},this.noiseSuppressionModeToWasmDnsEffectMapping={Off:zn.AudioEffectType.Off,High:zn.AudioEffectType.NoiseSuppressionDeep,Low:zn.AudioEffectType.NoiseSuppressionClassic},this.userNoiseSuppressionMode=this.nsModeToUserNsMode[this.configProvider.mediaConfig.noiseSuppressionMode]}shouldFallbackToNativeProcessing(){return!!this.configProvider.config.enableAudioProcessingFallback&&(this.configProvider.config.wasmvqe.enableVqe||this.configProvider.config.wasmdns.enableNoiseSuppression?this.hasError?(this.logger.safe.info("shouldFallbackToNativeProcessing: error was encountred initializing the package"),!0):this.configProvider.config.wasmvqe.enableVqe&&!this.wasmVqeProvider?(this.logger.safe.info("shouldFallbackToNativeProcessing: VQE provider is enabled but not loaded"),!0):!(!this.configProvider.config.wasmdns.enableNoiseSuppression||this.wasmdnsProvider&&this.wasmaecProvider)&&(this.logger.safe.info("shouldFallbackToNativeProcessing: DNS/AEC provider is enabled but not loaded"),!0):(this.logger.safe.info("shouldFallbackToNativeProcessing: custom processing is not enabled"),!0))}nsModeToVqeMode(g,m){switch(g){case"High":return m?zn.VqeMode.DeepVQE:zn.VqeMode.DeepNS;case"Low":return m?zn.VqeMode.SkypeVQE:zn.VqeMode.SkypeNS;default:return m?zn.VqeMode.SkypeAEC:zn.VqeMode.Off}}vqeModeToNsMode(g){switch(g){case zn.VqeMode.DeepVQE:case zn.VqeMode.DeepNS:return"High";case zn.VqeMode.SkypeVQE:case zn.VqeMode.SkypeNS:return"Low";case zn.VqeMode.SkypeAEC:case zn.VqeMode.Off:default:return"Off"}}vqeModeToAudioEffectType(g){switch(g){case zn.VqeMode.DeepVQE:return 16;case zn.VqeMode.DeepNS:return 2;case zn.VqeMode.SkypeVQE:return 8;case zn.VqeMode.SkypeNS:return 1;case zn.VqeMode.SkypeAEC:return 4;case zn.VqeMode.Off:default:return 0}}async configureEffect(g){this.stopped||this.stop(),this.statistics.clearErrors();let m=g;if(!m){let g=this.configProvider.mediaConfig.noiseSuppressionMode;this.logger.safe.info(`Configuring the audio effect manager for Noise Suppression mode: ${g}`),"Auto"===g&&(g=this.configProvider.config.wasmvqe.enableVqe?this.vqeModeToNsMode(this.configProvider.config.wasmvqe.defaultVqeMode):this.configProvider.config.wasmdns.noiseSuppressionMode,this.logger.safe.info(`Overriding 'Auto' with ${g}`)),m={...this.configProvider.config.wasmdns,...this.configProvider.config.wasmvqe},m.defaultVqeMode=this.nsModeToVqeMode(g,m.enableAec),m.noiseSuppressionMode=g}if(await this.getEffectsCapability(),this.configProvider.config.wasmvqe.enableVqe)try{this.vqeProvider||(this.logger.safe.debug("Initializing VQE provider ..."),this.vqeProvider=await this.initializeAudioEffectProvider(zn.AudioEffectType.VoiceQualityEnhancementDeep)),this.logger.safe.debug("Configuring VQE audio effects ..."),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmVqeWorklet,await this.vqeProvider.configureEffect(m),this.logger.safe.debug(`The audio effects were configured as follows: ${stringifyObject(m)}, and current capability is ${this.currentEffectCapability}.`)}catch(g){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${g}), while trying to use this configuration: ${stringifyObject(m)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}else if(this.configProvider.config.wasmdns.enableNoiseSuppression){m.noiseSuppressionMode||(this.logger.safe.debug("configureEffect was called without a noiseSuppressionMode. Using noiseSuppressionMode from config provider ..."),m.noiseSuppressionMode=this.configProvider.mediaConfig.noiseSuppressionMode),this.currentEffect=this.noiseSuppressionModeToWasmDnsEffectMapping[m.noiseSuppressionMode],this.logger.safe.debug(`currentEffect is ${this.currentEffect}`);try{this.dnsProvider||(this.logger.safe.debug("Initializing DNS provider ..."),this.dnsProvider=await this.initializeAudioEffectProvider(zn.AudioEffectType.NoiseSuppressionDeep)),this.aecProvider||(this.logger.safe.debug("Initializing AEC provider ..."),this.aecProvider=await this.initializeAudioEffectProvider(zn.AudioEffectType.EchoCancellationClassic)),this.logger.safe.debug("Configuring DNS/AEC audio effects ..."),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmDnsWorklet,await this.dnsProvider.configureEffect(m),m.loadAudioWorkletCallback=this.createWasmAudioWorkletCbs?.getWasmAecWorklet,await this.aecProvider.configureEffect(m),this.logger.safe.debug(`The audio effects were configured as follows: ${stringifyObject(m)}, and current capability is ${this.currentEffectCapability}.`)}catch(g){this.notifyError("FailedToInitialize",`Audio effect provider configuration failed (${g}), while trying to use this configuration: ${stringifyObject(m)},\n                    under the following capability: ${this.currentEffectCapability}.`),this.requestStreamUpdate()}this.stopped=!1}}async setSourceAsync(g){if(this.logger.safe.debug(`Set source: ${g?g.id:"no stream"}, currentEffect = ${this.currentEffect}`),this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect(),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const m=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${m}).`),this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${m}).`),g}if(!this.configProvider.config.wasmvqe.enableVqe&&!this.configProvider.config.wasmdns.enableNoiseSuppression)return g;if(this.effectProviderSubs=[this.vqeProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.vqeProvider?.on("onErrorNotified",(g=>this.notifyError("WasmVqeProccessorError",g))),this.dnsProvider?.on("onEffectStopped",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onMetricsUpdated",(()=>this.notifyAboutLastSessionStats())),this.dnsProvider?.on("onErrorNotified",(g=>this.notifyError("WasmDnsProccessorError",g))),this.aecProvider?.on("onErrorNotified",(g=>this.notifyError("WasmAecProccessorError",g)))],this.configProvider.config.wasmvqe.enableVqe)try{const m=await this.vqeProvider.setSourceAsync(g);return this.aecRefStream&&this.vqeProvider.setRefStream(this.aecRefStream),m}catch(m){return this.notifyError("WasmVqeProccessorError",`setSourceAsync: Failed to asynchronously set source for VQE (${m})`),g}let m=g;try{m=await this.aecProvider.setSourceAsync(g),this.aecRefStream&&this.aecProvider.setRefStream?.(this.aecRefStream)}catch(g){this.notifyError("WasmAecProccessorError",`setSourceAsync: Failed to asynchronously set source for AEC (${g})`)}try{return await this.dnsProvider.setSourceAsync(m)}catch(g){this.notifyError("WasmDnsProccessorError",`setSourceAsync: Failed to asynchronously set source for DNS (${g})`)}return m}async setAecRefStream(g){try{if(this.logger.safe.debug(`Setting the reference stream to: ${g?g.id:"Null"}`),!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const g=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setAecRefStream: audio effect provider not initialized (${g}).`),void this.logger.safe.warn(`Unable to setAecRefStream for audio effects: audio effect provider not initialized (${g}).`)}this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider.setRefStream(g):this.configProvider.config.wasmdns.enableNoiseSuppression&&this.aecProvider.setRefStream(g)}catch(g){this.notifyError("WasmVqeProccessorError",`setRefStream: Failed to set reference stream for echo cancellation (${g})`)}this.aecRefStream=g}async setEffectAsync(g){this.configProvider.config.wasmvqe.enableVqe&&!this.vqeProvider?await this.configureEffect():!this.configProvider.config.wasmdns.enableNoiseSuppression||this.dnsProvider&&this.aecProvider||await this.configureEffect();const m=this.audioEffectToWasmAudioEffectType[g];if(this.userNoiseSuppressionMode=this.audioEffectTypeToUserNsMode[m],!(this.vqeProvider||this.dnsProvider&&this.aecProvider)){const g=this.vqeProvider?this.dnsProvider?"AEC":"DNS":"VQE";return this.statistics.setError("FailedToInitialize",`setSourceAsync: audio effect provider not initialized (${g}).`),void this.logger.safe.warn(`Unable to configure audio effects: audio effect provider not initialized (${g}).`)}try{this.configProvider.config.wasmvqe.enableVqe?await this.vqeProvider.setEffectAsync(m):this.configProvider.config.wasmdns.enableNoiseSuppression&&(await this.dnsProvider.setEffectAsync(m),await this.aecProvider.setEffectAsync(m)),this.currentEffect=m,this.logger.safe.debug(`The audio effect was set to '${m}'`)}catch(g){throw this.notifyError("WasmVqeProccessorError",`setEffectAsync: Failed to apply '${m}' audio effect, error: ${stringifyObject(g)}`),g}}stop(){try{this.stopped=!0,this.dnsProvider?.dispose(),this.dnsProvider=null,this.aecProvider?.dispose(),this.aecProvider=null,this.vqeProvider?.dispose(),this.vqeProvider=null,this.effectProviderSubs?.forEach((g=>g?.dispose())),this.effectProviderSubs=null,this.logger.safe.debug("The audio effects provider was stopped.")}catch(g){this.logger.safe.error(`Failed to stop the audio effects provider (${g})`)}}dispose(){try{this.hasError=!1,this.stop(),super.dispose(),this.logger.safe.debug("The audio effects provider was disposed.")}catch(g){this.logger.safe.error(`dispose: Failed to dispose the audio effects provider (${g})`)}}async getEffectsCapability(){return this.currentEffectCapability=0,this.configProvider.config.wasmvqe.enableVqe?(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.configProvider.config.wasmvqe.enableAec&&(this.currentEffectCapability|=4,this.currentEffectCapability|=8,this.currentEffectCapability|=16)):this.configProvider.config.wasmdns.enableNoiseSuppression&&(this.currentEffectCapability|=1,this.currentEffectCapability|=2,this.currentEffectCapability|=4),this.currentEffectCapability}getVersion(){return`${`WasmDns ${this.dnsProvider?.getVersion()??"Unknown"}`} / ${`WasmAec ${this.aecProvider?.getVersion()??"Unknown"}`} / ${`WasmVqe ${this.vqeProvider?.getVersion()??"Unknown"}`}`}getStats(){const g=this.configProvider.config.wasmvqe.enableVqe?this.vqeProvider?.getStats():this.dnsProvider?.getStats();return g?(g.userNoiseSuppressionMethod=this.userNoiseSuppressionMode,{timestamp:Date.now(),...this.createTelemetryEvent(g)}):null}async initializeAudioEffectProvider(g){if(!this.wasmVqeProvider&&g===zn.AudioEffectType.VoiceQualityEnhancementDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmVqe package not available."),this.logger.safe.warn("WasmVqe package not available."),null;if(!this.wasmdnsProvider&&g===zn.AudioEffectType.NoiseSuppressionDeep)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmDns package not available."),this.logger.safe.warn("WasmDns package not available."),null;if(!this.wasmaecProvider&&g===zn.AudioEffectType.EchoCancellationClassic)return this.statistics.setError("FailedToInitialize","initializeAudioEffectProvider: WasmAec package not available."),this.logger.safe.warn("WasmAec package not available."),null;let m;this.statistics.startLoadTimer();try{this.configProvider.config.wasmvqe.enableVqe&&g===zn.AudioEffectType.VoiceQualityEnhancementDeep&&(m=await this.wasmVqeProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&g===zn.AudioEffectType.NoiseSuppressionDeep&&(m=await this.wasmdnsProvider.getAudioEffectProvider()),this.configProvider.config.wasmdns.enableNoiseSuppression&&g===zn.AudioEffectType.EchoCancellationClassic&&(m=await this.wasmaecProvider.getAudioEffectProvider())}catch(g){this.logger.safe.warn(`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${g})`),this.statistics.setError("FailedToInitialize",`initializeAudioEffectProvider: Failed to initialize the audio effect provider (${g})`)}return this.statistics.stopLoadTimer(),m?(g===zn.AudioEffectType.VoiceQualityEnhancementDeep&&this.logger.safe.debug(`WasmVqe v${m.getVersion?.()} initialized!`),g===zn.AudioEffectType.NoiseSuppressionDeep&&this.logger.safe.debug(`WasmDns v${m.getVersion?.()} initialized!`),g===zn.AudioEffectType.EchoCancellationClassic&&this.logger.safe.debug(`WasmAec v${m.getVersion?.()} initialized!`),m):(this.logger.safe.warn("Unitialized Wasm audio effect provider."),null)}createTelemetryEvent(g){return{payload:{audioEffectsCapability:this.currentEffectCapability,version:this.getVersion(),...this.statistics.getReport(),...g}}}notifyError(g,m){this.statistics.setError(g,m),this.notifyAboutLastSessionStats()}notifyAboutLastSessionStats(){const g=this.getStats();g&&this.event("onAudioEffectTelemetryEvent").raise(g)}requestStreamUpdate(){this.configProvider.config.enableAudioProcessingFallback&&!this.hasError&&(this.hasError=!0,this.event("onMediaStreamUpdateRequested").raise("Audio"))}};__decorateClass([sequentialize()],Ym.prototype,"setSourceAsync",1),__decorateClass([sequentialize()],Ym.prototype,"setAecRefStream",1),__decorateClass([sequentialize()],Ym.prototype,"setEffectAsync",1),__decorateClass([sequentialize()],Ym.prototype,"stop",1),__decorateClass([sequentialize()],Ym.prototype,"dispose",1);var Qm=class extends Be{constructor(g,m){super(),this.configProvider=g,this.logger=m}isEffectEnabled(g){return"Video"===g&&this.videoEffectManager?.isEffectEnabled}shouldFallbackToNativeProcessing(g){return"Audio"===g&&this.audioEffectManager?.shouldFallbackToNativeProcessing()}addEffectManager(g,m){switch(g){case"Audio":this.addAudioEffectManagerAndSubscribe(m);break;case"Video":this.addVideoEffectManagerAndSubscribe(m)}}async startEffect(g,m){switch(g){case"Audio":return this.logger.safe.info("audioEffectManager is "+(this.audioEffectManager?"defined":"undefined")),this.audioEffectManager?.shouldFallbackToNativeProcessing()?(this.logger.safe.info("No custom audio effect is used. Fallback to native audio processing"),m):this.audioEffectManager.setSourceAsync(m);case"Video":return this.videoEffectManager.setSourceAsync(m);default:return m}}async setEffectType(g,m){switch(g){case"Audio":return this.audioEffectManager?.setEffectAsync(m);case"Video":return this.videoEffectManager?.setEffectAsync(m)}}stopEffect(g,m){switch(g){case"Audio":this.logger.safe.info("stopping audio effect"),this.audioEffectManager?.stop();break;case"Video":this.logger.safe.info("stopping video effect"),this.videoEffectManager?.removeSourceAsync(m)}}resetOutputConstraints(g,m,f){if("Video"===g)this.videoEffectManager?.resetOutputConstraints(m,f)}getStats(g,m){switch(g){case"Audio":return this.audioEffectManager?.getStats();case"Video":return this.videoEffectManager?.getStats(m);default:return}}async configure(g,m){if("Video"===g)return this.videoEffectManager?.configure(m)}async getEffectsCapability(g){switch(g){case"Audio":return this.audioEffectManager?.getEffectsCapability();case"Video":return this.videoEffectManager?.getEffectsCapability();default:return 0}}setAecRefStream(g){return this.audioEffectManager.setAecRefStream(g)}vqeModeToAudioEffectType(g){return this.audioEffectManager.vqeModeToAudioEffectType(g)}nsModeToVqeMode(g,m){return this.audioEffectManager.nsModeToVqeMode(g,m)}dispose(){super.dispose(),this.audioEffectManager?.dispose(),this.audioEffectManager=null,this.videoEffectManager?.dispose(),this.videoEffectManager=null}addAudioEffectManagerAndSubscribe(g){this.audioEffectManager||(this.audioEffectManager=new Ym(g.wasmdnsProvider,g.wasmaecProvider,g.wasmVqeProvider,this.configProvider,this.logger.createChild("AudioEffectManager"),g.createAudioWasmWorkerCbs),this.audioEffectManager.on("onAudioEffectTelemetryEvent",(g=>{this.event("onAudioEffectTelemetryEvent").raise(g)})),this.audioEffectManager.on("onMediaStreamUpdateRequested",(g=>{this.event("onMediaStreamUpdateRequested").raise(g)})))}addVideoEffectManagerAndSubscribe(g){this.videoEffectManager||(this.videoEffectManager=new Jm(g.webcvProvider,this.configProvider,this.logger.createChild("VideoEffectManager"),g.createWasmCVWorker),this.videoEffectManager.on("onMediaStreamUpdateRequested",(g=>{this.event("onMediaStreamUpdateRequested").raise(g)})),this.videoEffectManager.on("onVideoEffectQualityChanged",(g=>{this.event("onVideoEffectQualityChanged").raise(g)})),this.videoEffectManager.on("onVideoStreamQualityChanged",((g,m,f)=>{this.event("onVideoStreamQualityChanged").raise(g,m,f)})),this.videoEffectManager.on("onVideoEffectCapabilitiesChanged",(()=>{this.event("onVideoEffectCapabilitiesChanged").raise()})),this.videoEffectManager.on("onVideoEffectTelementyEvent",(g=>{this.event("onVideoEffectTelementyEvent").raise(g)})),this.videoEffectManager.on("onVideoEffectApplied",(()=>{this.event("onVideoEffectApplied").raise()})),this.videoEffectManager.on("videoFreezeDetected",(g=>{this.event("videoFreezeDetected").raise(g)})))}},Xm=class _DeviceManager extends Be{constructor(g,m,f,S,v,C,_,E,T,I){super(g),this.logger=g,this.configProvider=m,this.diagnostics=f,this.domOverrides=S,this.ufdManager=v,this.id=uniqueId(),this.virtualDeviceRecord=new Map,this.deviceEnumerator=new xm(this.configProvider,this.logger.createChild("DeviceEnumerator")),this.deviceSelection=new Um(xm.list,this.configProvider,this.logger.createChild("DeviceSelection")),this.permissionManager=new $m(this.configProvider,{getMediaStream:g=>this.getMediaStream({...g,withEffect:!1,withTimeout:!0,force:!1,audioProcessingFlags:g.audio&&!g.video?this.getAudioProcessingFlags():void 0},"permissionManager"),hasCamera:()=>this.hasDeviceType("camera"),raiseTelemetryEvent:(g,m)=>this.raiseTelemetryEvent(g,m),getActiveConstraints:()=>this.mediaStreamManager.getActiveConstraints(),handlePermissionStateChange:()=>this.handlePermissionStateChange()},this.logger.createChild("PermissionManager")),this.activeRenderers=[],this.selectedDevices={camera:null,microphone:null,speaker:null,audioIngestDevice:null},this.pendingDevices=null,this.deviceManagerSubscriptions=[],this.streamManagerSubscriptions=[],this.streamSubscriptions=new Map,this.rendererSubscriptions=new Map,this.rawDeviceStreamManager=new Np(this.logger.createChild("RawDeviceStream"),this.raiseTelemetryEvent.bind(this)),this.customDeviceMediaStreamMap=new Map,this.clientAudioRenderers=new Map,this.audioSharingRequested=!1,this.virtualDeviceSubs=new Map,this.effectsManagerInternal=new Qm(this.configProvider,this.logger.createChild("EffectsManager")),this.effectsManagerInternal.addEffectManager("Audio",{wasmdnsProvider:_,wasmaecProvider:E,wasmVqeProvider:T,createAudioWasmWorkerCbs:I?.audioWorklet}),this.effectsManagerInternal.addEffectManager("Video",{webcvProvider:C,createWasmCVWorker:I?.createWasmCVWorker}),this.mediaStreamManager=new Rm(this.logger.createChild("MediaStreamManager"),this.configProvider,this.effectsManager),this.deviceManagerSubscriptions=[this.permissionManager.on("onDevicesPermissionChanged",(()=>this.event("onDevicesPermissionChanged").raise())),xm.list.on("onDevicesChanged",((g,m)=>this.onDevicesChanged(g,m))),this.deviceSelection.on("onSelectedDevicesChanged",((g,m)=>this.onSelectedDevicesChanged(g,m))),this.effectsManager.on("onAudioEffectTelemetryEvent",(g=>{this.diagnostics?.registerAudioEffectsEvent(deepClone(g)),this.event("onAudioEffectsTelemetryEvent").raise(g)})),this.effectsManager.on("onMediaStreamUpdateRequested",(g=>this.onMediaStreamUpdateRequested(g,!0))),this.effectsManager.on("onMediaStreamUpdateRequested",(g=>this.onMediaStreamUpdateRequested(g))),this.effectsManager.on("onVideoEffectQualityChanged",(g=>this.onVideoEffectsQualityEventHandler(g))),this.effectsManager.on("onVideoEffectTelementyEvent",(g=>{this.diagnostics?.registerVideoEffectsEvent(deepClone(g)),this.event("onVideoEffectsTelemetryEvent").raise(g)})),this.effectsManager.on("onVideoEffectApplied",(()=>{this.raiseTelemetryEvent("video_effect_applied",{}),this.event("onVideoEffectApplied").raise()}))],this.subscribeOnStreamManagerEvents(),this.subscribeOnDeviceEnumeratorEvents(),this.deviceList.length&&this.onSelectedDevicesChanged(this.deviceSelection.selectedDevices,!1),this.createChildDeviceManager=g=>new _DeviceManager(g,m,void 0,S,v,C,_,E,T,I)}get deviceList(){return xm.list.devices}get isDeviceEnumeratorInitialized(){return xm.isInitialized}get isAudioOutputSelectionSupported(){return this.configProvider.userAgentConfig.isAudioOutputSelectionSupported}get effectsManager(){return this.effectsManagerInternal}createPreviewRenderer(g){const m=new qp(g,this,this.logger.createChild("videorenderer"),this.configProvider);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(m.getVideoElement()),this.subscribeOnRendererEvents(m),m}async askDevicePermission(g){await this.isDeviceEnumeratorInitialized.promise;const m=await this.permissionManager.askDevicePermission(g);if(this.configProvider.config.devices.enumerateDevicesAfterADP)try{await xm.enumerateDevices()}catch(g){this.logger.safe.warn(`Post-ADP device enumeration failed: ${stringifyObject(g)}`)}return m}getPermissionState(g){return this.permissionManager.getPermissionState(g)}handlePermissionStateChange(){this.diagnostics&&(this.diagnostics.permissionStates=this.permissionManager.knownPermissionStates),this.event("onPermissionStateChanged").raise()}onMediaStreamUpdateRequested(g,m=!1){if("Video"===g&&(this.updateRenderersAsync(),this.effectsManager.isEffectEnabled("Video")))return this.logger.safe.info("onStreamUpdateRequested will be called after the first frame is proccessed of the video effect stream"),void this.effectsManager.once("onVideoEffectApplied",(()=>this.event("onStreamUpdateRequested").raise(g)));this.event("onStreamUpdateRequested").raise(g,m)}createAudioRenderer(){const g=new kp(this.logger.createChild("CustomAudioRenderer"),this.configProvider),m=uniqueId();this.clientAudioRenderers.set(m,g);const f=g.play.bind(g),S=g.stop.bind(g);return this.raiseTelemetryEvent("custom_audio_renderer_created",this.getSelectedDevices()),{play:f,stop:S,dispose:()=>{this.clientAudioRenderers.get(m)?.dispose(),this.clientAudioRenderers.delete(m)},setMuted:(m,f=generateCauseId())=>g.setMuted(m,f),isMuted:()=>g.muted}}setAudioSharingRequested(g){this.audioSharingRequested=g}async createDevicesHandle(g,m,f){const S=g.sharing?"ScreenShare":g.video?"Video":"Audio";return new Vm(this.logger.createChild("DevicesHandle"),await this.getMediaStream({...g,...f&&{deviceId:f},withTimeout:!1,withEffect:!1,audioProcessingFlags:this.audioProcessingFlags,force:!1,withOverridenStream:this.customDeviceMediaStreamMap.get(S)?.active&&this.customDeviceMediaStreamMap.get(S)},m))}shareSystemSound(g){this.configProvider.config.postponeAudioMixerForAudioSharing&&(this.audioSharingRequested=g,this.event("onAudioSharingToggled").raise(g))}getAllowedModalities(){const g=shallowClone(this.permissionManager.browserPermittedModalities);return this.hasDeviceType("microphone")||(g.audio=[je.MEDIA_STATE.inactive,je.MEDIA_STATE.receive]),this.hasDeviceType("camera")||(g.video=[je.MEDIA_STATE.inactive,je.MEDIA_STATE.receive]),g}getRawDeviceMediaStream(g,m){if("ScreenShare"!==g&&!this.hasDeviceType(this.getDeviceType(g)))throw new Error("NoInputDevice");this.audioSharingRequested=m;const f=this.getStreamHandlerByType(g);if(!f)return this.logger.safe.debug(`method not found for ${g}`),null;const S=this.rawDeviceStreamManager.createIRawStreamClient(f,g);return this.raiseTelemetryEvent("IRawStream_client_created",g),S}setRawMediaStream(g,m){if(!g)throw this.logger.error(`Could not set ${g} as to ${m}`),new Error("InvalidStream");this.customDeviceMediaStreamMap.set(m,g),this.onMediaStreamUpdateRequested(m),this.raiseTelemetryEvent("set_raw_outgoing_media_stream",m)}unsetRawMediaStream(g){this.customDeviceMediaStreamMap.get(g)?(this.customDeviceMediaStreamMap.delete(g),this.onMediaStreamUpdateRequested(g),this.raiseTelemetryEvent("unset_raw_outgoing_media_stream",g)):this.logger.safe.debug("no custom stream")}async setVideoEffects(g){return this.effectsManager.setEffectType("Video",g)}async setAudioEffects(g){return this.effectsManager.setEffectType("Audio",g)}getAudioStream(g,m,f=!1){return this.getMediaStream({audio:!0,withTimeout:this.permissionManager.isPermissionKnown("microphone"),withEffect:!1,audioProcessingFlags:this.getAudioProcessingFlags(),force:g,withOverridenStream:!f&&this.customDeviceMediaStreamMap.get("Audio")?.active&&this.customDeviceMediaStreamMap.get("Audio")},m)}getVideoStream(g,m,f=!1){return this.getMediaStream({video:!0,withTimeout:this.permissionManager.isPermissionKnown("camera"),withEffect:!f&&this.configProvider.config.enableVideoEffects&&this.effectsManager.isEffectEnabled("Video"),force:g,withOverridenStream:!f&&this.customDeviceMediaStreamMap.get("Video")?.active&&this.customDeviceMediaStreamMap.get("Video")},m)}getDisplayStream(g,m=!1){const f=!(!this.configProvider.config.enableAudioSharing||!this.audioSharingRequested);return this.getMediaStream({audio:f,sharing:!0,withTimeout:!1,withEffect:!1,audioProcessingFlags:f?0:void 0,force:!1,withOverridenStream:!m&&this.customDeviceMediaStreamMap.get("ScreenShare")?.active&&this.customDeviceMediaStreamMap.get("ScreenShare")},g)}async enumerateDevicesAsync(){return await this.isDeviceEnumeratorInitialized.promise,this.getDeviceDescriptions(this.deviceList)}async getDeviceNameAsync(g){await this.isDeviceEnumeratorInitialized.promise;const m=this.deviceList.find((m=>m.guid===g));return m?.label??""}async getSpeakerDeviceDomIdAsync(g){await this.isDeviceEnumeratorInitialized.promise;const m=this.deviceList.find((m=>m.guid===g));return m?.deviceId??""}selectDevices(g){return this.pendingDevices?(this.logger.safe.info(`Overriding device selection until enumeration is complete with ${JSON.stringify(scrubSelectedDevices(this.pendingDevices))}`),void(this.pendingDevices=g)):this.isDeviceEnumeratorInitialized.isPending?(this.logger.safe.info("Postponing device selection until enumeration is complete"),this.pendingDevices=g,void this.isDeviceEnumeratorInitialized.promise.then((()=>{this.logger.safe.info("Performing postponed device selection");const g=this.pendingDevices;this.pendingDevices=null,this.selectDevices(g)}))):void this.deviceSelection.selectDevices(g)}getSelectedDevices(){return this.toSelectedDevices(this.deviceSelection.selectedDevices)}setAudioProcessingFlags(g){g!==this.audioProcessingFlags&&(this.logger.debug(`Setting audio processing flags: ${this.audioProcessingFlags} -> ${g}`),this.audioProcessingFlags=g,this.event("onStreamUpdateRequested").raise("Audio"))}getOutputDeviceId(){return this.selectedDevices.speaker?.deviceId}getDeviceDescriptions(g){return(g||this.deviceList).map((g=>g.toDeviceDesc()))}getDevicesCount(){return this.deviceList.reduce(((g,m)=>(g[m.type]++,g)),{camera:0,speaker:0,microphone:0,compositeAudio:0,virtualDevice:0,audioIngestDevice:0})}async getKnownPermissionStates(){return await this.permissionManager.initialize(),this.permissionManager.knownPermissionStates}getLocalVideoRenderers(){return this.activeRenderers}dispose(){this.deviceManagerSubscriptions?.forEach((g=>g.dispose())),this.deviceManagerSubscriptions=null,this.virtualDeviceSubs?.forEach((g=>g.forEach((g=>g.dispose())))),this.virtualDeviceSubs?.clear(),this.virtualDeviceSubs=null,this.virtualDeviceRecord?.forEach((g=>g.dispose())),this.virtualDeviceRecord=null,this.unsubscribeFromStreamManagerEvents(),this.deviceEnumerator.dispose(),this.mediaStreamManager.dispose(),this.activeVideoEffectSub?.dispose(),this.activeVideoStreamForEffect?.dispose(),this.disposeRawStreamAccess(),this.disposeClientAudioRenderer(),this.effectsManager.dispose(),super.dispose()}async registerVirtualDevice(g,m){const f=g.length?g.map((({id:g},m)=>{const f=this.createChildDeviceManager(this.logger.createChild(`VirtualDevice-${m}`));return f.selectDevices({camera:g}),f})):[this.createChildDeviceManager(this.logger.createChild("VirtualDevice"))],S=new Gm(f,m),v=S.id,C=[S.on("onVideoEffectApplied",((...g)=>this.event("onVideoEffectApplied").raise(...g))),S.on("onVideoEffectsEvent",((...g)=>this.event("onVideoEffectsEvent").raise(...g))),S.on("onDeviceTelemetryEvent",((...g)=>this.event("onDeviceTelemetryEvent").raise(...g))),S.on("onVideoEffectsTelemetryEvent",((...g)=>this.event("onVideoEffectsTelemetryEvent").raise(...g))),S.on("onDevicesPermissionChanged",((...g)=>this.event("onDevicesPermissionChanged").raise(...g))),S.on("onStreamUpdateRequested",((...g)=>this.event("onStreamUpdateRequested").raise(...g)))];return this.virtualDeviceSubs.set(v,C),this.virtualDeviceRecord.set(v,S),xm.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.raiseTelemetryEvent("register_virtual_device",{deviceCount:f.length,id:v}),this.event("onVirtualDevicesChanged").raise(),v}async unregisterVirtualDevice(g){this.virtualDeviceRecord.has(g)?(this.virtualDeviceSubs.get(g).forEach((g=>g.dispose())),this.virtualDeviceSubs.delete(g),this.virtualDeviceRecord.get(g).dispose(),this.virtualDeviceRecord.delete(g),xm.list.updateVirtualDeviceList(this.getRegisteredDevices()),this.event("onVirtualDevicesChanged").raise(),this.raiseTelemetryEvent("unregister_virtual_device",{id:g})):this.logger.error(`No virtual device found with id ${g}`)}getRegisteredDevices(){return Array.from(this.virtualDeviceRecord.values())}getAudioProcessingFlags(){if(!this.effectsManager.shouldFallbackToNativeProcessing("Audio"))return this.audioProcessingFlags??this.configProvider.config.defaultAudioProcessingFlags}disposeClientAudioRenderer(){this.clientAudioRenderers.size&&(this.clientAudioRenderers.forEach((g=>{g.dispose()})),this.clientAudioRenderers.clear(),this.raiseTelemetryEvent("custom_audio_renderer_disposed",this.getSelectedDevices()))}disposeRawStreamAccess(){this.rawDeviceStreamManager.disposeAll(),this.rawDeviceStreamManager=null}toSelectedDevices(g){return Object.entries(g).reduce(((g,[m,f])=>(f&&(g[m]=f.guid),g)),{})}getStreamConstraints(g){return{deviceId:g?.deviceId||void 0}}hasDeviceType(g){return values(this.deviceList).some((m=>m.type===g))}getConstraints(g){if(!g.audio&&!g.video&&!g.sharing)throw new Error("requesting nothing");if(this.logger.safe.info(`retrieving media stream: ${JSON.stringify(g)}`),g.sharing){let m;const f=this.selectedDevices.audioIngestDevice;return m=f&&g.deviceId?{deviceId:f.deviceId}:g.audio&&!g.deviceId?{deviceId:je.SYSTEM_AUDIO_SOURCE_ID}:void 0,{audio:m,sharing:{deviceId:g.deviceId||je.DISPLAY_SOURCE_ID},withTimeout:g.withTimeout,withEffect:!1,audioProcessingFlags:g.audioProcessingFlags,force:!1,withOverridenStream:g.withOverridenStream}}const m=this.selectedDevices.microphone,f=this.selectedDevices.camera,S=g.audio&&m,v=g.video&&f;if(!S&&!v){throw{type:je.MEDIA_ERROR.noDeviceSelected,detail:`audio requested ${g.audio}, video requested: ${g.video} Devices: ${JSON.stringify(this.deviceList.map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords)))))}`}}const C=this.getStreamConstraints(m),_=this.getStreamConstraints(f);let E=g.audioProcessingFlags;return void 0!==E&&g.audio&&!g.video&&m?.capabilities&&(m.capabilities.echoCancellation&&!m.capabilities.echoCancellation.includes(!!(2&E))&&(E^=2),m.capabilities.autoGainControl&&!m.capabilities.autoGainControl.includes(!!(1&E))&&(E^=1),m.capabilities.noiseSuppression&&!m.capabilities.noiseSuppression.includes(!!(4&E))&&(E^=4)),E!==g.audioProcessingFlags&&this.logger.safe.warn(`Unable to fulfill processing flags ${g.audioProcessingFlags}, using ${E} instead`),{audio:g.audio?C:void 0,video:g.video?_:void 0,withTimeout:g.withTimeout,withEffect:g.withEffect,audioProcessingFlags:E,force:g.force,withOverridenStream:g.withOverridenStream}}async getMediaStream(g,m){const f=this.configProvider.config.devices.enumerateBeforeGettingStream;f&&("always"!==f&&xm.isPolling||await xm.enumerateDevices());const S=this.getConstraints(g),v=this.mediaStreamManager.getMediaStream(S,m);this.subscribeOnStreamEvents(v);try{await v.start();const m=v.hasAudio(),f=v.hasVideo();m&&this.signalDeviceGood("Audio",v.rawTrack.muted),f&&this.signalDeviceGood(v.mediaType,v.rawTrack.muted),this.permissionManager.update(g,g)}catch(m){this.handleUserMediaError(g,m)}return v}signalDeviceGood(g,m){this.ufdManager.signalDeviceEvent(0,"Good",g,this.id),this.ufdManager.signalDeviceEvent(1,"Good",g,this.id),this.ufdManager.signalDeviceEvent(3,"Good",g,this.id),m||"Audio"!==g&&!this.configProvider.config.raiseVideoMuteUfd||this.ufdManager.signalDeviceEvent(2,"Good",g,this.id)}handleUserMediaError(g,m){const f=this.getMediaType(g),S=g.audio&&g.video,signalUFD=(g,m)=>{!S&&this.ufdManager.signalDeviceEvent(g,m,f,this.id)};switch(m.type){case je.MEDIA_ERROR.permissionDeniedError:"ScreenShare"!==f&&(signalUFD(3,"Bad"),this.configProvider.config.permissions.persistOnDeniedError&&this.refreshPermissions(g));break;case je.MEDIA_ERROR.permissionDeniedBySystemError:signalUFD(3,"Bad");break;case je.MEDIA_ERROR.sourceUnavailableError:signalUFD(0,"Bad");break;case je.MEDIA_ERROR.mediaStreamRequestTimedOut:signalUFD(1,"Bad");break;default:this.logger.safe.error(`getMediaStream() error: ${stringifyObject(m)}`),signalUFD(0,"Bad")}}refreshPermissions(g){const m=g.audio&&!g.video,f=!g.audio&&g.video;m?this.permissionManager.update({audio:!0},{audio:!1}):f&&this.permissionManager.update({video:!0},{video:!1})}getMediaType(g){if(g.sharing)return"ScreenShare";if(g.video)return"Video";if(g.audio)return"Audio";throw new Error(`mediaType is not defined for this constraint ${JSON.stringify(g)}`)}subscribeOnStreamEvents(g){const m=[];m.push(g.on("onStreamClientStarted",((g,m)=>this.onStreamStarted(g,m)))),m.push(g.on("onStreamClientDisposing",(g=>this.onStreamDisposing(g)))),m.push(g.on("onStreamClientEnded",((g,m)=>this.onStreamEnded(g,m)))),m.push(g.on("onStreamClientMuted",((g,m)=>this.onStreamMuted(g,m)))),m.push(g.on("onStreamClientError",((g,m)=>this.onStreamError(g,m)))),this.configProvider.config.useRawMediaApiForVideoEffects&&m.push(g.on("onStreamClientDisposed",(g=>this.removeVideoEffectStream(g)))),this.streamSubscriptions.set(g,m)}async removeVideoEffectStream(g){if(g.getCurrentConstraints().withEffect){this.logger.safe.info(`this.activeVideoEffectSub: ${this.activeVideoEffectSub} to be disposed`),this.activeVideoEffectSub?.dispose();const g=await(this.activeVideoStreamForEffect?.getMediaStream());this.effectsManager.stopEffect("Video",g)}}unsubscribeFromStreamEvents(g){this.streamSubscriptions.has(g)&&(this.streamSubscriptions.get(g).forEach((g=>g.dispose())),this.streamSubscriptions.delete(g))}subscribeOnRendererEvents(g){const m=[];m.push(g.on("onRendererDisposed",(g=>this.onRendererDisposed(g)))),m.push(g.on("onRendererStarted",(g=>this.onRendererStarted(g)))),m.push(g.on("onRendererSizeChanged",((g,m)=>this.onRendererSizeChanged()))),this.rendererSubscriptions.set(g,m)}unsubscribeFromRendererEvents(g){this.rendererSubscriptions.has(g)&&(this.rendererSubscriptions.get(g).forEach((g=>g.dispose())),this.rendererSubscriptions.delete(g))}subscribeOnStreamManagerEvents(){this.streamManagerSubscriptions=[],this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onAllStreamsRemoved",(()=>this.onAllStreamsRemoved()))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamAcquired",((g,m,f,S,v,C)=>this.onStreamAcquired(g,m,f,S,v,C)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamCreated",((g,m)=>this.onStreamCreated(g,m)))),this.streamManagerSubscriptions.push(this.mediaStreamManager.on("onStreamDisposing",((g,m)=>this.onMasterStreamDisposing(g,m))))}subscribeOnDeviceEnumeratorEvents(){this.deviceEnumerator.on("onDeviceEnumerationfailed",(g=>this.raiseTelemetryEvent("enumeration_failed",{error:g})))}unsubscribeFromStreamManagerEvents(){this.streamManagerSubscriptions.forEach((g=>g.dispose()))}async updateRenderersAsync(){try{await Promise.all(this.activeRenderers.map((g=>g.updateStreamAsync()))),this.logger.safe.info("Renderers updates finished")}catch(g){this.logger.safe.error(`Error updating renderers: ${stringifyObject(g)}`)}}onSelectedDevicesChanged(g,m){const f=this.selectedDevices;this.selectedDevices=g,this.diagnostics?.setSelectedDevices(g,m);if(!("camera"in f^"camera"in this.selectedDevices||"microphone"in f^"microphone"in this.selectedDevices)){const g=this.toSelectedDevices(this.selectedDevices),m=this.toSelectedDevices(f);this.event("onSelectedDevicesChanged").raise(g,m),g.microphone!==m.microphone&&this.rawDeviceStreamManager.notifyChange("Audio"),g.camera!==m.camera&&this.rawDeviceStreamManager.notifyChange("Video"),this.clientAudioRenderers.forEach((g=>{g.setOutputDevice(this.getOutputDeviceId())}))}const S=this.configProvider.config.devices.piiSafeWords;this.raiseTelemetryEvent("selected_devices_changed",{microphone:this.selectedDevices.microphone&&scrubDeviceLabelPii(this.selectedDevices.microphone.label,S),camera:this.selectedDevices.camera&&scrubDeviceLabelPii(this.selectedDevices.camera.label,S),speaker:this.selectedDevices.speaker&&scrubDeviceLabelPii(this.selectedDevices.speaker.label,S),fromInterface:m}),this.updateRenderersAsync()}onDevicesChanged(g,m){this.event("onDevicesChanged").raise(g,m),this.mediaStreamManager.onDevicesChanged(g),this.diagnostics?.setDeviceList(g,m,this.getDeviceListDebugInfo());const f=this.getDevicesCount();this.ufdManager.signalEvent("ZeroCaptureDevicesEnumerated",f.microphone>0?"Good":"Bad"),this.isAudioOutputSelectionSupported&&this.ufdManager.signalEvent("ZeroRenderDevicesEnumerated",f.speaker>0?"Good":"Bad");const S=new Map;let v=1;this.raiseTelemetryEvent("devices_changed",{devices:g.map((g=>{const m=S.get(g.groupId)||v++;return S.set(g.groupId,m),{label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),isSystemDefault:g.isSystemDefault,kind:g.kind,type:g.type,capabilities:g.capabilities,groupId:`${m}`}})),debug:this.getDeviceListDebugInfo()})}getDeviceListDebugInfo(){return xm.list.debugInfo}raiseTelemetryEvent(g,m){this.logger.safe.info(`Device event: ${g}: ${JSON.stringify(this.scrubPayload(g,m))}`);const f={eventType:g,timestamp:Date.now(),payload:m};this.diagnostics?.registerDeviceTelemetryEvent(deepClone(f)),this.event("onDeviceTelemetryEvent").raise(f)}scrubPayload(g,m){if("devices_changed"===g){return{devices:values(m.devices).map((g=>scrubDevices(g,this.configProvider.config.devices.piiSafeWords))),debug:m.debug}}return m}async onStreamStarted(g,m){if(this.permissionManager.browserPermittedModalities.audio.some((g=>g===je.MEDIA_STATE.send))||this.permissionManager.browserPermittedModalities.video.some((g=>g===je.MEDIA_STATE.send)))try{await xm.enumerateDevices()}catch(g){this.logger.safe.warn(`onStreamStarted device enumeration failed: ${stringifyObject(g)}`)}if(g.rawTrack){switch(g.mediaType){case"Audio":this.deviceEnumerator.startDevicePolling(),this.updateActiveMicrophone(g,m);break;case"Video":this.deviceEnumerator.startDevicePolling()}this.configProvider.config.useRawMediaApiForVideoEffects&&g.getCurrentConstraints().withEffect&&(this.activeVideoEffectSub=this.effectsManager.on("onVideoStreamQualityChanged",((m,f,S)=>g.onVideoStreamQualityChanged(m,f,S))))}else this.logger.safe.warn(`stream:${g.id} is already disposed`)}updateActiveMicrophone(g,m){if(g.deviceId){const f=this.deviceList.find((m=>m.deviceId===g.deviceId));if(!f&&"default"!==g.deviceId)return void this.logger.safe.error("Active device not found",`Device id from track: '${scrubMriOrOmit(g.deviceId)}', known devices: [${this.deviceList.map((g=>JSON.stringify(scrubDevices(g,this.configProvider.config.devices.piiSafeWords))))}]}`,JSON.stringify(scrubConstraints(m)));f&&"default"!==g.deviceId&&m.audio&&m.audio.deviceId===je.MEDIA_DEVICE.defaultId&&xm.list.updateActiveMicrophone(f)}}onStreamDisposing(g){this.unsubscribeFromStreamEvents(g)}onStreamMuted(g,m){("Audio"===g.mediaType||this.configProvider.config.raiseVideoMuteUfd)&&this.ufdManager.signalDeviceEvent(2,m?"Bad":"Good",g.mediaType,this.id),this.raiseTelemetryEvent(m?"stream_muted":"stream_unmuted",g.mediaType)}onStreamEnded(g,m){m.error?(this.raiseTelemetryEvent("stream_ended_error",{mediaType:g.mediaType,error:{type:m.error.name,detail:m.error.message}}),"SourceUnavailableError"===m.error.name&&this.ufdManager.signalDeviceEvent(0,"Bad","Audio",this.id)):("Audio"!==g.mediaType&&"Video"!==g.mediaType||this.ufdManager.signalDeviceEvent(0,"Bad",g.mediaType,this.id),this.raiseTelemetryEvent("stream_ended",g.mediaType))}onStreamError(g,m){this.raiseTelemetryEvent("stream_error",{mediaType:g.mediaType,error:m})}onAllStreamsRemoved(){this.deviceEnumerator.stopDevicePolling(),this.audioSharingRequested=!1}onStreamAcquired(g,m,f,S,v,C){0!==f&&this.raiseTelemetryEvent("stream_acquired",{id:g,mediaType:m,timestamp:f,resolution:S,withAudio:v,source:C})}onStreamCreated(g,m){this.raiseTelemetryEvent("stream_created",{id:g,mediaType:m})}onMasterStreamDisposing(g,m){this.raiseTelemetryEvent("stream_disposed",{id:g,mediaType:m})}onRendererDisposed(g){remove2(this.activeRenderers,(m=>m===g)),this.domOverrides.onMediaElementRemoved?.(g.getVideoElement()),this.unsubscribeFromRendererEvents(g)}onRendererStarted(g){this.activeRenderers.push(g),this.event("onLocalRendererStarted").raise(g)}getLargestRendererResolution(){const g=this.activeRenderers.map((g=>g.getResolution()));return g?.length>0?g.reduce(((g,m)=>m.height>g.height?m:g)):{width:0,height:0}}onVideoEffectsQualityEventHandler(g){const m=this.deviceSelection.selectedDevices.camera;if(m?.deviceId){const f={type:"onVideoEffectQualityChanged",payload:{message:g.message,effectType:g.effectType}};this.event("onVideoEffectsEvent").raise(m.deviceId,f)}}onRendererSizeChanged(){const g=this.getLargestRendererResolution();this.effectsManager.resetOutputConstraints("Video",g,qn.EffectQualityChangeReason.RendererSize)}getDeviceType(g){if("Video"===g)return"camera";if("Audio"===g)return"microphone";throw new Error(`DeviceType for mediaType: ${g} doesn't exist`)}getStreamHandlerByType(g){return"Video"===g?()=>this.getVideoStream(!1,"rawStream",!0):"Audio"===g?()=>this.getAudioStream(!1,"rawStream",!0):"ScreenShare"===g?()=>this.getDisplayStream("rawStream",!0):null}},Zm=class{constructor(g){this.configProvider=g,this.data={deviceList:[],deviceSelectionChangeCount:0,deviceSelectionChangeCountFromInterface:0,permissionStates:{microphone:"unknown",camera:"unknown"},devicesCount:{microphone:0,camera:0,speaker:0,compositeAudio:0,audioIngestDevice:0,virtualDevice:0},devicesChangeCount:0,devicesPollChangeCount:0,deviceTelemetryEvents:[],videoEffectsEvents:[],audioEffectsEvents:[]},Object.defineProperty(this.data,"rawUsedDevices",{get:()=>this.rawUsedDevices,configurable:!1,enumerable:!1})}set permissionStates(g){this.data.permissionStates=g}setSelectedDevices(g,m){const f={microphone:scrubDeviceLabelPii(g.microphone?.label,this.configProvider.config.devices.piiSafeWords),camera:scrubDeviceLabelPii(g.camera?.label,this.configProvider.config.devices.piiSafeWords),speaker:scrubDeviceLabelPii(g.speaker?.label,this.configProvider.config.devices.piiSafeWords)};this.rawUsedDevices={microphone:g.microphone?.label,camera:g.camera?.label,speaker:g.speaker?.label},this.data.usedDevices&&(this.data.deviceSelectionChangeCount++,m&&this.data.deviceSelectionChangeCountFromInterface++),this.data.usedDevices=f}setDeviceList(g,m,f){this.data.deviceList=g.map((g=>({label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),kind:g.type}))),f&&(this.data.deviceDebugStrings=deepClone(f)),this.data.devicesCount.microphone=g.filter((g=>"microphone"===g.type)).length,this.data.devicesCount.camera=g.filter((g=>"camera"===g.type)).length,this.data.devicesCount.speaker=g.filter((g=>"speaker"===g.type)).length,this.data.devicesCount.compositeAudio=g.filter((g=>"compositeAudio"===g.type)).length,this.data.devicesChangeCount++,m&&this.data.devicesPollChangeCount++}registerDeviceTelemetryEvent(g){if("stream_acquired"===g.eventType){const m=g.payload;"Video"===m.mediaType&&(this.data.latestCameraOpenResolution=m.resolution)}arrayLimitedPush(this.data.deviceTelemetryEvents,g,this.configProvider.config.diagnostics.collectionLimits.numDeviceEvents)}registerVideoEffectsEvent(g){arrayLimitedPush(this.data.videoEffectsEvents,g,this.configProvider.config.diagnostics.collectionLimits.numVideoEffectsEvents)}registerAudioEffectsEvent(g){arrayLimitedPush(this.data.audioEffectsEvents,g,this.configProvider.config.diagnostics.collectionLimits.numAudioEffectsEvents)}getObjectRef(){return this.data}},ef=class{constructor(){this.data={clientDSH:void 0,signalingDSH:void 0,serverDSH:void 0,activeStrategy:void 0,lastMsgOrigin:void 0}}setCurrentActiveStrategy(g){this.data.activeStrategy=g}resetState(){return this.data.lastMsgOrigin=void 0,this}recordHistoryEvent(g,m){var f,S;(f=this.data)[S=m+"DSH"]??(f[S]={count:0,duplicateCount:0}),this.data.lastMsgOrigin=m;const v=this.data[m+"DSH"];v.count++,v.firstMsgTime??(v.firstMsgTime=Date.now()),deepEqual(this.data.lastHistory,g)&&v.duplicateCount++,this.data.lastHistory=g,this.data.lastMsgDate=Date.now()}getObjectRef(){return this.data}},tf=class{constructor(g,m){this.configProvider=g,this.addStatsError=m,this.data={video:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},sharing:{events:[],counters:{attempted:0,subscribed:0,unsubscribed:0,failed:0}},subscribedTrackIds:[]}}set subscribedTrackIds(g){this.data.subscribedTrackIds=g}addSubscribe(g,m,f){const S=this.getModalityData(g);if(S){const g={evt:1,msi:m,localMsi:f,ts:Date.now()};arrayLimitedPush(S.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),S.counters.attempted++}}addSubscribed(g,m,f,S){const v=this.getModalityData(g);if(v){const g={evt:2,msi:m,localMsi:f,ts:Date.now(),duration:S};arrayLimitedPush(v.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),v.counters.subscribed++}}addUnsubscribe(g,m,f){const S=this.getModalityData(g);if(S){const g={evt:3,msi:m,localMsi:f,ts:Date.now()};arrayLimitedPush(S.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),S.counters.unsubscribed++}}addFailed(g,m,f,S){const v=this.getModalityData(g);if(v){const g={evt:-1,msi:m,localMsi:f,ts:Date.now(),error:S};arrayLimitedPush(v.events,g,this.configProvider.config.diagnostics.collectionLimits.numSubscriptionEvents),v.counters.failed++}}getObjectRef(){return this.data}getModalityData(g){switch(g){case je.MEDIA_TYPE.video:return this.data.video;case je.MEDIA_TYPE.sharing:return this.data.sharing;default:return void this.addStatsError(`Unsupported modality ${g}`)}}},nf=class{constructor(g,m){this.configProvider=g,this.addStatsError=m,this.data={videoMaxCapabilitiesEvents:[],videoMaxCapabilitiesErrors:[],sharingMaxCapabilitiesEvents:[],sharingMaxCapabilitiesErrors:[],currentVideoSsrcRequestedCapabilities:{},currentVideoSsrcAppliedCapabilities:{},currentSharingSsrcRequestedCapabilities:{},currentSharingSsrcAppliedCapabilities:{},numVideoControlMessages:0,numOutOfOrderVideoControlMessages:0,numWebcamFreezeIntervals:0,numProcessedStreamFreezeIntervals:0}}onMaxCapabilitiesRequested(g){const m={causeId:g.causeId,events:[{eventType:"req",timestamp:Date.now(),capabilities:g.capabilities,isSimulcast:g.isSimulcastEnabled}]};try{if(g.modality===je.MODALITY.video){arrayLimitedPush(this.data.videoMaxCapabilitiesEvents,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const m of g.capabilities)this.data.currentVideoSsrcRequestedCapabilities[`${m.ssrc??0}`]=m}else if(g.modality===je.MODALITY.sharing){arrayLimitedPush(this.data.sharingMaxCapabilitiesEvents,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesRequested);for(const m of g.capabilities)this.data.currentSharingSsrcRequestedCapabilities[`${m.ssrc??0}`]=m}}catch(g){this.addStatsError?.("onMaxCapabilitiesRequested",stringifyObject(g))}}onMaxCapabilitiesApplied(g){try{const m=this.getEventForCause(g.modality,g.causeId),f={eventType:"app",timestamp:Date.now(),capabilities:g.capabilities,error:`${g.error}`||"none"};if(m&&(arrayLimitedPush(m.events,f,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1),g.error&&(g.modality===je.MODALITY.video?arrayLimitedPush(this.data.videoMaxCapabilitiesErrors,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1):g.modality===je.MODALITY.sharing&&arrayLimitedPush(this.data.sharingMaxCapabilitiesErrors,m,this.configProvider.config.diagnostics.collectionLimits.numCapabilitiesApplied,1))),g.modality===je.MODALITY.video)for(const m of g.capabilities)this.data.currentVideoSsrcAppliedCapabilities[`${m.ssrc??0}`]=m;else if(g.modality===je.MODALITY.sharing)for(const m of g.capabilities)this.data.currentSharingSsrcAppliedCapabilities[`${m.ssrc??0}`]=m}catch(g){this.addStatsError?.("onMaxCapabilitiesApplied",stringifyObject(g))}}addVideoControlMessage(g=!1){this.data.numVideoControlMessages++,g&&this.data.numOutOfOrderVideoControlMessages++}getObjectRef(){return this.data}registerWebcamFreeze(){this.data.numWebcamFreezeIntervals++}registerProcessedStreamFreeze(){this.data.numProcessedStreamFreezeIntervals++}getEventForCause(g,m){return(g===je.MODALITY.video?this.data.videoMaxCapabilitiesEvents:this.data.sharingMaxCapabilitiesEvents).find((g=>g.causeId===m))}},rf=class{constructor(g){this.configProvider=g,this.data={renderers:[],firstTimeToFirstFrameVideo:-1,firstTimeToFirstFrameSharing:-1,timeToFirstFrameSinceSubscriptionStartVideo:-1,timeToFirstFrameSinceSubscriptionStartSharing:-1,isRenderingEvents:{video:[],sharing:[]},preferredResolution:{video:void 0,sharing:void 0}}}setTimeToFirstFrame(g,m){-1!==g&&(m===je.MODALITY.video&&-1===this.data.firstTimeToFirstFrameVideo?this.data.firstTimeToFirstFrameVideo=g:m===je.MODALITY.sharing&&-1===this.data.firstTimeToFirstFrameSharing&&(this.data.firstTimeToFirstFrameSharing=g))}setTimeToFirstFrameSinceSubscriptionStart(g,m){-1!==g&&(m===je.MODALITY.video&&-1===this.data.timeToFirstFrameSinceSubscriptionStartVideo?this.data.timeToFirstFrameSinceSubscriptionStartVideo=g:m===je.MODALITY.sharing&&-1===this.data.timeToFirstFrameSinceSubscriptionStartSharing&&(this.data.timeToFirstFrameSinceSubscriptionStartSharing=g))}setIsRendering(g,m){this.data.isRenderingEvents[m]&&arrayLimitedPush(this.data.isRenderingEvents[m],{isRendering:g,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents)}setPreferredResolution(g,m){(g.width||g.height)&&(this.data.preferredResolution[m]=g)}newRendererDiagnostics(){const g=new sf(this,this.configProvider),m=g.on("onDisposed",(()=>{this.removeDeadRenderers(),m.dispose()}));return this.data.renderers.push(g.getObjectRef()),g}getObjectRef(){return this.data}removeDeadRenderers(){this.data.renderers=this.data.renderers.filter((g=>g.alive))}},sf=class extends Be{constructor(g,m){super(),this.managerDiagnostics=g,this.configProvider=m,this.isAlive=!0,this.data={alive:!0,totalFreezeDuration:0,isRendering:!1,timeToFirstFrame:-1,timeToFirstFrameSinceSubscriptionStart:-1,rendererStates:[]},delete this.data.alive,Object.defineProperty(this.data,"alive",{get:()=>this.isAlive,enumerable:!1,configurable:!1})}set trackId(g){this.data.trackId=g}set rendererSize(g){this.data.rendererSize=g,g.toString=()=>`${g.width}x${g.height}`,this.managerDiagnostics.setPreferredResolution(g,this.data.modality)}set msi(g){this.data.msi=g}set modality(g){this.data.modality=g}set isRendering(g){this.data.isRendering=g,this.managerDiagnostics.setIsRendering(g,this.data.modality)}set timeToFirstFrame(g){this.data.timeToFirstFrame=g,this.managerDiagnostics.setTimeToFirstFrame(g,this.data.modality)}set timeToFirstFrameSinceSubscriptionStart(g){this.data.timeToFirstFrameSinceSubscriptionStart=g,this.managerDiagnostics.setTimeToFirstFrameSinceSubscriptionStart(g,this.data.modality)}addFreezeDuration(g){this.data.totalFreezeDuration+=g}addStateChange(g){arrayLimitedPush(this.data.rendererStates,g,this.configProvider.config.diagnostics.telemetryLimits.numRendererStateChangedEvents)}dispose(){this.isAlive=!1,this.event("onDisposed").raise()}getObjectRef(){return this.data}},af=R,of=__toESM(Te()),lf=R;function fmtParamsToString(g){let m="";return forOwn(g,((g,f)=>{m+=(m?";":"")+f,void 0!==g&&(m+=`=${g}`)})),m}var cf=class{constructor(g){this.parameters={},g&&g.split(";").forEach((g=>{const m=g.split("=");this.parameters[m[0]]=m[1]}))}setIfMissing(g,m){this.contains(g)||(this.parameters[g]=m)}removeIfPresent(g){this.contains(g)&&delete this.parameters[g]}get(g){return this.parameters[g]}names(){return Object.keys(this.parameters)}contains(g){return this.parameters.hasOwnProperty(g)}toString(){return fmtParamsToString(this.parameters)}};function updatePayload(g,m,f){if(!g.rtp)return;const S=g.rtp.filter((g=>g.payload===m))[0];S&&forOneCodec(g,{codec:S.codec,rate:S.rate,payload:S.payload,encoding:S.encoding},(g=>(g.rtp.payload=f,g)))}function findAvailablePayload(g){const m=new Set;for(const f of g.media)for(const g of f.rtp??[])m.add(g.payload);const f=[96,127];for(let g=f[0];g<=f[1];g++)if(!m.has(g))return g;const S=[35,64];for(let g=S[0];g<=S[1];g++)if(!m.has(g))return g;return-1}function findAllAvailablePayloads(g,m){const f=new Set,S=[];for(const m of g.media)for(const g of m.rtp??[])f.add(g.payload);for(let g=m[0];g<=m[1];g++)f.has(g)||S.push(g);return S}function forOneCodec(g,m,f){forCodec(g,m,!0,f)}function forAllCodecs(g,m,f){forCodec(g,m,!1,f)}function forCodec(g,m,f,S){if(g.rtp){for(let v=0;v<g.rtp.length;v++){const C=g.rtp[v],_=C.payload;if(m.codec.toLowerCase()!==C.codec.toLowerCase()||m.rate!==C.rate||m.encoding!==C.encoding||m.payload&&m.payload!==C.payload)continue;const E={rtp:C};g.fmtp||(g.fmtp=[]);const T=g.fmtp.find((g=>C.payload===g.payload));E.fmtp=T,g.rtcpFb||(g.rtcpFb=[]),E.rtcpFb=g.rtcpFb.filter((g=>g.payload===C.payload));const I=E.rtcpFb.length>0;if(null===S(E))g.payloads=g.payloads.toString().split(" ").filter((g=>C.payload!==+g)).join(" "),g.fmtp=g.fmtp.filter((g=>C.payload!==g.payload)),g.rtcpFb=g.rtcpFb.filter((g=>C.payload!==g.payload)),g.rtp[v]=null;else{if(E.rtp.payload!==_){const m=E.rtp.payload;g.payloads=g.payloads.toString().split(" ").map((g=>+g===_?m:+g)).join(" "),E.fmtp&&(E.fmtp.payload=m),E.rtcpFb&&E.rtcpFb.forEach((g=>g.payload=m)),g.fmtp.filter((g=>g.config&&g.config.indexOf(`apt=${_}`)>-1)).forEach((g=>g.config=g.config.replace(`apt=${_}`,`apt=${m}`)))}!T&&E.fmtp&&g.fmtp.push(E.fmtp),!I&&E.rtcpFb&&E.rtcpFb.forEach((m=>g.rtcpFb.push(m)))}if(f)break}g.rtp=g.rtp.filter((g=>!!g))}}function removeCodec(g,m){if(!g.rtp)return;let f=-1;if(g.rtp.forEach((function(g,S){m.codec.toLowerCase()!==g.codec.toLowerCase()||m.rate!==g.rate||m.encoding!==g.encoding||m.payload&&m.payload!==g.payload||(f=S)})),f>=0&&g.rtp.length>1){const m=g.rtp[f].payload;g.rtp.splice(f,1),g.payloads=g.payloads.split(" ").filter((g=>m!==+g)).join(" "),g.fmtp=g.fmtp?.filter((g=>m!==g.payload))}}function addCodec(g,m){g.rtp.unshift({payload:m.payload,codec:m.codec,rate:m.rate,encoding:m.encoding}),g.payloads=`${m.payload} ${g.payloads}`}function isCodecsMatch(g,m,f){if(!(0,lf.isUndefined)(g.rate)&&g.rate!==m.rate)return!1;if(!(0,lf.isUndefined)(g.codec)&&g.codec.toLowerCase()!==m.codec.toLowerCase())return!1;if(!(0,lf.isUndefined)(g.encoding)){if(!(0,lf.isUndefined)(m.encoding)&&g.encoding!==m.encoding)return!1;if((0,lf.isUndefined)(m.encoding)&&1!==g.encoding)return!1}if(!(0,lf.isUndefined)(g.fmtpLine)){return!!(f&&f.find((f=>f.payload===m.payload&&-1!==f.config.toLowerCase().indexOf(g.fmtpLine.toLowerCase()))))}return!0}function isPayloadMatch(g,m){return m===g||"*"===m}function filterCodecs(g,m,f,S){if(!g.rtp?.length)return;let v=g.rtp.filter((f=>m.some((m=>isCodecsMatch(m,f,g.fmtp)))));g.type===je.MEDIA_TYPE.video&&(v=v.filter((m=>{const f=g.fmtp&&g.fmtp.find((g=>g.payload===m.payload&&g.config.startsWith("apt=")));if(f){const g=+f.config.split(";")[0].split("=")[1];return v.some((m=>m.payload===g))}return!0}))),v.length?(g.rtp=v,f&&(g.rtp=(0,lf.flatten)(m.map((m=>g.rtp.filter((f=>isCodecsMatch(m,f,g.fmtp))))))),g.payloads=g.rtp.map((g=>g.payload)).join(" "),g.fmtp=g.fmtp&&g.fmtp.filter((m=>g.rtp.some((g=>isPayloadMatch(g.payload,m.payload))))),g.rtcpFb=g.rtcpFb&&g.rtcpFb.filter((m=>g.rtp.some((g=>isPayloadMatch(g.payload,m.payload)))))):S&&S.warn("Empty rtp list after filtering")}function getModalityForMedia(g){if(g.label)switch(g.label){case je.MEDIA_LABEL.audio:return"Audio";case je.MEDIA_LABEL.video:return"Video";case je.MEDIA_LABEL.sharing:return"ScreenShare";case je.MEDIA_LABEL.data:return"Data"}else switch(g.type){case je.MEDIA_TYPE.audio:return"Audio";case je.MEDIA_TYPE.video:return"Video";case je.MEDIA_TYPE.data:case je.MEDIA_TYPE.dataChannel:return"Data"}return null}function getModality(g){if(g.label)switch(g.label){case je.MEDIA_LABEL.audio:return je.MODALITY.audio;case je.MEDIA_LABEL.video:return je.MODALITY.video;case je.MEDIA_LABEL.sharing:return je.MODALITY.sharing;case je.MEDIA_LABEL.data:return je.MODALITY.data}else switch(g.type){case je.MEDIA_TYPE.audio:return je.MODALITY.audio;case je.MEDIA_TYPE.video:return je.MODALITY.video;case je.MEDIA_TYPE.data:case je.MEDIA_TYPE.dataChannel:return je.MODALITY.data}return null}function getLabelForModality(g){switch(g){case je.MODALITY.audio:return je.MEDIA_LABEL.audio;case je.MODALITY.video:return je.MEDIA_LABEL.video;case je.MODALITY.sharing:return je.MEDIA_LABEL.sharing;case je.MODALITY.data:return je.MEDIA_LABEL.data;default:return null}}function getModalities(g){return g.media.reduce(((g,m)=>{if(0!==m.port){const f=getModality(m);if(!(f in g)){const S=m.direction?m.direction.toLowerCase():je.MEDIA_STATE.sendReceive;g[f]=S}}return g}),{})}function getTypeFromModality(g){switch(g){case je.MODALITY.audio:return je.MEDIA_TYPE.audio;case je.MODALITY.video:case je.MODALITY.sharing:return je.MEDIA_TYPE.video;case je.MODALITY.data:return je.MEDIA_TYPE.data;default:return null}}function getBundle(g){const m=g.groups?.find((g=>"BUNDLE"===g.type));if(m){const f=m.mids?.toString().split(" ")[0];return g.media.find((g=>{const m="number"==typeof g.mid?g.mid.toString():g.mid;return f===m}))||null}return null}function isMediaDisabled(g){return 0===g.port}function getRecvCapabilitiesForMedia(g){let m;return g&&forOneCodec(g,{codec:"h264",rate:9e4},(g=>{g.fmtp?.config&&(m=parseVideoCapabilitiesFromFmtpConfig(g.fmtp.config))})),m}function parseVideoCapabilitiesFromFmtpConfig(g){const m=new cf(g);return{maxFs:+m.get(je.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+m.get(je.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+m.get(je.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+m.get(je.VIDEO_CAPABILITIES.MAX_BR_PATH)}}var df=R;function CandidateTransform(){const g=[{jsep:"active",msSdp:"tcp-act"},{jsep:"passive",msSdp:"tcp-pass"},{jsep:"so",msSdp:"tcp-so"}];function transformBundle(g,m){if(g.port&&!g.candidates.length){const f=getBundle(m);f&&(g.port=f.port,g.connection=f.connection)}}function transformCandidate(g,m){delete g.generation,delete g["network-id"],delete g["network-cost"],g.transport.match(/tcp/i)&&transformTcpCandidate(g,m)}function transformTcpCandidate(m,f){g.some((function(g){if(f){if(g.msSdp===m.transport.toLowerCase())return m.transport="tcp",m.tcptype=g.jsep,!0}else if(m.tcptype&&g.jsep===m.tcptype.toLowerCase())return m.transport=g.msSdp,delete m.tcptype,!0;return!1}))}function isDefault(g,m,f){const S=m.connection||f.connection,isSame=function(g,m,f){return g.port===f&&g.ip===m};return!!S&&(1===g.component?isSame(g,S.ip,m.port):!!m.rtcp&&isSame(g,m.rtcp.ip||S.ip,m.rtcp.port))}this.fromMsSdp=function(g){g.candidates=g.candidates||[],g.xCandidatesIpv6&&(g.xCandidatesIpv6.forEach((function(m){g.candidates.push(m)})),delete g.xCandidatesIpv6),g.candidates.forEach((function(g){transformCandidate(g,!0)}))},this.toMsSdp=function(g,m){g.candidates=g.candidates||[],g.candidates.sort((function(f,S){return f.foundation!==S.foundation?f.foundation-S.foundation:f.component!==S.component?f.component-S.component:+isDefault(S,g,m)-+isDefault(f,g,m)})),g.candidates=g.candidates.filter((function(m,f){transformCandidate(m,!1);const S=g.candidates[f-1];return!S||S.component!==m.component||S.foundation!==m.foundation})),transformBundle(g,m)}}var hf={build:()=>new CandidateTransform},uf=class{toMsSdp(g,m){"offer"===m?g.rtcp&&(g.rtcp={port:g.port}):delete g.rtcp}},gf={build:()=>new uf},pf={STREAM_ID:{audio:"mainAudio",video:"mainVideo",sharing:"applicationsharingVideo"},STREAM_ID_DELIMITER:"-"},mf=[{label:je.MEDIA_LABEL.audio,id:pf.STREAM_ID.audio},{label:je.MEDIA_LABEL.video,id:pf.STREAM_ID.video},{label:je.MEDIA_LABEL.sharing,id:pf.STREAM_ID.sharing}].reduce(((g,m)=>(g[m.label]=m.id,g)),{}),ff=uniqueId(),Sf=class{constructor(g){this.configuration=g}fromMsSdp(g){if(0===g.port)return;const m="-";if(!this.isRecvOnly(g)||this.configuration.unifiedPlanEnabled){if(g.msid){g.ssrcs&&1===g.ssrcs.length&&(this.addStream(g,g.ssrcs[0].id,g.ssrcs[0].value,g.msid),g.ssrcs.shift());const f=g.msid.split(" ");(this.configuration.addPrefixForMsid||f[0]===m)&&(g.msid=this.getMsidValue(f[0],f[1]||f[0],g.label))}if(g.ssrcs)this.updateMsids(g.ssrcs,((f,S)=>this.configuration.addPrefixForMsid||f===m?this.getMsidValue(f,S,g.label):`${f} ${S}`));else{const m=this.getFlowSsrcs(g);m.length>0?m.forEach((f=>{this.addStream(g,f,ff,this.getMsidValue(m[0],m[0],g.label))})):g.xSsrcRange&&this.addStream(g,g.xSsrcRange.ssrcMin,ff,this.getMsidValue(g.xSsrcRange.ssrcMin,g.xSsrcRange.ssrcMin,g.label))}}delete g.xSsrcRange}toMsSdp(g,m){if(0===g.port)return;let f;g.ssrcs&&g.ssrcs[0]&&(f=g.ssrcs[0].id),void 0!==f&&(g.xSsrcRange={ssrcMin:f,ssrcMax:f+m})}getFlowSsrcs(g){if(g.ssrcGroups&&g.type===je.MEDIA_TYPE.video){let m;if(g.ssrcGroups.some((g=>"FID"===g.semantics&&(m=g,!0))),m)return m.ssrcs.split(" ").map((g=>+g))}return[]}addStream(g,m,f,S){g.ssrcs=g.ssrcs||[],g.ssrcs.push({attribute:"cname",id:m,value:f}),g.ssrcs.push({attribute:"msid",id:m,value:S})}updateMsids(g,m){g.filter((g=>"msid"===g.attribute)).forEach((g=>{const f=g.value.split(" ");g.value=m(f[0],f[1]||f[0])}))}getMsidValue(g,m,f){const S=this.getMsidPrefix(f);return S+g+" "+S+m}getMsidPrefix(g){return mf[g]?mf[g]+pf.STREAM_ID_DELIMITER:""}isRecvOnly(g){return"recvonly"===g.direction}},vf={audio:"main-audio",video:"main-video"},yf=class{constructor(g,m){this.context=g,this.mediaManager=m,this.logger=this.context.logger,this.candidateTransform=hf.build(),this.streamTransform=new Sf(this.context.configuration),this.rtcpTransform=gf.build()}toMsSdp(g,m){return g.msidSemantic={semantic:"WMS",token:"*"},g.media.forEach(((f,S)=>{if(f.protocol=je.PROFILES.rtpSavp,f.label=f.label||this.getLabel(f.type),isMediaDisabled(f)){for(const g in f)f.hasOwnProperty(g)&&["type","port","protocol","payloads"].indexOf(g)<0&&delete f[g];f.payloads="34"}const v=this.getSsrcRangeForIndex(f.direction,S);this.streamTransform.toMsSdp(f,v),f.crypto&&f.crypto.forEach((function(g){g.config+="|2^31"})),0!==f.port&&g.fingerprint&&(f.fingerprint=g.fingerprint),this.candidateTransform.toMsSdp(f,g),this.rtcpTransform.toMsSdp(f,m),f.invalid&&(this.logger.unsafe.error(`Unknown SDP attributes! ${JSON.stringify(f.invalid)}`),delete f.invalid),this.transformExtensions(f,!1),0!==f.port&&(f.type===je.MEDIA_TYPE.audio&&this.context.configProvider.config.webrtcAudioChannelSignalingFeedback?f.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcAudioChannelSignalingFeedback}:f.type===je.MEDIA_TYPE.video&&this.context.configProvider.config.webrtcVideoChannelSignalingFeedback&&(f.signalingFbXMessage={payload:"*",param:this.context.configProvider.config.webrtcVideoChannelSignalingFeedback}))})),delete g.fingerprint,g}fromMsSdp(g,m){for(let f=g.media.length-1;f>=0;--f){const S=g.media[f];if((S.ssrcs&&S.ssrcs[0]||S.xSsrcRange)&&(g.msidSemantic={semantic:"WMS",token:"*"}),isMediaDisabled(S))S.direction||(S.direction="inactive");else{if(this.streamTransform.fromMsSdp(S),delete S.cryptoscale,S.fingerprint&&(!this.isOffer(m)||this.context.configProvider.config.disableIncomingDtlsRoleOverride&&S.setup||(S.setup="actpass")),S.crypto)for(let g=S.crypto.length-1;g>=0;--g){const m=S.crypto[g];m.config.match(/.*\|\d+:\d+/)?S.crypto.splice(g,1):m.config=m.config.replace(/(.*)\|2\^\d+/,"$1")}S.remoteCandidates&&(delete S.candidates,delete S.xCandidatesIpv6,delete S.remoteCandidates),this.candidateTransform.fromMsSdp(S),S.rtcpFbXMessage&&delete S.rtcpFbXMessage,S.invalid&&this.logger.unsafe.info(`Unknown SDP attributes! ${JSON.stringify(S.invalid)}`),this.transformExtensions(S,!0)}}return g}transformExtensions(g,m){const f=[{name:je.ABS_SEND_TIME.EXT_URI,encoded:je.ABS_SEND_TIME.MSSDP_ENCODED_URI},{name:je.TRANSPORT_CC.EXT_URI,encoded:je.TRANSPORT_CC.MSSDP_ENCODED_URI}];g.ext&&g.ext.forEach((function(g){f.some((function(f){const S=m?f.encoded:f.name,v=m?f.name:f.encoded;return S===g.uri&&(g.uri=v,!0)}))}))}isOffer(g){return"offer"===g}getLabel(g){return vf.hasOwnProperty(g)&&vf[g]||"undefined"}getSsrcRangeForIndex(g,m){const f=this.mediaManager.getMediaEntities()[m],S=f?.getSimulcastContext();return hasSendDirectionality(g)&&S?S.getSsrcRange():0}},Cf=class{constructor(g,m,f){this.context=g,this.mediaManager=m,this.sessionType=f,this.msSdpT=new yf(this.context,this.mediaManager)}modify(g){this.msSdpT.toMsSdp(g,this.sessionType)}},_f=class{constructor(g,m,f){this.context=g,this.mediaManager=m,this.sessionType=f,this.msSdpT=new yf(this.context,this.mediaManager)}modify(g){this.msSdpT.fromMsSdp(g,this.sessionType)}},Ef=class{constructor(g){this.context=g}modify(g){const m=preferSdesSrtp(this.context),f=getSrtpInfo(g),S=g.media.find((g=>!!g.crypto));g.media.forEach((g=>{g.type!==je.MEDIA_TYPE.dataChannel&&(!m&&g.fingerprint&&g.crypto&&delete g.crypto,g.protocol=!f.dtls||f.sdes&&m?je.PROFILES.rtpSavpf:je.PROFILES.udpTlsRtpSavpf,isMediaDisabled(g)&&g.protocol===je.PROFILES.rtpSavpf&&S&&(g.crypto=S.crypto))}))}},Tf=class{constructor(g,m,f){this.mediaManager=g,this.isOffer=m,this.configProvider=f}modify(g){g.media.forEach(((g,m)=>{const f=g.setup,S=this.mediaManager.getMediaEntities()[m],v=S.getExtension("setup");f&&S.isEnabled()&&("actpass"!==f?S.setExtension("setup",f):this.isOffer&&void 0!==v&&"actpass"!==v&&!this.configProvider.config.disableOutgoingDtlsRoleOverride&&(g.setup=v))}))}},If=class{constructor(g,m){this.mediaManager=g,this.modalities=m}modify(g){let m=0;g.media.forEach(((g,f)=>{const S=parseInt(g.mid,10);!isNaN(S)&&S>=m&&(m=S+1)})),g.media.forEach(((f,S)=>{const v=this.mediaManager.getMediaEntities()[S];if(isMediaDisabled(f)||v.isDisabled()||!(v.getModality()in this.modalities)){const C=v.getExtension("midApplied")?void 0:f.mid||""+m++;0===S?f.direction=je.MEDIA_STATE.inactive:g.media[S]=disabledMedia(f.type,void 0,f.protocol,C)}}))}},bf=class{constructor(g,m){this.mediaManager=g,this.remote=m}modify(g){const m=this.mediaManager.getMediaEntities();for(let f=0;f<m.length;f++){const S=m[f],v=g.media[f];if(S.getExtension("rollback"))if(v&&!this.remote)g.media[f]=null;else if(!v&&this.remote){const m=S.getType()===je.MEDIA_TYPE.data?je.MEDIA_TYPE.dataChannel:S.getType(),f=m===je.MEDIA_TYPE.dataChannel?je.PROFILES.udpDtlsSctp:je.PROFILES.udpTlsRtpSavpf;g.media.push(disabledMedia(m,void 0,f,void 0))}}g.media=g.media.filter((g=>g))}},Af=class{constructor(g){this.mediaManager=g}modify(g){this.mediaManager.getMediaEntities().forEach(((m,f)=>{const S=g.media[f];m.getModality()!==je.MODALITY.data||S&&S.type===je.MEDIA_TYPE.dataChannel||g.media.splice(f,0,disabledMedia(je.MEDIA_TYPE.data,je.MEDIA_LABEL.data,je.PROFILES.rtpSavp,void 0))}))}},Pf=class{constructor(g,m){this.context=g,this.direction=m}modify(g){g.media.forEach((g=>{g.type===je.MEDIA_TYPE.dataChannel&&(g.type=je.MEDIA_TYPE.data,g.payloads=je.PAYLOAD_TYPE.X_DATA)})),allowDataChannel(this.context)&&getEnabledMedia(g,je.MEDIA_TYPE.data).forEach((m=>{m.rtp=m.rtp||[],m.fmtp=m.fmtp||[],m.rtp.push({codec:"x-data",payload:127,rate:9e4}),m.rtp.push({codec:"rtx",payload:126,rate:9e4}),m.fmtp.push({payload:126,config:"apt=127"});const f=this.getNonOverlappingSsrc(g);m.xSsrcRange={ssrcMin:f,ssrcMax:f},m.rtcpMux="rtcp-mux",m.xDataProtocol="sctp",m.direction=this.direction}))}getNonOverlappingSsrc(g){let m,f=!0;do{m=Math.floor(4294967293*Math.random())+2,getEnabledMedia(g).forEach((g=>{g?.ssrcs?.[0]?.id===m&&(f=!1)}))}while(!f);return m}},Rf=class{constructor(g){this.configProvider=g,this.uri="urn:3gpp:video-orientation",this.value=13}modify(g){if(this.configProvider.config.enableVideoOrientationExtension)for(const m of getEnabledMedia(g,je.MEDIA_TYPE.video))this.modifyMedia(m)}},wf=class extends Rf{modifyMedia(g){g.ext??(g.ext=[]);g.ext.some((g=>g.uri===this.uri))||g.ext.push({value:this.getAvailableValue(g.ext),uri:this.uri})}getAvailableValue(g){const m=g.map((g=>g.value));return m.includes(this.value)?Math.max(...m)+1:this.value}},Mf=class extends Rf{modifyMedia(g){g.ext=g.ext?.filter((g=>g.uri!==this.uri))}},Df=class{constructor(g){this.context=g}modify(g){const m=g.groups?.find((g=>"BUNDLE"===g.type));for(let f=g.media.length-1;f>=0;f--){const S=g.media[f];if(S.type===je.MEDIA_TYPE.data){const v=this.context.configProvider.config.rejectUnbundledDataModality&&!this.context.configProvider.mediaConfig.isTransportUnbundled&&!m?.mids?.toString().includes(S.mid),C=allowDataChannel(this.context);C||this.context.configProvider.config.acceptDisabledDataModality?(S.port=C&&!v?S.port:0,S.payloads=je.PAYLOAD_TYPE.DATA_CHANNEL,S.type=je.MEDIA_TYPE.dataChannel,S.protocol=je.PROFILES.udpDtlsSctp,S.sctpPort??(S.sctpPort=this.context.configProvider.config.sctpPort),delete S.xDataProtocol,delete S.rtp,delete S.fmtp,delete S.rtcp,delete S.rtcpMux,delete S.ext,delete S.ssrcs,delete S.ssrcGroups,delete S.xSsrcRange):g.media.splice(f,1)}}}},Of=class{constructor(g,m){this.modalities=g,this.mediaManager=m}modify(g){getEnabledMedia(g).forEach((g=>{const m=getModality(g),f=this.mediaManager.getMediaEntityByMid(g.mid);!(this.modalities[m]!==je.MEDIA_STATE.send||f.getExtension("reinviteless")||g.direction&&g.direction.toLowerCase()===je.MEDIA_STATE.receive)&&(g.direction=je.MEDIA_STATE.receive)}))}},Nf=class{constructor(g,m){this.isMultiparty=g,this.cname=m}modify(g){this.isMultiparty&&getEnabledMedia(g).forEach((g=>{const m=g.direction;m!==je.MEDIA_STATE.receive&&m!==je.MEDIA_STATE.inactive||(g.ssrcs&&g.ssrcs[0]?g.ssrcs=[{id:g.ssrcs[0].id,attribute:"cname",value:this.cname}]:g.type===je.MEDIA_TYPE.audio?g.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:g.type===je.MEDIA_TYPE.video&&(g.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}))}},kf=class{modify(g){const m=new Set;getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{g.ssrcs&&g.ssrcs.length>1&&m.add(g.ssrcs[0].id)}));const f=getEnabledMedia(g,je.MEDIA_TYPE.video).find((g=>g.direction===je.MEDIA_STATE.sendReceive||g.direction===je.MEDIA_STATE.send));getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{const S=g.direction;if((S===je.MEDIA_STATE.receive||S===je.MEDIA_STATE.inactive)&&g.ssrcs&&1===g.ssrcs.length){const S=g.ssrcs[0].id;(1===S||f&&f.ssrcs[0].id===S||!f&&m.has(S))&&(delete g.ssrcs,delete g.ssrcGroups)}}))}},Lf=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const f=this.mediaManager.getMediaEntities()[m];g.label=getLabelForModality(f.getModality())}))}},Ff=class{modify(g){g.media.forEach((g=>{delete g.label}))}},xf=class{constructor(g,m,f){this.mediaManager=g,this.modalities=m,this.configProvider=f}modify(g){let m=this.configProvider.mediaConfig.maxBandwidthInKbps;const f=g.bandwidth?.find((g=>"CT"===g.type));f&&(!m||m>f.limit)&&(m=f.limit);const S=this.configProvider.config.audioBandwidthInKbps||0,v=Math.max(m-S,0),C=this.configProvider.config.videoBandwidthAllocation&&hasSendDirectionality(this.modalities.video)&&hasSendDirectionality(this.modalities.sharing);getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{if(delete g.bandwidth,v){let m=v;if(C){const f=this.mediaManager.getMediaEntityByMid(g.mid).getModality()===je.MODALITY.video?this.configProvider.config.videoBandwidthAllocation:1-this.configProvider.config.videoBandwidthAllocation;m=Math.round(v*f)}g.bandwidth=[{limit:m,type:"AS"}]}}))}},Uf=class{constructor(g){this.configProvider=g}modify(g){const m=this.configProvider.mediaConfig.maxBandwidthInKbps;m&&(g.bandwidth=[{limit:m,type:"CT"}])}},Vf=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const f=this.mediaManager.getMediaEntities()[m],S=f.getExtension("iceUfrag");f.setExtension("iceRestart",!!g.iceUfrag&&!!S&&S!==g.iceUfrag),f.setExtension("iceUfrag",g.iceUfrag)}))}},Bf=class{modify(g){const m=new Set(["urn:ietf:params:rtp-hdrext:csrc-audio-level","http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"]);getEnabledMedia(g).forEach((g=>{g.ext&&(g.ext=g.ext.filter((g=>!m.has(g.uri))))}))}},Hf=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.extmapAllowMixed&&(g.extmapAllowMixed="extmap-allow-mixed")}},$f=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.extmapAllowMixed||delete g.extmapAllowMixed}},Gf=class{modify(g){getEnabledMedia(g).forEach((g=>{delete g.signalingFbXMessage}))}},jf=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){if(!this.configProvider.config.isAv1Allowed)return;const m=findAllAvailablePayloads(g,[96,127]);this.mediaManager.getMediaEntities().forEach(((f,S)=>{if(f.getModality()===je.MODALITY.audio)return;const v=g.media[S];let C=0;forAllCodecs(v,{codec:"AV1",rate:9e4},(g=>{g.rtp.payload<96&&(g.rtp.payload=m[C]??g.rtp.payload,C++)}))}))}},Wf=class{constructor(g,m,f){this.mediaManager=g,this.configProvider=m,this.sdpType=f,this.baseModifier=new zf(this.mediaManager,this.configProvider,this.sdpType,!1)}modify(g){this.configProvider.config.filterCodecsInSdpV2||this.baseModifier.modify(g)}},qf=class{constructor(g,m,f){this.mediaManager=g,this.configProvider=m,this.sdpType=f,this.baseModifier=new zf(this.mediaManager,this.configProvider,this.sdpType,!0)}modify(g){this.configProvider.config.filterCodecsInSdpV2&&this.baseModifier.modify(g)}},zf=class{constructor(g,m,f,S=!1){this.mediaManager=g,this.configProvider=m,this.sdpType=f,this.alwaysReorder=S}modify(g){this.configProvider.config.filterCodecsInSdp&&"offer"===this.sdpType&&this.mediaManager.getMediaEntities().forEach(((m,f)=>{const S=g.media[f];if(!S)return;const v=getAllowedCodecs(this.configProvider,S.type);if(!v.length)return;filterCodecs(S,convertToCodecInfo(v),!!m.getExtension("unnegotiatedModality")||this.alwaysReorder,null)}))}},Kf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=this.configProvider.mediaConfig.audioCodecContext;m&&f&&(f.codec!==f.lastUsedCodec&&"None"!==f.lastUsedCodec&&this.removeSubstitutionCodecIfNeeded(m,f.lastUsedCodec),f.enabledLocally&&!f.disabledRemotely&&this.addSubstitutionCodecIfNeeded(m,f.codec,g))}addSubstitutionCodecIfNeeded(g,m,f){if(this.isSubstitutionCodecAdded(g,m))return;const S=findAvailablePayload(f);if(-1===S)return;const v=getCustomCodecParams(m,"SUBSTITUTION");changePayloadType(f,v.payload,S),addCodec(g,v)}removeSubstitutionCodecIfNeeded(g,m){removeCodec(g,getCustomCodecParams(m,"SUBSTITUTION"))}isSubstitutionCodecAdded(g,m){let f=!1;return forOneCodec(g,getCustomCodecParams(m,"SUBSTITUTION"),(()=>{f=!0})),f}},Jf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=this.configProvider.mediaConfig.audioCodecContext;if(m&&f&&f.enabledLocally&&!f.disabledRemotely){const g=getCustomCodecParams(f.codec,"SUBSTITUTION"),S=getCustomCodecParams(f.codec,"CODEC");forOneCodec(m,g,(g=>{g.rtp.codec=S.codec,g.rtp.rate=S.rate,g.rtp.encoding=S.encoding}))}}},Yf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=this.configProvider.mediaConfig.audioCodecContext;if(!m||!f?.enabledLocally)return;const S=getCustomCodecParams(f.codec,"CODEC"),v=getCustomCodecParams(f.codec,"SUBSTITUTION");let C=!1;forOneCodec(m,S,(g=>{f.enabledForSend&&(g.rtp.codec=v.codec,g.rtp.rate=v.rate,g.rtp.encoding=v.encoding,g.fmtp={payload:S.payload,config:"ptime=20"}),C=!0})),f.disabledRemotely=!C}},Qf=class{modify(g){removeCodec(g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),{codec:"CN",rate:16e3})}},Xf=class{constructor(g){this.configProvider=g}modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=this.configProvider.mediaConfig.audioCodecContext;if(!m||!f?.enabledLocally||f.disabledRemotely)return;let S=!1;const v={codec:"CN",rate:48e3};if(forOneCodec(m,v,(()=>{S=!0})),S)return;const C=findAvailablePayload(g);-1!==C&&(changePayloadType(g,je.PAYLOAD_TYPE.MSRTC_CNFB,C),v.payload=je.PAYLOAD_TYPE.MSRTC_CNFB,addCodec(m,v))}},Zf=class{modify(g){removeCodec(g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),{codec:"g722",rate:8e3,encoding:2})}},eS=class{constructor(g){this.configProvider=g}modify(g){const m=this.configProvider.config.enforceOpusFmtp;if(m){forOneCodec(g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),{codec:"opus",rate:48e3,encoding:2},(g=>{g.fmtp||(g.fmtp={payload:g.rtp.payload});const f=new cf(g.fmtp.config);Object.keys(m).forEach((g=>{f.removeIfPresent(g),f.setIfMissing(g,`${m[g]}`)})),g.fmtp.config=f.toString()}))}}},tS=class{modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio));if(m&&isMediaDisabled(m)){const f=g.media.find((g=>!!g.iceUfrag));f&&(m.port=9,m.direction="inactive",m.iceUfrag=f.iceUfrag,m.icePwd=f.icePwd,m.rtcpMux="rtcp-mux",f.crypto&&(m.crypto=f.crypto),f.fingerprint&&(m.fingerprint=f.fingerprint,m.setup=f.setup),m.rtp=[{payload:0,codec:"PCMU",rate:8e3}],m.payloads="0")}}},iS=class{constructor(g){this.otherPartyCodecs=g}modify(g){const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=["cn","telephone-event"],S=m.rtp.filter((g=>-1!==this.otherPartyCodecs.indexOf(g.codec.toLowerCase())&&-1===f.indexOf(g.codec.toLowerCase())));if(0===S.length)throw new Error("there is no matching primary audio codec");m.rtp.filter((g=>g!==S[0]&&-1===f.indexOf(g.codec.toLowerCase()))).forEach((g=>{removeCodec(m,g)}))}},nS=class{constructor(g,m){this.configProvider=g,this.logger=m}modify(g){this.configProvider.config.webrtcInjectTransportCCAudio&&getEnabledMedia(g,je.MEDIA_TYPE.audio).forEach((g=>{const m=g.ext?.find((g=>g.uri===je.TRANSPORT_CC.EXT_URI));if(!m)return void this.logger.safe.info("transport-cc ext not present in sdp, skipping injecting transport-cc attribute for audio");const f=g.rtp?.find((g=>"opus"===g.codec.toLowerCase()));if(!f)return void this.logger.safe.info("opus codec not found, skipping injecting transport-cc attribute for audio");const S=f.payload,v=g.rtcpFb?.find((g=>g.type===je.TRANSPORT_CC.ATTRIBUTE&&g.payload===S));v?this.logger.safe.info("opus codec already has transport-cc attribute"):(g.rtcpFb=g.rtcpFb||[],g.rtcpFb.push({payload:S,type:je.TRANSPORT_CC.ATTRIBUTE}),this.logger.safe.info("injected transport-cc attribute"))}))}},rS=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){g.media.forEach(((g,m)=>{if(isMediaDisabled(g)||g.type!==je.MEDIA_TYPE.video)return;const f=this.mediaManager.getMediaEntities()[m];forOneCodec(g,{codec:"h264",rate:9e4},(g=>{const m=f.getLocalRecvCapabilities();if(!m)return;g.fmtp||(g.fmtp={payload:g.rtp.payload});const S=new cf(g.fmtp.config);this.configProvider.config.h264SdpProfile?(S.removeIfPresent("profile-level-id"),S.setIfMissing("profile-level-id",this.configProvider.config.h264SdpProfile)):S.setIfMissing("profile-level-id","42C02A"),S.setIfMissing("max-fs",m.getMaxFS().toString()),S.setIfMissing("max-mbps",m.getMaxMBPS().toString()),S.setIfMissing("max-fps",m.getMaxFPS().toString()),g.fmtp.config=S.toString()}))}))}},sS=class{constructor(g){this.configProvider=g}modify(g){getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{forOneCodec(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new cf,f=new cf(g.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((g=>{if(f.contains(g)){let S=f.get(g);"profile-level-id"===g&&(S=this.configProvider.config.h264SendProfileOverride||S),m.setIfMissing(g,S)}})),g.fmtp.config=m.toString()}}))}))}},aS=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{forAllCodecs(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new cf(g.fmtp.config);m.setIfMissing("sps-pps-idr-in-keyframe","1"),g.fmtp.config=m.toString()}}))}))}},oS=class{constructor(g){this.configProvider=g}modify(g){this.configProvider.config.enableH264SpsPpsIdrKeyframe&&getEnabledMedia(g,je.MEDIA_TYPE.video).forEach((g=>{forAllCodecs(g,{codec:"h264",rate:9e4},(g=>{if(g.fmtp){const m=new cf(g.fmtp.config);m.removeIfPresent("sps-pps-idr-in-keyframe"),g.fmtp.config=m.toString()}}))}))}},lS=class{constructor(g){this.configProvider=g}modify(g){const m=(g.groups||[]).findIndex((g=>"BUNDLE"===g.type)),f=g.groups?g.groups[m]:void 0;f&&(this.configProvider.mediaConfig.isTransportUnbundled?(f.mids=this.createBundleFromMedia(getEnabledMedia(g,je.MEDIA_TYPE.video)),f.mids||g.groups.splice(m,1)):f.mids=this.createBundleFromMedia(getEnabledMedia(g)))}createBundleFromMedia(g){return g.map((g=>g.mid?.toString())).filter((g=>g)).join(" ")}},cS=class{modify(g){g.media.forEach((g=>{isMediaDisabled(g)&&g.bundleOnly&&(g.port=9,delete g.invalid)}))}},dS=class{constructor(g,m){this.configProvider=g,this.mediaManager=m}modify(g){if(!this.configProvider.mediaConfig.isTransportUnbundled&&!g.groups?.find((g=>"BUNDLE"===g.type))){let m=!1;if(g.media.forEach(((g,f)=>{const S=this.mediaManager.getMediaEntities()[f];!m&&S.isEnabled()?(g.mid=S.getMid(),m=!0):(S.disable(),g.port=0)})),m){g.groups||(g.groups=[]);const m={type:"BUNDLE"};g.groups.push(m)}}}},hS=class{constructor(g,m){this.configProvider=g,this.logger=m}modify(g){g.media.forEach((g=>{const m=!!g.candidates;if(g.candidates&&(g.candidates=g.candidates.filter((g=>{let m=!0,f=!0,S=!0;return this.configProvider.config.iceCandidateType&&(m=!!g.type.match(new RegExp(this.configProvider.config.iceCandidateType,"i"))),this.configProvider.config.iceCandidateTransport&&(f=!!g.transport.match(new RegExp(this.configProvider.config.iceCandidateTransport,"i"))),this.configProvider.config.iceCandidateFilterMDns&&(S=!this.isMdns(g.ip),S||this.logger.safe.info(`Filtering out mDNS candidate ${scrubMriOrOmit(g.ip)}:${scrubMriOrOmit(g.port)}`)),m&&f&&S}))),m&&g.connection&&this.configProvider.config.iceCandidateFilterMDns&&(g.candidates&&0!==g.candidates.length||(g.candidates=[getDummyCandidate(g.port)]),this.isMdns(g.connection.ip)||!this.hasMatchingCandidate(g))){const m=this.getDefaultCandidate(g);g.connection.ip=m.ip,g.port=m.port}}))}hasMatchingCandidate(g){const m=g.connection;return m&&!!g.candidates.find(this.createIpAndPortMatcher(m.ip,g.port))}getDefaultCandidate(g){return g.candidates.slice().sort(((g,m)=>g.type===m.type?0:"host"===g.type||"relay"===m.type?1:"relay"===g.type||"host"===m.type?-1:0))[0]}isMdns(g){return g.indexOf(".local")>-1||g.indexOf(".encrypted")>-1}createIpAndPortMatcher(g,m){return f=>f.ip===g&&f.port===m}},uS=class{modify(g){const m=getEnabledMedia(g)[0];m&&(m.candidates=[getDummyCandidate()])}},gS=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{this.fromMsSdp(g,m)}))}fromMsSdp(g,m){if(isMediaDisabled(g)||g.rids&&g.simulcast)return;const f=this.mediaManager.getMediaEntities()[m],S=f?.getSimulcastContext();S?.shouldBeEnabledInRemoteDesc()&&(S.enableInRemoteDesc(),g.simulcast={dir1:"recv",list1:S.ridList.map((g=>`${S.activeRids.includes(g)?"":"~"}${g}`)).join(";")},g.rids=S.ridList.map((g=>({id:g,direction:"recv"}))))}},pS=class{constructor(g,m){this.mediaManager=g,this.logger=m}modify(g){g.media.forEach(((g,m)=>{this.toMsSdp(g,m)}))}toMsSdp(g,m){const f=this.mediaManager.getMediaEntities()[m],S=f?.getSimulcastContext();S&&(S.localDescriptionIsApplied(),S.shouldBeEnabledInLocalDesc()&&(S.enableInLocalDesc(),this.removeSimulcastEnvelope(g),this.addStreamSsrc(g,f.getLocalSsrc())))}removeSimulcastEnvelope(g){g.rids&&delete g.rids,g.simulcast&&delete g.simulcast}addStreamSsrc(g,m){if(!m)return;if(g.ssrcs)return void this.logger.safe.debug(`Media mid: ${g.mid} already contains ssrc: ${JSON.stringify(g.ssrcs)}`);const f=m;this.setSsrc(g,f)}setSsrc(g,m){g.ssrcs=[{id:m,attribute:"fake_attribute",value:"fake_value"}]}},mS=class{constructor(g){this.mediaManager=g}modify(g){g.media.forEach(((g,m)=>{const f=this.mediaManager.getMediaEntities()[m],S=f?.getLocalTrackId();(!g.msid&&f?.getSimulcastContext()?.shouldUseSimulcast()&&S||f?.getExtension("reinviteless"))&&(g.msid=`- ${S??"-"}`)}))}},fS=class{constructor(g,m){this.mediaManager=g,this.configProvider=m}modify(g){const m=this.mediaManager.getMediaEntities(),f=(0,df.flatMap)(m,(g=>g.getRtpHeaderExtensions())),S=f.find((g=>"vla"===g?.headerType))?.value,v=f.find((g=>"non-adv-vla"===g?.headerType))?.value,C=S??v??(0,df.flatMap)(g.media,(g=>g.ext||[])).find((g=>g.uri===je.VLA.EXT_URI))?.value,_=getFreeValueForExt(g,this.configProvider.config.extmapAllowMixed,je.VLA.DEFAULT_VALUE);g.media.forEach(((g,f)=>{const S=getModalityForMedia(g);if(!(this.configProvider.config.enableVla&&("Video"===S||"ScreenShare"===S)))return;if(g.ext?.find((g=>g.uri===je.VLA.EXT_URI)))return;const v=m[f]?.getRtpHeaderExtensions(),E=v?v.find((g=>"vla"===g.headerType))?.value??v.find((g=>"non-adv-vla"===g.headerType))?.value:C??_;E&&(g.ext=g.ext||[],g.ext.push({value:E,uri:je.VLA.EXT_URI}))}))}},SS=class{constructor(g){this.configProvider=g}modify(g){g.media.forEach((g=>{const m=getModalityForMedia(g);if(this.configProvider.config.allowRemoteVla&&("Video"===m||"ScreenShare"===m))return;const f=g.ext?.findIndex((g=>g.uri===je.VLA.EXT_URI));f>-1&&g.ext.splice(f,1)}))}},vS=class{constructor(g){this.configProvider=g}modify(g,m,f){g.media.forEach((g=>{const S=getModalityForMedia(g);if(!(this.configProvider.config.enableNonAdvVla&&("Video"===S||"ScreenShare"===S))||g.ext?.find((g=>g.uri===f)))return;const v=g.ext?.find((g=>g.uri===m));v&&(v.uri=f)}))}},yS=class extends vS{constructor(g,m){super(g),this.mediaManager=m}modify(g){const m=this.mediaManager.getMediaEntities();(0,df.flatMap)(m,(g=>g.getRtpHeaderExtensions())).some((g=>"vla"===g?.headerType))||super.modify(g,je.VLA.EXT_URI,je.VLA.EXT_URI_NON_ADV)}},CS=class extends vS{constructor(g){super(g)}modify(g){super.modify(g,je.VLA.EXT_URI_NON_ADV,je.VLA.EXT_URI)}},_S=class{modify(g){g.media.forEach((g=>{g.ext?.forEach((g=>g.uri=this.normalizeSlashesInUri(g.uri)))}))}normalizeSlashesInUri(g){return g.replace(/\\/g,"/")}},ES=class{constructor(g){this.configProvider=g}modify(g){if(this.configProvider.config.fixSdpForPartialIceRestart){const[{iceUfrag:m,icePwd:f}={}]=g.media;void 0!==m&&void 0!==f&&g.media.forEach((g=>{g.iceUfrag=m,g.icePwd=f}))}}},TS=class{constructor(g){this.configProvider=g}modify(g){if(this.configProvider.config.reduceRtcpFbInSdp?.length)for(const m of getEnabledMedia(g,je.MEDIA_TYPE.video))m.rtcpFb=m.rtcpFb&&this.getFbList(m.rtcpFb)}getFbList(g){const m=[],f=[];for(const S of g){const g=S.subtype?`${S.type}/${S.subtype}`:`${S.type}`;m.includes(g)||(this.configProvider.config.reduceRtcpFbInSdp.includes(g)?(m.push(g),f.push({...S,payload:"*"})):f.push(S))}return f}},IS=class{constructor(g){this.configProvider=g}modify(g){if(!this.configProvider.config.redReceiveEnabled)return;const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio));let f=0;forOneCodec(m,{codec:"opus",rate:48e3,encoding:2},(g=>{f=g.rtp.payload}));const S={codec:"RED",rate:8e3};forOneCodec(m,S,(g=>{g.rtp.rate=48e3,g.rtp.encoding=2,f&&(g.fmtp={payload:g.rtp.payload,config:`${f}/${f}`})})),removeCodec(m,S)}},bS=class{constructor(g){this.configProvider=g}modify(g){if(!this.configProvider.config.redReceiveEnabled)return;forOneCodec(g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),{codec:"red",rate:48e3,encoding:2},(g=>{g.rtp.codec="RED",g.rtp.rate=8e3,delete g.rtp.encoding}))}},AS=class{constructor(g,m){this.configProvider=g,this.sdpType=m}modify(g){if(!this.configProvider.config.redReceiveEnabled||"offer"!==this.sdpType)return;const m=g.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f={codec:"red",rate:48e3,encoding:2};let S=0;if(forOneCodec(m,f,(g=>{S=g.rtp.payload})),S===je.PAYLOAD_TYPE.MSRTC_RED)return;const v=findAvailablePayload(g);-1!==v&&(changePayloadType(g,je.PAYLOAD_TYPE.MSRTC_RED,v),forOneCodec(m,f,(g=>{g.rtp.payload=je.PAYLOAD_TYPE.MSRTC_RED})))}};function disabledMedia(g,m,f,S){const v={type:g,port:0,label:m,payloads:g===je.MEDIA_TYPE.dataChannel||g===je.MEDIA_TYPE.data?je.PAYLOAD_TYPE.DATA_CHANNEL:"36",protocol:f,connection:{ip:"10.10.10.10",version:4}};return S&&(v.mid=S),v}function getEnabledMedia(g,m=null){return g.media.filter((g=>!(isMediaDisabled(g)||m&&g.type!==m)))}function getDummyCandidate(g=1234){return{component:1,ip:"10.10.10.10",foundation:1755259772,priority:2122197247,port:g!==9?g:1234,transport:"UDP",type:"host"}}function getFreeValueForExt(g,m,f,S=!1){const v=(0,df.flatMap)(g.media,(g=>g.ext||[])).map((g=>g.value));if(0===v.length)return f;const C=2,_=14;if(S&&!v.includes(f))return f;let E;for(let g=C;g<=_;g++)if(!v.includes(g)){E=g;break}return!E&&m&&(E=Math.max(...v)+1),E}function getCustomCodecParams(g,m){if(!je.AUDIO_DECODER[g]?.[m])throw`unsupported codec ${g} or type ${m}`;const f=je.AUDIO_DECODER[g][m];return{codec:f.NAME,rate:f.RATE,encoding:f.ENCODING,payload:je.AUDIO_DECODER[g].PT}}function changePayloadType(g,m,f){for(const S of g.media)updatePayload(S,m,f)}var PS=class _SessionDescription{constructor(g,m,f,S){this.context=g,this.sessionType=m,this.sdp=f,this.remote=S,this.mediaManager=this.context.mediaManager,this.sdpTransform=this.context.sdpTransform,this.logger=this.context.logger.createChild("SessionDescr"),this.sdpModel=of.parse(this.sdp),this.sdpModel.media.forEach((g=>{(0,af.isUndefined)(g.mid)||(g.mid=g.mid.toString())})),this.remote&&!this.context.configProvider.config.disableMsSdp&&new _f(g,this.mediaManager,m).modify(this.sdpModel)}clone(){return new _SessionDescription(this.context,this.sessionType,this.sdp,this.remote)}getModalities(){return this.modalities||getModalities(this.sdpModel)}updateModalities(g){this.modalities=g}getSrtpInfo(){return getSrtpInfo(this.sdpModel)}getVideoCodecs(){const g={};return this.sdpModel.media.forEach((m=>{"video"===m.type&&m.rtp.map((g=>g.codec.toLowerCase())).forEach((m=>g[m]=!0))})),Object.keys(g)}usePrimaryAudioCodecOnly(g){new iS(g).modify(this.sdpModel)}isCodecSwitchSupported(){return!this.sdpModel.media.some((g=>g.type===je.MEDIA_TYPE.audio&&g.xMediaSettings&&this.containsMediaSetting(g.xMediaSettings,"codecswitchunsupported")))}toLocal(){return this.sdpModel=this.sdpTransform.toLocal(this.sdpModel,this.mediaManager,this.sessionType),of.write(this.sdpModel)}toOffer(){return this.toOfferAnswer()}toAnswer(){return this.toOfferAnswer()}toOfferAnswer(){const g="offer"===this.sessionType;return new hS(this.context.configProvider,this.logger).modify(this.sdpModel),(new cS).modify(this.sdpModel),g&&this.mediaManager.isEmpty()&&this.mediaManager.fromOffer(this.sdpModel,this.modalities),this.mediaManager.syncModalities(this.sdpModel,this.modalities,!g),this.sdpModel=g?this.sdpTransform.toOffer(this.sdpModel,this.mediaManager,this.modalities):this.sdpTransform.toAnswer(this.sdpModel,this.mediaManager,this.modalities),this.context.configProvider.config.disableMsSdp||new Cf(this.context,this.mediaManager,this.sessionType).modify(this.sdpModel),new rS(this.mediaManager,this.context.configProvider).modify(this.sdpModel),this.modalities=getModalities(this.sdpModel),of.write(this.sdpModel)}toRemote(g){return this.modalities=g,this.mediaManager.fromRemote(this.sdpModel,this.modalities),this.sdpModel=this.sdpTransform.toRemote(this.sdpModel,this.mediaManager,this.modalities,this.sessionType),of.write(this.sdpModel)}getVideoRecvCapabilities(){return getRecvCapabilitiesForMedia(this.getMediaByLabel(je.MEDIA_LABEL.video))}getSharingRecvCapabilities(){return getRecvCapabilitiesForMedia(this.getMediaByLabel(je.MEDIA_LABEL.sharing))}getMediaByType(g){return this.sdpModel.media.find((m=>m.type===g))}isUnbundled(){const g=this.sdpModel.groups?.find((g=>"BUNDLE"===g.type)),m=this.sdpModel.media.find((g=>g.type===je.MEDIA_TYPE.audio)),f=this.sdpModel.media.find((g=>g.type===je.MEDIA_TYPE.video));return g?!g.mids.toString().split(" ").find((g=>g===m.mid)):!!f}couldBeUnbundled(){return!this.sdpModel.groups?.find((g=>"BUNDLE"===g.type))||this.hasUnbundledIceCandidates()}containsMediaSetting(g,m){return g.some((g=>-1!==g.settings.indexOf(m)))}getMediaByLabel(g){return this.sdpModel.media.find((m=>m.label===g))}hasIceCandidatesForMediaType(g,m=""){const f=this.sdpModel.media?this.sdpModel.media.filter((m=>m.type===g&&!!m.candidates&&0!==m.candidates.length)):[];return m?f.some((g=>!!g.candidates&&g.candidates.some((g=>g.type===m)))):!!f.length}hasIceCandidates(){return this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.audio)||this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.video)}hasRelayIceCandidates(){return this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.audio,"relay")||this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.video,"relay")}hasUnbundledIceCandidates(){const g=this.sdpModel.media.filter((g=>g.type===je.MEDIA_TYPE.video&&0!==g.port));return this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.audio)&&(!g.length||this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.video))}hasUnbundledRelayIceCandidates(){const g=this.sdpModel.media.filter((g=>g.type===je.MEDIA_TYPE.video&&0!==g.port));return this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.audio,"relay")&&(!g.length||this.hasIceCandidatesForMediaType(je.MEDIA_TYPE.video,"relay"))}isIceRestart(){return this.mediaManager.getMediaEntities().some((g=>g.getExtension("iceRestart")))}isMSRTC(){return!!this.sdpModel.xMediaBw}insertFakeCandidateIfNeeded(g,m){this.hasIceCandidates()||(g.setFakeIceCandidate(!0),m&&(m.fakeIceCandidate=!0),(new uS).modify(this.sdpModel))}getBweType(){const g=this.sdpModel.media.find((g=>0!==g.port&&g.type===je.MEDIA_TYPE.video));if(!g)return"Unknown";const m=g.ext?.find((g=>g.uri===je.TRANSPORT_CC.EXT_URI||g.uri===je.TRANSPORT_CC.MSSDP_ENCODED_URI));return m?"SSBWE":"REMB"}fixDataModality(){new Af(this.mediaManager).modify(this.sdpModel)}getPayloadsForMedia(g){const m=this.sdpModel.media.find((m=>m.type===g&&0!==m.port));return m?.rtp??[]}},RS=class{constructor(g){this.context=g}createLocalOffer(g){return new PS(this.context,"offer",g)}createRemoteOffer(g){return new PS(this.context,"offer",g,!0)}createLocalAnswer(g){return new PS(this.context,"answer",g)}createRemoteAnswer(g){return new PS(this.context,"answer",g,!0)}},wS=class{static build(g){return new RS(g=g||{})}};function getSrtpReport(g){let m="";return g.dtls&&(m+="dtls"),g.sdes&&(m+="sdes"),m}var MS=class{constructor(){this.info={OfferedSrtp:"none",NegotiatedSrtp:"none",IceConnectionState:"none",IceConnectionStatePrevious:"none",SignalingState:"none",SignalingStatePrevious:"none",RelayCandidate:"none",IceTransportPolicy:"none",IceServers:"none",FakeIceCandidate:!1,BweType:"none",SdpSemantics:"none",BundlePolicy:"none",IPAddress:"none",ReflexiveLocalIP:"none",NumberOfInterfaces:0,EncodedStreamWorker:!1,AudioCodecEvents:"none"}}setCandidateDetails(g){"host"===g.type&&"udp"===g.protocol?this.setIPAddressInfo(g.ip):"srflx"===g.type&&this.setReflexiveLocalIP(g.ip)}setOfferedModalities(g){this.offeredModalities=g,this.activeModalities=g}setNegotiatedModalities(g){this.negotiatedModalities=g,this.activeModalities=g}setNegotiatedSrtpInfo(g){this.info.NegotiatedSrtp=getSrtpReport(g)}setOfferedSrtpInfo(g){this.info.OfferedSrtp=getSrtpReport(g)}setIceConnectionState(g){this.info.IceConnectionStatePrevious=this.info.IceConnectionState,this.info.IceConnectionState=g}setSignalingConnectionState(g){this.info.SignalingStatePrevious=this.info.SignalingState,this.info.SignalingState=g}setRelayCandidateInfo(g){this.info.RelayCandidate=JSON.stringify(g)}fillExtensionInfo(g){assign(g,this.info)}setIceTransportPolicy(g){this.info.IceTransportPolicy=g}setIceServers(g){const m=g.map((g=>{const m={...g};return m.username&&(m.username="true"),m.credential&&(m.credential="true"),m}));this.info.IceServers=JSON.stringify(m)}setFakeIceCandidate(g){this.info.FakeIceCandidate=g}setBweType(g){"Unknown"!==g&&(this.info.BweType=g)}setSdpSemantics(g){this.info.SdpSemantics=g}setBundlePolicy(g){this.info.BundlePolicy=g}setEncodedStreamWorkerLoaded(g){this.info.EncodedStreamWorker=g}setAudiocCodecEvents(g){this.info.AudioCodecEvents=JSON.stringify(g)}setCreateChannelFailReason(g){this.info.CreateChannelFailReason=stringifyObject(g)}setIPAddressInfo(g){this.info.NumberOfInterfaces+=1,"none"===this.info.IPAddress&&(this.info.IPAddress=g)}setReflexiveLocalIP(g){"none"===this.info.ReflexiveLocalIP&&(this.info.ReflexiveLocalIP=g)}},DS=class{constructor(g){this.audioContext=new Ws.window.AudioContext,this.sourceNode=this.audioContext.createMediaStreamSource(g),this.analyzerNode=this.createAnalyserNode(this.sourceNode)}dispose(){this.sourceNode.disconnect(),this.audioContext.close(),this.audioContext=null,this.sourceNode=null,this.analyzerNode=null}getInputLevel(){if(!this.analyzerNode)return 0;const g=new Uint8Array(this.analyzerNode.frequencyBinCount);return this.analyzerNode.getByteFrequencyData(g),Math.floor(65535*getAverage(g)/255)}createAnalyserNode(g){const m=this.audioContext.createAnalyser();return m.fftSize=1024,m.smoothingTimeConstant=.1,g.connect(m),m}},OS=class _TimerTracker{constructor(g){this.name=g,this.sharedState={mark:new Map,measure:[]}}mark(g,m){this.sharedState.mark.set(g,{name:g,ts:We(),startTime:Date.now(),details:m})}measure(g,m){const f=this.sharedState.mark.get(m.start),S=this.sharedState.mark.get(m.end);if(f&&S){const v={...m,parentName:this.name===g?"":this.name};this.sharedState.measure.push({name:g,details:v,duration:round(S.ts-f.ts),startTime:f.startTime})}}markAndMeasure(g,m,f,S){!1===this.sharedState.mark.has(m)&&this.mark(m,f);const v=this.sharedState.mark.get(g),C=this.sharedState.mark.get(m);if(v&&C){const g={...S,parentName:this.name===m?"":this.name};this.sharedState.measure.push({name:m,details:g,duration:round(C.ts-v.ts),startTime:v.startTime})}}clone(g){const m=new _TimerTracker(`${this.name}|${g}`);return m.setSharedState(this.sharedState),m}setSharedState(g){this.sharedState=g}getReport(){return this.sharedState.measure.map((g=>({name:g.name,duration:g.duration,ts:g.startTime,parentName:g.details.parentName})))}},NS=class _NoopTracker{mark(){}measure(){}markAndMeasure(){}clone(){return new _NoopTracker}getReport(){return[]}},kS=class{constructor(g){this.enableTimerTracker=g,this.timerTrackers={},this.timerTrackerOptions={}}getTimerTracker(g,m){if(!this.enableTimerTracker)return new NS;const f=new OS(g);if(this.timerTrackers[g]){const m=this.timerTrackerOptions[g];if(m?.first)return new NS;m?.last&&(this.timerTrackers[g]=[f]),m?.all&&this.timerTrackers[g].push(f)}else this.timerTrackers[g]=[f],this.timerTrackerOptions[g]=m;return f}getReport(){if(this.enableTimerTracker)return Object.keys(this.timerTrackers).reduce(((g,m)=>{const f=this.timerTrackerOptions[m];return(f.first||f.last)&&(g[m]=[this.timerTrackers[m][0]?.getReport()]),f.all&&(g[m]=Object.values(this.timerTrackers[m]).map((g=>g?.getReport()))),g}),{})}},LS=class{constructor(){this.presentationAPIUserDuration=0,this.presentationAudioDuration=0,this.isActiveScreenSharing=!1}handleInputLevel(g,m){this.isActiveScreenSharing&&("ScreenShare"===g&&m>0&&(this.presentationAPIUserDuration+=je.TIME_INTERVAL.SEC_1),"Audio"===g&&m>0&&(this.presentationAudioDuration+=je.TIME_INTERVAL.SEC_1))}updateScreenSharingStream(g,m){"ScreenShare"===m&&(this.isActiveScreenSharing=!!g)}getPresentationAudioDuration(){return this.presentationAudioDuration}getPresentationAudioAPIUserDuration(){return this.presentationAPIUserDuration}},FS=/profile-level-id=(.{6})/,xS=class{constructor(g,m,f=(()=>{}),S=(()=>this),v=(()=>{}),C=new ef,_){this.configProvider=g,this.dmDiagnostics=m,this.addSessionStatsError=f,this.newNativeSession=S,this.commitNativeSession=v,this.dshDiagnostics=C,this.getSessionRef=_,this.data={startTime:Date.now(),duration:0,offeredSrtp:"unknown",negotiatedSrtp:"unknown",iceConnectionState:"none",iceConnectionStatePrevious:"none",signalingState:"none",signalingStatePrevious:"none",relayCandidate:"none",iceTransportPolicy:"none",iceServers:"none",fakeIceCandidate:!1,bweType:"Unknown",sdpSemantics:"none",bundlePolicy:"none",iceCandidateErrors:[],H264Profiles:[],numInterfaces:0,statsReports:[],aggregatedModalityStats:{},multiViewStats:[],networkInfo:[],statsErrors:[],statsOnSubscribed:{},recvVideoStreamCount:{min:0,max:0,mode:0},sentBWSeed:void 0,reportedReceiveBandwidth:[],encodedStreamWorker:!1,audioCodecEvents:"none",totalVideoRecvMblocksRates:{macroblockRateReceivedMax:0,macroblockRateReceivedAvg:0,macroblockRateDecodedMax:0,macroblockRateDecodedAvg:0,macroblockRateMaxDecoderLossPercent:0,macroblockRateDecoderLossPercent:0},timerTrackerReport:{},loopIntervalMax:-1,loopIntervalMedian:-1,fetchTimeMax:-1,fetchTimeMedian:-1,codecSupport:void 0,videoPerformanceEvent:[],ovcToSubscriptionEvents:[],presentationAPIUserDuration:0,presentationAudioDuration:0,earlyMediaNumStatsPolls:0},this.timerTracker=new kS(this.configProvider.config.enableTimerTracker),this.presentationAudioTelemetry=new LS,addGetterFields(this.data,{duration:()=>this.data.endTime?this.data.endTime-this.data.startTime:Date.now()-this.data.startTime,bandwidthReport:()=>this.bandwidthStatsRef?.getBandwidthReport(),timerTrackerReport:()=>this.timerTracker.getReport(),presentationAPIUserDuration:()=>this.presentationAudioTelemetry.getPresentationAudioAPIUserDuration(),presentationAudioDuration:()=>this.presentationAudioTelemetry.getPresentationAudioDuration()}),Object.defineProperty(this.data,"IPAddress",{enumerable:!1,writable:!0,configurable:!0}),Object.defineProperty(this.data,"reflexiveLocalIP",{enumerable:!1,writable:!0,configurable:!0})}getTimerTracker(g,m){return this.timerTracker.getTimerTracker(g,m)}get deviceManager(){return this.dmDiagnostics}get audioLevel(){return this.analyzer?.getInputLevel()}get reflexiveLocalIP(){return this.data.reflexiveLocalIP}set bandwidthDiagnostic(g){this.bandwidthStatsRef=g}get callIsMuted(){return this.getSessionRef?.().callIsMuted}get sharingAudioLevel(){return this.analyzerSharing?.getInputLevel()}set offeredModalities(g){this.data.offeredModalities=g,this.data.activeModalities=g}set negotiatedModalities(g){this.data.negotiatedModalities=g,this.data.activeModalities=g}set offeredSrtp(g){this.data.offeredSrtp=getSrtpReport2(g)}set negotiatedSrtp(g){this.data.negotiatedSrtp=getSrtpReport2(g)}set iceConnectionState(g){this.data.iceConnectionStatePrevious=this.data.iceConnectionState,this.data.iceConnectionState=g}set signalingConnectionState(g){this.data.signalingStatePrevious=this.data.signalingState,this.data.signalingState=g}set relayCandidateInfo(g){this.data.relayCandidate=JSON.stringify(g)}set iceTransportPolicy(g){this.data.iceTransportPolicy=g}set iceServers(g){const m=g.map((g=>{const m={...g};return m.username&&(m.username="true"),m.credential&&(m.credential="true"),m}));this.data.iceServers=JSON.stringify(m)}set fakeIceCandidate(g){this.data.fakeIceCandidate=g}set bweType(g){this.data.bweType=g}set sdpSemantics(g){this.data.sdpSemantics=g}set isCodecsSupported(g){this.data.codecSupport=g}set bundlePolicy(g){this.data.bundlePolicy=g}set latestRawReport(g){this.data.latestRawReport=g}set recvVideoStreamsCount(g){this.data.recvVideoStreamCount=g}set aggregatedStatsRef(g){this.data.aggregatedModalityStats=g}set multiViewStats(g){this.data.multiViewStats=g}set videoCapabilities(g){if(!g?.codecs)return;const m=[];g.codecs.forEach((g=>{if("h264"===g.mimeType&&g.sdpFmtpLine){const f=FS.exec(g.sdpFmtpLine)?.[1];f&&m.push(f)}})),this.data.H264Profiles=[...new Set(this.data.H264Profiles.concat(m))]}set sentBWSeed(g){this.data.sentBWSeed=g}set reportedSendBandwidth(g){this.data.reportedSendBandwidth=g,(!this.data.reportedSendBandwidthMin||this.data.reportedSendBandwidthMin>g)&&(this.data.reportedSendBandwidthMin=g),(!this.data.reportedSendBandwidthMax||this.data.reportedSendBandwidthMax<g)&&(this.data.reportedSendBandwidthMax=g)}set maxSessionBandwidth(g){this.data.maxSessionBandwidth=g}set bwStabiliationTime(g){this.data.bwStabilizationTime=g}set bwDownlinkStabiliationTime(g){this.data.bwDownlinkStabilizationTime=g}set statsOnSubscribed(g){this.data.statsOnSubscribed=g}set loopIntervalMax(g){this.data.loopIntervalMax=g}set loopIntervalMedian(g){this.data.loopIntervalMedian=g}set fetchTimeMax(g){this.data.fetchTimeMax=g}set fetchTimeMedian(g){this.data.fetchTimeMedian=g}setTotalVideoRecvMblocksRates(g){this.data.totalVideoRecvMblocksRates=g}setCandidateDetails(g){"host"===g.type&&"udp"===g.protocol?(this.data.numInterfaces++,this.data.IPAddress||(this.data.IPAddress=g.ip)):"srflx"!==g.type||this.data.reflexiveLocalIP||(this.data.reflexiveLocalIP=g.ip)}setAudioSendStream(g,m){if(this.configProvider.config.useAudioAnalyzer){const f=new DS(g.rawStream);"ScreenShare"===m&&g.hasAudio()?(this.analyzerSharing?.dispose(),this.analyzerSharing=f):"Audio"===m&&(this.analyzer?.dispose(),this.analyzer=f)}}addNetworkInfo(g){arrayLimitedPush(this.data.networkInfo,g,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addIceCandidateError(g){this.data.iceCandidateErrors.push(g)}clearIceCandidateErrors(){this.data.iceCandidateErrors=[]}registerEarlyMediaPoll(){this.data.earlyMediaNumStatsPolls++}addReportedReceiveBandwidth(g){arrayLimitedPush(this.data.reportedReceiveBandwidth,g,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addOvcSubscriptionReport(g,m,f){const S=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];S?.ovc.count!==g&&arrayLimitedPush(this.data.ovcToSubscriptionEvents,{ovc:{ts:Date.now(),count:g,subsCount:m,...f},subs:[]},this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples)}addSubscriptionToOvcEvent(g){const m=this.data.ovcToSubscriptionEvents[this.data.ovcToSubscriptionEvents.length-1];m&&m.subs.push({ts:Date.now(),count:g})}addStatsReport(g){arrayLimitedPush(this.data.statsReports,g,this.configProvider.config.diagnostics.collectionLimits.numStatsReports)}addStatsError(g,m){const f=this.data.statsErrors.find((f=>f.error===m&&f.origin===g));f?f.count++:arrayLimitedPush(this.data.statsErrors,{origin:g,error:m,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors),this.addSessionStatsError(`nativeSession:${g}`,m)}setPresentationAudioOnScreenSharing(g,m){this.presentationAudioTelemetry.updateScreenSharingStream(g,m)}handlePresentationAudioInputLevel(){this.presentationAudioTelemetry.handleInputLevel("Audio",this.audioLevel),this.presentationAudioTelemetry.handleInputLevel("ScreenShare",this.sharingAudioLevel)}terminate(){this.data.endTime=Date.now(),this.analyzer?.dispose(),this.analyzer=null,this.analyzerSharing?.dispose(),this.analyzerSharing=null}newQualityManagerDiagnostics(){const g=new nf(this.configProvider,((g,m)=>this.addStatsError(`qualityManagerDiagnostics:${g}`,m)));return this.data.qualityManager=g.getObjectRef(),g}newRemoteVideoManagerDiagnostics(){const g=new rf(this.configProvider);return this.data.remoteVideoManager=g.getObjectRef(),g}newSubscriptionManagerDiagnostics(){const g=new tf(this.configProvider,(g=>this.addStatsError("subscriptionManagerDiagnostics",g)));return this.data.subscriptionManager=g.getObjectRef(),g}set encodedStreamWorker(g){this.data.encodedStreamWorker=g}set audioCodecEvents(g){this.data.audioCodecEvents=g}getObjectRef(){return this.data}registerVideoPerformanceEvent(g,m){const f={type:m,perfEvent:g,resRequestEvent:null,resChangedEvent:[]};this.data.videoPerformanceEvent=this.data.videoPerformanceEvent.concat(f)}registerResolutionChanageRequest(g){const m=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];m&&(m.resRequestEvent=g)}registerResolutionChanageEvent(g){const m=this.data.videoPerformanceEvent[this.data.videoPerformanceEvent.length-1];g.ts-m?.resRequestEvent.ts<this.configProvider.config.diagnostics.performanceMonitoring.telemetryResolutionRequestSpanMs&&m.resChangedEvent.push(g)}};function getSrtpReport2(g){let m="";return g.dtls&&(m+="dtls"),g.sdes&&(m+="sdes"),m}var US=Symbol("sessionDiagnosticsRef"),VS=class{constructor(g,m,f,S,v,C){this.logger=g,this.configProvider=m,this.diagnosticsReport=f,this.dmDiagnostics=S,this.dshDiagnostics=new ef,this.data={creationTime:Date.now(),callNumber:0,sessionId:"unknown",isMultiParty:!1,dtmfSuccessCount:0,dtmfFailureCount:0,iceInitTime:0,iceConnectedStateTime:0,negotiationCount:0,rejectedNegotiationCount:0,initialNegotiationCompleted:!1,finalAnswerTime:0,transportReconnectedCount:0,rollbackNegotiation:[],activeModalities:{},allowedAudioSend:!0,allowedVideoSend:!0,allowedScreensharingSend:!0,noIceCandidatesEventCount:{good:0,bad:0},noRelayIceCandidatesEventCount:{good:0,bad:0},microphoneInUseEventCount:{good:0,bad:0},cameraInUseEventCount:{good:0,bad:0},cameraFreezeEventCount:{start:0,end:0},rawMedia:{audio:{recv:{numAttempts:0,durationRatio:0},send:{numAttempts:0,durationRatio:0}}},ufds:[],statsErrors:[],webrtcSessions:[],isOngoing:!1,duration:0,callMutedRatio:0,callOsMuted:0,callHwSilent:0,callSwMuted:0,callIsMuted:!1,callSpeakerMuted:0,callIsSpeaking:0,networkRecvUFD:void 0,networkSendUFD:void 0,deviceManager:void 0,relayTimers:void 0,dominantSpeaker:this.dshDiagnostics.getObjectRef(),[US]:this},this.transportDisconnected=!1,this.commonMuteTracker=new HS,this.swMuteTracker=new HS,this.osMuteTracker=new HS,this.speakerMuteTracker=new HS,this.hwSilentTracker=new HS,this.isSpeakingTracker=new HS,this.networkRecv=new $S,this.networkSend=new $S,this.rawMediaTimers={audio:{send:new HS,recv:new HS}},this.dmFragmenter=new BS(this.dmDiagnostics),this.durationTimer=new HS,this.data.callNumber=v,this.data.sessionId=C,this.durationTimer.start(),addGetterFields(this.data,{isOngoing:()=>void 0===this.data.terminationTime,duration:()=>this.durationTimer.elapsed,callMutedRatio:()=>getDurationRatio(this.commonMuteTracker.elapsed,this.data.duration),callOsMuted:()=>this.osMuteTracker.elapsed,callHwSilent:()=>this.hwSilentTracker.elapsed,callSwMuted:()=>this.swMuteTracker.elapsed,callIsMuted:()=>this.swMuteTracker.isRunning,callSpeakerMuted:()=>this.speakerMuteTracker.elapsed,callIsSpeaking:()=>this.isSpeakingTracker.elapsed,networkRecvUFD:()=>({good:this.networkRecv.getCount("Good"),poor:this.networkRecv.getCount("Poor"),bad:this.networkRecv.getCount("Bad"),goodRatio:getDurationRatio(this.networkRecv.getElapsed("Good"),this.data.duration),poorRatio:getDurationRatio(this.networkRecv.getElapsed("Poor"),this.data.duration),badRatio:getDurationRatio(this.networkRecv.getElapsed("Bad"),this.data.duration)}),networkSendUFD:()=>({good:this.networkSend.getCount("Good"),poor:this.networkSend.getCount("Poor"),bad:this.networkSend.getCount("Bad"),goodRatio:getDurationRatio(this.networkSend.getElapsed("Good"),this.data.duration),poorRatio:getDurationRatio(this.networkSend.getElapsed("Poor"),this.data.duration),badRatio:getDurationRatio(this.networkSend.getElapsed("Bad"),this.data.duration)}),deviceManager:()=>this.dmFragmenter.getFragment(this.dmDiagnostics),relayTimers:()=>this.relayManagerTimers?.getStats()}),addGetterFields(this.data.rawMedia.audio.recv,{durationRatio:()=>getDurationRatio(this.rawMediaTimers.audio.recv.elapsed,this.data.duration)}),addGetterFields(this.data.rawMedia.audio.send,{durationRatio:()=>getDurationRatio(this.rawMediaTimers.audio.send.elapsed,this.data.duration)})}get telemetryReport(){const g={type:"WebRtcMediaStats",data:this.diagnosticsReport.getSessionTelemetry(this.data.sessionId)},m={};return forOwnRec(g.data,((g,f,S)=>{let v=0;zs.test(g)?(v=13,m[f]="IPv4"):Ks.test(g)&&(v=4,m[f]="IPv6"),S[f]={type:v,value:g,__VALUE__:!0}})),g.data.metrics.piiFields={type:0,value:JSON.stringify(m),__VALUE__:!0},g}get mediaStatsReport(){return this.diagnosticsReport.getMediaSessionStats(this.data.sessionId)}get realtimeTelemetryReport(){return this.diagnosticsReport.getTeamsRealtimeTelemetry(this.data.sessionId)}get e2eDiagnostics(){return this.diagnosticsReport.getDiagnosticsForE2eTests(this.data.sessionId)}set relayManager(g){this.relayManagerTimers=g}set isMultiParty(g){this.data.isMultiParty=g}set mediaLegId(g){this.data.mediaLegId=g.process()}set ETag(g){this.data.ETag=g}set configIds(g){this.data.configIds=g}set reconnect(g){this.data.reconnect=g}set relay(g){this.data.relay={address:g.addresses.join(),expires:g.expires,realm:g.realm,credentials:!(!g.username||!g.password),ports:[g.udpPort?`udp:${g.udpPort}`:"",g.tcpPort?`tcp:${g.tcpPort}`:"",g.tlsPort?`tls:${g.tlsPort}`:""].join(","),fqdns:g.fqdns?g.fqdns.join():"none"}}set sessionError(g){this.data.error=g}set dtmfResult(g){g?this.data.dtmfSuccessCount++:this.data.dtmfFailureCount++}set swMute(g){g?this.swMuteTracker.start():this.swMuteTracker.stop(),this.updateCommonMute()}set speakerMute(g){g?this.speakerMuteTracker.start():this.speakerMuteTracker.stop()}set hwSilent(g){g?this.hwSilentTracker.start():this.hwSilentTracker.stop()}set isSpeaking(g){g?this.isSpeakingTracker.start():this.isSpeakingTracker.stop()}set iceInitTime(g){this.data.iceInitTime||(this.data.iceInitTime=g)}set finalAnswerTime(g){var m;(m=this.data).finalAnswerTime??(m.finalAnswerTime=g)}set iceConnectedStateTimestamp(g){this.data.iceConnectedStateTime||(this.data.iceConnectedStateTime=g)}set allowedModalities(g){this.data.allowedAudioSend=g.audio.some((g=>hasSendDirectionality(g))),this.data.allowedVideoSend=g.video.some((g=>hasSendDirectionality(g))),this.data.allowedScreensharingSend=g.sharing.some((g=>hasSendDirectionality(g)))}negotiationStart(g){var m;(m=this.data).initialNegotiationType??(m.initialNegotiationType=g),this.data.negotiationCount++}negotiationCompleted(g){this.data.initialNegotiationCompleted=!0,this.data.activeModalities=g,this.data.error=void 0}negotiationRejected(){this.data.rejectedNegotiationCount++}registerRollbackEvent(g){this.data.rollbackNegotiation.push({type:g.type,attempt:this.data.rollbackNegotiation.length+1,error:g.error})}registerRawMediaAccess(g,m,f){const S=this.data.rawMedia[g]?.[m];if(S){S.numAttempts++;const v=this.rawMediaTimers[g]?.[m];f?v?.start():v?.stop()}}registerQualityStateChangedEvent(g){switch(g.type){case"NoNetwork":"Good"===g.value?this.data.noIceCandidatesEventCount.good++:this.data.noIceCandidatesEventCount.bad++;break;case"NetworkRelaysNotReachable":"Good"===g.value?this.data.noRelayIceCandidatesEventCount.good++:this.data.noRelayIceCandidatesEventCount.bad++;break;case"DeviceCaptureNotFunctioning":"Good"===g.value?this.data.microphoneInUseEventCount.good++:this.data.microphoneInUseEventCount.bad++;break;case"VideoCapturerDeviceStartFailed":"Good"===g.value?this.data.cameraInUseEventCount.good++:this.data.cameraInUseEventCount.bad++;break;case"DeviceCaptureMute":"Bad"===g.value?this.osMuteTracker.start():this.osMuteTracker.stop(),this.updateCommonMute();break;case"NetworkRecvQuality":this.networkRecv.updateLevel(g.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(g.value);break;case"VideoCaptureDeviceFreeze":"Good"===g.value?this.data.cameraFreezeEventCount.end++:this.data.cameraFreezeEventCount.start++}"DeviceSpeakWhileMuted"!==g.type&&arrayLimitedPush(this.data.ufds,{...g,timestamp:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numUFDs)}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.data.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}terminated(g){this.data.terminationReason=deepClone(g),this.data.terminationTime=Date.now(),this.durationTimer.stop(),this.swMuteTracker.stop(),this.speakerMuteTracker.stop(),this.hwSilentTracker.stop(),this.isSpeakingTracker.stop(),this.dmFragmenter.terminated(this.dmDiagnostics)}addStatsError(g,m){const f=this.data.statsErrors.find((f=>f.error===m&&f.origin===g));this.logger.safe.error(`Stats error from '${g}': ${m} (${f?.count??1})`),f?f.count++:arrayLimitedPush(this.data.statsErrors,{origin:g,error:m,count:1},this.configProvider.config.diagnostics.collectionLimits.numStatsErrors)}newNativeSessionDiag(g=!0){let m;return m=new xS(this.configProvider,this.dmDiagnostics,((g,m)=>this.addStatsError(g,m)),(g=>this.newNativeSessionDiag(g)),(()=>this.pushNativeSessionDiag(m.getObjectRef())),this.dshDiagnostics.resetState(),(()=>this.getObjectRef())),g&&arrayLimitedPush(this.data.webrtcSessions,m.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numNativeSessions),m}pushNativeSessionDiag(g){arrayLimitedPush(this.data.webrtcSessions,g,this.configProvider.config.diagnostics.collectionLimits.numNativeSessions)}getObjectRef(){return this.data}updateCommonMute(){this.swMuteTracker.isRunning||this.osMuteTracker.isRunning?this.commonMuteTracker.start():this.swMuteTracker.isRunning||this.osMuteTracker.isRunning||this.commonMuteTracker.stop()}},BS=class{constructor(g){this.fragmentBase=this.sanitizeDiagnostics(g)}getFragment(g){const m=this.fragmentTerminated??g;return{devicesChangeCount:m.devicesChangeCount-this.fragmentBase.devicesChangeCount,deviceSelectionChangeCount:m.deviceSelectionChangeCount-this.fragmentBase.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:m.deviceSelectionChangeCountFromInterface-this.fragmentBase.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:m.devicesPollChangeCount-this.fragmentBase.devicesPollChangeCount}}terminated(g){this.fragmentTerminated=this.sanitizeDiagnostics(g)}sanitizeDiagnostics(g){return{devicesChangeCount:g.devicesChangeCount,deviceSelectionChangeCount:g.deviceSelectionChangeCount,deviceSelectionChangeCountFromInterface:g.deviceSelectionChangeCountFromInterface,devicesPollChangeCount:g.devicesPollChangeCount}}},HS=class{constructor(){this.startTime=0,this.elapsedInternal=0,this.countInternal=0}get isRunning(){return!!this.startTime}get elapsed(){return Math.round(this.startTime?this.elapsedInternal+We()-this.startTime:this.elapsedInternal)}get count(){return this.countInternal}start(){this.startTime||(this.startTime=We(),this.countInternal++)}stop(){this.startTime&&(this.elapsedInternal+=We()-this.startTime,this.startTime=0)}},$S=class{constructor(){this.currentLevel="Good",this.stopWatches={},this.getStopWatch(this.currentLevel).start()}updateLevel(g){this.currentLevel!==g&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=g,this.getStopWatch(this.currentLevel).start())}getCount(g){const m=this.stopWatches[g];return m?m.count:0}getElapsed(g){const m=this.stopWatches[g];return m?m.elapsed:0}getStopWatch(g){let m=this.stopWatches[g];return m||(m=new HS,this.stopWatches[g]=m),m}};function getDurationRatio(g,m){return g/(0!==m?m:1)}function compileAudioReport(g,m,f){return removeUndefinedFields({recv:removeUndefinedFields({id:m?.inboundRTP.id,ssrc:m?.inboundRTP.ssrc,mediaType:m?.inboundRTP.mediaType??m?.inboundRTP.kind,bytesReceived:sampleseries(g.audio?.recv,(g=>g.inboundRTP.bytesReceived)),packetsReceived:sampleseries(g.audio?.recv,(g=>g.inboundRTP.packetsReceived)),packetsLost:sampleseries(g.audio?.recv,(g=>g.inboundRTP.packetsLost)),googCodecName:m?.codec?.mimeType.split("/")[1],googTrackId:m?.track?.trackIdentifier,transport_id:m?.transport?.id,transportId:m?.inboundRTP.transportId,transport_selectedCandidatePairId:m?.transport?.selectedCandidatePairId,transport_dtlsCipher:m?.transport?.dtlsCipher,transport_srtpCipher:m?.transport?.srtpCipher,pair_id:m?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:m?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:m?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:m?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:m?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(g.audio?.recv,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:m?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:m?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:m?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:m?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:m?.transport?.selectedCandidatePair?.localCandidate?.ip??m?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:m?.transport?.selectedCandidatePair?.remoteCandidate?.ip??m?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(g.audio?.recv,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:m?.transport?.selectedCandidatePair?.nominated}),send:removeUndefinedFields({id:f?.outboundRTP.id,ssrc:f?.outboundRTP.ssrc,mediaType:f?.outboundRTP.mediaType??f?.outboundRTP.kind,bytesSent:sampleseries(g.audio?.send,(g=>g.outboundRTP.bytesSent)),packetsSent:sampleseries(g.audio?.send,(g=>g.outboundRTP.packetsSent)),packetsLost:sampleseries(g.audio?.send,(g=>g.remoteInboundRTP?.packetsLost)),googCodecName:f?.codec?.mimeType.split("/")[1],googTrackId:f?.track?.trackIdentifier,transport_id:f?.transport?.id,transportId:f?.outboundRTP.transportId,transport_selectedCandidatePairId:f?.transport?.selectedCandidatePairId,transport_dtlsCipher:f?.transport?.dtlsCipher,transport_srtpCipher:f?.transport?.srtpCipher,pair_id:f?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:f?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:f?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:f?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:f?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(g.audio?.send,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:f?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:f?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:f?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:f?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:f?.transport?.selectedCandidatePair?.localCandidate?.ip??f?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:f?.transport?.selectedCandidatePair?.remoteCandidate?.ip??f?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(g.audio?.send,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:f?.transport?.selectedCandidatePair?.nominated})})}function compileVideoTelemetryReport(g,m,f,S){return removeUndefinedFields({recv:removeUndefinedFields({id:f?.inboundRTP.id,ssrc:f?.inboundRTP.ssrc,mediaType:f?.inboundRTP.mediaType??f?.inboundRTP.kind,bytesReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.bytesReceived)),packetsReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.packetsReceived)),packetsLost:sampleseries(m[g]?.recv,(g=>g.inboundRTP.packetsLost)),googCodecName:f?.codec?.mimeType.split("/")[1],codecImplementationName:f?.inboundRTP.decoderImplementation,googTrackId:f?.track?.trackIdentifier,transport_id:f?.transport?.id,transportId:f?.inboundRTP.transportId,transport_selectedCandidatePairId:f?.transport?.selectedCandidatePairId,transport_dtlsCipher:f?.transport?.dtlsCipher,transport_srtpCipher:f?.transport?.srtpCipher,pair_id:f?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:f?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:f?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:f?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:f?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(m[g]?.recv,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:f?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:f?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:f?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:f?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:f?.transport?.selectedCandidatePair?.localCandidate?.ip??f?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:f?.transport?.selectedCandidatePair?.remoteCandidate?.ip??f?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(m[g]?.recv,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:f?.transport?.selectedCandidatePair?.nominated,framesDecoded:sampleseries(m[g]?.recv,(g=>g.inboundRTP.framesDecoded)),googFrameHeightReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.frameHeight)),googFrameWidthReceived:sampleseries(m[g]?.recv,(g=>g.inboundRTP.frameWidth)),googFrameRateReceived:sampleseries(m[g]?.recv,(g=>g.extensions?.frameRateReceived||0)),googNacksSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.nackCount)),googPlisSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.pliCount)),keyFramesDecoded:sampleseries(m[g]?.recv,(g=>g.inboundRTP.keyFramesDecoded)),googFirsSent:sampleseries(m[g]?.recv,(g=>g.inboundRTP.firCount)),googJitterBufferMs:sampleseries(m[g]?.recv,(g=>g.extensions?.jitterBufferMs)),googFrameRateDecoded:sampleseries(m[g]?.recv,(g=>g.extensions?.frameRateDecoded||0)),googFrameRateOutput:f?.extensions?.trackRecvFps,jitter:f?.inboundRTP.jitter}),send:removeUndefinedFields({id:S?.outboundRTP.id,ssrc:S?.outboundRTP.ssrc,mediaType:S?.outboundRTP.mediaType??S?.outboundRTP.kind,bytesSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.bytesSent)),packetsSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.packetsSent)),packetsLost:sampleseries(m[g]?.send,(g=>g.remoteInboundRTP?.packetsLost)),googCodecName:S?.codec?.mimeType.split("/")[1],codecImplementationName:S?.outboundRTP.encoderImplementation,googTrackId:S?.track?.trackIdentifier,transport_id:S?.transport?.id,transportId:S?.outboundRTP.transportId,transport_selectedCandidatePairId:S?.transport?.selectedCandidatePairId,transport_dtlsCipher:S?.transport?.dtlsCipher,transport_srtpCipher:S?.transport?.srtpCipher,pair_id:S?.transport?.selectedCandidatePair?.id,pair_responsesSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.responsesSent)),pair_requestsReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.requestsReceived)),pair_googRemoteCandidateType:S?.transport?.selectedCandidatePair?.remoteCandidate?.candidateType,pair_consentRequestsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.consentRequestsSent)),pair_googTransportType:S?.transport?.selectedCandidatePair?.localCandidate?.protocol,pair_googLocalCandidateType:S?.transport?.selectedCandidatePair?.localCandidate?.candidateType,pair_googWritable:S?.transport?.selectedCandidatePair?.writable,pair_requestsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.requestsSent)),pair_googRtt:sampleseries(m[g]?.send,(g=>1e3*g.transport?.selectedCandidatePair?.currentRoundTripTime),!0),pair_googActiveConnection:S?.transport?.selectedCandidatePair?.nominated,pair_packetsDiscardedOnSend:S?.transport?.selectedCandidatePair?.packetsDiscardedOnSend,pair_bytesReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.bytesReceived)),pair_responsesReceived:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.responsesReceived)),pair_remoteCandidateId:S?.transport?.selectedCandidatePair?.remoteCandidate?.id,pair_localCandidateId:S?.transport?.selectedCandidatePair?.localCandidate?.id,pair_packetsSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.packetsSent)),pair_googLocalAddress:S?.transport?.selectedCandidatePair?.localCandidate?.ip??S?.transport?.selectedCandidatePair?.localCandidate?.address,pair_googRemoteAddress:S?.transport?.selectedCandidatePair?.remoteCandidate?.ip??S?.transport?.selectedCandidatePair?.remoteCandidate?.address,pair_bytesSent:sampleseries(m[g]?.send,(g=>g.transport?.selectedCandidatePair?.bytesSent)),pair_googReadable:S?.transport?.selectedCandidatePair?.nominated,framesEncoded:sampleseries(m[g]?.send,(g=>g.outboundRTP.framesEncoded)),googNacksReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.nackCount)),googPlisReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.pliCount)),googFirsReceived:sampleseries(m[g]?.send,(g=>g.outboundRTP.firCount)),keyFramesEncoded:sampleseries(m[g]?.send,(g=>g.outboundRTP.keyFramesEncoded)),googFrameHeightInput:S?.mediaSource?.height,googFrameWidthInput:S?.mediaSource?.width,googFrameRateInput:sampleseries(m[g]?.send,(g=>g.mediaSource?.framesPerSecond)),googFrameHeightSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.frameHeight)),googFrameWidthSent:sampleseries(m[g]?.send,(g=>g.outboundRTP.frameWidth)),googFrameRateSent:sampleseries(m[g]?.send,(g=>g.extensions?.frameRateSent)),googRtt:sampleseries(m[g]?.send,(g=>1e3*(g.remoteInboundRTP?.roundTripTime??0)),!0),hugeFramesSent:S?.outboundRTP.hugeFramesSent,qpSum:sampleseries(m[g]?.send,(g=>g.outboundRTP.qpSum)),qualityLimitationDurations:S?JSON.stringify(S?.outboundRTP.qualityLimitationDurations):void 0,qualityLimitationReason:S?.outboundRTP.qualityLimitationReason,qualityLimitationResolutionChanges:S?.outboundRTP.qualityLimitationResolutionChanges,jitter:S?.remoteInboundRTP?.jitter})})}function compileExtensionsTelemetryReport(g,m,f){const S=g.aggregatedModalityStats,v=getLast(S.audio?.recv),C=getLast(S.audio?.send),_=getLast(S.video?.recv),E=getLast(S.video?.send),T=getLast(S.sharing?.recv),I=getLast(S.sharing?.send),getMaxCapsEvents=f=>g.qualityManager&&limitArraySize(deepClone(f).map((f=>rebaseTime(limitArraySize(f.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested),b=getMaxCapsEvents(g.qualityManager.videoMaxCapabilitiesEvents),A=getMaxCapsEvents(g.qualityManager.videoMaxCapabilitiesErrors),P=getMaxCapsEvents(g.qualityManager.sharingMaxCapabilitiesEvents),R=getMaxCapsEvents(g.qualityManager.sharingMaxCapabilitiesErrors),w="REMB"!==g.bweType?g.bandwidthReport:void 0,M="REMB"===g.bweType?g.bandwidthReport:void 0,D=[],O=[];return g.statsOnSubscribed.video?.forEach((g=>D.push(g))),g.statsOnSubscribed.sharing?.forEach((g=>O.push(g))),removeUndefinedFields({BundlePolicy:g.bundlePolicy,FakeIceCandidate:g.fakeIceCandidate,H264_available_profiles:JSON.stringify(g.H264Profiles),IceConnectionState:g.iceConnectionState,IceConnectionStatePrevious:g.iceConnectionStatePrevious,IceServers:g.iceServers,IceTransportPolicy:g.iceTransportPolicy,NegotiatedSrtp:JSON.stringify(g.negotiatedSrtp),OfferedSrtp:JSON.stringify(g.offeredSrtp),RelayCandidate:g.relayCandidate,SdpSemantics:g.sdpSemantics,iceCandidateErrors:JSON.stringify(g.iceCandidateErrors),SignalingState:g.signalingState,SignalingStatePrevious:g.signalingStatePrevious,WebRTCStats_statsErrors:JSON.stringify(f),MaxSessionBandwidth:g.maxSessionBandwidth,Bandwidth_uplinkStabilizationTime:JSON.stringify(g.bwStabilizationTime),Bandwidth_downlinkStabilizationTime:JSON.stringify(g.bwDownlinkStabilizationTime),totalVideoControlMessages:g.qualityManager?.numVideoControlMessages,outOfOrderVideoControlMessages:g.qualityManager?.numOutOfOrderVideoControlMessages,webcamFreezeIntervals:g.qualityManager?.numWebcamFreezeIntervals,processedStreamFreezeIntervals:g.qualityManager?.numProcessedStreamFreezeIntervals,Connection:removeUndefinedFields({DownLink:sampleseries(g.networkInfo,(g=>g.downlink)),EffectiveType:sampleseries(g.networkInfo,(g=>g.effectiveType)),Rtt:sampleseries(g.networkInfo,(g=>g.rtt)),SaveData:getLast(g.networkInfo)?.saveData}),IPAddress:g.IPAddress??"none",ReflexiveLocalIP:g.reflexiveLocalIP??"none",NumberOfInterfaces:g.numInterfaces,StartTime:g.startTime,EndTime:g.endTime,AudioTransportRecvBitrate:v?.transport?.extensions?.recvBWAvg,AudioTransportSendBitrate:v?.transport?.extensions?.sendBWAvg,AudioPayloadRecvBitrate:v?.aggregated?.bitrateAvg,AudioPayloadSendBitrate:C?.aggregated?.bitrateAvg,VideoPayloadRecvBitrate:_?.aggregated?.bitrateAvg,VideoPayloadSendBitrate:E?.aggregated?.bitrateAvg,WebRTCStats_bweStat_googAvailableReceiveBandwidth:sampleseries(S.video?.recv,(g=>g.transport?.selectedCandidatePair?.availableIncomingBitrate))??sampleseries(S.video?.send,(g=>g.transport?.selectedCandidatePair?.availableIncomingBitrate)),WebRTCStats_bweStat_googAvailableSendBandwidth:sampleseries(S.video?.send,(g=>g.transport?.selectedCandidatePair?.availableOutgoingBitrate))??sampleseries(S.video?.recv,(g=>g.transport?.selectedCandidatePair?.availableOutgoingBitrate)),ReportedSendBWMax:g.reportedSendBandwidthMax,ReportedSendBWMin:g.reportedSendBandwidthMin,Bandwidth_jumpsHistogram:JSON.stringify(E?.transport?.extensions?.bwJumpsHistogram),StartCallBWESendSide:JSON.stringify(w?.startOfTheCall),EndCallBWESendSide:JSON.stringify(w?.endOfTheCall),BWEStdSendSide:JSON.stringify(w?.std),BwPercentilesSendSide:JSON.stringify(w?.bwPercentiles),AvgBwSendSide:JSON.stringify(w?.avgBwe),StartCallBWE:JSON.stringify(M?.startOfTheCall),EndCallBWE:JSON.stringify(M?.endOfTheCall),BWEStd:JSON.stringify(M?.std),BwPercentiles:JSON.stringify(M?.bwPercentiles),AvgBw:JSON.stringify(M?.avgBwe),WebRTCStats_ssrc:removeUndefinedFields({audio:compileAudioReport(S,v,C),video:compileVideoTelemetryReport("video",S,_,E),sharing:compileVideoTelemetryReport("sharing",S,T,I)}),Audio_recv_jitterBufferAvgSize:v?.aggregated?.avgJitterBufferSize,Audio_recv_packetsLostRateMax:v?.aggregated?.lossRateMax,Audio_recv_jitterAvg:v?.aggregated?.jitterAvg,Audio_recv_networkAvgLossRate:v?.aggregated?.networkAvgLossRate,Audio_send_rttAvg:C?.aggregated?.rttAvg&&round(1e3*C.aggregated.rttAvg),Audio_send_rttMax:C?.aggregated?.rttMax&&round(1e3*C.aggregated.rttMax),Audio_send_RawInputVolume:sampleseries(S.audio?.send,(g=>g.aggregated?.rawInputVolume)),Audio_send_packetsLostRateMax:C?.aggregated?.lossRateMax,Audio_send_presentationAPIUserDuration:g.presentationAPIUserDuration,Audio_send_presentationDuration:g.presentationAudioDuration,Video_recv_DurationSeconds:_?.aggregated?.duration,Video_recv_FreezeHistogram:JSON.stringify(_?.aggregated?.freezeCountHistogram),Video_recv_FreezeTimestamps:JSON.stringify(rebaseHistogramTimestamps(_?.aggregated?.freezeTimestampsHistogram,g.startTime)),Video_recv_LongestFreezeDuration:_?.aggregated?.longestFreeze,Video_recv_OngoingFreeze:_?.extensions?.isFrozen,Video_recv_OngoingFreezeDuration:_?.aggregated?.ongoingFreezeDuration,Video_recv_TotalFreezeDuration:_?.aggregated?.totalFreezeDuration,Video_recv_RecvAvgFreezeDuration:_?.aggregated?.avgFreezeDuration,Video_recv_NumResolutionSwitches:_?.aggregated?.numResolutionSwitches,Video_recv_ResolutionDurations:JSON.stringify(_?.aggregated?.resolutionDurations),Video_recv_StreamsMax:g.recvVideoStreamCount.max,Video_recv_StreamsMin:g.recvVideoStreamCount.min,Video_recv_StreamsMode:g.recvVideoStreamCount.mode,Video_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameVideo,Video_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.firstTimeToFirstFrameVideo,Video_recv_bitrateAvg:_?.aggregated?.bitrateAvg,Video_recv_bitrateMax:_?.aggregated?.bitrateMax,Video_recv_frameRateAvg:_?.aggregated?.avgFrameRate,Video_recv_jitterBufferAvgSize:_?.aggregated?.avgJitterBufferSize,Video_recv_packetsLostRateMax:_?.aggregated?.lossRateMax,Video_recv_isRenderingEvents:JSON.stringify(limitArraySize(g.remoteVideoManager.isRenderingEvents.video,m.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Video_recv_FpsHarmonicAverage:_?.aggregated?.fpsHarmonicAverage,Video_recv_PreferredResolution:g.remoteVideoManager.preferredResolution.video?.toString(),Video_recv_statsOnSubscribed:JSON.stringify(D),Video_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.video.events,"ts",g.startTime)),Video_SubscriptionCounters:JSON.stringify(g.subscriptionManager?.video.counters),Video_send_CaptureFramerateAvg:E?.aggregated?.captureFramerateAvg,Video_send_DurationSeconds:E?.aggregated?.duration,Video_send_FreezeIntervals:E?.extensions?.captureFreezeIntervalsCount,Video_send_MaxCapabilities:JSON.stringify(b),Video_send_MaxCapabilitiesErrors:JSON.stringify(A),Video_send_OvershootDurations:JSON.stringify({fs:E?.aggregated?.totalFsOvershootDuration,fps:E?.aggregated?.totalFpsOvershootDuration,br:E?.aggregated?.totalBrOvershootDuration}),Video_send_OvershootEvents:JSON.stringify(rebaseTime(E?.aggregated.overshootEvents,"timestamp",g.startTime)),Video_send_QpAvg:E?.aggregated?.qpAvg,Video_send_bitrateAvg:E?.aggregated?.bitrateAvg,Video_send_bitrateMax:E?.aggregated?.bitrateMax,Video_send_frameRateAvg:E?.aggregated?.frameRateAvg,Video_send_AllocateBWAvg:E?.aggregated?.bweAvg,Video_send_CameraOpenWidth:E?.extensions?.cameraOpenResolution?.width,Video_send_CameraOpenHeight:E?.extensions?.cameraOpenResolution?.height,Video_send_packetsLostRateMax:E?.aggregated?.lossRateMax,Video_send_resolutionSwitches:JSON.stringify(E?.aggregated?.resolutionSwitches),Sharing_recv_DurationSeconds:T?.aggregated?.duration,Sharing_recv_FreezeHistogram:JSON.stringify(T?.aggregated?.freezeCountHistogram),Sharing_recv_FreezeTimestamps:JSON.stringify(rebaseHistogramTimestamps(T?.aggregated?.freezeTimestampsHistogram,g.startTime)),Sharing_recv_LongestFreezeDuration:T?.aggregated?.longestFreeze,Sharing_recv_OngoingFreeze:T?.extensions?.isFrozen,Sharing_recv_TotalFreezeDuration:T?.aggregated?.totalFreezeDuration,Sharing_recv_RecvAvgFreezeDuration:T?.aggregated?.avgFreezeDuration,Sharing_recv_NumResolutionSwitches:T?.aggregated?.numResolutionSwitches,Sharing_recv_ResolutionDurations:JSON.stringify(T?.aggregated?.resolutionDurations),Sharing_recv_StreamsMax:g.recvVideoStreamCount.max,Sharing_recv_StreamsMin:g.recvVideoStreamCount.min,Sharing_recv_StreamsMode:g.recvVideoStreamCount.mode,Sharing_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameSharing,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.firstTimeToFirstFrameVideo,Sharing_recv_bitrateAvg:T?.aggregated?.bitrateAvg,Sharing_recv_bitrateMax:T?.aggregated?.bitrateMax,Sharing_recv_frameRateAvg:T?.aggregated?.avgFrameRate,Sharing_recv_jitterBufferAvgSize:T?.aggregated?.avgJitterBufferSize,Sharing_recv_packetsLostRateMax:T?.aggregated?.lossRateMax,Sharing_recv_FpsHarmonicAverage:T?.aggregated?.fpsHarmonicAverage,Sharing_recv_isRenderingEvents:JSON.stringify(limitArraySize(g.remoteVideoManager.isRenderingEvents.sharing,m.config.diagnostics.telemetryLimits.numIsRenderingEvents)),Sharing_recv_PreferredResolution:g.remoteVideoManager.preferredResolution.sharing?.toString(),Sharing_recv_statsOnSubscribed:JSON.stringify(O),Sharing_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.sharing.events,"ts",g.startTime)),Sharing_SubscriptionCounters:JSON.stringify(g.subscriptionManager?.sharing.counters),Sharing_send_CaptureFramerateAvg:I?.aggregated?.captureFramerateAvg,Sharing_send_DurationSeconds:I?.aggregated?.duration,Sharing_send_MaxCapabilities:JSON.stringify(P),Sharing_send_MaxCapabilitiesErrors:JSON.stringify(R),Sharing_send_OvershootDurations:JSON.stringify({fs:I?.aggregated?.totalFsOvershootDuration,fps:I?.aggregated?.totalFpsOvershootDuration,br:I?.aggregated?.totalBrOvershootDuration}),Sharing_send_resolutionSwitches:I?.aggregated?.resolutionSwitches,Sharing_send_OvershootEvents:JSON.stringify(rebaseTime(I?.aggregated.overshootEvents,"timestamp",g.startTime)),Sharing_send_QpAvg:I?.aggregated?.qpAvg,Sharing_send_bitrateAvg:I?.aggregated?.bitrateAvg,Sharing_send_bitrateMax:I?.aggregated?.bitrateMax,Sharing_send_frameRateAvg:I?.aggregated?.frameRateAvg,Sharing_send_AllocateBWAvg:I?.aggregated?.bweAvg,Sharing_send_packetsLostRateMax:I?.aggregated?.lossRateMax,multipleVideoStreams:JSON.stringify(rebaseTime(g.multiViewStats,"startTime",g.startTime)),ReportedReceiveBandwidth:g.reportedReceiveBandwidth,OvcToSubscribtions:JSON.stringify(g.ovcToSubscriptionEvents),EncodedStreamWorker:g.encodedStreamWorker,AudioCodecEvents:JSON.stringify(g.audioCodecEvents),HevcCodecSupport:JSON.stringify(g?.codecSupport),CallSetupTimeTracker:JSON.stringify(g.timerTrackerReport),SentBWSeed:g.sentBWSeed,videoPerformanceEvent:JSON.stringify(g.videoPerformanceEvent),EarlyMedia_NumStatsPolls:g.earlyMediaNumStatsPolls})}function convertCodec(g){return g?.substring(g.indexOf("/")+1).toUpperCase()}var videoSendStatsFieldConverter=g=>removeUndefinedFields({id:g.outboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.remoteInboundRTP?.jitter,packets:g.outboundRTP.packetsSent,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.remoteInboundRTP?.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,rtt:g.remoteInboundRTP?.roundTripTime,frameRateInput:g.mediaSource?.framesPerSecond,frameWidthInput:g.mediaSource?.width,frameHeightInput:g.mediaSource?.height,framesEncoded:g.outboundRTP.framesEncoded,frameRateEncoded:g.extensions?.frameRateEncoded,framesSent:g.outboundRTP.framesSent,frameRateSent:g.extensions?.frameRateSent,frameWidthSent:g.outboundRTP.frameWidth,frameHeightSent:g.outboundRTP.frameHeight,keyFramesEncoded:g.outboundRTP.keyFramesEncoded,nackCount:g.outboundRTP.nackCount,firCount:g.outboundRTP.firCount,pliCount:g.outboundRTP.pliCount,transportId:g.outboundRTP.transportId,altLayouts:g.altLayouts?.map(videoSendStatsFieldConverter)}),videoRecvStatsFieldConverter=g=>removeUndefinedFields({id:g.inboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.inboundRTP.jitter,packets:g.inboundRTP.packetsReceived,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.inboundRTP.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.inboundRTP.packetsDiscarded,rtt:g.remoteOutboundRTP?.roundTripTime,msi:g.renderer?.msi,jitterBufferMs:g.extensions?.jitterBufferMs,frameRateOutput:g.extensions?.frameRateDecoded,frameRateDecoded:g.extensions?.frameRateDecoded,frameRateReceived:g.extensions?.frameRateReceived,frameWidthReceived:g.inboundRTP.frameWidth,frameHeightReceived:g.inboundRTP.frameHeight,longestFreezeDuration:g.extensions?.longestFreeze,totalFreezeDuration:g.extensions?.totalFreezeDuration,framesReceived:g.inboundRTP.framesReceived,framesDropped:g.inboundRTP.framesDropped,framesDecoded:g.inboundRTP.framesDecoded,keyFramesDecoded:g.inboundRTP.keyFramesDecoded,nackCount:g.inboundRTP.nackCount,firCount:g.inboundRTP.firCount,pliCount:g.inboundRTP.pliCount,transportId:g.inboundRTP.transportId}),audioSendStatsFieldConverter=g=>removeUndefinedFields({id:g.outboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.remoteInboundRTP?.jitter,packets:g.outboundRTP.packetsSent,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.remoteInboundRTP?.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.remoteInboundRTP?.packetsDiscarded,rtt:g.remoteInboundRTP?.roundTripTime,audioLevel:g.mediaSource?.audioLevel,transportId:g.outboundRTP.transportId}),audioRecvStatsFieldConverter=g=>removeUndefinedFields({id:g.inboundRTP.ssrc.toString(),codecName:convertCodec(g.codec?.mimeType),bitrate:g.extensions?.bitrate,jitter:g.inboundRTP.jitter,packets:g.inboundRTP.packetsReceived,packetsPerSecond:g.extensions?.packetsPerSecond,packetsLost:g.inboundRTP.packetsLost,packetsLostPerSecond:g.extensions?.packetsLostPerSecond,packetsDiscarded:g.inboundRTP.packetsDiscarded,rtt:g.remoteOutboundRTP?.roundTripTime,jitterBufferMs:g.extensions?.jitterBufferMs,audioLevel:g.inboundRTP.audioLevel,healedRatio:g.extensions?.healedRatio,transportId:g.inboundRTP.transportId}),dataChannelStatsFieldConverter=g=>removeUndefinedFields({id:g.id,state:g.state,dataChannelIdentifier:g.dataChannelIdentifier,messagesSent:g.messagesSent,bytesSent:g.bytesSent,messagesReceived:g.messagesReceived,bytesReceived:g.bytesReceived,sendBitrate:g.extensions?.sendBitrate,recvBitrate:g.extensions?.recvBitrate,messagesSentPerSecond:g.extensions?.sendMessageRate,messagesReceivedPerSecond:g.extensions?.recvMessageRate}),transportStatsFieldConverter=g=>removeUndefinedFields({id:g.id,rtt:g.selectedCandidatePair?.currentRoundTripTime,availableIncomingBitrate:g.selectedCandidatePair?.availableIncomingBitrate,availableOutgoingBitrate:g.selectedCandidatePair?.availableOutgoingBitrate,relayProtocol:g.selectedCandidatePair?.localCandidate?.relayProtocol,candidateType:`${g.selectedCandidatePair?.localCandidate?.candidateType??""}:${g.selectedCandidatePair?.remoteCandidate?.candidateType??""}`});function compileAudioSendReport(g){return(g.audio?.send??[]).map(audioSendStatsFieldConverter)}function compileAudioRecvReport(g){return(g.audio?.recv??[]).map(audioRecvStatsFieldConverter)}function compileVideoSendReport(g){if(!g.video?.send?.length)return[];return g.video.send.map(videoSendStatsFieldConverter)}function compileVideoRecvReport(g){return(g.video?.recv??[]).map(videoRecvStatsFieldConverter)}function compileScreenShareSendReport(g){if(!g.sharing?.send?.length)return[];return g.sharing.send.map(videoSendStatsFieldConverter)}function compileScreenShareRecvReport(g){return(g.sharing?.recv??[]).map(videoRecvStatsFieldConverter)}function compileDataChannelReport(g){return(g.data??[]).map(dataChannelStatsFieldConverter)}function compileTransportReport(g){return Object.values(g.transports??{}).map(transportStatsFieldConverter)}function compileMediaStatsReport(g){return{audio:{send:compileAudioSendReport(g),recv:compileAudioRecvReport(g)},video:{send:compileVideoSendReport(g),recv:compileVideoRecvReport(g)},screenShare:{send:compileScreenShareSendReport(g),recv:compileScreenShareRecvReport(g)},data:compileDataChannelReport(g),transports:compileTransportReport(g)}}function compileMediaStatsReportExtensions(g,m){const f=g.qualityManager&&limitArraySize(deepClone(g.qualityManager.videoMaxCapabilitiesEvents).map((f=>rebaseTime(limitArraySize(f.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested),S=g.qualityManager&&limitArraySize(deepClone(g.qualityManager.sharingMaxCapabilitiesEvents).map((f=>rebaseTime(limitArraySize(f.events,m.config.diagnostics.telemetryLimits.numCapabilitiesApplied,1),"timestamp",g.startTime))),m.config.diagnostics.telemetryLimits.numCapabilitiesRequested);return removeUndefinedFields({Video_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.video.events,"ts",g.startTime)),Sharing_SubscriptionEvents:JSON.stringify(rebaseTime(g.subscriptionManager?.sharing.events,"ts",g.startTime)),Video_send_MaxCapabilities:JSON.stringify(f),Sharing_send_MaxCapabilities:JSON.stringify(S),RelayCandidate:g.relayCandidate,Video_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameVideo,Sharing_recv_TimeToFirstFrame:g.remoteVideoManager.firstTimeToFirstFrameSharing,Video_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.timeToFirstFrameSinceSubscriptionStartVideo,Sharing_recv_TimeToFirstFrameSinceSubscriptionStart:g.remoteVideoManager.timeToFirstFrameSinceSubscriptionStartSharing})}function compileMediaStatsReportMetrics(g,m,f){return removeUndefinedFields({DeviceEvents:JSON.stringify(rebaseTime(f.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),IceConnectedStateTime:1e4*g.iceConnectedStateTime})}function compileMetricsTelemetryReport(g,m,f,S){return removeUndefinedFields({MediaLegId:g.mediaLegId,CreationTime:getHpTimeFromMillis(g.creationTime),CallNumber:g.callNumber,SessionId:g.sessionId,MultiParty:g.isMultiParty,ErrorType:g.error?.type??"none",ErrorDetail:g.error?.detail??"none",IncompatibleOffer:g.error?.type===je.MEDIA_ERROR.incompatibleOffer,TerminationTime:getHpTimeFromMillis(g.terminationTime),TerminationReason_code:g.terminationReason?.code,TerminationReason_subCode:g.terminationReason?.subCode,TerminationReason_phrase:g.terminationReason?.phrase,TerminationReason_remoteTerminated:g.terminationReason?.remoteTerminated,TerminationReason_clientReasonPhrase:g.terminationReason?.clientReasonPhrase,TerminationReason_clientReasonSubCode:g.terminationReason?.clientReasonSubCode,CallDuration:getHpTimeFromMillis(g.duration),IceInitTime:getHpTimeFromMillis(g.iceInitTime),IceConnectedStateTime:getHpTimeFromMillis(g.iceConnectedStateTime),NegotiationCount:g.negotiationCount,RejectedNegotiationCount:g.rejectedNegotiationCount,InitialNegotiationCompleted:g.initialNegotiationCompleted,InitialNegotiationType:g.initialNegotiationType,FinalAnswerTime:getHpTimeFromMillis(g.finalAnswerTime),TransportReconnectedCount:g.transportReconnectedCount,RollbackNegotiation:JSON.stringify(g.rollbackNegotiation),Relay:g.relay?JSON.stringify(g.relay):void 0,ActiveModalities:JSON.stringify(g.activeModalities),AllowedAudioSend:g.allowedAudioSend,AllowedVideoSend:g.allowedVideoSend,AllowedScreensharingSend:g.allowedScreensharingSend,RelayManager:JSON.stringify(g.relayTimers),CallMutedRatio:getHpTimeFromMillis(g.callMutedRatio),CallOsMuted:getHpTimeFromMillis(g.callOsMuted),CallHwSilent:getHpTimeFromMillis(g.callHwSilent),CallSwMuted:getHpTimeFromMillis(g.callSwMuted),CallSpeakerMuted:getHpTimeFromMillis(g.callSpeakerMuted),CallIsSpeaking:getHpTimeFromMillis(g.callIsSpeaking),DtmfSuccess:g.dtmfSuccessCount,DtmfFailure:g.dtmfFailureCount,ReconnectInProgress:g.reconnect?.isReconnecting,RetargetIncomingCount:g.reconnect?.retargetCount.incoming,RetargetOutgoingCount:g.reconnect?.retargetCount.outgoing,RetargetCompletedCount:g.reconnect?.retargetCount.completed,RetargetRejectedCount:g.reconnect?.retargetCount.rejected,EscalationAttemptedCount:g.reconnect?.escalationCount.attempted,EscalationCompletedCount:g.reconnect?.escalationCount.completed,EscalationRejectedCount:g.reconnect?.escalationCount.rejected,ReconnectAttemptedCount:g.reconnect?.reconnectCount.attempted,ReconnectConnectedCount:g.reconnect?.reconnectCount.connected,ReconnectAttempts:JSON.stringify(rebaseTime(limitArraySize(g.reconnect?.records,S.config.diagnostics.telemetryLimits.numReconnects),"startTime",g.creationTime)),NetworkEvents:JSON.stringify(rebaseTime(limitArraySize(g.reconnect?.tmpRecords,S.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",g.creationTime)),NoIceCandidatesGoodEventCount:g.noIceCandidatesEventCount.good,NoIceCandidatesBadEventCount:g.noIceCandidatesEventCount.bad,NoRelayIceCandidatesGoodEventCount:g.noRelayIceCandidatesEventCount.good,NoRelayIceCandidatesBadEventCount:g.noRelayIceCandidatesEventCount.bad,MicrophoneInUseGoodEventCount:g.microphoneInUseEventCount.good,MicrophoneInUseBadEventCount:g.microphoneInUseEventCount.bad,CameraInUseGoodEventCount:g.cameraInUseEventCount.good,CameraInUseBadEventCount:g.cameraInUseEventCount.bad,CameraFreezeStartEventCount:g.cameraFreezeEventCount.start,CameraFreezeEndEventCount:g.cameraFreezeEventCount.end,NetworkRecvGood:g.networkRecvUFD.good,NetworkRecvGoodRatio:g.networkRecvUFD.goodRatio,NetworkRecvPoor:g.networkRecvUFD.poor,NetworkRecvPoorRatio:g.networkRecvUFD.poorRatio,NetworkRecvBad:g.networkRecvUFD.bad,NetworkRecvBadRatio:g.networkRecvUFD.badRatio,NetworkSendGood:g.networkSendUFD.good,NetworkSendGoodRatio:g.networkSendUFD.goodRatio,NetworkSendPoor:g.networkSendUFD.poor,NetworkSendPoorRatio:g.networkSendUFD.poorRatio,NetworkSendBad:g.networkSendUFD.bad,NetworkSendBadRatio:g.networkSendUFD.badRatio,RawOutputAudioAccessAttempted:g.rawMedia.audio.recv.numAttempts,RawOutputAudioAccessDurationRatio:g.rawMedia.audio.recv.durationRatio,RawInputAudioOverrideAttempted:g.rawMedia.audio.send.numAttempts,RawInputAudioOverrideDurationRatio:g.rawMedia.audio.send.durationRatio,UFDs:JSON.stringify(rebaseTime(limitArraySize(g.ufds,S.config.diagnostics.telemetryLimits.numUFDs),"timestamp",g.creationTime)),MediaQosEnabled:f.configuration.mediaConfig?.enableMediaQoS??!1,PortRangeConfigured:!!f.configuration.mediaConfig?.mediaPortRanges,hardwareConcurrency:navigator.hardwareConcurrency,ETag:g.ETag,ConfigIds:g.configIds,PermissionStates:JSON.stringify(f.deviceManager.permissionStates),DeviceList:JSON.stringify(f.deviceManager.deviceList),DeviceListDebug:JSON.stringify(f.deviceManager.deviceDebugStrings),DevicesChangeCount:g.deviceManager.devicesChangeCount,DevicesPollChangeCount:g.deviceManager.devicesPollChangeCount,DeviceSelectionChangeCount:g.deviceManager.deviceSelectionChangeCount,DeviceSelectionChangeFromInterfaceCount:g.deviceManager.deviceSelectionChangeCountFromInterface,DevicesCount:JSON.stringify(f.deviceManager.devicesCount),UsedMicrophone:f.deviceManager.usedDevices.microphone,UsedSpeaker:f.deviceManager.usedDevices.speaker,UsedCamera:f.deviceManager.usedDevices.camera,DeviceEvents:JSON.stringify(rebaseTime(f.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),VideoEffects:JSON.stringify(rebaseTime(f.deviceManager.videoEffectsEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),AudioEffects:JSON.stringify(rebaseTime(f.deviceManager.audioEffectsEvents.filter((g=>g.timestamp>m)),"timestamp",g.creationTime)),MediaByPassEnabled:!!f.configuration.mediaConfig.enableMediaBypass,CallConstraints:JSON.stringify(S.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(generateDominantSpeakerReport(g.dominantSpeaker,g.terminationTime))})}function getHpTimeFromMillis(g){return 1e4*g}function generateDominantSpeakerReport(g,m=Number(new Date)){if(!g)return;const f=deepClone(g);return g.lastMsgDate&&(g.timeSinceLastMsg=g.lastMsgDate-m),delete f.lastMsgDate,delete f.lastHistory,removeUndefinedFields(f)}function getValue(g,m,f=0){const S=m.filter((g=>void 0!==g));let v;switch(g){case"Difference":v=S[S.length-1]-S[0];break;case"Average":v=S.reduce(((g,m)=>g+m),0)/S.length;break;case"LastValue":v=S[S.length-1]}return v||0===v?`${"number"==typeof v?+v.toFixed(f):v}`:void 0}function filterStats(g,m,f){return(f?g.map((g=>g?.[m]?.[f])):g.map((g=>g?.[m]))).filter((g=>void 0!==g)).reduce(((g,m)=>g.concat(m)),[])}function findTransportStats(g){const m=g.find((g=>g?.transports));return m?m.transports[Object.keys(m.transports)[0]]:void 0}function getVideoProcessing(g){const m=g[g.length-1]?.extensions?.powerEfficient;return void 0===m?"":m?"hw":"sw"}function getMediaDirection(g,m){return g&m?"Bidirectional":g?"ReceiveFromPeer":m?"SendToPeer":"Inactive"}function getSendActivityState(g){const m=g[g.length-1]?.extensions?.callIsMuted,f=g[g.length-1]?.extensions?.rawInputVolume;return m?"0":!m&&f>0?"2":m||0!==f?void 0:"1"}function compileAudioReport2(g,m){const f=filterStats(g,"audio","send"),S=filterStats(g,"audio","recv"),v=findTransportStats(g);if(f.length||S.length)return removeUndefinedFields({mediaType:"Audio",mediaDirection:getMediaDirection(S.length,f.length),"Received BW estimate":getValue("Average",S.map((g=>g?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Recv Loss Rate (Avg)":getValue("LastValue",S.map((g=>g?.extensions?.lossRate/100)),3),"Rtp Packets Received":getValue("Difference",S.map((g=>g?.inboundRTP.packetsReceived))),"Rtp Packet Sent":getValue("Difference",f.map((g=>g?.outboundRTP.packetsSent))),"Sent BW estimate":getValue("Average",f.map((g=>g?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Audio Codec":getValue("LastValue",f.map((g=>g?.codec?.mimeType)))?.split("/")[1],"Send RTT (Avg)":getValue("LastValue",f.map((g=>g?.extensions?.rttAvg))),"Audio NW jitter avg":getValue("LastValue",S.map((g=>g?.extensions?.jitterAvg)),3),"Audio send bps":getValue("Average",f.map((g=>g?.extensions?.bitrate))),"JB delay (ms)":getValue("LastValue",S.map((g=>g?.extensions?.jitterBufferDelayMs))),"Recv Audio Codec":getValue("LastValue",S.map((g=>g?.codec?.mimeType)))?.split("/")[1],"Current Render Device Name":m?.speaker,"Current Capture Device Name":m?.microphone,"Latest Network Type":v?.selectedCandidatePair?.localCandidate?.networkType,"Latest Transport Protocol":v?.selectedCandidatePair?.localCandidate?.protocol,"Latest Reflexive Address":ipAddressConverter(v?.extensions?.reflexiveLocalIP),"Local Address":ipAddressConverter(v?.selectedCandidatePair?.localCandidate?.ip),"Local short-term Healed Data Ratio":getValue("LastValue",S.map((g=>g?.extensions?.healedRatio))),"Send activity (0=muted; 1=inactive; 2=active)":getSendActivityState(f)})}function formatVideoStats(g){const m={},formatStats=f=>{g.map((g=>g?.video?.[f])).forEach((g=>{g?.forEach((g=>{var S;const v=g?.mediaEntity?.remoteSsrc;m[v]??(m[v]={}),(S=m[v])[f]??(S[f]=[]),m[v][f].push(g)}))}))};return formatStats("recv"),formatStats("send"),m}function compileVideoReport(g,m){const f=[],S=formatVideoStats(g);for(const{send:g,recv:v}of Object.values(S)){let S={mediaType:"Camera",mediaDirection:getMediaDirection(v?.length,g?.length)};v&&(S={...S,...compileVideoRecvReport2(v)}),g&&(S={...S,...compileVideoSendReport2(g,m)}),f.push(removeUndefinedFields(S))}return f}function compileVideoSendReport2(g,m){const f=getValue("LastValue",g.map((g=>g?.codec?.mimeType)))?.split("/")[1],S=f?f+` ${getVideoProcessing(g)}`:void 0;return{"Rtp Packet Sent":getValue("Difference",g.map((g=>g?.outboundRTP.packetsSent))),"Sent BW estimate":getValue("Average",g.map((g=>g?.transport?.selectedCandidatePair?.availableOutgoingBitrate))),"Send Current Bitrate":getValue("Average",g.map((g=>g?.extensions?.bitrate))),"Allocated Send Bandwidth Average":getValue("LastValue",g.map((g=>g?.extensions?.bitrateAvg))),"Send Actual Height":getValue("LastValue",g.map((g=>g?.outboundRTP.frameHeight))),"Send Actual Width":getValue("LastValue",g.map((g=>g?.outboundRTP.frameWidth))),"Send Current Frame Rate":getValue("Average",g.map((g=>g?.extensions?.frameRateSent))),"Send RTT (Avg)":getValue("LastValue",g.map((g=>g?.extensions?.rttAvg))),"Sent Codec Name":S,"Webcam Freeze Intervals":getValue("LastValue",g.map((g=>g?.extensions?.captureFreezeIntervalsCount))),"Current Capture Device Name":m?.camera,"Number of Sync Frame Request per Minute":getValue("LastValue",g.map((g=>g?.extensions?.pliRate)))}}function compileVideoRecvReport2(g){const m=getValue("LastValue",g.map((g=>g?.mediaEntity?.xSourceStreamId))),f=getValue("LastValue",g.map((g=>g?.codec?.mimeType)))?.split("/")[1],S=f?f+` ${getVideoProcessing(g)}`:void 0;return{"Recv Loss Rate (Avg)":getValue("LastValue",g.map((g=>g?.extensions?.lossRate)),3),"Received BW estimate":getValue("Average",g.map((g=>g?.transport?.selectedCandidatePair?.availableIncomingBitrate))),"Receive Current Bitrate":getValue("Average",g.map((g=>g?.extensions?.bitrate))),"Rtp Packets Received":getValue("Difference",g.map((g=>g?.inboundRTP.packetsReceived))),"Receive Actual Height":getValue("LastValue",g.map((g=>g?.inboundRTP.frameHeight))),"Receive Actual Width":getValue("LastValue",g.map((g=>g?.inboundRTP.frameWidth))),"Receive Current Frame Rate":getValue("Average",g.map((g=>g?.extensions?.frameRateReceived))),"Received Codec Name":S,"Received Total Freeze Fraction (ms per min)":getValue("LastValue",g.map((g=>g?.extensions?.totalFreezeFraction))),videoSourceId:m?parseInt(m):void 0,"Received Fps Time Weighted Harmonic Average":getValue("LastValue",g.map((g=>g?.extensions?.fpsHarmonicAverage)))}}function compileSharingReport(g){const m=filterStats(g,"sharing","send"),f=filterStats(g,"sharing","recv");if(!f.length&&!m.length)return;let S={mediaType:"AppSharing",mediaDirection:"Bidirectional","Render Device Name":""};return f.length&&(S={...S,...compileVideoRecvReport2(f)}),m.length&&(S={...S,...compileVideoSendReport2(m,{microphone:void 0,camera:"Screen sharing",speaker:void 0})}),removeUndefinedFields(S)}function compileReports(g,m,f){const S=compileAudioReport2(g,m);S&&f.channels.push(S);const v=compileVideoReport(g,m);v.length&&f.channels.push(...v);const C=compileSharingReport(g);C&&f.channels.push(C)}function compileTeamsRealtimeTelemetryReport(g,m){const f=filterStats(g,"inactiveTracks"),S={channels:[]};return compileReports(g,m,S),f.length&&compileReports(f,void 0,S),S}function compileVideoReportForE2E(g,m,f,S,v){return removeUndefinedFields({recv:removeUndefinedFields({id:f?.inboundRTP.id,ssrc:f?.inboundRTP.ssrc,mediaType:f?.inboundRTP.mediaType??f?.inboundRTP.kind,bytes:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.bytesReceived),v),packets:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.packetsReceived),v),packetsLost:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.packetsLost),v),codec:f?.codec?.mimeType.split("/")[1],codecReport:f?.aggregated?.codecReport,framesDecoded:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.framesDecoded),v),height:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.frameHeight),v),width:sampleseriesArr(m[g]?.recv,(g=>g.inboundRTP.frameWidth),v),frameRate:sampleseriesArr(m[g]?.recv,(g=>g.extensions?.frameRateReceived),v)}),send:removeUndefinedFields({id:S?.outboundRTP.id,ssrc:S?.outboundRTP.ssrc,mediaType:S?.outboundRTP.mediaType??S?.outboundRTP.kind,bytes:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.bytesSent),v),packets:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.packetsSent),v),packetsLost:sampleseriesArr(m[g]?.send,(g=>g.remoteInboundRTP?.packetsLost),v),codec:S?.codec?.mimeType.split("/")[1],framesEncoded:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.framesEncoded),v),heightInput:S?.mediaSource?.height,widthInput:S?.mediaSource?.width,height:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.frameHeight),v),width:sampleseriesArr(m[g]?.send,(g=>g.outboundRTP.frameWidth),v),frameRate:sampleseriesArr(m[g]?.send,(g=>g.extensions?.frameRateSent),v)})})}function compileAudioReportForE2E(g,m,f,S){const v=m?.codec?.mimeType.split("/");return removeUndefinedFields({recv:removeUndefinedFields({id:m?.inboundRTP.id,ssrc:m?.inboundRTP.ssrc,mediaType:m?.inboundRTP.mediaType??m?.inboundRTP.kind,bytes:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.bytesReceived),S),packets:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.packetsReceived),S),packetsLost:sampleseriesArr(g.audio?.recv,(g=>g.inboundRTP.packetsLost),S),codec:v?.[v?.length-1],audioLevel:sampleseriesArr(g.audio?.recv,(g=>Math.floor(65535*g.inboundRTP.audioLevel)),S)}),send:removeUndefinedFields({id:f?.outboundRTP.id,ssrc:f?.outboundRTP.ssrc,mediaType:f?.outboundRTP.mediaType??f?.outboundRTP.kind,bytes:sampleseriesArr(g.audio?.send,(g=>g.outboundRTP.bytesSent),S),packets:sampleseriesArr(g.audio?.send,(g=>g.outboundRTP.packetsSent),S),packetsLost:sampleseriesArr(g.audio?.send,(g=>g.remoteInboundRTP?.packetsLost),S),codec:f?.codec?.mimeType.split("/")[1],audioLevel:sampleseriesArr(g.audio?.send,(g=>Math.floor(65535*g.aggregated.audioLevel)),S)})})}function compileE2EDiagReport(g,m,f,S,v){const C=g.aggregatedModalityStats,_=getLast(C.audio?.recv),E=getLast(C.audio?.send),T=getLast(C.video?.recv),I=getLast(C.video?.send),b=getLast(C.sharing?.recv),A=getLast(C.sharing?.send),P=[],R=[];return g.statsOnSubscribed.video?.forEach((g=>P.push(g))),g.statsOnSubscribed.sharing?.forEach((g=>R.push(g))),removeUndefinedFields({multipleVideoStreams:g.multiViewStats,WebRTCStats_ssrc:removeUndefinedFields({audio:compileAudioReportForE2E(C,_,E,v),video:compileVideoReportForE2E("video",C,T,I,v),sharing:compileVideoReportForE2E("sharing",C,b,A,v)}),CallSwMuted:1e3*m.callSwMuted,DeviceEvents:rebaseTime(f.deviceManager.deviceTelemetryEvents.filter((g=>g.timestamp>S)),"timestamp",m.creationTime),VideoEffects:rebaseTime(f.deviceManager.videoEffectsEvents.filter((g=>g.timestamp>S)),"timestamp",m.creationTime)})}var GS=class{constructor(g,m){this.rootRef=g,this.configProvider=m}get rootCopy(){return deepClone(this.rootRef)}get rawRootRef(){return this.rootRef}getSessionTelemetry(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g)),f={metrics:{},Extensions:{}};if(!m)return;const S=We();try{const g=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,S=g?.terminationTime??0,v=m.webrtcSessions[m.webrtcSessions.length-1];f.metrics=compileMetricsTelemetryReport(m,S,this.rootRef,this.configProvider),f.Extensions=compileExtensionsTelemetryReport(v,this.configProvider,m.statsErrors)}catch(g){m[US].addStatsError("DiagnosticsReport:getSessionTelemetry",stringifyObject(g)),f.Extensions.WebRTCStats_statsErrors=JSON.stringify(m.statsErrors)}return f.metrics.ReportGenerationTimeMs=round(We()-S),f}getTeamsRealtimeTelemetry(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));if(m)try{const g=m.webrtcSessions[m.webrtcSessions.length-1],f=this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval;return compileTeamsRealtimeTelemetryReport(g.statsReports.slice(g.statsReports.length-f),this.rootRef.deviceManager.rawUsedDevices)}catch(g){throw m[US].addStatsError("DiagnosticsReport:getRealTimeTelemetry",stringifyObject(g)),g}}getMediaSessionStats(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));if(m)try{const g=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,f=g?.terminationTime??0,S=m.webrtcSessions[m.webrtcSessions.length-1],v=S?.statsReports.length?S.statsReports[S.statsReports.length-1]:void 0,C=v?compileMediaStatsReport(v):void 0;return C&&(C.extensions=compileMediaStatsReportExtensions(S,this.configProvider),C.metrics=compileMediaStatsReportMetrics(m,f,this.rootRef)),C}catch(g){throw m[US].addStatsError("DiagnosticsReport:getMediaSessionStats",stringifyObject(g)),g}}getDiagnosticsForE2eTests(g){const m=this.rootRef.sessions.find((m=>m.sessionId===g));let f={};if(m){try{const g=m.webrtcSessions[m.webrtcSessions.length-1],S=m.callNumber>1?this.rootRef.sessions.find((g=>m.callNumber-1===g.callNumber)):void 0,v=S?.terminationTime??0;f=compileE2EDiagReport(g,m,this.rootRef,v,this.configProvider.config.diagnostics.collectionLimits.numSamplesForE2E)}catch(g){m[US].addStatsError("DiagnosticsReport:getSessionTelemetry",stringifyObject(g))}return f}}},jS=class{constructor(g,m){this.configProvider=g,this.deviceManagerDiagnostics=m,this.root={creationTime:Date.now(),numTotalSessions:0,deviceManager:this.deviceManagerDiagnostics.getObjectRef(),configuration:{stackConfig:this.configProvider.stackConfig,defaultConfig:this.configProvider.defaultConfig,mediaConfig:{},userAgentConfig:{isAudioOutputSelectionSupported:this.configProvider.userAgentConfig.isAudioOutputSelectionSupported,isBrowserRollbackSupported:this.configProvider.userAgentConfig.isBrowserRollbackSupported,hardwareConcurrency:this.configProvider.userAgentConfig.hardwareConcurrency,unmaskedGlRenderer:this.configProvider.userAgentConfig.unmaskedGlRenderer,hasMediaApi:qs.hasMediaApi(),hasCapabilitiesApi:qs.hasCapabilitiesApi(),hasUnifiedPlanSupport:void 0},consoleOverrides:this.configProvider.consoleOverrides,fullConfig:deepClone(this.configProvider.config),ecsConfigUpdates:[]},browserInfo:getBrowserInfo(),sessions:[]},this.diagnosticsReport=new GS(this.root,this.configProvider),this.configProvider.on("newConfigReceived",((g,m,f)=>{this.root.configuration.ecsConfigUpdates.push({timestamp:Date.now(),etag:m,configIds:f,config:g})})),this.configProvider.on("configUpdated",(()=>{this.root.configuration.consoleOverrides=this.configProvider.consoleOverrides,this.root.configuration.fullConfig=deepClone(this.configProvider.config)}))}get reportGenerator(){return this.diagnosticsReport}get rootRef(){return this.root}set mediaConfig(g){this.root.configuration.mediaConfig=g}newSession(g,m,f){this.root.configuration.userAgentConfig.hasUnifiedPlanSupport=this.configProvider.mediaConfig.simulcastSessionEnabled;const S=new VS(f,g,this.diagnosticsReport,this.root.deviceManager,++this.root.numTotalSessions,m);return arrayLimitedPush(this.root.sessions,S.getObjectRef(),this.configProvider.config.diagnostics.collectionLimits.numSessions),S}},WS=class _JamaLogger{constructor(g,m){this.safe=g,this.unsafe=m,this.safe||(this.safe=this.unsafe)}warn(...g){this.unsafe.warn(...g)}error(...g){this.unsafe.error(...g)}debug(...g){this.unsafe.debug(...g)}info(...g){this.unsafe.info(...g)}createChild(g){return new _JamaLogger(this.safe.createChild(g),this.unsafe.createChild(g))}},qS=R,zS=class{constructor(g){this.logger=g,this.extensionId="nkeimhogjdpnpccoofpliimaahmaaome",this.editorExtensionId="ncbjelpjchkpbikbpkcchkhkblodoama",this.logId="TeamsWebRTCLogs",this.loggingState="unknown",this.connectionCount=0;window.webRtcInternalsCollector=this}get isExtensionAvailable(){return"unavailable"!==this.loggingState}async updateSessionCount(g){this.isExtensionAvailable&&(0===this.connectionCount&&1===g?("stopped"===this.loggingState&&await this.discardLogs(),await this.initialStartLogging()):0===g&&await this.stopLogging(),this.connectionCount=g)}async collect(){return this.isExtensionAvailable?this.collectPromise?this.collectPromise:this.collectPromise=new Promise((async g=>{try{this.connectionCount>0&&(this.logger.safe.info(`Stopping logger for gathering, open connections: ${this.connectionCount}`),await this.stopLogging()),await this.storeLogs();const m=await this.gatherFromStorage();this.connectionCount>0&&await this.continueLogging(),g(m.length>0?m.join("\r\n"):"")}catch(m){this.logger.safe.error("Error while collecting logs",m),g(JSON.stringify(m))}this.collectPromise=void 0})):""}async initialStartLogging(){try{await this.startLogging()}catch(g){if(g?.includes("A log is already open"))try{const m=g.match(/State=(\w+)/);await this.cleanState(m?.[1]),await this.startLogging()}catch(g){this.logger.safe.error("Error while starting logging at cleanup phase",g),this.loggingState="unknown"}else this.logger.safe.error("Error while starting logging",g),this.loggingState="unavailable"}}async continueLogging(){try{await this.startLogging()}catch(g){this.logger.safe.error("Error while continuing logging",g),this.loggingState="stopped"}}async startLogging(){await this.sendMessage(this.extensionId,{method:"logging.start"}),this.logger.safe.info("Logging started"),this.loggingState="started"}async cleanState(g){try{if("started"===g)await this.stopLogging(),await this.discardLogs();else{if("stopped"!==g)throw new Error(`Unexpected logging state: ${g}`);await this.discardLogs()}}catch(g){this.logger.safe.error("Error while cleaning state",g)}}async stopLogging(){try{await this.sendMessage(this.extensionId,{method:"logging.stop"}),this.logger.safe.info("Logging stopped"),this.loggingState="stopped"}catch(g){this.logger.safe.error("Error while stopping logging",g)}}async discardLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.discard"}),this.logger.safe.info("Logs discarded"),this.loggingState="closed"}catch(g){this.logger.safe.error("Error while discarding logs",g)}}async storeLogs(){try{await this.sendMessage(this.extensionId,{method:"logging.store",logId:this.logId}),this.logger.safe.info(`Logs stored to ${this.logId}`),this.loggingState="closed"}catch(g){this.logger.safe.error("Error while storing logs",g)}}async gatherFromStorage(){const g=[];let m={offset:0};do{m=await this.sendMessage(this.editorExtensionId,{api:"getWebRtcLog",logId:this.logId,offset:m.offset}),g.push(m.data),this.logger.safe.info(`Batch gathered with offset: ${m.offset}, moreData: ${m.moreData}`)}while(m.moreData);return this.logger.safe.info("Finished gathering"),g}sendMessage(g,m){return new Promise(((f,S)=>{const v=chrome.runtime;v.sendMessage(g,m,(g=>{if(!g||g?.error){const f=g?JSON.stringify(g.error):v.lastError;S(`sendMessage ${JSON.stringify(m)} failed with error: ${f}`)}f(g)}))}))}},KS=(()=>{let g;function getInstance(m,f){return f?.config.enableWebRtcInternalsLogs&&"EdgeAnaheim"===getBrowserInfo().name&&!!chrome?.runtime?(g||(g=new zS(m)),g):(m.safe.info("WebRTC internal logging is disabled"),{collect:()=>Promise.resolve(""),updateSessionCount:()=>Promise.resolve()})}return{getInstance:getInstance}})(),JS=class{getId(){return 0}getDeviceId(){return je.EMPTY_DEVICE_ID}getPreviewAsync(g,m){return Promise.resolve(null)}getDescription(){return"display"}getType(){return 1}getIcon(g,m){return Promise.resolve(null)}},YS=class{constructor(g){this.descr=g}getId(){return 0}getDeviceId(){return this.descr.browserId}getPreviewAsync(g,m){return Promise.resolve(null)}getDescription(){return this.descr.label}getType(){return 3}getIcon(g,m){return Promise.resolve(null)}},QS=class{constructor(g){this.deviceManager=g,this.sharingSource=new JS}onScreensChanged(g){return{dispose:()=>{}}}enumerateScreensAsync(){return Promise.resolve([this.sharingSource])}enumerateWindowsAsync(){return Promise.resolve([])}async enumerateCamerasAsync(){return(await this.deviceManager.enumerateDevicesAsync()).filter((g=>"camera"===g.kind)).map((g=>new YS(g)))}},XS=class{constructor(){this.data={records:[],tmpRecords:[],isReconnecting:!1,networkRecoveredCount:0,disconnectedRecoveredCount:0,reconnectCount:{attempted:0,connected:0},retargetCount:{incoming:0,outgoing:0,completed:0,rejected:0},escalationCount:{attempted:0,completed:0,rejected:0}}}registerState(g){const m="connected"===g?this.activeTmpRecord:this.getTmpRecord();m&&m.events[m.events.length-1]?.type!==g&&(m.events.push({type:g,time:Date.now()-m.startTime}),"networkOnline"===g?this.data.networkRecoveredCount++:"connected"===g&&this.data.disconnectedRecoveredCount++,"reconnect"!==g&&"connected"!==g||(m.endTime=Date.now()-m.startTime,this.activeTmpRecord=null))}registerReconnectAttempt(g){this.activeRecord&&(this.activeAttempt={direction:g,startTime:Date.now()-this.activeRecord.startTime,status:!1},this.data.isReconnecting=!0,this.activeRecord.attempts.push(this.activeAttempt))}registerReconnectAttemptStatus(g){"completed"===g&&(this.data.isReconnecting=!1),this.activeAttempt&&this.activeRecord&&(this.activeAttempt.endTime=Date.now()-this.activeRecord.startTime,this.activeAttempt.status="completed"===g)}registerReconnect(g){if(this.data.reconnectCount[g]++,this.data.isReconnecting="attempted"===g,"attempted"===g){if(this.activeRecord)return;this.activeRecord={startTime:Date.now(),attempts:[]},this.data.records.push(this.activeRecord)}else if("connected"===g){if(!this.activeRecord)return;this.activeTmpRecord&&this.registerState("connected"),this.activeRecord.endTime=Date.now()-this.activeRecord.startTime,this.activeRecord=void 0,this.activeAttempt=void 0}}registerRetarget(g){this.data.retargetCount[g]++}registerEscalation(g){this.data.escalationCount[g]++}getObject(){return this.data}getTmpRecord(){return(!this.activeTmpRecord||this.activeTmpRecord.endTime>0)&&(this.activeTmpRecord={startTime:Date.now(),events:[]},this.data.tmpRecords.push(this.activeTmpRecord)),this.activeTmpRecord}},ZS=class{constructor(){}process(g){return this.mediaLegId=g||this.mediaLegId||uniqueId().toUpperCase(),this.mediaLegId}},ev=class{constructor(g,m){this.relayManager=g,this.diagnostics=m}initialize(){}setRelayOverride(){}async queryRelaysAsync(g){const m=await this.relayManager.queryRelaysAsync(g);return m.length>0&&(this.diagnostics.relay=m[0]),m}getStats(){return this.relayManager.getStats?.()??{unavailable:"1"}}},tv=class{constructor(g,m,f){this.stats=g,this.diag=m,f&&m&&(f.reconnect=m.getObject())}registerState(g){this.diag?.registerState(g)}registerReconnectAttempt(g){this.stats.registerReconnectAttempt(g),this.diag?.registerReconnectAttempt(g)}registerReconnectAttemptStatus(g){switch(g){case"completed":this.stats.registerReconnectAttemptCompleted();break;case"rejected":this.stats.registerReconnectAttemptRejected()}this.diag?.registerReconnectAttemptStatus(g)}registerReconnect(g){switch(g){case"attempted":this.stats.registerReconnectAttempted();break;case"connected":this.stats.registerReconnectConnected()}this.diag?.registerReconnect(g)}registerRetarget(g){switch(g){case"completed":this.stats.registerRetargetCompleted();break;case"rejected":this.stats.registerRetargetRejected();break;case"incoming":this.stats.registerRetargetIncoming();break;case"outgoing":this.stats.registerRetargetOutgoing()}this.diag?.registerRetarget(g)}registerEscalation(g){switch(g){case"attempted":this.stats.registerEscalationStart();break;case"completed":this.stats.registerEscalationCompleted();break;case"rejected":this.stats.registerEscalationRejected()}this.diag?.registerEscalation(g)}},iv=class{constructor(g){this.initialCallbacks=g,this.queueCallbacks={onTerminated:this.genCallback(this.initialCallbacks.onTerminated),onSessionErrorOccurred:this.genCallback(this.initialCallbacks.onSessionErrorOccurred),onNegotiationRequired:this.genCallback(this.initialCallbacks.onNegotiationRequired),onAudioStateChanged:this.genCallback(this.initialCallbacks.onAudioStateChanged),onAudioHwSilentChanged:this.genCallback(this.initialCallbacks.onAudioHwSilentChanged),onTransportDisconnected:this.genCallback(this.initialCallbacks.onTransportDisconnected),onTransportConnected:this.genCallback(this.initialCallbacks.onTransportConnected),onTransportInitialized:this.genCallback(this.initialCallbacks.onTransportInitialized),onTransportFailed:this.genCallback(this.initialCallbacks.onTransportFailed),onUpdateMediaDescriptionsRequired:this.genCallback(this.initialCallbacks.onUpdateMediaDescriptionsRequired),onTeamsRealtimeTelemetryReport:this.genCallback(this.initialCallbacks.onTeamsRealtimeTelemetryReport)},this.queue=[]}flush(){this.queue.forEach((g=>{g.method.apply(null,g.args)})),this.clear()}clear(){this.queue=[]}genCallback(g){return(...m)=>this.queue.push({method:g,args:m})}},nv=class{constructor(g,m){this.relayConfig=g,this.logger=m}async ensureOnline(){if(0===this.relayConfig.length)return this.logger.safe.warn("No TURN servers defined"),0;if(this.probeDeferred)return this.probeDeferred.promise;this.logger.safe.info(`Starting TURN probes with ${JSON.stringify(this.relayConfig[0].urls)}`),this.checkStart=Date.now();let g=0;this.probeDeferred=defer();const check=async()=>{await this.performCheck()&&this.finalize()},spawnCheckAndScheduleNext=()=>{check(),g<3e3&&(g+=1e3),this.probeTimer=setTimeout(spawnCheckAndScheduleNext,g)};return spawnCheckAndScheduleNext(),this.probeDeferred.promise}finalize(){this.probeTimer&&(clearTimeout(this.probeTimer),this.probeTimer=0),this.probeDeferred&&(this.probeDeferred.resolve(Date.now()-this.checkStart),this.probeDeferred=null)}dispose(){this.finalize()}async performCheck(){this.logger.safe.info("Probing...");const g=this.tryCreatePc();if(!g)return!1;g.createDataChannel("probe");const m=defer();function finalize(f){g.onicecandidate=void 0,g.close(),m.resolve(f)}let f=!1;return g.onicecandidate=g=>{const m=g.candidate;if(!m)return f||this.logger.safe.info("still offline"),void finalize(f);const S=m.type??parseCandidateString(m.candidate).type;"srflx"!==S&&"relay"!==S||(this.logger.safe.info(`Back online through ${S} candidate`),f=!0,"srflx"===S&&(this.ipFromRelay=m.address,finalize(!0)))},await g.setLocalDescription(await g.createOffer()),m.promise}tryCreatePc(){try{return new Ws.window.RTCPeerConnection({iceServers:this.relayConfig})}catch(g){return this.logger.safe.info(`Failed to create PC, errCode=${g.code}`),null}}},createIceServers=(g,m)=>g.reduce(((g,f)=>{const S=[],v=f.addresses&&f.addresses[0],C=f.fqdns&&f.fqdns.length>0,_=m.iceUdpAddressType,E=m.iceTcpAddressType,T=m.iceServerTransport;if(!v&&!C)return g;if(T.includes("udp")&&f.udpPort){const g=!C||"fqdn"!==_&&v?v:f.fqdns[0];S.push(`turn:${g}:${f.udpPort}?transport=udp`)}if(T.includes("tcp")&&f.tcpPort){const g=!C||"fqdn"!==E&&v?v:f.fqdns[0];S.push(`turn:${g}:${f.tcpPort}?transport=tcp`)}return T.includes("tls")&&f.tlsPort&&C&&S.push(`turns:${f.fqdns[0]}:${f.tlsPort}`),g.concat({urls:S,credential:f.password,username:f.username})}),[]),createProbeIceServers=(g,m)=>g.reduce(((g,f)=>{const S=[],v=f.addresses&&f.addresses[0],C=f.fqdns&&f.fqdns.length>0,_=m.iceUdpAddressType,E=m.iceServerTransport;if(!v&&!C)return g;if(E.includes("udp")&&f.udpPort){const g=!C||"fqdn"!==_&&v?v:f.fqdns[0];S.push(`stun:${g}:${f.udpPort}`)}return E.includes("tls")&&f.tlsPort&&C&&S.push(`turns:${f.fqdns[0]}:${f.tlsPort}`),g.concat({urls:S,credential:f.password,username:f.username})}),[]),rv=class{constructor(g,m,f,S,v,C,_,E){this.session=g,this.context=m,this.diagnostics=f,this.sessionOperationQueue=S,this.callback=v,this.sessionCallbacks=C,this.configProvider=_,this.relayManager=E,this.wasConnected=!1,this.isDisconnected=!1,this.isReconnectConference=!1,this.escalationType=0,this._isSignalingStable=!0,this.reconnectDelayTime=0,this._isReconnectScheduled=!1,this.isDisposing=!1,this.isWaitingForNetwork=!1,this.onOnline=async()=>{this.logger.safe.info("onOnline: Network is up"),this.diagnostics.registerState("networkOnline"),this.isOnlineDeferred?.resolve(),this.isOnlineDeferred=null},this.onOffline=()=>{this.logger.safe.info("onOffline: Network is down"),this.diagnostics.registerState("networkOffline"),this.isOnlineDeferred=defer4()},this.logger=m.getLogger().createChild("ReconnectManagerV2"),this.ufdManager=m.getUfdManager(),this.session.callbacks=C,this.reconnectManagerMessageQueue=new iv(C),window.addEventListener("online",this.onOnline),window.addEventListener("offline",this.onOffline)}get isOnline(){return!this.isOnlineDeferred}async createRelayProber(){if(!this._relayProber){const g=Date.now(),m=createProbeIceServers(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config),f=Date.now()-g;this.logger.safe.info(`RelayProber configuration fetched in ${f} ms`),f>5e3&&this.diagnostics.registerState("relayConfigFetched"),this._relayProber=new nv(m,this.logger.createChild("RelayProber"))}return this._relayProber}dispose(){this.isDisposing=!0,window.removeEventListener("online",this.onOnline),window.removeEventListener("offline",this.onOffline),this._relayProber?.dispose(),this.isOnlineDeferred?.reject(new Error("dispose")),this.reconnectTimer&&this.resetReconnectTimer()}get settings(){return(this.reconnectSession||this.session).getSessionConfig().config}getCurrentSession(){return this.reconnectSession||this.session}getMainSession(){return this.session||this.reconnectSession}getReconnectSession(){return this.reconnectSession}async onIceDisconnect(g){if(this.wasConnected)this.raiseReconnectEvent("Bad",g);else if(!this.settings.reconnectWithNoRelays&&!this.session.hasRelayCandidates())return void this.onReconnectFailed("no relays",g);if(this.isDisconnected=!0,!this.isReconnecting()&&!this.isWaitingForNetwork)return this.logger.safe.info(`[${g}] reconnect attempt after iceDisconnect error`),this.session.isFailed()&&this.diagnostics.registerState("failed"),this.diagnostics.registerReconnect("attempted"),this.reconnectAsync(g)}onTransportDisconnect(g){this.isDisconnected=!0,this.wasConnected&&(this.diagnostics.registerState("disconnected"),this.handleTmpConnectivityLoss(g))}onConnected(g){this.isDisconnected=!1,this.logger.safe.info(`[${g}] set allow UFD`),this.diagnostics.registerState("connected"),this.raiseReconnectEvent("Good",g),this.wasConnected=!0,this._relayProber?.finalize()}onNegotiationCompletedAsync(g){return this.logger.safe.info(`[${g}] handle negotiation completed`),this.setSignalingState(!0),this.isReconnecting()&&(this.diagnostics.registerRetarget("completed"),2===this.escalationType&&this.blockCurrentSession(g)),Promise.resolve()}async onSessionErrorOccurred(g,m){this.logger.safe.info(`[${m}] handle session error`,stringifyObject(g)),await this.rejectReconnect(m),this.isReconnectAllowed()?await this.scheduleReconnectRetry(m,!1,!1):this.callback.onSessionErrorOccurred(g,m,this.wasConnected)}onNegotiationRejection(g,m){this.logger.safe.info(`[${m}] handle negotiation rejection`),this.diagnostics.registerRetarget("rejected");const f=1===this.escalationType;return this.rejectReconnect(m).then((()=>{const S=g.type===je.RENEGOTIATION_ERROR.glare&&f;(g.type!==je.RENEGOTIATION_ERROR.glare||f)&&(this.isRecoverableError(g.type)||S?this.scheduleReconnectRetry(m,S,f):this.onReconnectFailed(stringifyObject(g),m))}))}async ensureNetwork(g){const m=this.isOnline;if(!this.isOnline){this.logger.safe.info(`[${g}] waiting for network...`);try{await this.isOnlineDeferred.promise}catch(m){return void this.logger.safe.info(`${g} call disposed while waiting for network`)}this.logger.safe.info(`[${g}] network seems up`)}if(this.isDisconnected){const f=await this.createRelayProber(),S=await f.ensureOnline();this.logger.safe.info(`[${g}] probing complete in ${S} ms`),this.diagnostics.registerState("relaysUp"),m&&S<1e3&&this.logger.safe.info(`[${g}] looks like network failed on remote side, recovery was quick`)}}oldSessionIsOnline(g){return!!this.session?.isConnected()&&(this.logger.safe.info(`[${g}] old session recovered`),this.isReconnecting()||this.diagnostics.registerReconnect("connected"),!0)}async waitForNetworkAndTryLightweightRecovery(g){const m=this.oldSessionIsOnline(g);if(m||!this.settings.reconnectWithProbes)return m;this.setReconnectTimer(),this.isWaitingForNetwork=!0;const f=this.getMaxNetworkWaitTime();return this.logger.safe.info(`[${g}] can wait up to ${f} ms`),await Promise.race([this.ensureNetwork(g),delay(f)]),this.isWaitingForNetwork=!1,this.session&&(this.session.isConnected()||this.session.isFailed()||(this.logger.safe.info(`[${g}] giving session a moment to recover`),await delay(this.settings.reconnectWaitTimeAfterProbe)),this.oldSessionIsOnline(g))?(this.resetReconnectTimer(),!0):this.checkIfTimerFailed(g)?(this.logger.safe.info(`[${g}] session reconnect timer reached during network checks`),!0):!!this.isDisposing&&(this.logger.safe.info(`[${g}] session is disposed`),!0)}reconnectAsync(g,m=!1,f=!1){return this.logger.safe.info(`[${g}] queueing reconnect, force=${m}, escalation=${f}`),this.diagnostics.registerReconnectAttempt(f?"local escalation":"out"),this._isReconnectScheduled=!0,f&&(this.escalationType=1),this.sessionOperationQueue.queueOperation((async()=>{if(this._isReconnectScheduled=!1,!m){if(await this.waitForNetworkAndTryLightweightRecovery(g))return void this.sessionOperationQueue.completeCurrentOperation()}if(this.isReconnecting())return this.logger.safe.info(`[${g}] ongoing reconnect is in progress`),void this.sessionOperationQueue.completeCurrentOperation();this.diagnostics.registerState("reconnect"),await this.initReconnect(g),await this.reconnectSession.configureModalitiesAsync(this.getConfiguredModalities(),g),this.sessionOperationQueue.completeCurrentOperation()}),g)}async acceptReconnectStartAsync(g,m){return this.logger.safe.info(`[${m}] accepting reconnect`),this.diagnostics.registerRetarget("incoming"),g?(this.escalationType=2,this.diagnostics.registerEscalation("attempted")):(!this.isReconnecting()&&this.isDisconnected?this.diagnostics.registerReconnect("attempted"):this.isReconnecting()&&await this.rejectReconnect(m),this.diagnostics.registerState("reconnect"),this.diagnostics.registerReconnectAttempt("in")),this.initReconnect(m)}acceptReconnectFinish(g){const m=this.getConfiguredModalities();return this.reconnectSession.configureModalitiesAsync(m,g).then((()=>m))}isReconnecting(){return!!this.reconnectSession}isReconnectScheduled(){return this._isReconnectScheduled}cleanUp(){this.sessionCallbacks=null,this.reconnectSession=null}async terminateAsync(g){try{await(this.session?.terminate(g,{}))}catch{}try{await this.terminateReconnectSessionAsync(g,!0)}catch{}this.cleanUp()}completeReconnect(g){return this.logger.safe.info(`[${g}] completing reconnect`),2===this.escalationType&&(this.unblockCurrentSession(),this.diagnostics.registerEscalation("completed")),this.escalationType=0,this.reconnectSession&&(this.context.config.isConference=this.isReconnectConference,this.disposeActiveSession(g),this.session=this.reconnectSession,this.reconnectManagerMessageQueue.clear(),this.diagnostics.registerReconnectAttemptStatus("completed"),this._isSignalingStable||this.diagnostics.registerRetarget("completed"),this.isDisconnected&&this.diagnostics.registerReconnect("connected"),this.resetReconnectTimer(),this.reconnectDelayTime=0,this.reconnectSession=null,this.negotiationPausePromise=null,this.session.callbacks=this.sessionCallbacks||{}),Promise.resolve()}async rejectReconnect(g){this.logger.safe.info(`[${g}] rejecting reconnect`),this.setSignalingState(!1),2===this.escalationType&&this.diagnostics.registerEscalation("rejected"),this.escalationType=0,this.reconnectSession&&(await this.terminateReconnectSessionAsync(g,!1),this.diagnostics.registerReconnectAttemptStatus("rejected")),this.session&&(this.reconnectManagerMessageQueue.flush(),this.session.callbacks=this.sessionCallbacks,this.unblockCurrentSession())}configureModalitiesAsync(g,m){this.lastKnownConfiguredModalities=g;const f=[];return this.session&&f.push(this.session.configureModalitiesAsync(g,m)),this.reconnectSession&&f.push(this.reconnectSession.configureModalitiesAsync(g,m)),Promise.all(f).then((()=>Promise.resolve()))}canSendDtmf(){return this.getMainSession().canSendDtmf()}getExtensionsManager(){return this.getMainSession().getExtensionsManager()}muteHold(g,m){this.getMainSession().muteHold(g,m)}muteInputAsync(g){return this.getMainSession().muteInputAsync(g)}unmuteInputAsync(g){return this.getMainSession().unmuteInputAsync(g)}muteOutputAsync(g){return this.getMainSession().muteOutputAsync(g)}unmuteOutputAsync(g){return this.getMainSession().unmuteOutputAsync(g)}_deviceSelectionChanged(){this.session&&this.session.deviceSelectionChanged(),this.reconnectSession&&this.reconnectSession.deviceSelectionChanged()}disposeActiveSession(g){if(this.session&&this.isReconnecting()){this.logger.safe.info(`[${g}] About to dispose current session...`);const m=this.session;return this.lastKnownConfiguredModalities=this.session.getConfiguredModalities(),m.callbacks=this.reconnectManagerMessageQueue.queueCallbacks,m.move(this.reconnectSession,g),this.session=null,m.terminate(g,{},!1)}return Promise.resolve()}registerRetargetOutgoing(){this.diagnostics.registerRetarget("outgoing")}isSignalingStable(){return this._isSignalingStable}getConfiguredModalities(){return this.getMainSession().getConfiguredModalities()||this.lastKnownConfiguredModalities}checkIfTimerFailed(g){return!(this.isReconnectAllowed()||this.session&&!this.session.isFailed())&&(this.onReconnectFailed("the time limit was reached",g),!0)}async scheduleReconnectRetry(g,m,f){const S=this.getReconnectDelayTime();if(this.logger.safe.info(`[${g}}] scheduling reconnect retry attempt in ${S}`),await delay(S),m||!this.checkIfTimerFailed(g))return this.reconnectAsync(g,f,f)}isRecoverableError(g){return je.RENEGOTIATION_ERROR.media===g||je.RENEGOTIATION_ERROR.signaling===g}async resetReconnectSession(g){this.logger.safe.info(`[${g}] Resetting reconnect session. Session exists: old: ${!!this.session}, new: ${!!this.reconnectSession}`),this.isReconnectConference=0!==this.escalationType||this.context.config.isConference;const m=0!==this.escalationType||this.context.config.isConference&&this.wasConnected&&!this.isDisconnected,f=this.getMainSession(),S=this.configProvider.getConfigView(this.isReconnectConference,f.getSessionConfig().getCallConstraints()),v=f.clone(m,S);v.callbacks={...this.sessionCallbacks,onTransportConnected:g=>{2!==this.escalationType&&this.completeReconnect(g),this.raiseReconnectEvent("Good",g),this.sessionCallbacks.onTransportConnected(g)}},this.session&&(this.session.callbacks={...this.reconnectManagerMessageQueue.queueCallbacks,onSessionErrorOccurred:(g,m)=>(g.type!==je.MEDIA_ERROR.iceConnectionError&&this.reconnectManagerMessageQueue.queueCallbacks.onSessionErrorOccurred(g,m),Promise.resolve())}),this.reconnectSession&&(this.reconnectSession.move(v,g),this.logger.safe.info(`[${g}] reconnect session still exists during reconnect clone operation`),await this.terminateReconnectSessionAsync(g,!1)),this.logger.safe.info(`[${g}] New session reset.`),this.reconnectSession=v}async initReconnect(g){this.logger.safe.info(`[${g}] initiate reconnect`),this.setReconnectTimer(),await this.resetReconnectSession(g),this.setSignalingState(!1),this.session&&(this.blockCurrentSession(g),await Promise.all([this.reconnectSession.muteInputAsync(g),this.reconnectSession.muteOutputAsync(g)]))}blockCurrentSession(g){this.negotiationPausePromise=this.session.pauseNegotiations(g)}unblockCurrentSession(){this.negotiationPausePromise&&(this.negotiationPausePromise.resolve(),this.negotiationPausePromise=null)}raiseReconnectEvent(g,m){this.ufdManager.signalEvent("NetworkReconnect",g,"Audio",!0,m)}async terminateReconnectSessionAsync(g,m){if(this.reconnectSession){const f=new iv(this.sessionCallbacks);this.reconnectSession.callbacks={...f.queueCallbacks,onTerminated:m?this.sessionCallbacks.onTerminated:f.queueCallbacks.onTerminated},await this.reconnectSession.terminate(g,{},!1),f.clear(),this.reconnectSession=null}}setReconnectTimer(){const g=this.wasConnected?this.settings.reconnectTimeLimit:this.settings.initialReconnectTimeLimit;g>0&&!this.reconnectTimer&&(this.reconnectTimerStart=Date.now(),this.reconnectTimer=window.setTimeout((()=>this.resetReconnectTimer()),g))}resetReconnectTimer(){clearTimeout(this.reconnectTimer),this.reconnectTimer=null}isReconnectAllowed(){return!!this.reconnectTimer&&!this.isDisposing}getReconnectDelayTime(){return 1e3*Math.min(++this.reconnectDelayTime,this.settings.maxReconnectDelayTime)}getMaxNetworkWaitTime(){const g=this.reconnectTimerStart>0?Date.now()-this.reconnectTimerStart:0;return Math.max(this.settings.reconnectTimeLimit-g,0)}onReconnectFailed(g,m){this.callback.onSessionErrorOccurred({type:je.MEDIA_ERROR.iceConnectionError,detail:`Reconnect failed, error - ${stringifyObject(g)}`},m,this.wasConnected)}setSignalingState(g){this._isSignalingStable=g}async handleTmpConnectivityLoss(g){this.logger.safe.info(`[${g}] Session went into disconnected state, giving it ${this.settings.losingConnectivityTimeoutMs}ms to recover`),-1!==this.settings.losingConnectivityTimeoutMs&&(await delay(this.settings.losingConnectivityTimeoutMs),this.isDisconnected&&this.raiseReconnectEvent("Poor",g)),this.isDisconnected&&this.settings.reconnectOnDisconnect&&(this.logger.safe.info(`[${g}] Session is still down, triggering reconnect`),this.onIceDisconnect(g))}},sv=class{constructor(g,m){this.stats=g,this.diagnostics=m}set mediaLegId(g){this.stats.setMediaLegId(g.process()),this.diagnostics&&(this.diagnostics.mediaLegId=g)}set isMultiParty(g){g&&this.stats.setMultiParty(),this.diagnostics&&(this.diagnostics.isMultiParty=g)}set allowedModalities(g){this.stats.setSendModalities(g),this.diagnostics&&(this.diagnostics.allowedModalities=g)}set sessionError(g){this.stats.setError(g),this.diagnostics&&(this.diagnostics.sessionError=g)}set finalAnswerTime(g){this.stats.setFinalAnswerTimestamp(g),this.diagnostics&&(this.diagnostics.finalAnswerTime=g)}set dtmfResult(g){this.stats.dtmfResult(g),this.diagnostics&&(this.diagnostics.dtmfResult=g)}set swMute(g){this.stats.setSwMute(g),this.diagnostics&&(this.diagnostics.swMute=g)}set speakerMute(g){this.stats.setSpeakerMute(g),this.diagnostics&&(this.diagnostics.speakerMute=g)}set hwSilent(g){this.stats.setHwSilent(g),this.diagnostics&&(this.diagnostics.hwSilent=g)}set isSpeaking(g){this.stats.setSpeakingState(g),this.diagnostics&&(this.diagnostics.isSpeaking=g)}set iceConnectedStateTimestamp(g){this.stats.setIceConnectedStateTimestamp(g),this.diagnostics&&(this.diagnostics.iceConnectedStateTimestamp=g)}set iceInitTime(g){this.stats.setIceInitTimestamp(g),this.diagnostics&&(this.diagnostics.iceInitTime=g)}set ETag(g){this.stats.setETag(g),this.diagnostics&&(this.diagnostics.ETag=g)}set configIds(g){this.stats.setConfigIds(g),this.diagnostics&&(this.diagnostics.configIds=g)}set relay(g){this.stats.setRelay(g),this.diagnostics&&(this.diagnostics.relay=g)}negotiationStart(g){switch(this.diagnostics?.negotiationStart(g),g){case"Offering":this.stats.negotiation.offering.started();break;case"Answering":this.stats.negotiation.answering.started()}}negotiationCompleted(g){this.stats.negotiation.current.completed(g),this.diagnostics?.negotiationCompleted(g)}negotiationRejected(){this.stats.negotiation.current.rejected(),this.diagnostics?.negotiationRejected()}registerTransportConnected(){this.stats.registerTransportConnected(),this.diagnostics?.registerTransportConnected()}registerTransportDisconnected(){this.stats.registerTransportDisconnected(),this.diagnostics?.registerTransportDisconnected()}registerTransportFailed(){this.stats.registerTransportFailed(),this.diagnostics?.registerTransportFailed()}registerRollbackEvent(g){this.stats.registerRollbackEvent(g),this.diagnostics?.registerRollbackEvent(g)}registerRawMediaAccess(g,m,f){"send"===m?this.stats.registerSetInputRawMedia(f):this.stats.registerOutputRawMediaAccess(),this.diagnostics?.registerRawMediaAccess(g,m,f)}registerQualityStateChangedEvent(g){this.stats.registerQualityStateChangedEvent(g),this.diagnostics?.registerQualityStateChangedEvent(g)}terminated(g){this.stats.terminated(g),this.diagnostics?.terminated(g)}},av=class{constructor(g){this.logger=g,this.operationQueue=null,this.currentOperationDeferred=null,this.operationQueue=new Lp(this.logger)}queueOperation(g,m=generateCauseId()){this.logger.safe.info(`[${m}] queueing operation`);const f=new Sr,S=this.operationQueue.add((()=>(this.currentOperationDeferred=f,g())),m);return this.operationQueue.add(f,m),S}completeCurrentOperation(){this.currentOperationDeferred&&(this.logger.safe.info("completing operation"),this.currentOperationDeferred.resolve())}},ov=class extends Be{constructor(g,m,f,S,v,C,_,E=f.getLogger().createChild("SessionV2",m)){super(E),this.session=g,this.context=f,this.callback=S,this.statistics=v,this.configProvider=C,this.diagnostics=_,this.logger=E,this.audioStreamStates={[je.STREAMING_STATE.inactive]:[je.STREAMING_STATE.started,je.STREAMING_STATE.active,je.STREAMING_STATE.failed],[je.STREAMING_STATE.started]:[je.STREAMING_STATE.active,je.STREAMING_STATE.removed,je.STREAMING_STATE.stopped,je.STREAMING_STATE.failed],[je.STREAMING_STATE.active]:[je.STREAMING_STATE.removed,je.STREAMING_STATE.stopped,je.STREAMING_STATE.failed]},this.mediaLegId=new ZS,this.rejectedNegotiations=0,this.negotiationState=null,this.audioStreamState=je.STREAMING_STATE.inactive,this.deviceManagerDisposables=[],this.visibilityChangedHandler=()=>{if(this.logger.safe.debug(`document.visibilityState changed: ${document.visibilityState}`),"visible"===document.visibilityState&&this.pcClosedInfo){const g=this.pcClosedInfo;this.pcClosedInfo=null,Date.now()<g.timestamp+this.configProvider.config.reconnectWakeupTimeLimit?(this.logger.safe.info(`[${g.causeId}] start reconnect after wakeup`),this.startReconnect(g.causeId)):(this.logger.safe.info(`[${g.causeId}] terminate a call after wakeup because allowed time limit for reconnect exceeded`),this.endCallOnFailure(g.mediaError,g.causeId))}},this.ufdManager=f.getUfdManager(),this.ufdManagerDisposable=this.ufdManager.on("onQualityChanged",(g=>this.qualityChanged(g))),this.sessionOperationQueue=new av(this.logger),this.mediaLegId=new ZS,this.diagnosticsWrapper=new sv(this.statistics,this.diagnostics),this.statistics.setId(m),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.diagnosticsWrapper.ETag=this.configProvider.ETag,this.diagnosticsWrapper.configIds=this.configProvider.ecsConfigIds,this.diagnosticsWrapper.isMultiParty=!!f.config.isConference,this.recoverableErrors=this.configProvider.config.recoverableMediaErrors.split(","),this.forceReconnectErrors=this.configProvider.config.forceReconnectErrors.split(",");const T=this.getSessionCallbacks();g.callbacks=T,g.relayManagerProvider=this,this.reconnectManager=new rv(g,f,new tv(this.statistics,this.diagnostics?new XS:void 0,this.diagnostics),this.sessionOperationQueue,this.getReconnectManagerCallbacks(),T,this.configProvider,this.getRelayManager()),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesPermissionChanged",(()=>this.diagnosticsWrapper.allowedModalities=this.getAllowedModalities()))),this.deviceManagerDisposables.push(this.deviceManager.on("onSelectedDevicesChanged",(()=>this.deviceSelectionChanged()))),this.deviceManagerDisposables.push(this.deviceManager.on("onDevicesChanged",((g,m)=>this.deviceListChanged(m)))),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount()),this.ufdManager.applyCurrentState((g=>this.qualityChanged(g))),document.addEventListener("visibilitychange",this.visibilityChangedHandler),this.requestWakeLock()}async requestWakeLock(){if(qs.isWakeLockSupported()&&this.configProvider.config.useWakeLockApi)try{this.wakeLock=await window.navigator.wakeLock.request("screen")}catch(g){this.logger.safe.info(`Wakelock request failed - ${g.message}`)}}enableTeamsRealTimeTelemetry(){this.realtimeTelemetryInterval||(this.logger.safe.info("teams realtime telemetry is enabled"),this.getSessionCallbacks().onTeamsRealtimeTelemetryReport(),this.realtimeTelemetryInterval=window.setInterval((()=>{this.getSessionCallbacks().onTeamsRealtimeTelemetryReport()}),1e3*this.configProvider.config.diagnostics.teamsRealtimeTelemetry.pollingInterval))}getMediaStatsReport(){return this.diagnostics?.mediaStatsReport}createOfferAsync(g){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Offering");try{const m=await this.getCurrentSession().createOfferAsync(g);return this.updateSelectedDevices(),m.mediaLegId=this.mediaLegId.process(m.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,this.reconnectManager.isReconnecting()&&!this.reconnectManager.isSignalingStable()&&(this.reconnectManager.registerRetargetOutgoing(),m.newOffer=!0),m}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}),g)}setCallConstraints(g,m){return this.getCurrentSession().setCallConstraints(g,m)}processOfferAsync(g,m){return this.sessionOperationQueue.queueOperation((async()=>{this.diagnosticsWrapper.negotiationStart("Answering"),g.mediaLegId=this.mediaLegId.process(g.mediaLegId);try{g.newOffer&&await this.reconnectManager.acceptReconnectStartAsync(g.escalationOccurring,m);const f=await this.getCurrentSession().processOfferAsync(g,m);if(g.newOffer){const g=await this.reconnectManager.acceptReconnectFinish(m);return f.sharing===je.MEDIA_STATE.sendReceive&&(f.sharing=g.sharing===je.MEDIA_STATE.send?je.MEDIA_STATE.send:je.MEDIA_STATE.receive),f}return f}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}),m)}async processAnswerAsync(g,m,f,S){try{return await this.getCurrentSession().processAnswerAsync(g,m,f,S)}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}async completeNegotiationAsync(g){this.rejectedNegotiations=0;try{const m=await this.getCurrentSession().completeNegotiationAsync(g);return this.negotiationState=m,this.diagnosticsWrapper.finalAnswerTime=Date.now(),this.diagnosticsWrapper.negotiationCompleted?.(m.activeModalities),await this.reconnectManager.onNegotiationCompletedAsync(g),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}ignoreNotReconnectError(g){return g.detail?.type!==je.MEDIA_ERROR.incompatibleOriginator}async rejectNegotiationAsync(g,m){this.logger.safe.info(`[${m}] rejectNegotiationAsync`,g);try{if(this.reconnectManager.isReconnecting()&&this.ignoreNotReconnectError(g))return await this.reconnectManager.onNegotiationRejection(g,m),this.registerNegotiationRejection(this.negotiationState),this.sessionOperationQueue.completeCurrentOperation(),this.negotiationState;{const f=await this.getCurrentSession().rejectNegotiationAsync(g,m,this.isRenegotiationAllowed(g.type));return this.sessionOperationQueue.completeCurrentOperation(),this.registerNegotiationRejection(f),f}}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}completeEscalationAsync(g){return this.reconnectManager.completeReconnect(g)}rejectEscalationAsync(g){return this.reconnectManager.rejectReconnect(g)}async terminate(g,m){this.logger.safe.info(`terminate reject reason: ${JSON.stringify(m||"")}`),this.registerVideoEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Video","StatsQuery")),this.registerAudioEffectsTelemetryEvent(this.deviceManager.effectsManager.getStats("Audio")),this.statistics.setPermissionStates(await this.deviceManager.getKnownPermissionStates()),this.diagnosticsWrapper.terminated(m);const always=()=>this.cleanUp();return this.reconnectManager.terminateAsync(g).then(always,always)}async getStatsAsync(g){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.getMainSession().getStatsAsync(g).then((g=>this.prepareStats(g)))}getLastKnownStats(g=!1){return this.configProvider.config.diagnostics.useForTelemetry?this.diagnostics?.telemetryReport:this.prepareStats(this.getMainSession().getLastKnownStats(g),g)}getCallTechnicalInfo(){return this.diagnostics?.realtimeTelemetryReport}async createAnswerAsync(g,m){try{const f=await this.getCurrentSession().createAnswerAsync(g,m);return this.updateSelectedDevices(),f.mediaLegId=this.mediaLegId.process(f.mediaLegId),this.diagnosticsWrapper.mediaLegId=this.mediaLegId,f}catch(g){throw this.diagnosticsWrapper.sessionError=g,g}}configureModalitiesAsync(g,m){return forOwn(g,((m,f)=>{m||delete g[f]})),this.reconnectManager.configureModalitiesAsync(g,m)}getAllowedModalities(){return this.deviceManager.getAllowedModalities()}createRemoteRenderer(g){return this.getMainSession().createRemoteRenderer(g)}async sendDtmf(g){try{const m=await this.getMainSession().sendDtmf(g);return this.diagnosticsWrapper.dtmfResult=!0,m}catch(g){throw this.diagnosticsWrapper.dtmfResult=!1,g}}canSendDtmf(){return this.reconnectManager.canSendDtmf()}getExtensionsManager(){return this.reconnectManager.getExtensionsManager()}muteHold(g,m){this.reconnectManager.muteHold(g,m)}muteInputAsync(g){return this.diagnosticsWrapper.swMute=!0,this.ufdManager.setSwMute(!0),this.reconnectManager.muteInputAsync(g)}unmuteInputAsync(g){return this.diagnosticsWrapper.swMute=!1,this.ufdManager.setSwMute(!1),this.reconnectManager.unmuteInputAsync(g)}muteOutputAsync(g){return this.diagnosticsWrapper.speakerMute=!0,this.reconnectManager.muteOutputAsync(g)}unmuteOutputAsync(g){return this.diagnosticsWrapper.speakerMute=!1,this.reconnectManager.unmuteOutputAsync(g)}getAcceptedTypes(){return this.reconnectManager.getCurrentSession().getAcceptedTypes()}useNullAudioStreamClient(){this.getCurrentSession().useNullAudioStreamClient()}createAudioElement(g){this.getCurrentSession().createAudioElement(g)}getIncomingRawAudioStream(){return this.diagnosticsWrapper.registerRawMediaAccess("audio","recv",!0),this.getCurrentSession().getIncomingRawAudioStream()}getUnmixedAudioProvider(){return this.getCurrentSession().getUnmixedAudioProvider()}deviceSelectionChanged(){this.updateSelectedDevices(),this.reconnectManager._deviceSelectionChanged()}registerDeviceTelemetryEvent(g){this.getCurrentSession().onDeviceEvent(g),this.statistics.registerDeviceTelemetryEvent(g)}registerVideoEffectsTelemetryEvent(g){this.statistics.registerVideoEffectsTelemetryEvent(g)}registerAudioEffectsTelemetryEvent(g){this.statistics.registerAudioEffectsTelemetryEvent(g)}reconnectAsync(g,m=!1){return this.reconnectManager.reconnectAsync(g,!0,m)}isReconnecting(){return this.reconnectManager.isReconnecting()}getRelayManager(){return this.relayManager??(this.relayManager=new ev(this.context.maContext.getRelayManager(),this.diagnosticsWrapper))}getSessionConfig(){return this.reconnectManager.getCurrentSession().getSessionConfig()}getDiagnostics(){return this.diagnostics}getLocalMediaTrackId(g){return this.reconnectManager.getMainSession().getLocalMediaTrackId(g)}getSubscriptionManager(){return this.getCurrentSession().getSubscriptionManager()}getDisabledModalities(){return this.getCurrentSession().getDisabledModalities()}configureSpatialAudio(g,m){this.getCurrentSession().configureSpatialAudio(g,m)}setParticipantSpatialAudioPositions(g,m){this.getCurrentSession().setParticipantSpatialAudioPositions(g,m)}startMediaDescriptionsUpdateAsync(g){return this.getCurrentSession().startMediaDescriptionsUpdateAsync(g)}completeMediaDescriptionsUpdateAsync(g){return this.getCurrentSession().completeMediaDescriptionsUpdateAsync(g)}rejectMediaDescriptionsUpdateAsync(g,m){return this.getCurrentSession().rejectMediaDescriptionsUpdateAsync(g,m)}processNotification(g,m){this.session.processNotification(g,m)}async cleanUp(){this.callback=null,this.deviceManagerDisposables.forEach((g=>g.dispose())),this.ufdManagerDisposable.dispose(),this.reconnectManager.dispose(),this.pcClosedInfo=null,document.removeEventListener("visibilitychange",this.visibilityChangedHandler),window.clearInterval(this.realtimeTelemetryInterval),this.wakeLock&&(await this.wakeLock.release(),this.wakeLock=null)}updateSelectedDevices(){const g=this.deviceManager.getSelectedDevices(),getDeviceName=g=>g?this.deviceManager.getDeviceNameAsync(g).then((g=>scrubDeviceLabelPii(g,this.configProvider.config.devices.piiSafeWords))):Promise.resolve("none");Promise.all([getDeviceName(g.microphone),getDeviceName(g.speaker),getDeviceName(g.camera)]).then((([g,m,f])=>{this.statistics.setUsedDevices({microphone:g,speaker:m,camera:f})}))}getCurrentSession(){return this.reconnectManager.getCurrentSession()}getMainSession(){return this.reconnectManager.getMainSession()}setAudioStreamState(g,m){this.isAudioStateValid(g)?this.raiseAudioStateChanged(g,m):this.logger.safe.error(`[${m}] audio state transition is invalid: ${this.audioStreamState} -> ${g}`)}isAudioStateValid(g){return this.audioStreamStates[this.audioStreamState].indexOf(g)>=-1}raiseAudioStateChanged(g,m){if(this.logger.safe.info(`[${m}] audio state changed to ${g}`),this.callback.onAudioStateChanged){const m={content:"audio",direction:"receive",stream:g};this.callback.onAudioStateChanged(m)}}getReconnectManagerCallbacks(){return{onSessionErrorOccurred:(g,m,f)=>{this.isNetworkMediaError(g)&&!f&&this.ufdManager.raisePendingWhitelistingUFD(),this.endCallOnFailure(g,m)}}}isNetworkMediaError(g){return g.type===je.MEDIA_ERROR.iceConnectionError||g.type===je.MEDIA_ERROR.noNetworkError}isRecoverableMediaError(g){return this.recoverableErrors.includes(g.type)}startReconnect(g=generateCauseId()){return this.reconnectManager.onIceDisconnect(g)}shouldForceReconnect(g){return this.forceReconnectErrors.includes(g.type)}isUnexpectedPcClose(g){return g.type===je.MEDIA_ERROR.unexpectedClose}getSessionCallbacks(){return this.sessionCallbacks||(this.sessionCallbacks={onTerminated:()=>{this.logger.safe.warn("call onTerminated"),this.event("onTerminated").raise(this)},onSessionErrorOccurred:(g,m=generateCauseId())=>this.isUnexpectedPcClose(g)?this.handlePcClosed(g,m):this.shouldForceReconnect(g)?this.reconnectManager.reconnectAsync(m,!0):this.isRecoverableMediaError(g)?this.reconnectManager.isReconnecting()?this.reconnectManager.onSessionErrorOccurred(g,m):this.startReconnect(m):(this.endCallOnFailure(g,m),Promise.resolve()),onNegotiationRequired:g=>this.callback.onNegotiationRequired(g),onAudioHwSilentChanged:g=>{this.diagnosticsWrapper.hwSilent=g},onAudioStateChanged:(g,m)=>{this.setAudioStreamState(g,m)},onTransportConnected:(g=generateCauseId())=>{this.logger.safe.info(`[${g}] Transport connectivity established`),this.ufdManager.cancelPendingWhitelistingUFD(),this.reconnectManager.onConnected(g),this.diagnosticsWrapper.registerTransportConnected(),this.diagnosticsWrapper.iceConnectedStateTimestamp=Date.now(),this.callback?.onTransportConnected(g)},onTransportDisconnected:(g=generateCauseId())=>{this.logger.safe.warn(`[${g}] Transport connectivity lost`),this.reconnectManager.onTransportDisconnect(g),this.diagnosticsWrapper.registerTransportDisconnected()},onTransportFailed:()=>{this.diagnosticsWrapper.registerTransportFailed()},onTransportInitialized:()=>{this.diagnosticsWrapper.iceInitTime=Date.now()},onUpdateMediaDescriptionsRequired:g=>this.callback.onUpdateMediaDescriptionsRequired(g),onTeamsRealtimeTelemetryReport:()=>this.callback.onRealtimeTelemetryReport()}),this.sessionCallbacks}registerNegotiationRejection(g){this.rejectedNegotiations++,this.diagnosticsWrapper.negotiationRejected?.(),g.rollback&&this.diagnosticsWrapper.registerRollbackEvent(g.rollback)}isRenegotiationAllowed(g){return this.rejectedNegotiations<this.context.configProvider.config.renegotiationAttempts&&!this.reconnectManager.isReconnectScheduled&&(je.RENEGOTIATION_ERROR.signaling===g||je.RENEGOTIATION_ERROR.media===g)}prepareStats(g,m=!1){return this.statistics.setDeviceList(this.deviceManager.getDeviceDescriptions(),this.deviceManager.getDeviceListDebugInfo()),this.statistics.setRelayManagerTimers(this.getRelayManager().getStats()),this.statistics.setVideoEffectStats(this.context.callDeviceManager.getDeviceManager("Video").effectsManager.getStats("Video","StatsQuery")),this.statistics.setAudioEffectStats(this.deviceManager.effectsManager.getStats("Audio")),this.statistics.generateStatistics(g,this.mediaLegId,m)}deviceListChanged(g){g&&this.statistics.deviceChangedByPoll(),this.statistics.devicesChanged(),this.statistics.setDevicesCount(this.deviceManager.getDevicesCount())}qualityChanged(g){const m=g.deviceManagerId;!m||this.context.callDeviceManager.hasDevice(m)?this.callback?.onQualityChanged&&(this.diagnosticsWrapper.registerQualityStateChangedEvent(g),"DeviceSpeakWhileMuted"===g.type&&(this.diagnosticsWrapper.isSpeaking="Good"!==g.value),this.callback.onQualityChanged(g)):this.logger.info(`${m} - is not added to Call, skipping UFD.`)}endCallOnFailure(g,m){this.callback&&(this.callback.onSessionErrorOccurred&&this.callback.onSessionErrorOccurred(g,m),this.diagnosticsWrapper.sessionError=g,this.setAudioStreamState(je.STREAMING_STATE.failed,m))}async handlePcClosed(g,m){const f=this.configProvider.config.reconnectWakeupTimeLimit;return this.logger.safe.info(`[${m}] handle unexpected PC closed event`,`visibilityState=${document.visibilityState}, wakeupLimit=${this.configProvider.config.reconnectWakeupTimeLimit}`),"visible"===document.visibilityState?this.startReconnect(m):f?void(this.pcClosedInfo={timestamp:Date.now(),causeId:m,mediaError:g}):this.endCallOnFailure(g,m)}},lv=class{constructor(g){this.creationTime=g,this.records=[],this.activeRecord=null,this.activeAttempt=null,this.reconnectState=!1}getReport(){return this.records.length?JSON.stringify(this.records):""}isReconnecting(){return this.reconnectState}onReconnectStart(){this.reconnectState=!0,this.activeRecord||(this.activeRecord={attempts:[],endTime:null,startTime:Date.now()-this.creationTime},this.records.push(this.activeRecord))}onReconnectAttempt(g){if(!this.activeRecord)return null;this.activeAttempt={direction:g,status:!1,endTime:null,startTime:this.getTimestamp()},this.reconnectState=!0,this.activeRecord.attempts.push(this.activeAttempt)}onReconnectConnected(){if(!this.activeRecord)return null;this.reconnectState=!1,this.activeRecord.endTime=this.getTimestamp(),this.activeRecord=this.activeAttempt=null}onReconnectCompleted(){this.reconnectState=!1,this.resolveReconnectAttempt(!0)}onReconnectRejected(){this.resolveReconnectAttempt(!1)}resolveReconnectAttempt(g){this.activeAttempt&&this.activeRecord&&(this.activeAttempt.status=g,this.activeAttempt.endTime=this.getTimestamp())}getTimestamp(){return Date.now()-this.creationTime-this.activeRecord.startTime}},cv=window.navigator,dv=class{constructor(g="Good"){this.stopWatches=[],this.currentLevel=g,this.getStopWatch(g).start()}updateLevel(g){this.currentLevel!==g&&(this.getStopWatch(this.currentLevel).stop(),this.currentLevel=g,this.getStopWatch(this.currentLevel).start())}getCount(g){const m=this.stopWatches[g];return m?m.count:0}getElapsed(g){const m=this.stopWatches[g];return m?m.elapsed:0}getStopWatch(g){let m=this.stopWatches[g];return m||(m=new HS,this.stopWatches[g]=m),m}},hv=RegExp(/^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\:[0-9]{2,5})?$/),uv=RegExp(/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))(:[0-9]{2,5})?$/),gv=class{constructor(g,m,f){this.configProvider=g,this.callNumber=m,this.sessionDiagnostics=f,this.negotiation={offering:this.offering(),answering:this.answering(),current:this.current()},this.creationTime=Date.now(),this.negotiationCount=0,this.initialNegotiationCompleted=!1,this.activeModalities={},this.multiParty=!1,this.noIceCandidatesGoodEventCount=0,this.noIceCandidatesBadEventCount=0,this.noRelayIceCandidatesGoodEventCount=0,this.noRelayIceCandidatesBadEventCount=0,this.cameraInUseBadEventCount=0,this.cameraInUseGoodEventCount=0,this.microphoneInUseBadEventCount=0,this.microphoneInUseGoodEventCount=0,this.cameraFreezeStartEventCount=0,this.cameraFreezeEndEventCount=0,this.networkRecv=new dv,this.networkSend=new dv,this.retargetIncomingCount=0,this.retargetOutgoingCount=0,this.retargetCompletedCount=0,this.retargetRejectedCount=0,this.reconnectAttemptedCount=0,this.reconnectConnectedCount=0,this.escalationAttemptedCount=0,this.escalationCompletedCount=0,this.escalationRejectedCount=0,this.durationTimer=new HS,this.terminationReason={},this.terminationTime=0,this.sessionId="0",this.rejectedNegotiationCount=0,this.mediaError={type:"none",detail:"none"},this.incompatibleOffer=!1,this.dtmfSuccess=0,this.dtmfFailure=0,this.relay=null,this.relayManagerTimers=null,this.allowedAudioSend=!0,this.allowedVideoSend=!0,this.allowedScreensharingSend=!0,this.iceInitTime=0,this.finalAnswerTime=0,this.iceConnectedStateTime=0,this.usedDevices=null,this.deviceSelectionChangeCount=0,this.devicesChangeCount=0,this.devicesPollChangeCount=0,this.mute=new HS,this.osMute=new HS,this.hwSilent=new HS,this.isSpeaking=new HS,this.swMute=new HS,this.speakerMute=new HS,this.deviceTelemetryEvents=[],this.videoEffectsTelemetryEvents=new Wm(this.configProvider.config.effectsTelemetryBufferSize),this.audioEffectsTelemetryEvents=new Wm(this.configProvider.config.effectsTelemetryBufferSize),this.devicesCount=null,this.reconnectStats=new lv(this.creationTime),this.transportDisconnected=!1,this.transportReconnectedCount=0,this.ufds=[],this.mediaQosEnabled=!1,this.portRangeConfigured=!1,this.rollbackNegotiation=[],this.rawOutputAudioAccess={attempt:0,timer:new HS},this.rawInputAudioOverride={attempt:0,timer:new HS},this.connectionEffectiveTypeSeries=new Wm(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionRttSeries=new Wm(this.configProvider.config.navConnectionNumSamplesToCollect),this.connectionDownlinkSeries=new Wm(this.configProvider.config.navConnectionNumSamplesToCollect),this.navigatorConnectionInterval=setInterval((()=>{const g=cv?.connection;g&&("number"==typeof g.downlink&&this.connectionDownlinkSeries.add(g.downlink),"number"==typeof g.rtt&&this.connectionRttSeries.add(g.rtt),"number"==typeof g.effectiveType&&this.connectionEffectiveTypeSeries.add(g.effectiveType))}),this.configProvider.config.navConnectionPollingInterval),this.durationTimer.start()}terminated(g){this.terminationReason=deepClone(g),this.terminationTime=Date.now(),this.durationTimer.stop(),this.osMute.stop(),this.swMute.stop(),this.hwSilent.stop(),this.isSpeaking.stop(),this.mute.stop(),this.speakerMute.stop(),this.rawInputAudioOverride.timer.stop(),this.rawOutputAudioAccess.timer.stop(),clearInterval(this.navigatorConnectionInterval)}setMultiParty(){this.multiParty=!0}updateCommonMute(){this.swMute.isRunning||this.osMute.isRunning?this.mute.start():this.mute.stop()}setDeviceList(g,m){this.deviceList=g.map((g=>({label:scrubDeviceLabelPii(g.label,this.configProvider.config.devices.piiSafeWords),kind:g.kind}))),m&&(this.deviceDebugStrings=deepClone(m))}setPermissionStates(g){this.permissionStates=g}setSwMute(g){g?this.swMute.start():this.swMute.stop(),this.updateCommonMute()}setSpeakerMute(g){g?this.speakerMute.start():this.speakerMute.stop()}setHwSilent(g){g?this.hwSilent.start():this.hwSilent.stop()}setSpeakingState(g){g?this.isSpeaking.start():this.isSpeaking.stop()}setETag(g){this.ETag=g}setConfigIds(g){this.configIds=g}setVideoEffectStats(g){g&&this.videoEffectsTelemetryEvents.add(g)}setAudioEffectStats(g){g&&this.audioEffectsTelemetryEvents.add(g)}registerQualityStateChangedEvent(g){switch(g.type){case"NoNetwork":"Good"===g.value?this.noIceCandidatesGoodEventCount++:this.noIceCandidatesBadEventCount++;break;case"NetworkRelaysNotReachable":"Good"===g.value?this.noRelayIceCandidatesGoodEventCount++:this.noRelayIceCandidatesBadEventCount++;break;case"DeviceCaptureNotFunctioning":"Good"===g.value?this.microphoneInUseGoodEventCount++:this.microphoneInUseBadEventCount++;break;case"VideoCapturerDeviceStartFailed":"Good"===g.value?this.cameraInUseGoodEventCount++:this.cameraInUseBadEventCount++;break;case"DeviceCaptureMute":"Audio"===g.mediaType&&("Bad"===g.value?this.osMute.start():this.osMute.stop(),this.updateCommonMute());break;case"NetworkRecvQuality":this.networkRecv.updateLevel(g.value);break;case"NetworkSendQuality":this.networkSend.updateLevel(g.value);break;case"VideoCaptureDeviceFreeze":"Good"===g.value?this.cameraFreezeEndEventCount++:this.cameraFreezeStartEventCount++}"DeviceSpeakWhileMuted"!==g.type&&this.ufds.push({...g,timestamp:Date.now()-this.creationTime}),this.ufds.length>this.configProvider.config.maxStoredUFDCount&&this.ufds.shift()}registerRetargetIncoming(){this.retargetIncomingCount++}registerRetargetOutgoing(){this.retargetOutgoingCount++}registerRetargetCompleted(){this.retargetCompletedCount++}registerRetargetRejected(){this.retargetRejectedCount++}registerEscalationStart(){this.escalationAttemptedCount++}registerEscalationCompleted(){this.escalationCompletedCount++}registerEscalationRejected(){this.escalationRejectedCount++}registerRollbackEvent(g){g&&this.rollbackNegotiation.push({type:g.type,attempt:this.rollbackNegotiation.length+1,error:g.error?g.error:""})}registerReconnectAttempted(){this.reconnectAttemptedCount++,this.reconnectStats.onReconnectStart()}registerReconnectConnected(){this.reconnectConnectedCount++,this.reconnectStats.onReconnectConnected()}registerDeviceTelemetryEvent(g){g.timestamp=g.timestamp-this.creationTime,this.deviceTelemetryEvents.push(g)}registerVideoEffectsTelemetryEvent(g){g&&(g.timestamp=g.timestamp-this.creationTime,this.videoEffectsTelemetryEvents.add(g))}registerAudioEffectsTelemetryEvent(g){if(g){g.timestamp=g.timestamp-this.creationTime;const m=this.audioEffectsTelemetryEvents.items.pop();m&&this.audioEffectsChanged(m,g)&&this.audioEffectsTelemetryEvents.add(m),this.audioEffectsTelemetryEvents.add(g)}}audioEffectsChanged(g,m){return g.payload.fallback!==m.payload.fallback||(void 0!==m.payload.userNoiseSuppressionMethod&&g.payload.userNoiseSuppressionMethod!==m.payload.userNoiseSuppressionMethod||void 0!==m.payload.userAudioEffect&&g.payload.userAudioEffect!==m.payload.userAudioEffect)}registerReconnectAttempt(g){this.reconnectStats.onReconnectAttempt(g)}registerReconnectAttemptCompleted(){this.reconnectStats.onReconnectCompleted()}registerReconnectAttemptRejected(){this.reconnectStats.onReconnectRejected()}setMediaLegId(g){this.mediaLegId=g}setId(g){this.sessionId=g}setError(g){g.type===je.MEDIA_ERROR.incompatibleOffer&&(this.incompatibleOffer=!0),this.mediaError.type=g.type||je.MEDIA_ERROR.internalError,this.mediaError.detail=g.detail||g.toString()}setRelay(g){this.relay={address:g.addresses.join(),expires:g.expires,realm:g.realm,credentials:!(!g.username||!g.password),ports:[g.udpPort?`udp:${g.udpPort}`:"",g.tcpPort?`tcp:${g.tcpPort}`:"",g.tlsPort?`tls:${g.tlsPort}`:""].join(","),fqdns:g.fqdns?g.fqdns.join():"none"}}setRelayManagerTimers(g){this.relayManagerTimers=g}setSendModalities(g){this.allowedAudioSend=g.audio.some((g=>hasSendDirectionality(g))),this.allowedVideoSend=g.video.some((g=>hasSendDirectionality(g))),this.allowedScreensharingSend=g.sharing.some((g=>hasSendDirectionality(g)))}setIceInitTimestamp(g){this.iceInitTime||(this.iceInitTime=g)}setFinalAnswerTimestamp(g){this.finalAnswerTime||(this.finalAnswerTime=g)}setIceConnectedStateTimestamp(g){this.iceConnectedStateTime||(this.iceConnectedStateTime=g)}dtmfResult(g){g?++this.dtmfSuccess:++this.dtmfFailure}setUsedDevices(g){this.usedDevices&&JSON.stringify(g)!==JSON.stringify(this.usedDevices)&&this.deviceSelectionChangeCount++,this.usedDevices=g}setDevicesCount(g){this.devicesCount=g}setMediaQosEnabled(g){this.mediaQosEnabled=g}setPortRangeConfigured(g){this.portRangeConfigured=g}devicesChanged(){this.devicesChangeCount++}deviceChangedByPoll(){this.devicesPollChangeCount++}registerOutputRawMediaAccess(){this.rawOutputAudioAccess.attempt++,this.rawOutputAudioAccess.timer.start()}registerSetInputRawMedia(g){this.rawInputAudioOverride.attempt++,g?this.rawInputAudioOverride.timer.start():this.rawInputAudioOverride.timer.stop()}getReport(){const g=this.usedDevices||{microphone:"none",speaker:"none",camera:"none"};return{RawOutputAudioAccessDurationRatio:this.getDurationRatio(this.rawOutputAudioAccess.timer.elapsed),RawOutputAudioAccessAttempted:this.rawOutputAudioAccess.attempt,RawInputAudioOverrideDurationRatio:this.getDurationRatio(this.rawInputAudioOverride.timer.elapsed),RawInputAudioOverrideAttempted:this.rawInputAudioOverride.attempt,SessionId:this.sessionId,CallNumber:this.callNumber,NoIceCandidatesBadEventCount:this.noIceCandidatesBadEventCount,NoIceCandidatesGoodEventCount:this.noIceCandidatesGoodEventCount,NoRelayIceCandidatesBadEventCount:this.noRelayIceCandidatesBadEventCount,NoRelayIceCandidatesGoodEventCount:this.noRelayIceCandidatesGoodEventCount,CameraInUseBadEventCount:this.cameraInUseBadEventCount,CameraInUseGoodEventCount:this.cameraInUseGoodEventCount,MicrophoneInUseBadEventCount:this.microphoneInUseBadEventCount,MicrophoneInUseGoodEventCount:this.microphoneInUseGoodEventCount,CameraFreezeStartEventCount:this.cameraFreezeStartEventCount,CameraFreezeEndEventCount:this.cameraFreezeEndEventCount,RetargetIncomingCount:this.retargetIncomingCount,RetargetOutgoingCount:this.retargetOutgoingCount,RetargetCompletedCount:this.retargetCompletedCount,RetargetRejectedCount:this.retargetRejectedCount,ReconnectAttemptedCount:this.reconnectAttemptedCount,ReconnectConnectedCount:this.reconnectConnectedCount,EscalationAttemptedCount:this.escalationAttemptedCount,EscalationCompletedCount:this.escalationCompletedCount,EscalationRejectedCount:this.escalationRejectedCount,CreationTime:this.getHpTimeFromMillis(this.creationTime),InitTime:this.getHpTimeFromMillis(this.creationTime),TerminationTime:this.getHpTimeFromMillis(this.terminationTime),CallDuration:this.getHpTimeFromMillis(this.getCurrentDuration()),InitialNegotiationType:this.initialNegotiationType||"none",InitialNegotiationCompleted:this.initialNegotiationCompleted,ActiveModalities:JSON.stringify(this.activeModalities),NegotiationCount:this.negotiationCount,RejectedNegotiationCount:this.rejectedNegotiationCount,MediaLegId:this.mediaLegId,MultiParty:this.multiParty,ErrorType:this.mediaError.type,ErrorDetail:this.mediaError.detail,TerminationReason:this.terminationReason,IncompatibleOffer:this.incompatibleOffer,DtmfSuccess:this.dtmfSuccess,DtmfFailure:this.dtmfFailure,Relay:this.relay?JSON.stringify(this.relay):"none",RelayManager:this.relayManagerTimers?JSON.stringify(this.relayManagerTimers):"none",AllowedAudioSend:this.allowedAudioSend,AllowedVideoSend:this.allowedVideoSend,AllowedScreensharingSend:this.allowedScreensharingSend,IceInitTime:this.getHpTimeFromMillis(this.iceInitTime),FinalAnswerTime:this.getHpTimeFromMillis(this.finalAnswerTime),IceConnectedStateTime:this.getHpTimeFromMillis(this.iceConnectedStateTime),UsedMicrophone:g.microphone,UsedSpeaker:g.speaker,UsedCamera:g.camera,DeviceSelectionChangeCount:this.deviceSelectionChangeCount,DevicesChangeCount:this.devicesChangeCount,DevicesPollChangeCount:this.devicesPollChangeCount,DevicesCount:this.devicesCount?JSON.stringify(this.devicesCount):"none",ETag:this.ETag||"",ConfigIds:this.configIds?Array.isArray(this.configIds)?this.configIds.join(","):this.configIds:"",CallMutedRatio:this.getDurationRatio(this.mute.elapsed),CallOsMuted:this.getHpTimeFromMillis(this.osMute.elapsed),CallHwSilent:this.getHpTimeFromMillis(this.hwSilent.elapsed),CallSwMuted:this.getHpTimeFromMillis(this.swMute.elapsed),CallSpeakerMuted:this.getHpTimeFromMillis(this.speakerMute.elapsed),CallIsSpeaking:this.getHpTimeFromMillis(this.isSpeaking.elapsed),NetworkRecvGood:this.networkRecv.getCount("Good")-1,NetworkRecvPoor:this.networkRecv.getCount("Poor"),NetworkRecvBad:this.networkRecv.getCount("Bad"),NetworkSendGood:this.networkSend.getCount("Good")-1,NetworkSendPoor:this.networkSend.getCount("Poor"),NetworkSendBad:this.networkSend.getCount("Bad"),NetworkRecvGoodRatio:this.getDurationRatio(this.networkRecv.getElapsed("Good")),NetworkRecvPoorRatio:this.getDurationRatio(this.networkRecv.getElapsed("Poor")),NetworkRecvBadRatio:this.getDurationRatio(this.networkRecv.getElapsed("Bad")),NetworkSendGoodRatio:this.getDurationRatio(this.networkSend.getElapsed("Good")),NetworkSendPoorRatio:this.getDurationRatio(this.networkSend.getElapsed("Poor")),NetworkSendBadRatio:this.getDurationRatio(this.networkSend.getElapsed("Bad")),DeviceEvents:JSON.stringify(this.deviceTelemetryEvents),DeviceList:JSON.stringify(this.deviceList),DeviceListDebug:JSON.stringify(this.deviceDebugStrings),VideoEffects:JSON.stringify(this.videoEffectsTelemetryEvents.items),AudioEffects:JSON.stringify(this.audioEffectsTelemetryEvents.items),PermissionStates:JSON.stringify(this.permissionStates),ReconnectAttempts:this.reconnectStats.getReport(),NetworkEvents:JSON.stringify(rebaseTime(limitArraySize(this.sessionDiagnostics?.getObjectRef().reconnect?.tmpRecords,this.configProvider.config.diagnostics.telemetryLimits.numNetworkEvents),"startTime",this.creationTime)),ReconnectInProgress:this.reconnectStats.isReconnecting(),TransportReconnectedCount:this.transportReconnectedCount,UFDs:JSON.stringify(this.ufds),MediaQosEnabled:this.mediaQosEnabled,PortRangeConfigured:this.portRangeConfigured,RollbackNegotiation:JSON.stringify(this.rollbackNegotiation),hardwareConcurrency:qs.hardwareConcurrency,GPUName:qs.unmaskedGlRenderer,Connection_Downlink:sampleseries(this.connectionDownlinkSeries.items,(g=>g)),Connection_EffectiveType:sampleseries(this.connectionEffectiveTypeSeries.items,(g=>g)),Connection_Rtt:sampleseries(this.connectionRttSeries.items,(g=>g)),Connection_SaveData:cv?.connection?.saveData,MediaByPassEnabled:!!this.configProvider.mediaConfig.mediaBypassEnabled,CallConstraints:JSON.stringify(this.configProvider.getCallConstraintsTelemetry()),DominantSpeaker:JSON.stringify(generateDominantSpeakerReport(this.sessionDiagnostics?.getObjectRef().dominantSpeaker,this.terminationTime))}}generateStatistics(g,m,f=!1){if(this.setMediaLegId(m.process()),"WebRtcMediaStats"!==g.type)throw new Error(`Unknown stats type - ${g.type}`);if(f){const g=this.deviceTelemetryEvents.length;this.deviceTelemetryEvents.splice(0,g-1),this.deviceDebugStrings=km,this.audioEffectsTelemetryEvents.clear()}g.data.metrics=this.getReport();const S=this.sessionDiagnostics?.getObjectRef().statsErrors;if(S?.length)if(g.data.Extensions?.WebRTCStats?.statsErrors){const m=JSON.parse(g.data.Extensions.WebRTCStats.statsErrors);m.push(...S),g.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(m)}else g.data.Extensions.WebRTCStats.statsErrors=JSON.stringify(S);const v={};return forOwnRec(g.data,((g,m,f)=>{let S=0;hv.test(g)?(S=13,v[m]="IPv4"):uv.test(g)&&(S=4,v[m]="IPv6"),f[m]={type:S,value:g,__VALUE__:!0}})),g.data.metrics.piiFields={type:0,value:JSON.stringify(v),__VALUE__:!0},g}registerTransportConnected(){this.transportDisconnected&&(this.transportDisconnected=!1,this.transportReconnectedCount++)}registerTransportDisconnected(){this.transportDisconnected=!0}registerTransportFailed(){this.transportDisconnected=!1}resetError(){this.setError({type:"none",detail:"none"})}offering(){return{started:()=>{this.currentNegotiationType="Offering",this.negotiationStarted()}}}answering(){return{started:()=>{this.currentNegotiationType="Answering",this.negotiationStarted()}}}negotiationStarted(){this.initialNegotiationType=this.initialNegotiationType||this.currentNegotiationType,++this.negotiationCount}current(){return{completed:g=>{this.initialNegotiationCompleted=!0,this.activeModalities=g,this.resetError()},rejected:()=>{++this.rejectedNegotiationCount}}}getDurationRatio(g){const m=this.getCurrentDuration();return g/(0!==m?m:1)}getCurrentDuration(){return this.durationTimer.elapsed}getHpTimeFromMillis(g){return 1e4*g}},pv=class{constructor(g,m,f,S){this.onActiveSpeakersChanged=g,this.onDominantSpeakersChanged=m,this.diagnostics=f,this.logger=S}setStrategy(g){this.disposeStrategy(),this.dshStrategy=g,this.dshStrategy?.setOnDominantSpeakerChanged(this.onDominantSpeakerHistoryChanged.bind(this)),this.diagnostics?.setCurrentActiveStrategy("client")}onContributingSourcesChanged(g){this.onActiveSpeakersChanged(g),this.dshStrategy?.setSources(g)}onDominantSpeakerHistoryChanged(g,m){this.onDominantSpeakersChanged(g),this.diagnostics?.recordHistoryEvent(g,m),"client"!==m&&this.dshStrategy&&(this.logger.safe.info("Disposing client DSH strategy and switching to MP provided DSH"),this.disposeStrategy())}dispose(){this.disposeStrategy(),this.onActiveSpeakersChanged=null,this.onDominantSpeakersChanged=null}disposeStrategy(){this.dshStrategy?.dispose(),this.dshStrategy=null}},mv=4294967040,fv=class{constructor(){this.ssrc=Math.floor(Math.random()*(mv-1))+1}nextAudioStreamSsrc(){return this.nextSsrc(0)}nextVideoStreamSsrc(){return this.nextSsrc(99)}nextSsrc(g){let m=this.ssrc;do{m=this.ssrc,this.ssrc=(this.ssrc+g+1)%mv,0===this.ssrc&&(this.ssrc=1)}while(m+g>mv);return{min:m,max:m+g}}},Sv=class{};Sv.SourceNone=-1,Sv.SourceAny=-2;var vv=class{constructor(g){this.listener=g,this.streams=[]}add(g){this.streams.some((m=>m.getId()===g.getId()))||(this.streams.push(g),this.listener.streamAdded(g))}remove(g){let m;remove2(this.streams,(f=>f.getId()===g&&(m=f,!0)))&&this.listener.streamRemoved(m)}getStreams(){return this.streams}clear(){this.streams.forEach((g=>g.dispose())),this.streams=[]}},yv=class{constructor(g){this.subscription=g}get subscribedStream(){return this.subscription.stream?.getMediaStream()}get msi(){return this.checkDisposed(),this.subscription.msi}get modality(){return this.checkDisposed(),this.subscription.modality}get localMsi(){return this.checkDisposed(),this.subscription.localMsi}setOnMediaStreamChangedHandler(g){this.checkDisposed(),this.mediaStreamChanged=g,this.subscription.isStreamReady&&this.notifyMediaStreamChanged()}setOnErrorHandler(g){this.checkDisposed(),this.error=g}dispose(){this.subscription&&(this.subscription.dispose(generateCauseId(),this),this.subscription=null)}unsubscribe(){this.subscription&&(this.subscription.unsubscribe(),this.subscription=null)}notifyMediaStreamChanged(){if(this.mediaStreamChanged){const g=this.subscription.stream,m=this.subscription.isStreamReady;this.mediaStreamChanged(g&&m?g.getMediaStream():null)}}notifyError(g){this.error&&this.error(g)}checkDisposed(){if(!this.subscription)throw new Error("subscription disposed")}},Cv=class extends Be{constructor(g,m,f){super(),this.modality=g,this.msi=m,this.disposeDelay=f,this.clients=[],this.streamReady=!1}createClient(){const g=new yv(this);return this.clients.push(g),g}get isStreamReady(){return this.streamReady}get localMsi(){return this.subStream?.getSourceStreamId()}get isInactive(){return!this.clients.length}get stream(){return this.subStream}set stream(g){try{if(g===this.subStream)return;this.subStream&&(this.unsubscribe(!1),this.notifyStreamChanged()),this.subStream=g,g&&(this.streamReady=!1,g.requestSource(this.msi).then((()=>{this.streamReady=!0,this.notifyStreamChanged()})).catch((g=>{this.notifyError(g)})))}catch(g){this.event("onFailed").raise(this,g)}}notifyError(g){this.clients.forEach((m=>{m.notifyError(g)})),this.event("onFailed").raise(this,g)}dispose(g,m){m?(remove2(this.clients,(g=>g===m)),this.isInactive&&(this.disposeTimeout=window.setTimeout((()=>{this.disposeTimeout=null,this.unsubscribeIfInactive()}),this.disposeDelay))):(this.clients=[],this.unsubscribe())}unsubscribeIfInactive(){this.isInactive&&(this.disposeTimeout&&clearTimeout(this.disposeTimeout),this.unsubscribe())}unsubscribe(g=!0){this.subStream&&(this.subStream.requestSource(Sv.SourceNone).catch((()=>{})),this.streamReady=!1,this.subStream=null),g&&this.event("onDisposed").raise(this)}notifyStreamChanged(){this.clients.forEach((g=>g.notifyMediaStreamChanged())),this.event("onStreamChanged").raise()}},_v=class extends Be{constructor(g,m,f,S){super(g),this.configProvider=m,this.diagnostics=S,this.videoSubscriptions=[],this.subscriptionEvents=new Map,this.setLogger(g),this.diagnostics??(this.diagnostics=new tf(this.configProvider,(()=>{}))),this.setStreamProvider(f),this.logger.safe.info("created")}getSubscriptionsCount(){return this.videoSubscriptions.length}setStreamProvider(g){this.streamProvider=g,this.streamProvider.setOnStreamsChangedHandler((()=>this.streamsChanged()))}setLogger(g){this.logger=g}subscribeVideo(g,m=Sv.SourceAny){let f=this.videoSubscriptions.find((f=>f.msi===m&&f.modality===g));if(!f){const S=Date.now();this.disposeInactiveSubscriptionIfNeeded(g);const v=this.getAvailableStream(g),C=v?.getSourceStreamId();this.logger.safe.info(`creating new subscription #${m} for modality ${g}`),this.event("onSubscriptionChanged").raise(1,g,m,C,null),this.diagnostics.addSubscribe(g,m,C),f=new Cv(g,m,this.configProvider.config.webrtcVideoSubscriptionDisposeTimeout);const _=[];_.push(f.on("onDisposed",(g=>this.onSubscriptionDisposed(g)))),_.push(f.on("onStreamChanged",(()=>{const v=f.stream?.getId(),C=f.localMsi;if(this.updateTrackIds(),f.isStreamReady){const f=Date.now();this.event("onSubscriptionChanged").raise(2,g,m,C,f-S,v),this.diagnostics.addSubscribed(g,m,C,f-S)}}))),_.push(f.on("onFailed",((g,m)=>this.onSubscriptionFailed(g,m)))),this.subscriptionEvents.set(f,_),this.videoSubscriptions.push(f),v&&this.assignStream(f,v)}return f.createClient()}dispose(){const g=generateCauseId();this.videoSubscriptions.concat().forEach((m=>m.dispose(g))),this.streamProvider.setOnStreamsChangedHandler(null),super.dispose(),this.logger.safe.info("disposed")}reriseSubscribeEvents(){this.logger.safe.info(`rerising subscription events: ${this.videoSubscriptions.length}`);const g=[];this.videoSubscriptions.forEach((m=>{const f=m.modality,S=m.msi,v=m.localMsi;this.event("onSubscriptionChanged").raise(1,f,S,v),this.diagnostics.addSubscribe(f,S,v),g.push(...this.getSubscriptionVideoTrackIds(m))})),this.diagnostics.subscribedTrackIds=g}setDiagnostics(g){this.diagnostics=g??new tf(this.configProvider,(g=>{this.logger.safe.warn(`Unhandled stats error from inactive subscription manager: ${g}`)}))}streamChangedByMsi(g){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`);const m=this.videoSubscriptions.find((m=>m.msi===g));m?this.assignSubscriptionToStream(m):this.logger.safe.error(`Subscription for msi ${g} not found`)}streamsChanged(){this.logger.safe.info(`streams changed, subscriptions active: ${this.videoSubscriptions.length}`),this.videoSubscriptions.forEach((g=>{this.assignSubscriptionToStream(g)}))}assignSubscriptionToStream(g){const m=!g.stream||this.isStreamRemoved(g.stream);if(this.logger.safe.info(`Subscription for ${g.modality} ${g.msi} needs new stream: ${m}`),!m)return;const f=this.getAvailableStream(g.modality);f?this.assignStream(g,f):this.resignStream(g)}getAvailableStream(g){return this.streamProvider.getStreams().find((m=>g===m.getModality()&&m.getMsi()===Sv.SourceNone))}isStreamRemoved(g){return!this.streamProvider.getStreams().some((m=>m===g))}assignStream(g,m){this.logger.safe.info(`assigning stream #${m.getId()} to subscription #${g.msi}`),g.stream=m}resignStream(g){g.stream&&(this.logger.safe.info(`removing stream from subscription #${g.msi}`),g.stream=null)}disposeInactiveSubscriptionIfNeeded(g){this.getAvailableStream(g)||this.videoSubscriptions.find((m=>m.modality===g&&m.isInactive))?.unsubscribeIfInactive()}onSubscriptionDisposed(g){const m=generateCauseId(),f=g.modality,S=g.msi,v=g.localMsi;this.event("onSubscriptionChanged").raise(3,f,S,v),this.diagnostics.addUnsubscribe(f,S,v),this.logger.safe.info(`disposing subscription for ${f} #${S}`),remove2(this.videoSubscriptions,(m=>m===g)),this.streamsChanged(),this.updateTrackIds(),this.subscriptionEvents.has(g)&&(this.subscriptionEvents.get(g).forEach((g=>g.dispose(m))),this.subscriptionEvents.delete(g))}updateTrackIds(){const g=[],m=[];this.videoSubscriptions.forEach((f=>{if(!f.isStreamReady)return;const S=f.stream?.getId().split("-")[1];m.push(S),g.push(...this.getSubscriptionVideoTrackIds(f))})),this.event("onTrackIdsChanged").raise(g),this.diagnostics.subscribedTrackIds=g,this.configProvider.config.subscribeToSsrcForVideo&&this.event("onTrackSsrcChanged").raise(m)}getSubscriptionVideoTrackIds(g){return g?.stream?.getMediaStream()?.getVideoTracks().map((g=>g.id))??[]}onSubscriptionFailed(g,m){this.event("onSubscriptionFailed").raise(-1,g.modality,g.msi,g.localMsi,m),this.diagnostics.addFailed(g.modality,g.msi,g.localMsi,stringifyObject(m))}},Ev=__toESM(Te()),Tv=class{constructor(g,m,f){this.logger=g,this.qualityManager=m,this.configProvider=f}getControlItem(){return this.controlItem}setControlItem(g){this.controlItem=g}dispose(){this.controlItem=null}setVideoControlMessage(g){this.controlItem=this.messageToControlItem(g),this.logger.safe.info(`BW limit requested to ${this.controlItem.bandwidth}`)}modifyDescriptor(g){if(!this.controlItem)return g;const m=Ev.parse(g.sdp);if(!m.media[1])return this.logger.unsafe.warn("video modality is disabled, skipping sdp modification, ",g),g;const f=this.getCurrentResolutionBitrate();this.logger.safe.info(`Select the BW limit as min of requested ${this.controlItem.bandwidth} and Current Resolution Max BR ${f}`);const S=this.getSessionBitrate(m),v=Math.min(f,this.controlItem.bandwidth,S);if(m.media[1].bandwidth)m.media[1].bandwidth[0].limit=v;else{const g={limit:v,type:"AS"};m.media[1].bandwidth=[g]}return g.sdp=Ev.write(m),g}messageToControlItem(g){const m=new cf(g.controlVideoStreaming.controlInfo[0].fmtParams),f="max-br",S=1.2;if(!m.contains(f))return null;const v=Math.round(+m.get(f)*S);return{sourceId:g.controlVideoStreaming.controlInfo[0].sourceId,streamMsid:g.controlVideoStreaming.controlInfo[0].streamMsid,bandwidth:v}}getCurrentResolutionBitrate(){const g=this.qualityManager.getCurrentResolution(),m=jp.Send.getResolutionByFs(g);return g&&m?Math.floor(jp.Send.getBitrateForResolution(m.width,m.height).maxBitrate/1e3):Number.MAX_VALUE}getSessionBitrate(g){let m=Number.MAX_SAFE_INTEGER;return this.configProvider.mediaConfig.maxBandwidthInKbps&&(m=this.configProvider.mediaConfig.maxBandwidthInKbps),g.bandwidth&&(m=Math.min(g.bandwidth[0].limit,m)),m-(this.configProvider.config.audioBandwidthInKbps||0)}},Iv=class{constructor(g,m,f){this.pc=g,this.configProvider=m,this.logger=f.createChild("MediaRollbackModifier")}modifyDescriptor(g){const m=Ev.parse(g.sdp);return Ev.parse(this.pc.localDescription.sdp).media.forEach(((g,f)=>{const S=m.media[f];(isMediaDisabled(g)&&!g.bundleOnly||!S||isMediaDisabled(S))&&(this.logger.safe.info(`Adding disabled media ${g.type}, position ${f}`),m.media[f]=disabledMedia(g.type,void 0,g.protocol,void 0))})),new lS(this.configProvider).modify(m),g.sdp=Ev.write(m),g}},bv=class{constructor(g){this.manager=null,this.extensionType=g}initialize(g){g.manager&&(this.manager=g.manager),g.logger&&(this.logger=g.logger.createChild(this.extensionType)),g.configProvider&&(this.configProvider=g.configProvider)}dispose(){this.manager&&(this.manager=null),this.logger&&(this.logger.safe.info("disposed"),this.logger=this.logger.createChild("DISPOSED"))}configure(g){this.options=g}getOptions(){return this.options}getType(){return this.extensionType}},Av=class extends bv{constructor(){super("dominantSpeakerHistory"),this.callback=null}initialize(g){super.initialize(g),this.extensionManagerSubscription=this.manager.on("onDominantHistoryMessage",((g,m)=>this.onDominantHistoryMessage(g,m))),g&&g.callback&&(this.callback=g.callback)}dispose(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null,this.callback=null,super.dispose()}onDominantHistoryMessage(g,m){this.callback&&("server"===m?this.callback(g.history,m):"signaling"===m&&this.callback(g.previousDominantSpeakerHistory,m))}},Pv=class{constructor(g,m,f,S,v,C){this.logger=g,this.emulator=m,this.qualityManager=f,this.diagnostics=S,this.configProvider=v,this.statsGatherer=C,this.previousSequenceNumber=new Map,this.modifiers=this.configProvider.mediaConfig.simulcastSessionEnabled?[]:[new Tv(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider)]}dispose(){this.cleanupDevToolsInjector(),this.modifiers&&(this.modifiers.forEach((g=>g.dispose())),this.modifiers=null),this.emulator=null,this.logger=this.logger.createChild("DISPOSED")}handleMessage(g){const m=g.controlInfo[0].sourceId;if(this.previousSequenceNumber.has(m)&&g.sequenceNumber<this.previousSequenceNumber.get(m))return this.statsGatherer.addVideoControlMessage(!0),this.diagnostics?.addVideoControlMessage(!0),this.logger.safe.info(`Discarded old media stream control message for sourceId ${m}: (${JSON.stringify(g)})`),Promise.resolve();this.previousSequenceNumber.set(m,g.sequenceNumber),this.statsGatherer.addVideoControlMessage(),this.diagnostics?.addVideoControlMessage(),this.configProvider.config.enableDevtoolsAPI&&this.injectFmtpHandler(g);const f={controlVideoStreaming:g};return this.configureResolution(f),this.modifiers.length?(this.modifiers.forEach((g=>g.setVideoControlMessage(f))),this.emulator.renegotiate(this.modifiers)):Promise.resolve()}configureResolution(g){this.logger.safe.info(`Signaling FMTP: ${JSON.stringify(g.controlVideoStreaming)}`);const m=String(g.controlVideoStreaming.sequenceNumber),f=g.controlVideoStreaming.controlInfo[0].fmtParamsList,S=g.controlVideoStreaming.controlInfo[0].fmtParams,v=f&&this.configProvider.config.webrtcFmtParamListSupported?this.parseFmtParamsList(f):[this.parseFmtParams(S)],C=+g.controlVideoStreaming.controlInfo[0].sourceId,_=[{causeId:m,isSimulcast:v.some((g=>void 0!==g.rid))||v.length>1,capabilities:v,sourceId:C}];this.qualityManager.setMaxCapabilities(_)}parseFmtParamsList(g){return g.map((g=>this.parseFmtParams(g)))}parseFmtParams(g){const m=new cf(g);return{maxFs:+m.get(je.VIDEO_CAPABILITIES.MAX_FS_PATH),maxMbps:+m.get(je.VIDEO_CAPABILITIES.MAX_MBPS_PATH),maxFps:+m.get(je.VIDEO_CAPABILITIES.MAX_FPS_PATH)/100,maxBr:1200*+m.get(je.VIDEO_CAPABILITIES.MAX_BR_PATH),ssrc:+m.get(je.VIDEO_CAPABILITIES.SSRC_PATH),rid:m.get(je.VIDEO_CAPABILITIES.RID_PATH),keyframe:this.shouldGenerateKeyFrame(m),vlaDebug:m.get(je.VIDEO_CAPABILITIES.VLA_DEBUG)}}shouldGenerateKeyFrame(g){return g.get(je.VIDEO_CAPABILITIES.KEYFRAME_PATH)?!!+g.get(je.VIDEO_CAPABILITIES.KEYFRAME_PATH):this.configProvider.config.webrtcAllowRestoreKeyframe}injectFmtpHandler(g){const m=window;m&&m.webMA&&(m.webMA.fmtp||(m.webMA.fmtp={handleMessage:this.handleMessage.bind(this)}),m.webMA.fmtp.lastFmtp=g)}cleanupDevToolsInjector(){const g=window;g&&g.webMA&&delete g.webMA.fmtp}},Rv=class{constructor(){this.sequence=0}getVideoControlMessage(g,m,f){const S={controlVideoStreaming:{sequenceNumber:++this.sequence,globalTimeStamp:(new Date).toString(),controlInfo:[{control:"start",sourceId:m,streamMsid:g}]}};return f&&(S.controlVideoStreaming.controlInfo[0].fmtParams=fmtParamsToString(f)),S}getSourceRequestMessage(g,m,f,S){if(!S)throw new Error("Failed to construct SourceRequestMessage, missing fmtParams");return{applyChannelParameters:{multiChannelParameter:{mids:[f],mediaParameter:JSON.stringify({controlVideoStreaming:{sequenceNumber:++this.sequence,controlInfo:{sourceId:m,streamMsid:g,fmtParams:S}}})}}}}getBandwidthInfoMessage(g,m){return{applyChannelParameters:{multiChannelParameter:{mids:g,mediaParameter:JSON.stringify({remoteUplinkBWE:{bw:m.toString()}})}}}}getMaxVideoSendCapabilitiesMessage(g){function ceilToMacroblock(g){const m=16;return Math.ceil(g/m)*m}const{streamMIDs:m,capabilities:f,useMax:S,sendMaxFs:v,sendMaxMbps:C}=g;let _=ceilToMacroblock(f.maxWidth),E=ceilToMacroblock(f.maxHeight);S&&(_=E=Math.max(_,E));const T={[je.VIDEO_CAPABILITIES.MAX_FPS_PATH]:f.maxFps,[je.VIDEO_CAPABILITIES.MAX_WIDTH]:_,[je.VIDEO_CAPABILITIES.MAX_HEIGHT]:E};return v&&(T[je.VIDEO_CAPABILITIES.MAX_FS_PATH]=f.maxFs),C&&(T[je.VIDEO_CAPABILITIES.MAX_MBPS_PATH]=f.maxMbps),{applyChannelParameters:{multiChannelParameter:{mids:m,mediaParameter:JSON.stringify({maxVideoSendCapabilities:{caps:T}})}}}}},wv=class{constructor(g){this.logger=g}dispose(){this.sender=null}configure(g){this.sender=g.sender}async sendMessage(g,m){if(!this.checkConfigured())return this.logger.safe.warn("extension not configured with sender"),null;let f,S;return"ApplyChannelParametersSourceRequest"===g&&(f=JSON.parse(m.applyChannelParameters.multiChannelParameter.mediaParameter),S=f.controlVideoStreaming.sequenceNumber),this.logger.safe.info(`sending video control message: ${JSON.stringify(m)}`),this.sender.send(g,m,f,S)}checkConfigured(){return!!this.sender}},Mv=class extends bv{constructor(){super("videoStreamControl"),this.messageGenerator=new Rv}initialize(g){super.initialize(g),this.subscribeListeners(),this.sourceRequester=new wv(g.logger),this.streamConfigurationHandler=new Pv(g.logger,g.negotiationEmulator,g.qualityManager,g.diagnostics,g.configProvider,g.statisticsGatherer)}configure(g){super.configure(g),this.sourceRequester.configure(g)}sendSourceRequest(g,m,f,S){if(this.configProvider?.config.useApplyChannelParametersForSourceRequests){const v=this.messageGenerator.getSourceRequestMessage(g,m,f,S);return this.sourceRequester.sendMessage("ApplyChannelParametersSourceRequest",v)}const v=this.messageGenerator.getVideoControlMessage(g,m,S?.[0]);return this.sourceRequester.sendMessage("ControlVideoStreaming",v)}sendBandwidthInfo(g,m){const f=this.messageGenerator.getBandwidthInfoMessage(g,m);return this.sourceRequester.sendMessage("ApplyChannelParametersBandwidth",f)}sendMaxVideoSendCapabilities(g,m){const f=this.messageGenerator.getMaxVideoSendCapabilitiesMessage({streamMIDs:g,capabilities:m,sendMaxFs:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxFs,sendMaxMbps:this.configProvider.config.maxSendVideoCapabilitiesReportingSendMaxMbps,useMax:this.configProvider.config.maxSendVideoCapabilitiesReportingUseMaximumWidthHeight});return this.sourceRequester.sendMessage("ApplyChannelParametersVideoCapabilities",f)}dispose(){this.unsubscribeListeners(),this.streamConfigurationHandler&&(this.streamConfigurationHandler.dispose(),this.streamConfigurationHandler=null),this.sourceRequester&&(this.sourceRequester.dispose(),this.sourceRequester=null),super.dispose()}onMediaStreamControlMessage(g){this.streamConfigurationHandler.handleMessage(g)}subscribeListeners(){this.extensionManagerSubscription=this.manager.on("onMediaStreamControlMessage",(g=>this.onMediaStreamControlMessage(g)))}unsubscribeListeners(){this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}},Dv=class extends bv{constructor(){super("bandwidthTelemetry")}initialize(g){super.initialize(g),this.statisticsGatherer=g.statisticsGatherer,this.diagnostics=g.diagnostics,this.extensionManagerSubscription=this.manager.on("onBandwidthMessage",(g=>this.onBandwidthMessage(g)))}dispose(){super.dispose(),this.extensionManagerSubscription.dispose(),this.extensionManagerSubscription=null}onBandwidthMessage(g){this.statisticsGatherer.addReportedReceiveBandwidth(g.bw),this.diagnostics.addReportedReceiveBandwidth(g.bw)}},Ov=class{constructor(g){this.key=g.config.bwSeedOptions.localStorageKey||"bwSeed";const m=localStorage.getItem(this.key);parseInt(m)||localStorage.setItem(this.key,g.config.bwSeedOptions.constValue.toString())}getSeed(){const g=localStorage.getItem(this.key),m=parseInt(g);return isNaN(m)?void 0:m}saveSeed(g){localStorage.setItem(this.key,g.toString())}static localStorageAvailable(){try{const g=window.localStorage,m="someKey",f="someValue";return g.setItem(m,f),g.removeItem(m),!0}catch(g){return!1}}},Nv=class _BandwidthMemoryStorage{constructor(g){_BandwidthMemoryStorage.value??(_BandwidthMemoryStorage.value=g.config.bwSeedOptions.constValue)}getSeed(){return _BandwidthMemoryStorage.value}saveSeed(g){_BandwidthMemoryStorage.value=g}},kv=class{constructor(g){this.value=g}addValue(g){}getAggregated(){return this.value}},Lv=class{addValue(g){this.value=g}getAggregated(){return this.value}},Fv=class{constructor(g){this.values=new Wm(g)}addValue(g){this.values.add(g)}getAggregated(){return Math.floor(average(this.values.items))}},xv=class{constructor(){this.total=0,this.duration=0,this.max=0,this.minNonZero=Number.MAX_SAFE_INTEGER}get avg(){return 0!==this.duration?this.total/this.duration:0}get maxSample(){return this.max}get minNonZeroSample(){return this.minNonZero}captureSample(g){(g||0===g)&&(this.total+=g,this.duration++,this.max=Math.max(g,this.max),0!==g&&(this.minNonZero=Math.min(g,this.minNonZero)))}},Uv=class{constructor(){this.sampleCounts={}}get min(){const g=Object.keys(this.sampleCounts).map(Number).filter((g=>g>0));return g.length>0?Math.min(...g):0}get max(){const g=Object.keys(this.sampleCounts).map(Number);return g.length>0?Math.max(...g):0}get mode(){const g=Object.keys(this.sampleCounts).map(Number);return g.length>0?g.reduce(((g,m)=>this.sampleCounts[m]>this.sampleCounts[g]?m:g),g[0]):0}captureSample(g){var m;if(void 0!==g){const f=`${g}`;(m=this.sampleCounts)[f]??(m[f]=0),this.sampleCounts[f]++}}},Vv=class{get delta(){if(void 0!==this.cur&&void 0!==this.last)return this.cur-this.last}captureSample(g,m){void 0!==g&&(void 0!==this.cur&&(this.last=this.cur),this.cur=g)}},Bv=class{constructor(g=0){this.precision=g}get delta(){if(void 0!==this.currentSample&&void 0!==this.prevSample){let g=1;return void 0!==this.currentTimestamp&&void 0!==this.prevTimestamp&&(g=(this.currentTimestamp-this.prevTimestamp)/1e3),g&&round((this.currentSample-this.prevSample)/g,this.precision)}}captureSample(g,m){if(this.currentTimestamp!==m){if(void 0===g)return this.prevSample=void 0,this.currentSample=void 0,this.prevTimestamp=void 0,void(this.currentTimestamp=void 0);void 0!==this.currentSample&&(this.prevSample=this.currentSample),this.prevTimestamp=this.currentTimestamp,this.currentTimestamp=m,this.currentSample=g}}},Hv=class{constructor(){this.startTime=Date.now()}get elapsed(){return round((Date.now()-this.startTime)/1e3,0)}},$v=class{constructor(){this.eventCount=0,this.totalActiveDuration=0,this.countBuckets={seconds1to3:0,seconds3to5:0,seconds5to8:0,seconds8to15:0,seconds15to60:0,seconds60toMax:0},this.timestampBuckets={seconds1to3:[],seconds3to5:[],seconds5to8:[],seconds8to15:[],seconds15to60:[],seconds60toMax:[]},this.averager=new xv}get active(){return!!this.current}get ongoingDuration(){return this.current?.elapsed||0}get avgDuration(){return this.averager.avg}get longestDuration(){return this.averager.maxSample}get numEvents(){return this.eventCount}get totalDuration(){return this.current?this.totalActiveDuration+this.current.elapsed:this.totalActiveDuration}get timestamps(){return deepClone(this.timestampBuckets)}get counts(){return deepClone(this.countBuckets)}set active(g){if(!this.current&&g)this.current=new Hv;else if(this.current&&!g){const g=this.current.elapsed;this.averager.captureSample(g),this.totalActiveDuration+=g;for(const m of Object.keys(je.HISTOGRAM_BATCH))if(g<=je.HISTOGRAM_BATCH[m]){this.countBuckets[m]++,this.timestampBuckets[m].push(this.current.startTime);break}this.eventCount++,this.current=void 0}}},Gv=class{constructor(){this.sampleChangeCount=0,this.sampleDurations={}}get durations(){return deepClone(this.sampleDurations)}get sortedDurations(){return Object.keys(this.sampleDurations).sort(((g,m)=>this.sampleDurations[m]-this.sampleDurations[g]))}get durationRatios(){const g={};let m=0;for(const g in this.sampleDurations)m+=this.sampleDurations[g];for(const f in this.sampleDurations)g[f]=round(this.sampleDurations[f]/m*100);return g}get changeCount(){return this.sampleChangeCount}captureSample(g){this.sampleDurations[g]||(this.sampleDurations[g]=0),this.sampleDurations[g]++,g!==this.lastSample&&(this.sampleChangeCount++,this.lastSample=g)}},jv=class{constructor(g,m){this.validTimeBetweenFramesArrival=g,this.invalidFPSAboveMax=m,this.lastSampleTimestamp=-1,this.fpsHarmonicSumWeigtsTs=0,this.fpsHarmonicWeigtedSumsFramePerDelayTs=0}captureSample(g){const m=Date.now();if(g>0&&this.lastSampleTimestamp>0){const f=m-this.lastSampleTimestamp;if(this.lastSampleTimestamp=m,f<0||f>this.validTimeBetweenFramesArrival||g>this.invalidFPSAboveMax)return;const S=f/g;this.fpsHarmonicSumWeigtsTs+=f,this.fpsHarmonicWeigtedSumsFramePerDelayTs+=f*S}(this.lastSampleTimestamp<0||0===g)&&(this.lastSampleTimestamp=m)}get harmonicMean(){return this.fpsHarmonicWeigtedSumsFramePerDelayTs>0?1e3*this.fpsHarmonicSumWeigtsTs/this.fpsHarmonicWeigtedSumsFramePerDelayTs:0}},Wv=class{constructor(g){this.samplesNum=g,this.samples=[],this.lastReport={avg:-1,max:-1,median:-1,volatilityPercent:-1}}isReportComplete(){return this.samples.length===this.samplesNum}getReport(){return this.lastReport}captureSample(g){void 0===g||g<0||(arrayLimitedPush(this.samples,g,this.samplesNum),this.lastReport={avg:this.getAvg(),max:this.getMax(),median:this.getMedian(),volatilityPercent:this.getVolatility()})}getAvg(){return average(this.samples)}getMax(){return Math.max(...this.samples)}getMedian(){this.samples.sort(((g,m)=>g-m));return this.samples.length%2==1?this.samples[Math.floor(this.samples.length/2)]:(this.samples[this.samples.length/2]+this.samples[this.samples.length/2-1])/2}getVolatility(){const g=this.getAvg();if(0===g)return 0;let m=0;this.samples.forEach((f=>{m+=Math.abs(f-g)}));return round(m/this.samples.length*100/g,2)}},qv=class{constructor(){this.duration=0,this.reportAggr={avg:0,max:0,median:0,volatilityPercent:0}}captureSample(g){!g||g.avg<0||(this.reportAggr={avg:this.reportAggr.avg+g.avg,max:Math.max(this.reportAggr.max,g.max),median:this.reportAggr.median+g.median,volatilityPercent:this.reportAggr.volatilityPercent+g.volatilityPercent},this.duration++)}getReport(){if(0!==this.duration)return{avg:this.reportAggr.avg/this.duration,max:this.reportAggr.max,median:this.reportAggr.median/this.duration,volatilityPercent:this.reportAggr.volatilityPercent/this.duration}}},zv=class{constructor(g=0){this.allowedOvershoot=g,this.past=[],this.totalOvershootDuration=0,this.lastAllowed=0}get isOvershooting(){return!!this.current}get events(){return this.current?[...this.past,this.current]:this.past}get totalDuration(){return this.totalOvershootDuration}captureSample(g,m){const f=round(g-m);f>this.allowedOvershoot&&(0===this.lastAllowed||m===this.lastAllowed||!this.current&&m>this.lastAllowed)?(this.totalOvershootDuration++,this.current?(this.current.min=Math.min(this.current.min,f),this.current.max=Math.max(this.current.max,f)):this.current={timestamp:Date.now(),min:f,max:f}):this.current&&(this.current.duration=Date.now()-this.current.timestamp,this.past.push(this.current),this.current=void 0),this.lastAllowed=m}},Kv=class{constructor(g=100){this.minPackets=g,this.prevLost=0,this.prevReceived=0}calculate(g,m){if(void 0===g||void 0===m)return;const f=g-this.prevReceived,S=m-this.prevLost;return f+S<this.minPackets?void 0:(this.prevReceived=g,this.prevLost=m,S*this.minPackets/(S+f))}},Jv=class{constructor(){this.capturedSamples=[]}captureSample(g){g&&this.capturedSamples.push(g)}calculateStd(){if(!this.capturedSamples.length)return;const g=this.capturedSamples.reduce(((g,m)=>g+m),0)/this.capturedSamples.length,m=this.capturedSamples.map((m=>(m-g)**2)),f=m.reduce(((g,m)=>g+m),0)/m.length;return round(Math.sqrt(f),2)}getFirst(){return this.capturedSamples[0]}getLast(){if(this.capturedSamples.length)return this.capturedSamples[this.capturedSamples.length-1]}calculatePercentile(g){if(!this.capturedSamples.length)return;const m=this.capturedSamples.sort(((g,m)=>g-m)),f=(m.length-1)*g,S=Math.floor(f),v=f-S;return void 0!==m[S+1]?m[S]+v*(m[S+1]-m[S]):m[S]}};function isPowerEfficient(g){if(!g)return;const m=["libvpx","ffmpeg"];let f=!0;for(const S of m)if(g.toLowerCase().includes(S)){f=!1;break}return f}var Yv=class{constructor(g){this.samplesCount=g,this.capturedSamples=[]}captureSample(g){void 0!==g&&arrayLimitedPush(this.capturedSamples,g,this.samplesCount)}getRate(){if(!this.capturedSamples.length)return;const g=this.samplesCount/this.capturedSamples.length;return this.capturedSamples.reduce(((g,m)=>g+m))*g/this.samplesCount}},Qv=class{constructor(g=5){this.limit=g,this.curWidth=0,this.curHeight=0,this.resolutionSwitches=[]}captureSample(g,m){g===this.curWidth&&m===this.curHeight||(arrayLimitedPush(this.resolutionSwitches,`${g}x${m}`,this.limit),this.curWidth=g,this.curHeight=m)}get switches(){if(this.resolutionSwitches.length)return this.resolutionSwitches}};function calcMacroblockRate(g,m,f){return g&&m?Math.ceil(g/je.MACROBLOCK_SIZE)*Math.ceil(m/je.MACROBLOCK_SIZE)*f:0}var Xv=class{constructor(){this.macroblockRateAveragerReceived=new xv,this.macroblockRateAveragerDecoded=new xv,this.maxDecoderLoss=0,this.decoderLoss=0}captureSample(g,m){this.macroblockRateAveragerReceived.captureSample(g),this.macroblockRateAveragerDecoded.captureSample(m);let f=this.maxDecoderLoss;g&&(f=(g-m)/g*100),this.decoderLoss=f,this.maxDecoderLoss=Math.max(f,this.maxDecoderLoss)}getReport(){return{macroblockRateReceivedMax:this.macroblockRateAveragerReceived.maxSample,macroblockRateReceivedAvg:this.macroblockRateAveragerReceived.avg,macroblockRateDecodedMax:this.macroblockRateAveragerDecoded.maxSample,macroblockRateDecodedAvg:this.macroblockRateAveragerDecoded.avg,macroblockRateMaxDecoderLossPercent:Math.floor(this.maxDecoderLoss),macroblockRateDecoderLossPercent:Math.floor(this.decoderLoss)}}},Zv=class{constructor(){this.codecReport={}}captureSample(g,m){var f,S;const v=g.split("/")[1];return void 0===this.activeMsi||this.activeMsi!==m?(this.activeMsi=m,this.previousCodec=v,void((f=this.codecReport)[m]??(f[m]={[v]:1,codecSwitchCounter:0}))):this.previousCodec!==v?((S=this.codecReport[m])[v]??(S[v]=0),this.codecReport[m][v]++,this.codecReport[m].codecSwitchCounter++,void(this.previousCodec=v)):void this.codecReport[m][v]++}get report(){return this.codecReport}},ey=class{constructor(){this.bandwidthAverager=new xv}addValue(g){this.bandwidthAverager.captureSample(g)}getAggregated(){return Math.floor(this.bandwidthAverager.avg)}},ty=-1,iy=class{constructor(g){this.configProvider=g,this.aggregator=this.getAggregator(),this.storage=this.getStorage(),this.cappingValue=this.configProvider.config.bwSeedOptions.cappingValue}getSeed(){const g=this.storage.getSeed()??ty;return this.cappingValue>=0?Math.min(g,this.cappingValue):g}saveSeed(g){this.aggregator.addValue(g);const m=this.aggregator.getAggregated();this.storage.saveSeed(m)}getAggregator(){switch(this.configProvider.config.bwSeedOptions.aggregation){case"avg":return this.configProvider.config.bwSeedOptions.aggregateLastN>0?new Fv(this.configProvider.config.bwSeedOptions.aggregateLastN):new ey;case"last":return new Lv;default:return new kv(this.configProvider.config.bwSeedOptions.constValue)}}getStorage(){return this.configProvider.config.bwSeedOptions.useLocalStorage&&Ov.localStorageAvailable()?new Ov(this.configProvider):new Nv(this.configProvider)}},ny=class extends bv{constructor(){super("bandwidthCache")}initialize(g){super.initialize(g),this.bandwidthCache=new iy(g.configProvider),this.onBandwidthMessageSubscription=this.manager.on("onBandwidthMessage",(g=>{this.bandwidthCache.saveSeed(g.bw)}))}getBWSeed(){return this.bandwidthCache.getSeed()}dispose(){super.dispose(),this.onBandwidthMessageSubscription?.dispose(),this.onBandwidthMessageSubscription=null}},ry=class{static getExtension(g){switch(g){case"dominantSpeakerHistory":return new Av;case"videoStreamControl":return new Mv;case"bandwidthTelemetry":return new Dv;case"bandwidthCache":return new ny;default:throw new Error(`Extension of type ${g} is not found`)}}},sy=class extends Be{constructor(g){super(g),this.logger=g,this.extensions=[]}dispose(){this.extensions.map((g=>g.dispose())),this.extensions=[],super.dispose()}addExtension(g,m){m.manager||(m.manager=this);const f=ry.getExtension(g);f.initialize(m),this.extensions.push(f)}getExtension(g){return this.extensions.find((m=>m.getType()===g))}configureExtension(g,m){this.getExtension(g)?.configure(m)}processNotification(g,m){switch(g){case"ControlVideoStreaming":this.event("onMediaStreamControlMessage").raise(m);break;case"DominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(m,"signaling");break;case"McpDominantSpeakerInfo":this.event("onDominantHistoryMessage").raise(m,"server");break;case"BandwithNotification":this.event("onBandwidthMessage").raise(m);break;default:this.logger.safe.error(`Notification message handler not found for type: ${g}`)}}},ay=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(g){if(!g)return;const m=new Set;if(g.send){this.diagnostics.handlePresentationAudioInputLevel();for(const f of g.send)try{m.add(f.outboundRTP.id);let g=this.sendExtenders.get(f.outboundRTP.id)??new cy(this.diagnostics,this.configProvider);f.outboundRTP.bytesSent<g.lastBytes&&(g=new cy(this.diagnostics,this.configProvider)),this.sendExtenders.set(f.outboundRTP.id,g),g.processSample(f)}catch(g){this.diagnostics.addStatsError("AudioStatsProcessor:send",stringifyObject(g))}}if(clearMap(this.sendExtenders,m),m.clear(),g.recv)for(const f of g.recv)try{m.add(f.inboundRTP.id);let g=this.recvExtenders.get(f.inboundRTP.id)??new oy(this.configProvider);f.inboundRTP.bytesReceived<g.lastBytes&&(g=new oy(this.configProvider)),this.recvExtenders.set(f.inboundRTP.id,g),g.processSample(f)}catch(g){this.diagnostics.addStatsError("AudioStatsProcessor:recv",stringifyObject(g))}clearMap(this.recvExtenders,m)}},oy=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new Kv,this.bytesReceivedDiff=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.concealedRatioAverager=new xv,this.stretchedRatioAverager=new xv,this.codecSwitchesTracker=new Gv,this.packetDurationTracker=new Gv,this.jitterAverager=new xv,this.jitterBufferDelayAverager=new xv,this.lastBytes=0}processSample(g){let m,f,S,v,C;const _=this.lossRateCalculator.calculate(g.inboundRTP.packetsReceived,g.inboundRTP.packetsLost)??0;this.lastBytes=g.inboundRTP.bytesReceived,this.bytesReceivedDiff.captureSample(g.inboundRTP.bytesReceived,g.inboundRTP.timestamp);const E=this.bytesReceivedDiff.delta,T=E?8*E:void 0;this.packetsDelta.captureSample(g.inboundRTP.packetsReceived,g.inboundRTP.timestamp),this.packetsLostDelta.captureSample(g.inboundRTP.packetsLost,g.inboundRTP.timestamp);const I=g.inboundRTP.jitterBufferEmittedCount&&round(g.inboundRTP.jitterBufferDelay/g.inboundRTP.jitterBufferEmittedCount*1e3,0);if(this.jitterAverager.captureSample(1e3*g.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(g.inboundRTP.jitterBufferDelay),m=g.inboundRTP.totalSamplesReceived&&round((g.inboundRTP.concealedSamples-g.inboundRTP.silentConcealedSamples)/g.inboundRTP.totalSamplesReceived),g.customHealerStats){g.customHealerStats.numSamplesPerFrame&&(v=g.customHealerStats.decodedSamples/g.customHealerStats.numSamplesPerFrame,C=g.customHealerStats.cngSamples/g.customHealerStats.numSamplesPerFrame),m=g.customHealerStats.healedSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples),S=g.customHealerStats.concealSamples&&g.customHealerStats.concealSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples),f=g.customHealerStats.stretchSamples&&g.customHealerStats.stretchSamples/(g.customHealerStats.decodedSamples+g.customHealerStats.healedSamples);const _=g.customHealerStats.packetDurationInMs&&g.customHealerStats.packetDurationInMs>100?100:g.customHealerStats.packetDurationInMs;this.concealedRatioAverager.captureSample(S),this.stretchedRatioAverager.captureSample(f),this.codecSwitchesTracker.captureSample(`${g.customHealerStats.pullAdspPayloadType}`),this.packetDurationTracker.captureSample(`${_}`)}g.extensions={lossRate:_,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,healedRatio:m,jitterBufferMs:I,bitrate:T||0,customHealerStats:g.customHealerStats&&{concealedDataRatio:S,concealedDataRatioMax:this.concealedRatioAverager.maxSample,stretchedDataRatio:f,stretchedDataRatioMax:this.stretchedRatioAverager.maxSample,numberOfDecodedFrames:v,usageMetricsCodecId:this.codecSwitchesTracker.sortedDurations,percentageOfPtime:this.packetDurationTracker.durationRatios,pushPacketProcessingTimes:g.customHealerStats.pushProcessingTimes,pullPacketProcessingTimes:g.customHealerStats.pullProcessingTimes,pullProcessingTimePerStreamNumber:g.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:g.customHealerStats.cnpPushCount,cnpPullCount:g.customHealerStats.cnpPullCount,numberOfCNFrames:C,redPacketsCount:g.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:g.customHealerStats.pullNumOfStreamsCounter},jitterAvg:round(this.jitterAverager.avg),jitterBufferDelayMs:round(this.jitterBufferDelayAverager.avg)},this.duration++}},ly=class{constructor(){this.duration=0,this.lossRateAverager=new xv,this.bitrateAverager=new xv,this.jitterBufferAverager=new xv,this.jitterAverager=new xv,this.jitterBufferDelayAverager=new xv,this.healedRatioAverager=new xv}processSample(g,m,f){const S=g[0],v={inboundRTP:S.inboundRTP};if(S.transport&&Object.defineProperty(v,"transport",{value:S.transport,configurable:!1,enumerable:!1}),S.codec&&(v.codec=S.codec),S.track&&(v.track=S.track),S.remoteOutboundRTP&&(v.remoteOutboundRTP=S.remoteOutboundRTP),S.extensions){this.lossRateAverager.captureSample(S.extensions.lossRate),this.bitrateAverager.captureSample(S.extensions.bitrate),this.healedRatioAverager.captureSample(S.extensions.healedRatio),this.jitterBufferAverager.captureSample(S.extensions.jitterBufferMs),this.jitterAverager.captureSample(1e3*S.inboundRTP.jitter),this.jitterBufferDelayAverager.captureSample(S.inboundRTP.jitterBufferDelay);const g=S.inboundRTP.packetsReceived+S.inboundRTP.packetsLost;v.aggregated={lossRateMax:this.lossRateAverager.maxSample,lossRateAvg:this.lossRateAverager.avg,networkAvgLossRate:g>0?S.inboundRTP.packetsLost/g:0,duration:this.duration,bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),jitterAvg:this.jitterAverager.avg,avgJitterBufferSize:this.jitterBufferAverager.avg,healedRatioAvg:this.healedRatioAverager.avg,healedRatioMax:this.healedRatioAverager.maxSample,customHealerStats:S.extensions.customHealerStats&&{concealedDataRatio:S.extensions.customHealerStats.concealedDataRatio,concealedDataRatioMax:S.extensions.customHealerStats.concealedDataRatioMax,stretchedDataRatio:S.extensions.customHealerStats.stretchedDataRatio,stretchedDataRatioMax:S.extensions.customHealerStats.stretchedDataRatioMax,numberOfDecodedFrames:S.extensions.customHealerStats.numberOfDecodedFrames,usageMetricsCodecId:S.extensions.customHealerStats.usageMetricsCodecId,percentageOfPtime:S.extensions.customHealerStats.percentageOfPtime,pushPacketProcessingTimes:S.extensions.customHealerStats.pushPacketProcessingTimes,pullPacketProcessingTimes:S.extensions.customHealerStats.pullPacketProcessingTimes,pullProcessingTimePerStreamNumber:S.extensions.customHealerStats.pullProcessingTimePerStreamNumber,cnpPushCount:S.extensions.customHealerStats.cnpPushCount,cnpPullCount:S.extensions.customHealerStats.cnpPullCount,numberOfCNFrames:S.extensions.customHealerStats.numberOfCNFrames,redPacketsCount:S.extensions.customHealerStats.redPacketsCount,pullNumOfStreamsCounter:S.extensions.customHealerStats.pullNumOfStreamsCounter}},this.duration++}arrayLimitedPush(m,v,f)}},cy=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new Kv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.bytesSendDiff=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.rttAverager=new xv,this.lastBytes=0}processSample(g){const m=this.lossRateCalculator.calculate(g.remoteInboundRTP?.packetsReceived,g.remoteInboundRTP?.packetsLost)??0;this.packetsDelta.captureSample(g.outboundRTP.packetsSent,g.outboundRTP.timestamp),this.packetsLostDelta.captureSample(g.remoteInboundRTP?.packetsLost,g.remoteInboundRTP?.timestamp),this.lastBytes=g.outboundRTP.bytesSent,this.bytesSendDiff.captureSample(g.outboundRTP.bytesSent,g.outboundRTP.timestamp);const f=this.bytesSendDiff.delta;this.rttAverager.captureSample(1e3*(g.remoteInboundRTP?.roundTripTime??0)),g.extensions={lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,bitrate:f?8*f:0,rttAvg:round(this.rttAverager.avg),callIsMuted:this.diagnostics.callIsMuted,rawInputVolume:this.diagnostics.audioLevel},this.duration++}},dy=class{constructor(g){this.diagnostics=g,this.duration=0,this.lossRateAverager=new xv,this.bitrateAverager=new xv,this.rttAverager=new xv}processSample(g,m,f){const S=g[0],v={outboundRTP:S.outboundRTP};S.transport&&Object.defineProperty(v,"transport",{value:S.transport,configurable:!1,enumerable:!1}),S.codec&&(v.codec=S.codec),S.track&&(v.track=S.track),S.mediaSource&&(v.mediaSource=S.mediaSource),S.remoteInboundRTP&&(v.remoteInboundRTP=S.remoteInboundRTP),S.extensions&&(this.lossRateAverager.captureSample(S.extensions.lossRate),this.bitrateAverager.captureSample(S.extensions.bitrate),this.rttAverager.captureSample(S.remoteInboundRTP?.roundTripTime),v.aggregated={duration:this.duration,lossRateMax:this.lossRateAverager.maxSample,bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),rttAvg:round(this.rttAverager.avg),rttMax:round(this.rttAverager.maxSample),rawInputVolume:this.diagnostics.audioLevel,audioLevel:S.track?.audioLevel??S.mediaSource?.audioLevel},this.duration++),arrayLimitedPush(m,v,f)}},hy=R,uy={fs:0,fps:1},gy=class{constructor(g){this.logger=g,this.allowed=new Map,this.lastParams=new Map,this.currentEvents=new Map,this.finishedEvents=[]}setMaxCapabilities(g){g.forEach((g=>{if(g.ssrc||0===g.ssrc){this.finishIfActive(g.ssrc),this.allowed.set(g.ssrc,{fs:g.maxFs+uy.fs,fps:g.maxFps+uy.fps});const m=this.lastParams.get(g.ssrc);m&&this.setCurrentParams(g.ssrc,m.fs,m.fps)}}))}setCurrentParams(g,m,f){this.lastParams.set(g,{fs:m,fps:f});const S=this.getAllowedParams(g);S&&(m>S.fs||f>S.fps)?(this.captureOvershoot(g,f,S.fps,"fps"),this.captureOvershoot(g,m,S.fs,"fs")):S&&this.finishIfActive(g)}flush(){this.currentEvents.forEach(((g,m)=>this.finishIfActive(m)))}getEvents(){const g=[...deepClone(this.finishedEvents)],m=Date.now();return this.currentEvents.forEach((f=>f.forEach((f=>g.push({ssrc:f.ssrc,timestamp:f.timestamp,duration:m-f.timestamp,overshootType:f.overshootType,amount:f.amount}))))),g}captureOvershoot(g,m,f,S){const v=this.currentEvents.get(g)||[],C=v.findIndex((g=>g.overshootType===S)),_=v[C],E=m-f,T=uy[S];E<=T&&_?(_.duration=Date.now()-_.timestamp,this.finishedEvents.push(_),this.logger.debug(`stopped overshooting ${S} by ${_.amount}`),v.splice(C,1)):E>T&&!_?(this.logger.safe.info(`overshooting ${S} by ${m-f}`),v.push({ssrc:g,timestamp:Date.now(),duration:-1,overshootType:S,amount:{min:E,max:E}})):E>T&&_&&(_.amount={min:Math.min(_.amount.min,E),max:Math.max(_.amount.max,E)}),v.length?this.currentEvents.set(g,v):this.currentEvents.has(g)&&this.currentEvents.delete(g)}getAllowedParams(g){const m=this.allowed.get(g);return m||this.allowed.get(0)}finishIfActive(g){const m=this.currentEvents.get(g);if(m){const f=Date.now();m.forEach((m=>{m.duration=f-m.timestamp,this.finishedEvents.push(m),this.logger.debug(`finished overshooting ${m.overshootType} by min:${m.amount.min} max:${m.amount.max} for ${m.duration}ms for ssrc ${g}`)})),this.currentEvents.delete(g)}}},py=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.recvExtenders=new Map,this.sendExtenders=new Map}processStats(g){if(!g)return;const m=new Set;if(g.send&&(0,hy.flatMap)(g.send,(g=>[g,...g.altLayouts??[]])).forEach((g=>{try{m.add(g.outboundRTP.id);let f=this.sendExtenders.get(g.outboundRTP.id)??new Sy(this.configProvider);g.outboundRTP.bytesSent<f.lastBytes&&(f=new Sy(this.configProvider)),this.sendExtenders.set(g.outboundRTP.id,f),f.processSample(g)}catch(g){this.diagnostics.addStatsError("VideoStatsProcessor:send",stringifyObject(g))}})),clearMap(this.sendExtenders,m),m.clear(),g.recv)for(const f of g.recv)try{m.add(f.inboundRTP.id);let g=this.recvExtenders.get(f.inboundRTP.id)??new my(this.configProvider);f.inboundRTP.bytesReceived<g.lastBytes&&(g=new my(this.configProvider)),this.recvExtenders.set(f.inboundRTP.id,g),g.processSample(f)}catch(g){this.diagnostics.addStatsError("VideoStatsProcessor:recv",stringifyObject(g))}clearMap(this.recvExtenders,m)}},my=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new Kv,this.bytesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.framesReceivedDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.framesDecodedDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.trackFramesDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.decodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new Bv(2):new Vv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.freezeHistogram=new $v,this.harmonicDecodedFps=new jv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.prevTimeToFirstFrame=-1,this.lastBytes=0,this.macroblockStatsTracker=new Xv}processSample(g){const m=this.lossRateCalculator.calculate(g.inboundRTP.packetsReceived,g.inboundRTP.packetsLost)??0;this.framesReceivedDelta.captureSample(g.inboundRTP.framesReceived,g.inboundRTP.timestamp),this.framesDecodedDelta.captureSample(g.inboundRTP.framesDecoded,g.inboundRTP.timestamp),this.trackFramesDelta.captureSample(g.inboundRTP.framesReceived??g.track?.framesReceived,g.inboundRTP.timestamp),this.packetsDelta.captureSample(g.inboundRTP.packetsReceived,g.inboundRTP.timestamp),this.packetsLostDelta.captureSample(g.inboundRTP.packetsLost,g.inboundRTP.timestamp);const f=this.framesReceivedDelta.delta,S=this.framesDecodedDelta.delta;this.harmonicDecodedFps.captureSample(S),this.decodeTimeDelta.captureSample(g.inboundRTP.totalDecodeTime,g.inboundRTP.timestamp);const v=this.decodeTimeDelta.delta&&S&&round(this.decodeTimeDelta.delta/S*1e3,0),C=g.renderer?.timeToFirstFrame??-1;this.freezeHistogram.active=-1!==C&&-1!==this.prevTimeToFirstFrame&&(0===S||0===f),this.prevTimeToFirstFrame=C,this.lastBytes=g.inboundRTP.bytesReceived,this.bytesReceivedDelta.captureSample(g.inboundRTP.bytesReceived,g.inboundRTP.timestamp);const _=this.bytesReceivedDelta.delta,E=g.inboundRTP.jitterBufferEmittedCount&&round((g.inboundRTP.jitterBufferDelay??0)/g.inboundRTP.jitterBufferEmittedCount*1e3),T=calcMacroblockRate(g.inboundRTP.frameWidth,g.inboundRTP.frameHeight,f||0),I=calcMacroblockRate(g.inboundRTP.frameWidth,g.inboundRTP.frameHeight,S||0);this.macroblockStatsTracker.captureSample(T,I),g.extensions={lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,frameRateReceived:f,frameRateDecoded:S,trackRecvFps:this.trackFramesDelta.delta,decodeTime:v||0,jitterBufferMs:E,bitrate:_?8*_:0,isFrozen:this.freezeHistogram.active,macroblockRateReceived:T,macroblockRateDecoded:I,macroblockRateStats:this.macroblockStatsTracker.getReport(),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,powerEfficient:void 0!==g.inboundRTP.powerEfficientDecoder?g.inboundRTP.powerEfficientDecoder:isPowerEfficient(g.inboundRTP.decoderImplementation),totalFreezeFraction:this.duration?this.freezeHistogram.totalDuration/this.duration:0,fpsHarmonicAverage:round(this.harmonicDecodedFps.harmonicMean)},this.duration++}},fy=class{constructor(g){this.configProvider=g,this.duration=0,this.lossRateAverager=new xv,this.bitrateAverager=new xv,this.jitterAverager=new xv,this.frameRateAverager=new xv,this.freezeHistogram=new $v,this.harmonicDecodedFps=new jv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.resolutionDurations=new Gv,this.codecCalculator=new Zv}processSample(g,m,f){const S=g.sort(((g,m)=>m.inboundRTP.frameHeight*m.inboundRTP.frameWidth-g.inboundRTP.frameHeight*g.inboundRTP.frameWidth))[0],v={inboundRTP:S.inboundRTP};S.transport&&Object.defineProperty(v,"transport",{value:S.transport,configurable:!1,enumerable:!1}),S.codec&&(v.codec=S.codec,this.configProvider?.config.isAv1Allowed&&"sharing"===S.mediaEntity?.modality&&this.codecCalculator.captureSample(S.codec.mimeType,S.renderer?.msi)),S.track&&(v.track=S.track),S.remoteOutboundRTP&&(v.remoteOutboundRTP=S.remoteOutboundRTP),S.extensions&&(v.extensions=S.extensions),S.extensions&&(this.harmonicDecodedFps.captureSample(S.extensions.frameRateDecoded),this.lossRateAverager.captureSample(S.extensions.lossRate),this.bitrateAverager.captureSample(S.extensions.bitrate),this.jitterAverager.captureSample(1e3*(S.inboundRTP.jitter??0)),this.frameRateAverager.captureSample(S.extensions.frameRateReceived??S.extensions.frameRateDecoded),this.freezeHistogram.active=S.extensions.isFrozen,S.inboundRTP.frameWidth&&S.inboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${S.inboundRTP.frameWidth}x${S.inboundRTP.frameHeight}`),v.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,avgFrameRate:round(this.frameRateAverager.avg),fpsHarmonicAverage:round(this.harmonicDecodedFps.harmonicMean),avgJitterBufferSize:round(this.jitterAverager.avg),bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),bitrateMinNonZero:round(this.bitrateAverager.minNonZeroSample,0),ongoingFreezeDuration:this.freezeHistogram.ongoingDuration,numFreezes:this.freezeHistogram.numEvents,avgFreezeDuration:round(this.freezeHistogram.avgDuration),longestFreeze:this.freezeHistogram.longestDuration,totalFreezeDuration:this.freezeHistogram.totalDuration,freezeCountHistogram:this.freezeHistogram.counts,freezeTimestampsHistogram:this.freezeHistogram.timestamps,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,macroblockRateStats:S.extensions.macroblockRateStats,codecReport:this.codecCalculator?.report},this.duration++),arrayLimitedPush(m,v,f)}},Sy=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.duration=0,this.lossRateCalculator=new Kv,this.lossRateAverager=new xv,this.captureFreezeIntervalsCount=0,this.bytesSendDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.encodedFramesDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.sentFramesDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.packetsLostDelta=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.harmonicEncodedFps=new jv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax),this.encodeTimeDelta=this.useLastSampleDeltaPerSecondConverter?new Bv(2):new Vv,this.qpDelta=this.useLastSampleDeltaPerSecondConverter?new Bv(3):new Vv,this.fsOvershoot=new zv,this.fpsOvershoot=new zv(1),this.brOvershoot=new zv,this.plisDelta=new Vv,this.pliRate=new Yv(60),this.resolutionSwitcherTracker=new Qv(this.configProvider.config.diagnostics.collectionLimits.numResolutionSwitches),this.bitrateAverager=new xv,this.rttAverager=new xv,this.lastBytes=0}processSample(g){const m=this.lossRateCalculator.calculate(g.remoteInboundRTP?.packetsReceived,g.remoteInboundRTP?.packetsLost);this.lossRateAverager.captureSample(m),this.plisDelta.captureSample(g.outboundRTP.pliCount),this.pliRate.captureSample(this.plisDelta.delta),this.packetsDelta.captureSample(g.outboundRTP.packetsSent,g.outboundRTP.timestamp),this.packetsLostDelta.captureSample(g.remoteInboundRTP?.packetsLost,g.remoteInboundRTP?.timestamp),this.lastBytes=g.outboundRTP.bytesSent,this.bytesSendDelta.captureSample(g.outboundRTP.bytesSent,g.outboundRTP.timestamp);const f=this.bytesSendDelta.delta,S=f?8*f:void 0;this.bitrateAverager.captureSample(S),this.rttAverager.captureSample(1e3*(g.remoteInboundRTP?.roundTripTime??0)),this.encodedFramesDelta.captureSample(g.outboundRTP.framesEncoded,g.outboundRTP.timestamp);const v=this.encodedFramesDelta.delta;this.sentFramesDelta.captureSample(g.outboundRTP.framesSent,g.outboundRTP.timestamp);const C=this.sentFramesDelta.delta||0;this.harmonicEncodedFps.captureSample(v);const _=g.mediaSource?.framesPerSecond;0===_&&void 0!==this.lastCaptureFramerate&&this.lastCaptureFramerate>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFramerate=_,this.encodeTimeDelta.captureSample(g.outboundRTP.totalEncodeTime,g.outboundRTP.timestamp);const E=this.encodeTimeDelta.delta&&v&&round(this.encodeTimeDelta.delta/v*1e3,0);this.qpDelta.captureSample(g.outboundRTP.qpSum,g.outboundRTP.timestamp);const T=this.qpDelta.delta&&v&&round(this.qpDelta.delta/v,2);g.outboundRTP.frameWidth&&g.outboundRTP.frameHeight&&this.resolutionSwitcherTracker.captureSample(g.outboundRTP.frameWidth,g.outboundRTP.frameHeight);const I=g.appliedCapabilities??g.requestedCapabilities;I&&(void 0!==g.outboundRTP.frameHeight&&void 0!==g.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(g.outboundRTP.frameHeight/16*(g.outboundRTP.frameWidth/16),I.maxFs),this.fpsOvershoot.captureSample(C,I.maxFps),I.maxBr&&this.brOvershoot.captureSample(S,I.maxBr));const b=[];for(const g of this.fsOvershoot.events)b.push({...g,overshootType:"fs"});for(const g of this.fpsOvershoot.events)b.push({...g,overshootType:"fps"});for(const g of this.brOvershoot.events)b.push({...g,overshootType:"br"});b.sort(((g,m)=>g.timestamp-m.timestamp)),g.extensions={lossRate:m,packetsPerSecond:this.packetsDelta.delta,packetsLostPerSecond:this.packetsLostDelta.delta,duration:this.duration,pliRate:this.pliRate.getRate(),frameRateEncoded:this.encodedFramesDelta.delta,frameRateSent:C,bitrate:S||0,encodeTime:E||0,qp:T||0,captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:b,powerEfficient:void 0!==g.outboundRTP.powerEfficientEncoder?g.outboundRTP.powerEfficientEncoder:isPowerEfficient(g.outboundRTP.encoderImplementation),bitrateAvg:round(this.bitrateAverager.avg,0),rttAvg:round(this.rttAverager.avg)},this.duration++}},vy=class{constructor(g){this.configProvider=g,this.duration=0,this.lossRateAverager=new xv,this.bitrateAverager=new xv,this.sendBWEAverager=new xv,this.rttAverager=new xv,this.framerateAverager=new xv,this.captureFpsAverager=new xv,this.captureFreezeIntervalsCount=0,this.lastCaptureFps=void 0,this.resolutionDurations=new Gv,this.fsOvershoot=new zv,this.fpsOvershoot=new zv(1),this.brOvershoot=new zv,this.harmonicEncodedFps=new jv(this.configProvider.config.webrtcStatPollInterval*this.configProvider.config.coeffOfValidTimeDelayBetweenFramesArrival,this.configProvider.config.invalidFPSAboveMax)}processSample(g,m,f){g.length>1&&g.sort(((g,m)=>{const f=g.appliedCapabilities??g.requestedCapabilities,S=m.appliedCapabilities??m.requestedCapabilities;return f?.maxMbps&&S?.maxMbps?S.maxMbps-f.maxMbps:0}));const S=g[0],v={outboundRTP:S.outboundRTP};if(S.transport&&Object.defineProperty(v,"transport",{value:S.transport,configurable:!1,enumerable:!1}),S.codec&&(v.codec=S.codec),S.track&&(v.track=S.track),S.mediaSource&&(v.mediaSource=S.mediaSource),S.remoteInboundRTP&&(v.remoteInboundRTP=S.remoteInboundRTP),S.extensions&&(v.extensions=S.extensions),S.extensions){this.lossRateAverager.captureSample(S.extensions.lossRate),this.bitrateAverager.captureSample(S.extensions.bitrate),this.sendBWEAverager.captureSample(S.transport?.selectedCandidatePair?.availableOutgoingBitrate),this.rttAverager.captureSample(S.remoteInboundRTP?.roundTripTime),this.framerateAverager.captureSample(S.extensions.frameRateSent);const g=S.mediaSource?.framesPerSecond;this.captureFpsAverager.captureSample(g),0===g&&void 0!==this.lastCaptureFps&&this.lastCaptureFps>0&&this.captureFreezeIntervalsCount++,this.lastCaptureFps=g,S.outboundRTP.frameWidth&&S.outboundRTP.frameHeight&&this.resolutionDurations.captureSample(`${S.outboundRTP.frameWidth}x${S.outboundRTP.frameHeight}`);const m=S.appliedCapabilities??S.requestedCapabilities;m&&(void 0!==S.outboundRTP.frameHeight&&void 0!==S.outboundRTP.frameWidth&&this.fsOvershoot.captureSample(S.outboundRTP.frameHeight/16*(S.outboundRTP.frameWidth/16),m.maxFs),this.fpsOvershoot.captureSample(S.extensions.frameRateSent,m.maxFps),m.maxBr&&this.brOvershoot.captureSample(S.extensions?.bitrate,m.maxBr)),this.harmonicEncodedFps.captureSample(S.extensions.frameRateEncoded);const f=[];for(const g of this.fsOvershoot.events)f.push({...g,overshootType:"fs"});for(const g of this.fpsOvershoot.events)f.push({...g,overshootType:"fps"});for(const g of this.brOvershoot.events)f.push({...g,overshootType:"br"});f.sort(((g,m)=>g.timestamp-m.timestamp)),v.aggregated={lossRateMax:this.lossRateAverager.maxSample,duration:this.duration,frameRateAvg:round(this.framerateAverager.avg),captureFramerateAvg:round(this.captureFpsAverager.avg),fpsHarmonicAverage:round(this.harmonicEncodedFps.harmonicMean),qpAvg:round(S.outboundRTP.qpSum/S.outboundRTP.framesSent),rttAvg:round(this.rttAverager.avg),bitrateAvg:round(this.bitrateAverager.avg,0),bitrateMax:round(this.bitrateAverager.maxSample,0),bitrateMinNonZero:round(this.bitrateAverager.minNonZeroSample,0),bweAvg:round(this.sendBWEAverager.avg,0),captureFreezeIntervalsCount:this.captureFreezeIntervalsCount,numResolutionSwitches:this.resolutionDurations.changeCount,resolutionDurations:this.resolutionDurations.durations,resolutionDurationRatios:this.resolutionDurations.durationRatios,isFsOvershooting:this.fsOvershoot.isOvershooting,isFpsOvershooting:this.fpsOvershoot.isOvershooting,isBrOvershooting:this.brOvershoot.isOvershooting,totalFsOvershootDuration:this.fsOvershoot.totalDuration,totalFpsOvershootDuration:this.fpsOvershoot.totalDuration,totalBrOvershootDuration:this.brOvershoot.totalDuration,overshootEvents:f},this.duration++}arrayLimitedPush(m,v,f)}},yy=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.extenders=new Map}processStats(g){const m=new Set;for(const f in g)try{m.add(f);const S=g[f],v=this.extenders.get(S.id)??new Cy(this.configProvider,this.diagnostics);this.extenders.set(S.id,v),v.processSample(S)}catch(g){this.diagnostics.addStatsError("TransportStatsProcessor",stringifyObject(g))}clearMap(this.extenders,m)}},Cy=class{constructor(g,m){this.configProvider=g,this.diagnostics=m,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.bwJumpsHistogramCollector=new $v,this.sendBWEAverager=new xv,this.recvBWEAverager=new xv,this.sendBW=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.recvBW=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.sendBWAverager=new xv,this.recvBWAverager=new xv}processSample(g){this.sendBWEAverager.captureSample(g.selectedCandidatePair?.availableOutgoingBitrate),this.recvBWEAverager.captureSample(g.selectedCandidatePair?.availableIncomingBitrate),this.sendBW.captureSample(g.selectedCandidatePair?.bytesSent,g.selectedCandidatePair?.timestamp),this.recvBW.captureSample(g.selectedCandidatePair?.bytesReceived,g.selectedCandidatePair?.timestamp);const m=this.sendBW.delta,f=this.recvBW.delta,S=m?8*m:void 0,v=f?8*f:void 0;this.sendBWAverager.captureSample(S),this.recvBWAverager.captureSample(v);const C=g.selectedCandidatePair?.availableOutgoingBitrate;C&&(this.bwJumpsHistogramCollector.active=this.bwJumpsHistogramCollector.active&&C<this.configProvider.config.webrtcBWJumpUpperLimit||C<this.configProvider.config.webrtcBWJumpLowerLimit),g.extensions={sendBWEAvg:round(this.sendBWEAverager.avg,0),sendBWEMax:round(this.sendBWEAverager.maxSample,0),recvBWEAvg:round(this.recvBWEAverager.avg,0),recvBWEMax:round(this.recvBWEAverager.maxSample,0),sendBitrate:S,recvBitrate:v,sendBWAvg:round(this.sendBWAverager.avg,0),sendBWMax:round(this.sendBWAverager.maxSample,0),recvBWAvg:round(this.recvBWAverager.avg,0),recvBWMax:round(this.recvBWAverager.maxSample,0),bwJumpsHistogram:this.bwJumpsHistogramCollector.counts,reflexiveLocalIP:this.diagnostics.reflexiveLocalIP}}},_y=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.extenders=new Map}processStats(g){if(!g)return;const m=new Set;for(const f of g)try{m.add(f.id);const g=this.extenders.get(f.id)??new Ey(this.configProvider);this.extenders.set(f.id,g),g.processSample(f)}catch(g){this.diagnostics.addStatsError("DataChannelStatsProcessor",stringifyObject(g))}clearMap(this.extenders,m)}},Ey=class{constructor(g){this.configProvider=g,this.useLastSampleDeltaPerSecondConverter=this.configProvider.config.diagnostics.features.useLastSampleDeltaPerSecondConverter,this.sendBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.recvBytesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.sendMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv,this.recvMessagesDeltaCalculator=this.useLastSampleDeltaPerSecondConverter?new Bv:new Vv}processSample(g){this.sendBytesDeltaCalculator.captureSample(g.bytesSent,g.timestamp),this.recvBytesDeltaCalculator.captureSample(g.bytesReceived,g.timestamp);const m=this.sendBytesDeltaCalculator.delta,f=this.recvBytesDeltaCalculator.delta,S=m?8*m:void 0,v=f?8*f:void 0;this.sendMessagesDeltaCalculator.captureSample(g.messagesSent,g.timestamp),this.recvMessagesDeltaCalculator.captureSample(g.messagesReceived,g.timestamp);const C=this.sendMessagesDeltaCalculator.delta,_=this.recvMessagesDeltaCalculator.delta;g.extensions={sendBitrate:S,recvBitrate:v,sendMessageRate:C,recvMessageRate:_}}},Ty=class{constructor(g){this.collecVideoStatsAfterSubscription=g,this.videoStatsEvent=[],this.count=0}prepareCollectingStatsOnSubscribed(g){this.count=0,this.videoStatsEvent.push({ts:Date.now(),framesDecoded:[],bytesReceived:[],height:[],msi:g})}captureStatsOnSubscribed(g,m,f,S){if(this.count>=this.collecVideoStatsAfterSubscription)return;const v=getLast(this.videoStatsEvent);v&&(v.framesDecoded.push(g),v.bytesReceived.push(m),void 0!==f&&v.height.push(f)),this.count++}getStatsOnSubscribed(){return this.videoStatsEvent}},Iy=class{constructor(g,m,f,S){this.slidingWindowSize=g,this.maxDeviation=m,this.minBandwidth=f,this.directionalityCheck=S,this.slidingWindow=new Wm(this.slidingWindowSize),this.currentModality=null,this.previousModality=null,this.inProcess=!1}processBandwidth(g,m,f){this.currentModality?this.handleStopEvent(m,f):this.handleStartEvent(m,f),this.inProcess&&(this.stabilizationTime++,this.slidingWindow.add(g),this.inProcess=!this.slidingWindow.isFull||!this.isBandwidthStable())}getReport(g=!1){if(void 0!==this.stabilizationTime){return{time:this.inProcess?this.stabilizationTime:Math.max(this.stabilizationTime-this.slidingWindowSize,0),bandwidth:g?round(this.averageBandwidth,2):this.averageBandwidth,finished:!this.inProcess,modality:this.previousModality}}}handleStartEvent(g,m){this.currentModality=this.GetModalityString(g),m&&this.currentModality&&!this.previousModality&&(this.previousModality=this.currentModality,this.stabilizationTime=0,this.slidingWindow.clear(),this.inProcess=!0)}handleStopEvent(g,m){m&&(this.directionalityCheck(g.audio)||this.directionalityCheck(g.video)||this.directionalityCheck(g.sharing))||(this.currentModality=null,this.inProcess=!1)}GetModalityString(g){return[this.directionalityCheck(g.audio)?je.MODALITY.audio:null,this.directionalityCheck(g.video)?je.MODALITY.video:null,this.directionalityCheck(g.sharing)?je.MODALITY.sharing:null].filter(Boolean).join(", ")}isBandwidthStable(){if(this.averageBandwidth=average(this.slidingWindow.items),this.averageBandwidth<this.minBandwidth)return!1;{const g=this.averageBandwidth*this.maxDeviation,m=this.averageBandwidth-g,f=this.averageBandwidth+g;return this.slidingWindow.items.every((g=>isInRange(g,m,f)))}}},by=class{constructor(g,m){this.diagnostics=g,this.configProvider=m,this.uplinkStabilizationTelemetry=new Iy(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,hasSendDirectionality),this.downlinkSabilizationTelemetry=new Iy(this.configProvider.config.downlinkBWStabilizationSlidingWindowSize,this.configProvider.config.downlinkBWStabilizationMaxDeviation,this.configProvider.config.downlinkBWStabilizationMinBandwidth,hasReceiveDirectionality),this.bandwidthCalculator=new Jv,this.bandwidthAvg=new xv}processStats(g){const m=this.diagnostics.getObjectRef(),f=m?.activeModalities;if(!f||!g.transports)return;const S=g.transports[Object.keys(g.transports)[0]],v=m?.reportedReceiveBandwidth?.[m.reportedReceiveBandwidth.length-1],C=S?.selectedCandidatePair?.availableOutgoingBitrate,_=g.audio?.send?.length>0||g.video?.send?.length>0||g.sharing?.send?.length>0,E=g.audio?.recv?.length>0||g.video?.recv?.length>0||g.sharing?.recv?.length>0;this.bweType!==m?.bweType&&(this.bandwidthCalculator=new Jv,this.bandwidthAvg=new xv,this.bweType=m?.bweType);const T="REMB"===m?.bweType?"availableIncomingBitrate":"availableOutgoingBitrate",I=S?.selectedCandidatePair?.[T];this.bandwidthCalculator.captureSample(I),this.bandwidthAvg.captureSample(I);try{this.uplinkStabilizationTelemetry.processBandwidth(C,f,_),this.downlinkSabilizationTelemetry.processBandwidth(v,f,E)}catch(g){this.diagnostics.addStatsError("BandwithStatsProcessor",stringifyObject(g))}}getStabilizedReport(g=!1){return this.uplinkStabilizationTelemetry.getReport(g)}getDownlinkStabilizedReport(g=!1){return this.downlinkSabilizationTelemetry.getReport(g)}calculateBwPercentiles(){if(!this.bandwidthCalculator.getFirst())return;const g=this.configProvider.config.bwPercentiles,m={};return g.forEach((g=>{Object.defineProperty(m,g,{value:this.bandwidthCalculator.calculatePercentile(g/100),enumerable:!0})})),m}getBandwidthReport(){return{startOfTheCall:this.bandwidthCalculator.getFirst(),endOfTheCall:this.bandwidthCalculator.getLast(),std:this.bandwidthCalculator.calculateStd(),bwPercentiles:this.calculateBwPercentiles(),avgBwe:round(this.bandwidthAvg.avg,2)}}},Ay=class{constructor(g,m){this.configProvider=g,this.diagnostics=m,this.dataChannelStatsProcessor=new _y(this.diagnostics,this.configProvider),this.transportStatsProcessor=new yy(this.diagnostics,this.configProvider),this.audioStatsProcessor=new ay(this.diagnostics,this.configProvider),this.videoStatsProcessor=new py(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new py(this.diagnostics,this.configProvider),this.bandwithStatsProcessor=new by(this.diagnostics,this.configProvider),this.macroblockStatsTracker=new Xv,this.statsAggregators={audio:{recv:new ly,send:new dy(this.diagnostics)},video:{recv:new fy(this.configProvider),send:new vy(this.configProvider)},sharing:{recv:new fy(this.configProvider),send:new vy(this.configProvider)}},this.aggregatedModalityStats={},this.recvVideoStreamsCounter=new Uv,this.multiviewData={},this.multiviewKeySet=new Set,this.statsOnSubscribedData={video:{},sharing:{}},this.statsOnSubscribed={video:[],sharing:[]},this.diagnostics.aggregatedStatsRef=this.aggregatedModalityStats,this.diagnostics.statsOnSubscribed=this.statsOnSubscribed,this.diagnostics.bandwidthDiagnostic=this.bandwithStatsProcessor}processStats(g){this.dataChannelStatsProcessor.processStats(g.data),this.transportStatsProcessor.processStats(g.transports),this.audioStatsProcessor.processStats(g.audio),this.videoStatsProcessor.processStats(g.video),this.sharingStatsProcessor.processStats(g.sharing),this.bandwithStatsProcessor.processStats(g),this.diagnostics.bwStabiliationTime=this.bandwithStatsProcessor.getStabilizedReport(!0),this.diagnostics.bwDownlinkStabiliationTime=this.bandwithStatsProcessor.getDownlinkStabilizedReport(!0),this.recvVideoStreamsCounter.captureSample(g.video?.recv?.length),this.diagnostics.recvVideoStreamsCount={min:this.recvVideoStreamsCounter.min,max:this.recvVideoStreamsCounter.max,mode:this.recvVideoStreamsCounter.mode};try{this.processAggregated(g)}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processAggregated",stringifyObject(g))}try{this.processMultiview(g.video?.recv??[])}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processMultiview",stringifyObject(g))}try{const g=navigator?.connection;g&&this.diagnostics.addNetworkInfo({downlink:g.downlink,rtt:g.rtt,effectiveType:g.effectiveType,saveData:g.saveData})}catch(g){this.diagnostics.addStatsError("webrtcStatistics:processStats(networkInfo)",stringifyObject(g))}try{this.processMacroblockRateStats(g.video?.recv)}catch(g){this.diagnostics.addStatsError("webrtcStatistics: processMacroblockRateStats",stringifyObject(g))}}signalNoConnection(){this.transportStatsProcessor=new yy(this.diagnostics,this.configProvider),this.audioStatsProcessor=new ay(this.diagnostics,this.configProvider),this.videoStatsProcessor=new py(this.diagnostics,this.configProvider),this.sharingStatsProcessor=new py(this.diagnostics,this.configProvider)}processMultiview(g){const m=new Set;for(const f of g){const g=f.inboundRTP.id;m.add(g);let S=this.multiviewData[g];S&&this.multiviewKeySet.has(g)?S.stats.duration++:(S={bitrateAverager:new xv,jitterAverager:new xv,frameRateAverager:new xv,freezeHistogram:new $v,resolutionDurations:new Gv,isRenderingEvents:[],statsOnSubscribed:new Ty(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),stats:{ssrc:f.inboundRTP.ssrc,startTime:Date.now(),duration:0,framesDecoded:[],bytesReceived:[],height:[],width:[]}},S.statsOnSubscribed.prepareCollectingStatsOnSubscribed(f.renderer?.msi),this.multiviewData[g]=S),S.statsOnSubscribed.captureStatsOnSubscribed(f.inboundRTP.framesDecoded,f.inboundRTP.bytesReceived,f.inboundRTP.frameHeight),S.bitrateAverager.captureSample(f.extensions?.bitrate),S.jitterAverager.captureSample(1e3*(f.inboundRTP.jitter??0)),S.frameRateAverager.captureSample(f.extensions.frameRateReceived),S.freezeHistogram.active=f.extensions?.isFrozen,f.inboundRTP.frameWidth&&f.inboundRTP.frameHeight&&S.resolutionDurations.captureSample(`${f.inboundRTP.frameWidth}x${f.inboundRTP.frameHeight}`);const v=f.renderer?.isRendering??!1;(!S.isRenderingEvents.length&&v||S.isRenderingEvents.length&&getLast(S.isRenderingEvents).isRendering!==v)&&arrayLimitedPush(S.isRenderingEvents,{isRendering:v,ts:Date.now()},this.configProvider.config.diagnostics.collectionLimits.numIsRenderingEvents),S.stats.frameRateAvg=round(S.frameRateAverager.avg),S.stats.bitrateAvg=round(S.bitrateAverager.avg,0),S.stats.bitrateMax=round(S.bitrateAverager.maxSample,0),S.stats.bitrateMinNonZero=round(S.bitrateAverager.minNonZeroSample),S.stats.freezeHistogram=S.freezeHistogram.counts,S.stats.freezeTimestamps=S.freezeHistogram.timestamps,S.stats.avgFreezeDuration=round(S.freezeHistogram.avgDuration),S.stats.totalFreezeDuration=S.freezeHistogram.totalDuration,S.stats.ongoingFreeze=S.freezeHistogram.active,S.stats.ongoingFreezeDuration=S.freezeHistogram.ongoingDuration,S.stats.numResolutionSwitches=S.resolutionDurations.changeCount,S.stats.rendererSize=`${f.renderer?.rendererSize?.width}x${f.renderer?.rendererSize?.height}`,S.stats.resolutionDurations=S.resolutionDurations.durations,S.stats.timeToFirstFrame=f.renderer?.timeToFirstFrame,S.stats.timeToFirstFrameSinceSubscriptionStart=f.renderer?.timeToFirstFrameSinceSubscriptionStart,S.stats.isRenderingEvents=S.isRenderingEvents,S.stats.statsOnSubscribed=S.statsOnSubscribed.getStatsOnSubscribed(),S.stats.msi=f.renderer?.msi,S.stats.rendererStates=f.renderer?.rendererStates,arrayLimitedPush(S.stats.framesDecoded,f.inboundRTP.framesDecoded,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(S.stats.framesDecoded,f.inboundRTP.framesDecoded,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(S.stats.bytesReceived,f.inboundRTP.bytesReceived,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(S.stats.height,f.inboundRTP.frameHeight,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),arrayLimitedPush(S.stats.width,f.inboundRTP.frameWidth,this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples);const C=f.extensions?.macroblockRateStats??{};for(const g in C)S.stats[g]=round(C[g],0)}this.diagnostics.multiViewStats=Object.values(this.multiviewData).map((g=>g.stats)),this.multiviewKeySet=m}processAggregated(g){for(const m of["audio","video","sharing"])if(g[m])for(const f in g[m])this.processAggregatedModality(g,m,f)}processAggregatedModality(g,m,f){var S,v;const C=g[m]?.[f]?.length??0;C>0&&((S=this.aggregatedModalityStats)[m]??(S[m]={}),(v=this.aggregatedModalityStats[m])[f]??(v[f]=[]),C>1&&("audio"===m||"sharing"===m)&&this.diagnostics.addStatsError("webrtcStatistics:processAggregatedModality",`Multiple ${m} ${f} streams: ${C}`),this.statsAggregators[m][f].processSample(g[m][f],this.aggregatedModalityStats[m][f],this.configProvider.config.diagnostics.telemetryLimits.numAggregatedSamples),"sharing"!==m&&"video"!==m||"recv"!==f||this.processStatsOnSubscribed(g[m][f],m))}processStatsOnSubscribed(g,m){const f=new Set;for(const S of g)if(S.inboundRTP){const g=`${S.inboundRTP.id}x${S.renderer?.msi}`;let v=this.statsOnSubscribedData[m]?.[g];f.add(g),v||(v=new Ty(this.configProvider.config.diagnostics.telemetryLimits.maxVideoStatsAfterSubscription),v.prepareCollectingStatsOnSubscribed(S.renderer?.msi),this.statsOnSubscribedData[m][g]=v,this.statsOnSubscribed[m].push(...v.getStatsOnSubscribed())),v.captureStatsOnSubscribed(S.inboundRTP.framesDecoded,S.inboundRTP.bytesReceived)}clearObj(this.statsOnSubscribedData[m],f)}processMacroblockRateStats(g){if(!g?.length)return;let m=0,f=0;for(const S of g)m+=S.extensions?.macroblockRateReceived,f+=S.extensions?.macroblockRateDecoded;this.macroblockStatsTracker.captureSample(m,f),this.diagnostics.setTotalVideoRecvMblocksRates(this.macroblockStatsTracker.getReport())}},Py=R,Ry=class{constructor(g,m,f,S){this.logger=g,this.configProvider=m,this.diagnostics=f,this.mediaManager=S,this.webrtcStats=new Ay(this.configProvider,this.diagnostics),this.ssrcToRecvTrackMap=new Map,this.activeChannels={}}setAudioDecoderStatsProvider(g){this.audioDecoderStatsProvider=g}signalNoConnection(){this.webrtcStats.signalNoConnection()}processRawReport(g){this.diagnostics.latestRawReport=g;const m={loopTime:-1,fetchTime:-1,convertTime:-1,processingTime:-1,legacyProcessingTime:-1};try{let f=We(),S=f;const v=this.convertStatsReport(g);return v.perfCounters=m,f=We(),m.convertTime=f-S,S=f,this.webrtcStats.processStats(v),this.diagnostics.addStatsReport(v),f=We(),m.processingTime=f-S,v}catch(g){const m=stringifyObject(g);return this.logger.safe.error(`Error processing raw stats: ${m}`),void this.diagnostics.addStatsError("StatisticsGatherer:processRawReport",m)}}setSsrcTrackPair(g,m){null===m?this.ssrcToRecvTrackMap.delete(g):this.ssrcToRecvTrackMap.set(g,m)}convertStatsReport(g){const m={transports:this.processTransportStats(g)};return this.appendPcStats(g,m),this.appendSendMediaStats(g,m),this.appendRecvMediaStats(g,m),g["data-channel"]&&(m.data=Object.values(g["data-channel"])),m}processTransportStats(g){if(g.transport){const m={};for(const f in g.transport){const S=g.transport[f];if(m[f]=shallowClone(S),S.selectedCandidatePairId){const v=shallowClone(g["candidate-pair"][S.selectedCandidatePairId]);v.localCandidate=g["local-candidate"][v.localCandidateId],v.remoteCandidate=g["remote-candidate"][v.remoteCandidateId],m[f].selectedCandidatePair=v}S.localCertificateId&&g.certificate&&(m[f].localCertificate=g.certificate[S.localCertificateId]),S.remoteCertificateId&&g.certificate&&(m[f].remoteCertificate=g.certificate[S.remoteCertificateId])}return m}if(g["candidate-pair"]){const m={};for(const f in g["candidate-pair"]){const S=shallowClone(g["candidate-pair"][f]);S.selected&&(S.localCandidate=g["local-candidate"][S.localCandidateId],S.remoteCandidate=g["remote-candidate"][S.remoteCandidateId],m.faketransport={id:"faketransport",timestamp:S.timestamp,type:"transport",selectedCandidatePair:S,selectedCandidatePairId:S.id})}return m}}appendPcStats(g,m){let f="";g["peer-connection"]&&(Object.keys(g["peer-connection"]).forEach((g=>{""===f?f=g:(this.logger.safe.error(`Unexpected second peer connection stats id ${g}, also found ${f}`),this.diagnostics.addStatsError("StatisticsGatherer","Unexpected second peer connection stats"))})),m.peerConnection=g["peer-connection"][f])}appendSendMediaStats(g,m){var f,S,v,C;for(const _ in g["outbound-rtp"]){const E=g["outbound-rtp"][_],T={outboundRTP:E};E.codecId&&g.codec&&(T.codec=g.codec[E.codecId]),Object.defineProperty(T,"transport",{value:m.transports[E.transportId??"faketransport"],configurable:!1,enumerable:!1}),E.remoteId&&g["remote-inbound-rtp"]&&(T.remoteInboundRTP=g["remote-inbound-rtp"][E.remoteId]),E.mediaSourceId&&g["media-source"]&&(T.mediaSource=g["media-source"][E.mediaSourceId]),E.trackId&&g.track&&(T.track=g.track[E.trackId]);const I=getEntityByLocalTrack(this.mediaManager,T.track?.trackIdentifier??T.mediaSource?.trackIdentifier,E.rid)??getEntityByLocalSSRC(this.mediaManager,E.ssrc,E.rid)??getMediaEntitieByMid(this.mediaManager,T.outboundRTP.mid,E.rid);if(!I?.getLocalTrackId())continue;T.mediaEntity=I.serialize();const b="video"===E.kind?"sharing"===I?.getModality()?"sharing":"video":E.kind;if((f=this.activeChannels)[b]??(f[b]={}),(S=this.activeChannels[b]).send??(S.send={}),hasSendDirectionality(this.diagnostics.getObjectRef().activeModalities?.[b])){if(m[b]||(m[b]={}),m[b].send||(m[b].send=[]),"video"===E.kind){const g=getRequestedCapabilitiesBySsrc(this.diagnostics,b,E.ssrc)??getRequestedCapabilitiesBySsrc(this.diagnostics,b,0);g&&(T.requestedCapabilities=g);const f=getAppliedCapabilitiesBySsrc(this.diagnostics,b,E.ssrc)??getAppliedCapabilitiesBySsrc(this.diagnostics,b,0);f&&(T.appliedCapabilities=f);const S=m[b].send.find((g=>g.outboundRTP.trackId===T.outboundRTP.trackId));if(S){const g=parseInt(S.outboundRTP.rid,10)>parseInt(T.outboundRTP.rid,10);if(!S.altLayouts&&g&&(S.altLayouts=[]),g)S.altLayouts.push(T);else{T.altLayouts=[],T.altLayouts.push(S);const g=m[b].send.indexOf(S);m[b].send[g]=T}continue}}this.activeChannels[b].send[E.id]=T,m[b].send.push(T)}else this.activeChannels[b].send[E.id]&&"sharing"!==b&&(m.inactiveTracks??(m.inactiveTracks={}),(v=m.inactiveTracks)[b]??(v[b]={}),(C=m.inactiveTracks[b]).send??(C.send=[]),m.inactiveTracks[b].send.push(this.activeChannels[b].send[E.id]))}}appendRecvMediaStats(g,m){var f,S,v,C;const _=this.diagnostics.getObjectRef().subscriptionManager?.subscribedTrackIds;for(const E in g["inbound-rtp"]){const T=g["inbound-rtp"][E],I={inboundRTP:T};T.codecId&&g.codec&&(I.codec=g.codec[T.codecId]),"audio"===T.kind&&I.inboundRTP.ssrc===this.audioDecoderStatsProvider?.ssrc&&(I.codec||(I.codec={transportId:T.transportId??"faketransport",id:"fakeCodec",payloadType:999,timestamp:T.timestamp,type:"codec",mimeType:"unk"}),I.codec.mimeType=this.audioDecoderStatsProvider.codecName,I.inboundRTP=(0,Py.merge)(I.inboundRTP,this.audioDecoderStatsProvider.getWebRtcCompatibaleStats()),I.customHealerStats=this.audioDecoderStatsProvider.getWasmStats()),m.transports[T.transportId??"faketransport"]&&Object.defineProperty(I,"transport",{value:m.transports[T.transportId??"faketransport"],configurable:!1,enumerable:!1}),T.remoteId&&g["remote-outbound-rtp"]&&(I.remoteOutboundRTP=g["remote-outbound-rtp"][T.remoteId]);const b=I.inboundRTP.trackIdentifier??this.ssrcToRecvTrackMap.get(T.ssrc);if(T.trackId||b){T.trackId&&g.track?I.track=g.track[T.trackId]:b&&(I.track={id:"ssrcToTrackId",kind:T.kind,timestamp:T.timestamp,type:"track",trackIdentifier:b});const m=getRendererDiagnosticsByTrack(this.diagnostics,I.track?.trackIdentifier);m&&(I.renderer=m)}const A=getEntityByRemoteTrack(this.mediaManager,I.track?.trackIdentifier)??getEntityByRemoteSSRC(this.mediaManager,T.ssrc);if(!A)continue;I.mediaEntity=A.serialize();const P="video"===T.kind&&I.track?"sharing"===A?.getModality()?"sharing":"video":T.kind;(f=this.activeChannels)[P]??(f[P]={}),(S=this.activeChannels[P]).recv??(S.recv={}),"video"!==T.kind||_.some((g=>g&&g===I.track?.trackIdentifier))?hasReceiveDirectionality(this.diagnostics.getObjectRef().activeModalities?.[P])&&(m[P]||(m[P]={}),m[P].recv||(m[P].recv=[]),this.activeChannels[P].recv[T.id]=I,m[P].recv.push(I)):this.activeChannels[P].recv[T.id]&&"sharing"!==P&&(m.inactiveTracks??(m.inactiveTracks={}),(v=m.inactiveTracks)[P]??(v[P]={}),(C=m.inactiveTracks[P]).recv??(C.recv=[]),m.inactiveTracks[P].recv.push(this.activeChannels[P].recv[T.id]))}}};function verifyRidIfPresent(g,m){return!m||g.getSimulcastContext()?.activeRids.map(String).some((g=>g===m))}function getEntityByRemoteSSRC(g,m){return g.getMediaEntities().find((g=>g.getRemoteSsrc()===m))}function getEntityByRemoteTrack(g,m){const f=g.getMediaEntities();return void 0!==m?f.find((g=>g.getRemoteTrackId()===m)):void 0}function getEntityByLocalSSRC(g,m,f){return g.getMediaEntities().find((g=>g.getLocalSsrc()===m&&verifyRidIfPresent(g,f)))}function getEntityByLocalTrack(g,m,f){const S=g.getMediaEntities();return m?S.find((g=>g.getLocalTrackId()===m&&verifyRidIfPresent(g,f))):void 0}function getRequestedCapabilitiesBySsrc(g,m,f){const S=g.getObjectRef().qualityManager;return"video"===m?S?.currentVideoSsrcRequestedCapabilities[`${f}`]:"sharing"===m?S?.currentSharingSsrcRequestedCapabilities[`${f}`]:void 0}function getAppliedCapabilitiesBySsrc(g,m,f){const S=g.getObjectRef().qualityManager;return"video"===m?S?.currentVideoSsrcAppliedCapabilities[`${f}`]:"sharing"===m?S?.currentSharingSsrcAppliedCapabilities[`${f}`]:void 0}function getRendererDiagnosticsByTrack(g,m){return g.getObjectRef().remoteVideoManager?.renderers.find((g=>g.trackId===m))}function getMediaEntitieByMid(g,m,f){const S=g.getMediaEntities();return m?S.find((g=>g.getMid()===m&&verifyRidIfPresent(g,f))):void 0}var wy=class{constructor(){this.googCandidatePair={},this.ssrc={},this.googComponent={},this.VideoBwe={bweforvideo:{}}}},My=class{constructor(){this.statistics=new wy,this.statsDiffMap=new Map,this.ssrcTrackMap=new Map}build(g){return this.statistics=new wy,this.constructGoogCandidatePair(g),this.constructGoogSsrc(g),this.constructGoogComponent(g),this.constructDataChannel(g),this.constructBwe(g),this.statistics}setSsrcTrackPair(g,m){null===m?this.ssrcTrackMap.delete(g):this.ssrcTrackMap.set(g,m)}setAudioDecoderStatsProvider(g){this.audioDecoderStatsProvider=g}constructGoogSsrc(g){const m={};if(g.hasOwnProperty("outbound-rtp")){const f=g["outbound-rtp"];Object.keys(f).forEach((S=>{const v=`ssrc_${f[S].ssrc}_send`,C=this.constructSendSsrc(g,f[S]);m[v]=C}))}if(g.hasOwnProperty("inbound-rtp")){const f=g["inbound-rtp"];Object.keys(f).forEach((S=>{const v=`ssrc_${f[S].ssrc}_recv`,C=this.constructRecvSsrc(g,f[S]);m[v]=C}))}this.statistics.ssrc=m}constructSendSsrc(g,m){const f=m.trackId?g.track[m.trackId]:null,S=m.mediaSourceId?g["media-source"][m.mediaSourceId]:null,v=g["remote-inbound-rtp"]?.[m.remoteId],C=`ssrc_${m.ssrc}_send`,_=S?.trackIdentifier??f?.trackIdentifier??this.ssrcTrackMap.get(m.ssrc);let E={id:C,ssrc:m.ssrc,mediaType:m.mediaType??m.kind,bytesSent:m.bytesSent,bytesSentDiff:this.calculateDiff(C,m.bytesSent,4),packetsSent:m.packetsSent,packetsLost:v?.packetsLost,jitter:v?.jitter,googRtt:this.getRtt(v),googCodecName:this.getCodec(g,m.codecId),transportId:m.transportId,googTrackId:_};return"audio"===E.mediaType&&(E={...E,...this.constructAudioSendSsrc(m,S)}),"video"===E.mediaType&&(E={...E,...this.constructVideoSendSsrc(m,S,C,f)}),removeUndefinedFields(E)}constructAudioSendSsrc(g,m){return{audioInputLevel:m?.audioLevel,totalAudioEnergy:m?.totalAudioEnergy,fecPacketsSent:g.fecPacketsSent}}constructVideoSendSsrc(g,m,f,S){return{framesEncoded:g.framesEncoded,googFrameRateEncoded:this.calculateDiff(f,g.framesEncoded,2),googFrameRateSent:this.calculateDiff(f,g.framesSent??S?.framesSent,1),googFrameRateInput:m?.framesPerSecond,googFrameHeightSent:g.frameHeight??S?.frameHeight,googFrameWidthSent:g.frameWidth??S?.frameWidth,googFrameHeightInput:m?.height,googFrameWidthInput:m?.width,hugeFramesSent:g.hugeFramesSent??S?.hugeFramesSent,keyFramesEncoded:g.keyFramesEncoded,qpSum:g.qpSum,qp:this.calculateDiff(f,g.qpSum,8),googPlisReceived:g.pliCount,googFirsReceived:g.firCount,googNacksReceived:g.nackCount,qualityLimitationDurations:g.qualityLimitationDurations,qualityLimitationReason:g.qualityLimitationReason,qualityLimitationResolutionChanges:g.qualityLimitationResolutionChanges,codecImplementationName:g.encoderImplementation,rid:g.rid,encodeTime:g.totalEncodeTime&&Math.round(1e3*this.calculateDiff(f,g.totalEncodeTime,6))}}constructRecvSsrc(g,m){const f=m.trackId?g.track[m.trackId]:null,S=`ssrc_${m.ssrc}_recv`,v=m.trackIdentifier??f?.trackIdentifier??this.ssrcTrackMap.get(m.ssrc);let C={id:S,ssrc:m.ssrc,mediaType:m.mediaType??m.kind,bytesReceived:m.bytesReceived,bytesReceivedDiff:this.calculateDiff(S,m.bytesReceived,5),packetsReceived:m.packetsReceived,packetsLost:m.packetsLost,jitter:m.jitter,googJitterBufferMs:m.jitterBufferEmittedCount&&Math.round(m.jitterBufferDelay/m.jitterBufferEmittedCount*1e3),googCodecName:this.getCodec(g,m.codecId),googTrackId:v,transportId:m.transportId};return"audio"===C.mediaType&&(C={...C,...this.constructAudioRecvSsrc(m,f)}),"video"===C.mediaType&&(C={...C,...this.constructVideoRecvSsrc(m,S,f)}),removeUndefinedFields(C)}constructAudioRecvSsrc(g,m){const f=this.audioDecoderStatsProvider?.ssrc===g.ssrc?this.audioDecoderStatsProvider?.getWebRtcCompatibaleStats():g,S={audioOutputLevel:f.audioLevel??m?.audioLevel,totalAudioEnergy:f.totalAudioEnergy??m?.totalAudioEnergy,concealedSamples:f.concealedSamples,silentConcealedSamples:f.silentConcealedSamples,totalSamplesReceived:f.totalSamplesReceived,healedRatio:f.totalSamplesReceived&&(f.concealedSamples-f.silentConcealedSamples)/f.totalSamplesReceived,fecPacketsReceived:f.fecPacketsReceived,fecPacketsDiscarded:f.fecPacketsDiscarded,packetsDiscarded:f.packetsDiscarded};if(this.audioDecoderStatsProvider?.ssrc===g.ssrc){S.googJitterBufferMs=f.jitterBufferEmittedCount&&Math.round(f.jitterBufferDelay/f.jitterBufferEmittedCount*1e3),S.googCodecName=this.audioDecoderStatsProvider.codecName;const g=this.audioDecoderStatsProvider.getDecoderStats();S.pushCount=g.pushCount,S.pushErrCount=g.pushErrCount,S.pullCount=g.pullCount,S.pullErrCount=g.pullErrCount}return S}constructVideoRecvSsrc(g,m,f){return{framesDecoded:g.framesDecoded,googFrameRateDecoded:this.calculateDiff(m,g.framesDecoded,3),googFrameRateReceived:this.calculateDiff(m,g.framesReceived??f?.framesReceived,0),googFrameHeightReceived:g.frameHeight??f?.frameHeight,googFrameWidthReceived:g.frameWidth??f?.frameWidth,keyFramesDecoded:g.keyFramesDecoded,googPlisSent:g.pliCount,googFirsSent:g.firCount,googNacksSent:g.nackCount,codecImplementationName:g.decoderImplementation,decodeTime:g.totalDecodeTime&&Math.round(1e3*this.calculateDiff(m,g.totalDecodeTime,7))}}constructGoogCandidatePair(g){const m=g["candidate-pair"];m&&Object.keys(m).forEach((f=>{const S=this.constructPair(g,m[f]);this.statistics.googCandidatePair[S.id]=S}))}constructPair(g,m){const f=g["local-candidate"][m.localCandidateId],S=g["remote-candidate"][m.remoteCandidateId];return removeUndefinedFields({bytesReceived:m.bytesReceived,bytesSent:m.bytesSent,googTransportType:f.protocol,googRtt:m.currentRoundTripTime?Math.round(1e3*m.currentRoundTripTime):void 0,googLocalAddress:`${f.ip?f.ip:f.address}:${f.port}`,googLocalCandidateType:f.candidateType,localRelayProtocol:f.relayProtocol,localNetworkType:f.networkType,googRemoteAddress:`${S.ip?S.ip:S.address}:${S.port}`,googRemoteCandidateType:S.candidateType,googActiveConnection:m.nominated,requestsReceived:m.requestsReceived,requestsSent:m.requestsSent,responsesReceived:m.responsesReceived,responsesSent:m.responsesSent,consentRequestsSent:m.consentRequestsSent,id:m.id,remoteCandidateId:m.remoteCandidateId,localCandidateId:m.localCandidateId,googWritable:m.writable,selected:m.selected})}constructGoogComponent(g){g.transport&&Object.keys(g.transport).forEach((m=>{this.statistics.googComponent[m]={id:m,selectedCandidatePairId:g.transport[m].selectedCandidatePairId}}))}constructDataChannel(g){if(!g.hasOwnProperty("data-channel"))return;const m=g["data-channel"];this.statistics.data=Object.keys(m).map((g=>{const f=m[g];return{bytesReceived:f.bytesReceived,bytesSent:f.bytesSent,dataChannelIdentifier:f.dataChannelIdentifier,label:f.label,messagesReceived:f.messagesReceived,messagesSent:f.messagesSent,protocol:f.protocol,state:f.state,timestamp:f.timestamp,type:f.type}}))}constructBwe(g){const m=Object.values(g["outbound-rtp"]??{})?.find((g=>{const m=g.mediaType??g.kind;return"audio"===m||"video"===m}));if(!m)return;const f=g.transport?.[m.transportId];if(!f)return;const S=g["candidate-pair"]?.[f.selectedCandidatePairId];if(!S)return;const v={googAvailableSendBandwidth:S.availableOutgoingBitrate,googAvailableReceiveBandwidth:S.availableIncomingBitrate};this.statistics.VideoBwe.bweforvideo=removeUndefinedFields(v)}getRtt(g){const m=g?.roundTripTime;return m?Math.round(1e3*m):void 0}getCodec(g,m){if(m&&g.codec&&g.codec[m])return g.codec[m].mimeType.split("/")[1]}calculateDiff(g,m,f){if(void 0===m)return;let S=m;const v=this.statsDiffMap.has(g)?this.statsDiffMap.get(g):new Map;if(v.has(f)){const g=v.get(f);g<=m&&(S=m-g)}return v.set(f,m),this.statsDiffMap.set(g,v),isNaN(S)?void 0:S}},Dy=R,Oy=R,Ny=class{constructor(g){this.healedRatio=0,this.healedRatioMax=0,this.healedRatioDuration=0,this.healedRatioTotal=0,this.totalSamplesReceivedDiff=0;const m=g.config;this.networkDetectionDuration=m.webrtcStatNetworkDetectionDuration,this.networkRecvQualityDiagnostics=m.networkRecvQualityDiagnostics,this.networkRecvQualityDiagnostics&&(this.healedRatioAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.concealedSamplesDiffAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.silentConcealedSamplesDiffAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize),this.totalSamplesReceivedDiffAccumulator=new Wm(m.webrtcHealedRatioExtendedWindowSize))}captureHealedRatioSamples(g,m,f){!g||!m||!f||g.length<=this.networkDetectionDuration||m.length<=this.networkDetectionDuration||f.length<=this.networkDetectionDuration||this.setHealedRatioPerDuration(g,m,f)}getHealedRatioMax(){return this.healedRatioMax}getHealedRatioAvg(){return this.healedRatioDuration?this.healedRatioTotal/this.healedRatioDuration:0}getHealedRatio(){return this.healedRatio}getTotalSamplesReceivedDiff(){return this.totalSamplesReceivedDiff}setHealedRatioPerDuration(g,m,f){const S=-1-this.networkDetectionDuration,v=Math.max((0,Oy.last)(g)-(0,Oy.nth)(g,S),0),C=Math.max((0,Oy.last)(m)-(0,Oy.nth)(m,S),0);this.totalSamplesReceivedDiff=Math.max((0,Oy.last)(f)-(0,Oy.nth)(f,S),0),0!==this.totalSamplesReceivedDiff&&(this.healedRatio=(v-C)/this.totalSamplesReceivedDiff,this.healedRatioDuration++,this.healedRatioTotal+=this.healedRatio,this.healedRatioMax=Math.max(this.healedRatioMax,this.healedRatio),this.networkRecvQualityDiagnostics&&(this.concealedSamplesAccumulator.add((0,Oy.last)(g)),this.silentConcealedSamplesAccumulator.add((0,Oy.last)(m)),this.totalSamplesReceivedAccumulator.add((0,Oy.last)(f)),this.concealedSamplesDiffAccumulator.add(v),this.silentConcealedSamplesDiffAccumulator.add(C),this.totalSamplesReceivedDiffAccumulator.add(this.totalSamplesReceivedDiff),this.healedRatioAccumulator.add(this.healedRatio)))}getDiagnostics(g){return{quality:(0,Oy.last)(g),qualityLevels:g,concealedSamples:this.concealedSamplesAccumulator.items,silentConcealedSamples:this.silentConcealedSamplesAccumulator.items,totalSamplesReceived:this.totalSamplesReceivedAccumulator.items,concealedSamplesDiff:this.concealedSamplesDiffAccumulator.items,silentConcealedSamplesDiff:this.silentConcealedSamplesDiffAccumulator.items,totalSamplesReceivedDiff:this.totalSamplesReceivedDiffAccumulator.items,healedRatio:this.healedRatioAccumulator.items.map((g=>round(g)))}}},ky=class{constructor(g=100){this.minPacketsReceivedToCalculatePacketLossRate=g,this.packetsReceivedForPrevWindow=0,this.packetsLostForPrevWindow=0,this.packetLostRateMax=0,this.totalPacketsLost=0,this.totalPacketsRecv=0,this.packetsLostDuration=0}capturePacketsLostAndPacketsReceived(g,m){this.packetsLostDuration+=je.TIME_INTERVAL.SEC_1,this.totalPacketsRecv=m,this.totalPacketsLost=g,this.calculateMaxLostRateInWindowSize(g,m)}getPacketsLostRateMax(){return this.packetLostRateMax}getNetworkAvgLostRate(){const g=this.totalPacketsLost+this.totalPacketsRecv;return g>0?this.totalPacketsLost/g:0}getAvgPacketsLost(){return this.totalPacketsLost?round(this.totalPacketsLost/this.packetsLostDuration,2):0}calculateMaxLostRateInWindowSize(g,m){const f=m-this.packetsReceivedForPrevWindow;if(f<this.minPacketsReceivedToCalculatePacketLossRate)return;this.packetsReceivedForPrevWindow=m;const S=g-this.packetsLostForPrevWindow;this.packetsLostForPrevWindow=g,this.packetLostRateMax=Math.max(round(S*this.minPacketsReceivedToCalculatePacketLossRate/(S+f),2),this.packetLostRateMax)}},Ly=class{constructor(g){this.configProvider=g,this.audioAnalyzers=new Map,this.jitterBufferDuration=0,this.jitterBufferTotal=0,this.jitterTotal=0,this.jitterDuration=0,this.rttDuration=0,this.rttTotal=0,this.rttMax=0,this.jitterMax=0,this.webrtcAudioPacketLossRate=new ky(g.config.minPacketsReceivedToCalculatePacketLossRate)}captureJitterBuffer(g){this.jitterBufferDuration+=je.TIME_INTERVAL.SEC_1,this.jitterBufferTotal+=g}captureJitter(g){const m=1e3*g;this.jitterTotal+=m,this.jitterMax=Math.max(m,this.jitterMax),this.jitterDuration+=je.TIME_INTERVAL.SEC_1}getJitterAvg(){return this.jitterDuration?round(this.jitterTotal/this.jitterDuration):0}getAvgJitterBuffer(){return this.jitterBufferDuration?Math.round(this.jitterBufferTotal/this.jitterBufferDuration):0}capturePacketsLostAndPacketsReceived(g,m){this.webrtcAudioPacketLossRate.capturePacketsLostAndPacketsReceived(g,m)}getPacketsLostRateMax(){return this.webrtcAudioPacketLossRate.getPacketsLostRateMax()}getNetworkAvgLostRate(){return this.webrtcAudioPacketLossRate.getNetworkAvgLostRate()}getAvgPacketsLost(){return this.webrtcAudioPacketLossRate.getAvgPacketsLost()}captureRtt(g){if(null!==g){const m=parseInt(g);this.rttDuration+=je.TIME_INTERVAL.SEC_1,this.rttTotal+=m,this.rttMax=Math.max(this.rttMax,m)}}getAvgRtt(){return this.rttDuration?round(this.rttTotal/this.rttDuration):0}getMaxRtt(){return this.rttMax}getJitterMax(){return this.jitterMax}updateSendStream(g,m){if(!this.configProvider.config.useAudioAnalyzer)return;const f=this.audioAnalyzers.get(m);f&&(f.dispose(),this.audioAnalyzers.delete(m)),g?.rawStream?.getAudioTracks().length&&this.audioAnalyzers.set(m,new DS(g.rawStream))}getInputLevel(g){const m=this.audioAnalyzers.get(g);return m?.getInputLevel()}},Fy=class{constructor(g,m){this.dropBadBandwidth=g,this.dropGoodBandwidth=m,this.dropDurationCounts={},Object.keys(je.HISTOGRAM_BATCH).forEach((g=>{this.dropDurationCounts[g]=0}))}recordSendBandwidth(g){this.currentDropDuration&&g<this.dropGoodBandwidth||g<this.dropBadBandwidth?this.initiateDrop():this.currentDropDuration&&g>this.dropGoodBandwidth&&this.recoverDrop()}getReport(){const g=shallowClone(this.dropDurationCounts);return this.currentDropDuration&&(g.ongoingDuration=this.currentDropDuration),g}initiateDrop(){this.currentDropDuration?this.currentDropDuration++:this.currentDropDuration=1}recoverDrop(){for(const g of Object.keys(je.HISTOGRAM_BATCH))if(this.currentDropDuration<=je.HISTOGRAM_BATCH[g]){this.dropDurationCounts[g]+=1,this.currentDropDuration=0;break}}},xy=R,Uy=class{constructor(g,m,f,S){this.lowThreshold=g,this.highThreshold=m,this.isLowerBetter=f,this.curInLowerRange=f,this.stateTracker=new Vy(S)}onSample(g,m){let f=this.curInLowerRange;this.curInLowerRange?g>this.highThreshold&&(f=!1):g<this.lowThreshold&&(f=!0);const S=this.stateTracker.onNewState(this.getQuality(f),m);return S!==this.getQuality(this.curInLowerRange)&&(this.curInLowerRange=f),S}getQuality(g){return g===this.isLowerBetter?"Good":"Bad"}},Vy=class{constructor(g){this.sticknessTime=g}onNewState(g,m){return"Good"!==g&&"Bad"!==g?this.curState:0===this.sticknessTime?g:g===this.curState?(this.stickTimerStarted=0,this.curState):("Bad"===this.curState?0===this.stickTimerStarted?this.stickTimerStarted=m:m-this.stickTimerStarted>this.sticknessTime&&(this.curState=g,this.stickTimerStarted=0):(this.curState=g,this.stickTimerStarted=0),this.curState)}},By=class{constructor(g,m,f,S){this.stateProcessor=g,this.windowSize=m,this.extendedWindowSize=f,this.addDiagnosticData=S,this.dataAccumulator=new Wm(f),this.avgAccumulator=new Wm(f)}getLatestSendQuality(g,m,f){if(this.dataAccumulator.add(g),this.dataAccumulator.items.length>=this.windowSize){const g=this.dataAccumulator.items.slice(-this.windowSize),f=(0,xy.mean)(g);return this.addDiagnosticData&&this.avgAccumulator.add(f),this.stateProcessor.onSample(f,m)}return f}getData(){return this.dataAccumulator.items.map((g=>round(g)))}getAggregatedData(){return this.avgAccumulator.items.map((g=>round(g)))}},Hy=class{constructor(g,m,f){this.configProvider=g,this.newStatsApi=m,this.webrtcHealedRatio=f,this.sendAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiffAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.lostDiffAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.totalAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendQualityAccumulator=new Wm(this.configProvider.config.webrtcLossRateExtendedWindowSize),this.sendDiagnosticsEnabled=this.configProvider.config.networkSendQualityDiagnostics,this.recvDiagnosticsEnabled=this.configProvider.config.networkRecvQualityDiagnostics,this.recvQualityAccumulator=new Wm(this.configProvider.config.webrtcHealedRatioExtendedWindowSize);const S=Number(this.configProvider.config.webrtcStatNetworkDetectionHysteresis);this.networkDetectionBadLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionBadLevel)+S/2,this.networkDetectionBadLevelLow=this.networkDetectionBadLevelHigh-S,this.networkDetectionGoodLevelHigh=Number(this.configProvider.config.webrtcStatNetworkDetectionGoodLevel)+S/2,this.networkDetectionGoodLevelLow=this.networkDetectionGoodLevelHigh-S;const v=new Uy(g.config.webrtcJitterLowThreshold,g.config.webrtcJitterHighThreshold,!0,g.config.webrtcJitterSticknessTime),C=new Uy(g.config.webrtcLossRateLowThreshold,g.config.webrtcLossRateHighThreshold,!0,g.config.webrtcLossRateSticknessTime);this.jitterCalculator=new By(v,g.config.webrtcJitterWindowSize,g.config.webrtcJitterExtendedWindowSize,this.sendDiagnosticsEnabled),this.lossRateCalculator=new By(C,g.config.webrtcLossRateWindowSize,g.config.webrtcLossRateExtendedWindowSize,this.sendDiagnosticsEnabled)}calculateNetworkSendQualityLevel(g,m,f,S){if(!g||!m)return{quality:S};if(g.length<2||m.length<2||(0,xy.last)(g)<this.configProvider.config.webrtcMinPacketsSentForNetworkSendQuality)return{quality:S};const v=Date.now(),C=(0,xy.last)(f),_=this.jitterCalculator.getLatestSendQuality(C,v,S),[E,T]=g.slice(-2),[I,b]=m.slice(-2),A=this.getLossRate(T,E,b,I),P=this.lossRateCalculator.getLatestSendQuality(A,v,S),R="Good"===_&&"Good"===P?"Good":"Bad";return this.sendDiagnosticsEnabled&&(this.sendAccumulator.add(T),this.lostAccumulator.add(b),this.sendQualityAccumulator.add(R)),this.sendDiagnosticsEnabled?{quality:R,packetsSend:this.sendAccumulator.items,packetsLost:this.lostAccumulator.items,packetsSendDiff:this.sendDiffAccumulator.items,packetsLostDiff:this.lostDiffAccumulator.items,lossRates:this.lossRateCalculator.getData(),lossRatesAggregated:this.lossRateCalculator.getAggregatedData(),jitter:this.jitterCalculator.getData(),jitterAggregated:this.jitterCalculator.getAggregatedData(),qualityLevels:this.sendQualityAccumulator.items}:{quality:R}}calculateNetworkRecvQualityLevel(g){if(this.newStatsApi){const m=g;return this.calculateNetworkRecvQualityLevelNewStatsApi(m.concealedSamples,m.silentConcealedSamples,m.totalSamplesReceived,m.oldNetworkLevel)}{const m=g;return this.calculateNetworkRecvQualityLevelLegacyStatsApi(m.googDecodingCTN,m.googDecodingPLC,m.oldNetworkLevel)}}calculateNetworkRecvQualityLevelLegacyStatsApi(g,m,f){const S=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!g||!m||g.length<2*S)return{quality:f};let v=g.length-1-S;const C=g[g.length-1];for(;v>=0&&C-g[v]<100*S;)v--;if(v<0)return{quality:f};const _=C-g[v],E=m[m.length-1]-m[v];if(_<=0)return{quality:f};const T=E/_;return{quality:this.getRecvQuality(T,f)}}calculateNetworkRecvQualityLevelNewStatsApi(g,m,f,S){const v=this.configProvider.config.webrtcStatNetworkDetectionDuration;if(!g||g.length<=v||!m||m.length<=v||!f||f.length<=v)return{quality:S};if((0,xy.last)(f)<this.configProvider.config.webrtcMinAudioSamplesRecvForNetworkRecvQuality)return{quality:S};if(0===this.webrtcHealedRatio.getTotalSamplesReceivedDiff())return{quality:S};const C=this.webrtcHealedRatio.getHealedRatio(),_=this.getRecvQuality(C,S);if(this.recvDiagnosticsEnabled){this.recvQualityAccumulator.add(_);return this.webrtcHealedRatio.getDiagnostics(this.recvQualityAccumulator.items)}return{quality:_}}getRecvQuality(g,m){return g<this.networkDetectionGoodLevelLow?"Good":g<this.networkDetectionGoodLevelHigh?"Good"===m?"Good":"Poor":g<this.networkDetectionBadLevelLow?"Poor":g<this.networkDetectionBadLevelHigh?"Bad"===m?"Bad":"Poor":"Bad"}getLossRate(g,m,f,S){const v=g-m,C=f-S,_=v+C;return this.sendDiagnosticsEnabled&&(this.sendDiffAccumulator.add(v),this.lostDiffAccumulator.add(C),this.totalAccumulator.add(_)),_>0?C/_:0}},$y=class{constructor(g){this.configProvider=g,this.qualityLimitationReasonEvents=[]}setQualityLimitationReason(g){this.lastQualityLimitationReason!==g&&this.qualityLimitationReasonEvents.push({event:g,startTime:Date.now(),endTime:Date.now()}),this.qualityLimitationReasonEvents.length>this.configProvider.config.maxStoredQualityLimitationReasonEvents&&this.qualityLimitationReasonEvents.shift(),this.lastQualityLimitationReason=g}getQualityLimitationReasonEvents(){return this.qualityLimitationReasonEvents.reduce(((g,m,f)=>"none"===m.event?g:[...g,{...m,endTime:this.qualityLimitationReasonEvents[f+1]?.startTime??Date.now()}]),[])}},Gy=class{constructor(){this.bitrateData={[je.MEDIA_DIRECTION.SEND]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0,allocateBW:0,allocateBWSamples:0},[je.MEDIA_DIRECTION.RECV]:{lastBytes:0,lastTimestamp:0,maxSample:0,bitrateTotal:0,nSamples:0}}}captureSample(g,m){const f=Date.now()/1e3;if(0!==this.bitrateData[g].lastTimestamp&&m>this.bitrateData[g].lastBytes){const S=f-this.bitrateData[g].lastTimestamp,v=8*(m-this.bitrateData[g].lastBytes)/S;this.onBitrateSample(g,v)}this.bitrateData[g].lastTimestamp=f,this.bitrateData[g].lastBytes=m}getMax(g){return Math.round(this.bitrateData[g].maxSample)}getAvg(g){return 0===this.bitrateData[g].nSamples?0:Math.round(this.bitrateData[g].bitrateTotal/this.bitrateData[g].nSamples)}stopCapture(g){this.bitrateData[g].lastBytes=0,this.bitrateData[g].lastTimestamp=0}onBitrateSample(g,m){m>this.bitrateData[g].maxSample&&(this.bitrateData[g].maxSample=m),this.bitrateData[g].bitrateTotal+=m,this.bitrateData[g].nSamples++}captureAllocateBandwidth(g){if(g){const m=parseInt(g[g.length-1]);this.bitrateData[je.MEDIA_DIRECTION.SEND].allocateBW+=m,this.bitrateData[je.MEDIA_DIRECTION.SEND].allocateBWSamples+=1}}getAllocateBandwidthAvg(){const g=this.bitrateData[je.MEDIA_DIRECTION.SEND].allocateBW,m=this.bitrateData[je.MEDIA_DIRECTION.SEND].allocateBWSamples;if(g>0&&m>0)return Math.floor(g/m)}},jy=class{constructor(g,m){this.maxAppliedCapabilitiesCount=m,this.events=[],this.events.push({eventType:"req",timestamp:Date.now(),capabilities:g.capabilities,isSimulcast:g.isSimulcastEnabled})}setMaxCapabilitiesApplied(g){this.events.push({eventType:"app",timestamp:Date.now(),capabilities:g.capabilities,error:g.error?`${g.error}`:"none"}),this.maxAppliedCapabilitiesCount&&this.events.length>this.maxAppliedCapabilitiesCount+1&&this.events.splice(1,1)}getEvents(){return this.events}},Wy=class{constructor(g,m){this.configProvider=g,this.logger=m,this.resolutionChangeRequestRecords={},this.currentResolutionsByRid={},this.resolutionChangeCounterByRid={},this.events=[],this.errors=[]}setMaxCapabilitesRequested(g){const m=new jy(g,this.configProvider.config.webrtcLastAppliedVideoCapabilitiesCount);this.events.push({causeId:g.causeId,seq:m}),this.recordResolutionChange(g),this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.length>this.configProvider.config.webrtcLastAppliedVideoCapabilitiesSequenceCount&&this.events.shift()}setMaxCapabilitesApplied(g){const m=this.events.find((m=>m.causeId===g.causeId));m?(m.seq.setMaxCapabilitiesApplied(g),g.error&&this.errors.push(m)):this.logger.safe.warn(`Requested capabilities with id ${g.causeId} not found`)}getEvents(){return this.events.map((g=>({causeId:g.causeId,events:g.seq.getEvents()})))}getErrors(){return this.errors.map((g=>({causeId:g.causeId,events:g.seq.getEvents()})))}getResolutionRecords(){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo)return{req:this.resolutionChangeRequestRecords,count:this.resolutionChangeCounterByRid}}recordResolutionChange(g){if(this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo){const m=Object.keys(this.currentResolutionsByRid),getRid=g=>g.rid||"default";[...m,...g.capabilities.map((g=>getRid(g)))].forEach((m=>{const f=g.capabilities.find((g=>getRid(g)===m)),S=this.currentResolutionsByRid[m]||0,v=f?.maxFs||0;if(S===v)return;this.resolutionChangeRequestRecords[m]||(this.resolutionChangeRequestRecords[m]=[],this.resolutionChangeCounterByRid[m]=0);const C=this.resolutionChangeRequestRecords[m].find((g=>g.from===S&&g.to===v));C?C.counter++:this.resolutionChangeRequestRecords[m].push({from:S,to:v,counter:1}),this.currentResolutionsByRid[m]=v,this.resolutionChangeCounterByRid[m]++}))}}},qy=class{constructor(){this.delayCur=[],this.delayTotal=0,this.delayEventCount=0}analyzeDelay(g,m){if(m&&""!==m){this.delayCur.length===g&&this.delayCur.shift();const f=parseInt(m);this.delayCur.push(f),this.delayTotal+=f,this.delayEventCount+=je.TIME_INTERVAL.SEC_1}}getDelayCur(){if(this.delayCur.length>0){const g=this.delayCur.reduce(((g,m)=>g+m))/this.delayCur.length;return g<0?0:g}}getDelayAvg(){if(this.delayEventCount>0&&this.delayTotal>0){const g=this.delayTotal/this.delayEventCount;return g<0?0:g}}},zy=class{constructor(g,m){this.configProvider=g,this.startTime=m,this.recvTotalFreezeDuration=-1,this.recvFreezeDurations=[],this.recvFreezeIsOngoing=!1,this.recvCurrentFreezeDuration=0,this.recvFreezeCount=0,this.receiveFreezeDurationCounts={},this.longestRecvFreezeDuration=0,this.sendCameraFreezeIntervalsCount=0,this.previousInputFrame=0,this.recvCurrentFreezeStartTimestamp=0,this.receiveFreezeDurationTimestamps={},this.finalFreezeIsOngoing=!1,this.finalRecvCurrentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0,Object.keys(je.HISTOGRAM_BATCH).forEach((g=>{this.receiveFreezeDurationCounts[g]=0,this.receiveFreezeDurationTimestamps[g]=[]}))}gatherFreezeData({frameRateDecoded:g,frameRateRecv:m,bytesReceived:f,mediaType:S}){if(g){const v=parseInt(g[g.length-1],10),C=m?.length>0?parseInt(m[m.length-1],10):void 0;void 0!==f&&"ScreenShare"!==S&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&!this.configProvider.config.isRenderingBasedOnRawStatistics&&this.calculateBitrate(f,v),-1===this.recvTotalFreezeDuration&&(this.recvTotalFreezeDuration=0),v>0&&(this.mediaStarted=!0),0!==v&&0!==C||!this.mediaStarted?v>0&&(void 0===C||C>0)&&this.recvFreezeIsOngoing&&this.stopRecvDataGathering(!1):(this.recvFreezeIsOngoing||(this.recvCurrentFreezeStartTimestamp=Date.now()-this.startTime),this.recvFreezeIsOngoing=!0,this.recvCurrentFreezeDuration+=je.TIME_INTERVAL.SEC_1,this.recvTotalFreezeDuration+=je.TIME_INTERVAL.SEC_1)}}getIsRendering(g){return this.recvCurrentFreezeDuration<g&&this.currentLowBitrateDuration<g&&this.mediaStarted}detectCaptureFreeze(g){if(g){const m=parseInt(g[g.length-1],10);this.previousInputFrame>0&&0===m&&(this.sendCameraFreezeIntervalsCount+=1),this.previousInputFrame=m}}getSendCameraFreezeIntervals(){return this.sendCameraFreezeIntervalsCount>0?this.sendCameraFreezeIntervalsCount:void 0}stopRecvDataGathering(g=!0){this.finalFreezeIsOngoing=this.recvFreezeIsOngoing,this.recvFreezeIsOngoing=!1,g&&(this.mediaStarted=!1),this.recvCurrentFreezeDuration>0&&(this.populateLongestRecvFreezeDuration(),this.populateRecvFreezeDurationCounts(),this.recvFreezeDurations.push(this.recvCurrentFreezeDuration),this.recvFreezeCount+=1),this.finalRecvCurrentFreezeDuration=this.recvCurrentFreezeDuration,this.recvCurrentFreezeDuration=0}getRecvFreezeDurationCounts(){return this.recvFreezeCount>0?JSON.stringify(this.receiveFreezeDurationCounts):void 0}getRecvFreezeDurationTimestamps(g){if(0===this.recvFreezeCount)return;const m={};return Object.keys(this.receiveFreezeDurationTimestamps).forEach((f=>{const S=this.receiveFreezeDurationTimestamps[f].length;m[f]=S>g?this.receiveFreezeDurationTimestamps[f].slice(S-g):this.receiveFreezeDurationTimestamps[f]})),JSON.stringify(m)}getRecvFreezeIsOngoing(g){return this.finalRecvCurrentFreezeDuration>=g&&this.finalFreezeIsOngoing}getRecvTotalFreezeDuration(){return this.recvTotalFreezeDuration>=0?this.recvTotalFreezeDuration:void 0}getRecvAvgFreezeDuration(){if(this.recvTotalFreezeDuration>0&&this.recvFreezeCount>0)return this.recvTotalFreezeDuration/this.recvFreezeCount}getLongestRecvFreezeDuration(){return this.longestRecvFreezeDuration>0?this.longestRecvFreezeDuration:void 0}populateRecvFreezeDurationCounts(){for(const g of Object.keys(je.HISTOGRAM_BATCH))if(this.recvCurrentFreezeDuration<=je.HISTOGRAM_BATCH[g]){this.receiveFreezeDurationCounts[g]+=1,this.receiveFreezeDurationTimestamps[g].push(this.recvCurrentFreezeStartTimestamp);break}this.recvCurrentFreezeStartTimestamp=0}populateLongestRecvFreezeDuration(){this.recvCurrentFreezeDuration>this.longestRecvFreezeDuration&&(this.longestRecvFreezeDuration=this.recvCurrentFreezeDuration)}calculateBitrate(g,m){const f=125,S=(g-this.lastBytesRecv)/f;this.lastBytesRecv=g,S<this.configProvider.config.notRenderingLowBitrateThreshold&&m<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}},Ky=class{constructor(){this.mediaData={[je.MEDIA_DIRECTION.SEND]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0},[je.MEDIA_DIRECTION.RECV]:{totalMediaDuration:-1,totalFrameCount:0,mediaStartTimestamp:new Date,mediaStarted:!1,timeSinceLastDecode:0,cameraFrameRate:0}},this.gatheringSendData=!1}captureMediaData(g,m,f){const S=this.mediaData[g];if(g===je.MEDIA_DIRECTION.SEND&&(this.gatheringSendData=!0),m){const g=parseInt(m[m.length-1],10);S.totalFrameCount+=g}if(f){-1===S.totalMediaDuration&&(S.totalMediaDuration=0);const g=parseInt(f[f.length-1],10);S.mediaStarted||g>0&&(S.mediaStarted=!0,S.mediaStartTimestamp=new Date)}S.mediaStarted&&(S.totalMediaDuration+=je.TIME_INTERVAL.SEC_1)}captureFrameRate(g){const m=this.mediaData[je.MEDIA_DIRECTION.SEND];if(g){const f=parseInt(g[g.length-1],10);m.cameraFrameRate+=f}}stopRecvDataGathering(){const g=this.mediaData[je.MEDIA_DIRECTION.RECV],m=(new Date).getTime();g.timeSinceLastDecode=g.totalMediaDuration>0?Math.round((m-g.mediaStartTimestamp.getTime())/1e3):0,g.mediaStarted=!1}isGatheringSendData(){return this.gatheringSendData}stopSendDataGathering(){const g=this.mediaData[je.MEDIA_DIRECTION.SEND],m=new Date;g.timeSinceLastDecode=g.totalMediaDuration>0?Math.round((m.getTime()-g.mediaStartTimestamp.getTime())/1e3):0,this.gatheringSendData=!1,g.mediaStarted=!1}getAvgFrameRate(g){const m=this.mediaData[g];if(m.totalMediaDuration>0&&m.totalFrameCount>0)return m.totalFrameCount/m.totalMediaDuration}getTotalDuration(g){const m=this.mediaData[g];return m.totalMediaDuration>=0?m.totalMediaDuration:void 0}getTimeSinceLastDecode(g){const m=this.mediaData[g];return m.timeSinceLastDecode>0?m.timeSinceLastDecode:void 0}getSendCameraFramerate(){const g=this.mediaData[je.MEDIA_DIRECTION.SEND];if(g.totalMediaDuration>0)return g.cameraFrameRate/g.totalMediaDuration}},Jy=class{constructor(){this.qpData={[je.MEDIA_DIRECTION.SEND]:{frames:0,qpSum:0},[je.MEDIA_DIRECTION.RECV]:{frames:0,qpSum:0}}}captureQpData(g,m,f){const S=this.qpData[g];if(f&&f.length>0){const g=parseInt(f[f.length-1],10);g>0&&(S.frames=g)}if(m){const g=parseInt(m,10);g>0&&(S.qpSum=g)}}getQpAverage(g){const m=this.qpData[g];if(m.qpSum>0&&m.frames>0)return m.qpSum/m.frames}},Yy=class{constructor(){this.resolutionChangedCount=0,this.resDurations={},this.preferredResolutionDurations={},this.preferredResolutions=[]}get resolutionSwitchCount(){return this.resolutionChangedCount}get resolutionDurationRatios(){return this.countResolutionDurationRatio(this.resDurations)}get preferredResolutionDurationRatios(){return this.countResolutionDurationRatio(this.preferredResolutionDurations)}get preferredResolution(){return this.preferredResolutions}captureSample(g){g&&g.width&&g.height&&(this.isResolutionChanged(this.lastResolution,g)&&this.resolutionChanged(g),this.updateResolutionDuration(this.getResolutionKey(g),this.resDurations)),this.lastPreferredResolution&&this.updatePreferredResolutionDurations()}capturePreferredResolution(g,m){const f=this.getResolutionKey(g);this.preferredResolution.includes(f)||(this.preferredResolutions.length>=m&&this.preferredResolutions.shift(),this.preferredResolutions.push(f)),this.isResolutionChanged(this.lastPreferredResolution,g)&&(this.preferredResolutionChanged(g),this.updatePreferredResolutionDurations())}getResolutionKey(g){return`${g.width}x${g.height}`}isResolutionChanged(g,m){return!g||g.width!==m.width||g.height!==m.height}countResolutionDurationRatio(g){const m={};let f=0;for(const m in g)f+=g[m];for(const S in g)m[S]=round(g[S]/f*100,2);return m}updatePreferredResolutionDurations(){this.updateResolutionDuration(this.getResolutionKey(this.lastPreferredResolution),this.preferredResolutionDurations)}updateResolutionDuration(g,m){m[g]||(m[g]=0),m[g]++}preferredResolutionChanged(g){this.lastPreferredResolution=g}resolutionChanged(g){this.lastResolution=g,this.resolutionChangedCount++}},Qy=class{constructor(){this.streamsTimers={}}countRecvStreams(g){const m=`${g}`;this.streamsTimers.hasOwnProperty(m)||(this.streamsTimers[m]=0),this.streamsTimers[m]++}getStreamCounts(){const g={min:void 0,max:void 0,mode:void 0},m=Object.keys(this.streamsTimers).map(Number);return 0===m.length||1===m.length&&0===m[0]||(g.min=Math.min(...m.filter((g=>g>0))),g.max=Math.max(...m),g.mode=m.reduce(((g,m)=>this.streamsTimers[m]>this.streamsTimers[g]?m:g),m[0])),g}},Xy=class{constructor(g){this.configProvider=g,this.subscriptionEvents=[],this.subscriptionCounters={attempted:0,subscribed:0,unsubscribed:0,failed:0}}addSubscriptionEvent(g){switch(this.subscriptionEvents.length>this.configProvider.config.webrtcSubscriptionEventLimit&&this.subscriptionEvents.shift(),this.subscriptionEvents.push(g),g.evt){case 1:this.subscriptionCounters.attempted++;break;case 2:this.subscriptionCounters.subscribed++;break;case 3:this.subscriptionCounters.unsubscribed++;break;case-1:this.subscriptionCounters.failed++}}getSubscriptionEvents(){return this.subscriptionEvents.length>0?{events:this.subscriptionEvents}:void 0}getSubscriptionCounters(){return this.subscriptionEvents.length>0?this.subscriptionCounters:void 0}},Zy=class{constructor(g,m,f,S="Video"){this.startTime=g,this.configProvider=m,this.logger=f,this.mediaType=S,this.subscriptionCounter=0,this.videoFreezeTelemetry=new zy(this.configProvider,this.startTime),this.videoDelayTelemetry=new qy,this.videoSubscriptionEvents=new Xy(this.configProvider),this.videoQPEvents=new Jy,this.videoResolutionTelemetry=new Yy,this.videoGeneralTelemetry=new Ky,this.videoStreamsCounters=new Qy,this.videoBitrate=new Gy,this.videoMaxCapabilities=new Wy(this.configProvider,this.logger),this.videoOvershoot=new gy(this.logger),this.videoQualityLimitations=new $y(this.configProvider),this.videoPacketLostRate=new ky(this.configProvider.config.minPacketsReceivedToCalculatePacketLossRate),this.videoStatsOnSubscribed=new Ty(this.configProvider.config.maxVideoStatsAfterSubscription),this.videoResolutionSwitchTracker=new Qv(this.configProvider.config.diagnostics?.collectionLimits?.numResolutionSwitches),this.timeToFirstFrame=-1,this.timeToFirstFrameSinceSubscriptionStart=-1,this.currentTrackId="",this.recvTotalFreezeDurationMs=0,this.isRenderingEvents=[]}get trackId(){return this.currentTrackId}set trackId(g){this.currentTrackId=g}get isRecvDataGatheringEnabled(){return this.subscriptionCounter>0}startStopRecvDataGathering(g){this.logger.safe.info("Receive data gathering is "+(g?"enabled":"disabled")),g?this.subscriptionCounter++:this.subscriptionCounter--,this.subscriptionCounter<0&&this.logger.safe.error(`Subscription counter should not be less than 0. Actual value is ${this.subscriptionCounter}`),0===this.subscriptionCounter&&this.stopRecvGathering()}stopDataGathering(){this.stopRecvGathering(),this.stopSendGathering()}stopRecvGathering(){this.videoFreezeTelemetry.stopRecvDataGathering(),this.videoGeneralTelemetry.stopRecvDataGathering(),this.videoBitrate.stopCapture(je.MEDIA_DIRECTION.RECV)}isSendGathering(){return this.videoGeneralTelemetry.isGatheringSendData()}stopSendGathering(){this.videoGeneralTelemetry.stopSendDataGathering(),this.videoBitrate.stopCapture(je.MEDIA_DIRECTION.SEND),this.videoOvershoot.flush()}gatherRecvFreezeData(g,m,f){this.videoFreezeTelemetry.gatherFreezeData({frameRateDecoded:g,frameRateRecv:m,bytesReceived:f,mediaType:this.mediaType})}detectCaptureFreeze(g){this.videoFreezeTelemetry.detectCaptureFreeze(g)}getRecvFreezeDurationCounts(){return this.videoFreezeTelemetry.getRecvFreezeDurationCounts()}getRecvFreezeDurationTimestamps(){return this.videoFreezeTelemetry.getRecvFreezeDurationTimestamps(this.configProvider.config.maxVideoFreezeTimestampsInBucket)}getRecvTotalFreezeDuration(){return this.videoFreezeTelemetry.getRecvTotalFreezeDuration()}setRecvTotalFreezeDurationMs(g){this.recvTotalFreezeDurationMs=void 0!==g?this.recvTotalFreezeDurationMs+=g:void 0}analyzeDelay(g,m){this.videoDelayTelemetry.analyzeDelay(g,m)}getDelayCur(){return this.videoDelayTelemetry.getDelayCur()}getDelayAvg(){return this.videoDelayTelemetry.getDelayAvg()}addSubscriptionEvent(g){this.videoSubscriptionEvents.addSubscriptionEvent(g)}getSubscriptionEvents(){return this.videoSubscriptionEvents.getSubscriptionEvents()}getSubscriptionCounters(){return this.videoSubscriptionEvents.getSubscriptionCounters()}captureQpData(g,m,f){this.videoQPEvents.captureQpData(g,m,f)}getQpAverage(g){return this.videoQPEvents.getQpAverage(g)}captureMediaData(g,m,f){this.videoGeneralTelemetry.captureMediaData(g,m,f)}getIsRendering(){const g=this.configProvider.config.notRenderingTimeInterval["Video"===this.mediaType?"video":"sharing"];return this.videoFreezeTelemetry.getIsRendering(g)}captureFrameRate(g){this.videoGeneralTelemetry.captureFrameRate(g)}getTotalDuration(g){return this.videoGeneralTelemetry.getTotalDuration(g)}captureResolutionSample(g){this.videoResolutionTelemetry.captureSample(g)}countRecvStreams(g){this.videoStreamsCounters.countRecvStreams(g)}captureBitrateSample(g,m){this.videoBitrate.captureSample(g,m)}captureAllocateBandwidth(g){this.videoBitrate.captureAllocateBandwidth(g)}capturePreferredResolution(g,m){this.videoResolutionTelemetry.capturePreferredResolution(g,m)}setMaxCapabilitesRequested(g,m=!1){this.videoMaxCapabilities.setMaxCapabilitesRequested(g),m||1===g.capabilities.length&&!g.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(g.capabilities)}setMaxCapabilitesApplied(g,m=!1){this.videoMaxCapabilities.setMaxCapabilitesApplied(g),m||1===g.capabilities.length&&!g.capabilities[0]?.ssrc||this.setMaxCapabilitiesOvershoot(g.capabilities)}getMaxCapabilitiesEvents(){const g=this.videoMaxCapabilities.getEvents();return JSON.stringify(g)}getMaxCapabilitiesResolutionChanges(){const g=this.videoMaxCapabilities.getResolutionRecords();return g?JSON.stringify(g):""}getMaxCapabilitiesErrors(){const g=this.videoMaxCapabilities.getErrors();return g?JSON.stringify(g):""}setCurrentParameters(g,m,f){this.videoOvershoot.setCurrentParams(g,m.height/16*(m.width/16),f)}setMaxCapabilitiesOvershoot(g){this.videoOvershoot.setMaxCapabilities(g)}getOvershootEvents(){let g=this.videoOvershoot.getEvents();return g=g.slice(Math.max(0,g.length-(this.configProvider.config.maxReportedOvershootingEvents+1)),g.length),g.forEach((g=>g.timestamp=g.timestamp-this.startTime)),JSON.stringify(g)}getOvershootTotalDurations(){const g=this.videoOvershoot.getEvents();return g.forEach((g=>g.timestamp=g.timestamp-this.startTime)),JSON.stringify({fs:g.reduce(((g,m)=>"fs"===m.overshootType?g+m.duration:g),0),fps:g.reduce(((g,m)=>"fps"===m.overshootType?g+m.duration:g),0)})}setQualityLimitationReason(g){this.videoQualityLimitations.setQualityLimitationReason(g)}getQualityLimitationReasonEvents(){return this.videoQualityLimitations.getQualityLimitationReasonEvents()}captureTimeToFirstFrame(g,m){-1!==g&&(this.timeToFirstFrame=g,this.timeToFirstFrameSinceSubscriptionStart=m)}getTimeToFirstFrame(){return this.timeToFirstFrame}setIsRendering(g){arrayLimitedPush(this.isRenderingEvents,{isRendering:g,ts:Date.now()},this.configProvider.config.diagnostics.telemetryLimits.numIsRenderingEvents)}capturePacketsLostAndPacketsReceved(g,m){this.videoPacketLostRate.capturePacketsLostAndPacketsReceived(g,m)}setMsi(g){this.msi=g}setLocalMsi(g){this.localMsi=g}prepareCollectingStatsOnSubscribed(g){this.videoStatsOnSubscribed.prepareCollectingStatsOnSubscribed(g)}captureStatsOnSubscribed(g,m){this.videoStatsOnSubscribed.captureStatsOnSubscribed(g,m)}calculateResolutinSwitches(g,m){this.videoResolutionSwitchTracker.captureSample(g,m)}getReport(g,m,f=!1){const S={};if(S[m+"DurationSeconds"]=this.getTotalDuration(g),S[m+"QpAvg"]=this.getQpAverage(g),S[m+"frameRateAvg"]=this.videoGeneralTelemetry.getAvgFrameRate(g),S[m+"bitrateAvg"]=this.videoBitrate.getAvg(g),S[m+"bitrateMax"]=this.videoBitrate.getMax(g),g===je.MEDIA_DIRECTION.SEND)S[m+"DelayCur"]=this.getDelayCur(),S[m+"DelayAvg"]=this.getDelayAvg(),S[m+"TimeSinceLastEncodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(g),S[m+"AllocateBWAvg"]=this.videoBitrate.getAllocateBandwidthAvg(),S[m+"CaptureFramerateAvg"]=this.videoGeneralTelemetry.getSendCameraFramerate(),S[m+"FreezeIntervals"]=this.videoFreezeTelemetry.getSendCameraFreezeIntervals(),S[m+"MaxCapabilities"]=f?"":this.getMaxCapabilitiesEvents(),S[m+"MaxCapabilitiesErrors"]=f?"":this.getMaxCapabilitiesErrors(),S[m+"OvershootEvents"]=this.getOvershootEvents(),S[m+"OvershootDurations"]=this.getOvershootTotalDurations(),S[m+"qualityLimitationReasonEvents"]=JSON.stringify(this.getQualityLimitationReasonEvents()),S[m+"MaxCapabilitiesResolutions"]=this.getMaxCapabilitiesResolutionChanges(),S[m+"ResolutionsSwitches"]=this.videoResolutionSwitchTracker.switches?JSON.stringify(this.videoResolutionSwitchTracker.switches):"";else if(g===je.MEDIA_DIRECTION.RECV){S[m+"TimeSinceLastDecodeStart"]=this.videoGeneralTelemetry.getTimeSinceLastDecode(g),S[m+"FreezeHistogram"]=this.getRecvFreezeDurationCounts(),S[m+"FreezeTimestamps"]=this.getRecvFreezeDurationTimestamps(),S[m+"LongestFreezeDuration"]=this.videoFreezeTelemetry.getLongestRecvFreezeDuration(),S[m+"RecvAvgFreezeDuration"]=this.videoFreezeTelemetry.getRecvAvgFreezeDuration(),S[m+"TotalFreezeDuration"]=this.getRecvTotalFreezeDuration(),S[m+"TotalFreezeDurationMs"]=this.recvTotalFreezeDurationMs,S[m+"OngoingFreeze"]=this.videoFreezeTelemetry.getRecvFreezeIsOngoing(this.configProvider.config.webrtcEndOfCallFreezeThreshold),S[m+"NumResolutionSwitches"]=this.videoResolutionTelemetry.resolutionSwitchCount,S[m+"PreferredResolution"]=this.videoResolutionTelemetry.preferredResolution,S[m+"PreferredResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.preferredResolutionDurationRatios),S[m+"packetsLostRateMax"]=this.videoPacketLostRate.getPacketsLostRateMax(),S[m+"ResolutionDurations"]=JSON.stringify(this.videoResolutionTelemetry.resolutionDurationRatios);const f=this.videoStreamsCounters.getStreamCounts();S[m+"StreamsMin"]=f.min,S[m+"StreamsMax"]=f.max,S[m+"StreamsMode"]=f.mode,S[m+"TimeToFirstFrame"]=this.timeToFirstFrame,S[m+"TimeToFirstFrameSinceSubscriptionStart"]=this.timeToFirstFrameSinceSubscriptionStart,S[m+"LocalMsi"]=this.localMsi,S[m+"Msi"]=this.msi,S[m+"isRenderingEvents"]=JSON.stringify(this.isRenderingEvents),S[m+"statsOnSubscribed"]=JSON.stringify(this.videoStatsOnSubscribed.getStatsOnSubscribed())}return S}},eC=Symbol("mslbase"),tC=Symbol("mslsamples"),iC=class{constructor(g,m){this.logger=g,this.configProvider=m,this.currentLayouts={},this.collectedModalitySessions=[],this.startTimestamp=Date.now()}get collectedSessions(){return this.collectedModalitySessions}get highestFidelitySSRC(){if(!this.currentModalitySession)return;let g;for(const m in this.currentLayouts)g=this.getHigherFidelitySSRC(m,g);return parseInt(g)}processStats(g){const m=Object.values(g.ssrc??{}).filter((g=>g.rid&&g.ssrc&&g.googFrameHeightInput&&this.lastMaxCapabilitiesEvent?.capabilities.some((m=>m.rid===g.rid)))),f=new Map(m.map((g=>[`${g.ssrc}`,g.rid])));for(const g in this.currentLayouts)f.has(g)||this.collectLayout(g);!this.currentModalitySession&&f.size>0&&(this.currentModalitySession={timestamp:Date.now()-this.startTimestamp,duration:0,numLayouts:0,layouts:[]},this.logger.safe.info("Modality session started")),m.forEach((g=>{this.currentLayouts[`${g.ssrc}`]||this.addLayout(g)})),0===f.size&&this.currentModalitySession&&this.collectSession(),m.forEach((g=>this.processLayoutData(g)))}setMaxCapabilities(g,m){if(this.lastMaxCapabilitiesEvent=g,Object.keys(this.currentLayouts).length)for(const f of g.capabilities){const S=Object.values(this.currentLayouts).find((g=>g.rid===f.rid));S&&(m?(arrayLimitedPush(S.fmtp,{...f,timestamp:Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-S.timestamp,causeId:g.causeId},this.configProvider.config.simulcastTelemetryNumFMTP),S.gatherer.setMaxCapabilitesApplied(g)):S.gatherer.setMaxCapabilitesRequested(g),S.gatherer.setMaxCapabilitiesOvershoot([f]))}}finish(){this.logger.safe.info("Finishing statistics gathering");for(const g in this.currentLayouts)this.collectLayout(g);this.currentModalitySession&&this.collectSession()}addLayout(g){const m=`${g.ssrc}`,f=g.rid,S=this.lastMaxCapabilitiesEvent?.capabilities.find((g=>g.rid===f));this.logger.safe.info(`Adding layout for ssrc ${m} rid ${f}`);const v=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,C=new Zy(v,this.configProvider,this.logger.createChild(`Telemetry#${m}`));this.currentLayouts[m]={ssrc:g.ssrc,rid:f,fmtp:[{...S,timestamp:v,causeId:this.lastMaxCapabilitiesEvent?.causeId}],timestamp:v,duration:0,gatherer:C,[eC]:{firCount:g.googFirsReceived,nackCount:g.googNacksReceived,pliCount:g.googPlisReceived,framesEncoded:g.framesEncoded,bytesSent:g.bytesSent,packetsSent:g.packetsSent,packetsLost:g.packetsLost,qpSum:g.qpSum},[tC]:{firCount:[],nackCount:[],pliCount:[],framesEncoded:[],bytesSent:[],packetsSent:[],packetsLost:[],qpSum:[],frameHeightInput:[],frameHeightSent:[],frameRateInput:[],frameRateSent:[]}},C.setMaxCapabilitiesOvershoot([S]),this.currentModalitySession.numLayouts++}processLayoutData(g){const m=`${g.ssrc}`,f=this.currentLayouts[m];this.processMediaStats(f,g),f.gatherer.captureMediaData(je.MEDIA_DIRECTION.SEND,[String(g.googFrameRateSent)],[String(g.framesEncoded)]),f.gatherer.captureFrameRate([String(g.googFrameRateInput)]),f.gatherer.captureQpData(je.MEDIA_DIRECTION.SEND,String(g.qpSum),[String(g.framesEncoded)]),f.gatherer.captureBitrateSample(je.MEDIA_DIRECTION.SEND,g.bytesSent),f.gatherer.detectCaptureFreeze([String(g.googFrameRateInput)]),f.gatherer.setCurrentParameters(g.ssrc,{width:g.googFrameWidthSent,height:g.googFrameHeightSent},g.googFrameRateSent)}processMediaStats(g,m){const f=g[eC],S=m.googFirsReceived-f.firCount,v=m.googNacksReceived-f.nackCount,C=m.googPlisReceived-f.pliCount,_=m.framesEncoded-f.framesEncoded,E=m.bytesSent-f.bytesSent,T=m.packetsSent-f.packetsSent,I=m.packetsLost-f.packetsLost,b=m.qpSum-f.qpSum,A=g[tC],P=this.configProvider.config.webrtcStatStoredRecordsNumber;arrayLimitedPush(A.firCount,S,P),arrayLimitedPush(A.nackCount,v,P),arrayLimitedPush(A.pliCount,C,P),arrayLimitedPush(A.framesEncoded,_,P),arrayLimitedPush(A.bytesSent,E,P),arrayLimitedPush(A.packetsSent,T,P),arrayLimitedPush(A.packetsLost,I,P),arrayLimitedPush(A.qpSum,b,P),arrayLimitedPush(A.frameHeightInput,m.googFrameHeightInput,P),arrayLimitedPush(A.frameHeightSent,m.googFrameHeightSent,P),arrayLimitedPush(A.frameRateInput,m.googFrameRateInput,P),arrayLimitedPush(A.frameRateSent,m.googFrameRateSent,P)}collectLayout(g){this.logger.safe.info(`Collecting layout for ssrc ${g}`),this.currentLayouts[g].duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp-this.currentLayouts[g].timestamp,this.currentLayouts[g].gatherer.isSendGathering()&&this.currentLayouts[g].gatherer.stopSendGathering();const m=this.currentLayouts[g].gatherer.getReport(je.MEDIA_DIRECTION.SEND,"",!1);for(const f in m)this.currentLayouts[g][f]=m[f];for(const m in this.currentLayouts[g][tC])this.currentLayouts[g][m]=sampleseries(this.currentLayouts[g][tC][m],(g=>g));delete this.currentLayouts[g].gatherer,arrayLimitedPush(this.currentModalitySession.layouts,this.currentLayouts[g],this.configProvider.config.simulcastTelemetryLayoutsPerSession),delete this.currentLayouts[g]}collectSession(){this.logger.safe.info("Collecting session");for(const g in this.currentLayouts)this.collectLayout(g);this.currentModalitySession.duration=Date.now()-this.startTimestamp-this.currentModalitySession.timestamp,arrayLimitedPush(this.collectedModalitySessions,this.currentModalitySession,this.configProvider.config.simulcastTelemetryNumModalitySessions),this.currentModalitySession=void 0,this.lastMaxCapabilitiesEvent=void 0}getHigherFidelitySSRC(g,m){if(!g||!m)return g||m;const[f]=this.currentLayouts[g].fmtp.slice(-1),[S]=this.currentLayouts[m].fmtp.slice(-1);return(f?.maxMbps??0)>0&&(S?.maxMbps??0)>0?f.maxMbps>S.maxMbps?g:m:g||m}},nC=["googFrameHeightReceived","googFrameWidthReceived","googFrameHeightSent","googFrameWidthSent","googFrameRateInput","googFrameRateSent","googNacksSent","googNacksReceived","googPlisSent","googPlisReceived","googFirsSent","googFirsReceived","framesDecoded","googFrameRateDecoded","googFrameRateReceived","framesEncoded","packetsLost","packetsSent","packetsReceived","bytesReceived","bytesSent","googEncodeUsagePercent","audioInputLevel","audioOutputLevel","googDecodingCTN","googDecodingPLC","keyFramesEncoded","keyFramesDecoded","googRtt","concealedSamples","silentConcealedSamples","totalSamplesReceived","healedRatio","jitter","googJitterBufferMs","qpSum","fecPacketsReceived","fecPacketsDiscarded","fecPacketsSent","packetsDiscarded","pushCount","pushErrCount","pullCount","pullErrCount"],rC=["bytesSent","bytesReceived","googRtt","packetsSent","requestsSent","consentRequestsSent","responsesSent","requestsReceived","responsesReceived"],sC=["googAvailableReceiveBandwidth","googAvailableSendBandwidth","googTransmitBitrate"];function catchStatsErrors(g,m,f){const S=f.value;f.value=function(...g){try{return S.apply(this,g)}catch(g){this.processStatsError(m,g)}}}var aC=10,oC=class{constructor(g,m,f,S,v,C){this.logger=g,this.sessionInfo=m,this.configProvider=f,this.mediaManager=S,this.multiparty=v,this.newStatsApi=C,this.statsErrors=[],this.subscribedTrackIds=[],this.iceCandidateErrors=[],this.terminated=!1,this.hwSilent=!1,this.isSpeaking=!1,this.networkSendLevel={quality:"Good"},this.networkRecvLevel={quality:"Good"},this.audioTelemetry=new Ly(this.configProvider),this.cameraOpenResolution={width:0,height:0},this.streamSenderStarted={},this.totalVideoControlMessages=0,this.outOfOrderVideoControlMessages=0,this.subscribedTrackSsrc=[],this.multiViewVideoTelemetry={},this.h264AvailableProfiles=[],this.timeToFirstFrame={},this.timeToFirstFrameSinceSubscriptionStart={},this.missedInitialPreferredResolution={},this.MSIDs=new Set,this.MSIDsPairs={},this.timerTrackerManager=new kS(this.configProvider.config.enableTimerTracker),this.extensions={WebRTCStats:{},AudioTransportRecvBitrate:0,AudioTransportSendBitrate:0,AudioPayloadSendBitrate:0,AudioPayloadRecvBitrate:0,VideoPayloadSendBitrate:0,VideoPayloadRecvBitrate:0,TimerAudioTransportRecvBitrate:0,TimerAudioTransportSendBitrate:0,TimerAudioPayloadRecvBitrate:0,TimerAudioPayloadSendBitrate:0,TimerVideoPayloadRecvBitrate:0,TimerVideoPayloadSendBitrate:0,StartTime:Date.now(),EndTime:Date.now(),Audio_recv_jitterBufferAvgSize:0,Audio_recv_jitterMax:0,Audio_recv_jitterAvg:0,Audio_send_rttAvg:0,Audio_send_rttMax:0,MaxSessionBandwidth:0,Video_recv_MSIDs:[],CallSetupTimeTracker:"",Audio_send_presentationUserAPIDuration:"",Audio_send_presentationDuration:""},this.report={type:"WebRtcMediaStats",data:{Extensions:this.extensions}},this.lastSSRCs=new Map,this.videoTelemetry=new Zy(this.extensions.StartTime,this.configProvider,this.logger.createChild("Video"),"Video"),this.sharingTelemetry=new Zy(this.extensions.StartTime,this.configProvider,this.logger.createChild("Sharing"),"ScreenShare"),this.dataTelemetry=new ss,this.bandwidthTelemetry=new Fy(this.configProvider.config.webrtcBWJumpLowerLimit,this.configProvider.config.webrtcBWJumpUpperLimit),this.stabilizationTelemetry=new Iy(this.configProvider.config.uplinkBWStabilizationSlidingWindowSize,this.configProvider.config.uplinkBWStabilizationMaxDeviation,this.configProvider.config.uplinkBWStabilizationMinBandwidth,hasSendDirectionality),this.storedRecordsNumber=Number(this.configProvider.config.webrtcStatStoredRecordsNumber),this.hwSilentDetectionDuration=Number(this.configProvider.config.webrtcStatHwSilentDetectionDuration),this.hwSilentDetectionLevel=Number(this.configProvider.config.webrtcStatHwSilentDetectionLevel),this.audioHealedRatioTelemetry=new Ny(this.configProvider),this.networkQualityTelemetry=new Hy(this.configProvider,this.newStatsApi,this.audioHealedRatioTelemetry),this.speakingWhileMutedBadDuration=Number(this.configProvider.config.webrtcSpeakingWhileMutedBadDuration),this.speakingWhileMutedDetectionLevel=Number(this.configProvider.config.webrtcSpeakingWhileMutedDetectionLevel),this.videoDelayTimePeriod=this.configProvider.config.webrtcVideoDelayThreshold,this.maxStoredPreferredResolutions=this.configProvider.config.maxStoredPreferredResolutionCount,this.simulcastVideo=new iC(this.logger.createChild("simulcastVideo"),this.configProvider),this.simulcastSharing=new iC(this.logger.createChild("simulcastSharing"),this.configProvider)}get currentVideoRecvTrackId(){return this.extensions.WebRTCStats.ssrc_video_recv?.googTrackId}get currentSharingRecvTrackId(){return this.extensions.WebRTCStats.ssrc_sharing_recv?.googTrackId}get isMultiViewVideoTelemetry(){return Object.getOwnPropertyNames(this.multiViewVideoTelemetry).length>0}onDeviceEvent(g){if("stream_acquired"===g.eventType){const m=g.payload;"Video"===m.mediaType&&(this.cameraOpenResolution=m.resolution)}}onMaxCapabilitiesRequested(g){(g.modality===je.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesRequested(g);(g.modality===je.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(g,!1)}onMaxCapabilitiesApplied(g){(g.modality===je.MODALITY.video?this.videoTelemetry:this.sharingTelemetry).setMaxCapabilitesApplied(g);(g.modality===je.MODALITY.video?this.simulcastVideo:this.simulcastSharing).setMaxCapabilities(g,!0)}setSubscribedTrackIds(g){this.subscribedTrackIds=g||[]}setSubscribedTrackSsrc(g){this.subscribedTrackSsrc=g||[]}addSubscriptionEvent(g,m,f,S,v,C,_){const E={evt:g,ts:Date.now()-this.extensions.StartTime,msi:f,localMsi:S,duration:C};v&&(E.error=stringifyObject(v));const T=this.getHandlerForModality(m);if(T.addSubscriptionEvent(E),_&&this.setMSIDsPair(f,S,_),1===g||3===g){const m=1===g;T.startStopRecvDataGathering(m)}2===g&&T.prepareCollectingStatsOnSubscribed(f)}setMSIDsPair(g,m,f){const S=`ssrc_${f.replace(/\D/g,"")}_recv`;this.MSIDsPairs[S]={msi:g,localMsi:m}}getHandlerForModality(g){switch(g){case je.MODALITY.video:return this.videoTelemetry;case je.MODALITY.sharing:return this.sharingTelemetry;default:throw new Error(`Handler not found for modality: ${g}`)}}setTerminated(){this.extensions.EndTime=(new Date).getTime(),this.terminated=!0}startWaitingForStreamStart(g){this.streamStartDetection||this.sessionInfo.setOfferedModalities(g),this.streamStartDetection=!0}recordDataChannelProtocolEvent(g){this.dataTelemetry.recordDataChannelProtocolEvent(g)}setSessionDataChannelState(g){this.dataTelemetry.setSessionDataChannelState(g)}recordDataChannelError(g){this.dataTelemetry.recordDataChannelError(g)}processStatsDict(g){if(this.processSimulcastStats(g),this.constructWebRtcReportForSingleStream(this.extensions.WebRTCStats,g),this.streamStartDetection&&(this.setStartTime(this.sessionInfo.offeredModalities)||this.terminated)&&(this.streamStartDetection=!1),Object.keys(this.missedInitialPreferredResolution).length>0&&(this.currentVideoRecvTrackId||this.currentSharingRecvTrackId)&&this.setMissedInitialPreferredResolution(),this.constructWebRTCDataReport(this.extensions.WebRTCStats,g),this.calculateHwSilentState(),this.calculateSpeakingState(),this.setHealedRatioSamples(),this.calculateNetworkRecvQualityLevel(),this.calculateNetworkSendQualityLevel(),this.sessionInfo.activeModalities&&(this.processBandwidthStats(),this.processAudioStats(),this.processVideoStatsRecv(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_recv,!0),this.processVideoStatsSend(this.videoTelemetry,this.extensions.WebRTCStats.ssrc_video_send),this.processSharingStats(),this.processStreamsCounters()),this.configProvider.config.enableMultiViewStats){const m=this.extensions.WebRTCStats[je.MULTIPLE_RECV_STREAMS]?this.extensions.WebRTCStats[je.MULTIPLE_RECV_STREAMS]:{};this.constructWebRtcReportForMultipleStreams(m,g);for(const g of Object.keys(m)){const f=m[g];this.processVideoStatsRecv(this.multiViewVideoTelemetry[g],f)}this.extensions.WebRTCStats[je.MULTIPLE_RECV_STREAMS]=m}this.extensions.WebRTCStats.statsErrors=JSON.stringify(this.statsErrors)}setTimeToFirstFrame(g,m,f){f in this.timeToFirstFrame||(this.timeToFirstFrame[f]=g,this.timeToFirstFrameSinceSubscriptionStart[f]=m)}getCurrentTimeToFirstFrame(g){return this.timeToFirstFrame[g]?this.timeToFirstFrame[g]:-1}getCurrentTimeToFirstFrameSinceSubscriptionStart(g){return this.timeToFirstFrameSinceSubscriptionStart[g]?this.timeToFirstFrameSinceSubscriptionStart[g]:-1}getVideoTelemetryBySsrc(g){let m;return this.extensions.WebRTCStats.ssrc_video_recv&&this.extensions.WebRTCStats.ssrc_video_recv.id===g?m=this.videoTelemetry:this.extensions.WebRTCStats.ssrc_sharing_recv&&this.extensions.WebRTCStats.ssrc_sharing_recv.id===g?m=this.sharingTelemetry:this.isMultiViewVideoTelemetry&&(m=this.multiViewVideoTelemetry[g]),m}getIsRendering(g){const m=this.getVideoTelemetryBySsrc(g);return m?m.getIsRendering():void 0}setFreezeDuration(g,m){for(const f of Object.keys(this.multiViewVideoTelemetry))this.multiViewVideoTelemetry[f].trackId===m&&this.isSubscribed(m)&&this.multiViewVideoTelemetry[f].setRecvTotalFreezeDurationMs(g);this.currentSharingRecvTrackId===m&&this.isSubscribed(m)&&this.sharingTelemetry.setRecvTotalFreezeDurationMs(g),this.currentVideoRecvTrackId===m&&this.isSubscribed(m)&&this.videoTelemetry.setRecvTotalFreezeDurationMs(g)}addVideoControlMessage(g){this.totalVideoControlMessages++,g&&this.outOfOrderVideoControlMessages++}setStreamSenderStarted(g,m){this.streamSenderStarted[g]=m}addReportedReceiveBandwidth(g){this.limitCaptureAmount(this.extensions,"ReportedReceiveBandwidth",g)}setHealedRatioSamples(){this.audioHealedRatioTelemetry.captureHealedRatioSamples(this.extensions?.WebRTCStats?.ssrc_audio_recv?.concealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.silentConcealedSamples,this.extensions?.WebRTCStats?.ssrc_audio_recv?.totalSamplesReceived)}processSimulcastStats(g){this.simulcastVideo.processStats(g),this.simulcastSharing.processStats(g)}processBandwidthStats(){const g=this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth;if(g){const m=this.streamSenderStarted.Video||this.streamSenderStarted.ScreenShare;this.bandwidthTelemetry.recordSendBandwidth(g[g.length-1]),this.stabilizationTelemetry.processBandwidth(parseInt(g[g.length-1]),this.sessionInfo.activeModalities,m)}}processAudioStats(){if(this.extensions.WebRTCStats.ssrc_audio_send&&this.limitCaptureAmount(this.extensions,"Audio_send_RawInputVolume",this.audioTelemetry.getInputLevel("Audio")),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.googJitterBufferMs&&this.audioTelemetry.captureJitterBuffer((0,Dy.last)(this.extensions.WebRTCStats.ssrc_audio_recv.googJitterBufferMs)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_audio_recv?.packetsReceived&&this.audioTelemetry.capturePacketsLostAndPacketsReceived((0,Dy.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsLost),(0,Dy.last)(this.extensions.WebRTCStats.ssrc_audio_recv.packetsReceived)),void 0!==this.extensions.WebRTCStats.ssrc_audio_recv?.jitter&&this.audioTelemetry.captureJitter((0,Dy.last)(this.extensions.WebRTCStats.ssrc_audio_recv.jitter)),this.extensions.WebRTCStats.ssrc_audio_send?.googRtt){const g=this.extensions.WebRTCStats.ssrc_audio_send.googRtt;this.audioTelemetry.captureRtt(g[g.length-1])}}stopGatheringIfNeeded(g,m,f,S){const v=`${m}${f}`;S!==this.lastSSRCs.get(v)&&(this.lastSSRCs.set(v,S),m===je.MEDIA_DIRECTION.SEND?g.stopSendGathering():g.stopRecvGathering())}processVideoStatsSend(g,m){m&&hasSendDirectionality(this.sessionInfo.activeModalities.video)?(this.stopGatheringIfNeeded(g,je.MEDIA_DIRECTION.SEND,"Video",m.ssrc),g.captureMediaData(je.MEDIA_DIRECTION.SEND,m.googFrameRateSent,m.framesEncoded),g.captureFrameRate(m.googFrameRateInput),g.analyzeDelay(this.videoDelayTimePeriod,m.googAvgEncodeMs),g.captureQpData(je.MEDIA_DIRECTION.SEND,m.qpSum,m.framesEncoded),g.captureBitrateSample(je.MEDIA_DIRECTION.SEND,this.getLastSampleInt(m.bytesSent)),g.detectCaptureFreeze(m.googFrameRateInput),g.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),g.setCurrentParameters(parseInt(m.ssrc),{width:this.getLastSampleInt(m.googFrameWidthSent),height:this.getLastSampleInt(m.googFrameHeightSent)},this.getLastSampleInt(m.googFrameRateSent)),g.setQualityLimitationReason(m.qualityLimitationReason),this.configProvider.config.specCompliantSimulcast?.collectResolutionInfo&&g.calculateResolutinSwitches(this.getLastSampleInt(m.googFrameWidthSent),this.getLastSampleInt(m.googFrameHeightSent))):g.isSendGathering()&&(g.stopSendGathering(),this.lastSSRCs.delete(`${je.MEDIA_DIRECTION.SEND}Video`))}processVideoStatsRecv(g,m,f=!1){m&&hasReceiveDirectionality(this.sessionInfo.activeModalities.video)&&this.videoTelemetry.isRecvDataGatheringEnabled?(f&&this.stopGatheringIfNeeded(g,je.MEDIA_DIRECTION.RECV,"Video",m.ssrc),g.trackId=m.googTrackId,g.gatherRecvFreezeData(m.googFrameRateDecoded,m.googFrameRateReceived,this.getLastSampleInt(m.bytesReceived)),g.captureMediaData(je.MEDIA_DIRECTION.RECV,m.googFrameRateReceived,m.googFrameRateDecoded),g.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(m.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(m.googTrackId)),g.captureQpData(je.MEDIA_DIRECTION.RECV,m.qpSum,m.framesDecoded),g.captureBitrateSample(je.MEDIA_DIRECTION.RECV,this.getLastSampleInt(m.bytesReceived)),g.captureResolutionSample({width:this.getLastSampleInt(m.googFrameWidthReceived),height:this.getLastSampleInt(m.googFrameHeightReceived)}),this.extensions.WebRTCStats.ssrc_video_recv?.packetsLost&&this.extensions.WebRTCStats.ssrc_video_recv?.packetsReceived&&this.videoTelemetry.capturePacketsLostAndPacketsReceved((0,Dy.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsLost),(0,Dy.last)(this.extensions.WebRTCStats.ssrc_video_recv.packetsReceived)),g.captureStatsOnSubscribed(this.getLastSampleInt(m.framesDecoded),this.getLastSampleInt(m.bytesReceived))):f&&this.lastSSRCs.delete(`${je.MEDIA_DIRECTION.RECV}Video`)}processSharingStats(){const g=this.extensions.WebRTCStats.ssrc_sharing_send,m=this.extensions.WebRTCStats.ssrc_sharing_recv;g&&hasSendDirectionality(this.sessionInfo.activeModalities.sharing)?(this.stopGatheringIfNeeded(this.sharingTelemetry,je.MEDIA_DIRECTION.SEND,"Sharing",g.ssrc),this.sharingTelemetry.captureMediaData(je.MEDIA_DIRECTION.SEND,g.googFrameRateSent,g.framesEncoded),this.sharingTelemetry.captureFrameRate(g.googFrameRateInput),this.sharingTelemetry.analyzeDelay(this.videoDelayTimePeriod,g.googAvgEncodeMs),this.sharingTelemetry.captureQpData(je.MEDIA_DIRECTION.SEND,g.qpSum,g.framesEncoded),this.sharingTelemetry.captureBitrateSample(je.MEDIA_DIRECTION.SEND,this.getLastSampleInt(g.bytesSent)),this.sharingTelemetry.detectCaptureFreeze(g.googFrameRateInput),this.sharingTelemetry.captureAllocateBandwidth(this.extensions.WebRTCStats.bweStat?.googAvailableSendBandwidth),this.sharingTelemetry.setCurrentParameters(parseInt(g.ssrc),{width:this.getLastSampleInt(g.googFrameWidthSent),height:this.getLastSampleInt(g.googFrameHeightSent)},this.getLastSampleInt(g.googFrameRateSent)),this.limitCaptureAmount(this.extensions,"Sharing_send_RawInputVolume",this.audioTelemetry.getInputLevel("ScreenShare"))):this.sharingTelemetry.isSendGathering()&&(this.sharingTelemetry.stopSendGathering(),this.lastSSRCs.delete(`${je.MEDIA_DIRECTION.SEND}Sharing`)),m&&hasReceiveDirectionality(this.sessionInfo.activeModalities.sharing)&&this.sharingTelemetry.isRecvDataGatheringEnabled?(this.stopGatheringIfNeeded(this.sharingTelemetry,je.MEDIA_DIRECTION.RECV,"Sharing",m.ssrc),this.sharingTelemetry.trackId=m.googTrackId,this.sharingTelemetry.gatherRecvFreezeData(m.googFrameRateDecoded,m.googFrameRateReceived),this.sharingTelemetry.captureMediaData(je.MEDIA_DIRECTION.RECV,m.googFrameRateReceived,m.googFrameRateDecoded),this.sharingTelemetry.captureTimeToFirstFrame(this.getCurrentTimeToFirstFrame(m.googTrackId),this.getCurrentTimeToFirstFrameSinceSubscriptionStart(m.googTrackId)),this.sharingTelemetry.captureQpData(je.MEDIA_DIRECTION.RECV,m.qpSum,m.framesDecoded),this.sharingTelemetry.captureBitrateSample(je.MEDIA_DIRECTION.RECV,this.getLastSampleInt(m.bytesReceived)),this.sharingTelemetry.captureResolutionSample({width:this.getLastSampleInt(m.googFrameWidthReceived),height:this.getLastSampleInt(m.googFrameHeightReceived)}),this.sharingTelemetry.captureStatsOnSubscribed(this.getLastSampleInt(m.framesDecoded),this.getLastSampleInt(m.bytesReceived))):this.lastSSRCs.delete(`${je.MEDIA_DIRECTION.RECV}Sharing`)}processStreamsCounters(){const g=this.extensions.WebRTCStats.recvCounters;g&&(this.videoTelemetry.countRecvStreams(g[je.MODALITY.video]),this.sharingTelemetry.countRecvStreams(g[je.MODALITY.sharing]))}setMissedInitialPreferredResolution(){forOwn(this.missedInitialPreferredResolution,((g,m)=>{this.setPreferredResolution(m,g)})),this.missedInitialPreferredResolution={}}setPreferredResolution(g,m,f){if((f===je.MEDIA_TYPE.video&&!this.currentVideoRecvTrackId||f===je.MEDIA_TYPE.sharing&&!this.currentSharingRecvTrackId)&&(this.missedInitialPreferredResolution[g]=m),this.currentVideoRecvTrackId===g&&this.videoTelemetry.capturePreferredResolution(m,this.maxStoredPreferredResolutions),this.currentSharingRecvTrackId===g&&this.sharingTelemetry.capturePreferredResolution(m,this.maxStoredPreferredResolutions),this.isMultiViewVideoTelemetry){const f=this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(g)];f&&f.capturePreferredResolution(m,this.maxStoredPreferredResolutions)}}setIsRendering(g,m,f){m===je.MEDIA_TYPE.video&&this.videoTelemetry.setIsRendering(g),m===je.MEDIA_TYPE.sharing&&this.sharingTelemetry.setIsRendering(g),this.isMultiViewVideoTelemetry&&this.multiViewVideoTelemetry[this.getSsrcIdFromMultipleVideoStream(f)]?.setIsRendering(g)}setReportedSendBandwidth(g){this.extensions.ReportedSendBWMax||this.extensions.ReportedSendBWMin?g>this.extensions.ReportedSendBWMax?this.extensions.ReportedSendBWMax=g:g<this.extensions.ReportedSendBWMin&&(this.extensions.ReportedSendBWMin=g):(this.extensions.ReportedSendBWMax=g,this.extensions.ReportedSendBWMin=g)}setMaxSessionBandwidth(g){this.extensions.MaxSessionBandwidth=g}isSubscribed(g,m){let f=this.subscribedTrackIds.some((m=>m===g));return!f&&this.configProvider.config.subscribeToSsrcForVideo&&(f=this.subscribedTrackSsrc.some((g=>g===`${m}`))),f||!this.multiparty&&this.configProvider.config.subscribeToSsrcForVideo}getReport(g=!1,m=!1){try{m&&this.resetPairValues(),g||(this.videoTelemetry.stopDataGathering(),this.sharingTelemetry.stopDataGathering());const f=this.videoTelemetry.getTotalDuration(je.MEDIA_DIRECTION.RECV),S=this.videoTelemetry.getTotalDuration(je.MEDIA_DIRECTION.SEND),v=this.sharingTelemetry.getTotalDuration(je.MEDIA_DIRECTION.RECV),C=this.sharingTelemetry.getTotalDuration(je.MEDIA_DIRECTION.SEND);if(f>=0&&(forOwn(this.videoTelemetry.getReport(je.MEDIA_DIRECTION.RECV,"Video_recv_",m),((g,m)=>this.extensions[m]=g)),!isEmpty(this.multiViewVideoTelemetry))){const g=[];for(const f of Object.keys(this.multiViewVideoTelemetry)){const S={id:f};forOwn(this.multiViewVideoTelemetry[f].getReport(je.MEDIA_DIRECTION.RECV,"Video",m),((g,m)=>{void 0!==g&&(S[m]=g)})),g.push(S)}this.extensions[je.MULTIPLE_RECV_STREAMS]=JSON.stringify(g)}v>=0&&forOwn(this.sharingTelemetry.getReport(je.MEDIA_DIRECTION.RECV,"Sharing_recv_",m),((g,m)=>this.extensions[m]=g)),S>=0&&(forOwn(this.videoTelemetry.getReport(je.MEDIA_DIRECTION.SEND,"Video_send_",m),((g,m)=>this.extensions[m]=g)),this.extensions.Bandwidth_jumpsHistogram=JSON.stringify(this.bandwidthTelemetry.getReport()),this.extensions.Bandwidth_uplinkStabilizationTime=JSON.stringify(this.stabilizationTelemetry.getReport(!0)),this.extensions.Video_send_CameraOpenWidth=this.cameraOpenResolution.width,this.extensions.Video_send_CameraOpenHeight=this.cameraOpenResolution.height),C>=0&&forOwn(this.sharingTelemetry.getReport(je.MEDIA_DIRECTION.SEND,"Sharing_send_",m),((g,m)=>this.extensions[m]=g)),forOwn(this.dataTelemetry.getReport("Data_"),((g,m)=>this.extensions[m]=g)),g||m||(this.simulcastVideo.finish(),this.extensions.Video_send_Simulcast=JSON.stringify(this.simulcastVideo.collectedSessions),this.simulcastSharing.finish(),this.extensions.Sharing_send_Simulcast=JSON.stringify(this.simulcastSharing.collectedSessions)),this.iceCandidateErrors.length>0&&(this.extensions.iceCandidateErrors=JSON.stringify(this.iceCandidateErrors)),this.extensions.Audio_recv_jitterBufferAvgSize=this.audioTelemetry.getAvgJitterBuffer(),this.extensions.Audio_recv_packetsLostRateMax=this.audioTelemetry.getPacketsLostRateMax(),this.extensions.Audio_recv_networkAvgLossRate=this.audioTelemetry.getNetworkAvgLostRate(),this.extensions.Audio_recv_jitterMax=this.audioTelemetry.getJitterMax(),this.extensions.Audio_recv_jitterAvg=this.audioTelemetry.getJitterAvg(),this.extensions.Video_SubscriptionEvents=m?"":JSON.stringify(this.videoTelemetry.getSubscriptionEvents()),this.extensions.Video_SubscriptionCounters=m?"":JSON.stringify(this.videoTelemetry.getSubscriptionCounters()),this.extensions.Sharing_SubscriptionEvents=m?"":JSON.stringify(this.sharingTelemetry.getSubscriptionEvents()),this.extensions.Sharing_SubscriptionCounters=m?"":JSON.stringify(this.sharingTelemetry.getSubscriptionCounters()),this.extensions.Audio_recv_healedRatioMax=this.audioHealedRatioTelemetry.getHealedRatioMax(),this.extensions.Audio_recv_healedRatioAvg=this.audioHealedRatioTelemetry.getHealedRatioAvg(),this.extensions.Audio_recv_packetsLostAvg=this.audioTelemetry.getAvgPacketsLost(),this.extensions.Audio_send_rttAvg=this.audioTelemetry.getAvgRtt(),this.extensions.Audio_send_rttMax=this.audioTelemetry.getMaxRtt(),this.extensions.CallSetupTimeTracker=JSON.stringify(this.timerTrackerManager.getReport());for(const g of Object.keys(this.extensions))void 0===this.extensions[g]&&delete this.extensions[g];delete this.extensions.WebRTCStats[je.MULTIPLE_RECV_STREAMS],this.sessionInfo.fillExtensionInfo(this.extensions);return Object.keys(this.extensions.WebRTCStats).length>0&&!this.extensions.WebRTCStats.hasStatsError&&this.calculateAverages(),this.extensions.H264_available_profiles=this.h264AvailableProfiles.join(),this.extensions.Video_recv_MSIDs=Array.from(this.MSIDs),this.totalVideoControlMessages>0&&(this.extensions.totalVideoControlMessages=this.totalVideoControlMessages,this.extensions.outOfOrderVideoControlMessages=this.outOfOrderVideoControlMessages),deepClone(this.report)}catch(g){throw this.processStatsError("Report",g),{error:g,partialReport:deepClone(this.report)}}}getAudioHwSilent(){return this.hwSilent}getSpeakingState(){return this.isSpeaking}getNetworkSendLevel(){return this.networkSendLevel}getNetworkRecvLevel(){return this.networkRecvLevel}addIceCandidateError(g){this.iceCandidateErrors.push(g)}clearIceCandidateErrors(){this.iceCandidateErrors=[]}addH264AvailableProfiles(g){this.h264AvailableProfiles=[...new Set(this.h264AvailableProfiles.concat(g))]}updateSendStream(g,m){this.audioTelemetry.updateSendStream(g,m)}getTimerTracker(g,m){return this.timerTrackerManager.getTimerTracker(g,m)}resetPairValues(){Object.keys(this.extensions.WebRTCStats).forEach((g=>{delete this.extensions.WebRTCStats[g].pair}))}limitCaptureAmount(g,m,f){void 0!==f&&(g[m]=Array.isArray(g[m])?g[m]:[],g[m].push(f),g[m].length>this.storedRecordsNumber&&g[m].shift())}setStartTime(g){const m=this.extensions.WebRTCStats;if(!m.ssrc_audio_send||!m.ssrc_audio_recv)return!1;const setupCounter=(g,m)=>!g||m&&-1===m?m:(new Date).getTime();return this.extensions.TimerAudioPayloadRecvBitrate=hasReceiveDirectionality(g.audio)?setupCounter(m.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioPayloadRecvBitrate):-1,this.extensions.TimerAudioPayloadSendBitrate=hasSendDirectionality(g.audio)?setupCounter(m.ssrc_audio_send.bytesSent,this.extensions.TimerAudioPayloadSendBitrate):-1,this.extensions.TimerAudioTransportRecvBitrate=hasReceiveDirectionality(g.audio)?setupCounter(m.ssrc_audio_recv.bytesReceived,this.extensions.TimerAudioTransportRecvBitrate):-1,this.extensions.TimerAudioTransportSendBitrate=hasSendDirectionality(g.audio)?setupCounter(m.ssrc_audio_send.bytesSent,this.extensions.TimerAudioTransportSendBitrate):-1,!(!m.ssrc_video_send||!m.ssrc_video_recv)&&(this.extensions.TimerVideoPayloadRecvBitrate=hasReceiveDirectionality(g.video)?setupCounter(m.ssrc_video_recv.bytesReceived,this.extensions.TimerVideoPayloadRecvBitrate):-1,this.extensions.TimerVideoPayloadSendBitrate=hasSendDirectionality(g.video)?setupCounter(m.ssrc_video_send.bytesSent,this.extensions.TimerVideoSendBitrate):-1,!!(this.extensions.TimerVideoPayloadRecvBitrate&&this.extensions.TimerVideoPayloadSendBitrate&&this.extensions.TimerAudioPayloadRecvBitrate&&this.extensions.TimerAudioPayloadSendBitrate&&this.extensions.TimerAudioTransportRecvBitrate&&this.extensions.TimerAudioTransportSendBitrate))}calculateAverages(){const g=this.extensions.EndTime,doTheCalc=(m,f)=>m&&g-f>0&&0!==f&&-1!==f?Math.round(8*m/(g-f)):0,getCounter=g=>{const m=g.split(".").reduce(((g,m)=>null==g?g:g[m]),this.extensions.WebRTCStats);return Array.isArray(m)?m[m.length-1]:m};this.extensions.AudioPayloadRecvBitrate=doTheCalc(getCounter("ssrc_audio_recv.bytesReceived"),this.extensions.TimerAudioPayloadRecvBitrate),this.extensions.AudioPayloadSendBitrate=doTheCalc(getCounter("ssrc_audio_send.bytesSent"),this.extensions.TimerAudioPayloadSendBitrate),this.extensions.VideoPayloadRecvBitrate=doTheCalc(getCounter("ssrc_video_recv.bytesReceived"),this.extensions.TimerVideoPayloadRecvBitrate),this.extensions.VideoPayloadSendBitrate=doTheCalc(getCounter("ssrc_video_send.bytesSent"),this.extensions.TimerVideoPayloadSendBitrate),this.extensions.AudioTransportRecvBitrate=doTheCalc(getCounter("ssrc_audio_send.pair.bytesReceived"),this.extensions.TimerAudioTransportRecvBitrate),this.extensions.AudioTransportSendBitrate=doTheCalc(getCounter("ssrc_audio_send.pair.bytesSent"),this.extensions.TimerAudioTransportSendBitrate)}addFilteredFields(g,m,f=[]){for(const S in m)if(m.hasOwnProperty(S)&&"type"!==S)if(-1!==f.indexOf(S)){const f=g[S]||[];f.push(this.formatFields(m,S)),f.length>this.storedRecordsNumber&&f.shift(),g[S]||(g[S]=f)}else g[S]=m[S]}formatFields(g,m){const f=g[m];switch(m){case"audioInputLevel":case"audioOutputLevel":return this.newStatsApi?Math.floor(65535*f):2*f;case"googJitterBufferMs":return parseInt(f);case"healedRatio":return round(parseFloat(f),this.configProvider.config.healedRatioPrecision);case"jitter":return round(parseFloat(f),this.configProvider.config.jitterPrecision);default:return f}}processSource(g,m,f){let S;if(this.addFilteredFields(g,m,nC),m.transportId){const v=f.googComponent?.[m.transportId];g.transport||(g.transport={}),v&&(this.addFilteredFields(g.transport,v),v.selectedCandidatePairId&&(S=f.googCandidatePair?.[v.selectedCandidatePairId]))}else S=Object.values(f.googCandidatePair).find((g=>g.selected));S&&(g.pair||(g.pair={}),this.addFilteredFields(g.pair,S,rC))}getWebrtcReport(g,m,f,S){const v=g.ssrc[f],C=S?v.id.replace(/[0-9]+/,S):v.id;m[C]?v.ssrc!==m[C].ssrc&&(C.endsWith("video_send")?this.videoTelemetry.stopSendGathering():C.endsWith("video_recv")?this.videoTelemetry.stopRecvGathering():C.endsWith("sharing_send")?this.sharingTelemetry.stopSendGathering():C.endsWith("sharing_recv")&&this.sharingTelemetry.stopRecvGathering()):m[C]={},this.processSource(m[C],v,g)}constructWebRTCDataReport(g,m){if(!m.data?.length)return;const f=m.data.sort(((g,m)=>m.timestamp-g.timestamp)),S=f.find((g=>"open"===g.state));g.data=S||f[0]}constructWebRtcReportForSingleStream(g,m){if(!m.ssrc)return;const f=this.selectSsrcsToCollect(m.ssrc);g.recvCounters=f.recvCounters,delete f.recvCounters,delete f.multiRecv,forOwn(f,(f=>{forOwn(f,((f,S)=>{this.getWebrtcReport(m,g,f,S)}))})),m.VideoBwe?.bweforvideo&&(g.bweStat||(g.bweStat={}),this.addFilteredFields(g.bweStat,m.VideoBwe.bweforvideo,sC))}constructWebRtcReportForMultipleStreams(g,m){if(!m.ssrc)return;this.selectSsrcsToCollect(m.ssrc).multiRecv.forEach((f=>this.getWebrtcReport(m,g,f)))}getMediaType(g,m){let f=m?m.getModality():g.mediaType;return g.googTrackId?.match("applicationsharing")&&f!==je.MEDIA_TYPE.sharing&&(f=je.MEDIA_TYPE.sharing),f}selectSsrcsToCollect(g){const m={send:{},recv:{},recvCounters:{video:0,sharing:0},multiRecv:[]};if(!this.sessionInfo.activeModalities)return m;let f=[];for(const S of Object.keys(g)){const v=g[S],C=v.googTrackId;if(!C&&v.mediaType!==je.MEDIA_TYPE.audio)continue;const _=this.getMediaEntity(C,v),E=this.getMediaType(v,_),T=_?.getXSourceStreamId();if(S.endsWith("send"))switch(E){case je.MEDIA_TYPE.audio:hasSendDirectionality(this.sessionInfo.activeModalities.audio)&&(m.send.audio=S);break;case je.MEDIA_TYPE.video:if(this.extensions.Video_send_SourceId=T,this.simulcastVideo.highestFidelitySSRC){this.simulcastVideo.highestFidelitySSRC===v.ssrc&&(m.send.video=S);break}this.streamSenderStarted.Video&&hasSendDirectionality(this.sessionInfo.activeModalities.video)&&_?.getLocalTrackId()&&(_?.getLocalTrackId()===v.googTrackId||this.configProvider.config.statsAllowAnyVideoSendTrack&&!m.send.video)&&(!v.rid||"1"===v.rid)&&(m.send.video=S);break;case je.MEDIA_TYPE.sharing:if(this.simulcastSharing.highestFidelitySSRC){this.simulcastSharing.highestFidelitySSRC===v.ssrc&&(m.send.sharing=S);break}this.streamSenderStarted.ScreenShare&&hasSendDirectionality(this.sessionInfo.activeModalities.sharing)&&_?.getLocalTrackId()===v.googTrackId&&(m.send.sharing=S);break;default:this.logger.warn(`Unknown media type '${E}'`)}else if(S.endsWith("recv"))switch(E){case je.MEDIA_TYPE.audio:hasReceiveDirectionality(this.sessionInfo.activeModalities.audio)&&(m.recv.audio=S);break;case je.MEDIA_TYPE.video:void 0!==T&&this.MSIDs.add(T),this.isSubscribed(v.googTrackId,v.ssrc)&&hasReceiveDirectionality(this.sessionInfo.activeModalities.video)&&(f.push(v),+v.googFrameRateReceived>0&&m.recvCounters[je.MODALITY.video]++);break;case je.MEDIA_TYPE.sharing:this.isSubscribed(v.googTrackId,v.ssrc)&&hasReceiveDirectionality(this.sessionInfo.activeModalities.sharing)&&(m.recv.sharing=S,+v.googFrameRateReceived>0&&m.recvCounters[je.MODALITY.sharing]++);break;default:this.logger.warn(`Unknown media type '${E}'`)}}if(f.length>0){f=f.sort(((g,m)=>+m.googFrameHeightReceived-+g.googFrameHeightReceived));const g=f.find((g=>g.mediaType===je.MEDIA_TYPE.video));g&&(m.recv.video=g.id),this.multiparty&&this.configProvider.config.enableMultiViewStats&&(m.multiRecv=f.map((g=>g.id)),m.multiRecv.forEach((g=>{this.multiViewVideoTelemetry[g]||(this.multiViewVideoTelemetry[g]=new Zy(this.extensions.StartTime,this.configProvider,this.logger.createChild(`Video[${g}]`,"Video")),this.multiViewVideoTelemetry[g].setMsi(this.MSIDsPairs[g]?.msi),this.multiViewVideoTelemetry[g].setLocalMsi(this.MSIDsPairs[g]?.localMsi),this.multiViewVideoTelemetry[g].prepareCollectingStatsOnSubscribed(this.MSIDsPairs[g]?.msi))})))}return m}getMediaEntityForTrack(g){if(g)return this.mediaManager.getMediaEntities().find((m=>m.getLocalTrackId()===g||m.getRemoteTrackId()===g))}getMediaEntityByRemoteSsrc(g){if(g)return this.mediaManager.getMediaEntities().find((m=>m.getRemoteSsrc()===+g))}getMediaEntity(g,m){const f=`${m.ssrc}`,S=m.id;let v=this.getMediaEntityForTrack(g);return!v&&this.configProvider.config.subscribeToSsrcForVideo&&S.endsWith("recv")&&(v=this.getMediaEntityByRemoteSsrc(f)),v}calculateHwSilentState(){const g=this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!g||g.length<2*this.hwSilentDetectionDuration)return;let m=!0;for(let f=g.length-this.hwSilentDetectionDuration-1;f<g.length;f++)if(g[f]>this.hwSilentDetectionLevel){m=!1;break}this.hwSilent!==m&&(this.hwSilent=m,this.logger.safe.info(`HW silent changed to ${this.hwSilent}`))}calculateSpeakingState(){const g=this.newStatsApi&&this.configProvider.config.useAudioAnalyzer?this.extensions.Audio_send_RawInputVolume:this.extensions.WebRTCStats.ssrc_audio_send?.audioInputLevel;if(!g||g.length<=this.speakingWhileMutedBadDuration)return;let m=!1;for(let f=g.length-this.speakingWhileMutedBadDuration;f<g.length;f++)if(g[f]>this.speakingWhileMutedDetectionLevel){m=!0;break}this.isSpeaking=m}calculateNetworkRecvQualityLevel(){this.configProvider.config.enableNetworkRecvQualityUFD&&this.extensions.WebRTCStats.ssrc_audio_recv&&(this.networkRecvLevel=this.networkQualityTelemetry.calculateNetworkRecvQualityLevel({googDecodingCTN:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingCTN??[],googDecodingPLC:this.extensions.WebRTCStats.ssrc_audio_recv.googDecodingPLC??[],concealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.concealedSamples??[],silentConcealedSamples:this.extensions.WebRTCStats.ssrc_audio_recv.silentConcealedSamples??[],totalSamplesReceived:this.extensions.WebRTCStats.ssrc_audio_recv.totalSamplesReceived??[],oldNetworkLevel:this.networkRecvLevel.quality}))}calculateNetworkSendQualityLevel(){this.extensions.WebRTCStats.ssrc_audio_send&&(this.networkSendLevel=this.networkQualityTelemetry.calculateNetworkSendQualityLevel(this.extensions.WebRTCStats.ssrc_audio_send.packetsSent,this.extensions.WebRTCStats.ssrc_audio_send.packetsLost,this.extensions.WebRTCStats.ssrc_audio_send.jitter,this.networkSendLevel.quality))}processStatsError(g,m){const f=stringifyObject(m);this.logger.safe.error(`webrtcStatistics error [${g}]: ${f}`);const S=this.statsErrors.find((m=>m.error===f&&m.origin===g));S?S.count++:this.statsErrors.push({origin:g,error:f,count:1}),this.statsErrors.length>aC&&this.statsErrors.splice(1)}getLastSampleInt(g){return"number"==typeof g?g:g&&parseInt(g[g.length-1])||0}getSsrcIdFromMultipleVideoStream(g){let m;const f=this.extensions.WebRTCStats[je.MULTIPLE_RECV_STREAMS]||{};for(const S in f){const v=f[S];if(v&&v.googTrackId===g){m=S;break}}return m}};__decorateClass([catchStatsErrors],oC.prototype,"onDeviceEvent",1),__decorateClass([catchStatsErrors],oC.prototype,"onMaxCapabilitiesRequested",1),__decorateClass([catchStatsErrors],oC.prototype,"onMaxCapabilitiesApplied",1),__decorateClass([catchStatsErrors],oC.prototype,"addSubscriptionEvent",1),__decorateClass([catchStatsErrors],oC.prototype,"processSimulcastStats",1),__decorateClass([catchStatsErrors],oC.prototype,"processBandwidthStats",1),__decorateClass([catchStatsErrors],oC.prototype,"processAudioStats",1),__decorateClass([catchStatsErrors],oC.prototype,"processVideoStatsSend",1),__decorateClass([catchStatsErrors],oC.prototype,"processVideoStatsRecv",1),__decorateClass([catchStatsErrors],oC.prototype,"processSharingStats",1),__decorateClass([catchStatsErrors],oC.prototype,"processStreamsCounters",1),__decorateClass([catchStatsErrors],oC.prototype,"setMissedInitialPreferredResolution",1),__decorateClass([catchStatsErrors],oC.prototype,"setPreferredResolution",1),__decorateClass([catchStatsErrors],oC.prototype,"setIsRendering",1),__decorateClass([catchStatsErrors],oC.prototype,"setReportedSendBandwidth",1),__decorateClass([catchStatsErrors],oC.prototype,"setMaxSessionBandwidth",1),__decorateClass([catchStatsErrors],oC.prototype,"setStartTime",1),__decorateClass([catchStatsErrors],oC.prototype,"calculateAverages",1),__decorateClass([catchStatsErrors],oC.prototype,"addFilteredFields",1),__decorateClass([catchStatsErrors],oC.prototype,"formatFields",1),__decorateClass([catchStatsErrors],oC.prototype,"processSource",1),__decorateClass([catchStatsErrors],oC.prototype,"getWebrtcReport",1),__decorateClass([catchStatsErrors],oC.prototype,"constructWebRTCDataReport",1),__decorateClass([catchStatsErrors],oC.prototype,"constructWebRtcReportForSingleStream",1),__decorateClass([catchStatsErrors],oC.prototype,"constructWebRtcReportForMultipleStreams",1),__decorateClass([catchStatsErrors],oC.prototype,"selectSsrcsToCollect",1),__decorateClass([catchStatsErrors],oC.prototype,"calculateHwSilentState",1),__decorateClass([catchStatsErrors],oC.prototype,"calculateSpeakingState",1),__decorateClass([catchStatsErrors],oC.prototype,"calculateNetworkRecvQualityLevel",1),__decorateClass([catchStatsErrors],oC.prototype,"calculateNetworkSendQualityLevel",1);var lC="VideoBwe",cC="bweforvideo",dC="googAvailableReceiveBandwidth",hC="googAvailableSendBandwidth",uC="mediaType",gC="framesDecoded",pC="googFrameRateDecoded",mC="googFrameRateReceived",fC="googFrameRateInput",SC="googTrackId";function unwrapResults(g){const m={};return g.result().forEach((g=>{g.names().forEach((f=>{m[g.type]=m[g.type]||{},m[g.type][g.id]=m[g.type][g.id]||{},m[g.type][g.id][f]=g.stat(f)})),m[g.type][g.id].id=g.id})),m}var vC=class extends Be{constructor(g,m,f,S){super(),this.logger=g,this.configProvider=m,this.mediaManager=f,this.window=Ws.window,this._sessionInfo=new MS,this.statisticsMapper=new My,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.webRtcStatistics=new oC(this.logger.createChild("WebrtcStatistics"),this._sessionInfo,this.configProvider,f,S,this.useNewStatsApi)}setAudioDecoderStatsProvider(g){this.statisticsMapper?.setAudioDecoderStatsProvider(g)}get sessionInfo(){return this._sessionInfo}get isDisposed(){return null===this.pc&&0===this.interval}initialize(g){this.pc=g}startWaitingForStreamStart(g){this.webRtcStatistics.startWaitingForStreamStart(g)}onDeviceEvent(g){this.webRtcStatistics.onDeviceEvent(g)}onMaxCapabilitiesRequested(g){this.webRtcStatistics.onMaxCapabilitiesRequested(g)}onMaxCapabilitiesApplied(g){this.webRtcStatistics.onMaxCapabilitiesApplied(g)}onSendersChanged(g,m){this.webRtcStatistics.setStreamSenderStarted(g,m)}addSubscriptionEvent(g,m,f,S,v,C,_){this.webRtcStatistics.addSubscriptionEvent(g,m,f,S,v,C,_)}setSubscribedTrackIds(g){this.webRtcStatistics.setSubscribedTrackIds(g)}setSubscribedTrackSsrc(g){this.webRtcStatistics.setSubscribedTrackSsrc(g)}setPreferredResolution(g,m,f){this.webRtcStatistics.setPreferredResolution(g,m,f)}setIsRendering(g,m,f){this.webRtcStatistics.setIsRendering(g,m,f)}setReportedSendBandwidth(g){this.webRtcStatistics.setReportedSendBandwidth(g)}setMaxSessionBandwidth(g){this.webRtcStatistics.setMaxSessionBandwidth(g)}setTerminated(){this.webRtcStatistics.setTerminated()}addIceCandidateError(g){this.webRtcStatistics.addIceCandidateError(g)}clearIceCandidateErrors(){this.webRtcStatistics.clearIceCandidateErrors()}recordDataChannelProtocolEvent(g){this.webRtcStatistics.recordDataChannelProtocolEvent(g)}setSessionDataChannelState(g){this.webRtcStatistics.setSessionDataChannelState(g)}recordDataChannelError(g){this.webRtcStatistics.recordDataChannelError(g)}updateSendStream(g,m){this.webRtcStatistics.updateSendStream(g,m)}getTimerTracker(g,m){return this.webRtcStatistics.getTimerTracker(g,m)}setH264AvailableProfiles(g){if(!g?.codecs)return;let m=[];g.codecs.forEach((g=>{if("h264"===g.mimeType&&g.sdpFmtpLine){const f=/profile-level-id=(.{6})/.exec(g.sdpFmtpLine);f?.[1]&&(m=m.concat(f[1]))}})),this.webRtcStatistics.addH264AvailableProfiles(m)}processRawReport(g){this.processStatsDict(this.statisticsMapper.build(g))}processLegacyReport(g){this.processStatsDict(unwrapResults(g))}getReport(g,m=!1){const f=this.webRtcStatistics.getReport(g,m);return this.addStreamInfoForE2ETests(f),f}dispose(){this.interval&&(this.window.clearInterval(this.interval),this.interval=0),this.pc=null}getLastStatistics(){return this.statistics}setTimeToFirstFrame(g,m,f){this.webRtcStatistics.setTimeToFirstFrame(g,m,f)}setFreezeDuration(g,m){this.webRtcStatistics.setFreezeDuration(g,m)}addVideoControlMessage(g=!1){this.webRtcStatistics.addVideoControlMessage(g)}setSsrcTrackPair(g,m){this.statisticsMapper.setSsrcTrackPair(g,m)}updateStatsWithLocalSsrcTrackInfo(){for(const g of this.mediaManager.getMediaEntities()){const m=g.getLocalSsrc();m&&this.statisticsMapper.setSsrcTrackPair(m,g.getLocalTrackId())}}addReportedReceiveBandwidth(g){this.webRtcStatistics.addReportedReceiveBandwidth(g)}addStreamInfoForE2ETests(g){const m=this._sessionInfo.negotiatedModalities;if(m&&!this.isDisposed)try{g.localStreams=this.getSendersReport(this.pc.getSenders(),{audio:hasSendDirectionality(m.audio),video:hasSendDirectionality(m.video)}),g.remoteStreams=this.getReceiversReport(this.pc.getReceivers(),{audio:hasReceiveDirectionality(m.audio),video:hasReceiveDirectionality(m.video)})}catch(g){this.logger.safe.warn(`addStreamInfoForE2ETests failed: ${stringifyObject(g)}`)}}getReceiversReport(g,m){const f=[];return g.forEach((g=>{const S={tracks:[]};f.push(S),g.track&&("audio"===g.track.kind&&m.audio||"video"===g.track.kind&&m.video)&&S.tracks.push({stream:void 0,track:g.track})})),f}getSendersReport(g,m){const f=[],S={tracks:[]};return f.push(S),g.forEach((g=>{g.track&&("audio"===g.track.kind&&m.audio||"video"===g.track.kind&&m.video)&&S.tracks.push({stream:void 0,track:g.track})})),f}processStatsDict(g){this.webRtcStatistics.processStatsDict(g);let m=0,f=0;const S=g[lC]?.[cC];S&&(m=Number(S[dC]),f=Number(S[hC]));const v=1e3*((this.configProvider.mediaConfig.maxBandwidthInKbps||Math.floor(Number.MAX_SAFE_INTEGER/1e3))-(this.configProvider.config.audioBandwidthInKbps||0)),C=isNaN(m)?0:m,_=isNaN(f)?0:f,E={estimatedReceiveBandwidth:Math.min(C,v),estimatedSendBandwidth:Math.min(_,v),remoteVideoStreams:{},localVideoStreams:{},isSpeaking:this.webRtcStatistics.getSpeakingState(),audioHwSilent:this.webRtcStatistics.getAudioHwSilent(),networkSendLevel:this.webRtcStatistics.getNetworkSendLevel(),networkRecvLevel:this.webRtcStatistics.getNetworkRecvLevel()};forOwn(g.ssrc,(g=>{if("video"!==g[uC])return;const m=g[SC],f=g.id;-1!==f.indexOf("_recv")?(E.remoteVideoStreams[m]={trackId:m,frameRateReceived:Number(g[mC]),frameRateDecoded:Number(g[pC]),framesDecoded:Number(g[gC])},this.configProvider.config.isRenderingBasedOnRawStatistics||(E.remoteVideoStreams[m].isRendering=this.webRtcStatistics.getIsRendering(f))):m&&-1!==f.indexOf("_send")&&(E.localVideoStreams[m]={trackId:m,ssrc:Number(g.ssrc),frameRateInput:Number(g[fC])})})),this.notifyRawStatisticsChanged(g),deepEqual(this.statistics,E)||(this.statistics=E,this.notifyStatisticsChanged())}notifyRawStatisticsChanged(g){this.event("onRawStatisticsChanged").raise(g)}notifyStatisticsChanged(){this.event("onStatisticsChanged").raise(this.statistics)}},yC=class extends Be{constructor(g,m,f,S,v){super(),this.logger=g,this.configProvider=m,this.diagnostics=f,this.mediaManager=S,this.window=Ws.window,this.useNewStatsApi=this.configProvider.config.webrtcUseNewStatsApi&&this.configProvider.mediaConfig.simulcastSessionEnabled,this.loopIntervalTracker=new Wv(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.loopIntervalAggregator=new qv,this.fetchTimeTracker=new Wv(this.configProvider.config.diagnostics.performanceMonitoring.fluctuationSamplesNum),this.fetchTimeAggregator=new qv,this.gathererV1=new vC(this.logger.createChild("V1"),this.configProvider,this.mediaManager,v),this.gathererV1.on("onStatisticsChanged",(g=>this.event("onStatisticsChanged").raise(g))),this.gathererV1.on("onRawStatisticsChanged",(g=>this.event("onRawStatisticsChanged").raise(g))),this.useNewStatsApi&&m.config.diagnostics.sideBySide&&(this.gathererV2=new Ry(this.logger.createChild("V2"),this.configProvider,this.diagnostics,this.mediaManager))}initialize(g){this.pc=g,this.gathererV1.initialize(g),this.interval??(this.interval=this.window.setInterval((()=>this.processStats()),this.configProvider.config.webrtcStatPollInterval))}setAudioDecoderStatsProvider(g){this.gathererV1.setAudioDecoderStatsProvider(g),this.gathererV2?.setAudioDecoderStatsProvider(g)}dispose(){super.dispose(),this.interval&&(this.window.clearInterval(this.interval),this.interval=void 0),this.gathererV1.dispose(),this.pc=void 0}get isDisposed(){return!this.pc&&void 0===this.interval}async processStats(){if(this.configProvider.config.diagnostics.collectWhileNotConnected){if(!this.pc||"closed"===this.pc.iceConnectionState)return}else if(!this.pc||"connected"!==this.pc.iceConnectionState&&"completed"!==this.pc.iceConnectionState)return void this.gathererV2?.signalNoConnection();if(this.useNewStatsApi){const g=We(),m=void 0===this.loopTimer?-1:g-this.loopTimer;this.loopTimer=g,this.loopIntervalTracker.captureSample(m),this.loopIntervalAggregator.captureSample(this.loopIntervalTracker.getReport());const f=this.loopIntervalAggregator.getReport();f&&(this.diagnostics.loopIntervalMax=f.max,this.diagnostics.loopIntervalMedian=f.median);const S={};(await this.pc.getStats()).forEach((g=>{this.cleanupPii(g);const m=g.type;delete g.type,S[m]??(S[m]={}),S[m][g.id]=g}));const v=We()-g;this.fetchTimeTracker.captureSample(v),this.fetchTimeAggregator.captureSample(this.fetchTimeTracker.getReport());const C=this.fetchTimeAggregator.getReport();C&&(this.diagnostics.fetchTimeMax=C.max,this.diagnostics.fetchTimeMedian=C.median);const _=this.gathererV2?.processRawReport(S);let E=We();this.gathererV1.processRawReport(S),E=We()-E,_&&this.event("onDiagnosticUpdated").raise(_),_?.perfCounters&&(_.perfCounters.loopTime=m,_.perfCounters.fetchTime=v,_.perfCounters.legacyProcessingTime=E)}else this.pc.getStats((g=>{g.result&&this.gathererV1.processLegacyReport(g)}))}cleanupPii(g){switch(g.type){case"local-candidate":case"remote-candidate":{const m=g;Object.defineProperty(m,"address",{enumerable:!1}),Object.defineProperty(m,"url",{enumerable:!1}),Object.defineProperty(m,"relatedAddress",{enumerable:!1}),Object.defineProperty(m,"ip",{enumerable:!1}),Object.defineProperty(m,"usernameFragment",{enumerable:!1});break}case"certificate":{const m=g;Object.defineProperty(m,"fingerprint",{enumerable:!1}),Object.defineProperty(m,"base64Certificate",{enumerable:!1});break}}}get sessionInfo(){return this.gathererV1.sessionInfo}setReportedSendBandwidth(g){this.gathererV1.setReportedSendBandwidth(g)}onMaxCapabilitiesApplied(g){this.gathererV1.onMaxCapabilitiesApplied(g)}clearIceCandidateErrors(){this.gathererV1.clearIceCandidateErrors()}setSsrcTrackPair(g,m){this.gathererV1.setSsrcTrackPair(g,m),this.gathererV2?.setSsrcTrackPair(g,m)}addSubscriptionEvent(g,m,f,S,v,C,_){this.gathererV1.addSubscriptionEvent(g,m,f,S,v,C,_)}setSubscribedTrackSsrc(g){this.gathererV1.setSubscribedTrackSsrc(g)}addIceCandidateError(g){this.gathererV1.addIceCandidateError(g)}setH264AvailableProfiles(g){this.gathererV1.setH264AvailableProfiles(g)}setTerminated(){this.gathererV1.setTerminated()}onDeviceEvent(g){this.gathererV1.onDeviceEvent(g)}getReport(g,m=!1){const f=this.gathererV1.getReport(g,m);if(this.gathererV2&&this.configProvider.config.diagnostics.sideBySide){const g=this.loopIntervalAggregator.getReport();g&&(f.data.Extensions.LoopIntervalMax=`${round(g.max,1)}`,f.data.Extensions.LoopIntervalMedian=`${round(g.median,1)}`);const m=this.fetchTimeAggregator.getReport();m&&(f.data.Extensions.FetchTimeMax=`${round(m.max,1)}`,f.data.Extensions.FetchTimeMedian=`${round(m.median,1)}`);const S=this.diagnostics.getObjectRef();f.data.Extensions.multipleVideoStreams=JSON.stringify(rebaseTime(S.multiViewStats,"startTime",S.startTime)),f.data.Extensions.OvcToSubscribtions=JSON.stringify(S.ovcToSubscriptionEvents),f.data.Extensions.videoPerformanceEvent=JSON.stringify(S.videoPerformanceEvent);const v=S.bandwidthReport;"REMB"===S.bweType?(f.data.Extensions.StartCallBWE=JSON.stringify(v?.startOfTheCall),f.data.Extensions.EndCallBWE=JSON.stringify(v?.endOfTheCall),f.data.Extensions.BWEStd=JSON.stringify(v?.std),f.data.Extensions.BwPercentiles=JSON.stringify(v?.bwPercentiles),f.data.Extensions.AvgBwe=JSON.stringify(v?.avgBwe)):(f.data.Extensions.StartCallBWESendSide=JSON.stringify(v?.startOfTheCall),f.data.Extensions.EndCallBWESendSide=JSON.stringify(v?.endOfTheCall),f.data.Extensions.BWEStdSendSide=JSON.stringify(v?.std),f.data.Extensions.BwPercentilesSendSide=JSON.stringify(v?.bwPercentiles),f.data.Extensions.AvgBwSendSide=JSON.stringify(v?.avgBwe)),f.data.Extensions.SentBWSeed=JSON.stringify(S.sentBWSeed),f.data.Extensions.Bandwidth_downlinkStabilizationTime=JSON.stringify(S.bwDownlinkStabilizationTime);const C=S.aggregatedModalityStats?.video?.recv||[],_=S.aggregatedModalityStats?.audio?.recv||[],E=S.aggregatedModalityStats?.sharing?.recv||[],T=C[C.length-1],I=E[E.length-1],b=T?.aggregated?.macroblockRateStats??{},A=_[_.length-1]?.aggregated?.customHealerStats??{};if(A?.pullPacketProcessingTimes){const g=getPercentilesProviderFromSampleFreqs(A.pullPacketProcessingTimes);A.pullPacketProcessingTimeP50=g.getPercentile(.5),A.pullPacketProcessingTimeP95=g.getPercentile(.95)}if(A?.pushPacketProcessingTimes){const g=getPercentilesProviderFromSampleFreqs(A.pushPacketProcessingTimes);A.pushPacketProcessingTimeP50=g.getPercentile(.5),A.pushPacketProcessingTimeP95=g.getPercentile(.95)}for(const g in b)f.data.Extensions[`Video_recv_${g}`]=`${round(b[g],0)}`;for(const g in S.totalVideoRecvMblocksRates)f.data.Extensions[`totalVideoRecv_${g}`]=`${round(S.totalVideoRecvMblocksRates[g],0)}`;for(const g in A)if(void 0!==A[g]){const m="number"!=typeof A[g]?JSON.stringify(A[g]):A[g];f.data.Extensions[`Audio_recv_customHealer_${g}`]=m}f.data.Extensions.CallSetupTimeTracker=JSON.stringify(S.timerTrackerReport),f.data.Extensions.Audio_send_presentationAPIUserDuration=JSON.stringify(S.presentationAPIUserDuration),f.data.Extensions.Audio_send_presentationDuration=JSON.stringify(S.presentationAudioDuration),f.data.Extensions.CodecSupport=JSON.stringify(S.codecSupport),f.data.Extensions.Video_recv_FpsHarmonicAverage=T?.extensions.fpsHarmonicAverage?.toString(),f.data.Extensions.Sharing_recv_FpsHarmonicAverage=I?.extensions.fpsHarmonicAverage?.toString(),f.data.Extensions.Sharing_recv_CodecReport=JSON.stringify(I?.aggregated.codecReport),this.configProvider.config.diagnostics.features.takeFreezeTelemetryFromGathererV2&&(C.length&&(f.data.Extensions.Video_recv_FreezeHistogram=JSON.stringify(T.aggregated.freezeCountHistogram),f.data.Extensions.Video_recv_LongestFreezeDuration=JSON.stringify(T?.aggregated?.longestFreeze),f.data.Extensions.Video_recv_OngoingFreeze=JSON.stringify(T?.extensions?.isFrozen),f.data.Extensions.Video_recv_OngoingFreezeDuration=JSON.stringify(T?.aggregated?.ongoingFreezeDuration),f.data.Extensions.Video_recv_TotalFreezeDuration=JSON.stringify(T?.aggregated?.totalFreezeDuration),f.data.Extensions.Video_recv_RecvAvgFreezeDuration=JSON.stringify(T?.aggregated?.avgFreezeDuration),f.data.Extensions.Video_recv_FreezeTimestamps=JSON.stringify(rebaseHistogramTimestamps(T?.aggregated?.freezeTimestampsHistogram,S.startTime))),E.length&&(f.data.Extensions.Sharing_recv_FreezeHistogram=JSON.stringify(I.aggregated.freezeCountHistogram),f.data.Extensions.Sharing_recv_LongestFreezeDuration=JSON.stringify(I?.aggregated?.longestFreeze),f.data.Extensions.Sharing_recv_OngoingFreeze=JSON.stringify(I?.extensions?.isFrozen),f.data.Extensions.Sharing_recv_OngoingFreezeDuration=JSON.stringify(I?.aggregated?.ongoingFreezeDuration),f.data.Extensions.Sharing_recv_TotalFreezeDuration=JSON.stringify(I?.aggregated?.totalFreezeDuration),f.data.Extensions.Sharing_recv_RecvAvgFreezeDuration=JSON.stringify(I?.aggregated?.avgFreezeDuration),f.data.Extensions.Sharing_recv_FreezeTimestamps=JSON.stringify(rebaseHistogramTimestamps(I?.aggregated?.freezeTimestampsHistogram,S.startTime)))),f.data.Extensions.EarlyMedia={NumStatsPolls:`${S.earlyMediaNumStatsPolls}`}}return f}startWaitingForStreamStart(g){this.gathererV1.startWaitingForStreamStart(g)}getTimerTracker(g,m){return this.gathererV1.getTimerTracker(g,m)}getLastStatistics(){return this.gathererV1.getLastStatistics()}updateSendStream(g,m){this.gathererV1.updateSendStream(g,m)}setSubscribedTrackIds(g){this.gathererV1.setSubscribedTrackIds(g)}setMaxSessionBandwidth(g){this.gathererV1.setMaxSessionBandwidth(g)}updateStatsWithLocalSsrcTrackInfo(){this.gathererV1.updateStatsWithLocalSsrcTrackInfo()}onSendersChanged(g,m){this.gathererV1.onSendersChanged(g,m)}setPreferredResolution(g,m,f){this.gathererV1.setPreferredResolution(g,m,f)}setIsRendering(g,m,f){this.gathererV1.setIsRendering(g,m,f)}setTimeToFirstFrame(g,m,f){this.gathererV1.setTimeToFirstFrame(g,m,f)}setFreezeDuration(g,m){this.gathererV1.setFreezeDuration(g,m)}addVideoControlMessage(g){this.gathererV1.addVideoControlMessage(g)}setSessionDataChannelState(g){this.gathererV1.setSessionDataChannelState(g)}recordDataChannelError(g){this.gathererV1.recordDataChannelError(g)}onMaxCapabilitiesRequested(g){this.gathererV1.onMaxCapabilitiesRequested(g)}recordDataChannelProtocolEvent(g){this.gathererV1.recordDataChannelProtocolEvent(g)}addReportedReceiveBandwidth(g){this.gathererV1.addReportedReceiveBandwidth(g)}},CC=101,_C=[48e3,32e3,24e3,16e3,12e3],EC=class{constructor(g){this.context=g,this.cname=uniqueId(),this.dataMedia={type:je.MEDIA_TYPE.data,protocol:je.PROFILES.rtpSavp,port:0},this.configProvider=g.configProvider,this.logger=g.getLogger().createChild("WebkitSdpTrans")}fixTelephoneEvent(g){let m;return _C.forEach((m=>{removeCodec(g,{codec:"telephone-event",rate:m})})),updatePayload(g,CC,999),forOneCodec(g,{codec:"telephone-event",rate:8e3},(g=>(m=g.rtp.payload,g.rtp.payload=CC,g))),updatePayload(g,999,m||CC),m}toLocal(g,m,f){const S=m.isEmpty(),v=deepClone(g);let C;return v.media.forEach((g=>{if("audio"===g.type)S&&(C=this.fixTelephoneEvent(g)),fixComfortNoise(g);else{C&&updatePayload(g,CC,C);const f=m.getLocalSsrcs().get(getModality(g));this.enforceFixedSsrc(g,f)}const v=getAllowedCodecs(this.configProvider,g.type);"offer"===f&&filterCodecs2(g,v,S,this.logger)})),new aS(this.configProvider).modify(v),delete v.extmapAllowMixed,v}toOffer(g,m,f){return this.fromNative(g,m,f,!0)}toAnswer(g,m,f){return this.fromNative(g,m,f,!1)}toRemote(g,m,f,S){const v=deepClone(g);let C,_,E=this.configProvider.mediaConfig.maxBandwidthInKbps;v.bandwidth&&(!E||E>g.bandwidth[0].limit)&&(E=g.bandwidth[0].limit),v.media.forEach(((g,f)=>{m.getMediaEntity(f).isDisabled()&&g.type!==je.MEDIA_TYPE.audio&&(g.port=0)}));let T=getBundle2(v);if(!T){let g=!1;v.media.forEach(((f,S)=>{const v=m.getMediaEntity(S);!g&&v.isEnabled()?(f.mid=v.getMid(),g=!0):(v.disable(),f.port=0)})),g&&(v.groups||(v.groups=[]),T={type:"BUNDLE"},v.groups.push(T))}v.media.forEach((g=>{const m=getModality(g);f[m]===je.MEDIA_STATE.send&&(g.direction&&g.direction.toLowerCase()===je.MEDIA_STATE.receive||(g.direction=je.MEDIA_STATE.receive))}));const I=v.media.filter((g=>g.type===je.MEDIA_TYPE.video));if(I.length>0){const g=I.filter((g=>0!==g.port));if(g.length>0){_=deepClone(g[0]),_.bandwidth&&delete _.bandwidth;const m=this.configProvider.config.audioBandwidthInKbps?this.configProvider.config.audioBandwidthInKbps:0;E&&E-m>0&&(_.bandwidth=[{limit:E-m,type:"AS"}]),_.mid="video",_.direction=null,delete _.label,_.ssrcs=[],_.ssrcGroups=[],delete _.msid,g.forEach((g=>{g.ssrcs&&(_.ssrcs=_.ssrcs.concat(g.ssrcs)),g.ssrcGroups&&(_.ssrcGroups=_.ssrcGroups.concat(g.ssrcGroups)),_.direction=mergeDirections(_.direction,g.direction||je.MEDIA_STATE.sendReceive)})),removeUnifiedPlanExtensions(_)}else _=disabledMedia2(je.MEDIA_TYPE.video,void 0,I[0].protocol,I[0].payloads)}const b=v.media.find((g=>g.type===je.MEDIA_TYPE.audio));if(b)if(0!==b.port)C=deepClone(b),C.mid="audio",delete C.label,removeG722Codec(C),fixComfortNoise(C),removeUnifiedPlanExtensions(C);else{C=disabledMedia2(je.MEDIA_TYPE.audio,void 0,b.protocol,b.payloads);const g=v.media.find((g=>!!g.iceUfrag));g&&(C.port=9,C.direction="inactive",C.mid="audio",C.iceUfrag=g.iceUfrag,C.icePwd=g.icePwd,C.rtcpMux="rtcp-mux",g.crypto&&(C.crypto=g.crypto),g.fingerprint&&(C.fingerprint=g.fingerprint,C.setup=g.setup),C.rtp=[{payload:0,codec:"PCMU",rate:8e3}],C.payloads="0")}v.media.forEach(((g,m)=>{g.type===je.MEDIA_TYPE.data&&(g.type=je.MEDIA_TYPE.dataChannel,g.payloads=je.PAYLOAD_TYPE.DATA_CHANNEL,g.protocol=je.PROFILES.udpDtlsSctp,g.mid="data",delete g.xDataProtocol,delete g.direction,isMediaDisabled(g)&&(v.media[m]=disabledMedia2(g.type,void 0,g.protocol,g.payloads)))}));const A=allowDataChannel(this.context)?v.media.find((g=>g.type===je.MEDIA_TYPE.dataChannel)):null;v.media=[C,_,A].filter((g=>g)),m.getMediaEntities()[0].getModality()!==je.MODALITY.audio&&v.media.reverse();const P=preferSdesSrtp(this.context),R=getSrtpInfo(g);return v.media.forEach((g=>{g.type!==je.MEDIA_TYPE.dataChannel&&(!P&&g.fingerprint&&g.crypto&&delete g.crypto,g.protocol=!R.dtls||R.sdes&&P?je.PROFILES.rtpSavpf:je.PROFILES.udpTlsRtpSavpf)})),"offer"===S&&(filterCodecs2(C,this.configProvider.config.allowedAudioCodecs,!1,this.logger),filterCodecs2(_,this.configProvider.config.allowedVideoCodecs,!1,this.logger)),fixBundling(v,this.configProvider.mediaConfig.isTransportUnbundled),v}splitMedia(g,m,f,S,v){const C=g.getMid(),_=g.getModality(),E=deepClone(m);if(E.label=getLabelForModality(_),E.direction=S,E.mid=C,E.ssrcs=[],E.ssrcGroups=[],g.getModality()===je.MODALITY.data)return E.type=je.MEDIA_TYPE.data,E.payloads=je.PAYLOAD_TYPE.X_DATA,E;const T=f.filter((g=>g.modality===_));if(T&&T.length){const g=[];m.ssrcs&&(T.forEach((f=>{const S=m.ssrcs.filter((g=>"msid"===g.attribute&&f.trackId===getTrackId(g.value))).map((g=>g.id));g.push(...S)})),E.ssrcs=m.ssrcs.filter((m=>g.indexOf(m.id)>-1)),E.ssrcs.forEach((g=>{"cname"===g.attribute&&(g.value=this.cname)}))),m.ssrcGroups&&(E.ssrcGroups=m.ssrcGroups.filter((m=>m.ssrcs.split(" ").find((m=>g.indexOf(+m)>-1)))))}else{if(S===je.MEDIA_STATE.send||S===je.MEDIA_STATE.sendReceive)return disabledMedia2(m.type,getLabelForModality(_),m.protocol,m.payloads);S!==je.MEDIA_STATE.receive&&S!==je.MEDIA_STATE.inactive||(v[m.type].ssrcs&&v[m.type].ssrcs[0]?E.ssrcs=[{id:v[m.type].ssrcs[0].id,attribute:"cname",value:this.cname}]:m.type===je.MEDIA_TYPE.audio?E.ssrcs=[{id:4195875351,attribute:"cname",value:this.cname}]:m.type===je.MEDIA_TYPE.video&&(E.ssrcs=[{id:1,attribute:"cname",value:this.cname}]))}return E}fromNative(g,m,f,S){const v=deepClone(g),C=this.configProvider.mediaConfig.maxBandwidthInKbps;C&&(v.bandwidth=[{limit:C,type:"CT"}]),new oS(this.configProvider).modify(v);const _=v.media.find((g=>g.type===je.MEDIA_TYPE.audio)),E=v.media.find((g=>g.type===je.MEDIA_TYPE.video)),T=v.media.find((g=>g.type===je.MEDIA_TYPE.dataChannel)),I={};I[je.MODALITY.audio]=_,I[je.MODALITY.video]=E,I[je.MODALITY.sharing]=E,I[je.MODALITY.data]=T||this.dataMedia;const b={};b[je.MEDIA_TYPE.audio]=_,b[je.MEDIA_TYPE.video]=E,b[je.MEDIA_TYPE.data]=T||this.dataMedia;const A={};return A[je.MODALITY.audio]=m.getMediaEntitiesByModality(je.MODALITY.audio)[0],A[je.MODALITY.video]=m.getMediaEntitiesByModality(je.MODALITY.video)[0],A[je.MODALITY.sharing]=m.getMediaEntitiesByModality(je.MODALITY.sharing)[0],A[je.MODALITY.data]=m.getMediaEntitiesByModality(je.MODALITY.data)[0],v.media=[],m.getMediaEntities().forEach((g=>{let C,_=f[g.getModality()];!g.isEnabled()||0===I[g.getModality()].port||g!==A[g.getModality()]&&_===je.MEDIA_STATE.send?(C=disabledMedia2(g.getType(),getLabelForModality(g.getModality()),I[g.getModality()].protocol,I[g.getModality()].payloads),I[g.getModality()].payloads===je.PAYLOAD_TYPE.DATA_CHANNEL&&(C.payloads=je.PAYLOAD_TYPE.DATA_CHANNEL)):(_!==je.MEDIA_STATE.inactive&&g!==A[g.getModality()]&&(_=je.MEDIA_STATE.receive),C=this.splitMedia(g,I[g.getModality()],m.getLocalTracksInfo(),_,b),g!==A[g.getModality()]&&(C.candidates=[]));const E=I[g.getModality()].setup;E&&("actpass"!==E?g.setExtension("setup",E):S&&void 0!==g.getExtension("setup")&&(C.setup="actpass"!==g.getExtension("setup")?g.getExtension("setup"):E));const T=I[g.getModality()].iceUfrag,P=g.getExtension("iceUfrag");g.setExtension("iceRestart",!!T&&!!P&&P!==T),g.setExtension("iceUfrag",T),isMediaDisabled(C)&&g.disable(),v.media.push(C)})),new Pf(this.context,f.data).modify(v),fixBundling(v,this.configProvider.mediaConfig.isTransportUnbundled),v}enforceFixedSsrc(g,m){let f=-1;if(!g.ssrcs)return;const S=[];if(g.ssrcs.forEach((g=>{"msid"===g.attribute&&S.push({ssrc:g.id,trackId:getTrackId(g.value)})})),g.ssrcs.forEach((g=>{"cname"===g.attribute&&f++,m&&(g.id=this.getVideoSSRC(f,m))})),g.ssrcGroups){const m=g.ssrcs.filter((g=>"cname"===g.attribute)).map((g=>g.id));g.ssrcGroups.forEach(((g,f)=>{g.ssrcs=[m[2*f],m[2*f+1]].join(" ")}))}}getVideoSSRC(g,m){return g%2==1?m+50:m}};function removeG722Codec(g){removeCodec(g,{codec:"g722",rate:8e3,encoding:2})}function removeUnifiedPlanExtensions(g){const m=new Set(["urn:ietf:params:rtp-hdrext:sdes:mid","urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id","urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id"]);g.ext&&(g.ext=g.ext.filter((g=>!m.has(g.uri))))}function fixComfortNoise(g){removeCodec(g,{codec:"CN",rate:16e3})}function getBundle2(g){return g.groups?g.groups.find((g=>"BUNDLE"===g.type)):null}function fixBundling(g,m){const f=g.groups?.findIndex((g=>"BUNDLE"===g.type)),S=g.groups?g.groups[f]:void 0;S&&(m?(S.mids=g.media.filter((g=>g.type===je.MEDIA_TYPE.video)).map((g=>g.mid)).filter((g=>g)).join(" "),S.mids||delete g.groups[f]):S.mids=g.media.map((g=>g.mid)).filter((g=>g)).join(" "))}function disabledMedia2(g,m,f,S){return{type:g,port:0,label:m,payloads:S,protocol:f}}function getTrackId(g){return g.split(" ")[1]}function mergeDirections(g,m){return g===je.MEDIA_STATE.sendReceive||m===je.MEDIA_STATE.sendReceive?je.MEDIA_STATE.sendReceive:g===m?g:g&&m&&g!==m?je.MEDIA_STATE.sendReceive:g||m}function filterCodecs2(g,m,f,S){if(!m.length||!g?.port)return;filterCodecs(g,convertToCodecInfo(m),f,S)}var TC=__toESM(Te()),IC=class{getCapabilities(g){const m=RTCRtpReceiver.getCapabilities(g);return m.codecs.forEach((g=>{const m=g.mimeType.toLowerCase().split("/");g.mimeType=m[1]||m[0]})),Promise.resolve(m)}},bC=class{constructor(g){this.selfGlobal=g.global.capabilityGatherer=g.global.capabilityGatherer||{},this.getCapabilities("video")}async getCapabilities(g){if("video"!==g&&"audio"!==g)return Promise.reject(new Error(`capabilities for ${g} are not supported`));if(!this.selfGlobal.gatherTask){const g=defer4();this.selfGlobal.gatherTask=g.promise;const m=void 0!==Ws.window.webkitRTCPeerConnection,f=m?new Ws.window.webkitRTCPeerConnection(null):new Ws.window.RTCPeerConnection(null),createOfferWrapper=g=>m?new Promise(((m,S)=>{f.createOffer(m,S,g)})):f.createOffer(g);try{const m=await createOfferWrapper({offerToReceiveVideo:1,offerToReceiveAudio:1}),S={};TC.parse(m.sdp).media.forEach((g=>{S[g.type]=g.rtp.map((m=>{const f={mimeType:m.codec.toLowerCase()};if("video"===g.type){const S=g.fmtp?.find((g=>g.payload===m.payload));f.sdpFmtpLine=S?.config}return f}))})),f.close(),g.resolve(S)}catch(m){this.selfGlobal.gatherTask=null,f.close(),g.reject(m)}}return this.selfGlobal.gatherTask.then((m=>({codecs:m[g]})))}},AC={build:(g,m)=>!m&&qs.hasCapabilitiesApi()?new IC:new bC(g)},PC=__toESM(Te()),RC="rollback";function SessionDescription2(){const g=[].slice.apply(arguments);let m=g[0]&&isRollback(g[0].type);g.splice(0,m?1:0,null);const f=new(Function.prototype.bind.apply(Ws.window.RTCSessionDescription,g)),S=Object.getOwnPropertyDescriptor(Ws.window.RTCSessionDescription.prototype,"type");return Object.defineProperty(f,"type",{get:()=>m?RC:S.get.call(f),set(g){m=isRollback(g),m||S.set.call(f,g)}}),f}function isRollback(g){return RC===g}var wC={build:()=>SessionDescription2},MC=[{codec:"telephone-event",rate:8e3},{codec:"cn",rate:16e3}];function PeerConnection(g){const m=[],f=wC.build(),S=[].slice.apply(arguments);S.splice(0,1,null),overrideSetting("iceTransportPolicy","iceTransports");const v=new(Function.prototype.bind.apply(Ws.window.webkitRTCPeerConnection,S));function overrideSetting(g,m){S[1]&&S[1][g]&&(S[1][m]=S[1][g])}function shim(){shimPromises(),shimSetRemoteDescription(),shimCreateAnswer(),shimCreateOffer(),shimSenders()}function shimPromises(){[{name:"createOffer",reverseArgs:!0},"createAnswer","setRemoteDescription","setLocalDescription"].forEach((function(g){const m=g.name||g,f=v[m];v[m]=function(){const m=arguments;return new Promise((function(S,C){const _=[S,C];m.length>0&&_.splice(g.reverseArgs?_.length:0,0,m[0]),f.apply(v,_)}))}}))}function Sender(g,m){let f;Object.defineProperty(this,"dtmf",{get:()=>"audio"===g.kind?(f=f||v.createDTMFSender(g),f):null}),this.track=g,this._stream=m}function shimSenders(){v.getSenders&&v.addTrack&&v.removeTrack||(v.getSenders=function(){return m.slice()},v.addTrack=function(g,f){if(!g||!f)throw new Error("both media track and stream need to be provided");v.getLocalStreams().some((function(g){return g.id===f.id}))||v.addStream(f);let S=m.find((function(m){return m.track.id===g.id}));return S||(S=new Sender(g,f),m.push(S)),S},v.removeTrack=function(g){v.getLocalStreams().filter((function(m){return m.id===g._stream.id})).forEach((function(g){v.removeStream(g)})),remove2(m,(m=>m===g))})}function shimCreateOffer(){const g=v.createOffer;v.createOffer=function(m){const f=arguments;return m&&m.offerToReceiveVideo>1&&(m.offerToReceiveVideo=1),g.apply(v,f)}}function shimSetRemoteDescription(){["createOffer","createAnswer","setLocalDescription"].forEach((function(m){const f=v[m];v[m]=function(){const m=arguments;return g.getCapabilities("video").then((function(){return f.apply(f,m)}))}}));const m=v.setRemoteDescription;v.setRemoteDescription=function(f){return g.getCapabilities("video").then((function(g){const S=g.codecs,v=PC.parse(f.sdp);return v.media.forEach((function(g){if("video"===g.type){g.rtp.some((function(g){return S.some((function(m){return g.codec.toLowerCase()===m.mimeType}))}))?suppressH264FormatParameters(g):g.port=0}if(!hasDtls(g)){const m=getBundle(v);m?g.crypto=m.crypto:g.port||v.media.some((function(m){return!!m.port&&(g.crypto=m.crypto,!0)}))}})),f.sdp=PC.write(v),m(f)}))}}function shimCreateAnswer(){const g=v.createAnswer;v.createAnswer=function(){const m=arguments;return g.apply(v,m).then((function(g){if(!v.localDescription||!v.localDescription.sdp)return g;const m=PC.parse(v.localDescription.sdp),S=[];if(m.media.forEach((function(g){MC.forEach((function(m){forOneCodec(g,m,(function(g){S.push(g)}))}))})),S.length){const m=PC.parse(g.sdp);let v=!1;m.media.forEach((function(g){S.forEach((function(m){forOneCodec(g,{codec:m.rtp.codec,rate:m.rtp.rate},(function(g){g.rtp.payload!==m.rtp.payload&&(g.rtp.payload=m.rtp.payload,v=!0)}))}))})),v&&(g=new f({type:g.type,sdp:PC.write(m)}))}return g}))}}function suppressH264FormatParameters(g){forOneCodec(g,{codec:"h264",rate:9e4},(function(g){if(g.fmtp){const m=new cf,f=new cf(g.fmtp.config);["level-asymmetry-allowed","packetization-mode","profile-level-id"].forEach((function(g){if(f.contains(g)){let S=f.get(g);"profile-level-id"===g&&(S="42C02A"),m.setIfMissing(g,S)}})),g.fmtp.config=m.toString()}}))}function hasDtls(g){return"RTP/SAVPF"!==g.protocol}return shim(),v}var DC={build:g=>PeerConnection.bind(null,g)},OC=class{constructor(g){const m=g.configProvider.config.useSdpCapabilitiesLegacySession;this.RTCRtpReceiver=AC.build(g,m),this.SdpTransform=EC,this.RTCPeerConnection=DC.build(this.RTCRtpReceiver),this.RTCSessionDescription=wC.build()}};function UnsupportedAdapter(){function throwUnsupported(){throw new Error("unsupported platform")}this.SdpTransform=throwUnsupported,this.RTCPeerConnection=throwUnsupported,this.RTCSessionDescription=throwUnsupported,this.RTCRtpReceiver=throwUnsupported}function isWebkitRtc(){return void 0!==Ws.window.webkitRTCPeerConnection}var NC={build:g=>isWebkitRtc()?new OC(g):new UnsupportedAdapter},kC=class{constructor(g,m,f,S){this.logger=g,this.configProvider=m,this.activeSpeakerManager=f,this.contributingSourcesProvider=S,this.lastSources=[],this.poll=()=>{const g=this.contributingSourcesProvider.getContributingSources();if(!g)return this.logger.safe.info("Contributing sources are not supported on this client"),void this.dispose();this.activeSpeakerManager.onContributingSourcesChanged(g.filter((g=>{const m=this.lastSources.find((m=>m.source===g.source));return!m||m.timestamp!==g.timestamp})).map((g=>g.source))),this.updateLastSources(g),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)},this.contributingSourcesProvider=S,this.logger.safe.info("Polling started"),this.timer=window.setTimeout(this.poll,this.configProvider.config.webrtcContributingSourcesPollingInterval)}dispose(){this.timer&&(window.clearTimeout(this.timer),this.timer=void 0),this.contributingSourcesProvider=void 0,this.logger.safe.info("Polling stopped")}updateLastSources(g){this.lastSources=g.map((g=>({source:g.source,timestamp:g.timestamp})))}},LC=class{constructor(g,m){this.logger=g,this.peerConnection=m}getContributingSources(){try{if(!this.peerConnection?.getReceivers)return;const g=this.peerConnection.getReceivers().find((g=>"audio"===g.track.kind));return g?g.getContributingSources?.():[]}catch(g){return void this.logger.safe.error("Failed to get contributing sources",g)}}},FC=R,xC=[2812,4218,8437,16875,33750,67500,108e3,135e3,198e3,244800,27e4,352500,52e4],UC=class{constructor(g,m,f,S){this.initialMaxFS=g,this.initialMaxFPS=m,this.isAv1Allowed=f,this.h264SubscribeProfile=S,this.maxFS=g,this.maxFPS=m}setMaxFS(g,m){return!(this.maxFS===g||(this.maxFS=g,!m))&&(m(this),!0)}getMaxFS(){return this.maxFS}getMaxFPS(){return this.maxFPS}getMaxMBPS(){return this.calculateMbps(this.maxFS,this.maxFPS)}calculateMbps(g,m){return getClosestValue(xC,g*m/100,!0)}resetToInitial(){this.maxFS=this.initialMaxFS,this.maxFPS=this.initialMaxFPS}fmtpParams(){return{"max-fs":this.getMaxFS(),"max-mbps":this.getMaxMBPS(),"max-fps":this.getMaxFPS()}}buildFmtp(){const g=[];let m=this.fmtpParams();return this.h264SubscribeProfile&&(m["profile-level-id"]=this.h264SubscribeProfile),g.push(m),this.isAv1Allowed&&(m=this.fmtpParams(),m.codec="AV1",g.push(m)),g}},VC=class _MediaEntity{constructor(g,m){this.entity=g,this.configProvider=m}static getVideoCababilities(g,m,f){if(g!==je.MEDIA_TYPE.video)return null;let S,v;m===je.MODALITY.sharing?(S=f.config.webrtcScreensharingCapabilityMaxFS,v=f.config.webrtcScreensharingCapabilityMaxFPS):(S=f.config.webrtcVideoCapabilityMaxFS,v=f.config.webrtcVideoCapabilityMaxFPS,f.config.useMultiviewLimitsOnInitialRequest&&f.config.multiviewResolutionLimits[1]&&(S=jp.Send.getResolutionForHeight(f.config.multiviewResolutionLimits[1]).fs));const C=f.config.isAv1Allowed&&m===je.MODALITY.sharing;return new UC(S,v,C,f.config.h264SubscribeProfile)}static create(g,m,f){const S=getTypeFromModality(m),v=new _MediaEntity({modality:m,mid:f,mtype:S,extensions:{}},g);return v.localRecvCapabilities=_MediaEntity.getVideoCababilities(S,m,g),v}clone(){const g=new _MediaEntity((0,FC.cloneDeep)(this.entity),this.configProvider);return g.setSimulcastContext(this.simulcastContext),g.localRecvCapabilities=this.localRecvCapabilities,g.remoteRecvCapabilities=this.remoteRecvCapabilities,g}getModality(){return this.entity.modality}getType(){return this.entity.mtype}getMid(){return this.entity.mid}disable(){this.entity.mid=null}update(g,m){this.entity.modality!==g&&(this.localRecvCapabilities=_MediaEntity.getVideoCababilities(this.entity.mtype,g,this.configProvider)),this.entity.modality=g,this.entity.mid=m,this.isEnabled()&&this.setExtension("rollback",!1)}isDisabled(){return!this.entity.mid}isEnabled(){return!!this.entity.mid}getLocalRecvCapabilities(){return this.localRecvCapabilities}getRemoteRecvCapabilities(){return{sourceId:this.getXSourceStreamId(),capabilities:this.remoteRecvCapabilities?[this.remoteRecvCapabilities]:[]}}setRemoteRecvCapabilities(g){this.remoteRecvCapabilities=g}getRemoteStreamId(){return this.entity.remoteStreamId}setRemoteStreamId(g){this.entity.remoteStreamId=g}setRemoteSsrc(g){this.entity.remoteSsrc=g}getRemoteSsrc(){return this.entity.remoteSsrc}setLocalSsrc(g){this.entity.localSsrc=g}getLocalSsrc(){return this.entity.localSsrc}getRemoteTrackId(){return this.entity.remoteTrackId}setRemoteTrackId(g){this.entity.remoteTrackId=g}getXSourceStreamId(){return this.entity.xSourceStreamId}setXSourceStreamId(g){this.entity.xSourceStreamId=g}setLocalTrackId(g){this.entity.localTrackId=g}getLocalTrackId(){return this.entity.localTrackId}getExtension(g){return this.entity.extensions[g]}setExtension(g,m){this.entity.extensions[g]=m}getRtpHeaderExtensions(){return this.entity.rtpExt}setRtpHeaderExtensions(g){this.entity.rtpExt=g}setSimulcastContext(g){this.simulcastContext=g}getSimulcastContext(){return this.simulcastContext}serialize(){return deepClone(this.entity)}},BC=class{constructor(g){this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.localSsrcs=new Map,this.ssrcGenerator=new fv,this.logger=g.logger.createChild("MM"),this.configProvider=g.configProvider,this.numVideoChannels=g.numVideoChannels}fromOffer(g,m){g.media.forEach((g=>{if(g.type===je.MEDIA_TYPE.audio)je.MODALITY.audio in m&&this.addMediaEntity(je.MODALITY.audio);else if(g.type===je.MEDIA_TYPE.video){if(je.MODALITY.video in m)for(let g=0;g<this.numVideoChannels;g++)this.addMediaEntity(je.MODALITY.video);je.MODALITY.sharing in m&&this.addMediaEntity(je.MODALITY.sharing)}else g.type===je.MEDIA_TYPE.data&&je.MODALITY.data in m&&this.addMediaEntity(je.MODALITY.data)}))}fromRemote(g,m){g.media.forEach(((g,f)=>{const S=getModality(g);if(isMediaDisabled(g)||!(S in m))this.mediaEntities[f]?this.mediaEntities[f].disable():this.addDisabledMediaEntity(S),this.mediaEntities[f].setRemoteStreamId(null),this.mediaEntities[f].setRemoteTrackId(null);else{if(this.mediaEntities[f]?this.mediaEntities[f].update(S,g.mid||this.generateMid(f)):this.addMediaEntity(S,g.mid||this.generateMid(f)),g.msid)this.mediaEntities[f].setRemoteStreamId(g.msid.split(" ")[0]),this.mediaEntities[f].setRemoteTrackId(g.msid.split(" ")[1]);else if(g.ssrcs){const m=g.ssrcs.find((g=>"msid"===g.attribute));m?(this.mediaEntities[f].setRemoteStreamId(m.value.split(" ")[0]),this.mediaEntities[f].setRemoteTrackId(m.value.split(" ")[1])):this.logger.safe.warn(`No ssrc msid for media of type ${g.type} with mid ${g.mid}`)}const m=g.xSourceStreamId||this.generateSourceStreamId(f);this.mediaEntities[f].setXSourceStreamId(m)}}))}isEmpty(){return 0===this.mediaEntities.length}addMediaEntity(g,m){this.createMediaEntity(g,m||this.generateMid(this.mediaEntities.length))}addDisabledMediaEntity(g){this.createMediaEntity(g)}getMediaEntities(){return this.mediaEntities}createMediaEntity(g,m){const f=VC.create(this.configProvider,g,m);return this.mediaEntities.push(f),f}getMediaEntity(g){return this.mediaEntities[g]}getMediaEntityByMid(g){return this.mediaEntities.find((m=>m.getMid()===g))}getMediaEntitiesByModality(g){return this.mediaEntities.filter((m=>m.getModality()===g))}getMediaEntityByRemoteStreamId(g){return this.mediaEntities.find((m=>m.getRemoteStreamId()===g))}getMediaEntityByLocalTrackId(g){return this.mediaEntities.find((m=>m.getLocalTrackId()===g))}getMediaEntityByXSourceStreamId(g){return this.mediaEntities.find((m=>m.getXSourceStreamId()===g))}reset(){this.mediaEntities=[]}syncModalities(g,m,f){this.disableModalities(m),f||(this.enableModalities(m),this.addModalities(m))}enableModalities(g){this.mediaEntities.forEach(((m,f)=>{m.getModality()in g&&m.isDisabled()&&m.update(m.getModality(),this.generateMid(f))}))}disableModalities(g){this.mediaEntities.forEach((m=>{m.getModality()in g||m.disable()}))}setRollbackUpdateHandler(g){}addModalities(g){const m={};this.mediaEntities.map((g=>g.getModality())).forEach((g=>{m[g]=!0}));for(const f in g)f in m||this.addMediaEntity(f)}setLocalTracksInfo(g){this.mediaTracks=g,this.updateLocalSsrc(this.mediaTracks)}getLocalTracksInfo(){return this.mediaTracks}getLocalSsrcs(){return this.localSsrcs}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((g=>g.setLocalTrackId(null))),this.mediaTracks.forEach((g=>{const m=this.getMediaEntitiesByModality(g.modality)[0];m?m.setLocalTrackId(g.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(g.modality)}`)})))}updateMediaEntitiesWithActivityState(g,m){}backup(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{this.mediaEntitiesBackup.push(g.clone())}))}commit(){this.mediaEntitiesBackup=[]}rollback(){this.mediaEntities=this.mediaEntitiesBackup}generateSourceStreamId(g){return g+10}generateMid(g){return`media_${g}`}updateLocalSsrc(g){g.forEach((g=>{if(!this.localSsrcs.get(g.modality)){const m=this.ssrcGenerator.nextVideoStreamSsrc().min;this.logger.safe.debug(`Ssrc updated for modality: ${g.modality}: ${m}`),this.localSsrcs.set(g.modality,m)}}))}},HC=__toESM(Te()),$C=class{constructor(g,m,f,S,v){this.logger=g,this.RtcDescType=m,this.sessionDescription=f,this.negotiationQueue=S,this.mediaManager=v}dispose(){this.peerConnection=null}configure(g){this.peerConnection=g}renegotiateNow(){return this.renegotiate(null,!0)}renegotiate(g,m=!1,f="local"){if(!this.peerConnection)throw new Error("trying to renegotiate during empty peerConnection");const S="local"===f?this.createNegotiationTaskForHaveLocalOffer(g):this.createNegotiationTaskForHaveRemoteOffer(g);return m?(this.logger.safe.info(`forced ${f} renegotiation starting`),Promise.resolve(S())):this.negotiationQueue.add(S)}normalizeRemoteSdpSDES(g,m){if(m.media[0].crypto)g.media.forEach((g=>{delete g.fingerprint,delete g.setup,g.crypto=g.crypto.filter((g=>m.media[0].crypto.some((m=>m.id===g.id)))).slice(0,1)})),g.fingerprint&&delete g.fingerprint;else{const m=this.mediaManager.getMediaEntities().find((g=>void 0!==g.getExtension("setup")));g.media.forEach((g=>{const f=m?.getExtension("setup")||"actpass";"actpass"===g.setup&&(g.setup="active"===f?"passive":"active")}))}}normalizeRemoteSdpExtensions(g,m){g.media.forEach(((g,f)=>{const S=new Set(m.media[f].ext?.map((g=>g.value))||[]);g.ext=g.ext?.filter((g=>S.has(g.value)))}))}throwIfNoPeerConnection(){if(!this.peerConnection)throw this.logger.safe.warn("no peer connection present"),new Error("trying to renegotiate during empty peerConnection")}createNegotiationTaskForHaveLocalOffer(g){return()=>{let m=this.peerConnection.remoteDescription.sdp;const f=this.peerConnection.localDescription.sdp;this.logger.safe.info(`local renegotiation starting remoteSdp=${!!m} localSdp=${!!f}`);const S=HC.parse(m),v=HC.parse(f);this.normalizeRemoteSdpSDES(S,v),this.normalizeRemoteSdpExtensions(S,v),m=HC.write(S);let C=new this.RtcDescType({sdp:m,type:"answer"});return g&&g.forEach((g=>{C=g.modifyDescriptor(C)})),Promise.resolve().then((()=>(this.logger.safe.info("creating offer"),this.throwIfNoPeerConnection(),this.peerConnection.createOffer()))).then((g=>{this.throwIfNoPeerConnection();const m=this.sessionDescription.createLocalOffer(g.sdp),f=new this.RtcDescType({sdp:m.toLocal(),type:"offer"});return this.logger.safe.info("setting local description"),this.logger.unsafe.debug(`local description, sdp: ${f.sdp}`),this.peerConnection.setLocalDescription(f)})).then((()=>(this.throwIfNoPeerConnection(),this.logger.safe.info("setting remote description"),this.logger.unsafe.debug(`remote description, sdp: ${C.sdp}`),this.peerConnection.setRemoteDescription(C)))).then((g=>(this.logger.safe.debug("local renegotiation done"),g))).catch((g=>{throw this.logger.safe.error("local renegotiation failed: ",g.toString()),g}))}}createNegotiationTaskForHaveRemoteOffer(g){return this.logger.safe.info("createNegotiationTaskForRemote"),()=>(this.logger.safe.info("proceed with setting local sdp start"),Promise.resolve().then((()=>(this.logger.safe.info("creating answer"),this.throwIfNoPeerConnection(),this.peerConnection.createAnswer()))).then((g=>{this.logger.safe.info("applying answer"),this.throwIfNoPeerConnection();const m=this.sessionDescription.createLocalAnswer(g.sdp),f=new this.RtcDescType({sdp:m.toLocal(),type:"answer"});return this.logger.safe.info("setting [answer] local description"),this.logger.unsafe.debug(`[answer] local description, sdp: ${f.sdp}`),this.peerConnection.setLocalDescription(f)})).then((g=>(this.logger.safe.info("local answer for renegotiation is done"),g))).catch((g=>{throw this.logger.safe.error("local answer for renegotiation failed: ",g.toString()),g})))}},GC=15e3,jC=5e3,WC=class{constructor(g,m,f,S){this.settings=g,this.listener=m,this.statsGatherer=f,this.logger=S,this.lastSendBW=0,this.coolingDown=!1,this.cooldownTimer=null,this.cooldownEnd=0,this.active=!1,this.maxResolution=this.settings.maxResolution,this.settings.scalingEnabled?(this.active=!0,this.statsSubscription=this.statsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))):this.logger.safe.info("Resolution management disabled: no resolution management for 1x1 calls")}dispose(){this.currentResolution=null,this.pendingResolution=null,this.maxResolution=null,this.listener=null,this.active=!1,clearTimeout(this.cooldownTimer),this.cooldownTimer=null,this.statsSubscription&&(this.statsSubscription.dispose(),this.statsSubscription=null),this.statsGatherer=null,this.listener=null}setMaxResolution(g){const m=jp.Send.getResolutionByFs(g);m!==this.maxResolution&&(this.logger.safe.info(`Setting max resolution: ${m}`),this.maxResolution=m,this.lastSendBW&&this.processEstimatedBandwidth(this.lastSendBW))}resetCurrentResolution(){this.currentResolution=null}getCurrentResolution(){return this.currentResolution?.fs}setCurrentResolution(g){this.currentResolution=g}applyRes(g){this.pendingResolution=g,this.coolingDown&&(!this.currentResolution||g.fs>this.currentResolution.fs)||(this.coolingDown=!0,this.logger.safe.info(`Changing resolution to ${g}`),this.listener&&this.listener.onResolutionChanged(g.fs).then((m=>{m?(g===this.pendingResolution&&(this.pendingResolution=null),this.coolingDown&&!this.currentResolution&&(this.coolingDown=!1),this.currentResolution=g,this.cooldown()):(this.logger.safe.info("Unable to apply resolution at the moment"),this.cooldown(jC))})).catch((g=>{this.logger.safe.error(`Error while applying new resolution: ${JSON.stringify(g)}`),this.pendingResolution=null})))}cooldown(g=GC){!this.active||this.coolingDown&&this.cooldownEnd-Date.now()>GC||(this.cooldownTimer&&clearTimeout(this.cooldownTimer),this.coolingDown=!0,this.cooldownEnd=Date.now()+GC,this.cooldownTimer=setTimeout((()=>{this.logger.safe.debug("Resolution changer cooled down"),this.coolingDown=!1,this.cooldownTimer=null,this.pendingResolution?this.proposeResolution(this.pendingResolution):this.processEstimatedBandwidth(this.lastSendBW)}),g))}proposeResolution(g){let m=g;this.maxResolution&&this.maxResolution.fs<m.fs&&(m=this.maxResolution),this.currentResolution&&m.fs===this.currentResolution.fs||this.applyRes(m)}processEstimatedBandwidth(g){const{lowRes:m,highRes:f}=jp.Send.getResolutionForBitrate(g),S=g<this.lastSendBW?f:m;g<this.lastSendBW&&S&&this.currentResolution&&this.currentResolution.fs<S.fs||(S&&this.proposeResolution(S),this.lastSendBW=g)}onStatisticsChanged(g){const m=g.estimatedSendBandwidth;m!==this.lastSendBW&&(this.logger.safe.debug(`Send BW: ${m}`),this.processEstimatedBandwidth(m))}},qC=class{constructor(g,m,f,S,v,C,_){this.listener=g,this.statisticsGatherer=m,this.diagnostics=f,this.logger=S,this.configProvider=v,this.isSimulcastEnabled=_,this.serialQueue=new Lp(this.logger),this.modality=je.MODALITY.video;const E=C.maxResolution?{maxFs:C.maxResolution.fs}:null;this.validator=new Xp(this.logger.createChild("CapsValidator"),E),this.resolutionManager=new WC(C,this,this.statisticsGatherer,this.logger.createChild("rm"))}async setMaxCapabilities(g,m){const f={modality:this.modality,causeId:g,capabilities:m,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(f),this.diagnostics?.onMaxCapabilitiesRequested(f),this.causeId=g;const S=this.validator.ensureValidity(m[0]);this.streamSenderParams={...m[0],...S},this.resolutionManager.setMaxResolution(this.streamSenderParams.maxFs),this.configProvider.mediaConfig.simulcastSessionEnabled&&await this.applyCapabilities(this.getParamsToApply())}resetCurrentResolution(){this.resolutionManager.resetCurrentResolution()}getCurrentResolution(){return this.resolutionManager.getCurrentResolution()}setCurrentResolution(g){this.resolutionManager.setCurrentResolution(g)}async onResolutionChanged(g){return this.applyCapabilities(this.getParamsToApply(g))}dispose(){this.resolutionManager.dispose(),this.resolutionManager=null}async applyCapabilities(g){return g?this.lastAppliedSenderParams===g?(this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}`),!0):(this.logger.safe.info(`Capabilities to apply: ${JSON.stringify(g)}`),this.lastAppliedSenderParams=g,this.listener.onReceiveCapabilitiesChanged(this.modality,this.causeId,[g])):(this.logger.safe.error("Send capabilities are not set. Cannot apply constraints"),!1)}getParamsToApply(g){if(!this.streamSenderParams)return null;const m=g||this.resolutionManager.getCurrentResolution();if(!m||this.streamSenderParams.maxFs<=m)return this.streamSenderParams;const f=shallowClone(this.streamSenderParams);return f.maxFs=m,f}};__decorateClass([sequentialize()],qC.prototype,"applyCapabilities",1);var zC=class{constructor(g,m,f,S,v){this.modality=g,this.listener=m,this.statisticsGatherer=f,this.diagnostics=S,this.isSimulcastEnabled=v}setMaxCapabilities(g,m){const f={modality:this.modality,causeId:g,capabilities:m,isSimulcastEnabled:this.isSimulcastEnabled};this.statisticsGatherer.onMaxCapabilitiesRequested(f),this.diagnostics?.onMaxCapabilitiesRequested(f),this.listener.onReceiveCapabilitiesChanged(this.modality,g,m)}dispose(){}resetCurrentResolution(){}getCurrentResolution(){return null}setCurrentResolution(g){}},KC=class extends Be{constructor(g,m,f){super(f),this.configProvider=g,this.statsGatherer=m,this.logger=f,this.lastReportedAgo=1/0,this._forceUpdate=!1,this.subs=this.statsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))}forceUpdate(){this._forceUpdate=!0}dispose(){this.subs.dispose(),this.subs=null}onStatisticsChanged(g){this._forceUpdate?this.updateBandwidth(g.estimatedSendBandwidth,"forceUpdate"):this.processEstimatedBandwidth(g.estimatedSendBandwidth)}processEstimatedBandwidth(g){if(this.lastReportedAgo++,!g||this.bandwidth===g)return;const m=this.configProvider.config.webrtcSendBandwidthIgnoredUpdateLimit,f=this.configProvider.config.webrtcSendBandwidthThreshold,S=this.lastReportedAgo===1/0,v=!m&&!f,C=m&&this.lastReportedAgo>=m,_=f&&Math.abs((g-this.bandwidth)/this.bandwidth)>=f;if(S||v||C||_){const m=+S|+v<<1|+C<<2|+_<<3,f=this.getUpdateReason(m);this.updateBandwidth(g,f)}}updateBandwidth(g,m){this.bandwidth=g,this.logger.safe.debug(`Updating send bandwidth: ${this.bandwidth}, reason: ${m}`),this.notifySendBandwidthChanged()}notifySendBandwidthChanged(){this._forceUpdate=!1,this.event("onSendBandwidthChanged").raise(this.bandwidth),this.lastReportedAgo=0}getUpdateReason(g){return 1&g?"firstReport":2&g?"throttlingDisabled":4&g?"noReportsForTooLong":8&g?"bigMovement":"none"}},JC=class{constructor(g,m,f,S,v,C){this.logger=g,this.settings=m,this.listener=f,this.statsGatherer=S,this.diagnostics=v,this.configProvider=C,this.mediaSourceModels=[],this.pendingCapabilities=new Map}dispose(){this.mediaSourceModels.forEach((g=>{g.handler&&(g.handler.dispose(),g.handler=null)})),this.mediaSourceModels=null,this.sendBandwidthCalculator&&this.disableSendBandwidthCalculator()}updateRegisteredSources(g){this.logger.safe.info(`Local media params updated: ${JSON.stringify(g)}`);const m=[];this.mediaSourceModels.forEach((g=>m.push(g.sourceId)));const f=g.map((g=>g.sourceId)),S=subtractFrom(m,f);this.removeSourcesWithIds(S);const v=subtractFrom(f,m);this.addSourcesWithIds(v,g),this.settings.sendBandwidthNotificationsEnabled&&this.updateSendBandwidthCalculator()}setMaxCapabilities(g){for(const m of g){if(!m.capabilities.length)continue;if(!m.sourceId){this.logger.safe.info(`SourceId is not defined to apply recv capabilities: ${JSON.stringify(m)}`);continue}const g=this.getModelWithSourceId(m.sourceId);if(!g){this.logger.safe.info(`Model is not registered for sourceId: ${m.sourceId}`),this.configProvider.config.enableCachingFMTP&&this.pendingCapabilities.set(m.sourceId,m);continue}this.logger.safe.info(`Capabilities handler found for sourceId: ${m.sourceId}`);const f=this.getOrCreateHandlerForModel(g,m.isSimulcast);f?f.setMaxCapabilities(m.causeId,m.capabilities):this.logger.safe.info(`Handler is not found for sourceId: ${m.sourceId}`)}this.logger.safe.debug("Max capabilities application completed")}setPendingCapabilities(){if(!this.configProvider.config.enableCachingFMTP)return;this.logger.safe.info(`Apply pending capabilties for sources [${Array.from(this.pendingCapabilities.keys())}]`);const g=Array.from(this.pendingCapabilities.values());this.setMaxCapabilities(g),this.pendingCapabilities.clear()}clearPendingCapabilities(){this.pendingCapabilities.clear()}resetCurrentResolution(){const g=this.mediaSourceModels.find((g=>g.modality===je.MODALITY.video));g?.handler&&g.handler.resetCurrentResolution()}getCurrentResolution(){const g=this.mediaSourceModels.find((g=>g.modality===je.MODALITY.video));return g?.handler?g.handler.getCurrentResolution():this.currentResolution?.fs}setCurrentResolution(g){const m=this.mediaSourceModels.find((g=>g.modality===je.MODALITY.video));m?.handler?m.handler.setCurrentResolution(g):this.currentResolution=g}getOrCreateHandlerForModel(g,m){return g.handler||(g.handler=this.getCapabilitiesHandler(g.modality,m)),g.handler}addSourcesWithIds(g,m){g.forEach((g=>{const f=m.find((m=>m.sourceId===g));this.registerSource(g,f.modality)}))}removeSourcesWithIds(g){g.forEach((g=>this.unregisterSource(g)))}registerSource(g,m){this.logger.safe.info(`SourceId ${g} registered with mediaType: ${m}`),this.mediaSourceModels.push({modality:m,sourceId:g})}unregisterSource(g){const m=this.mediaSourceModels.find((m=>m.sourceId===g));m?(m.handler&&m.handler.dispose(),this.mediaSourceModels.splice(this.mediaSourceModels.indexOf(m),1),this.logger.safe.info(`SourceId ${g} unregistered`)):this.logger.safe.info(`Model doesn't exist with sourceId ${g}`)}updateSendBandwidthCalculator(){this.mediaSourceModels.some((g=>[je.MODALITY.video,je.MODALITY.sharing].indexOf(g.modality)>-1))?this.enableSendBandwidthCalculator():this.disableSendBandwidthCalculator()}enableSendBandwidthCalculator(){this.sendBandwidthCalculator||(this.sendBandwidthCalculator=new KC(this.configProvider,this.statsGatherer,this.logger.createChild("SendBwCalc")),this.sendBandwidthCalculatorSubscription=this.sendBandwidthCalculator.on("onSendBandwidthChanged",(g=>this.onSendBandwidthChanged(g))))}disableSendBandwidthCalculator(){this.sendBandwidthCalculatorSubscription&&(this.sendBandwidthCalculatorSubscription.dispose(),this.sendBandwidthCalculatorSubscription=null),this.sendBandwidthCalculator&&(this.sendBandwidthCalculator.dispose(),this.sendBandwidthCalculator=null)}getModelWithSourceId(g){return this.mediaSourceModels.find((m=>m.sourceId===g))}getCapabilitiesHandler(g,m){if(g===je.MODALITY.audio)return null;if(g===je.MODALITY.video&&!m&&this.settings.customBwEstimationEnabled){const g=new qC(this.listener,this.statsGatherer,this.diagnostics,this.logger.createChild("ach"),this.configProvider,this.settings,m);return this.currentResolution&&g.setCurrentResolution(this.currentResolution),g}return new zC(g,this.listener,this.statsGatherer,this.diagnostics,m)}onSendBandwidthChanged(g){return this.listener.onSendBandwidthChanged(g).catch((g=>{this.logger.safe.error("Error while reporting send bandwidth change",g),this.sendBandwidthCalculator.forceUpdate()}))}},YC=class extends Be{constructor(g,m,f,S,v,C){super(g),this.logger=g,this.multiParty=m,this.configProvider=f,this.mediaManager=S,this.statsGatherer=v,this.diagnostics=C,this.rendererResolutions=new Map,this.rendererResolutionsApplied=new Map,this.rendererResolutionMax=new Map,this.hasPendingLimitResolutionUpdate=!1}addRenderer(g){this.rendererResolutions.set(g,{width:0,height:0}),g.on("onRendererSizeChanged",((g,m)=>{this.onRendererSizeChanged(g,m)})),this.scheduleUpdateLimitedResolutions()}removeRenderer(g){this.rendererResolutions.delete(g),this.rendererResolutionsApplied.delete(g),this.rendererResolutionMax.delete(g),this.scheduleUpdateLimitedResolutions()}clearRenderers(){this.rendererResolutions.clear(),this.rendererResolutionsApplied.clear(),this.rendererResolutionMax.clear()}getMaxAllowedVideoFS(){const g=this.getMaxHeightFromConfig(this.renderersCount);return this.getMaxFSForHeight(g)}limitResolutionOnPoorPerformance(g){const m=this.getRendererByMsi(g);if(!m)return;const f=m.resolution.height>m.resolution.width,S=jp.Recv.getNextLowerResolution(m.resolution.width,m.resolution.height);if(!S)return void this.logger.safe.info("Poor perf. Lowest resolution reached. Not limiting resolution");const v={width:f?S.height:S.width,height:f?S.width:S.height};this.rendererResolutionMax.set(m.renderer,v),this.diagnostics?.registerResolutionChanageRequest({ts:Date.now(),msi:m.renderer.getMsi(),res:v}),this.logger.safe.info(`Poor perf. Limiting resolution for renderer msi: ${m.renderer.getMsi()} from ${m.resolution.height}p to ${v.height}p`),this.onRendererSizeChanged(m.renderer,v)}get renderersCount(){return this.rendererResolutions.size}getMaxFSForHeight(g){return this.limitMaxFS(jp.Recv.getResolutionForHeight(g).fs)}getRendererByMsi(g){for(const[m,f]of this.rendererResolutions.entries())if(m.getMsi()===g)return{renderer:m,resolution:f};return null}applyRendererResolution(g,m){this.setMaxFSCapabilities(g,m),this.rendererResolutionsApplied.set(g,m);const f=g.getMediaStream()&&g.getMediaStream().getVideoTracks();f?.[0]&&this.statsGatherer.setPreferredResolution(f[0].id,m,g.getModality())}onRendererSizeChanged(g,m){this.rendererResolutions.set(g,m),this.scheduleUpdateLimitedResolutions()}scheduleUpdateLimitedResolutions(){this.hasPendingLimitResolutionUpdate||(this.hasPendingLimitResolutionUpdate=!0,window.setTimeout((()=>{this.hasPendingLimitResolutionUpdate=!1;const g=this.groupMaxRenderersResolutionsByMsi();this.logger.safe.info(`Updating resolution limits: renderers count ${this.renderersCount}`),this.spotlightedRenderer=this.findSpotlightedRenderer(),this.spotlightedRenderer&&this.logger.safe.info(`Spotlighted renderer: ${this.spotlightedRenderer.getMsi()}`);for(const[m,f]of this.rendererResolutions.entries()){if(!f.height)continue;const S=g.get(m.getMsi()),v=this.limitRendererResolution(m,S||f),C=this.rendererResolutionsApplied.get(m);(!C||C.height!==v.height||C.width!==v.width)&&this.applyRendererResolution(m,v)}}),this.configProvider.config.multiviewResolutionLimitUpdateThrottleDelay))}findSpotlightedRenderer(){if(1===this.renderersCount||!this.configProvider.config.isSpotlightEnabled)return;let g,m=0,f=0;for(const[S,v]of this.rendererResolutions.entries()){if(!v.height)continue;f++;const C=jp.Recv.getMaxFS(v.width,v.height);C>m?(g=S,m=C):C===m&&(g=void 0)}return f<=1?void 0:g}getMaxHeightFromConfig(g,m=!1){return m?this.configProvider.config.maxSpotlightResolution:this.configProvider.config.multiviewResolutionLimits[`${g}`]||this.configProvider.config.multiviewResolutionLimits.more}getMaxHeight(g){const m=this.spotlightedRenderer?.getMsi()===g.getMsi();let f=this.getMaxHeightFromConfig(this.renderersCount,m);const S=this.rendererResolutionMax.get(g);return S&&(f=Math.min(f,Math.min(S.height,S.width))),f}limitRendererResolution(g,m){const f=this.getMaxHeight(g);if(!f)return m;if(m.height>m.width&&m.width>f){const g=f/m.width;return{height:Math.ceil(m.height*g),width:f,limited:!0}}if(m.width>m.height&&m.height>f){const g=f/m.height;return{height:f,width:Math.ceil(m.width*g),limited:!0}}return m}setMaxFSCapabilities(g,m){const f=g.getMediaStream();if(!f)return void this.logger.safe.warn("renderer has no stream attached");const S=this.mediaManager.getMediaEntityByRemoteStreamId(f.id);if(!S?.getLocalRecvCapabilities())return void this.logger.safe.warn(`no capabilities for provided modality: ${g.getModality()}`);const v=m.limited?this.getMaxFSForHeight(m.height):this.getMaxFS(m.width,m.height),C=S.getLocalRecvCapabilities();C.setMaxFS(v,(()=>{if(this.logger.safe.info(`updated max-fs video capability to ${v} for renderer msi: ${g.getMsi()}`),this.multiParty&&this.configProvider.config.webrtcMultiPartyRecvVideoSignaling){const m=g.getMsi(),f=Number(S.getXSourceStreamId()),v=C.buildFmtp();this.event("onSourceRequestRequired").raise(S.getModality(),f,m,v)}else this.event("onNegotiationRequired").raise()}))}getMaxFS(g,m){return this.limitMaxFS(jp.Recv.getMaxFS(g,m))}limitMaxFS(g){return this.multiParty?Math.min(g,this.configProvider.config.webrtcMultiPartyRecvVideoMaxFS):Math.min(g,this.configProvider.config.webrtcRecvVideoMaxFS)}groupMaxRenderersResolutionsByMsi(){const g=new Map;return this.rendererResolutions.forEach(((m,f)=>{const S=f.getMsi(),v=g.get(S);(!v||m.width>v.width&&m.height>v.height)&&g.set(S,m)})),g}},QC=class extends Be{constructor(g,m){super(),this.configProvider=g,this.getModality=m,this.isRendering=!1,this.currentFreezeDuration=0,this.mediaStarted=!1,this.lastBytesRecv=0,this.currentLowBitrateDuration=0}captureRawStatistics(g){const m=g.googFrameRateDecoded,f=g.googFrameRateReceived,S=g.bytesReceived;void 0!==S&&this.getModality()!==je.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateBitrate(S,m),m>0&&(this.mediaStarted=!0),0===m||0===f?this.currentFreezeDuration+=je.TIME_INTERVAL.SEC_1:m>0&&(void 0===f||f>0)&&(this.currentFreezeDuration=0);const v=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(v)}updateRenderingTracker(g){const m=g.extensions.frameRateDecoded||0,f=g.extensions.frameRateReceived||0,S=g.extensions.bitrate;void 0!==S&&this.getModality()!==je.MODALITY.sharing&&this.configProvider.config.isBytesRecvUsedInIsRenderingCalculation&&this.calculateLowBitrateDuration(S,m),m>0&&(this.mediaStarted=!0),0===m||0===f?this.currentFreezeDuration+=je.TIME_INTERVAL.SEC_1:m>0&&(void 0===f||f>0)&&(this.currentFreezeDuration=0);const v=this.configProvider.config.notRenderingTimeInterval[this.getModality()];this.setIsRendering(v)}calculateLowBitrateDuration(g,m){g/1e3<this.configProvider.config.notRenderingLowBitrateThreshold&&m<this.configProvider.config.notRenderingLowFramerateThreshold?this.currentLowBitrateDuration++:this.currentLowBitrateDuration=0}calculateBitrate(g,m){const f=8*(g-this.lastBytesRecv);this.lastBytesRecv=g,this.calculateLowBitrateDuration(f,m)}setIsRendering(g){const m=this.currentFreezeDuration<g&&this.currentLowBitrateDuration<g&&this.mediaStarted;m!==this.isRendering&&(this.isRendering=m,this.event("onIsRenderingChanged").raise(this.isRendering))}},XC=class extends Be{constructor(g,m,f){super(),this.videoElement=g,this.configProvider=m,this.getTimeToFirstFrame=f,this.prevCurrentTime=0,this.prevDecodedFrameCount=0,this.prevTimestamp=Date.now(),this.currentFreezeDuration=0,this.freezeDurationTimer=window.setInterval((()=>{this.calcFreezeDurationMs()}),this.configProvider.config.freezeIntervalFrequency)}calcFreezeDurationMs(){const g=this.videoElement.currentTime,m=g===this.prevCurrentTime,f=this.videoElement.webkitDecodedFrameCount,S=void 0===f||f===this.prevDecodedFrameCount;this.prevCurrentTime=g,this.prevDecodedFrameCount=f;if(-1!==this.getTimeToFirstFrame())if(m&&S){const g=Date.now();this.currentFreezeDuration+=g-this.prevTimestamp,this.prevTimestamp=g}else{if(this.currentFreezeDuration>this.configProvider.config.freezeMinDuration){const g=this.calcFreeze();this.event("onFreezeEnded").raise(g)}this.currentFreezeDuration=0}this.prevTimestamp=Date.now()}getEndOfTheFreeze(){let g=0;return this.currentFreezeDuration>0&&(g=this.calcFreeze(),this.currentFreezeDuration=0),g}dispose(){const g=this.getEndOfTheFreeze();this.event("onFreezeEnded").raise(g),clearInterval(this.freezeDurationTimer)}calcFreeze(){const g=Date.now()-this.prevTimestamp;return this.currentFreezeDuration+g}},ZC=class extends Hp{constructor(g,m,f,S,v,C){super(v,g.createChild("remote"),m),this.diagnostics=f,this.subscriptionManager=S,this.sessionDiagnostics=C,this.disposed=!1,this.currentIsRendering=!1,this.startTimeTTFF=0,this.timeToFirstFrame=-1,this.isTimeToFirstFrameReported=!1,this.configProvider.config.freezeIntervalFrequency&&(this.freezeTracker=new XC(this.getVideoElement(),this.configProvider,(()=>this.timeToFirstFrame)),this.freezeTracker.on("onFreezeEnded",(g=>{this.diagnostics?.addFreezeDuration(g),this.event("onFreezeEnded").raise(g)}))),this.configProvider.config.isRenderingBasedOnRawStatistics&&(this.isRenderingTracker=new QC(this.configProvider,this.getModality.bind(this)),this.isRenderingChangedSubscription=this.isRenderingTracker.on("onIsRenderingChanged",(g=>{this.setIsRendering(g)}))),this.overlayStats=createRemoteRendererStatsOverlay(this.configProvider.config.showStatsInCall,v,this)}getEndOfTheFreeze(){return this.freezeTracker?.getEndOfTheFreeze()}resetTimeToFirstFrameFlag(){this.isTimeToFirstFrameReported=!1}setIsRendering(g){this.currentIsRendering!==g&&(this.currentIsRendering=g,this.captureIsRenderingEvent(g))}captureRawStatistics(g){this.configProvider.config.isRenderingBasedOnRawStatistics&&this.isRenderingTracker?.captureRawStatistics(g)}updateStatsOverlay(g){this.overlayStats.setStats(g)}updateIsRenderingTracker(g){this.isRenderingTracker?.updateRenderingTracker(g)}subscribeVideoAsync(g,m){return this.timeToFirstFrameSinceSubscriptionStart=Date.now(),new Promise(((f,S)=>{this.modality=m?je.MODALITY.sharing:je.MODALITY.video,this.diagnostics&&(this.diagnostics.msi=g,this.diagnostics.modality=this.modality),this.trackElementSizeChange(),this.unsubscribe(),this.sessionDiagnostics&&this.modality===je.MODALITY.video&&(this.on("onVideoSizeChanged",((m,f)=>{if(this.sessionDiagnostics.registerResolutionChanageEvent({ts:Date.now(),msi:g,res:{width:m,height:f}}),!this.isTimeToFirstFrameReported){if(-1===this.timeToFirstFrame){const g=Date.now();this.timeToFirstFrame=g-this.startTimeTTFF,this.timeToFirstFrameSinceSubscriptionStart=Date.now()-this.timeToFirstFrameSinceSubscriptionStart}const g=this.getTrackId();g&&(this.diagnostics.timeToFirstFrameSinceSubscriptionStart=this.timeToFirstFrameSinceSubscriptionStart,this.diagnostics.timeToFirstFrame=this.timeToFirstFrame,this.sizeTracker?.triggerVideoElementSizeChange(),this.event("onVideoStarted").raise(this.timeToFirstFrame,this.timeToFirstFrameSinceSubscriptionStart,g),this.isTimeToFirstFrameReported=!0)}})),this.on("onVideoRendererStateChanged",(g=>{this.diagnostics.addStateChange(g)})));const v=this.subscriptionManager.subscribeVideo(this.modality,g);this.subscription=v,this.logger.safe.info(`subscribing renderer to type: ${v.modality} msi: ${v.msi}`),v.setOnMediaStreamChangedHandler((g=>{const m=this.getMediaStream();this.attachMediaStream(g),g&&(this.startTimeTTFF=Date.now());const S=this.getTrackId();S&&this.diagnostics&&(this.diagnostics.trackId=S),this.logger.safe.info(`subscribed renderer to type: ${v.modality} msi: ${v.msi} on stream #${g?g.id:"none"}`),g&&m!==g&&this.sizeTracker?.triggerVideoElementSizeChange(),f()})),v.setOnErrorHandler((m=>{this.logger.safe.error(`failed to subscribe renderer ${stringifyObject(m)}`),"webRtcSession cleanup"===JSON.stringify(m)&&(this.logger.safe.info(`Retry to subscribe to video stream with msi: ${g}. Previous session was cleaned up`),this.subscriptionManager.streamChangedByMsi(g),f()),S(m)}))}))}dispose(){this.disposed?this.logger.safe.warn("renderer already disposed"):(this.disposed=!0,this.logger.safe.info("disposing"),this.unsubscribe(),this.captureIsRenderingEvent(!1),this.freezeTracker?.dispose(),this.isRenderingChangedSubscription?.dispose(),this.overlayStats.dispose(),this.diagnostics?.dispose(),this.event("onRendererDisposed").raise(this),super.dispose())}getModality(){return this.modality}getMsi(){return this.subscription?.msi??Sv.SourceNone}getLocalMsi(){return this.subscription?.localMsi}getCurrentResolution(){return this.resolution??{width:0,height:0}}unsubscribeNow(){this.subscription?.unsubscribe(),this.subscription=null}trackElementSizeChange(){const g=this.modality===je.MODALITY.sharing,m=g?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMin:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMin,f=g?this.configProvider.config.webrtcScreensharingCapabilityCheckIntervalMax:this.configProvider.config.webrtcVideoCapabilityCheckIntervalMax;m&&f?(this.sizeTracker=new Wp(this.getVideoElement(),m,f,this.configProvider.config.enableDevicePixelRatio),this.sizeTracker.changed((()=>this.onSizeTrackerChanged()))):this.logger.safe.info("skipping video size tracking")}onSizeTrackerChanged(){this.resolution={width:this.sizeTracker.width,height:this.sizeTracker.height},this.logger.safe.info(`video renderer size changed to ${this.resolution.width}x${this.resolution.height}`),this.diagnostics&&(this.diagnostics.rendererSize=this.resolution),this.event("onRendererSizeChanged").raise(this,this.resolution)}unsubscribe(){this.subscription?.dispose(),this.subscription=null}captureIsRenderingEvent(g){this.diagnostics&&(this.diagnostics.isRendering=g),this.event("onIsRenderingChanged").raise(g,this.getModality(),this.getTrackId())}},e_=class{constructor(g,m,f,S,v,C){this.logger=g,this.configProvider=m,this.statsGatherer=f,this.sessionDiagnostics=S,this.remoteVideoResolutionManager=v,this.domOverrides=C,this.remoteRendererSubscriptions=new Map,this.statSubs=[],this.diagnostics=S?.newRemoteVideoManagerDiagnostics(),this.subscribeToStatisticsChanged()}createRenderer(g,m,f){const S=new ZC((f??this.logger).createChild("videorenderer"),this.configProvider,this.diagnostics?.newRendererDiagnostics(),m,g,this.sessionDiagnostics);return this.domOverrides.onMediaElementAdded&&this.domOverrides.onMediaElementAdded(S.getVideoElement()),this.addRenderer(S),S}moveRenderers(g){this.renderers.forEach((m=>{m.resetTimeToFirstFrameFlag(),g.addRenderer(m),this.removeRenderer(m)}))}getMaxAllowedVideoFS(){return this.remoteVideoResolutionManager.getMaxAllowedVideoFS()}dispose(){this.renderers.forEach((g=>g.resetTimeToFirstFrameFlag())),this.renderers.forEach((g=>{const m=g.getTrackId(),f=g.getEndOfTheFreeze();this.statsGatherer.setFreezeDuration(f,m)})),this.remoteRendererSubscriptions.forEach(((g,m)=>{m.dispose(),g.forEach((g=>g.dispose()))})),this.remoteRendererSubscriptions.clear(),this.remoteVideoResolutionManager.clearRenderers(),this.statSubs.forEach((g=>g.dispose()))}get renderers(){return Array.from(this.remoteRendererSubscriptions,(([g])=>g))}addRenderer(g){this.remoteRendererSubscriptions.set(g,this.subscribeOnEvents(g)),this.logger.safe.info("Added renderer to manager"),this.remoteVideoResolutionManager.addRenderer(g)}subscribeToStatisticsChanged(){this.configProvider.config.isRenderingBasedOnRawStatistics?this.configProvider.config.diagnostics.sideBySide&&this.configProvider.config.isRenderingBasedOnRawStatistics?this.statSubs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.onDiagnosticUpdated(g)))):this.statSubs.push(this.statsGatherer.on("onRawStatisticsChanged",(g=>this.processRawStats(g)))):this.statSubs.push(this.statsGatherer.on("onStatisticsChanged",(g=>this.processStats(g)))),this.statSubs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.updateOverlayStats(g))))}generateSSRCStats(g){const m=new Map;return forOwn(g.ssrc,(g=>{m.set(g[SC],g)})),m}generateVideoRecvStats(g){const m=new Map,processRecvStats=g=>{g?.forEach((g=>{const f=g.track?.trackIdentifier??g.inboundRTP.trackIdentifier;m.set(f,g)}))};return processRecvStats(g.sharing?.recv),processRecvStats(g.video?.recv),m}updateOverlayStats(g){const m=this.generateVideoRecvStats(g);this.renderers.forEach((g=>{const f=g.getTrackId();m.has(f)&&g.updateStatsOverlay(m.get(f))}))}processStats(g){this.renderers.forEach((m=>{const f=m.getTrackId();if(g.remoteVideoStreams[f]){const S=g.remoteVideoStreams[f].isRendering;void 0!==S&&m.setIsRendering(S)}}))}onDiagnosticUpdated(g){const m=[...g.video?.recv??[],...g.sharing?.recv??[]];if(m.length){const g=new Map;m.forEach((m=>{g.set(m.track?.trackIdentifier,m)})),this.renderers.forEach((m=>{const f=m.getTrackId();g.has(f)&&m.updateIsRenderingTracker(g.get(f))}))}}processRawStats(g){const m=this.generateSSRCStats(g);this.renderers.forEach((g=>{const f=g.getTrackId();m.has(f)&&g.captureRawStatistics(m.get(f))}))}subscribeOnEvents(g){return[g.on("onRendererDisposed",(g=>this.onRendererDisposed(g))),g.on("onVideoStarted",((g,m,f)=>this.onVideoStarted(g,m,f))),g.on("onFreezeEnded",(m=>{const f=g.getTrackId();this.statsGatherer.setFreezeDuration(m,f)})),g.on("onIsRenderingChanged",((g,m,f)=>this.statsGatherer.setIsRendering(g,m,f)))]}onRendererDisposed(g){this.logger.safe.debug("Renderer removed from manager"),this.removeRenderer(g),this.domOverrides.onMediaElementRemoved&&this.domOverrides.onMediaElementRemoved(g.getVideoElement())}removeRenderer(g){this.remoteRendererSubscriptions.get(g).forEach((g=>g.dispose())),this.remoteRendererSubscriptions.delete(g),this.remoteVideoResolutionManager.removeRenderer(g)}onVideoStarted(g,m,f){this.statsGatherer.setTimeToFirstFrame(g,m,f)}},t_=class extends Be{constructor(g,m,f,S){super(),this.statisticsGatherer=g,this.configProvider=f,this.callDevicemanager=S,this.statisticsGathererSubscription=null,this.lastFramerateInput=-1,this.trackInfo=[],this.timeoutId=null,this.logger=m.createChild("localStreamWatcher"),this.callDeviceManagerSub=S.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, updating sunscriptions"),this.handleDeviceManagerChange()}))}get effectsManager(){return this.callDevicemanager.getDeviceManager("Video").effectsManager}startWatching(g){this.trackInfo=g,this.configProvider.config.videoCaptureFreezeTimeout&&(this.statisticsGathererSubscription||(this.statisticsGathererSubscription=this.statisticsGatherer.on("onStatisticsChanged",(g=>this.onStatisticsChanged(g)))),this.videoEffectManagerSubscription||(this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(g=>this.onVideoFreezeDetected(g)))))}stopWatching(){this.trackInfo=[],this.statisticsGathererSubscription&&(this.statisticsGathererSubscription.dispose(),this.statisticsGathererSubscription=null),this.videoEffectManagerSubscription&&(this.videoEffectManagerSubscription.dispose(),this.videoEffectManagerSubscription=null),0!==this.lastFramerateInput||this.timeoutId||this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")),this.disposeTimer(),this.lastFramerateInput=-1}dispose(g){this.callDeviceManagerSub?.dispose(),super.dispose(g),this.stopWatching()}onStatisticsChanged(g){if(!this.trackInfo.length)return;let m;Object.keys(g.localVideoStreams).forEach((f=>{const S=g.localVideoStreams[f];this.trackInfo.some((g=>g.trackId===S.trackId))&&(!m||m.frameRateInput<S.frameRateInput)&&(m=S)})),m?m.frameRateInput!==this.lastFramerateInput&&(0===m.frameRateInput?this.scheduleCaptureFreezeStart(m.trackId,!this.effectsManager.isEffectEnabled("Video")):0===this.lastFramerateInput&&(this.timeoutId?this.disposeTimer():(this.logger.info(`onVideoCaptureFreeze end for trackId: ${m.trackId}`),this.event("onVideoCaptureFreeze").raise(!1,!this.effectsManager.isEffectEnabled("Video")))),this.lastFramerateInput=m.frameRateInput):this.logger.safe.warn("WebRTC Stats for send video not found")}onVideoFreezeDetected(g){this.logger.info(`onVideoCaptureFreeze, webcam freeze detected trackId: ${g}`),this.event("onVideoCaptureFreeze").raise(!1,!0)}scheduleCaptureFreezeStart(g,m){this.timeoutId=window.setTimeout((()=>{this.timeoutId=null,this.logger.info(`onVideoCaptureFreeze start for trackId: ${g}`),this.event("onVideoCaptureFreeze").raise(!0,m)}),this.configProvider.config.videoCaptureFreezeTimeout)}disposeTimer(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null)}handleDeviceManagerChange(){this.videoEffectManagerSubscription?.dispose(),this.videoEffectManagerSubscription=this.effectsManager.on("videoFreezeDetected",(g=>this.onVideoFreezeDetected(g)))}},i_=class{constructor(g,m,f,S,v,C,_){this.mediaStream=g,this.receiver=m,this.modality=f,this.sourceStreamId=S,this.controller=v,this.videoCapabilties=C,this.getMaxAllowedVideoFS=_,this.msi=Sv.SourceNone,this.operations=Promise.resolve()}dispose(){this.receiver=null,this.mediaStream=null}getId(){return this.mediaStream.id}getModality(){return this.modality}getMsi(){return this.msi}getMediaStream(){return this.mediaStream}getReceiver(){return this.receiver}getSourceStreamId(){return this.sourceStreamId}requestSource(g){this.msi=g;const m=this.operations.then((()=>{let m;return this.videoCapabilties&&(this.videoCapabilties.resetToInitial(),this.getMaxAllowedVideoFS&&this.videoCapabilties.setMaxFS(Math.min(this.getMaxAllowedVideoFS(),this.videoCapabilties.getMaxFS())),m=this.videoCapabilties.buildFmtp(),this.videoCapabilties.resetToInitial()),this.controller.requestSource(this.modality,this.sourceStreamId,g,m)}));return this.operations=m.catch((()=>{})),m}},n_=class{constructor(g){this.queue=[],this.logger=g}cleanup(){this.queue.forEach((g=>{g.reject({notSent:g.tones})})),this.queue=[]}waitForNotification(g){return g?(this.logger.unsafe.info("sending dtmf tones: ",g),new Promise(((m,f)=>{this.queue.push({tones:g,resolve:m,reject:f})}))):Promise.reject(new Error("invalid input"))}toneSent(g){this.queue[0]&&(g===this.queue[0].tones[0]?(this.queue[0].tones=this.queue[0].tones.substr(1),""===this.queue[0].tones&&(this.queue[0].resolve(),this.queue.shift())):(this.queue[0].reject(new Error(`sent tone does not match: expected '${this.queue[0].tones[0]}' got '${g}'`)),this.queue.shift(),this.toneSent(g)))}},r_=class{constructor(g){this.webRtcSender=null,this.configProvider=g.configProvider,this.queue=new n_(g.logger)}sendDtmf(g,m){return g&&g.getSenders?(this.syncSender(g),this.webRtcSender?(this.webRtcSender.ontonechange=this.onToneChange.bind(this),this.webRtcSender.insertDTMF(this.webRtcSender.toneBuffer+m,this.configProvider.config.dtmf.toneDuration,this.configProvider.config.dtmf.toneGap),this.queue.waitForNotification(m)):Promise.reject(new Error("not available"))):Promise.reject(new Error("bad peerConnection"))}canSendDtmf(g){return!(!g||!g.getSenders)&&(this.syncSender(g),!!this.webRtcSender&&this.webRtcSender.canInsertDTMF)}dispose(){this.queue.cleanup()}syncSender(g){const m=g.getSenders().filter((g=>g.track&&"audio"===g.track.kind)).filter((g=>g.dtmf&&g.dtmf.canInsertDTMF))[0];this.webRtcSender&&m&&m.dtmf!==this.webRtcSender&&(this.webRtcSender.ontonechange=null,this.queue.cleanup()),this.webRtcSender=m?m.dtmf:null}onToneChange(g){g.tone&&this.queue.toneSent(g.tone)}},s_={build:g=>new r_(g)},a_=0,o_=class _WebRtcSession{constructor(g,m,f){this.context=g,this.callId=m,this.callback=f,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc-"+ ++a_),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.webrtcAdapter=NC.build({global:this.context.maContext,configProvider:this.configProvider}),this.iceHostCandidateOnly=this.multiParty&&getFrom("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new BC({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:!1}),this.sessionDescription=wS.build({sdpTransform:new this.webrtcAdapter.SdpTransform(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=getFrom("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new vv({streamAdded:g=>this.streamAdded(g),streamRemoved:g=>this.streamRemoved(g)}),this.stats=new yC(this.logger.createChild("stats"),this.configProvider,void 0,this.mediaManager,this.multiParty),this.maxResolution=this.multiParty?jp.Send.getResolutionByFs(this.configProvider.config.webrtcMultipartyMaxScalingFs):jp.Send.getResolutionByFs(this.configProvider.config.webrtcMaxScalingFs),this.qualityManager=new JC(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,cooldownTimeout:this.configProvider.config.webrtcResolutionManagerCooldownTimeout,retryDelay:this.configProvider.config.webrtcResolutionManagerRetryDelay,maxResolution:this.maxResolution,customBwEstimationEnabled:!0,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},{onReceiveCapabilitiesChanged:(g,m,f)=>this.applyCapabilitiesForModality(g,m,f),onSendBandwidthChanged:g=>this.onSendBandwidthChanged(g)},this.stats,void 0,this.configProvider),this.localVideoStreamWatcher=new t_(this.stats,this.logger,this.configProvider,this.context.callDeviceManager),this.activeSpeakerManager=new pv(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,null,this.logger.createChild("ActiveSpeakerManager")),this.senders={},this.negotiationQueue=new Lp(this.logger),this.negotiationEmulator=new $C(this.logger.createChild("negotiationEmulator"),this.webrtcAdapter.RTCSessionDescription,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.toBeCalledAfterConnected=[],this.iceTransportPolicy=this.configProvider.config.iceTransportPolicyForced||this.context.config.iceTransportPolicy||je.ICE_TRANSPORT_POLICY.all,this.isMuteHold=!1,this.peerConnection=null,this.mediaStreams=new Map,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Sr,this.relayCandidateGathered=!1,this.iceCandidatesTimer=null,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=s_.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=getFrom("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new _v(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:g=>this.onStreamsChanged(g)}),this.remoteVideoResolutionManager=new YC(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.stats),this.remoteVideoManager=new e_(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.stats,void 0,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Sr,this.ssrcGenerator=new fv,this.ssrcs={Audio:this.getSsrcRangeForMediaType("Audio"),Video:this.getSsrcRangeForMediaType("Video"),ScreenShare:this.getSsrcRangeForMediaType("ScreenShare")},this.forceKeyFramePromise=null,this.ufdManager=g.getUfdManager(),this.stats.on("onStatisticsChanged",(g=>{this.updateQualityLevels(g)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((g,m,f,S)=>this.requestSource(g,m,f,S))),this.setSubsForSubscriptionManager(),this.localVideoStreamWatcher.on("onVideoCaptureFreeze",(g=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",g?"Bad":"Good","Video")})),this.configProvider.mediaConfig.maxBandwidthInKbps&&this.stats.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.createAudioRenderer(),this.configProvider.config.webrtcVideoScaling&&this.onOptimalVideoReceiversCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount)}get audioStream(){return this.mediaStreams.get("Audio")}get videoStream(){return this.mediaStreams.get("Video")}get displayStream(){return this.mediaStreams.get("ScreenShare")}useNullAudioStreamClient(){}getIncomingRawAudioStream(){return null}configureSpatialAudio(g,m){}setParticipantSpatialAudioPositions(g,m){}getAcceptedTypes(){return this.allowedMediaContentType}clone(g=!1){const m=shallowClone(this.context);m.config=shallowClone(this.context.config),m.config.webrtcMediaContentType=this.mediaContentType,m.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,g?m.config.isConference=!0:(m.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(m.config.webrtcIceGatheringTimeoutIncreased=!0));const f=new _WebRtcSession(m,this.callId,this.callback);return this.relayManagerProvider&&(f.relayManagerProvider=this.relayManagerProvider),f.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,f}setInternals(g){if(g.extensionsManager&&this.extensionsManager){const m=g.extensionsManager.getExtension("videoStreamControl");m&&m.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",m.getOptions())}g.subscriptionManager&&(this.subscriptionManager&&this.subscriptionManager.dispose(),this.subscriptionManager=g.subscriptionManager,this.subscriptionManager.setStreamProvider({getStreams:()=>this.getStreams(),setOnStreamsChangedHandler:g=>this.onStreamsChanged(g)}),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),g.audioRenderer&&(g.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=g.audioRenderer),g.remoteVideoManager&&g.remoteVideoManager.moveRenderers(this.remoteVideoManager)}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(g=>this.stats.setSubscribedTrackIds(g))),this.subscriptionManager.on("onTrackSsrcChanged",(g=>this.stats.setSubscribedTrackSsrc(g))),this.subscriptionManager.on("onSubscriptionChanged",((g,m,f,S,v,C)=>this.stats.addSubscriptionEvent(g,m,f,S,null,v,C))),this.subscriptionManager.on("onSubscriptionFailed",((g,m,f,S,v)=>this.stats.addSubscriptionEvent(g,m,f,S,v)))]}move(g,m){g.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager}),g.muteHold(this.isMuteHold,m),this.doAudioMute?g.muteInputAsync(m):g.unmuteInputAsync(m),this.subscriptionManager=null,this.audioRenderer=null,this.callbacks.onTerminated=null}setMute(g,m,f){this.logger.safe.info(`[${f}] call setMuteAsync with mute state ${m}, audio stream exists: ${!!this.audioStream}`),"Audio"===g&&this.audioStream?this.audioStream.setMuted(m,f):"Video"===g&&this.videoStream?this.videoStream.setMuted(m,f):"ScreenShare"===g&&this.displayStream&&this.displayStream.setMuted(m,f),this.updateQualityLevels(this.stats.getLastStatistics())}setCallConstraints(g,m){return Promise.reject(new Error("Not supported"))}configureModalitiesAsync(g,m){const f=this.configuredModalitiesPromise.then((()=>{if(!g||!g.audio&&!g.video&&!g.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(g)}`);const f=!this.configuredModalities||!areNegotiatedDirectionsFulfilled(g,this.negotiatedModalities);return this.configuredModalities=g,this.logger.safe.info(`[${m}] configure modalities`,`audio: ${g.audio}`,`video: ${g.video}`,`sharing: ${g.sharing}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?this.peerConnection.signalingState:"-"}`,`needNewRenegotiation: ${f}`),f&&this.triggerRenegotiation(!1,m),this.configuredModalities}));return this.configuredModalitiesPromise=f.catch((g=>{this.logger.safe.warn(`[${m}] Error during configuring modalities: ${stringifyObject(g)}`)})).then((()=>{})),f.then((()=>{}))}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}getSubscriptionManager(){return null}createAudioElement(g){}createOfferAsync(g){const m=this.negotiationQueue.add((()=>new Promise((m=>{this.logger.safe.info(`[${g}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,this.offeredModalities=this.negotiatingModalities,this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[je.MODALITY.data]&&this.multiParty&&(this.offeredModalities[je.MODALITY.data]=je.MEDIA_STATE.inactive),isOnHold(this.offeredModalities)&&!isEmpty(this.negotiatedModalities)&&Object.keys(this.offeredModalities).forEach((g=>{void 0===this.negotiatedModalities[g]&&delete this.offeredModalities[g]})),m(this.updatePeerConnectionStreamsAsync(this.offeredModalities,!0,!0,g).then((()=>{const m=this.createNegotiationConstraints(this.offeredModalities);return this.logger.safe.info(`[${g}] create [offer] offered: ${JSON.stringify(this.offeredModalities)} constraints: ${JSON.stringify(m)}`),this.peerConnection.createOffer(m)})).then((m=>{this.logger.unsafe.debug(`[${g}] create [offer] offer from peer connection`,"sdp:",m.sdp);const f=this.sessionDescription.createLocalOffer(m.sdp);this.hasIceCandidates(f)||this.resetCandidateGathering(g),this.stats.startWaitingForStreamStart(this.offeredModalities);const S=new this.webrtcAdapter.RTCSessionDescription({sdp:f.toLocal(),type:"offer"});return this.setupIceGatheringTimeout(g),Promise.all([this.peerConnection.setLocalDescription(S),this.iceCandidatesDeferred.promise])})).then((()=>{const m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);m.updateModalities(this.offeredModalities),this.checkIceCandidates(m);const f=m.toOffer();this.logger.unsafe.debug("CREATE OFFER","sdp:",f);const S={blob:f,contentType:this.mediaContentType};return""===this.configProvider.config.webrtcRequiredFeatures||this.multiParty||(S.requiredFeatures=this.configProvider.config.webrtcRequiredFeatures),this.configProvider.countryCode&&(S.clientLocation=this.configProvider.countryCode),this.doRetargetIfNeeded(S,m,g),S})))}))),g);return this.resetNegotiationQueue(g),m}processOfferAsync(g,m){const f=this.negotiationQueue.add((()=>new Promise((f=>{const S=g.blob;if(this.logger.unsafe.debug(`[${m}] process [offer]`,"sdp:",S),this.configProvider.config.webrtcCompareContentTypeInOffer&&(throwIfNotSupported(g.contentType,this.allowedMediaContentType),this.mediaContentType=g.contentType),g.requiredFeatures){const m=this.configProvider.config.webrtcRejectedFeatures.split(",");throwIfFeatureNotSupported(g.requiredFeatures.split(","),m)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(S),this.canTriggerRenegotiation=!1,this.offeredModalities=invertModalities(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let v=Promise.resolve(this.offeredModalities);if(hasSendDirectionality(this.offeredModalities.video)||hasReceiveDirectionality(this.offeredModalities.video)||hasSendDirectionality(this.offeredModalities.sharing)||hasReceiveDirectionality(this.offeredModalities.sharing)){const g=this.offeredDescription.getVideoCodecs();v=this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((f=>{if(!f.codecs.some((m=>g.some((g=>m.mimeType===g))))){this.logger.safe.warn(`[${m}] offer doesn't contain any supported video codecs`);const g=shallowClone(this.offeredModalities);return this.disabledModalities.video=g.video,this.disabledModalities.sharing=g.sharing,g.video=void 0,g.sharing=void 0,g}return this.offeredModalities})).catch((g=>(this.logger.safe.error(`[${m}] failed to get video capability ${stringifyObject(g)}`),this.offeredModalities)))}f(v.then((g=>(this.logger.safe.info(`[${m}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(g)}`),g))))}))),m);return this.resetNegotiationQueue(m),f}createAnswerAsync(g,m){return new Promise((f=>{if(g)return void f({blob:"",contentType:this.mediaContentType});this.logger.safe.info(`[${m}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for"),this.negotiatingModalities=this.configuredModalities;let S=negotiateModalities(this.offeredModalities,this.negotiatingModalities);const v=this.offeredDescription.clone();f(this.updatePeerConnectionStreamsAsync(S,!0,!1,m).then((()=>this.handleCodecSwitchUnsupported(m))).then((()=>{const g=this.offeredDescription.toRemote(S);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources();const f=new this.webrtcAdapter.RTCSessionDescription({sdp:g,type:"offer"});return this.updateDescriptor(f,v),this.logger.unsafe.info(`[${m}] create [answer] set remote description`,"negotiated:",S,"sdp:",f.sdp),this.peerConnection.setRemoteDescription(f)})).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.updatePeerConnectionStreamsAsync(S,!1,!0,m)))).then((()=>(this.handleSharingRecvCapabilities(v),this.handleVideoRecvCapabilities(v)))).then((()=>this.peerConnection.createAnswer())).then((g=>{this.logger.unsafe.debug(`[${m}] create [answer] answer from peer connection`,"sdp:",g.sdp);const f=this.sessionDescription.createLocalAnswer(g.sdp);this.hasIceCandidates(f)||this.resetCandidateGathering(m),this.stats.startWaitingForStreamStart(S);const v=new this.webrtcAdapter.RTCSessionDescription({sdp:f.toLocal(),type:"answer"});return this.setupIceGatheringTimeout(m),Promise.all([this.peerConnection.setLocalDescription(v),this.iceCandidatesDeferred.promise])})).then((()=>{const g=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);g.updateModalities(S),this.checkIceCandidates(g);const f=g.toAnswer();S=g.getModalities(),areNegotiatedDirectionsAcceptable(this.configuredModalities,this.negotiatingModalities,S)||this.triggerRenegotiation(!0,m),this.setNegotiatedModalities(S),this.stats.sessionInfo.setBweType(g.getBweType()),this.logger.unsafe.debug("CREATE ANSWER","sdp:",f);const v={blob:f,contentType:this.mediaContentType};return this.configProvider.countryCode&&(v.clientLocation=this.configProvider.countryCode),v})))}))}processAnswerAsync(g,m,f){const S=g.blob;if(this.logger.unsafe.debug(f?"PROCESS PRANSWER":"PROCESS ANSWER","sdp:",S),f)return this.logger.safe.info(`[${m}] process [pranswer] ignored`),Promise.resolve();this.mediaContentType=g.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType);const v=this.sessionDescription.createRemoteAnswer(S),C=v.clone(),_=invertModalities(v.getModalities());this.setNegotiatedModalities(_);const E=v.toRemote(this.negotiatedModalities);this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.registerMediaSources(),this.stats.sessionInfo.setBweType(v.getBweType());const T=new this.webrtcAdapter.RTCSessionDescription({sdp:E,type:"answer"});return this.updateDescriptor(T,C),this.logger.unsafe.info(`[${m}] process [answer] set remote description`,"negotiated:",this.negotiatedModalities,"sdp:",T.sdp),this.peerConnection.setRemoteDescription(T).then((()=>(this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized(),this.negotiatedModalities))).then((()=>(this.handleSharingRecvCapabilities(C),this.handleVideoRecvCapabilities(C)))).then((g=>{g&&this.triggerRenegotiation(!0,m)}))}completeNegotiationAsync(g){return new Promise((m=>{this.mediaManager.commit();const f=this.configuredModalities,S=this.forceMediaStreamUpdate&&!isOnHold(this.negotiatedModalities)||!areNegotiatedDirectionsAcceptable(f,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,v=!S;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${g}] negotiation completed isComplete: ${v} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),S&&this.triggerRenegotiation(!1,g),this.negotiationCompletedPromise.resolve();m({isComplete:v,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})}))}rejectNegotiationAsync(g,m,f=!1){return Promise.resolve().then((()=>{if(this.mediaManager.rollback(),this.logger.safe.warn(`[${m}] negotiation rejected isComplete: ${!f} error: ${stringifyObject(g)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.peerConnection){if("have-local-offer"===this.peerConnection.signalingState)return this.logger.safe.info(`[${m}] rolling back local description`),this.configProvider.config.webrtcHandleRollback?(this.logger.safe.info(`[${m}] rolling back using local renegotiation`),this.negotiationEmulator.renegotiateNow().then((()=>{this.logger.safe.info(`[${m}] rolling back using local complete`)}))):this.peerConnection.setLocalDescription(new this.webrtcAdapter.RTCSessionDescription({type:"rollback"}));this.logger.safe.error(`[${m}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`)}})).then((()=>{this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected");this.getAddedMediaTypes(this.negotiatedModalities,this.negotiatingModalities).forEach((g=>{this.removeTrackByMediaType(g),this.disposeStreamByMediaType(g)})),this.registerLocalStreams()})).then((()=>(f&&(this.logger.safe.info(`[${m}] retrying failed negotiation`),this.triggerRenegotiation(!1,m)),{isComplete:!f,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator})))}startMediaDescriptionsUpdateAsync(g){return Promise.reject(new Error("Not supported"))}completeMediaDescriptionsUpdateAsync(g){return Promise.reject(new Error("Not supported"))}rejectMediaDescriptionsUpdateAsync(g,m){return Promise.reject(new Error("Not supported"))}createRemoteRenderer(g){return this.remoteVideoManager.createRenderer(g,this.subscriptionManager,this.logger)}getStatsAsync(g){return this.terminated||(this.statisticsReport=this.statisticsReport.then((()=>this.stats.getReport(g))).catch((g=>(this.logger.safe.error(`getting statistics should never fail: ${g.error}`),g.partialReport)))),this.statisticsReport}getLastKnownStats(g=!1){return this.stats.getReport(!1,g)}muteHold(g,m){this.isMuteHold=g;const f=[je.MODALITY.audio,je.MODALITY.video,je.MODALITY.sharing].filter((g=>hasSendDirectionality(this.negotiatedModalities[g])&&(g!==je.MODALITY.audio||!this.doAudioMute)));for(const S of f)this.setMute(modalityToMediaType(S),g,m)}async muteInputAsync(g){this.doAudioMute=!0,this.setMute("Audio",!0,g)}async unmuteInputAsync(g){this.doAudioMute=!1,this.setMute("Audio",!1,g)}muteOutputAsync(g){return this.audioRenderer.setMuted(!0,g),Promise.resolve()}unmuteOutputAsync(g){return this.audioRenderer.setMuted(!1,g),Promise.resolve()}sendDtmf(g){return this.dtmfSender.sendDtmf(this.peerConnection,g)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(g=generateCauseId()){const m=new Sr;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(m,g)})),m}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(g){this.stats.onDeviceEvent(g)}deviceSelectionChanged(){this.peerConnection&&(this.audioRenderer&&this.audioRenderer.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),isOnHold(this.negotiatedModalities)||(this.forceMediaStreamUpdate=!0,this.triggerRenegotiation(!0)))}async terminate(g,m,f=!0){this.logger.safe.info(`[${g}] terminate`),this.stats.setTerminated(),this.canTriggerRenegotiation=!1,this.cleanUp(g);try{f&&await this.getStatsAsync(!1)}catch(m){this.logger.safe.error(`[${g}] Error while gathering stats ${stringifyObject(m)}`)}finally{this.stats.dispose(),this.terminated=!0}}processNotification(g,m){this.extensionsManager.processNotification(g,m)}cleanUp(g){this.negotiationQueue.dispose(),this.localVideoStreamWatcher.dispose(),this.remoteVideoManager.dispose(),this.resetPeerConnection(g),this.subscriptionManagerSubs.forEach((g=>g.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(g){this.logger.safe.info(`[${g}] reset peer connection`),this.audioRenderer&&this.audioRenderer.dispose(),this.dtmfSender&&(this.dtmfSender.dispose(),this.dtmfSender=null),this.peerConnection&&this.peerConnection.close(),this.toBeCalledAfterConnected=[],this.disposeStreams(),this.peerConnection=null,this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(g),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(g=generateCauseId()){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Sr,g)}setNegotiationPromise(g,m=generateCauseId()){this.terminated||(this.negotiationCompletedPromise=g,this.negotiationQueue.add(this.negotiationCompletedPromise,m))}setupExtensionsManager(){const g=new sy(this.logger.createChild("ExtMgr"));return g.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),g.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,configProvider:this.configProvider,statisticsGatherer:this.stats}),g}updateQualityLevels(g){if(!g)return;this.hwSilent!==g.audioHwSilent&&(this.hwSilent=g.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",g.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:g.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",g.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:g.networkSendLevel});const m=!(!g.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",m?"Bad":"Good")}triggerRenegotiation(g,m=generateCauseId()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${m}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(m)):g&&(this.logger.safe.info(`[${m}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(g){if(!this.configuredModalities)throw new Error(g)}addTrack(g,m,f){if(!g)return;const S=this.modalityByMediaType(f);if(this.logger.safe.info(`add media track kind: ${g.kind} id: ${g.id}`),this.senders[S])throw new Error("track already created, modality:"+S+", kind:"+g.kind+", id:"+g.id);"closed"!==this.peerConnection.iceConnectionState&&(this.senders[S]=this.peerConnection.addTrack(g,m))}registerMediaSources(){const g=[];if(this.mediaStreams.forEach(((m,f)=>{const S={sourceId:this.getSourceIdForStream(m),defaultSSRC:this.ssrcs[f].min,modality:this.modalityByMediaType(f)};g.push(S)})),this.qualityManager.updateRegisteredSources(g),this.videoStream){const g=this.videoStream.getResolution();this.qualityManager.setCurrentResolution(new $p(g.width,g.height))}}updateStream(g,m){return g.start().then((()=>{try{const f=this.mediaStreams.get(m);if(f&&g.isSameStream(f))return g.dispose(),null;if(this.updateSsrcRangeForMediaType(m),this.removeTrackByMediaType(m),this.disposeStreamByMediaType(m),!this.peerConnection)return g.dispose(),null;if(this.addTrack(g.rawTrack,g.rawStream,m),g.onApplyConstraints=f=>{this.removeTrackByMediaType(m),f.then((()=>{this.addTrack(g.rawTrack,g.rawStream,m),this.registerLocalStreams(),this.mediaManager.updateMediaEntitiesWithLocalTracks()}))},this.mediaStreams.set(m,g),"Video"===m){const g=[this.getMediaTrackInfo(m)];this.localVideoStreamWatcher.startWatching(g)}}catch(f){throw this.removeTrackByMediaType(m),this.disposeStreamByMediaType(m),g.dispose(),f}}))}getSourceIdForStream(g){const m=g.rawStream.getTracks()[0].id,f=this.mediaManager.getMediaEntityByLocalTrackId(m);return f?(this.logger.safe.info(`Media entity found: ${JSON.stringify(f.getXSourceStreamId())}`),f.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(m)}`),0)}updatePeerConnectionStreamsAsync(g,m,f,S){const v=hasSendDirectionality(this.negotiatedModalities.audio),C=hasSendDirectionality(this.negotiatedModalities.video),_=hasSendDirectionality(this.negotiatedModalities.sharing),E=isOnHold(this.negotiatedModalities),T=hasSendDirectionality(g.audio),I=hasSendDirectionality(g.video),b=hasSendDirectionality(g.sharing),A=isOnHold(g);return E||A||(this.stats.onSendersChanged("Audio",T),this.stats.onSendersChanged("Video",I),this.stats.onSendersChanged("ScreenShare",b)),this.assurePeerConnectionAsync(S).then((async()=>{if(this.logger.safe.info("updatePeerConnectionStreamsAsync","pc state",this.peerConnection.signalingState,"hold","[",E,"->",A,"]","audio","[",v,"->",T,"]","video","[",C,"->",I,"]","sharing","[",_,"->",b,"]"),E!==A){if(this.videoStream&&this.videoStream.setHold(A),this.audioStream&&this.audioStream.setHold(A),this.displayStream&&this.displayStream.setHold(A),A)return;if(!A&&this.audioStream){this.removeTrackByMediaType("Audio");const g=this.audioStream.clone();this.audioStream.dispose(),this.mediaStreams.set("Audio",g),this.addTrack(this.audioStream.rawStream.getAudioTracks()[0],this.audioStream.rawStream,"Audio")}}if((v!==T||C!==I||_!==b||this.forceMediaStreamUpdate)&&(f&&(this.forceMediaStreamUpdate=!1),m&&(this.logger.safe.info("not using any media(track api) track, remove all senders"),T||(this.removeTrackByMediaType("Audio"),this.disposeStreamByMediaType("Audio")),f&&I||(this.removeTrackByMediaType("Video"),this.disposeStreamByMediaType("Video")),f&&b||(this.removeTrackByMediaType("ScreenShare"),this.disposeStreamByMediaType("ScreenShare"))),f)){const g=[];if(I){const m=await this.deviceManager.getVideoStream(!1);g.push(this.updateStream(m,"Video"))}if(b){const m=await this.deviceManager.getDisplayStream();g.push(this.updateStream(m,"ScreenShare"))}if(T){const m=await this.deviceManager.getAudioStream(!1);g.push(this.updateStream(m,"Audio").then((()=>{this.audioStream.setMuted(this.doAudioMute)})))}return Promise.all(g).then((()=>this.registerLocalStreams()))}}))}getMediaTrackInfo(g){const m=this.modalityByMediaType(g),f=this.mediaStreams.get(g).rawStream.getTracks()[0].id;return f||this.logger.safe.error(`No media track for modality found: ${m}`),{trackId:f,modality:m}}getSsrcRangeForMediaType(g){const m={min:1,max:1};switch(g){case"Audio":return this.ssrcGenerator.nextAudioStreamSsrc();case"Video":case"ScreenShare":return this.ssrcGenerator.nextVideoStreamSsrc();default:return m}}updateSsrcRangeForMediaType(g){"Video"!==g&&"ScreenShare"!==g||(this.ssrcs[g]=this.ssrcGenerator.nextVideoStreamSsrc())}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!1,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}registerLocalStreams(){const g=[];this.mediaStreams.forEach(((m,f)=>{g.push(this.getMediaTrackInfo(f))})),this.mediaManager.setLocalTracksInfo(g)}handleVideoRecvCapabilities(g){if(this.configProvider.config.enableLocalVideoConstraints&&hasReceiveDirectionality(g.getModalities().video)){if(this.videoStream){const m=g.getVideoRecvCapabilities();if(!m)return this.logger.safe.error("No fmt params found for video modality"),Promise.resolve(!1);const f=this.generateReceiveCapabilities(m,this.videoStream);this.qualityManager.setMaxCapabilities([f])}this.logger.safe.error("remote endpoint didn't specify video receive capability")}return Promise.resolve(!1)}handleSharingRecvCapabilities(g){if(this.configProvider.config.enableLocalVideoConstraints&&hasReceiveDirectionality(g.getModalities().sharing)&&this.displayStream){const m=g.getSharingRecvCapabilities();if(!m)return void this.logger.safe.error("No fmt params found for sharing modality");const f=this.generateReceiveCapabilities(m,this.displayStream);this.qualityManager.setMaxCapabilities([f])}}generateReceiveCapabilities(g,m){const f={ssrc:0,rid:"0",keyframe:!1,...g},S={causeId:generateCauseId(),isSimulcast:!1,sourceId:this.getSourceIdForStream(m),capabilities:[f]};return this.logger.safe.info(`Generated receive capabilities for stream ${m.id}: ${JSON.stringify(S)}`),S}updateDescriptor(g,m){const f=m.getVideoRecvCapabilities(),S={sourceId:0,streamMsid:0,bandwidth:0};if(f&&this.videoStream&&!this.displayStream&&(S.sourceId=this.getSourceIdForStream(this.videoStream),S.streamMsid=this.videoStream.id,S.bandwidth=f.maxBr?f.maxBr:Number.MAX_VALUE),S.bandwidth>0){S.bandwidth=Math.floor(S.bandwidth/1200);const m=new Tv(this.logger.createChild("rembModifier"),this.qualityManager,this.configProvider);m.setControlItem(S),m.modifyDescriptor(g)}}removeTrackByMediaType(g){return this.removeTracksByModality(this.modalityByMediaType(g))}modalityByMediaType(g){switch(g){case"Audio":return je.MODALITY.audio;case"Video":return je.MODALITY.video;case"ScreenShare":return je.MODALITY.sharing;default:throw new Error(`Modality is not defined for media type: ${g}`)}}removeTracksByModality(g){this.forceKeyFramePromise&&"sharing"===g?this.forceKeyFramePromise.then((()=>{this.removeTracksByModality(g)})):g in this.senders&&(this.logger.safe.info(`remove sender track kind: ${this.senders[g].track.kind} track id: ${this.senders[g].track.id}`),"closed"!==this.peerConnection.iceConnectionState&&this.peerConnection.removeTrack(this.senders[g]),delete this.senders[g])}handleCodecSwitchUnsupported(g){return this.offeredDescription.isCodecSwitchSupported()?Promise.resolve():this.webrtcAdapter.RTCRtpReceiver.getCapabilities(je.MEDIA_TYPE.audio).then((g=>{const m=g.codecs.map((g=>g.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(m)})).catch((m=>{this.logger.safe.error(`[${g}] failed to set primary codec based on audio capability ${stringifyObject(m)}`)}))}disposeStreamByMediaType(g){const m=this.mediaStreams.get(g);m&&(this.mediaStreams.delete(g),m.dispose(),"Video"===g&&this.localVideoStreamWatcher.stopWatching())}disposeStreams(){this.mediaStreams.forEach(((g,m)=>this.disposeStreamByMediaType(m)))}assurePeerConnectionAsync(g){if(!this.peerConnectionPromise){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info("fetching relay details from RelayManager...");const m={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};this.peerConnectionPromise=this.relayManagerProvider.getRelayManager().queryRelaysAsync(m).then((m=>{if(this.terminated)throw new Error("session already disposed");const f={optional:[]},S=createIceServers(m,this.configProvider.config),v=this.configureCrypto(f);this.configureCpuThreshold(f),this.logger.safe.info("create peer connection");const C=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle",_=this.peerConnection=new this.webrtcAdapter.RTCPeerConnection({iceServers:S,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,bundlePolicy:C,sdpSemantics:"plan-b",audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===v,offerExtmapAllowMixed:!1},f);this.negotiationEmulator.configure(_),this.stats.initialize(_),this.stats.sessionInfo.setIceServers(S),this.stats.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.stats.sessionInfo.setBundlePolicy(C),this.webrtcAdapter.RTCRtpReceiver.getCapabilities("video").then((g=>this.stats.setH264AvailableProfiles(g))),_.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${_.signalingState}`)},_.onsignalingstatechange=()=>{this.stats.sessionInfo.setSignalingConnectionState(_.signalingState),this.logger.safe.info(`onsignalingstatechange signalingState: ${_.signalingState}`)},_.onicecandidateerror=g=>{const[m,f]=[g.address,g.port];this.logger.safe.warn(`On ICE candidate error ${g.url} | ${m}:${f}: code ${g.errorCode}: ${g.errorText}`),this.isConnected()&&!this.iceCandidatesDeferred.isPending||this.stats.addIceCandidateError({address:m,port:+f,url:g.url,errorCode:g.errorCode,errorText:g.errorText})};const onAddStream=g=>{if(!this.isConnected())return this.logger.safe.info("onaddstream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onAddStream(g)));const m=g.stream;this.logger.safe.info(`onaddstream stream: ${m.id}`);let f=this.mediaManager.getMediaEntityByRemoteStreamId(m.id);if(f||(this.logger.safe.info(`cannot find media entity with stream id ${m.id} trying to fallback`),m.getAudioTracks()[0]&&(f=this.mediaManager.getMediaEntitiesByModality(je.MODALITY.audio)[0])),f){const g=this.createReceiveStream(m,f);this.receiveStreamCollection.add(g)}else this.logger.safe.error(`could not find media entity for an added stream: ${m.id}`)};_.onaddstream=onAddStream,_.ontrack=g=>{this.logger.safe.info(`ontrack track: ${g.track}`)};const onRemoveStream=g=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onRemoveStream(g)));this.logger.safe.info(`onremovestream stream: ${g.stream.id}`),this.receiveStreamCollection.remove(g.stream.id)};_.onremovestream=onRemoveStream,_.onicecandidate=m=>{const f=m.candidate;if(f){const m=parseCandidateString(f.candidate);this.logger.safe.info(`[${g}] onicecandidate candidate: prio:${m.priority} type:${m.type} port:${m.port}`),this.logger.unsafe.info(`[${g}] candidate details: ${f.candidate}`),!this.relayCandidateGathered&&f.candidate.indexOf("typ relay")>-1&&(this.stats.sessionInfo.setRelayCandidateInfo({priority:f.priority||f.candidate.split(" ")[3],time:Date.now()-this.iceRelayCandidatesGatherStartTime}),this.relayCandidateGathered=!0)}else this.logger.safe.info(`[${g}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const v=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,C=this.iceHostCandidateOnly||0===S.length;if(!f&&v||C){f&&this.logger.safe.info(`[${g}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${g}] Is connected:`,this.isConnected(),_.iceConnectionState,_.signalingState);let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled&&f){m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledIceCandidates()}m&&this.completeCandidateGathering(g)}else if(this.relayCandidateGathered){let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled){m=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp).hasUnbundledRelayIceCandidates()}m&&(this.stats.clearIceCandidateErrors(),this.completeCandidateGathering(g))}},_.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${_.iceGatheringState}`)},_.oniceconnectionstatechange=()=>{const g=generateCauseId();if(!this.terminated){if(this.stats.sessionInfo.setIceConnectionState(_.iceConnectionState),this.logger.safe.info(`[${g}] oniceconnectionstatechange iceConnectionState: ${_.iceConnectionState} pc.signalingState: ${_.signalingState}`),"connected"===_.iceConnectionState||"completed"===_.iceConnectionState)this.onTransportConnected(g);else if("failed"===_.iceConnectionState){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${g}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(g);this.raiseError({type:je.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},g),this.configProvider.config.webrtcCloseAfterIceFailure&&_.close(),this.onTransportFailed()}"disconnected"===_.iceConnectionState?(this.onTransportDisconnected(g),this.startIceDisconnectedTimer(g)):this.clearIceDisconnectedTimer()}},this.multiParty&&(this.contributingSources=new kC(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new LC(this.logger.createChild("ContributingSourcesProvider"),_)))}))}return this.peerConnectionPromise}configureCrypto(g){let m=!1;const f=preferSdesSrtp(this.context);if(this.offeredDescription){const g=this.offeredDescription.getSrtpInfo();this.stats.sessionInfo.setOfferedSrtpInfo(g),m=!g.dtls||g.sdes&&f}else m=f;return m&&(this.logger.safe.info("configuring peer connection to use sdes"),g.optional.push({DtlsSrtpKeyAgreement:!1})),this.stats.sessionInfo.setNegotiatedSrtpInfo({dtls:!m,sdes:!!m}),m?0:1}configureCpuThreshold(g){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&g.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(g){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${g}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(g){if(this.logger.safe.info(`[${g}] audio transport connected`),this.stats.clearIceCandidateErrors(),!this.terminated)for(this.callbacks.onAudioStateChanged(je.STREAMING_STATE.active,g),this.callbacks.onTransportConnected&&this.callbacks.onTransportConnected(g);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}onTransportDisconnected(g){this.callbacks.onTransportDisconnected&&this.callbacks.onTransportDisconnected(g)}onTransportFailed(){this.callbacks.onTransportFailed&&this.callbacks.onTransportFailed()}startIceDisconnectedTimer(g){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${g}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise CONSTANTS.MEDIAthis._ERROR.iceConnectionError`),this.raiseError({type:je.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},g)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(g,m=generateCauseId()){this.logger.safe.error(`[${m}] Media error occurred type: ${g.type} detail: ${g.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(g,m)}createNegotiationConstraints(g){function canReceive(g){return!!g&&(hasReceiveDirectionality(g)||"inactive"===g)}return{offerToReceiveAudio:canReceive(g.audio),offerToReceiveVideo:canReceive(g.video)||canReceive(g.sharing)}}resetCandidateGathering(g){this.logger.safe.info(`[${g}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Sr}checkIceCandidates(g){const m=this.hasIceCandidates(g);if(m===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:je.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(m){const m=this.hasRelayIceCandidates(g);if(m===this.noRelayIceCandidates){if(!m&&("connected"===this.peerConnection.iceConnectionState||"completed"===this.peerConnection.iceConnectionState))return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledIceCandidates():g.hasIceCandidates()}hasRelayIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledRelayIceCandidates():g.hasRelayIceCandidates()}doRetargetIfNeeded(g,m,f){const S=m.isIceRestart();this.logger.safe.info(`[${f}] ICE restart: ${S}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription?.isMSRTC()&&S&&!this.multiParty&&m.getSrtpInfo().sdes&&(g.newOffer=!0)}getAddedMediaTypes(g,m){g||(g={}),m||(m={});const f=[];return isModalityAdded(g.audio,m.audio)&&f.push("Audio"),isModalityAdded(g.video,m.video)&&f.push("Video"),isModalityAdded(g.sharing,m.sharing)&&f.push("ScreenShare"),f}applyCapabilitiesForModality(g,m,f){return g===je.MODALITY.video?this.applyCapabilitiesForVideo(m,f[0]):g===je.MODALITY.sharing?this.applyCapabilitiesForSharing(m,f[0]):Promise.resolve(!1)}applyCapabilitiesForSharing(g,m){return this.displayStream?this.applyCapabilities(this.displayStream,m).then((f=>(this.stats.onMaxCapabilitiesApplied({causeId:g,modality:je.MODALITY.sharing,capabilities:[m]}),this.configProvider.config.webrtcAllowRestoreKeyframe?this.forceKeyframe(this.senders[je.MODALITY.sharing]).then((()=>f)):Promise.resolve(f)))):(this.logger.safe.info(`${JSON.stringify(m)} is ignored as no sharing stream is sent, no renegotiation`),Promise.resolve(!1))}forceKeyframe(g){if(!g)return this.logger.safe.error("forceKeyframe: No sender available for sharing"),null;if(this.forceKeyFramePromise)return this.logger.safe.warn("forceKeyframe: already in progress"),this.forceKeyFramePromise;this.logger.safe.info("Restoring keyframe");const m=g.track;return this.forceKeyFramePromise=g.replaceTrack(null).then((()=>g.replaceTrack(m))).then((()=>{this.forceKeyFramePromise=null,this.logger.safe.info("Restoring keyframe finished")})).catch((g=>{this.forceKeyFramePromise=null,this.logger.safe.error(`Restoring keyframe failed: ${g}`),delete this.senders[je.MODALITY.sharing]})),this.forceKeyFramePromise}applyCapabilitiesForVideo(g,m){return this.negotiationCompletedPromise.isPending?(this.logger.safe.info("##### Renegotiation is in progress, no local resolution switch for now #####"),this.negotiationCompletedPromise.promise.then((()=>Promise.resolve(!1)))):this.videoStream?this.scheduleApplyCapabilities(this.videoStream,g,m):(this.logger.safe.info(`${JSON.stringify(m)} is ignored as no video is sent, no renegotiation`),Promise.resolve(!0))}scheduleApplyCapabilities(g,m,f){this.logger.safe.info("Queueing local renegotiation...");let S=!1;return this.negotiationQueue.add((()=>(this.logger.safe.info("############# LOCAL RENEGOTIATION START #############"),this.applyCapabilities(g,f).then((()=>{this.stats.onMaxCapabilitiesApplied({causeId:m,modality:je.MODALITY.video,capabilities:[f]}),S=!0})))),m),this.negotiationEmulator.renegotiate().then((()=>(this.logger.safe.info(`############# LOCAL RENEGOTIATION END. RESULT: ${S}  #############`),S)))}applyCapabilities(g,m){return g?(this.logger.safe.info(`Changing resolution to ${JSON.stringify(m)}`),g.applyCapabilities(m)):(this.logger.safe.info(`Resolution ${JSON.stringify(m)} ignored, no stream is being sent`),Promise.resolve(!1))}onOptimalVideoReceiversCountChanged(g){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(g)}async onSendBandwidthChanged(g){if(!this.isConnected())return;const m=this.extensionsManager.getExtension("videoStreamControl"),f=this.mediaManager.getMediaEntities().filter((g=>[je.MODALITY.video,je.MODALITY.sharing].indexOf(g.getModality())>-1)).filter((g=>g.isEnabled())).map((g=>g.getMid()));return 0!==f.length?m.sendBandwidthInfo(f,g).then((()=>{this.stats.setReportedSendBandwidth(g)})):void 0}getStreams(){return this.receiveStreamCollection.getStreams()}onStreamsChanged(g){this.streamsChangedListener=g}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}streamAdded(g){je.MODALITY.audio===g.getModality()&&(this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),this.audioRenderer.play(g.getMediaStream())),this.notifyStreamsChanged()}streamRemoved(g){je.MODALITY.audio===g.getModality()&&this.audioRenderer.getStream()===g.getMediaStream()&&this.audioRenderer.stop(),this.notifyStreamsChanged()}setNegotiatedModalities(g){this.negotiatedModalities=g,this.stats.sessionInfo.setNegotiatedModalities(g)}setupIceGatheringTimeout(g){this.iceRelayCandidatesGatherStartTime=Date.now();const m=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!m)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const f=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,f.isPending&&(this.logger.safe.warn(`[${g}] ICE candidates gathering terminated due to timeout ${m}`),f.resolve())}),m)}createAudioRenderer(){this.audioRenderer=new kp(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved)}isConnected(){const g=this.peerConnection;return g&&("connected"===g.iceConnectionState||"completed"===g.iceConnectionState)}isFailed(){return this.peerConnection&&("failed"===this.peerConnection.iceConnectionState||"closed"===this.peerConnection.iceConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}createReceiveStream(g,m){const f=this.configProvider.config.addFmtpToInitialSubscription?m.getLocalRecvCapabilities():null,S=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&m.getModality()!==je.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null;return new i_(g,null,m.getModality(),+m.getXSourceStreamId(),this,f,S)}requestSource(g,m,f,S){return this.multiParty?!this.isMuteHold&&this.negotiatedModalities[g]!==je.MEDIA_STATE.inactive||f===Sv.SourceNone?this.negotiationCompletedPromise.isPending?this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>this.requestSource(g,m,f,S))):Promise.resolve().then((()=>{const g=this.mediaManager.getMediaEntityByXSourceStreamId(m);return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(m,f,g?.getMid(),S)})):delay2(10).then((()=>this.requestSource(g,m,f,S))):Promise.resolve()}getSessionConfig(){return this.configProvider}getUnmixedAudioProvider(){return null}};function isModalityAdded(g,m){return!hasSendDirectionality(g)&&hasSendDirectionality(m)}var l_={build:(g,m,f)=>new o_(g,m,f)},c_=0,d_=class{constructor(g,m,f,S){this.worker=g,this.clientId=m,this.transformType=f,this.listener=S,this.worker.subscribeClient(this.clientId,this.transformType,(g=>this.processMsg(g))),this.worker.sendTransformCommand(this.clientId,{operation:"add",transformType:this.transformType})}processMsg(g){if(this.listener&&g.name in this.listener)return this.listener[g.name].apply(this.listener,g.args);throw`unexpected message received for transform type ${this.transformType}: ${JSON.stringify(g)}`}},h_=7,u_=31,g_=class{constructor(g){this.logger=g}createBaseInstanse(g){this.imp=new p_(this.logger.safe),g.addTransform(this.imp)}createWorkerInstanse(g,m){this.imp=new m_(g,m)}},p_=class{constructor(g){this.logger=g,this.transformType=0}transform(g){return this.processChunk(g),g}dispose(){}getStartCodeSize(g){const m=g.getUint32(0);return 1===m?4:256==(4294967040&m)?3:0}processChunk(g){if("key"!==g.type)return;const m=this.isH264KeyFrame(g.data)?`${this.getH264Profile(g.data)}(H264)`:"unknown";this.logger.info(`keyframe metadata: ${JSON.stringify(g.getMetadata())}, profile=${m}`)}isH264KeyFrame(g){if(g.byteLength<7)return!1;const m=new DataView(g),f=this.getStartCodeSize(m);return!!f&&(m.getUint8(f)&u_)===h_}getH264Profile(g){const m=new DataView(g),f=this.getStartCodeSize(m);return(16777215&m.getUint32(f)).toString(16)}},m_=class extends d_{constructor(g,m){super(g,m,0,void 0)}},f_=R,S_=[je.MODALITY.audio,je.MODALITY.video,je.MODALITY.sharing],v_=class{constructor(g,m,f,S,v){this.peerConnection=m,this.mediaManager=f,this.reinvitelessContext=v,this.entityTransceiverMap=new Map,this.logger=g.createChild("TM"),this.configProvider=S.configProvider,this.isMultiparty=S.config.isConference,this.isPstnCall=S.config.isPstnCall,this.isParkedCall=S.config.isParkedCall,this.numVideoChannels=this.isMultiparty&&this.configProvider.config.numVideoChannelsGvc||1,S.configProvider.config.enableRollbackHandler&&this.mediaManager.setRollbackUpdateHandler(this.handleMediaEntitiesRollback.bind(this))}getTransceivers(){return this.peerConnection.getTransceivers().filter(isActiveTransceiver)}assureTransceivers(g){this.assureNegotiatedOrder(),this.addModalities(g),this.logTransceiversInfo("assureTransceivers"),this.setDirections(g)}syncTransceivers(g){this.syncWithMediaEntities(),this.setDirections(g)}assureNegotiatedOrder(){const g=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((m=>{if(-1===S_.indexOf(m.getModality()))return;isActiveTransceiverInPc(this.entityTransceiverMap.get(m),g)||this.createTransceiverForEntity(m)}))}addModalities(g){const m=this.mediaManager.isEmpty();this.isMultiparty||!m||this.isPstnCall||(g.video=g.video||"inactive",g.sharing=g.sharing||"inactive"),this.configProvider.config.webrctRemoveVideoModalitiesForPstn&&this.isPstnCall&&!this.isParkedCall&&(delete g.video,delete g.sharing);for(const f of S_){if(this.mediaManager.getMediaEntitiesByModality(f)[0]||!g[f])continue;const S=f===je.MODALITY.video?this.numVideoChannels:1;(0,f_.times)(S,(g=>{const S=this.mediaManager.createMediaEntity(f);S.setExtension("reinviteless",m&&this.reinvitelessContext.maxStreamsForModality[f]>g),this.createTransceiverForEntity(S)}))}}createTransceiverForEntity(g){const m=g.getModality();this.logger.safe.info(`createTransceiver: modality=${m}`);const f=m===je.MODALITY.audio?je.MEDIA_TYPE.audio:je.MEDIA_TYPE.video,S=g.getSimulcastContext(),v=this.createTransceiver(f,S);this.setCodecPreferences(v,f,!0),this.setExtensionPreferences(v,m),this.entityTransceiverMap.set(g,v),g.setExtension("unnegotiatedModality",!0)}setCodecPreferences(g,m,f){const S=getAllowedCodecs(this.configProvider,m);if(!S?.length||!qs.hasCapabilitiesApi()||this.configProvider.config.filterCodecsInSdp)return;const v=Ws.window.RTCRtpReceiver.getCapabilities(m);if(!v)return;const C=[];if(f)for(const g of S){const m=v.codecs.filter((m=>isCodecsMatch2(g,m)));C.push(...m)}else for(const g of v.codecs)S.some((m=>isCodecsMatch2(m,g)))&&C.push(g);C.length&&g.setCodecPreferences&&g.setCodecPreferences(C)}setExtensionPreferences(g,m){if(!this.configProvider.config.headerExtensionsToUpdate?.[m])return;if(!g.getHeaderExtensionsToNegotiate||!g.setHeaderExtensionsToNegotiate)return void this.logger.safe.debug("setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate is not supported");const f=this.configProvider.config.headerExtensionsToUpdate[m],S=g.getHeaderExtensionsToNegotiate();for(const g of S){const m=f.find((m=>m.uri===g.uri));m&&(g.direction=m.direction)}try{g.setHeaderExtensionsToNegotiate(S)}catch(g){this.logger.safe.error(`setExtensionPreferences: transceiver.setHeaderExtensionsToNegotiate failed, err ${stringifyObject(g)}`)}}async createSender(g,m,f){const S=await this.associateTrackWithTransceiver(g,m,f);if(!S)throw new Error(`Transceiver for modality=${f} is not found`);const v=this.findEntityForTransceiver(S),C=f!==je.MODALITY.sharing||v?.getExtension("reinviteless")?je.MEDIA_STATE.sendReceive:je.MEDIA_STATE.send;return S.direction=C,this.logger.safe.info(`Replace track completed direction:${S.direction} for transceiver mid=${S.mid}`),S.sender}removeSender(g){this.removeSenderInternal(g,!1)}async removeSenderAsync(g){return this.removeSenderInternal(g,!0)}removeSenderInternal(g,m){if("closed"===(this.peerConnection.connectionState||this.peerConnection.iceConnectionState))return void this.logger.safe.info("Not removing sender from pc, connection is closed");const f=this.getTransceivers().find((m=>m.sender===g));if(!f)throw new Error(`Transceiver for sender with track=${g.track?.id} is not found`);const S=this.findEntityForTransceiver(f),v=!!S?.getExtension("reinviteless");this.logger.safe.info(`Remove sender with track=${g.track?.id} for transceiver mid=${f.mid}, reinviteless=${v}, doAsync=${m}`);let C=Promise.resolve();return v&&m?C=f.sender.replaceTrack(null):this.peerConnection.removeTrack(g),m?C:void 0}createTransceiver(g,m){const f={direction:"inactive"};return this.addSimulcastEnvelopeIfNeeded(f,m),this.peerConnection.addTransceiver(g,f)}addSimulcastEnvelopeIfNeeded(g,m){m?.shouldUseSimulcast()&&(g.sendEncodings=(0,f_.times)(m.config.layerScaleFactors.length,(g=>{const f=`${m.ridList[g]}`,S=m.config.layerScaleFactors[g];return this.logger.safe.debug(`Added layer ${g} with rid: ${f} SF: ${S}`),{rid:f,scaleResolutionDownBy:S}})))}async associateTrackWithTransceiver(g,m,f){const S=this.findAvailableTransceiverToSend(f);if(S){this.logger.safe.info(`Associate track=${g?.id} (${f}) with existing transceiver mid=${S.mid}`);try{await S.sender.replaceTrack(g),this.configProvider.config.useSetStreamsForSender&&S.sender.setStreams&&S.sender.setStreams(m)}catch(g){throw this.logger.safe.error(`replaceTrack failed, err ${JSON.stringify(g)}`),g}return S}return null}syncWithMediaEntities(){const g=this.getTransceivers();this.mediaManager.getMediaEntities().forEach((m=>{let f=this.entityTransceiverMap.get(m);f=isActiveTransceiverInPc(f,g)?f:g.find((g=>g.mid===m.getMid())),this.entityTransceiverMap.set(m,f)})),this.logTransceiversInfo("syncWithMediaEntities")}getTransceiversByModality(g){return this.mediaManager.getMediaEntitiesByModality(g).map((g=>this.entityTransceiverMap.get(g))).filter(isActiveTransceiver)}setDirections(g){const m=!isOnHold(g);for(const f of S_)for(const[S,v]of this.getTransceiversByModality(f).entries()){const C=this.findEntityForTransceiver(v);if(C?.getExtension("reinviteless")&&m){v.direction="sendrecv";continue}const _=g[f]||je.MEDIA_STATE.inactive;v.direction=0===S&&v.currentDirection?_:removeSendDirectionality2(_)}this.logTransceiversInfo("setDirections")}handleMediaEntitiesRollback(g,m){g.forEach((g=>{const f=this.entityTransceiverMap.get(g),S=m.find((m=>m.getMid()===g.getMid()));this.entityTransceiverMap.set(S,f)})),this.logTransceiversInfo("handleMediaEntitiesRollback")}findAvailableTransceiverToSend(g){const m=this.mediaManager.getMediaEntitiesByModality(g)[0];return this.entityTransceiverMap.get(m)}findEntityForTransceiver(g){for(const[m,f]of this.entityTransceiverMap)if(f===g)return m}logTransceiversInfo(g){let m=`${g}: transceivers details:`;for(const g of S_){const f=this.getTransceiversByModality(g);m+=` ${g}(${f.length}) [${f.map((g=>`mid=${g.mid}, direction=${g.direction}`)).join(";")}]`}this.logger.safe.debug(m)}};function isCodecsMatch2(g,m){return!(!(0,f_.isUndefined)(g.channels)&&g.channels!==m.channels)&&(!(!(0,f_.isUndefined)(g.clockRate)&&g.clockRate!==m.clockRate)&&(!(!(0,f_.isUndefined)(g.mimeType)&&g.mimeType.toLowerCase()!==m.mimeType.toLowerCase())&&!(!(0,f_.isUndefined)(g.sdpFmtpLine)&&-1===m.sdpFmtpLine.toLowerCase().indexOf(g.sdpFmtpLine.toLowerCase()))))}function removeSendDirectionality2(g){let m=g;return hasSendDirectionality(g)&&(m=removeSendDirectionality(g)),m||je.MEDIA_STATE.inactive}function isActiveTransceiver(g){return g&&"stopped"!==g.direction&&!g.stopped}function isActiveTransceiverInPc(g,m){return isActiveTransceiver(g)&&-1!==m.indexOf(g)}var y_=class{constructor(g,m){this.transforms=[];const f=new TransformStream({transform:(g,m)=>{let f=g;for(const g of this.transforms)if(f=g.transform(f),!f)return;m.enqueue(f)}});g.pipeThrough(f).pipeTo(m)}clearTransforms(){for(const g of this.transforms)g.dispose();this.transforms=[]}addTransform(g){this.transforms.push(g)}getTransform(g){return this.transforms.find((m=>m.transformType===g))}},C_=class{constructor(g,m){this.logger=m,this.clientsMap=new Map,this.loaded=!1,this.initDefer=defer4();try{this.worker=g.getWorker(),this.worker.onmessage=g=>this.handleEvent(g.data),this.worker.onerror=g=>{this.logger.safe.error(`error inside worker: ${g.message}`),this.initDefer.resolve()}}catch(g){this.logger.safe.error("failed to create worker"),this.initDefer.resolve()}}initialize(){return Promise.race([this.initDefer.promise,delay2(5e3)])}isWorkerLoaded(){return this.loaded}sendTransformCommand(g,m,f=[]){const S={type:"transform",clientId:g,payload:m};this.worker.postMessage(S,f)}subscribeClient(g,m,f){const S=this.clientsMap.get(g)??new Map;S.set(m,f),this.clientsMap.set(g,S)}dispose(){const g={type:"generic",payload:{operation:"dispose"}};this.worker.postMessage(g),this.worker.terminate()}handleEvent(g){switch(g.type){case"init":this.initDefer.resolve(),this.loaded=!0;break;case"transform":{const m=this.clientsMap.get(g.payload.clientId),f=m?.get(g.payload.event.transformType);f?.(g.payload.event),f||this.logger.safe.error(`received event for unknown Client ${g.payload.clientId} or transformType ${g.payload.event.transformType}`)}break;case"log":switch(g.level){case"debug":this.logger.safe.debug(g.msg);break;case"info":this.logger.safe.info(g.msg);break;case"warn":this.logger.safe.warn(g.msg);break;case"error":this.logger.safe.error(g.msg);break;default:this.logger.safe.error(`unknown log level ${g.level}`)}break;default:this.logger.safe.error(`received unsupported event from worker ${g.type}`)}}},E_=class extends Be{constructor(g,m,f){super(),this.configProvider=g,this.workerProvider=m,this.logger=f,this.transformsCollections=new Map}async initialize(){return this.configProvider.config.useInsertableStreams&&this.workerProvider&&qs.hasEncodedStreamApi()&&(this.worker=new C_(this.workerProvider,this.logger)),this.worker?this.worker.initialize():Promise.resolve()}initTransformsCollection(g,m,f){const S=qs.hasScriptTransformApi()||this.workerProvider;if(!(this.configProvider.config.useInsertableStreams&&qs.hasEncodedStreamApi()&&(!S||this.isWorkerLoaded())))return null;if(!this.transformsCollections.has(g)){const S=this.worker?new I_(this.worker,g):new T_(g);this.transformsCollections.set(g,{collection:S,mediaType:f,objType:m})}const v=this.transformsCollections.get(g);return this.event("onTransformsCollectionCreated").raise(v),v.collection}clearTransformsCollection(g){const m=this.transformsCollections.get(g);m&&(this.event("onTransformsCollectionCleared").raise(m),m.collection.clearTransforms())}dispose(){for(const g of this.transformsCollections.values())this.event("onTransformsCollectionCleared").raise(g),g.collection.clearTransforms();this.transformsCollections.clear(),this.worker?.dispose(),super.dispose()}isWorkerLoaded(){return!!this.worker?.isWorkerLoaded()}},T_=class{constructor(g){const{readable:m,writable:f}=g.createEncodedStreams();this.streamTransformer=new y_(m,f)}addTransform(g){g.createBaseInstanse(this.streamTransformer)}clearTransforms(){this.streamTransformer.clearTransforms()}},I_=class{constructor(g,m){if(this.workerHandler=g,this.clientId=m.track.id,qs.hasScriptTransformApi())return void(m.transform=new RTCRtpScriptTransform(this.workerHandler.worker,{clientId:this.clientId}));const{readable:f,writable:S}=m.createEncodedStreams(),v=[f,S];this.workerHandler.sendTransformCommand(this.clientId,{operation:"init",readable:f,writable:S},v)}addTransform(g){g.createWorkerInstanse(this.workerHandler,this.clientId)}clearTransforms(){this.workerHandler.sendTransformCommand(this.clientId,{operation:"clear"})}},b_=R,A_=class extends Be{constructor(g,m){super(m),this.logger=m,this.id=-1,this.parentId=-1,this.rawStream=null,this.rawTrack=null,this.deviceId=null,this.mediaType=g}start(){return this.logger.safe.debug("start"),Promise.resolve()}clone(){return this.logger.safe.debug("clone"),this}setMuted(g,m){this.logger.safe.debug("setMuted")}setHold(g){this.logger.safe.debug("setHold")}getResolution(){return this.logger.safe.debug("getResolution"),{width:240,height:180}}getFrameRate(){return this.logger.safe.debug("getFrameRate"),1}hasAudio(){return this.logger.safe.debug("hasAudio"),!1}hasVideo(){return this.logger.safe.debug("hasVideo"),!1}isSameStream(g){return this.logger.safe.debug("isSameStream"),g===this}applyCapabilities(g){return this.logger.safe.debug("applyCapabilities"),Promise.resolve(!1)}onApplyConstraints(g){this.logger.safe.debug("onApplyConstraints")}update(g){this.logger.safe.debug("update")}isActive(){return!1}isDisposed(){return!1}},P_=class _SessionStreamsProvider extends Be{constructor(g,m,f,S){super(S),this.callDeviceManager=g,this.configProvider=m,this.serialQueue=f,this.logger=S,this.mediaStreams={Audio:null,Video:null,ScreenShare:null},this.streamSubscriptions=new Map,this.deviceManagerSubscriptions=[],this.isNullAudioStream=!1}get currentMediaTypes(){return keys(this.streams).filter((g=>!!this.streams[g]))}get streams(){return this.mediaStreams}useNullAudioStreamClient(){this.isNullAudioStream=!0}async update(g,m){const f=keys(g).filter((m=>g[m]));return deepEqual(f,this.currentMediaTypes)?(this.logger.safe.info("Requested modalities have not changed. Do nothing"),sendStreamsToModalities(this.streams)):(this.logger.safe.info(`Starting media session with modalities: ${JSON.stringify(g)}`),await this.updateStreams(f,m),this.subscribeOnDeviceManagerEvents(),sendStreamsToModalities(this.streams))}async stopAsync(){this.logger.safe.info("Stopping streams async"),this.stop()}stop(){this.logger.safe.info("Stopping streams"),this.unsubscribeFromDeviceManagerEvents(),keys(this.mediaStreams).forEach((g=>this.removeStreamByType(g)))}async ensureUpdateCompleted(){this.logger.safe.debug("streams updated")}dispose(){this.stop(),super.dispose()}async updateStreams(g,m){const f=this.getAvailableMediaTypes(),S=(0,b_.intersection)(g,f),v=keys(this.mediaStreams).filter((g=>this.mediaStreams[g])),C=m?[]:subtractFrom(S,v),_=subtractFrom(v,S);this.logger.safe.info(`Adding media streams for types: ${JSON.stringify(C)}`),await Promise.all(C.map((async g=>{await this.addStream(g,!1),this.mediaStreams[g]&&this.event("onStreamAdded").raise(g)}))),this.logger.safe.info(`Removing media streams for types: ${JSON.stringify(_)}`),_.forEach((g=>{this.event("onStreamRemoving").raise(g),this.removeStreamByType(g)}))}getAvailableMediaTypes(){const g=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices(),m=[];return g.microphone&&m.push("Audio"),g.camera&&m.push("Video"),m.push("ScreenShare"),m}async addStream(g,m){if(this.mediaStreams[g])return void this.logger.safe.warn(`Stream with type: ${g} is already registered`);const f=await this.getStream(g,m);this.subscribeOnMediaStreamEvents(f);try{await f.start()}catch(m){return this.logger.safe.error(`Media stream request error: ${JSON.stringify(m)}`),void this.event("onStreamError").raise(g,m)}this.mediaStreams[g]=f}removeStreamByType(g){const m=this.mediaStreams[g];m?(this.unsubscribeFromMediaStreamEvents(m),m.dispose(),this.mediaStreams[g]=null):this.logger.safe.warn(`Stream with type: ${g} is not registered`)}async updateStream(g,m,f=!1){f&&"Audio"===g?await this.updateStreamWithEffect(g):(this.removeStreamByType(g),await this.addStream(g,m)),this.event("onStreamUpdated").raise(g)}async updateStreamWithEffect(g){const m=this.mediaStreams[g];m&&this.unsubscribeFromMediaStreamEvents(m);const f=await this.getStreamByMediaType(g,!0);this.subscribeOnMediaStreamEvents(f);try{await f.start()}catch(m){return this.logger.safe.error(`updateStreamWithEffect. Media stream request error: ${JSON.stringify(m)}`),void this.event("onStreamError").raise(g,m)}this.mediaStreams[g]=f,m?.dispose()}subscribeOnMediaStreamEvents(g){if(this.streamSubscriptions.has(g))return;const m=[];m.push(g.on("onStreamClientError",((g,m)=>this.onStreamError(g,m)))),m.push(g.on("onStreamClientDisposing",(g=>this.onStreamDisposing(g)))),this.streamSubscriptions.set(g,m)}unsubscribeFromMediaStreamEvents(g){this.streamSubscriptions.has(g)&&(this.streamSubscriptions.get(g).forEach((g=>g.dispose())),this.streamSubscriptions.delete(g))}async getStream(g,m){const f=this.mediaStreams[g];return f?(this.logger.safe.info(`Stream exists with id: ${f.id}, type: ${g}`),f):this.getStreamByMediaType(g,m)}async getStreamByMediaType(g,m){switch(g){case"Audio":return this.isNullAudioStream?new A_("Audio",this.logger.createChild("NullStreamClient")):this.getDeviceManagerByType("Audio").getAudioStream(m,"sessionStream");case"Video":return this.getDeviceManagerByType("Video").getVideoStream(m,"sessionStream");case"ScreenShare":return this.getDeviceManagerByType("ScreenShare").getDisplayStream("sessionStream");default:throw new Error(`Media type is not supported: ${g}`)}}getMediaTypeForStream(g){const m=Object.keys(this.mediaStreams).find((m=>this.mediaStreams[m]===g));return m||this.logger.safe.error(`Media type is not found for stream: ${stringifyObject(g)}`),m}subscribeOnDeviceManagerEvents(){if(0!==this.deviceManagerSubscriptions.length)return;if(this.callDeviceManager.isVirtualDeviceEnabled){const g=this.callDeviceManager.on("onSelectedVirtualDevicesChanged",((g,m)=>{const f=g;if(!g.camera){this.logger.info("Virtual DeviceID for camera is undefined, falling back to default device");const{camera:g}=this.callDeviceManager.getDefaultDeviceManager().getSelectedDevices();f.camera=g}this.callDeviceManager.isModalityEnabled("Video")&&m.camera!==f.camera&&(this.logger.info("Updating stream for camera"),this.updateStreamForVirtualDeviceChange("Video")),this.callDeviceManager.isModalityEnabled("ScreenShare")&&m.screenshare!==f.screenshare&&(this.logger.info("Updating stream for screenshare"),this.updateStreamForVirtualDeviceChange("ScreenShare"))}));this.deviceManagerSubscriptions.push(g)}const g=this.callDeviceManager.getDefaultDeviceManager();this.deviceManagerSubscriptions.push(g.on("onSelectedDevicesChanged",((g,m)=>this.onSelectedDevicesChanged(g,m))),g.on("onStreamUpdateRequested",((g,m)=>this.requestStreamUpdate(g,!1,m))),g.on("onAudioSharingToggled",(g=>this.onAudioSharingToggled(g))))}unsubscribeFromDeviceManagerEvents(){0!==this.deviceManagerSubscriptions.length&&(this.deviceManagerSubscriptions.forEach((g=>g.dispose())),this.deviceManagerSubscriptions=[])}getMediaTypesToUpdate(g,m){const f=[];return this.currentMediaTypes.some((g=>"Audio"===g))&&g.microphone&&g.microphone!==m.microphone&&f.push("Audio"),!this.callDeviceManager.getSelectedDevices().camera&&this.currentMediaTypes.some((g=>"Video"===g))&&g.camera&&g.camera!==m.camera&&f.push("Video"),f}removeStream(g){const m=this.getMediaTypeForStream(g);this.removeStreamByType(m)}async onSelectedDevicesChanged(g,m){if(this.configProvider.config.enablePermissionsWorkaround&&_SessionStreamsProvider.isDeviceListEmpty(g,m))return void this.logger.safe.info("Device list is empty, permission workaround enabled");const f=this.getMediaTypesToUpdate(g,m);this.logger.safe.info(`Media types to update: ${JSON.stringify(f)}`),await Promise.all(f.map((g=>this.updateStream(g,!1))))}async onAudioSharingToggled(g){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&g)return this.updateStream("ScreenShare",!0)}async requestStreamUpdate(g,m,f=!1){if(this.currentMediaTypes.some((m=>m===g))||m)return this.logger.safe.debug(`UpdateStream with media type: ${g}, force: ${m}`),this.updateStream(g,m,f);this.logger.safe.debug(`Stream with media type: ${g} is not active. Do nothing`)}onStreamError(g,m){this.removeStream(g)}onStreamDisposing(g){this.removeStream(g)}static isDeviceListEmpty(g,m){return!g.camera&&!g.microphone||!m.microphone&&!m.camera}getDeviceManagerByType(g){return this.callDeviceManager.getDeviceManager(g)}async updateStreamForVirtualDeviceChange(g){return this.updateStream(g,!1)}};__decorateClass([sequentialize()],P_.prototype,"update",1),__decorateClass([sequentialize()],P_.prototype,"stopAsync",1),__decorateClass([sequentialize()],P_.prototype,"ensureUpdateCompleted",1),__decorateClass([sequentialize()],P_.prototype,"onSelectedDevicesChanged",1),__decorateClass([sequentialize()],P_.prototype,"onAudioSharingToggled",1),__decorateClass([sequentialize()],P_.prototype,"requestStreamUpdate",1),__decorateClass([sequentialize()],P_.prototype,"updateStreamForVirtualDeviceChange",1);var R_=P_,w_=R,M_=[5e4,1e6,15e5,2e6,25e5,375e4,4e6],D_=[7e4,2e5,4e5,8e5,15e5,2499990,25e5];function createBandwidthAllocatorPerMediaType(g,m){const f=new O_(g.createChild("BandwidthAllocator"));return f.setLadder("ScreenShare",m.config.sharingBitrateLadderOverride||M_),f.setLadder("Video",m.config.videoBitrateLadderOverride||D_),f}var O_=class{constructor(g){this.logger=g,this.availableBandwidth=0,this.receivers=new Map,this.currentLayout={},this.ladders={}}setAvailableBandwidth(g){this.availableBandwidth=g,this.logger.safe.debug(`Total available bandwidth updated: ${g}`),this.updateLayouts()}addReceiverCapabilty(g,m){this.logger.safe.debug(`Receiver maxBr set: ${g}/${m}`),this.receivers.set(g,m),this.updateLayouts()}removeReceiver(g){this.logger.safe.debug(`Receiver maxBr removed: ${g}`),this.receivers.delete(g),this.updateLayouts()}getLayouts(){return this.currentLayout}setLadder(g,m){this.ladders[g]=m}updateLayouts(){const g=this.generateLayouts();(0,w_.isEqual)(g,this.currentLayout)||(this.currentLayout=g,this.logger.safe.debug(`Bandwidth distribution updated: ${stringifyObject(g)}`))}generateLayouts(){const g={},m={};for(const f of Object.keys(this.ladders)){const S=this.receivers.get(f);S&&(m[f]=S||Number.MAX_SAFE_INTEGER,g[f]=0)}let f=this.availableBandwidth,S=0;const runLoop=()=>{if(!f)return!1;for(const g of Object.values(m))if(g)return!0;return!1};for(;runLoop();){for(const v of Object.keys(g)){const C=this.ladders[v];let _=C[S]||C[C.length-1];_=Math.min(_,f,m[v]),g[v]+=_,f-=_,m[v]-=_}S++}return g}},N_=class{constructor(g,m,f){this.timeout=m,this.logger=f,this.isFirstTimeDeferred=!0,this.internalCallback=m=>{this.logger.safe.debug(`Trigger reason: ${m}`),g()}}invoke(g){if(this.logger.safe.debug(`Schedule shouldDefer: ${g}`),this.createTimerIfNeeded(g),this.timer)return g?this.startTimer():this.stopTimerAndTrigger();this.internalCallback("request")}dispose(){this.stopTimer()}startTimer(){this.timer.isActive||(this.timer.start(this.timeout),this.logger.safe.debug(`Timer started for : ${this.timeout}ms`))}stopTimer(){this.timer?.isActive&&(this.timer.stop(),this.logger.safe.debug("Timer stopped"))}stopTimerAndTrigger(){this.stopTimer(),this.internalCallback("request")}createTimerIfNeeded(g){g&&this.isFirstTimeDeferred&&(this.isFirstTimeDeferred=!1,this.timer=new Qs((()=>{this.internalCallback("timeout"),this.timer=null})))}},k_=class{constructor(g){this.logger=g,this.currentFrameSize=jp.Send.initialResolution.fs}setAvailableBandwidth(g){g!==this.lastSendBW&&(this.logger.safe.debug(`Available bandwidth updated ${g}`),this.processEstimatedBandwidth(g))}setMaxFrameSize(g){this.logger.safe.debug(`SetMaxFrameSize ${g}`),g!==this.maxFrameSize?(this.maxFrameSize=g,this.lastSendBW?(this.logger.safe.debug(`Setting max frame size: ${g}`),this.processEstimatedBandwidth(this.lastSendBW)):this.logger.safe.debug("Last send bwe is not defined. Do nothing")):this.logger.safe.debug(`Max frame size did not change. Do nothing, maxFs: ${g}`)}getFrameSize(){return this.currentFrameSize}processEstimatedBandwidth(g){if(this.logger.safe.debug(`Process estimated bandwidth ${g}`),0===g)return this.lastSendBW=0,void this.proposeResolution(0);const{lowRes:m,highRes:f}=jp.Send.getResolutionForBitrate(g);this.logger.safe.debug("low",m,"hi",f);const S=g<this.lastSendBW?f.fs:m.fs;g<this.lastSendBW&&this.currentFrameSize<S?this.logger.safe.debug(`proposed resolution is above the existing one, so we should stay on the current resolution, last bw: ${g}`):(S&&this.proposeResolution(S),this.logger.safe.debug(`Updating last bw: ${g}`),this.lastSendBW=g)}proposeResolution(g){this.logger.safe.debug(`Propose resolution ${g}`);const m=this.maxFrameSize?Math.min(g,this.maxFrameSize):g;m!==this.currentFrameSize&&(this.currentFrameSize=m,this.logger.safe.debug(`Proposed new frame size: ${m} based on bandwidth: ${this.lastSendBW}`))}},L_=1e8,F_=[{bwe:2e5,param:5e5},{bwe:5e5,param:12e5},{bwe:8e5,param:25e5},{bwe:12e5,param:4e6}],x_=[{bwe:2e5,param:240},{bwe:3e5,param:405},{bwe:5e5,param:920},{bwe:9e5,param:2040}],limitParamByBwe=(g,m,f)=>{for(const S of f)if(m<S.bwe)return Math.min(g,S.param);return g},limitStreamMaxBitrate=(g,m,f=F_)=>limitParamByBwe(g,m,f),limitStreamMaxResolution=(g,m,f=x_)=>limitParamByBwe(g,m,f),U_=class extends Be{constructor(g,m,f){super(m),this.configProvider=g,this.logger=m,this.layoutsNumber=f,this.totalBandwidth=L_,this.totalBandwidthMax=0,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),this.outputLayouts=null,super.dispose()}setAvailableBandwidth(g){this.storeAvailableBandwidth(g),this.inputLayouts?(this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.debug("Layouts are not set. Skip update")}setLayouts(g,m){this.storeAvailableBandwidth(m),g.length===this.layoutsNumber?(this.logger.safe.debug(`Set layouts: ${JSON.stringify(g)}`),this.inputLayouts=this.getPrioritizedLayouts(g),this.recalculateLayouts(),this.checkForChangesAndNotify()):this.logger.safe.warn(`Incorrect number of layouts! ${JSON.stringify(g)}, expected ${this.layoutsNumber}`)}getLayouts(){return this.inputLayouts}getPrioritizedLayouts(g){return g}checkForChangesAndNotify(){const g=this.getLayouts();deepEqual(this.outputLayouts,g)?this.logger.safe.debug("Layout has not changed, skip update"):(this.outputLayouts=g.slice(),this.event("onLayoutsChanged").raise())}storeAvailableBandwidth(g){this.logger.safe.debug(`Set available bandwidth: ${g}`),this.totalBandwidth=g,this.totalBandwidthMax=Math.max(this.totalBandwidthMax,this.totalBandwidth)}},V_=class extends U_{constructor(g,m){super(g,m,2),this.resolutionManager=new k_(this.logger.createChild("BWEControlledResolutionManager"))}getLayouts(){return this.hiFiLayout?[this.loFiLayout,this.hiFiLayout]:[this.loFiLayout]}dispose(){super.dispose(),this.resolutionManager=null}getHighLayoutBandwidth(g){const m=this.inputLayouts?.[0].maxBr||0,f=Math.max(g-m,0);this.logger.safe.debug(`Setting available bandwidth for layouts. High: ${f}, low: ${m||"not set"}, total: ${g}`);const S=this.configProvider.config.specCompliantSimulcast?.allowedBweOvershootRatio||1;return Math.floor(f*S)}recalculateLayouts(){const g=this.hiFiLayout,m=this.getHighLayoutBandwidth(this.totalBandwidth);this.resolutionManager.setAvailableBandwidth(m),this.resolutionManager.setMaxFrameSize(this.inputLayouts[1].maxFs),this.loFiLayout=this.getMinimalLayoutParams(this.inputLayouts),this.hiFiLayout=this.getHighLayoutParams(this.inputLayouts,m,this.loFiLayout),this.loFiLayout=this.adjustLowLayoutBasedOnHighLayout(this.hiFiLayout,this.loFiLayout,g)}adjustLowLayoutBasedOnHighLayout(g,m,f){return this.configProvider.config.useMediaQualityControllerForceKeyFrame&&!g&&f&&(this.logger.safe.debug("Forcing kayframe on low layout due to disabling high layout"),m.keyframe=!0),g?(m.maxBr===g.maxBr&&m.maxBr--,m):m}getPrioritizedLayouts(g){return g.sort(((g,m)=>g.maxFs-m.maxFs?g.maxFs-m.maxFs:g.maxFps-m.maxFps))}getHighLayoutParams(g,m,f){const S=g[1];if(S.maxBr<=m)return this.logger.safe.debug(`High layout bandwidth suits requested caps. Applying as-is: ${JSON.stringify(S)}`),S;const v={...g[1],maxFs:this.resolutionManager.getFrameSize(),maxBr:Math.min(m,g[1].maxBr),maxFps:g[1].maxFps},C=v.maxBr<f.maxBr||v.maxFs<f.maxFs||v.maxFs===f.maxFs&&v.maxFps<=f.maxFps,_=`Potential high layout: ${JSON.stringify(v)}`;return!this.hiFiLayout&&C?(this.logger.safe.debug(`High layout is already disabled. Do nothing. ${_}`),null):this.hiFiLayout&&C?(this.logger.safe.debug(`High layout gets disabled. ${_}`),null):(this.hiFiLayout&&deepEqual(v,this.hiFiLayout)?this.logger.safe.debug(`High layout has not been changed. Do nothing. ${_}`):this.hiFiLayout?this.logger.safe.debug(`High layout updated. ${_}`):this.logger.safe.debug(`High layout enabled. ${_}`),v)}getMinimalLayoutParams(g){const m=Math.min(g[0].maxBr,g[1].maxBr),f=this.configProvider.config.specCompliantSimulcast.maxBrControlEnabled?limitStreamMaxBitrate(m,this.totalBandwidth,this.configProvider.config.specCompliantSimulcast.bitrateToBweTable):m;return{...g[0],maxBr:f,maxFps:Math.min(g[0].maxFps,g[1].maxFps),maxFs:Math.min(g[0].maxFs,g[1].maxFs)}}},B_=class extends U_{constructor(g,m,f){super(m,f,1),this.couldLimitFs=g}getLayouts(){return[this.layout]}recalculateLayouts(){let g=this.inputLayouts[0].maxFs;if(this.configProvider.config.specCompliantSimulcast.allowResLimit&&this.couldLimitFs&&this.totalBandwidthMax){const m=this.configProvider.config.specCompliantSimulcast.fsToBweTable;g=limitStreamMaxResolution(this.inputLayouts[0].maxFs,this.totalBandwidthMax,m)}const m=this.configProvider.config.specCompliantSimulcast.bitrateToBweTable,f=limitStreamMaxBitrate(this.inputLayouts[0].maxBr,this.totalBandwidth,m);this.layout={...this.inputLayouts[0],maxFs:g,maxBr:f}}},H_=class extends Be{constructor(g){super(g),this.logger=g,this.logger.safe.debug("Created")}dispose(){this.logger.safe.debug("Disposed"),super.dispose()}setAvailableBandwidth(g){this.logger.safe.debug(`Available bandwidth updated ${g}`)}setLayouts(g,m){this.layouts=g,this.setAvailableBandwidth(m)}getLayouts(){return this.layouts}},$_=class extends Be{constructor(g,m,f,S){super(S),this.supportSingleBwControl=g,this.configProvider=f,this.logger=S,this.multiStream=!1,this.deferredOperation=new N_((()=>this.updateStrategy()),this.configProvider.config.layoutControlTimeout,this.logger.createChild("DeferredOperation")),this.createStrategy(this.multiStream,m)}configure(g){const m=this.isMultiStream(g);this.multiStream!==m&&(this.multiStream=m,this.deferredOperation.invoke(this.multiStream&&!this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled))}setLayouts(g,m){deepEqual(this.latestLayouts,g)&&this.latestBandwidth===m?this.logger.safe.debug("Layouts and bandwidth are not changed. Skipping update"):(this.latestLayouts=g,this.latestBandwidth=m,this.strategy.setLayouts(this.latestLayouts,m))}setAvailableBandwidth(g){this.latestBandwidth!==g?(this.strategy.setAvailableBandwidth(g),this.latestBandwidth=g):this.logger.safe.debug("Bandwidth is not changed. Skipping update")}getLayouts(){return this.strategy.getLayouts()}dispose(){this.strategy.dispose(),this.strategy=null,this.deferredOperation.dispose(),this.deferredOperation=null,super.dispose()}updateStrategy(){this.strategy.dispose(),this.createStrategy(this.multiStream),this.latestLayouts&&this.strategy.setLayouts(this.latestLayouts,this.latestBandwidth)}isMultiStream(g){return g>1}createStrategy(g,m=!1){this.strategy=this.getNewStrategy(g,m),this.strategy.on("onLayoutsChanged",(()=>{this.event("onLayoutsChanged").raise()}))}getNewStrategy(g,m){return g?new V_(this.configProvider,this.logger.createChild("BWEControlledStrategy")):this.configProvider.config.specCompliantSimulcast?.maxBrControlEnabled&&this.supportSingleBwControl?new B_(m,this.configProvider,this.logger.createChild("BWEControlledStrategySingle")):new H_(this.logger.createChild("NoControlStrategy"))}},G_=class extends Be{constructor(g,m,f){super(f),this.statisticsGatherer=g,this.configProvider=m,this.logger=f,this.bandwidthAllocator=null,this.bandwidthCalculator=new KC(this.configProvider,this.statisticsGatherer,this.logger.createChild("SendBandwidthCalculator")),this.layoutProviders=new Map,this.hadLayoutProvider=new Set,this.bandwidthAllocator=createBandwidthAllocatorPerMediaType(this.logger,this.configProvider),this.bandwidthCalculator.on("onSendBandwidthChanged",(g=>this.onAvailableBandwithChanged(g)))}dispose(){this.bandwidthCalculator?.dispose(),this.bandwidthCalculator=null,this.bandwidthAllocator=null,this.layoutProviders.forEach((g=>g.dispose())),this.layoutProviders.clear(),this.layoutProviders=null,super.dispose()}addReceiver(g,m){this.logger.safe.debug(`Set receiver max capabilities for ${g}: ${JSON.stringify(m)}`),this.configureProviders(g,m.length);const f=m.map((g=>g.maxBr)).reduce(((g,m)=>g+m));this.bandwidthAllocator.addReceiverCapabilty(g,f);const S=this.bandwidthAllocator.getLayouts();this.layoutProviders.get(g).setLayouts(m,S[g]),this.updateBandwidthDistribution()}removeReceiver(g){this.logger.safe.debug(`Removing receiver for ${g}`),this.layoutProviders.get(g)?.dispose(),this.layoutProviders.delete(g),this.bandwidthAllocator.removeReceiver(g),this.updateBandwidthDistribution()}getLayouts(g){return this.layoutProviders.get(g).getLayouts()}configureProviders(g,m){if(!this.layoutProviders.has(g)){const m=this.createProvider(g);this.layoutProviders.set(g,m)}this.layoutProviders.get(g).configure(m)}createProvider(g){const m=new $_("Video"===g,!this.hadLayoutProvider.has(g),this.configProvider,this.logger.createChild(`LG:${g}`));return m.on("onLayoutsChanged",(()=>{const f=m.getLayouts();this.logger.safe.debug(`New layouts generated: ${JSON.stringify(f)}`),this.event("onLayoutsUpdated").raise(g)})),this.hadLayoutProvider.add(g),m}onAvailableBandwithChanged(g){this.bandwidthAllocator.setAvailableBandwidth(g),this.updateBandwidthDistribution()}updateBandwidthDistribution(){const g=this.bandwidthAllocator.getLayouts();for(const[m,f]of Object.entries(g))this.layoutProviders.get(m)?.setAvailableBandwidth(f)}},j_=R,convertResolutionToFramesize=g=>jp.Send.getResolutionForHeight(g).fs;function mergeCapabilitiesWithCallConstraints(g,m,f){if("Video"!==g||!f)return f;const{maxBitrate:S,maxResolution:v,maxFramerate:C}=m.config.outgoingVideoLimit??{},_=S??1/0,E=v?convertResolutionToFramesize(v):1/0,T=C??1/0;return _===1/0&&E===1/0&&T===1/0?f:f.map((g=>({...g,maxFs:getMinDefined(g.maxFs,E),maxBr:getMinDefined(g.maxBr,_),maxFps:getMinDefined(g.maxFps,T)})))}var W_=class{constructor(g,m,f,S,v){this.sender=g,this.streamResolution=m,this.maxSimulcastLayerCount=f,this.logger=S,this.configProvider=v}async setCapabilities(g){if(!(0,j_.isEqual)(this.currentCapabilities,g))return this.defaultCapabilities=(0,j_.cloneDeep)(g),this.currentCapabilities=(0,j_.cloneDeep)(g),await this.generateKeyFrameIfNeeded(g),this.applyCapabilities(g,0);this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`)}async updateStreamQualityParams(g,m,f){if(g&&!(0,j_.isEqual)(this.streamResolution,g))return this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.streamResolution=g,this.applyCapabilities(this.currentCapabilities,f);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async stop(){return this.logger.safe.info("Stopping senders."),this.deactivateSenders()}applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.sender.mediaType,this.configProvider,this.defaultCapabilities),this.applyCapabilities(this.currentCapabilities,3)}getScaleFactor(g){const m=jp.Send.getResolutionByFs(g),f=this.streamResolution;let S=Math.min(f.width,f.height)/m.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(f)} and new Fs: ${g} as ${S}`),S<1&&(this.logger.safe.error("Scale factor cannot be less than 1! Limiting to 1"),S=1),S}deactivateSenders(){const g=this.sender.rtpSender.getParameters();return g.encodings.forEach((g=>g.active=!1)),this.logger.safe.info(`Stopping senders. Encoding params to set: ${JSON.stringify(g.encodings)}`),this.sender.rtpSender.setParameters(g)}async generateKeyFrameIfNeeded(g){const m=this.sender.rtpSender.getParameters(),f=[];if(g.forEach((g=>{const S=this.getEncondingIndexForRid(g.rid,m.encodings),v=m.encodings[S];g.keyframe&&v.active?(this.logger.safe.info(`Keyframe is needed for encoder with index ${S}`),f.push(S)):this.logger.safe.info(`Keyframe is not needed for index ${S} because encoding is active: ${v.active} or KF is requested: ${g.keyframe}`)})),0===f.length)return void this.logger.safe.info("No keyframes needed. Skipping");const S=this.getParamsForKeyFrame(m,f);return this.logger.safe.info(`Applying keyframe encoding params new: ${JSON.stringify(S.encodings)}, old: ${JSON.stringify(m.encodings)}`),this.sender.rtpSender.setParameters(S)}async applyCapabilities(g,m){if(!g)return void this.logger.safe.info("Capabilities are not set. Do nothing");await this.applyStreamCapabilities(g,m);const f=this.sender.rtpSender.getParameters(),S=(0,j_.cloneDeep)(f);return g.forEach((g=>{const m=this.getEncondingIndexForRid(g.rid,f.encodings);this.updateEncodingsWithCaps(f.encodings[m],g)})),this.updateActiveStates(f,g),this.logger.safe.info(`Encoding params new: ${JSON.stringify(f.encodings)}, old: ${JSON.stringify(S.encodings)}`),this.sender.rtpSender.setParameters(f)}async applyStreamCapabilities(g,m){if(!this.configProvider.config.specCompliantSimulcast?.video?.useApplyConstraints||2===m||!g.length||"Video"!==this.sender.mediaType)return;let f=g[0];for(const m of g)f.maxFs<m.maxFs&&(f=m);g.length>1&&(f=(0,j_.cloneDeep)(f),f.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,f.maxFs)),this.streamResolution=await this.sender.applyStreamCapabilities(f)}getEncondingIndexForRid(g,m){if(!g)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const f=m.findIndex((m=>m.rid===g));return f<0||f-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):f}updateEncodingsWithCaps(g,m){g?(g.maxBitrate=m.maxBr,g.scaleResolutionDownBy=this.getScaleFactor(m.maxFs),g.maxFramerate=m.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(m)}`)}updateActiveStates(g,m){const f=g.encodings.map((g=>g.rid)),S=f.filter((g=>m.some((m=>g===m.rid)))),v=subtractFrom(f,S);S.forEach((m=>this.changeEncodingState(g,m,!0))),v.forEach((m=>this.changeEncodingState(g,m,!1)))}changeEncodingState(g,m,f){const S=g.encodings.find((g=>g.rid===m));S?S.active=f:this.logger.safe.error(`Encoding not found for RID: ${m}`)}getParamsForKeyFrame(g,m){const f=(0,j_.cloneDeep)(g);return m.forEach((g=>{f.encodings[g].active&&f.encodings[g].scaleResolutionDownBy&&(f.encodings[g]=this.getEncodingParamsForKeyFrame(f.encodings[g]))})),f}getEncodingParamsForKeyFrame(g){const m=(0,j_.cloneDeep)(g);return m.scaleResolutionDownBy&&(m.scaleResolutionDownBy=1.1*g.scaleResolutionDownBy),m}},q_=class{constructor(g,m,f){this.sender=g,this.logger=m,this.configProvider=f}applyCallConstraints(g){this.logger.safe.info(`[${g}] Applying call constraints`);const m=mergeCapabilitiesWithCallConstraints(this.sender.mediaType,this.configProvider,this.currentCapabilities);return this.setCapabilities(m)}async setCapabilities(g){if(0===g.length||1!==g.length)return void this.logger.safe.error("Incorrect number of sender params!");this.currentCapabilities=g;const m=this.currentCapabilities?.find((g=>"1"===g.rid))??this.currentCapabilities?.[0];await this.sender.setParameters(m),await this.sender.start()}updateStreamQualityParams(g,m,f){return this.sender.updateStreamQualityParams(g,m,f)}async stop(){await this.sender.stop()}},z_=R,K_=class{constructor(g,m){this.configProvider=g,this.logger=m}async setActive(g,m){const f=this.getSenderParameters(g);return f.encodings[0].active=m,this.setSenderParameters(g,f,"setActive")}getScaleFactor(g,m){if(!m.width||!m.height)return this.logger.safe.warn("Stream resolution is not set yet. Cannot calculate scale factor. Returning 1"),1;const f=jp.Send.getResolutionByFs(g);let S=Math.min(m.width,m.height)/f.height;return this.logger.safe.debug(`Scale factor is taken from resolution: ${JSON.stringify(m)} and new Fs: ${g} as ${S}`),S<1&&(this.logger.safe.warn("Scale factor cannot be less than 1! Limiting to 1"),S=1),S}async generateKeyFrameIfNeeded(g,m){if(!m.track)return void this.logger.safe.info("No track attached. Skipping");const f=this.getSenderParameters(m),S=g.filter((g=>g.keyframe)).map((g=>g.rid));if(0===S.length||!f.encodings.some((g=>g.active)))return void this.logger.safe.info("No keyframes needed. Skipping");const v=f.encodings.map(((g,m)=>g.active?g.rid&&!S.includes(g.rid)?null:{idx:m,factor:g.scaleResolutionDownBy||1}:null)).filter((g=>g));for(const g of v)f.encodings[g.idx].scaleResolutionDownBy=g.factor*this.configProvider.config.forceKeyFrameV2ScaleFactor;this.logger.safe.debug(`Restoring keyframe starting. Update scaleResolutionDownBy for encodings: ${JSON.stringify(f.encodings)}`),await this.setSenderParameters(m,f,"generateKeyFrameStart");const C=this.getSenderParameters(m);for(const g of v)C.encodings[g.idx].scaleResolutionDownBy=g.factor;await this.setSenderParameters(m,C,"generateKeyFrameEnd"),this.logger.safe.debug(`Restoring keyframe completed. Set scaleResolutionDownBy back for encodings: ${JSON.stringify(C.encodings)}`)}getSenderParameters(g){const m=g.getParameters();if(m.encodings?.length||(m.encodings=[{}]),this.configProvider.config.reuseLastSetParameters&&this.lastSetEncodings){this.logger.safe.info(`Override returned encodings ${JSON.stringify(m.encodings)}`);const g=(0,z_.merge)((0,z_.cloneDeep)(m.encodings),this.lastSetEncodings);this.logger.safe.info(`Overrided encodings ${JSON.stringify(g)}`),m.encodings=g}return m}async setSenderParameters(g,m,f,S=!0){try{await g.setParameters(m),this.logger.safe.info(`${f}: Parameters applied for sender: ${JSON.stringify(m.encodings)}`),this.lastSetEncodings=m.encodings}catch(g){const v=`${f}: setParameters failed. Parameters: ${JSON.stringify(m.encodings)}, error:  ${stringifyObject(g)}`;if(this.logger.safe.error(v),S)throw new Error(v)}}getAdjustedBitrate(g,m){let f=g||0;const S=jp.Send.getResolutionRecord(m.width,m.height);return f=Math.min(f||S.maxBitrate,S.maxBitrate),f}async updateStreamParameters(g,m,f){if(g.getCurrentConstraints().withEffect&&m?.maxFs){const f=jp.Send.getResolutionByFs(m.maxFs),S={width:f.width,height:f.height};this.logger.safe.info(`Applying video constrains for video effetcs ${JSON.stringify(S)}`),g.resetEffectsOutputConstraints(S)}f&&await g.applyCapabilities(m)}},J_=class{constructor(g,m,f){this.maxSimulcastLayerCount=g,this.configProvider=m,this.logger=f,this.capabiltiesHelper=new K_(this.configProvider,this.logger)}setSender(g){this.rtpSender=g}updateStream(g){this.stream=g,this.streamResolution=g.getResolution()}setActive(g){return this.capabiltiesHelper.setActive(this.rtpSender,g)}async setCapabilities(g){(0,z_.isEqual)(this.currentCapabilities,g)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`):(this.defaultCapabilities=(0,z_.cloneDeep)(g),this.currentCapabilities=(0,z_.cloneDeep)(g),await this.applyLastCapabilities(),await this.capabiltiesHelper.generateKeyFrameIfNeeded(g,this.rtpSender))}async updateStreamQualityParams(g,m,f){if(g&&!(0,z_.isEqual)(this.streamResolution,g))return this.streamResolution=g,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.applyLastCapabilities();this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async startSender(){}async stopSender(){this.logger.safe.info("Stopping senders.");const g=this.capabiltiesHelper.getSenderParameters(this.rtpSender);return g.encodings.forEach((g=>g.active=!1)),this.capabiltiesHelper.setSenderParameters(this.rtpSender,g,"Stopping senders")}async applyLastCapabilities(){if(!this.currentCapabilities)return void this.logger.safe.info("Capabilities are not set. Do nothing");this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.stream.mediaType,this.configProvider,this.defaultCapabilities),await this.applyStreamCapabilities(this.currentCapabilities);const g=this.capabiltiesHelper.getSenderParameters(this.rtpSender),m=(0,z_.cloneDeep)(g);return this.currentCapabilities.forEach((m=>{const f=this.getEncondingIndexForRid(m.rid,g.encodings);this.updateEncodingsWithCaps(g.encodings[f],m)})),this.updateActiveStates(g,this.currentCapabilities),this.logger.safe.info(`Encoding params new: ${JSON.stringify(g.encodings)}, old: ${JSON.stringify(m.encodings)}`),this.capabiltiesHelper.setSenderParameters(this.rtpSender,g,"applyCapabilities")}async applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.applyLastCapabilities()}async applyStreamCapabilities(g){if("Video"!==this.stream.mediaType||!g.length)return;let m=g[0];for(const f of g)m.maxFs<f.maxFs&&(m=f);g.length>1&&(m=(0,z_.cloneDeep)(m),m.maxFs=Math.max(this.configProvider.config.specCompliantSimulcast.video.minFsForSimulcast||0,m.maxFs));const f=this.configProvider.config.specCompliantSimulcast.video.useApplyConstraints;await this.capabiltiesHelper.updateStreamParameters(this.stream,m,f),f&&(this.streamResolution=this.stream.getResolution())}getEncondingIndexForRid(g,m){if(!g)return this.logger.safe.error("No RID found in incoming params. Returning index 0"),0;const f=m.findIndex((m=>m.rid===g));return f<0||f-1>this.maxSimulcastLayerCount?(this.logger.safe.error("Incorrect index deduced from requested RID. Returning index 0"),0):f}updateEncodingsWithCaps(g,m){g?(g.maxBitrate=m.maxBr,g.scaleResolutionDownBy=this.capabiltiesHelper.getScaleFactor(m.maxFs,this.streamResolution),g.maxFramerate=m.maxFps):this.logger.safe.error(`SenderParams does not exist for caps: ${JSON.stringify(m)}`)}updateActiveStates(g,m){const f=g.encodings.map((g=>g.rid)),S=f.filter((g=>m.some((m=>g===m.rid)))),v=subtractFrom(f,S);S.forEach((m=>this.changeEncodingState(g,m,!0))),v.forEach((m=>this.changeEncodingState(g,m,!1)))}changeEncodingState(g,m,f){const S=g.encodings.find((g=>g.rid===m));S?S.active=f:this.logger.safe.error(`Encoding not found for RID: ${m}`)}},Y_=class{constructor(g,m){this.configProvider=g,this.logger=m,this.capabiltiesHelper=new K_(this.configProvider,this.logger)}get params(){return this.currentCapabilities?.find((g=>"1"===g.rid))??this.currentCapabilities?.[0]}async applyCallConstraints(g){return this.logger.safe.info(`[${g}] Applying call constraints`),this.applyLastCapabilities(3)}setSender(g){this.rtpSender=g}updateStream(g){this.stream=g,this.streamResolution=g.getResolution()}setActive(g){return this.capabiltiesHelper.setActive(this.rtpSender,g)}async setCapabilities(g){(0,z_.isEqual)(this.currentCapabilities,g)?this.logger.safe.info(`Capabilities already applied: ${JSON.stringify(g)}. Do nothing`):1===g.length?(this.defaultCapabilities=(0,z_.cloneDeep)(g),this.currentCapabilities=(0,z_.cloneDeep)(g),await this.applyLastCapabilities(0),await this.capabiltiesHelper.generateKeyFrameIfNeeded(g,this.rtpSender)):this.logger.safe.error("Incorrect number of sender params!")}async updateStreamQualityParams(g,m,f){if(g&&!(0,z_.isEqual)(this.streamResolution,g))return this.streamResolution=g,this.logger.safe.debug(`Stream params changed: ${JSON.stringify(g)}@${m}`),this.applyLastCapabilities(f);this.logger.safe.debug(`Resolution is not defined or same: ${JSON.stringify(g)}@${m}`)}async startSender(g){this.logger.safe.info(`Replace sender with track: ${g.id}`),await this.rtpSender.replaceTrack(g),this.logger.safe.info("replaceTrack completed"),this.configProvider.config.applySenderParamsBeforeStart&&this.currentCapabilities&&await this.capabiltiesHelper.generateKeyFrameIfNeeded(this.currentCapabilities,this.rtpSender)}async stopSender(){this.logger.safe.info("Replace sender with track: null"),await this.rtpSender.replaceTrack(null),this.logger.safe.info("replaceTrack completed")}async applyLastCapabilities(g){this.currentCapabilities?(this.currentCapabilities=mergeCapabilitiesWithCallConstraints(this.stream.mediaType,this.configProvider,this.defaultCapabilities),this.logger.safe.info(`Applying params: ${JSON.stringify(this.params)}`),await this.applyParams(this.params,g),await this.applyBitrate(this.params.maxBr)):this.logger.safe.debug("Capabilities are not yet set, nothing to apply")}applyBitrate(g){let m=g||0;return"Video"===this.stream.mediaType&&(m=this.capabiltiesHelper.getAdjustedBitrate(m,this.streamResolution)),this.setSingleEncodingParameters(this.rtpSender,{maxBitrate:m},"applyBitrate",!1)}async applyParams(g,m){if(this.configProvider.config.useSetParametersToApplyCapabilities)return this.setSingleEncodingParameters(this.rtpSender,{scaleResolutionDownBy:this.capabiltiesHelper.getScaleFactor(g.maxFs,this.streamResolution),maxFramerate:g.maxFps},"applyParams");2!==m&&await this.capabiltiesHelper.updateStreamParameters(this.stream,g,!0)}async setSingleEncodingParameters(g,m,f,S=!0){const v=this.capabiltiesHelper.getSenderParameters(g);return(0,z_.merge)(v.encodings[0],m),0===v.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?v.encodings[0].maxBitrate=void 0:delete v.encodings[0].maxBitrate),this.capabiltiesHelper.setSenderParameters(this.rtpSender,v,f,S)}},Q_=class{constructor(g,m,f){this.transitionStates=g,this.logger=f,this.stateInternal=m}get state(){return this.stateInternal}isDestinationStateValid(g){return this.transitionStates[this.stateInternal].indexOf(g)>-1}setState(g){return this.isDestinationStateValid(g)?(this.stateInternal=g,!0):(this.logger.safe.info(`Invalid state transition ${this.stateInternal} -> ${g}`),!1)}isCurrentStateMatchedWith(g){return this.stateInternal===g||(this.logger.safe.info(`State does not match. Current: ${this.stateInternal} required: ${g}`),!1)}},X_=R,Z_=class{constructor(g,m=document.body){this.logger=g,this.parentElement=m,this.container=this.createContainerElement(),this.video=this.createVideoElement(),this.canvas=this.createCanvasElement(),this.context=this.canvas.getContext("2d"),this.medaiQuery=window.matchMedia("(orientation: portrait)"),this.isPortrait=this.medaiQuery.matches,this.captureFrameRate=30,this.mediaQueryChangeListener=g=>{this.isPortrait=g.matches},this.container.append(this.video,this.canvas),this.parentElement.prepend(this.container),this.medaiQuery.addEventListener("change",this.mediaQueryChangeListener)}modify(g){this.logger.safe.info("modify()"),this.clearAnimationFrames(),this.disposeStream(),this.stream=this.canvas.captureStream(this.captureFrameRate),this.video.srcObject=new MediaStream([g]),this.video.play();let m=g.getSettings(),f=0,S=0;const requestFrame=()=>{m=g.getSettings();const v=this.isPortrait?Math.min(m.width,m.height):Math.max(m.width,m.height),C=this.isPortrait?Math.max(m.width,m.height):Math.min(m.width,m.height);f===v&&S===C||(this.canvas.width=v,this.canvas.height=C,f=v,S=C),this.context.drawImage(this.video,0,0,v,C),this.animationFrame=requestAnimationFrame(requestFrame)};return this.animationFrame=requestAnimationFrame(requestFrame),this.stream.getVideoTracks()[0]}dispose(){this.logger.safe.info("dispose()"),this.clearAnimationFrames(),this.disposeStream(),this.container.parentElement.removeChild(this.container),this.medaiQuery.removeEventListener("change",this.mediaQueryChangeListener)}disposeStream(){this.stream&&(this.stream.getTracks().forEach((g=>g.stop())),this.stream=void 0)}createContainerElement(){const g=document.createElement("div");return g.style.opacity="0",g.style.position="fixed",g.style.zIndex="-2147483648",g.style.pointerEvents="none",g.style.top="0",g.style.left="0",g.style.bottom="0",g.style.right="0",g}createVideoElement(){const g=document.createElement("video");return g.setAttribute("muted",""),g.setAttribute("playsinline",""),g.setAttribute("autoplay",""),g.style.top="0",g.style.left="0",g}createCanvasElement(){const g=document.createElement("canvas");return g.style.right="0",g.style.bottom="0",g}clearAnimationFrames(){this.logger.safe.info("clearAnimationFrames()"),this.animationFrame&&(cancelAnimationFrame(this.animationFrame),this.animationFrame=void 0)}},eE=class extends Be{constructor(g){super(g),this.logger=g,this.audioContext=new Ws.window.AudioContext,this.destination=this.audioContext.createMediaStreamDestination(),this.streamNodeMap=new Map,this.logger.safe.info(`Destination stream: ${this.destination.stream.id}, track: ${this.getDestinationTrack().id}`),this.subscribeOnMediaTrackEvents(this.getDestinationTrack())}get numberOfStreams(){return this.streamNodeMap.size}addSourceStream(g){if(!g.rawStream)return;if(this.streamNodeMap.has(g.rawStream))return;const m=g.on("onStreamClientDisposing",(()=>{this.removeSourceStream(g.rawStream),m.dispose()}));this.logger.safe.info(`Add stream: ${g.rawStream.id}, track: ${getTrack(g.rawStream).id}`),this.addStream(g.rawStream,g.mediaType)}getDestinationTrack(){return getTrack(this.destination.stream)}dispose(){super.dispose(),this.unsubscribeFromMediaTrackEvents(this.getDestinationTrack());for(const g of this.streamNodeMap.keys())this.removeSourceStream(g);this.audioContext.close(),this.audioContext=null}addStream(g,m="Audio"){const f=this.audioContext.createMediaStreamSource(g);f.connect(this.destination),this.streamNodeMap.set(g,{mediaType:m,sourceNode:f})}removeSourceStream(g){const m=this.streamNodeMap.get(g);m&&(this.logger.safe.info(`Remove stream: ${g.id}, track: ${getTrack(g).id}`),m.sourceNode.disconnect(),this.streamNodeMap.delete(g))}subscribeOnMediaTrackEvents(g){g.onended=m=>{this.logger.safe.info(`Track ${g.id} ended: ${JSON.stringify(m)}`)},g.onmute=()=>{this.logger.safe.info(`Track ${g.id} muted`)},g.onunmute=()=>{this.logger.safe.info(`Track ${g.id} unmuted`)}}unsubscribeFromMediaTrackEvents(g){g.onended=null,g.onmute=null,g.onunmute=null}};function getTrack(g){return g.getAudioTracks()[0]}var tE=class{constructor(g){this.logger=g}createBaseInstanse(g){this.imp=new iE,g.addTransform(this.imp)}createWorkerInstanse(g,m){this.imp=new nE(g,m)}mute(g){this.logger.safe.info(`Dropping audio chunks: ${g}`),this.imp.mute(g)}},iE=class{constructor(){this.transformType=1,this.muted=!1}transform(g){return this.muted?null:g}mute(g){this.muted=g}dispose(){}},nE=class extends d_{constructor(g,m){super(g,m,1,void 0)}mute(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"mute",args:[g]}})}},rE=class extends Be{constructor(g,m,f,S,v,C){super(),this.mediaConnection=g,this.contextStream=f,this.logger=S,this.configProvider=v,this.encStreamsManager=C,this.isActive=!1,this.isMuted=!1,this.configProvider.config.renderThroughCanvas&&(this.videoThroughCanvas=new Z_(this.logger.createChild("videoThroughCanvas"))),this.stream=m.clone("streamSender ctor"),this.streamResolution=this.stream.getResolution()}get rtpSender(){return this.sender}get trackId(){const g=this.rawTrack;return g?.id}get mediaType(){return this.stream.mediaType}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get canvasedRawTrack(){return this.configProvider.config.renderThroughCanvas?"Video"!==this.stream.mediaType?this.rawTrack:this.videoThroughCanvas?.modify(this.rawTrack)??this.rawTrack:this.rawTrack}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms()}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.wakeSender(),this.params&&await this.applyParams(this.params,0),this.logger.safe.info("Started"))}async stop(){if(this.isActive){if(this.logger.safe.info("Stopping"),this.isActive=!1,"Audio"!==this.stream.mediaType){const g=this.configProvider.config.webrtcDisabledSenderBitrate;await this.applyBitrate(g,!1)}await this.sleepSender(),this.logger.safe.info("Stopped")}else this.logger.safe.info("Already stopped. Do nothing")}setMuted(g,m,f){this.isMuted=g,this.stream.setMuted(g,m),g&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(g),!this.configProvider.config.requestNewStreamOnUnmute||g||f||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(g,m){return this.activateSender(!g,m)}async setMainStream(g){if(this.stream.dispose(),this.stream=g.clone("streamSender setMainStream"),this.streamResolution=this.stream.getResolution(),this.stream.setMuted(this.isMuted),this.params&&await this.applyCapabilities(this.params,1),this.audioMixer?.addSourceStream(this.stream),this.isActive){const g=this.rawTrack?.id;this.logger.safe.info(`Replace sender with track: ${g}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Replace completed")}}async addAdditionalStream(g){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(g),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}async setParameters(g,m=!1,f=0){if(m||this.params!==g){if(this.params=g,this.isActive)return this.applyParams(this.params,f);this.logger.safe.info("Sender is not active, preserving params")}}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((g=>g.active)).map((g=>+g.rid))}async updateStreamQualityParams(g,m,f){if(this.configProvider.config.useSetParametersToApplyCapabilities)if(g){if(this.logger.safe.debug(`Stream resolution has changed to ${JSON.stringify(g)}@${m}, re-applying send parameters`),this.streamResolution=g,this.params)return this.setParameters(this.params,!0,f);this.logger.safe.debug("Params are not yet set, do nothing")}else this.logger.safe.debug(`Resolution is not defined: ${JSON.stringify(g)}@${m}`)}async applyStreamCapabilities(g){return await this.stream.applyCapabilities(g),this.stream.getResolution()}async applyParams(g,m){this.logger.safe.info(`Applying params: ${JSON.stringify(g)}`),await this.applyCapabilities(g,m),await this.applyBitrate(g.maxBr),this.params.keyframe&&await this.forceKeyframe()}applyBitrate(g,m=!0){const f=m?this.getAdjustedBitrate(g):g;return this.setEncodingParameters({maxBitrate:f},"applyBitrate")}getAdjustedBitrate(g){let m=g||0;if("Video"===this.stream.mediaType){const g=jp.Send.getResolutionRecord(this.streamResolution.width,this.streamResolution.height);m=Math.min(m||g.maxBitrate,g.maxBitrate)}return m}async activateSender(g,m){await this.setEncodingParameters({active:g},"activateSender"),this.logger.safe.info(`[${m}] Active state applied isActive = ${g}`)}async forceKeyframe(){if(!this.sender)return this.logger.safe.error("No sender available"),null;if(!this.sender.track)return void this.logger.safe.info("Sender track does not exist, not restoring keyframe");this.logger.safe.info("Restoring keyframe starting");const g=this.getSenderParameters().encodings[0].scaleResolutionDownBy||1;await this.setEncodingParameters({scaleResolutionDownBy:g*this.configProvider.config.forceKeyFrameV2ScaleFactor},"forceKeyframe start"),await this.setEncodingParameters({scaleResolutionDownBy:g},"forceKeyframe end"),this.logger.safe.info("Restoring keyframe finished")}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.canvasedRawTrack,this.contextStream,mediaTypeToModality(this.stream.mediaType))}async wakeSender(){this.logger.safe.info("Wake started"),await this.sender.replaceTrack(this.canvasedRawTrack),this.logger.safe.info("Wake completed")}async sleepSender(){this.logger.safe.info("Sleep started"),await this.sender.replaceTrack(null),this.logger.safe.info("Sleep completed")}addStreamTransforms(){const g=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);g&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new tE(this.logger.createChild("SendAudioPayload")),g.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&g.addTransform(new g_(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new eE(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const g=this.sender.getParameters();return g.encodings?.length||(g.encodings=[{}]),g}async setEncodingParameters(g,m,f=!1){const S=this.getSenderParameters();(0,X_.merge)(S.encodings[0],g),0===S.encodings[0].maxBitrate&&(this.configProvider.config.setParametersMaxBitrateUndefined?S.encodings[0].maxBitrate=void 0:delete S.encodings[0].maxBitrate);try{await this.sender.setParameters(S),this.logger.safe.info(`${m}: Parameters applied for sender: ${JSON.stringify(S.encodings[0])}`)}catch(g){if(this.logger.safe.error(`${m}: setParameters failed: ${stringifyObject(g)}, parameters ${JSON.stringify(S.encodings[0])}`),f)throw g}}async applyCapabilities(g,m){this.configProvider.config.useSetParametersToApplyCapabilities?await this.setEncodingParameters({scaleResolutionDownBy:this.getScaleFactor(g.maxFs),maxFramerate:g.maxFps},"applyCapabilities",!0):2!==m&&await this.applyStreamCapabilities(g)}getScaleFactor(g){const m=jp.Send.getResolutionByFs(g),{width:f,height:S}=this.streamResolution,v=Math.min(f,S)/m.height;return this.logger.safe.debug(`Current stream resolution: ${f}x${S}, scale factor: ${v}`),v<1?(this.logger.safe.warn(`Resolution scale factor is less than 1: ${v}`),1):v}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.stream=null,this.isActive=!1,this.videoThroughCanvas?.dispose()}},sE=class extends Be{constructor(g,m,f,S,v,C,_){super(),this.mediaConnection=g,this.contextStream=f,this.logger=S,this.configProvider=v,this.encStreamsManager=C,this.capabilitiesManager=_,this.isActive=!1,this.isMuted=!1,this.stream=m.clone("streamSender ctor"),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.updateStream(this.stream)}get rawTrack(){return this.audioMixer?.getDestinationTrack()||this.stream.rawTrack}get trackId(){const g=this.rawTrack;return g?.id}get rtpSender(){throw new Error("rtpSender getter not implemented.")}get mediaType(){throw new Error("mediaType getter not implemented.")}setParameters(g){throw new Error("setParameters not implemented.")}applyStreamCapabilities(g){throw new Error("applyStreamCapabilities not implemented.")}applyCallConstraints(g){return this.capabilitiesManager.applyCallConstraints(g)}async init(){this.sender=await this.createSender(),this.isActive=!0,this.addStreamTransforms(),this.capabilitiesManager.setSender(this.sender)}async start(){this.isActive?this.logger.safe.info("Already active. Do nothing"):(this.logger.safe.info("Starting"),this.isActive=!0,await this.capabilitiesManager.startSender(this.rawTrack),this.logger.safe.info("Started"))}async stop(){this.isActive?(this.logger.safe.info("Stopping"),this.isActive=!1,await this.capabilitiesManager.stopSender(),this.logger.safe.info("Stopped")):this.logger.safe.info("Already stopped. Do nothing")}async setCapabilities(g){this.configProvider.config.applySenderParamsBeforeStart||await this.start(),await this.capabilitiesManager.setCapabilities(g),await this.start()}updateStreamQualityParams(g,m,f){return this.capabilitiesManager.updateStreamQualityParams(g,m,f)}setMuted(g,m,f){this.isMuted=g,this.stream.setMuted(g,m),g&&this.audioMixer&&1!==this.audioMixer.numberOfStreams||this.audioMuteTransform?.mute(g),!this.configProvider.config.requestNewStreamOnUnmute||g||f||this.stream.isActive()||this.event("onNewStreamNeeded").raise()}async setHold(g,m){if(this.configProvider.config.holdSkipActivation)return;const f=!g;this.logger.safe.info(`[${m}] change isActive state to ${f}`);try{return this.capabilitiesManager.setActive(f)}catch(g){const S=this.configProvider.config.holdRetryActivationDelay;if(S>=0)return this.logger.safe.info(`[${m}] retrying after delay of ${S}`),await delay(S),this.logger.safe.info(`[${m}] change isActive state to ${f}, second attempt`),this.capabilitiesManager.setActive(f);throw g}}async setMainStream(g){return this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=g.clone("streamSender setMainStream"),this.stream.setMuted(this.isMuted),this.audioMixer?.addSourceStream(this.stream),this.isActive&&(this.logger.safe.info(`Replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("Replace completed")),this.capabilitiesManager.updateStream(this.stream),this.subscribeOnStreamClientMuted(),this.capabilitiesManager.applyLastCapabilities(1)}async addAdditionalStream(g){if("Audio"===this.stream.mediaType){if(this.configProvider.config.postponeAudioMixerForAudioSharing&&this.setupAudioMixer(),this.audioMixer||this.logger.safe.error(`addAdditionalStream is called when audioMixer is not created. Main stream type is ${this.stream.mediaType}.`),this.audioMixer?.addSourceStream(g),this.audioMuteTransform?.mute(!1),this.configProvider.config.postponeAudioMixerForAudioSharing){if(!this.sender)return void this.logger.safe.error("Sender not created, cannot replace track");this.logger.safe.info(`addAdditionalStream replace sender with track: ${this.rawTrack?.id}`),await this.sender.replaceTrack(this.rawTrack),this.logger.safe.info("addAdditionalStream replace completed")}}else this.logger.safe.error("Not adding additional stream for non-audio stream")}dispose(){this.removeSender(),this.cleanUp()}async terminateAsync(){await this.removeSenderAsync(),this.cleanUp()}getActiveStreamIndexes(){return this.getSenderParameters().encodings.filter((g=>g.active)).map((g=>+g.rid))}removeSender(){this.logger.safe.info("Removing sender from pc");try{this.mediaConnection.removeSender(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async removeSenderAsync(){this.logger.safe.info("Removing sender from pc");try{await this.mediaConnection.removeSenderAsync(this.sender)}catch(g){this.logger.safe.warn(`Error removing sender: ${stringifyObject(g)}`)}}async createSender(){return this.configProvider.config.postponeAudioMixerForAudioSharing||this.setupAudioMixer(),this.mediaConnection.createSender(this.rawTrack,this.contextStream,mediaTypeToModality(this.stream.mediaType))}addStreamTransforms(){const g=this.encStreamsManager.initTransformsCollection(this.sender,"Sender",this.stream.mediaType);g&&("Audio"===this.stream.mediaType?this.configProvider.config.useInsertableStreams?.audioExtendedMute&&(this.audioMuteTransform=new tE(this.logger.createChild("SendAudioPayload")),g.addTransform(this.audioMuteTransform)):this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&g.addTransform(new g_(this.logger.createChild(`SendStreamAnalyzer [${this.stream.mediaType}]`))))}clearStreamTransforms(){this.encStreamsManager.clearTransformsCollection(this.sender)}setupAudioMixer(){this.configProvider.config.enableAudioSharing?"Audio"===this.stream.mediaType?this.configProvider.config.audioSharingMemoryLeakFix&&this.audioMixer?this.logger.safe.debug("Audio mixer already created, not creating new one"):(this.audioMixer=new eE(this.logger.createChild("AudioMixer")),this.audioMixer.addSourceStream(this.stream)):this.logger.safe.error("Not setting up audio mixer for non-audio stream"):this.logger.safe.info("Audio sharing is disabled, not setting up audio mixer")}getSenderParameters(){const g=this.sender.getParameters();return g.encodings?.length||(g.encodings=[{}]),g}subscribeOnStreamClientMuted(){this.configProvider.config.recoverOnStreamUnmute&&(this.onStreamClientMutedSubscription=this.stream.on("onStreamClientMuted",(async(g,m)=>{m||await this.capabilitiesManager.applyLastCapabilities(1)})))}cleanUp(){super.dispose(),this.clearStreamTransforms(),this.sender=null,this.audioMixer?.dispose(),this.stream.dispose(),this.onStreamClientMutedSubscription?.dispose(),this.stream=null,this.isActive=!1}},aE=class _SimulcastStreamSender extends Be{constructor(g,m,f,S,v,C,_,E,T,I){super(),this.mediaConnection=g,this.mainStream=m,this.contextStream=f,this.mediaType=S,this.serialQueue=v,this.logger=C,this.configProvider=_,this.isAlwaysActive=E,this.encStreamsManager=T,this.simulcastContext=I,this.isMuted=!1,this.isHold=!1,this.previousParameters=[],this.state=new Q_(_SimulcastStreamSender.transitionStates,"NotStarted",this.logger),this.pendingStream=null,this.pendingParams=null,this.subscribeOnQualityUpdates(this.mainStream)}async start(){this.state.setState("Started")&&(this.sender=this.createSenderModel(),await this.sender.init(),this.notifyMaxVideoSendCapabilitiesChanged(),this.configProvider.config.deactiveAudioSender&&"Audio"===this.mediaType&&await this.sender.stop(),this.subscribeForSenderEvents())}async activate(){this.state.setState("Active")&&(this.pendingStream&&(await this.updateStreamInternal(this.pendingStream),this.pendingStream=null),this.isAlwaysActive&&!this.isMuted&&"Audio"===this.mediaType&&await this.sender.start(),this.isAlwaysActive?(this.event("onSendersChanged").raise(this,!0),this.logger.safe.info("Sender set to always active. Do not stopping")):await this.capabilitiesManager.stop(),this.configProvider.config.enableCachingFMTP&&this.pendingParams&&(this.logger.safe.info("Apply pending parameters"),await this.updateParametersInternal(this.pendingParams),this.pendingParams=null))}updateStream(g){return this.updateStreamInternal(g)}async addAdditionalStream(g){return this.sender.addAdditionalStream(g)}async updateParameters(g){if(this.state.isCurrentStateMatchedWith("Active"))return this.updateParametersInternal(g);this.configProvider.config.enableCachingFMTP?(this.logger.safe.info("Postpone params update until sender is activated"),this.pendingParams=g):this.logger.safe.warn("Ignore params update as sender is not activate")}async terminateAsync(){this.state.setState("Disposed")&&(this.logger.safe.info("Terminating async"),await this.sender.terminateAsync(),this.cleanUp())}dispose(){this.state.setState("Disposed")&&(this.logger.safe.info("Disposing"),this.sender.dispose(),this.cleanUp())}async setHold(g,m){if(this.isHold!==g)return this.logger.safe.info(`[${m}] Setting hold to: ${g}`),this.isHold=g,this.sender.setHold(g,m);this.logger.safe.info(`[${m}] Already in hold=${g} state`)}setMuted(g,m,f){this.logger.safe.info(`[${m}] Setting muted to: ${g}`),this.isMuted=g,this.sender.setMuted(this.isMuted,m,f),!this.isMuted&&"Audio"===this.mediaType&&this.state.isCurrentStateMatchedWith("Active")&&this.sender.start()}getActiveStreamIndexes(){return this.sender?this.sender.getActiveStreamIndexes():[]}getTrackInfo(){return{modality:mediaTypeToModality(this.mediaType),trackId:this.sender.trackId}}applyCallConstraints(g){return this.capabilitiesManager.applyCallConstraints(g)}createSenderModel(){if(this.configProvider.config.useSenderV2){const g=new sE(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("SenderV2"),this.configProvider,this.encStreamsManager,this.getCapabilitiesManagerV2(this.simulcastContext));return this.capabilitiesManager=g,g}const g=new rE(this.mediaConnection,this.mainStream,this.contextStream,this.logger.createChild("Sender"),this.configProvider,this.encStreamsManager);return this.capabilitiesManager=this.getCapabilitiesManager(g,this.simulcastContext),g}subscribeForSenderEvents(){this.sender.on("onNewStreamNeeded",(()=>this.event("onNewStreamNeeded").raise()))}getCapabilitiesManager(g,m){return m?.shouldUseSimulcast()?new W_(g,this.mainStream.getResolution(),m.config.layerScaleFactors.length,this.logger.createChild("SimCapMgr"),this.configProvider):new q_(g,this.logger.createChild("SnglCapMgr"),this.configProvider)}getCapabilitiesManagerV2(g){return g?.shouldUseSimulcast()?new J_(g.config.layerScaleFactors.length,this.configProvider,this.logger.createChild("SimCapMgrV2")):new Y_(this.configProvider,this.logger.createChild("SnglCapMgrV2"))}async updateStreamInternal(g){return this.state.isCurrentStateMatchedWith("Active")?this.mainStream!==g?(this.logger.safe.debug(`Switching streams: ${this.mainStream.parentId}:${this.mainStream.id} -> ${g.parentId}:${g.id}`),this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=g,this.subscribeOnQualityUpdates(this.mainStream),this.notifyMaxVideoSendCapabilitiesChanged(),await this.sender.setMainStream(this.mainStream),this.capabilitiesManager.updateStreamQualityParams(this.mainStream.getResolution(),this.mainStream.getFrameRate(),1)):void this.logger.safe.info("Stream has not been changed. Skipping update"):(this.logger.safe.info("Postponing stream update until sender is activated"),void this.setPendingStream(g))}async updateParametersInternal(g){await this.capabilitiesManager.setCapabilities(g),compareArraysBy(this.previousParameters,g,((g,m)=>g.ssrc===m.ssrc))||(this.previousParameters=g,this.event("onSendersChanged").raise(this,!0))}setPendingStream(g){this.pendingStream=g;const m=g.on("onStreamClientDisposing",(()=>{this.pendingStream===g&&(this.pendingStream=null,m.dispose())}))}subscribeOnQualityUpdates(g){this.sub=g.on("onStreamQualityChanged",((g,m,f,S)=>this.updateStreamQualityParams(m,f,S)))}updateStreamQualityParams(g,m,f){return f===qn.EffectQualityChangeReason.Performance&&this.notifyMaxVideoSendCapabilitiesChanged({resolution:g,fps:m}),this.capabilitiesManager.updateStreamQualityParams(g,m,2)}unsubscribeFromQualityEvents(){this.sub?.dispose(),this.sub=null}notifyMaxVideoSendCapabilitiesChanged(g){if(!["Video","ScreenShare"].includes(this.mediaType))return;const{width:m,height:f}=g?.resolution??this.mainStream.getResolution(),S=g?.fps??this.mainStream.getFrameRate();if(!m||!f||!S)return;const v=new $p(m,f),C={maxFs:v.fs,maxMbps:v.fs*S,maxFps:S,maxWidth:v.width,maxHeight:v.height};this.logger.safe.info(`Capabilities for ${this.mediaType} stream: ${JSON.stringify(C)}`),this.event("onMaxVideoSendCapabilitiesChanged").raise(C)}cleanUp(){this.unsubscribeFromQualityEvents(),this.mainStream.dispose(),this.mainStream=null,this.pendingStream&&this.pendingStream.dispose(),this.pendingStream=null,this.sender=null,this.contextStream=null,this.event("onSendersChanged").raise(this,!1),super.dispose()}};aE.transitionStates={NotStarted:["Started","Disposed"],Started:["Active","Disposed"],Active:["NotStarted","Disposed"],Disposed:[]},__decorateClass([sequentialize()],aE.prototype,"start",1),__decorateClass([sequentialize()],aE.prototype,"activate",1),__decorateClass([sequentialize()],aE.prototype,"updateStream",1),__decorateClass([sequentialize()],aE.prototype,"addAdditionalStream",1),__decorateClass([sequentialize()],aE.prototype,"updateParameters",1),__decorateClass([sequentialize()],aE.prototype,"terminateAsync",1),__decorateClass([sequentialize()],aE.prototype,"setHold",1),__decorateClass([sequentialize()],aE.prototype,"updateStreamQualityParams",1);var oE=aE,lE=class extends Be{constructor(g,m,f,S,v,C,_,E){super(m),this.mediaManager=g,this.logger=m,this.callDeviceManager=f,this.configProvider=S,this.statisticsGatherer=v,this.diagnostics=C,this.isMultiparty=_,this.encStreamsManager=E,this.senders=new Map,this.previousMediaModalitites={Audio:!1,Video:!1,ScreenShare:!1},this.serialQueue=new Lp(this.logger),this.muted=new Map([["Audio",!1],["Video",!1]]),this.subs=new Map,this.senderId=0,this.callConstraintsCauseId=void 0,this.streamsProvider=new R_(f,S,this.serialQueue,this.logger.createChild("StreamsProvider")),this.subscribeToStreamProviderEvents(),this.localVideoStreamWatcher=new t_(v,this.logger,this.configProvider,this.callDeviceManager),this.subscribeToStreamWatcherEvents(),this.configProvider.config.useMediaQualityController&&(this.mediaQualityController=new G_(this.statisticsGatherer,this.configProvider,this.logger.createChild("MQC")),this.mediaQualityController.on("onLayoutsUpdated",(g=>this.updateLayouts(g))))}dispose(){this.senders.forEach(((g,m)=>{this.event("onSendStreamChanged").raise(null,m),this.configProvider.config.disposeSendersSync?g.dispose():g.terminateAsync()})),this.senders.clear(),this.subs.forEach((g=>g.forEach((g=>g.dispose())))),this.subs.clear(),this.mediaConnection=null,this.unsubscribeFromStreamProviderEvents(),this.configProvider.config.disposeStreamsSync?this.streamsProvider.stop():this.streamsProvider.stopAsync(),this.streamsProvider=null,this.localVideoStreamWatcherSubs?.dispose(),this.localVideoStreamWatcher?.dispose(),this.localVideoStreamWatcher=null,this.mediaManager=null,this.logger=this.logger.createChild("DISPOSED"),this.mediaQualityController?.dispose(),this.mediaQualityController=null,super.dispose()}registerRtpSenderManager(g){this.mediaConnection=g}useNullAudioStreamClient(){this.streamsProvider.useNullAudioStreamClient()}async update(g,m,f,S){S?.mark("startUpdateStreams");const v=getSendMediaModalities(g),C=await this.updateStreams(v,m);return S?.markAndMeasure("startUpdateStreams","updateStreamsWithModalities"),await this.updateSenders(),S?.markAndMeasure("updateStreamsWithModalities","updateSenders"),this.applyMuteState(f,!0),this.setAndUpdateLocalTracksInfo(!1),this.previousMediaModalitites=shallowClone(C),mergeSendModalities(g,this.previousMediaModalitites)}async activate(g){this.logger.info(`[${g}] activate senders`),await Promise.all([...this.senders.values()].map((async g=>g.activate())))}applyCallConstraints(g){const m=this.senders.get("Video");return m?m.applyCallConstraints(g):(this.logger.info(`[${g}] Caching call constraints until sender is created`),this.callConstraintsCauseId=g,this.applyCallConstraintsDeferred=defer4(),this.applyCallConstraintsDeferred.promise)}async applyCapabilities(g,m,f){this.logger.safe.info(`[${g}] Applying incoming ${m} FMTP: ${JSON.stringify(f)}`);const S=modalityToMediaType(m);this.lastCauseId=g;let v=f;return this.mediaQualityController&&(this.mediaQualityController.addReceiver(S,f),v=this.mediaQualityController.getLayouts(S)),this.updateParameters(g,S,v)}getLocalMediaSources(){const g=this.getTracksInfo(),m=[];return g.forEach((g=>{m.some((m=>m.modality===g.modality))||m.push({sourceId:this.getSourceIdForTrack(g),modality:g.modality})})),m}setMuted(g,m,f){this.muted.set(g,m),this.applyMuteState(f,!1)}async setHold(g,m){await Promise.all([...this.senders.values()].map((async f=>f.setHold(g,m))))}async updateParameters(g,m,f){try{await this.applyCapabilitiesForMediaType(m,f),this.logger.safe.debug(`[${g}] Capabilities completed`);const S={modality:mediaTypeToModality(m),causeId:g,capabilities:f};this.statisticsGatherer.onMaxCapabilitiesApplied(S),this.diagnostics?.onMaxCapabilitiesApplied(S)}catch(S){const v=stringifyObject(S);this.logger.safe.error(`[${g}] Error applying capabilities ${v}`);const C={modality:mediaTypeToModality(m),causeId:g,capabilities:f,error:v};this.statisticsGatherer.onMaxCapabilitiesApplied(C),this.diagnostics?.onMaxCapabilitiesApplied(C)}}async applyCapabilitiesForMediaType(g,m){const f=this.senders.get(g);if(f)return f.updateParameters(m);this.logger.safe.info(`[${this.lastCauseId}] Capabilities ignored ${JSON.stringify(m)} ignored, no sender for media type ${JSON.stringify(g)}`)}applyMuteState(g,m){for(const[f,S]of this.muted)this.senders.get(f)&&this.senders.get(f).setMuted(S,g,m)}setAndUpdateLocalTracksInfo(g){const m=this.getTracksInfo();this.mediaManager.setLocalTracksInfo(m),g&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statisticsGatherer.updateStatsWithLocalSsrcTrackInfo())}getTracksInfo(){const g=[];return this.senders.forEach((m=>{g.push(m.getTrackInfo())})),g}async updateStreams(g,m){const f=await this.streamsProvider.update(g,m);return this.logger.safe.info(`Streams updated, modalities requested: ${JSON.stringify(g)}, result: ${JSON.stringify(f)}`),f}async updateSenders(){await this.streamsProvider.ensureUpdateCompleted();const g=sendStreamsToModalities(this.streamsProvider.streams);await Promise.all(keys(g).map((async m=>{const f=g[m];if(f===this.previousMediaModalitites[m])return void this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(m)} are not changed. enabled=${f}`);if(!f)return this.logger.safe.info(`Removing sender for mediaType: ${JSON.stringify(m)}`),void await this.removeSender(m);const S=this.streamsProvider.streams[m];if(await this.createAndStartSender(S,m),this.logger.safe.info(`Sender for mediaType: ${JSON.stringify(m)} is added`),this.applyCallConstraintsDeferred&&"Video"===m){const g=this.senders.get("Video");try{await g.applyCallConstraints(this.callConstraintsCauseId),this.applyCallConstraintsDeferred.resolve()}catch(g){this.applyCallConstraintsDeferred.reject(g)}this.applyCallConstraintsDeferred=void 0,this.callConstraintsCauseId=void 0}await this.addAudioSharingStream(S),this.event("onSendStreamChanged").raise(S,m)}))),this.logger.safe.info("Senders updated")}createAndStartSender(g,m){if(this.senders.get(m))return this.logger.safe.error(`Sender already created, modality: ${JSON.stringify(m)}`),this.senders.get(m).start();const f=this.mediaManager.getMediaEntitiesByModality(mediaTypeToModality(m))[0],S=f?.getSimulcastContext(),v="Audio"===m||!this.isMultiparty||!!S?.shouldUseSimulcast(),C=new oE(this.mediaConnection,g,new MediaStream,m,this.serialQueue,this.logger.createChild(`Sender_${JSON.stringify(m)}:${this.senderId++}`),this.configProvider,v,this.encStreamsManager,S);this.senders.set(m,C);const _=[C.on("onSendersChanged",((g,m)=>this.onSenderStateChanged(g,m))),C.on("onNewStreamNeeded",(()=>this.streamsProvider.requestStreamUpdate(m,!0))),C.on("onMaxVideoSendCapabilitiesChanged",(g=>this.event("onMaxVideoSendCapabilitiesChanged").raise(m,g)))];return this.subs.set(C,_),C.start()}async removeSender(g){const m=this.senders.get(g);m&&(this.senders.delete(g),this.event("onSendStreamChanged").raise(null,g),await m.terminateAsync(),this.subs.get(m).forEach((g=>g.dispose())),this.subs.delete(m),this.logger.safe.info(`Removed sender with mediaType: ${JSON.stringify(g)}`)),this.mediaQualityController?.removeReceiver(g)}async updateLayouts(g){const m=this.mediaQualityController.getLayouts(g);return this.logger.safe.debug(`Update layouts for ${g}: ${JSON.stringify(m)}`),this.updateParameters(this.lastCauseId,g,m)}getSourceIdForTrack(g){const m=g.trackId,f=this.mediaManager.getMediaEntityByLocalTrackId(m);return f?(this.logger.safe.info(`Media entity found: ${JSON.stringify(f.getXSourceStreamId())}`),f.getXSourceStreamId()):(this.logger.safe.error(`Media entity is not found for stream: ${JSON.stringify(m)}`),0)}subscribeToStreamProviderEvents(){this.streamProviderSubscriptions=[this.streamsProvider.on("onStreamAdded",(g=>this.onStreamUpdated(g,!1))),this.streamsProvider.on("onStreamUpdated",(g=>this.onStreamUpdated(g,!0)))]}unsubscribeFromStreamProviderEvents(){this.streamProviderSubscriptions.forEach((g=>g.dispose())),this.streamProviderSubscriptions=null}subscribeToStreamWatcherEvents(){this.localVideoStreamWatcherSubs=this.localVideoStreamWatcher.on("onVideoCaptureFreeze",((g,m)=>{g||(m?this.diagnostics.registerWebcamFreeze():this.diagnostics.registerProcessedStreamFreeze()),this.event("onVideoCaptureFreeze").raise(g)}))}async onStreamUpdated(g,m){if(!this.senders.has(g))return void this.logger.safe.warn(`Sender with media type ${g} does not exist, do not update media stream`);let f=this.streamsProvider.streams[g];if(f||(this.logger.safe.info(`Stream is missing for mediaType: ${g}, using fake stream...`),f=new A_(g,this.logger.createChild("NullStreamClient"))),f.isDisposed())return void this.logger.safe.info(`Stream is already disposed for mediaType: ${g}`);this.event("onSendStreamChanged").raise(f,g);const S=this.senders.get(g);await this.addAudioSharingStream(f),await S.updateStream(f),this.setAndUpdateLocalTracksInfo(m)}onSenderStateChanged(g,m){if(this.mediaManager&&this.mediaManager.updateMediaEntitiesWithActivityState(g.mediaType,g.getActiveStreamIndexes()),this.statisticsGatherer.onSendersChanged(g.mediaType,m),"Video"===g.mediaType)if(m){const g=this.getTracksInfo().filter((g=>g.modality===je.MODALITY.video));this.localVideoStreamWatcher.startWatching(g)}else this.localVideoStreamWatcher.stopWatching()}async addAudioSharingStream(g){"ScreenShare"===g.mediaType&&g.hasAudio()&&(this.logger.safe.info("Adding audio stream from sharing to audio sender"),await(this.senders.get("Audio")?.addAdditionalStream(g)))}},cE=class{constructor(g,m,f,S,v){this.pc=g,this.cryptoMethod=m,this.logger=f,this.configProvider=S,this.stateChangedCallback=v,this.logger=f.createChild("TransportStateProvider"),this.subscribeForConnectionState()}get hasPcConnectionState(){return"connectionState"in this.pc&&this.configProvider.config.useConnectionState}subscribeForConnectionState(){this.pc.oniceconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection oniceconnectionstatechange iceConnectionState: ${this.pc.iceConnectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(0)&&this.stateChangedCallback(this.pc.iceConnectionState)},1===this.cryptoMethod&&this.hasPcConnectionState&&(this.pc.onconnectionstatechange=()=>{this.logger.safe.info(`RTCPeerConnection onconnectionStatechange connectionState: ${this.pc.connectionState} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(1)&&this.stateChangedCallback(this.pc.connectionState)})}subscribeForDtlsTransportState(){if(!this.configProvider.config.useDtlsTrasportConnectionCheck||this.transport||1!==this.cryptoMethod||this.hasPcConnectionState)return;const g=this.pc.getReceivers().find((g=>!!g.transport));this.transport=g&&g.transport,this.transport&&(this.transport.onstatechange=()=>{this.logger.safe.info(`RTCDtlsTransport onstatechange state: ${this.transport.state} pc.signalingState: ${this.pc.signalingState}`),this.shouldRaise(2)&&this.stateChangedCallback(this.transport.state)})}dispose(){this.pc.oniceconnectionstatechange=null,this.transport&&(this.transport.onstatechange=null,this.transport=null),this.pc.onconnectionstatechange&&(this.pc.onconnectionstatechange=null),this.pc=null,this.stateChangedCallback=null}shouldRaise(g){switch(g){case 2:if(1!==this.cryptoMethod)throw new Error(`DTLS transport is used with cryptoMethod=${this.cryptoMethod}`);return!this.configProvider.config.ignoreClosedDtlsTransportState||"closed"!==this.transport.state;case 1:return 1===this.cryptoMethod&&!this.transport;case 0:return!(!this.configProvider.config.ignoreClosedDtlsTransportState||!this.transport||"closed"!==this.pc.iceConnectionState)||(0===this.cryptoMethod||!this.transport&&!this.hasPcConnectionState||this.transport&&"disconnected"===this.pc.iceConnectionState||"connected"===this.transport?.state&&"connected"===this.pc.iceConnectionState);default:return this.logger.safe.error(`unknown StateMethod=${g}`),!1}}},dE=class{constructor(g,m,f,S,v){this.recvStream=g,this.mainTrack=m,this.receiveStreamCollection=f,this.logger=S,this.settings=v,this.removeOtherTracks(m),this.subscribeOnStreamEvents()}get stream(){return this.recvStream.getMediaStream()}dispose(){this.unsubscribeFromStreamEvents(),this.receiveStreamCollection=null,this.mainTrack=null,this.recvStream.dispose()}getId(){return this.recvStream.getId()}getModality(){return this.recvStream.getModality()}getMsi(){return this.recvStream.getMsi()}getMediaStream(){return this.stream}getReceiver(){return this.recvStream.getReceiver()}requestSource(g){return this.recvStream.requestSource(g)}getSourceStreamId(){return this.recvStream.getSourceStreamId()}removeOtherTracks(g){if(this.settings.onAddTrackRemoveOtherTracks){this.stream.getTracks().forEach((m=>{m.id!==g.id&&this.stream.removeTrack(m)}))}}subscribeOnStreamEvents(){const logEvent=g=>this.logger.safe.info(`${g} track: ${this.mainTrack.id}, stream: ${this.stream.id}`);this.stream.onremovetrack=()=>{logEvent("onremovetrack"),this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onended=()=>{logEvent("onended"),this.settings.removeRecvStreamOnEnded&&this.receiveStreamCollection.remove(this.stream.id)},this.mainTrack.onmute=()=>logEvent("onmute"),this.mainTrack.onunmute=()=>logEvent("onunmute")}unsubscribeFromStreamEvents(){this.stream.onremovetrack=null,this.mainTrack.onended=null,this.mainTrack.onmute=null,this.mainTrack.onunmute=null}},hE=class{constructor(g){this.startTimestamp=0,this.totalTime=0,this.lastActiveTime=0,this.id=g}},uE=class{constructor(g){this.speakersHistory=[],this.sources=[],this.configProvider=g.configProvider,this.ping=this.setupTimer()}setSources(g=[]){const m=g.map(this.getOrCreateSource.bind(this)),f=this.excludeSources(this.sources,m);m.forEach((g=>{this.isAlreadyActive(g)||this.updateSourceTimestamp(g),this.updateSourceLastActiveTime(g)})),f.forEach((g=>{this.updateTotalTime(g),this.resetStartTimestamp(g)})),this.ping||(this.ping=this.setupTimer())}setOnDominantSpeakerChanged(g){this.callback=g}dispose(){this.clearTimer(),this.sources=null,this.callback=null}excludeSources(g,m){return g.filter((g=>!m.some((m=>g.id===m.id))))}trigger(){if(!this.hasAnyoneSpoken())return void this.clearTimer();const byActivity=(g,m)=>m.totalTime-g.totalTime||m.lastActiveTime-g.lastActiveTime,toSourceId=g=>g.id,g=this.sources.map(this.updateTotalTime).sort(byActivity).map(toSourceId).slice(0,this.configProvider.config.ovcMaxCount);g.length&&!deepEqual(this.speakersHistory,g)&&(this.speakersHistory=g,this.callback&&this.callback(this.speakersHistory,"client")),this.sources.map(this.resetTotalTime).filter(this.isAlreadyActive).forEach(this.updateSourceTimestamp)}isAlreadyActive(g){return!!g.startTimestamp}setupTimer(){return window.setInterval(this.trigger.bind(this),this.configProvider.config.activeSpeaker.timeToPromote)}clearTimer(){this.ping&&(clearInterval(this.ping),this.ping=null)}getOrCreateSource(g){if(this.isExist(g))return this.sourceById(g);{const m=new hE(g);return this.sources.push(m),m}}isExist(g){return this.sources.some((m=>g===m.id))}hasAnyoneSpoken(){return this.sources.some((g=>0!==g.startTimestamp||0!==g.totalTime))}sourceById(g){return this.sources.find((m=>g===m.id))}updateSourceTimestamp(g){g.startTimestamp=Date.now()}updateSourceLastActiveTime(g){g.lastActiveTime=Date.now()}updateTotalTime(g){return g.startTimestamp&&(g.totalTime+=Date.now()-g.startTimestamp),g}resetStartTimestamp(g){return g.startTimestamp=0,g}resetTotalTime(g){return g.totalTime=0,g}},gE=class{constructor(g){this.modifierList=g}modify(g){for(const m of this.modifierList)m.modify(g)}},pE=class{constructor(g,m,f,S){this.context=g,this.mediaManager=m,this.modalities=f,this.cname=S}build(g){switch(g.sdpSource){case 0:return new gE([new aS(this.context.configProvider),new $f(this.context.configProvider),new fS(this.mediaManager,this.context.configProvider),new mS(this.mediaManager),new Xf(this.context.configProvider),new Kf(this.context.configProvider),new Wf(this.mediaManager,this.context.configProvider,g.sdpType),new jf(this.mediaManager,this.context.configProvider),new AS(this.context.configProvider,g.sdpType)]);case 2:return new gE([new If(this.mediaManager,this.modalities),new Gf,new bf(this.mediaManager,!0),new dS(this.context.configProvider,this.mediaManager),new Of(this.modalities,this.mediaManager),new tS,new Qf,new Zf,new eS(this.context.configProvider),new Yf(this.context.configProvider),new sS(this.context.configProvider),new kf,new Ef(this.context),new gS(this.mediaManager),new Hf(this.context.configProvider),new _S,new CS(this.context.configProvider),new SS(this.context.configProvider),new xf(this.mediaManager,this.modalities,this.context.configProvider),new Df(this.context),new ES(this.context.configProvider),new wf(this.context.configProvider),new Wf(this.mediaManager,this.context.configProvider,g.sdpType),new qf(this.mediaManager,this.context.configProvider,g.sdpType),new nS(this.context.configProvider,this.context.getLogger()),new Ff,new IS(this.context.configProvider),new lS(this.context.configProvider)]);case 1:return new gE([new Pf(this.context,this.modalities.data),new bf(this.mediaManager,!1),new Uf(this.context.configProvider),new If(this.mediaManager,this.modalities),new Lf(this.mediaManager),new Qf,new Jf(this.context.configProvider),new Tf(this.mediaManager,"offer"===g.sdpType,this.context.configProvider),new pS(this.mediaManager,this.context.getLogger()),new yS(this.context.configProvider,this.mediaManager),new Nf(this.context.config.isConference,this.cname),new Vf(this.mediaManager),new Bf,new oS(this.context.configProvider),new Mf(this.context.configProvider),new TS(this.context.configProvider),new bS(this.context.configProvider),new qf(this.mediaManager,this.context.configProvider,g.sdpType),new lS(this.context.configProvider)])}}},mE=class{constructor(g){this.context=g,this.cname=uniqueId()}toLocal(g,m,f){return this.modify({sdpSource:0,sdpType:f},g,m)}toOffer(g,m,f){return this.modify({sdpSource:1,sdpType:"offer"},g,m,f)}toAnswer(g,m,f){return this.modify({sdpSource:1,sdpType:"answer"},g,m,f)}toRemote(g,m,f,S){return this.modify({sdpSource:2,sdpType:S},g,m,f)}modify(g,m,f,S){const v=new pE(this.context,f,S,this.cname).build(g),C=deepClone(m);return v.modify(C),C}},fE=class{get sdp(){return this.originalDescription.sdp}set sdp(g){this.originalDescription=new Ws.window.RTCSessionDescription({sdp:g,type:this.originalDescription.type})}get type(){return this.originalDescription.type}set type(g){this.originalDescription=new Ws.window.RTCSessionDescription({sdp:this.originalDescription.sdp,type:g})}constructor(g){this.originalDescription=new Ws.window.RTCSessionDescription(g)}toJSON(){return this.originalDescription.toJSON()}},SE=R,vE=class{constructor(g,m,f){this.mediaEntity=g,this.logger=m,this.configProvider=f,this.activeRids=[],this.isLocalDescSet=!1,this.enabledLocally=!1,this.enabledRemotely=!1;const S=modalityToMediaType(this.mediaEntity.getModality());this.config=getSimulcastConfigForMediaType(S,this.configProvider),this.config?this.logger.safe.debug(`Adding simulcast info to ${g.getModality()} with mid: ${g.getMid()}, config: ${JSON.stringify(this.config)}`):this.logger.safe.debug(`Simulast is disabled for ${g.getModality()}`)}get ridList(){return this.config?(0,SE.times)(this.config.layerScaleFactors.length,(g=>g+1)):[]}localDescriptionIsApplied(){this.isLocalDescSet=!0}enableInLocalDesc(){this.enabledLocally=!0}shouldBeEnabledInLocalDesc(){return!!this.config&&(this.config.enableLocally||this.enabledRemotely)}enableInRemoteDesc(){this.enabledRemotely=!0}shouldBeEnabledInRemoteDesc(){return!!this.config&&(this.enabledLocally||this.config.allowEnableRemotely&&this.isMidRidHeaderExtPresented()&&!this.isLocalDescSet)}shouldUseSimulcast(){return this.shouldBeEnabledInLocalDesc()}getSsrcRange(){return this.shouldUseSimulcast()?99:0}isMidRidHeaderExtPresented(){const g=this.mediaEntity.getRtpHeaderExtensions();return g?.some((g=>"mid"===g.headerType||"rid"===g.headerType||"rrid"===g.headerType))}},yE={toffset:"toffset","abs-send-time":"abs-send-time","video-orientation":"video-orientation","draft-holmer-rmcat-transport-wide-cc-extensions-01":"transport-cc","video-content-type":"video-content-type","video-timing":"video-timing","color-space":"color-space","video-layers-allocation00":"vla","video-layers-allocation00-non-advertised":"non-adv-vla",mid:"mid","rtp-stream-id":"rid","repaired-rtp-stream-id":"rrid","fast_bandwidth_feedback#version_3":"fast_bandwidth_feedback#version_3","frame-counters-gvc":"frame-counters-gvc"},CE=class{constructor(g){this.context=g,this.mediaEntities=[],this.mediaEntitiesBackup=[],this.mediaTracks=[],this.ssrcGenerator=new fv,this.rollbackHandlers=[],this.logger=g.logger.createChild("MM2"),this.configProvider=g.configProvider}fromOffer(g,m,f=!1){this.updateMediaEntitiesFromModel(g,f),this.updateSharingEntity(!!m.sharing),g.media.forEach((g=>{const m=this.getMediaEntityByMid(g.mid);m&&this.saveLocalSsrc(m,g)}))}fromRemote(g,m){const f=0===this.mediaEntities.length;this.updateMediaEntitiesFromModel(g,!1,m),g.media.forEach(((g,m)=>{const f=this.getMediaEntityByMid(g.mid);f&&(this.saveRemoteMsid(f,g),this.saveRemoteSsrc(f,g),this.saveRtpHeaderExtensions(f,g),f.setXSourceStreamId(g.xSourceStreamId||this.generateSourceStreamId(m)),f.setRemoteRecvCapabilities(getRecvCapabilitiesForMedia(g)))})),f&&this.updateReinvitelessState(g)}isEmpty(){return 0===this.mediaEntities.length}createMediaEntity(g,m){const f=VC.create(this.configProvider,g,m);return this.context.useSimulcast&&!this.mediaEntities.find((m=>m.getModality()===g))&&this.setSimulcastContext(f),f.setExtension("reinviteless",!1),this.mediaEntities.push(f),f}getMediaEntities(){return this.mediaEntities}getMediaEntity(g){return this.mediaEntities[g]}getMediaEntityByMid(g){return this.mediaEntities.find((m=>m.getMid()===g))}getMediaEntitiesByModality(g){return this.mediaEntities.filter((m=>m.getModality()===g))}getMediaEntitiesByMediaType(g){const m=modalityToMediaType(g);return this.getMediaEntitiesByModality(m)}getMediaEntityByRemoteStreamId(g){return this.mediaEntities.find((m=>m.getRemoteStreamId()===g))}getMediaEntityByLocalTrackId(g){return this.mediaEntities.find((m=>m.getLocalTrackId()===g))}getMediaEntityByXSourceStreamId(g){return this.mediaEntities.find((m=>m.getXSourceStreamId()===g))}reset(){this.mediaEntities=[],this.rollbackHandlers=[]}syncModalities(g,m,f=!1){this.fromOffer(g,m,f)}setLocalTracksInfo(g){this.mediaTracks=g}getLocalTracksInfo(){return this.mediaTracks}backup(){this.logger.safe.debug("backup"),this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{this.mediaEntitiesBackup.push(g.clone())}))}commit(){this.mediaEntitiesBackup=[],this.mediaEntities.forEach((g=>{g.setExtension("unnegotiatedModality",!1)}))}rollback(){this.logger.safe.debug(`rollback, if backup exists: ${!!this.mediaEntitiesBackup.length}`),this.mediaEntitiesBackup.length&&(this.rollbackHandlers.forEach((g=>g(this.mediaEntities,this.mediaEntitiesBackup))),this.mediaEntities.forEach(((g,m)=>{this.mediaEntitiesBackup[m]?this.mediaEntities[m]=this.mediaEntitiesBackup[m]:(g.disable(),g.setExtension("rollback",!0))})))}updateMediaEntitiesWithLocalTracks(){this.mediaTracks&&(this.mediaEntities.forEach((g=>g.setLocalTrackId(null))),this.mediaTracks.forEach((g=>{const m=this.getMediaEntitiesByModality(g.modality)[0];m?m.setLocalTrackId(g.trackId):this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(g.modality)}`)})))}updateMediaEntitiesWithActivityState(g,m){this.logger.safe.debug(`Updating activity indexes for ${g} to ${JSON.stringify(m)}`);const f=mediaTypeToModality(g),S=this.getMediaEntitiesByModality(f)[0];if(!S)return void this.logger.safe.error(`Media entity is not found for modality: ${JSON.stringify(f)}`);const v=S.getSimulcastContext();v&&(v.activeRids=m)}setRollbackUpdateHandler(g){this.rollbackHandlers.push(g)}saveRtpHeaderExtensions(g,m){if(g.isDisabled())return void g.setRtpHeaderExtensions(void 0);const f=m.ext?.map((g=>this.getHeaderExtension(g)));this.logger.safe.debug(`RTP header ext for mid=${m.mid}, modality=${g.getModality()}: ${JSON.stringify(f)}`),g.setRtpHeaderExtensions(f)}getHeaderExtension(g){let m="unknown";for(const[f,S]of Object.entries(yE))if(g.uri.endsWith(f)){m=S;break}return{headerType:m,value:g.value}}saveRemoteMsid(g,m){if(isMediaDisabled(m))g.setRemoteStreamId(null);else if(m.msid)g.setRemoteStreamId(m.msid.split(" ")[0]);else if(m.ssrcs){const f=m.ssrcs.find((g=>"msid"===g.attribute));f?g.setRemoteStreamId(f.value.split(" ")[0]):this.logger.safe.warn(`No ssrc msid for media of type ${m.type} with mid ${m.mid}`)}}saveRemoteSsrc(g,m){if(m.ssrcs?.length){const f=m.ssrcs[0];g.setRemoteSsrc(f.id)}}saveLocalSsrc(g,m){const f=m.ssrcs?.[0]?.id;if(!hasSendDirectionality(m.direction))return void g.setLocalSsrc(f);const S=f||g.getLocalSsrc()||this.ssrcGenerator.nextVideoStreamSsrc().min;g.setLocalSsrc(S)}updateMediaEntitiesFromModel(g,m,f){g.media.forEach(((g,S)=>{this.mediaEntities[S]?isMediaDisabled(g)?this.mediaEntities[S].disable():this.mediaEntities[S].update(this.mediaEntities[S].getModality(),g.mid||this.mediaEntities[S].getMid()):m||this.createMediaEntity(getModality(g),g.mid||S.toString()),this.mediaEntities[S]&&f&&!(this.mediaEntities[S].getModality()in f)&&this.mediaEntities[S].disable()}))}updateSharingEntity(g){if(g&&!this.getMediaEntitiesByModality(je.MODALITY.sharing).length){const g=this.getMediaEntitiesByModality(je.MODALITY.video).pop();g.update(je.MODALITY.sharing,g.getMid())}}setSimulcastContext(g){if(!g||g.getSimulcastContext())return;const m=new vE(g,this.logger.createChild(`SimContext:${g.getModality()}`),this.configProvider);g.setSimulcastContext(m)}generateSourceStreamId(g){return g+10}updateReinvitelessState(g){const m={[je.MODALITY.audio]:0,[je.MODALITY.video]:0,[je.MODALITY.sharing]:0};for(const f of g.media){const g=getModality(f);void 0!==m[g]&&m[g]++;const S=this.getMediaEntityByMid(f.mid);if(S){const v=this.context.reinviteltessContext?.maxStreamsForModality[g]>=m?.[g]&&(!f.direction||"sendrecv"===f.direction);S.setExtension("reinviteless",v)}}}};function createAudioWasmDecoderProxy(g,m,f){return new _E(g,m,f)}var _E=class extends d_{constructor(g,m,f){super(g,m,2,f)}init(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[g]}})}setCodec(g,m){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[g,m]}})}passWriteableStreams(g,m){const f=g.concat(m);this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"passWriteableStreams",args:[g,m]}},f)}setAvailableStreams(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setAvailableStreams",args:[g]}})}setRecvPayloads(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setRecvPayloads",args:[g]}})}debugLogging(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[g]}})}sendApiRecordingData(){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"sendApiRecordingData",args:[]}})}},EE=class{constructor(g){this.logger=g,this.audioContext=new AudioContext,this.destination=this.audioContext.createMediaStreamDestination()}get stream(){return this.destination.stream}isSingleInputStream(){return 0===this.mixerImp?.mixerType}dispose(){this.audioContext.close(),this.audioContext=null}setMixerType(g,m){this.mixerImp?.mixerType!==g&&(this.mixerImp?.reset(),this.mixerImp=this.createMixer(g),this.mixerImp.setupMixer(this.audioContext,this.destination,m))}setStreamSources(g){this.mixerImp.setStreamSources?.(g)}setParticipantSpatialAudioPositions(g){this.mixerImp.setParticipantSpatialAudioPositions?.(g)}createMixer(g){switch(g){case 0:return new IE;case 1:return new bE(this.logger.createChild("MixingStreamsMixer"));case-1:return new TE;default:throw new Error(`unknown mixer type: ${g}`)}}},TE=class{constructor(){this.mixerType=-1}reset(){}setupMixer(g,m,f){}},IE=class{constructor(){this.mixerType=0}reset(){this.sourceNode.disconnect()}setupMixer(g,m,f){this.sourceNode=g.createMediaStreamSource(f[0]),this.sourceNode.connect(m)}},bE=class{constructor(g){this.logger=g,this.sourcePositions=new Map,this.pannerNodes=[],this.mixerType=1}reset(){for(const g of this.pannerNodes)g.disconnect();this.pannerNodes=[]}setupMixer(g,m,f){for(const S of f){const f=g.createMediaStreamSource(S),v=new PannerNode(g,{panningModel:"HRTF"});f.connect(v),v.connect(m),this.pannerNodes.push(v)}this.logger.safe.info(`setupMixer is done for ${f.length} streams.`)}setStreamSources(g){for(let m=0;m<g.length;m++)this.setStreamPosition(m,g[m])}setParticipantSpatialAudioPositions(g){this.sourcePositions=new Map(g.map((g=>[g.sourceId,g])))}setStreamPosition(g,m){const f=this.sourcePositions.get(m)??{sourceId:m,x:0,y:0},S=this.pannerNodes[g];S.positionX.value=f.x,S.positionY.value=f.y}},AE=class extends Ve{constructor(g){super(),this.logger=g,this.mediaStreams=[],this.cnStream=null,this.isActive=!0}get active(){return this.isActive}get streams(){return this.mediaStreams}get comfortNoiseStream(){return this.cnStream}setupStreams(g,m){this.logger.safe.debug(`setup ${g} streams with extra Comfort Noise stream: ${m}`),this.mediaStreams=[];const f=[];for(;g--;){const g=new MediaStreamTrackGenerator({kind:"audio"});f.push(g),this.streams.push(new MediaStream([g]))}const S=m?new MediaStreamTrackGenerator({kind:"audio"}):null;return this.cnStream=S?new MediaStream([S]):null,this.event("onStreamsChanged").raise(),{streams:f.map((g=>g.writable)),cnStream:S?.writable}}setStreamSources(g){this.isActive&&this.event("onStreamSourcesUpdated").raise(g)}activateUnmixedProvider(g){this.isActive!==g&&(this.isActive=g,this.event("onActiveStateChanged").raise())}},PE=class extends Be{constructor(g,m){super(),this.logger=g,this.maxNumOfStreamsFactor=m,this.statsProvider=new RE,this.streamMixer=new EE(this.logger),this.unmixedAudioProvider=new AE(this.logger),this.codec="None",this.recvPayloads=[],this.initCompleted=!1,this.enabledApiRecording=!1;try{this.enabledApiRecording="true"===localStorage.getItem("enableApiRecording")}catch{}this.injectWebMA()}get stream(){return this.streamMixer.stream}dispose(){super.dispose(),this.streamMixer.dispose(),this.removeWebMA()}activateTransform(g){this.logger.safe.debug("Activating WASM decoder transform"),g.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM decoder transform"),this.imp=null,this.initCompleted=!1,this.codec="None",this.streamMixer.setMixerType(-1,[])}createBaseInstanse(g){this.logger.warn("WASM decoder could only be instantiated in worker")}createWorkerInstanse(g,m){this.imp=createAudioWasmDecoderProxy(g,m,this),this.imp.init(this.enabledApiRecording)}setCodec(g){if(this.logger.safe.debug(`Setting codec to ${g}`),!this.initCompleted)return this.logger.safe.debug("Decoder is not initialized yet, postponing codec setting"),void(this.codec=g);this.codec!==g&&(this.codec=g,this.setCodecInternal())}setRecvPayloads(g){this.recvPayloads=g,this.imp?.setRecvPayloads(g)}negotiationCompleted(g){this.logger.safe.debug(`Negotiation completed, negotiated=${g}`),g||(this.codec="None",this.imp?.setCodec(this.codec,this.streamMixer.isSingleInputStream()))}setParticipantSpatialAudioPositions(g){this.streamMixer.setParticipantSpatialAudioPositions(g)}getStatsProvider(){return this.statsProvider}getUnmixedAudioProvider(){return this.unmixedAudioProvider}async storeApiRecording(){if(this.enabledApiRecording&&this.initCompleted)return this.recordingCompletePromise?.resolve(),this.recordingCompletePromise=new Sr,this.imp.sendApiRecordingData(),this.recordingCompletePromise.promise}initDone(g,m){if(this.healerCapabilities=m,this.logger.safe.info(`Init done, errorCode=${g}`),0!==g)return void this.event("initFailed").raise(g);this.logger.safe.info(`healerCapabilities=${JSON.stringify(m)}`),this.initCompleted=!0;const f=Math.floor(this.healerCapabilities.maxNumStreamsPerPacket*this.maxNumOfStreamsFactor),S=this.unmixedAudioProvider.setupStreams(f,!0);this.imp.passWriteableStreams(S.streams,S.cnStream),this.setCodecInternal(),this.imp.setRecvPayloads(this.recvPayloads)}usedDecoderChanged(g){this.logger.safe.info(`Used decoder changed to custom=${g}, configured codec=${this.codec}`),this.event("usedDecoderChanged").raise(g),this.unmixedAudioProvider.activateUnmixedProvider(g&&"MUCHv2"===this.codec)}packetReceived(g,m,f){this.statsProvider.ssrc=m,this.statsProvider.addPushStats(g,f)}newDataWrittenToStreams(g){const m=Array.from(new Int32Array(g));this.unmixedAudioProvider.setStreamSources(m),this.streamMixer.setStreamSources(m);const f=m.reduce(((g,m,f)=>(m===c_&&g.push(f),g)),[]);this.imp?.setAvailableStreams(f)}packetDecoded(g,m,f){this.statsProvider.addPullStats(g,m,f,f.extra.samplingRatekHz*this.healerCapabilities.frameLengthMs)}apiRecordingAvailable(g,m,f){if(this.logger.safe.debug(`API recording available: errorCode=${g}, name=${m}, buffer length=${f.byteLength}`),this.recordingCompletePromise?.resolve(),0===f.byteLength)return;const S=new Blob([f],{type:"application/octet-stream"}),v=URL.createObjectURL(S),C=document.createElement("a");C.href=v,C.download=m,C.click()}setCodecInternal(){this.streamMixer.setMixerType(getStreamGeneratorType(this.codec),this.unmixedAudioProvider.streams),this.imp.setCodec(this.codec,this.streamMixer.isSingleInputStream()),this.statsProvider.codecName=this.codec}injectWebMA(){const g=window.webMA;g&&(g.wasmDecoder={debugLogging:g=>this.imp?.debugLogging(g),sendApiRecordingData:()=>this.imp?.sendApiRecordingData()})}removeWebMA(){const g=window.webMA;g&&delete g.wasmDecoder}};function getStreamGeneratorType(g){switch(g){case"SatinFB":return 0;case"MUCHv2":return 1;case"None":return-1;default:throw new Error(`unknown codec: ${g}`)}}var RE=class{constructor(){this.customHealerStats={numSamplesPerFrame:0,FECPayloadDecodedSamples:0,concealSamples:0,stretchSamples:0,healedSamples:0,decodedSamples:0,redPacketsCount:0,pushProcessingTimes:{},pullProcessingTimes:{},pullProcessingTimePerStreamNumber:{},pullNumOfStreamsCounter:{}},this.inboudStats={silentConcealedSamples:0,concealedSamples:0,totalSamplesReceived:0,audioLevel:0,jitterBufferDelay:0,jitterBufferEmittedCount:0},this.decoderStats={pushCount:0,pushErrCount:0,pullCount:0,pullErrCount:0},this.packetPushProccesingTimes=new wE(0,1e3),this.packetPullProccesingTimes=new wE(0,1e3),this.numOfStreamsCounter=new wE(0,10),this.pullProcessingTimePerStreamNumber={}}get codecName(){return this.codec}set codecName(g){this.codec=g}addPushStats(g,m){this.decoderStats.pushCount++,this.decoderStats.pushErrCount+=0!==g?1:0,this.inboudStats.jitterBufferDelay+=m.webrtc.jitterBufferDelay,this.customHealerStats.packetDurationInMs=m.extra.packetDurationInMs,this.packetPushProccesingTimes.addSample(m.extra.processingTime),this.customHealerStats.pushProcessingTimes=this.packetPushProccesingTimes.getFrequencies(),this.customHealerStats.cnpPushCount=m.extra.totalCountCNPackets,this.customHealerStats.redPacketsCount+=0!==m.extra.redundancyTimestampOffset?1:0}addPullStats(g,m,f,S){var v;this.decoderStats.pullCount++,this.decoderStats.pullErrCount+=0!==g?1:0,this.inboudStats.audioLevel=f.webrtc.audioLevel,this.inboudStats.totalAudioEnergy=f.webrtc.totalAudioEnergy,this.inboudStats.jitterBufferEmittedCount=f.webrtc.jitterBufferEmittedCount,this.inboudStats.totalSamplesReceived=f.webrtc.totalSamplesReceived,this.inboudStats.concealedSamples=f.webrtc.concealedSamples,this.inboudStats.silentConcealedSamples=f.webrtc.silentConcealedSamples,this.numOfStreamsCounter.addSample(m),this.customHealerStats.FECPayloadDecodedSamples=f.extra.FECPayloadDecodedSamples,this.customHealerStats.numSamplesPerFrame=S,this.customHealerStats.pullAdspPayloadType=f.extra.pullAdspPayloadType,this.customHealerStats.concealSamples=f.extra.concealSamples,this.customHealerStats.stretchSamples=f.extra.stretchSamples,this.customHealerStats.healedSamples=f.extra.healedSamples,this.customHealerStats.decodedSamples=f.extra.decodeSamples,this.packetPullProccesingTimes.addSample(f.extra.processingTime),this.customHealerStats.pullProcessingTimes=this.packetPullProccesingTimes.getFrequencies(),this.customHealerStats.cnpPullCount=f.extra.totalCountCNGeneratedFrames,this.customHealerStats.cngSamples=f.extra.cngSamples,this.customHealerStats.pullNumOfStreamsCounter=this.numOfStreamsCounter.getFrequencies(),(v=this.pullProcessingTimePerStreamNumber)[m]??(v[m]=new wE(0,200)),this.pullProcessingTimePerStreamNumber[m].addSample(f.extra.processingTime);for(const g of Object.keys(this.pullProcessingTimePerStreamNumber))this.customHealerStats.pullProcessingTimePerStreamNumber[g]=this.pullProcessingTimePerStreamNumber[g].getFrequencies()}getWebRtcCompatibaleStats(){return this.inboudStats}getWasmStats(){return this.customHealerStats}getDecoderStats(){return this.decoderStats}},wE=class{constructor(g,m){this.minSample=g,this.maxSample=m,this.frequencyDict={}}addSample(g){if(void 0===g)return;const m=Math.min(this.maxSample,Math.max(this.minSample,g));this.frequencyDict[m]=(this.frequencyDict[m]??0)+1}getFrequencies(){return{...this.frequencyDict}}};function createAudioWasmEncoderProxy(g,m,f){return new ME(g,m,f)}var ME=class extends d_{constructor(g,m,f){super(g,m,3,f)}init(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"init",args:[g]}})}setCodec(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"setCodec",args:[g]}})}debugLogging(g){this.worker.sendTransformCommand(this.clientId,{operation:"invoke",func:{transformType:this.transformType,name:"debugLogging",args:[g]}})}},DE=["SatinFB"],OE=class extends Be{constructor(g){super(),this.logger=g,this.codec="None",this.injectWebMA()}dispose(){super.dispose(),this.removeWebMA()}activateTransform(g){this.logger.safe.debug("Activating WASM encoder transform"),g.addTransform(this)}deactivateTransform(){this.logger.safe.debug("Deactivating WASM encoder transform"),this.imp=null,this.encodersInitCodes=void 0,this.codec="None"}createBaseInstanse(g){this.logger.warn("WASM encoder could only be instantiated in worker")}createWorkerInstanse(g,m){this.imp=createAudioWasmEncoderProxy(g,m,this),this.imp.init(DE)}setCodec(g){if(this.logger.safe.debug(`Setting codec to ${g}`),!this.encodersInitCodes)return this.logger.safe.debug("Encoder is not initialized yet, postponing codec setting"),void(this.codec=g);this.codec!==g&&(this.codec=g,this.setCodecInternal())}isCodecAllowed(g){return DE.includes(g)}negotiationCompleted(g){g||(this.codec="None",this.imp?.setCodec(this.codec))}initDone(g){this.logger.safe.info(`initDone: ${JSON.stringify(g)}`),this.encodersInitCodes=g,this.setCodecInternal()}packetEncoded(g){0!==g&&this.logger.safe.info(`encode failed: ${g}`)}setCodecInternal(){const g=this.encodersInitCodes[this.codec]??-2147024809;if("None"!==this.codec&&0!==g)return this.logger.safe.error(`WASM encoder is failed to init codec ${this.codec}, err code: ${g}`),void this.event("initCodecFailed").raise(g);this.imp.setCodec(this.codec)}injectWebMA(){const g=window.webMA;g&&(g.wasmEncoder={debugLogging:g=>this.imp?.debugLogging(g)})}removeWebMA(){const g=window.webMA;g&&delete g.wasmEncoder}},NE=R,kE=class extends Be{constructor(g,m,f){super(),this.encStreamsManager=g,this.logger=m,this.configProvider=f,this.isEnabled=!1,this.sessionStats=new FE,this.subs=[],this.codecContext=this.configProvider.mediaConfig.audioCodecContext,this.codecConfig=this.configProvider.config.useInsertableStreams?.audioWasmCodec}get decoder(){return this.decoderImp}get encoder(){return this.encoderImp}init(g){if(!g||!this.codecContext||!this.codecConfig?.enable)return;this.isEnabled=!0;const m=this.codecConfig.maxNumOfStreamsFactor||1;this.decoderImp=new PE(this.logger.createChild("AudioWasmDecoder"),m),this.codecConfig.enableSend&&(this.encoderImp=new OE(this.logger.createChild("AudioWasmEncoder"))),this.subscribeToStreamManagerEvents(this.encStreamsManager),this.subscribeToCodecsEvents()}dispose(){super.dispose(),this.unsubscribeFromEvents(),this.decoderImp?.dispose(),this.encoderImp?.dispose()}getSessionEvents(){return this.sessionStats.getSessionEvents()}prepareForNegotiation(g){if(!this.isEnabled)return;const m=this.configProvider.mediaConfig.spatialAudioEnabled?"MUCHv2":this.codecConfig.codec||"None";this.codecContext.codec!==m&&(this.codecContext.initSendFailed=!1),this.codecContext.lastUsedCodec=this.codecContext.codec,this.codecContext.codec=m,this.codecContext.enabledLocally=!this.codecContext.initFailed&&"None"!==m,this.codecContext.enabledForSend=this.codecContext.enabledLocally&&!this.codecContext.initSendFailed&&!!this.codecConfig?.enableSend&&this.encoder?.isCodecAllowed(m),this.logger.safe.info(`Audio codec state: context=${JSON.stringify(this.codecContext)}`),this.codecContext.initFailed||!g&&this.codecContext.disabledRemotely||(this.sessionStats.toggleState("None"!==m),this.decoderImp?.setCodec(m),this.encoderImp?.setCodec(this.codecContext.enabledForSend?m:"None"))}negotiationCompleted(){if(!this.isEnabled)return!1;const g=this.codecContext.enabledLocally&&!this.codecContext.disabledRemotely;return this.decoderImp?.negotiationCompleted(g),this.encoderImp?.negotiationCompleted(g),this.sessionStats.negotiationCompleted(g,this.codecContext.enabledForSend),g}configureSpatialAudio(g,m){if(!this.isEnabled)return!1;this.configProvider.mediaConfig.spatialAudioEnabled=g;return(g&&"MUCHv2"!==this.codecContext.codec||!g&&"MUCHv2"===this.codecContext.codec)&&this.event("negotiationNeeded").raise(m),!0}subscribeToStreamManagerEvents(g){this.subs.push(g.on("onTransformsCollectionCreated",(g=>this.handleTransformsCollectionCreated(g))),g.on("onTransformsCollectionCleared",(g=>this.handleTransformsCollectionCleared(g))))}handleTransformsCollectionCreated(g){"Audio"===g.mediaType&&(this.decoderImp&&"Receiver"===g.objType?this.decoderImp.activateTransform(g.collection):this.encoderImp&&"Sender"===g.objType&&this.encoderImp.activateTransform(g.collection))}handleTransformsCollectionCleared(g){"Audio"===g.mediaType&&(this.decoderImp&&"Receiver"===g.objType?this.decoderImp.deactivateTransform():this.encoderImp&&"Sender"===g.objType&&this.encoderImp.deactivateTransform())}subscribeToCodecsEvents(){this.decoderImp&&this.subs.push(this.decoderImp.on("initFailed",(g=>this.handleCodecInitFailed("decoder",g)))),this.encoderImp&&this.subs.push(this.encoderImp.on("initCodecFailed",(g=>this.handleCodecInitFailed("encoder",g))))}unsubscribeFromEvents(){this.subs.forEach((g=>g.dispose())),this.subs=[]}handleCodecInitFailed(g,m){"decoder"===g?this.codecContext.initFailed=!0:this.codecContext.initSendFailed=!0;const f=generateCauseId();this.logger.safe.warn(`[${f}] Audio ${g} init failed ${m}`),this.sessionStats.initFailed(m,g),this.event("negotiationNeeded").raise(f)}},LE=class _AudioCodecSessionStats{constructor(){this.sessionEvents={negotiationAttempts:[],toggleCount:0,negotiatedCount:0,failedNegotiationCount:0,decoderInitError:0,encoderInitError:0}}toggleState(g){this.sessionEvents.toggleCount++,this.inProgressNegotiation={ts:Date.now(),enabled:g,negotiated:!1,sendEnabled:!1},arrayLimitedPush(this.sessionEvents.negotiationAttempts,this.inProgressNegotiation,_AudioCodecSessionStats.maxStoreNegotiations)}negotiationCompleted(g,m){this.inProgressNegotiation&&(this.sessionEvents.negotiatedCount+=g?1:0,this.sessionEvents.failedNegotiationCount+=this.inProgressNegotiation.enabled&&!g?1:0,this.inProgressNegotiation.negotiated=g,this.inProgressNegotiation.sendEnabled=m,this.inProgressNegotiation=void 0)}initFailed(g,m){"decoder"===m?this.sessionEvents.decoderInitError=g:this.sessionEvents.encoderInitError=g}getSessionEvents(){return(0,NE.clone)(this.sessionEvents)}};LE.maxStoreNegotiations=5;var FE=LE,xE=class extends Be{constructor(g,m){super(),this.configProvider=g,this.logger=m,this.bandwidthEstimationAvailable=!1,this.smoothingWindow=[],this.totalSamples=0,this.isStarted=!1,this.maxCountStatic=this.configProvider.config.ovcMaxCount,this.previousParticipantsCount=0;const f=window.navigator;this.updateStaticConstraint(f.hardwareConcurrency,this.configProvider.config.ovcAvailableConcurrencyForBiggerGrid,4),this.updateStaticConstraint(f.deviceMemory,this.configProvider.config.ovcMemoryForBiggerGrid,4),this.throttler=new UE(this.logger.createChild("ovcThrottler"),this.configProvider.config.ovcRampDownCooldown,this.configProvider.config.ovcRampUpCooldown)}start(){this.isStarted=!0,this.throttler.changed((()=>this.event("calculatorStateChanged").raise(2,{ovc:this.throttler.value,ovcPayload:this.throttler.payload})))}stop(){this.isStarted=!1}dispose(){super.dispose(),this.throttler.dispose()}processEstimatedBandwidth(g){const m=this.getOVCEstimate(g);this.throttler.setValue(Math.max(1,Math.min(m,this.maxCountStatic)),{bandwidth:g,reason:0})}updateParticipantCount(g){if(!this.configProvider||g===this.previousParticipantsCount)return;const m=this.configProvider.config.ovcXLParticipantsCount;g>m&&this.previousParticipantsCount<=m&&(this.maxCountStatic=this.configProvider.config.ovcMaxCountXL),g<=m&&this.previousParticipantsCount>m&&(this.maxCountStatic=this.configProvider.config.ovcMaxCount),this.previousParticipantsCount=g;const f=this.getOVCEstimate(this.throttler.payload?.bandwidth??0);this.throttler.setValue(Math.max(1,Math.min(f,this.maxCountStatic)),{bandwidth:this.throttler.payload?.bandwidth,reason:1})}getOVCEstimate(g){this.bandwidthEstimationAvailable||(this.bandwidthEstimationAvailable=this.isStarted&&g>0&&(this.totalSamples++>=this.configProvider.config.ovcIgnoreFirstSamples||Math.floor(g)/this.configProvider.config.ovcBandwidthPerVideoReceiver>=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount));let m=this.configProvider.config.nonEstimatedDefaultVideoReceiversCount;return this.bandwidthEstimationAvailable&&(m=Math.floor(this.sampleSmoothed(g)/this.configProvider.config.ovcBandwidthPerVideoReceiver)),m}sampleSmoothed(g){if(this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples?this.smoothingWindow.shift():this.smoothingWindow.length===this.configProvider.config.ovcSlidingWindowSamples-1&&(this.smoothingWindow=this.smoothingWindow.map((()=>g))),this.smoothingWindow.push(g),this.smoothingWindow.length>=this.configProvider.config.ovcSlidingWindowSamples){const g=this.smoothingWindow.slice().sort(),m=average(g);return g[g.length-1]-(g[g.length-1]-m*(1-this.configProvider.config.ovcSlidingWindowPercentile))}return g}updateStaticConstraint(g,m,f){g&&g<m&&(this.maxCountStatic=Math.min(this.maxCountStatic,f))}},UE=class extends Be{constructor(g,m,f){super(g),this.logger=g,this.throttleDownCooldown=m,this.throttleUpCooldown=f,this.wasRampingUp=!0,this.lastUpdateTime=0}get value(){return this.lastValue}get payload(){return this.lastPayload}setValue(g,m){if(g===this.lastValue)return;this.lastPayload=m;const f=g>this.lastValue,S=void 0!==this.lastValue&&f!==this.wasRampingUp?f?this.throttleUpCooldown:this.throttleDownCooldown:-1,v=Date.now();v-this.lastUpdateTime<S&&(1!==m.reason||f)||(void 0!==this.lastValue&&(this.lastUpdateTime=v,this.wasRampingUp=f),this.logger.safe.info(`optimal video receivers count updated ${this.lastValue} -> ${g}`),this.lastValue=g,this.raiseChanged())}},VE=class _CPUUsageMetricCollector{constructor(g,m=30){this.logger=g,this.maxEventNum=m,this.report=[],this.started=!1}isSupported(){return Boolean(window.chrome?.runtime?.connect)}start(){this.isSupported?(this.started=!0,this.logger.debug("Starting collecting CPU metric"),this.port=window.chrome.runtime.connect(_CPUUsageMetricCollector.extensionID,{name:_CPUUsageMetricCollector.extensionName}),this.port.onMessage.addListener((g=>{g&&arrayLimitedPush(this.report,{timeStamp:Date.now(),value:g},this.maxEventNum)}))):this.logger.debug("Chrome runtime is not supported")}stop(){this.port?.disconnect(),this.port=null,this.started=!1}getSamples(){return this.report}getLastSample(){return getLast(this.report)}getCurrentCpuSample(){return new Promise(((g,m)=>{this.started&&g(getLast(this.report)),this.isSupported()||m("Not supported"),this.port=window.chrome.runtime.connect(_CPUUsageMetricCollector.extensionID,{name:_CPUUsageMetricCollector.extensionName}),this.port.onMessage.addListener((f=>{this.stop(),f||m("Not supported"),g({timeStamp:Date.now(),value:f})}))}))}clearStats(){this.report=[]}};VE.extensionID="nkeimhogjdpnpccoofpliimaahmaaome",VE.extensionName="processCpu";var BE=VE,HE=class{constructor(g){this.logger=g,this.started=!1}static isSupported(){return void 0!==globalThis.PressureObserver}get cpuState(){return this.currentCpuState}start(){if(this.logger.safe.debug("Starting CPU pressure observer"),this.started)this.logger.safe.debug("CPU pressure observer is already started");else{try{this.cpuObserver=new globalThis.PressureObserver((g=>{g.forEach((m=>{"cpu"===m.source&&this.currentCpuState!==m.state&&(this.logger.safe.debug(`CPU pressure state changed: ${JSON.stringify(g)}`),this.currentCpuState=m.state)}))}),{sampleRate:1})}catch(g){throw this.logger.safe.error(`Error while creating pressure observer: ${g}`),g}this.started=!0,this.cpuObserver?.observe("cpu")}}stop(){this.started=!1,this.cpuObserver?.disconnect()}},$E=class{static getStrategy(g){switch(g.config.diagnostics.performanceMonitoring.monitoringStrategy){case"decodeTime":default:return new GE(g);case"renderedFps":return new jE(g);case"rendererVolatility":return new WE(g)}}},GE=class{constructor(g){this.configProvider=g,this.decodeThresholds=this.configProvider.config.diagnostics.performanceMonitoring.decodeThresholds,this.defaultThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultThrehold,this.badPerfCount=new Map}checkQuality(g){let m=!1,f=!1;const S=this.decodeThresholds[g.frameHeight]||this.defaultThreshold,v=g.decodeTimeTracker.getReport();return v.median>S.maxDecodeTime&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),v.median<S.maxDecodeTime&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),f=!0),m?0:f?2:1}},jE=class{constructor(g){this.configProvider=g,this.fpsDiffThresholds=this.configProvider.config.diagnostics.performanceMonitoring.fpsDiffThresholds,this.defaultFpsDiffThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultFpsDiffThreshold,this.badPerfCount=new Map}checkQuality(g){let m=!1,f=!1;const S=this.fpsDiffThresholds[g.frameHeight]||this.defaultFpsDiffThreshold,v=g.incomingFps.getReport(),C=g.rendererFps.getReport(),_=v.median-C.median;return _>=S.fpsDiff&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),_<S.fpsDiff&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),f=!0),m?0:f?2:1}},WE=class{constructor(g){this.configProvider=g,this.volatilityThresholds=this.configProvider.config.diagnostics.performanceMonitoring.volatilityThresholds,this.defaultVolatilityThreshold=this.configProvider.config.diagnostics.performanceMonitoring.defaultVolatilityThreshold,this.badPerfCount=new Map}checkQuality(g){let m=!1,f=!1;const S=this.volatilityThresholds[g.frameHeight]||this.defaultVolatilityThreshold,v=g.rendererFps.getReport(),C=g.incomingFps.getReport(),_=Math.abs(v.volatilityPercent-C.volatilityPercent);return S&&_>=S&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)||1),m=!0),_<S&&this.badPerfCount.get(g.msi)&&(this.badPerfCount.set(g.msi,this.badPerfCount.get(g.msi)-1),f=!0),m?0:f?2:1}},qE=class extends Be{constructor(g,m,f,S){super(),this.statsGatherer=g,this.diagnostics=m,this.configProvider=f,this.logger=S,this.paused=!1,this.started=!1,this.cpuMetricCollector=new BE(this.logger,this.configProvider.config.diagnostics.performanceMonitoring.cpuMetricCollector),this.trackInterval=this.configProvider.config.diagnostics.performanceMonitoring.remoteVideoTrackInterval,this.badPerfIds=new Set,this.perfTrackerMap=new Map,this.subs=[],this.rendererFpsCap=40,this.configProvider.config.diagnostics.performanceMonitoring.useComputePressure&&HE.isSupported()&&(this.cpuPressureObserver=new HE(this.logger))}start(){this.logger.safe.debug("Starting RemoteVideoPerformanceCalculator"),this.started?this.logger.safe.debug("RemoteVideoPerformanceCalculator already running. Do nothing."):(this.calculatorStrategy=$E.getStrategy(this.configProvider),this.started=!0,this.cpuPressureObserver?.start(),this.subs.push(this.statsGatherer.on("onDiagnosticUpdated",(g=>this.processStats(g)))))}stop(){this.logger.safe.debug("Stopping RemoteVideoPerformanceCalculator"),this.started=!1,this.subs.forEach((g=>{g.dispose()})),this.cpuMetricCollector.stop(),this.cpuPressureObserver?.stop()}dispose(){this.logger.safe.debug("Disposing RemoteVideoPerformanceCalculator"),this.cleanupMaps(),this.stop()}cleanupMaps(){this.badPerfIds.clear(),this.perfTrackerMap.clear()}async processStats(g){this.paused||g.video?.recv?.length&&g.video?.recv?.forEach((async m=>{const f=m.renderer?.msi;if(!this.perfTrackerMap.has(f)){const g={id:m.mediaEntity.remoteTrackId,decodeTimeTracker:new Wv(this.trackInterval),macroblockLossTracker:new Wv(this.trackInterval),macroblockMaxLossTracker:0,freezeDurationPercent:0,frameHeight:0,rendererFps:new Wv(this.trackInterval),incomingFps:new Wv(this.trackInterval),framesReceived:0,framesDecoded:0,decoder:"",msi:f};this.perfTrackerMap.set(f,g)}const S=this.perfTrackerMap.get(f);if(m.inboundRTP.totalDecodeTime&&m.inboundRTP.framesDecoded){const g=round(m.inboundRTP.totalDecodeTime/m.inboundRTP.framesDecoded*1e3,2);S.decodeTimeTracker.captureSample(g)}const v=m.extensions.macroblockRateStats?.macroblockRateDecoderLossPercent;S.macroblockLossTracker.captureSample(v),S.macroblockMaxLossTracker=m.extensions.macroblockRateStats?.macroblockRateMaxDecoderLossPercent,m.extensions.duration&&(S.freezeDurationPercent=m.extensions.totalFreezeDuration/m.extensions.duration*100),S.frameHeight=m.inboundRTP.frameHeight||0,void 0!==m.extensions.frameRateDecoded&&void 0!==m.inboundRTP.framesPerSecond&&m.extensions.frameRateDecoded<=this.rendererFpsCap&&m.inboundRTP.framesPerSecond<=this.rendererFpsCap&&(S.rendererFps.captureSample(m.extensions.frameRateDecoded),S.incomingFps.captureSample(m.inboundRTP.framesPerSecond)),m.inboundRTP.framesReceived&&m.inboundRTP.framesDecoded&&(S.framesReceived=m.inboundRTP.framesReceived,S.framesDecoded=m.inboundRTP.framesDecoded),S.decoder=m.inboundRTP.decoderImplementation,S.rendererFps.isReportComplete()&&S.incomingFps.isReportComplete()&&S.decodeTimeTracker.isReportComplete()&&(this.paused=!0,await this.checkQuality(S,g.perfCounters),this.paused=!1)}))}async checkQuality(g,m){const f=[];let S;try{S=await this.cpuMetricCollector.getCurrentCpuSample()}catch{this.logger.safe.debug("CPU sampling is not supported")}const v={ts:Date.now(),trackId:g.id,decodeTime:g.decodeTimeTracker.getReport(),macroblockLossPercent:g.macroblockLossTracker.getReport(),macroblockMaxLossPercent:g.macroblockMaxLossTracker,freezeDurationPercent:g.freezeDurationPercent,perfCounters:m,cpuUsage:S,rendererFps:g.rendererFps.getReport(),incomingFps:g.incomingFps.getReport(),framesDecoded:g.framesDecoded,framesReceived:g.framesReceived,msi:g.msi,frameHeight:g.frameHeight,decoder:g.decoder};f.push(v);const C=this.calculatorStrategy.checkQuality(g);0===C&&(this.diagnostics.registerVideoPerformanceEvent(f,1),this.logger.safe.debug(`Bad perf detected for msi ${g.msi}: ${JSON.stringify(f)}`),this.event("calculatorStateChanged").raise(1,{msi:g.msi})),2===C&&(this.diagnostics.registerVideoPerformanceEvent(f,0),this.logger.safe.debug(`Good perf detected for msi ${g.msi}: ${JSON.stringify(f)}`),this.event("calculatorStateChanged").raise(0,{msi:g.msi})),this.perfTrackerMap.delete(g.msi)}},zE=class extends Be{constructor(g,m,f,S){super(),this.statsGatherer=g,this.diagnostics=m,this.configProvider=f,this.logger=S,this.calculators=new Map,this.subs=[]}on(g,m){switch(g){case"onIncomingVideoQualityChanged":this.addCalculator(0),this.startCalculator(0);break;case"onOptimalVideoCountChanged":this.addCalculator(2),this.startCalculator(2)}return this.subscribe({changed:void 0,on:{name:String(g),handler:m}})}addCalculator(g){let m=this.calculators.get(g);if(!m){switch(g){case 0:if(!this.configProvider.config.diagnostics.performanceMonitoring.enableRemoteVideoCalculator)return;m=new qE(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("RemoteVideoPerformanceCalculator"));break;case 2:if(!this.configProvider.config.enableOptimalVideoCount)return;m=new xE(this.configProvider,this.logger.createChild("OptimalVideoCountCalculator"));break;case 1:throw new Error("Not implemented")}this.subs.push(m.on("calculatorStateChanged",((m,f)=>{this.handleChanged(g,m,f)}))),this.calculators.set(g,m)}}startCalculator(g){this.logger.safe.debug(`adding calculator with id ${g}`);const m=this.calculators.get(g);m&&m.start()}stopCalculator(g){this.logger.safe.debug(`stopping calculator with id ${g}`);const m=this.calculators.get(g);m&&m.stop()}processNotification(g,m){switch(g){case"BandwithNotification":this.calculators.get(2)?.processEstimatedBandwidth(m.bw);break;case"ParticipantCountChanged":this.calculators.get(2)?.updateParticipantCount(m.count);break;default:this.logger.safe.info(`Notification message handler not found for type: ${g}`)}}dispose(){super.dispose(),this.calculators.forEach((g=>{g.dispose()})),this.subs.forEach((g=>{g.dispose()}))}handleChanged(g,m,f){switch(this.logger.info(`calculatorStateChanged  ${m}: calculatorType ${g} ${JSON.stringify(f)}`),g){case 0:this.configProvider.config.diagnostics.performanceMonitoring.enableLowerResolution&&this.event("onIncomingVideoQualityChanged").raise(m,f?.msi);break;case 2:this.event("onOptimalVideoCountChanged").raise(f?.ovc,f?.ovcPayload)}}},KE=0,JE=class _WebRtcSession2{constructor(g,m,f){this.context=g,this.callId=m,this.callback=f,this.callbacks={},this.multiParty=this.context.config?.isConference,this.configProvider=this.context.configProvider,this.logger=this.context.getLogger().createChild("webrtc2-"+ ++KE),this.deviceManager=this.context.callDeviceManager.getDefaultDeviceManager(),this.capabiltityGatherer=AC.build({global:this.context.maContext},this.configProvider.config.useSdpCapabilities),this.reinvitelessContext=makeReinvitelessContext(this.context.config.reinvitelessConfig,this.multiParty),this.iceHostCandidateOnly=this.multiParty&&getFrom("iceHostCandidateOnly",this.context.config,this.configProvider.config),this.mediaManager=new CE({logger:this.logger,configProvider:this.configProvider,numVideoChannels:this.multiParty&&this.configProvider.config.numVideoChannelsGvc||1,useSimulcast:this.multiParty,reinviteltessContext:this.reinvitelessContext}),this.sessionDescription=wS.build({sdpTransform:new mE(this.context),mediaManager:this.mediaManager,logger:this.logger,configProvider:this.configProvider,configuration:this.getStreamTransformConfiguration()}),this.allowedMediaContentType=getFrom("webrtcAllowedMediaContentType",this.context.config,this.configProvider.config).concat(),this.receiveStreamCollection=new vv({streamAdded:g=>this.streamAdded(g),streamRemoved:g=>this.streamRemoved(g)}),this.diagnostics=this.context.diagnostics,this.qmDiagnostics=this.diagnostics?.newQualityManagerDiagnostics(),this.statsGatherer=new yC(this.logger.createChild("stats"),this.configProvider,this.diagnostics,this.mediaManager,this.multiParty),this.qualityManager=new JC(this.logger.createChild("qm"),{scalingEnabled:this.configProvider.config.webrtcVideoScaling,customBwEstimationEnabled:this.configProvider.config.webrtcEnabledCustomBwEstimationForVideo,sendBandwidthNotificationsEnabled:this.multiParty&&this.configProvider.config.webrtcSendBandwidthNotificationsEnabled},this,this.statsGatherer,this.qmDiagnostics,this.configProvider),this.activeSpeakerManager=new pv(this.callback.onContributingSourcesChanged,this.callback.onDominantSpeakerChanged,this.diagnostics?.dshDiagnostics,this.logger.createChild("ActiveSpeakerManager")),this.negotiationQueue=new Lp(this.logger),this.negotiationEmulator=new $C(this.logger.createChild("negotiationEmulator"),fE,this.sessionDescription,this.negotiationQueue,this.mediaManager),this.extensionsManager=this.setupExtensionsManager(),this.wasConnected=!1,this.toBeCalledAfterConnected=[],this.peerConnection=null,this.doAudioMute=this.context.config.muted,this.iceCandidatesDeferred=new Sr,this.iceCandidatesTimer=null,this.relayCandidateGathered=!1,this.iceCandidateReceived=!1,this.triggerRenegotiationFlag=!1,this.canTriggerRenegotiation=!0,this.noIceCandidates=!1,this.noRelayIceCandidates=!1,this.forceMediaStreamUpdate=!1,this.negotiatedModalities={},this.disabledModalities={},this.reinvitelessRequestedModalities={},this.reinvitelessAppliedModalities={},this.iceDisconnectedTimer=null,this.statisticsReport=Promise.resolve({type:"WebRtcMediaStats",data:{}}),this.terminated=!1,this.initiator=!1,this.streamsChangedListener=null,this.dtmfSender=s_.build({logger:this.logger,configProvider:this.configProvider}),this.mediaContentType=getFrom("webrtcMediaContentType",this.context.config,this.configProvider.config),this.streamsChangedNotificationScheduled=!1,this.subscriptionManager=new _v(this.logger.createChild("subs"),this.configProvider,{getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:g=>this.streamsChangedListener=g},this.diagnostics?.newSubscriptionManagerDiagnostics()),this.remoteVideoResolutionManager=new YC(this.logger.createChild("rvrm"),this.multiParty,this.configProvider,this.mediaManager,this.statsGatherer,this.diagnostics),this.remoteVideoManager=new e_(this.logger.createChild("RemoteVideoManager"),this.configProvider,this.statsGatherer,this.diagnostics,this.remoteVideoResolutionManager,this.context.maContext.domOverrides),this.transceiverManager=null,this.encStreamsManager=new E_(this.configProvider,this.context.maContext.getEncodedStreamsWorkerProvider?.(),this.logger.createChild("EncodedStreamsManager")),this.streamSendersManager=new lE(this.mediaManager,this.logger.createChild("SSM"),this.context.callDeviceManager,this.configProvider,this.statsGatherer,this.qmDiagnostics,this.multiParty,this.encStreamsManager),this.hwSilent=!1,this.configuredModalitiesPromise=Promise.resolve(),this.negotiationCompletedPromise=new Sr,this.transportStateProvider=null,this.isMuteHold=!1,this.rawIncomingAudioStreamManager=new Wr(this.logger.createChild("rawIncomingAudioStream")),this.useNullAudioStream=!1,this.audioCodecManager=new kE(this.encStreamsManager,this.logger,this.configProvider),this.perfMonitorSubs=[],this.ufdManager=g.getUfdManager(),this.statsGatherer.on("onStatisticsChanged",(g=>{this.updateQualityLevels(g)})),this.negotiationCompletedPromise.promise.catch((()=>{})),this.negotiationCompletedPromise.reject("placeholder"),this.remoteVideoResolutionManager.on("onNegotiationRequired",(()=>this.triggerRenegotiation(!0))),this.remoteVideoResolutionManager.on("onSourceRequestRequired",((g,m,f,S)=>this.requestSource(g,m,f,S))),this.performanceMonitor=new zE(this.statsGatherer,this.diagnostics,this.configProvider,this.logger.createChild("PerformanceMonitor")),this.setSubsForSubscriptionManager(),this.setSubsForStreamManagerEvents(),this.configProvider.mediaConfig.maxBandwidthInKbps&&(this.statsGatherer.setMaxSessionBandwidth(this.configProvider.mediaConfig.maxBandwidthInKbps),this.diagnostics&&(this.diagnostics.maxSessionBandwidth=this.configProvider.mediaConfig.maxBandwidthInKbps)),this.createAudioRenderer(),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(g=>g.setStatsProvider(this.statsGatherer,this.mediaManager.getLocalTracksInfo()))),this.context.callDeviceManager.isVirtualDeviceEnabled&&this.setupCallDeviceManagerSubs(),this.configProvider.config.enableActiveSpeakerBasedDSH&&this.activeSpeakerManager.setStrategy(new uE({configProvider:this.configProvider})),this.perfMonitorSubs.push(this.performanceMonitor.on("onIncomingVideoQualityChanged",((g,m)=>{this.onIncomingVideoQualityChanged(g,m)}))),this.configProvider.config.webrtcVideoScaling&&(this.perfMonitorSubs.push(this.performanceMonitor.on("onOptimalVideoCountChanged",((g,m)=>{this.onOptimalVideoCountChanged(g,m)}))),this.onOptimalVideoCountChanged(this.configProvider.config.nonEstimatedDefaultVideoReceiversCount))}get iceTransportPolicy(){return this.configProvider.getIceTransportPolicy()}getAcceptedTypes(){return this.allowedMediaContentType}clone(g,m){const f=shallowClone(this.context);f.config=shallowClone(this.context.config),f.config.webrtcMediaContentType=this.mediaContentType,f.config.webrtcAllowedMediaContentType=this.allowedMediaContentType,f.configProvider=m,f.diagnostics=this.context.diagnostics?.newNativeSession(!1),g?(f.config.isConference=!0,f.config.isPstnCall=!1):(f.config.iceHostCandidateOnly=!1,this.configProvider.config.waitForRelayOnReconnect&&(f.config.webrtcIceGatheringTimeoutIncreased=!0));const S=new _WebRtcSession2(f,this.callId,this.callback);return this.useNullAudioStream&&S.useNullAudioStreamClient(),this.relayManagerProvider&&(S.relayManagerProvider=this.relayManagerProvider),S.callbacks.onNegotiationRequired=this.callbacks.onNegotiationRequired,S}async setCallConstraints(g,m){const f=this.configProvider.setCallConstraints(g);if(this.logger.safe.info(`[${m}] Setting call constraints ${JSON.stringify(f)}, enableDynamicCallConstraints: ${this.configProvider.config.enableDynamicCallConstraints}`),this.configProvider.config.enableDynamicCallConstraints)try{await this.streamSendersManager.applyCallConstraints(m),this.configProvider.addCallConstraintsTelemetryEvent(f,"applied")}catch(g){throw this.logger.safe.error(`Error while applying constraints: ${g}`),g}else this.configProvider.addCallConstraintsTelemetryEvent(f,"applied");return f}setInternals(g,m){if(this.logger.safe.info(`[${m}] Setting internals from previous session`),this.diagnostics?.commitNativeSession(),g.extensionsManager&&this.extensionsManager){const m=g.extensionsManager.getExtension("videoStreamControl");m?.getOptions()&&this.extensionsManager.configureExtension("videoStreamControl",m.getOptions())}g.subscriptionManager&&(this.subscriptionManager?.dispose(),this.subscriptionManager=g.subscriptionManager,this.subscriptionManager.setDiagnostics(this.diagnostics?.newSubscriptionManagerDiagnostics()),this.subscriptionManager.setStreamProvider({getStreams:()=>this.receiveStreamCollection.getStreams(),setOnStreamsChangedHandler:g=>this.streamsChangedListener=g}),this.subscriptionManager.setLogger(this.logger.createChild("subs")),this.setSubsForSubscriptionManager(),this.subscriptionManager.reriseSubscribeEvents(),this.notifyStreamsChanged()),g.audioRenderer&&(g.audioRenderer.play(this.audioRenderer.getStream()),this.audioRenderer=g.audioRenderer),g.remoteVideoManager?.moveRenderers(this.remoteVideoManager),g.rawIncomingAudioStreamManager&&(this.rawIncomingAudioStreamManager=g.rawIncomingAudioStreamManager)}setSubsForSubscriptionManager(){this.subscriptionManagerSubs=[this.subscriptionManager.on("onTrackIdsChanged",(g=>this.statsGatherer.setSubscribedTrackIds(g))),this.subscriptionManager.on("onTrackSsrcChanged",(g=>this.statsGatherer.setSubscribedTrackSsrc(g))),this.subscriptionManager.on("onSubscriptionChanged",((g,m,f,S,v,C)=>this.onSubscriptionChanged(g,m,f,S,v,C))),this.subscriptionManager.on("onSubscriptionFailed",((g,m,f,S,v)=>this.statsGatherer.addSubscriptionEvent(g,m,f,S,v)))]}onSubscriptionChanged(g,m,f,S,v,C){m===je.MODALITY.video&&(2===g&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount()),3===g&&this.diagnostics.addSubscriptionToOvcEvent(this.subscriptionManager.getSubscriptionsCount())),this.statsGatherer.addSubscriptionEvent(g,m,f,S,null,v,C)}setSubsForStreamManagerEvents(){this.streamSendersManager.on("onSendStreamChanged",((g,m)=>{this.statsGatherer.updateSendStream(g,m),g?.hasAudio()&&this.diagnostics?.setAudioSendStream(g,m),this.diagnostics?.setPresentationAudioOnScreenSharing(g,m)})),this.streamSendersManager.on("onVideoCaptureFreeze",(g=>{this.isConnected()&&this.ufdManager.signalEvent("VideoCaptureDeviceFreeze",g?"Bad":"Good","Video")})),this.streamSendersManager.on("onMaxVideoSendCapabilitiesChanged",((g,m)=>this.onMaxVideoSendCapabilitiesChanged(g,m)))}move(g,m){this.logger.safe.info(`[${m}] moving to new session`),g.setInternals({subscriptionManager:this.subscriptionManager,extensionsManager:this.extensionsManager,audioRenderer:this.audioRenderer,remoteVideoManager:this.remoteVideoManager,rawIncomingAudioStreamManager:this.rawIncomingAudioStreamManager},m),g.muteHold(this.isMuteHold,m),this.doAudioMute?g.muteInputAsync(m):g.unmuteInputAsync(m),this.subscriptionManager=null,this.audioRenderer=null,this.rawIncomingAudioStreamManager=null,this.callbacks.onTerminated=null}setMute(g,m,f){this.logger.safe.info(`[${f}] call setMute for ${g} with mute state ${m}`),this.streamSendersManager.setMuted(g,m,f),this.updateQualityLevels(this.statsGatherer.getLastStatistics())}configureModalitiesAsync(g,m){const f=(async()=>{if(await this.configuredModalitiesPromise,!g||!g.audio&&!g.video&&!g.sharing)throw new Error(`Invalid parameters! ${JSON.stringify(g)}`);const f=shallowClone(g),S=shallowClone(this.negotiatedModalities);this.configProvider.config.alwaysNegotiateDataChannel&&(delete f.data,delete S.data);const v=!this.configuredModalities||!areNegotiatedDirectionsFulfilled(f,S);if(this.configuredModalities=g,this.logger.safe.info(`[${m}] configure modalities`,`audio: ${g.audio}`,`video: ${g.video}`,`sharing: ${g.sharing}`,`data: ${g.data}`,`peerconnection: ${!!this.peerConnection}`,`pc.signalingState: ${this.peerConnection?.signalingState??"-"}`,`needNewRenegotiation: ${v}`),v){this.updateSendStreamsReinviteless(m)||(this.configProvider.config.removeSendersOnConfigureModalities&&!isOnHold(this.configuredModalities)&&await this.streamSendersManager.update(this.configuredModalities,!0,m),this.triggerRenegotiation(!1,m))}})();return this.configuredModalitiesPromise=f.catch((g=>{this.logger.safe.warn(`[${m}] Error during configuring modalities: ${stringifyObject(g)}`)})),f}getConfiguredModalities(){return this.configuredModalities}getDisabledModalities(){return this.disabledModalities}createAudioElement(g){this.audioRenderer.assureAudioElement(g)}useNullAudioStreamClient(){this.useNullAudioStream=!0,this.streamSendersManager.useNullAudioStreamClient()}createOfferAsync(g){const m=this.negotiationQueue.add((()=>this.doCreateOfferAsync(g)),g);return this.resetNegotiationQueue(g),m}getTimerTracker(g,m){return this.diagnostics?this.diagnostics.getTimerTracker(g,m):this.statsGatherer.getTimerTracker(g,m)}async doCreateOfferAsync(g){const m=this.getTimerTracker("createOfferAsync",{first:!0});m.mark("start"),this.logger.safe.info(`[${g}] create [offer] configured: ${JSON.stringify(this.configuredModalities)}`),this.initiator=!0,this.throwIfModalitiesNotConfigured("no configured modalities to create offer for"),this.canTriggerRenegotiation=!1,this.negotiatingModalities=this.configuredModalities,await this.assurePeerConnectionAsync(g,m.clone("assurePeerConnectionAsync")),m.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${g}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),isOnHold(this.negotiatingModalities)&&!isEmpty(this.negotiatedModalities)&&Object.keys(this.negotiatingModalities).forEach((g=>{void 0===this.negotiatedModalities[g]&&delete this.negotiatingModalities[g]})),this.transceiverManager.assureTransceivers(this.negotiatingModalities);const f=await this.assureStreamsAndDataChannel(this.negotiatingModalities,g,m.clone("assureStreamsAndDataChannel"));m.markAndMeasure("assurePeerConnectionAsync","assureStreamsAndDataChannel"),this.offeredModalities=f,!allowDataChannel(this.context)&&this.configProvider.config.webrtcNegotiateDisabledDataModality&&!this.offeredModalities[je.MODALITY.data]&&this.multiParty&&(this.offeredModalities[je.MODALITY.data]=je.MEDIA_STATE.inactive),this.configureAudioCodec(),this.logger.safe.info(`[${g}] create [offer] offered: ${JSON.stringify(this.offeredModalities)}`);const S=await this.peerConnection.createOffer();m.markAndMeasure("assureStreamsAndDataChannel","createOffer"),this.logger.unsafe.debug(`[${g}] create [offer] offer from peer connection, sdp: ${S.sdp}`);const v=this.sessionDescription.createLocalOffer(S.sdp);this.hasIceCandidates(v)||this.resetCandidateGathering(g),this.statsGatherer.startWaitingForStreamStart(this.offeredModalities),this.diagnostics&&(this.diagnostics.offeredModalities=f),this.setupIceGatheringTimeout(g);const C=v.toLocal();this.logger.unsafe.debug(`[${g}] create [offer] set local description`,"sdp:",C),await this.peerConnection.setLocalDescription({sdp:C,type:"offer"}),m.markAndMeasure("createOffer","sLD"),await this.iceCandidatesDeferred.promise,m.markAndMeasure("sLD","candidates");const _=this.sessionDescription.createLocalOffer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(_),_.updateModalities(this.offeredModalities),this.checkIceCandidates(_);const E=_.toOffer();this.logger.unsafe.debug(`[${g}] CREATE OFFER`,"sdp:",E);const T={blob:E,contentType:this.mediaContentType};return""===this.configProvider.mediaConfig.webrtcRequiredFeatures||this.multiParty||(T.requiredFeatures=this.configProvider.mediaConfig.webrtcRequiredFeatures),this.audioCodecManager.decoder?.setRecvPayloads(_.getPayloadsForMedia(je.MEDIA_TYPE.audio)),this.configProvider.countryCode&&(T.clientLocation=this.configProvider.countryCode),this.mediaManager.getMediaEntities().forEach((g=>{g.setExtension("midApplied",!0)})),this.doRetargetIfNeeded(T,v,g),this.reinvitelessContext.enabled&&(this.mediaManager.updateMediaEntitiesWithLocalTracks(),T.mediaDescriptions=this.getMediaDescriptions(this.offeredModalities)),this.setBWSeed(T),m.markAndMeasure("start","createOfferAsync"),T}processOfferAsync(g,m){const f=this.negotiationQueue.add((()=>this.doProcessOfferAsync(g,m)),m);return this.resetNegotiationQueue(m),f}async doProcessOfferAsync(g,m){const f=this.getTimerTracker("processOfferAsync",{first:!0});f.mark("start"),this.mediaManager.backup();const S=g.blob;if(this.logger.unsafe.debug(`[${m}] process [offer]`,"sdp:",S),this.configProvider.config.webrtcCompareContentTypeInOffer&&(throwIfNotSupported(g.contentType,this.allowedMediaContentType),this.mediaContentType=g.contentType),this.offerOriginator&&this.offerOriginator!==g.originator&&this.configProvider.config.rejectIncompatibleOriginator)throw{detail:"mediaContent.originator is different on renegotiation",type:je.MEDIA_ERROR.incompatibleOriginator};if(this.offerOriginator=g.originator,g.requiredFeatures){const m=this.configProvider.mediaConfig.webrtcRejectedFeatures.split(",");throwIfFeatureNotSupported(g.requiredFeatures.split(","),m)}this.initiator=!1,this.offeredDescription=this.sessionDescription.createRemoteOffer(S),this.canTriggerRenegotiation=!1,this.offeredModalities=invertModalities(this.offeredDescription.getModalities()),this.peerConnection||(this.context.configProvider.mediaConfig.isTransportUnbundled?this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.couldBeUnbundled():this.context.configProvider.mediaConfig.isTransportUnbundled=this.offeredDescription.isUnbundled());let v=this.configProvider.config.removeUnsupportedVideoModality?this.offeredModalities:shallowClone(this.offeredModalities);if(hasSendDirectionality(this.offeredModalities.video)||hasReceiveDirectionality(this.offeredModalities.video)||hasSendDirectionality(this.offeredModalities.sharing)||hasReceiveDirectionality(this.offeredModalities.sharing)){const g=this.offeredDescription.getVideoCodecs();try{f.mark("startGetCapabilities");const S=await this.capabiltityGatherer.getCapabilities("video");f.markAndMeasure("startGetCapabilities","getCapabilities");S.codecs.some((m=>g.some((g=>m.mimeType===g&&this.configProvider.config.primaryVideoCodecs.includes(g)))))||(this.logger.safe.warn(`[${m}] offer doesn't contain any supported video codecs`),this.disabledModalities.video=v.video,this.disabledModalities.sharing=v.sharing,delete v.video,delete v.sharing)}catch(g){this.logger.safe.error(`[${m}] failed to get video capability ${stringifyObject(g)}`)}}return(!allowDataChannel(this.context)&&(hasSendDirectionality(this.offeredModalities.data)||hasReceiveDirectionality(this.offeredModalities.data))||this.dataChannel&&"Failed"===this.dataChannel.state)&&(this.logger.safe.info(`[${m}] Supressing data modality as data channel is not possible`),v=shallowClone(v),delete v.data),f.markAndMeasure("start","processOfferAsync"),this.logger.safe.info(`[${m}] process [offer] offered: ${JSON.stringify(this.offeredModalities)} acceptable: ${JSON.stringify(v)}`),v}async createAnswerAsync(g,m){if(g)return{blob:"",contentType:this.mediaContentType};const f=this.getTimerTracker("createAnswerAsync",{first:!0});f.mark("start"),this.logger.safe.info(`[${m}] create [answer] offered: ${JSON.stringify(this.offeredModalities)} configured: ${JSON.stringify(this.configuredModalities)}`),this.throwIfModalitiesNotConfigured("no configured modalities to create answer for");const S=this.configuredModalities;let v=this.negotiatingModalities=negotiateModalities(this.offeredModalities,S);await this.assurePeerConnectionAsync(m,f.clone("assurePeerConnectionAsync")),f.markAndMeasure("start","assurePeerConnectionAsync"),this.logger.safe.info(`[${m}] updatePeerConnectionStreamsAsync, pc state: ${JSON.stringify(this.peerConnection.signalingState)}`),await this.handleCodecSwitchUnsupported(m),f.markAndMeasure("assurePeerConnectionAsync","handleCodecSwitchUnsupported"),this.configureAudioCodec();const C=this.offeredDescription.toRemote(v);this.logger.unsafe.info(`[${m}] create [answer] set remote description', 'negotiated:`,v,"sdp:",C),await this.peerConnection.setRemoteDescription({sdp:C,type:"offer"}),f.markAndMeasure("handleCodecSwitchUnsupported","setRemoteDescription"),this.transceiverManager.syncTransceivers(v),this.mediaManager.getMediaEntities().forEach((g=>{g.setExtension("midApplied",!0)})),await this.assureStreamsAndDataChannel(v,m,f.clone("assureStreamsAndDataChannel")),f.markAndMeasure("setRemoteDescription","assureStreamsAndDataChannel"),this.callbacks.onTransportInitialized&&this.callbacks.onTransportInitialized();const _=await this.peerConnection.createAnswer();f.markAndMeasure("assureStreamsAndDataChannel","createAnswer"),this.logger.unsafe.debug(`[${m}] create [answer] answer from peer connection`,"sdp:",_.sdp);const E=this.sessionDescription.createLocalAnswer(_.sdp);this.hasIceCandidates(E)||this.resetCandidateGathering(m),this.statsGatherer.startWaitingForStreamStart(v),this.diagnostics&&(this.diagnostics.offeredModalities=v),this.setupIceGatheringTimeout(m);const T=E.toLocal();this.logger.unsafe.debug(`[${m}] create [answer] set local description`,"sdp:",T),await this.peerConnection.setLocalDescription({sdp:T,type:"answer"}),f.markAndMeasure("createAnswer","sLD"),await this.iceCandidatesDeferred.promise,f.markAndMeasure("sLD","candidates");const I=this.sessionDescription.createLocalAnswer(this.peerConnection.localDescription.sdp);this.fixLocalDescription(I),I.updateModalities(v),this.checkIceCandidates(I);const b=I.toAnswer();this.audioCodecManager.decoder?.setRecvPayloads(I.getPayloadsForMedia(je.MEDIA_TYPE.audio)),this.checkAudioCodecNegotiated(m),await this.streamSendersManager.activate(m),f.markAndMeasure("candidates","streamSendersManagerActivate"),this.updateLocalMediaSources(),this.applyReceiveCapabilities(),v=I.getModalities(),this.reinvitelessContext.enabled&&(v=removeChangedSendDirection(this.negotiatingModalities,v)),areNegotiatedDirectionsAcceptable(this.configuredModalities,this.negotiatingModalities,v)||this.triggerRenegotiation(!0,m),this.setNegotiatedModalities(v),this.statsGatherer.sessionInfo.setBweType(I.getBweType()),this.diagnostics&&(this.diagnostics.bweType=I.getBweType()),this.logger.unsafe.debug(`[${m}] CREATE ANSWER`,"sdp:",b);const A={blob:b,contentType:this.mediaContentType};return this.configProvider.countryCode&&(A.clientLocation=this.configProvider.countryCode),this.reinvitelessContext.enabled&&(A.mediaDescriptions=this.getMediaDescriptions(v)),this.setBWSeed(A),f.markAndMeasure("start","createAnswerAsync"),A}async processAnswerAsync(g,m,f,S=!1){const v=g.blob;this.logger.unsafe.debug(f?`[${m}] PROCESS PRANSWER`:`[${m}] PROCESS ANSWER`,"sdp:",v);const C=f?"pranswer":"answer";if(f&&(!allowProvisionalAnswer(this.context,S)||"have-local-offer"!==this.peerConnection.signalingState))return void this.logger.safe.info(`[${m}] process [${C}] ignored`);const _=this.getTimerTracker(""+(f?"processProvisionalAnswerAsync":"processAnswerAsync"),{first:!0});_.mark("start");const E=this.sessionDescription.createRemoteAnswer(v);let T=invertModalities(E.getModalities());this.reinvitelessContext.enabled&&(T=removeChangedSendDirection(this.offeredModalities,T));const I=E.toRemote(T);f||(this.mediaContentType=g.contentType,-1===this.allowedMediaContentType.indexOf(this.mediaContentType)&&this.allowedMediaContentType.push(this.mediaContentType),isOnHold(T)||(await this.streamSendersManager.update(T,!0,m),_.markAndMeasure("start","streamSendersManagerUpdate"),hasSendDirectionality(this.offeredModalities.data)&&!T.data&&this.dataChannel?.disable()),this.setNegotiatedModalities(T),this.updateLocalMediaSources(),this.statsGatherer.sessionInfo.setBweType(E.getBweType()),this.diagnostics&&(this.diagnostics.bweType=E.getBweType())),this.callbacks.onTransportInitialized?.(),this.logger.unsafe.info(`[${m}] process [${C}] set remote description`,"negotiated:",T,"sdp:",I),_.mark("startSetRemoteDescription"),await this.peerConnection.setRemoteDescription({sdp:I,type:C}),_.markAndMeasure("startSetRemoteDescription","setRemoteDescription"),f||(await this.streamSendersManager.activate(m),_.markAndMeasure("setRemoteDescription","streamSendersManagerActivate"),this.applyReceiveCapabilities(),this.checkAudioCodecNegotiated(m),this.transceiverManager.syncTransceivers(T),_.markAndMeasure("start","processAnswerAsync"))}async completeNegotiationAsync(g){this.mediaManager.commit();const m=this.configuredModalities,f=this.forceMediaStreamUpdate&&!isOnHold(this.negotiatedModalities)||!areNegotiatedDirectionsAcceptable(m,this.negotiatingModalities,this.negotiatedModalities)||this.triggerRenegotiationFlag,S=!f;this.canTriggerRenegotiation=!0,this.logger.safe.info(`[${g}] negotiation completed isComplete: ${S} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),f&&this.triggerRenegotiation(!1,g);for(const g of this.getVideoDeviceManager().getLocalVideoRenderers())g.setStatsProvider(this.statsGatherer,this.mediaManager.getLocalTracksInfo());return this.negotiationCompletedPromise.resolve(),{isComplete:S,activeModalities:this.negotiatedModalities,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator}}async rejectNegotiationAsync(g,m,f=!1){let S;this.mediaManager.rollback(),this.logger.safe.warn(`[${m}] negotiation rejected isComplete: ${!f} error: ${stringifyObject(g)} configured: ${JSON.stringify(this.configuredModalities)} negotiating: ${JSON.stringify(this.negotiatingModalities)} offered: ${JSON.stringify(this.offeredModalities)} negotiated: ${JSON.stringify(this.negotiatedModalities)}`),this.qualityManager.clearPendingCapabilities();const v=this.getModalitiesForRollback(m);if(this.transceiverManager?.syncTransceivers(v),await this.assureStreamsAndDataChannel(v,m),"have-local-offer"===this.peerConnection?.signalingState){S={},this.logger.safe.info(`[${m}] rolling back local description`);try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRollback){S.type="LocalRN",this.logger.safe.info(`[${m}] rolling back using local renegotiation`);const g=[new Iv(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(g,!0),this.logger.safe.info(`[${m}] rolling back using local complete`)}else this.logger.safe.info(`[${m}] rolling back using rollback`),S.type="Rollback",await this.peerConnection.setLocalDescription({type:"rollback"})}catch(g){this.logger.safe.error(`[${m}] rollback error`,g),S.error=g}}else if("have-remote-offer"===this.peerConnection?.signalingState){S={};try{if(!this.isRollbackSupported||this.configProvider.config.webrtcHandleRemoteRollback){S.type="RemoteRN",this.logger.safe.info(`[${m}] applying answer for remote renegotiation`);const g=[new Iv(this.peerConnection,this.configProvider,this.logger)];await this.negotiationEmulator.renegotiate(g,!0,"remote")}else this.logger.safe.info(`[${m}] rolling back using rollback on remote description`),S.type="Rollback",await this.peerConnection.setRemoteDescription({type:"rollback"})}catch(g){this.logger.safe.error(`[${m}] rollback error`,g),S.error=g}}else this.peerConnection&&this.logger.safe.error(`[${m}] cannot rollback local description in currrent state: ${this.peerConnection.signalingState}`);return this.canTriggerRenegotiation=!0,this.negotiationCompletedPromise.reject("negotiation rejected"),f&&(this.logger.safe.info(`[${m}] retrying failed negotiation`),this.triggerRenegotiation(!1,m)),{isComplete:!f,activeModalities:v,offeredModalities:this.offeredModalities,attemptedModalities:this.negotiatingModalities,configuredModalities:this.configuredModalities,initiator:this.initiator,rollback:S}}async startMediaDescriptionsUpdateAsync(g){return this.reinvitelessAppliedModalities=await this.assureStreamsAndDataChannel(this.reinvitelessRequestedModalities,g),this.updateLocalMediaSources(),await this.streamSendersManager.activate(g),this.getMediaDescriptions(this.reinvitelessAppliedModalities)}async completeMediaDescriptionsUpdateAsync(g){this.logger.safe.info(`[${g}] complete media descriptions update`),this.setNegotiatedModalities(this.reinvitelessAppliedModalities);const m=this.reinvitelessAppliedModalities,f=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:m,requestedModalities:f}}async rejectMediaDescriptionsUpdateAsync(g,m=!1){this.logger.safe.info(`[${g}] reject media descriptions update`),m&&(this.logger.safe.info(`[${g}] trigger renegotiation after failed media descriptions update`),this.triggerRenegotiation(!1,g));const f=await this.streamSendersManager.update(this.negotiatedModalities,!0,g),S=this.reinvitelessRequestedModalities;return this.reinvitelessAppliedModalities={},this.reinvitelessRequestedModalities={},{appliedModalities:f,requestedModalities:S}}createRemoteRenderer(g){return this.remoteVideoManager.createRenderer(g,this.subscriptionManager,this.logger)}getStatsAsync(g){if(this.statsGatherer&&!this.statsGatherer.isDisposed){if(this.audioCodecManager){const g=this.audioCodecManager.getSessionEvents();this.statsGatherer.sessionInfo.setAudiocCodecEvents(g),this.diagnostics&&(this.diagnostics.audioCodecEvents=g)}this.statisticsReport=this.statisticsReport.then((()=>this.statsGatherer.getReport(g))).catch((g=>(this.logger.safe.error(`getting statistics should never fail: ${g.error}`),g.partialReport)))}return this.statisticsReport}getLastKnownStats(g){return this.statsGatherer.getReport(!1,g)}muteHold(g,m){this.logger.safe.info(`[${m}] set muteHold state ${g}`),this.isMuteHold=g;const f=[je.MODALITY.audio,je.MODALITY.video,je.MODALITY.sharing].filter((g=>hasSendDirectionality(this.negotiatedModalities[g])&&(g!==je.MODALITY.audio||!this.doAudioMute)));for(const S of f)this.setMute(modalityToMediaType(S),g,m)}async muteInputAsync(g){this.doAudioMute=!0,this.setMute("Audio",!0,g)}async unmuteInputAsync(g){this.doAudioMute=!1,this.setMute("Audio",!1,g)}muteOutputAsync(g){return this.audioRenderer.setMuted(!0,g)}unmuteOutputAsync(g){return this.audioRenderer.setMuted(!1,g)}sendDtmf(g){return this.dtmfSender.sendDtmf(this.peerConnection,g)}canSendDtmf(){return this.dtmfSender.canSendDtmf(this.peerConnection)}pauseNegotiations(g=generateCauseId()){const m=new Sr;return this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.setNegotiationPromise(m,g)})),m}getExtensionsManager(){return this.extensionsManager}onDeviceEvent(g){this.statsGatherer.onDeviceEvent(g)}deviceSelectionChanged(){this.peerConnection&&this.audioRenderer?.getStream()&&this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId())}async terminate(g,m,f=!0){this.logger.safe.info(`[${g}] terminate`),this.statsGatherer.setTerminated(),this.diagnostics?.terminate(),this.perfMonitorSubs.forEach((g=>g?.dispose())),this.performanceMonitor.dispose(),this.terminated=!0,this.canTriggerRenegotiation=!1,await(this.audioCodecManager.decoder?.storeApiRecording()),this.cleanUp(g);try{f&&await this.getStatsAsync(!1)}catch(m){this.logger.safe.error(`[${g}] Error while gathering stats ${stringifyObject(m)}`)}finally{this.statsGatherer.dispose()}}getIncomingRawAudioStream(){const g=this.audioRenderer.getStream();return this.rawIncomingAudioStreamManager.createIRawStreamClient(g)}getUnmixedAudioProvider(){return this.audioCodecManager.decoder?.getUnmixedAudioProvider()}configureSpatialAudio(g,m){this.audioCodecManager.configureSpatialAudio(g,m)||this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable","Bad","Audio",!0,m)}setParticipantSpatialAudioPositions(g,m){if(!this.configProvider.mediaConfig.spatialAudioEnabled||!this.audioCodecManager?.decoder)throw this.logger.safe.error(`[${m}] setParticipantSpatialAudioPositions is called while MUCH audio decoder is not created or not enabled`),"setParticipantSpatialAudioPositions not allowed";this.audioCodecManager.decoder?.setParticipantSpatialAudioPositions(g)}processNotification(g,m){this.performanceMonitor.processNotification(g,m)}cleanUp(g){this.negotiationQueue.dispose(),this.rawIncomingAudioStreamManager?.dispose(),this.remoteVideoManager.dispose(),this.dataChannel&&(this.dataChannel.dispose(),this.dataChannel=null),this.deviceManager.effectsManager.setAecRefStream(null),this.resetPeerConnection(g),this.subscriptionManagerSubs.forEach((g=>g.dispose())),this.subscriptionManager&&this.subscriptionManager.dispose(),this.dmSub.dispose(),this.callDeviceManagerSub?.dispose(),this.clearIceDisconnectedTimer(),this.extensionsManager&&this.extensionsManager.dispose(),this.callbacks.onTerminated&&this.callbacks.onTerminated(),this.negotiationCompletedPromise.reject("webRtcSession cleanup")}resetPeerConnection(g){this.logger.safe.info(`[${g}] reset peer connection`),this.contributingSources?.dispose(),this.activeSpeakerManager.dispose(),this.qualityManager?.dispose(),this.qualityManager=null,this.audioRenderer?.dispose(),this.dtmfSender?.dispose(),this.dtmfSender=null,this.streamSendersManager?.dispose(),this.streamSendersManager=null,this.transceiverManager=null,this.encStreamsManager.dispose(),this.receiveStreamCollection.clear(),this.transportStateProvider?.dispose(),this.transportStateProvider=null,this.audioCodecManager.dispose(),this.mediaManager.reset(),this.peerConnection?.close(),this.peerConnection=null,this.toBeCalledAfterConnected=[],this.negotiationEmulator.configure(null),this.peerConnectionPromise=null,this.resetCandidateGathering(g),this.canTriggerRenegotiation=!0,this.negotiatedModalities={}}resetNegotiationQueue(g){this.negotiationCompletedPromise.reject("promise expired"),this.setNegotiationPromise(new Sr,g)}setNegotiationPromise(g,m=generateCauseId()){this.terminated||(this.negotiationCompletedPromise=g,this.negotiationQueue.add(this.negotiationCompletedPromise,m))}setupExtensionsManager(){const g=new sy(this.logger.createChild("ExtMgr"));return g.addExtension("dominantSpeakerHistory",{logger:this.logger,callback:this.activeSpeakerManager.onDominantSpeakerHistoryChanged.bind(this.activeSpeakerManager)}),g.addExtension("videoStreamControl",{logger:this.logger,negotiationEmulator:this.negotiationEmulator,qualityManager:this.qualityManager,diagnostics:this.qmDiagnostics,configProvider:this.configProvider,statisticsGatherer:this.statsGatherer}),g.addExtension("bandwidthTelemetry",{statisticsGatherer:this.statsGatherer,diagnostics:this.diagnostics}),this.configProvider.config.setBWSeed&&g.addExtension("bandwidthCache",{logger:this.logger,configProvider:this.configProvider}),g}updateQualityLevels(g){if(!g)return;this.hwSilent!==g.audioHwSilent&&(this.hwSilent=g.audioHwSilent,this.callbacks.onAudioHwSilentChanged&&this.callbacks.onAudioHwSilentChanged(this.hwSilent)),this.ufdManager.signalEvent("NetworkRecvQuality",g.networkRecvLevel.quality,void 0,void 0,void 0,void 0,{recvQualityData:g.networkRecvLevel}),this.ufdManager.signalEvent("NetworkSendQuality",this.doAudioMute?"Good":g.networkSendLevel.quality,void 0,void 0,void 0,void 0,{sendQualityData:g.networkSendLevel});const m=!(!g.isSpeaking||!this.doAudioMute);this.ufdManager.signalEvent("DeviceSpeakWhileMuted",m?"Bad":"Good")}triggerRenegotiation(g,m=generateCauseId()){this.canTriggerRenegotiation?(this.canTriggerRenegotiation=!1,this.triggerRenegotiationFlag=!1,this.logger.safe.info(`[${m}] triggering renegotiation`),this.mediaManager.backup(),this.callbacks.onNegotiationRequired&&this.callbacks.onNegotiationRequired(m)):g&&(this.logger.safe.info(`[${m}] renegotiation postponed`),this.triggerRenegotiationFlag=!0)}throwIfModalitiesNotConfigured(g){if(!this.configuredModalities)throw new Error(g)}async handleCodecSwitchUnsupported(g){if(!this.offeredDescription.isCodecSwitchSupported())try{const g=(await this.capabiltityGatherer.getCapabilities(je.MEDIA_TYPE.audio)).codecs.map((g=>g.mimeType));this.offeredDescription.usePrimaryAudioCodecOnly(g)}catch(m){this.logger.safe.error(`[${g}] failed to set primary codec based on audio capability ${stringifyObject(m)}`)}}assurePeerConnectionAsync(g,m){return this.peerConnectionPromise??(this.peerConnectionPromise=this.getPeerConnectionPromise(g,m)),this.peerConnectionPromise}async getPeerConnectionPromise(g,m){if(!this.relayManagerProvider)throw new Error("relay manager provider is not set!");this.logger.safe.info(`[${g}] fetching relay details from RelayManager...`);const f={relayType:"turn",isRemoteClientLync:this.context.config.isRemoteClientLync};m.mark("startQueryRelaysAsync");const S=await this.relayManagerProvider.getRelayManager().queryRelaysAsync(f);if(m.markAndMeasure("startQueryRelaysAsync","queryRelaysAsync"),this.terminated)throw new Error("session already disposed");const v={optional:[]},C=createIceServers(S,this.configProvider.config),_=this.configureCrypto(v);this.configureCpuThreshold(v),this.logger.safe.info("create peer connection");const E="unified-plan",T=this.context.configProvider.mediaConfig.isTransportUnbundled?"balanced":"max-bundle";try{this.peerConnection=new Ws.window.RTCPeerConnection({iceServers:C,rtcpMuxPolicy:"require",iceTransportPolicy:this.iceTransportPolicy,iceCandidatePoolSize:this.configProvider.config.iceCandidatePoolSize,bundlePolicy:T,sdpSemantics:E,audioPortRange:this.configProvider.mediaConfig.audioPortRange,videoPortRange:this.configProvider.mediaConfig.videoPortRange,enableDtlsSrtp:1===_,encodedInsertableStreams:!!this.configProvider.config.useInsertableStreams},v)}catch(g){throw g.code===DOMException.INVALID_STATE_ERR&&this.ufdManager.signalEvent("NoNetwork","Bad"),g}const I=this.peerConnection;this.isRollbackSupported=1===_&&this.context.configProvider.userAgentConfig.isBrowserRollbackSupported,this.negotiationEmulator.configure(I),this.statsGatherer.initialize(I),this.statsGatherer.sessionInfo.setIceServers(C),this.statsGatherer.sessionInfo.setIceTransportPolicy(this.iceTransportPolicy),this.statsGatherer.sessionInfo.setSdpSemantics(E),this.statsGatherer.sessionInfo.setBundlePolicy(T),this.diagnostics&&(this.diagnostics.iceServers=C,this.diagnostics.iceTransportPolicy=this.iceTransportPolicy,this.diagnostics.sdpSemantics=E,this.diagnostics.bundlePolicy=T),await this.checkVideoCodecsSupport(),m.markAndMeasure("queryRelaysAsync","checkVideoCodecsSupport"),I.onnegotiationneeded=()=>{this.logger.safe.info(`onnegotiationneeded signalingState: ${I.signalingState}`)},I.onsignalingstatechange=()=>{const g=generateCauseId();this.statsGatherer.sessionInfo.setSignalingConnectionState(I.signalingState),this.diagnostics&&(this.diagnostics.signalingConnectionState=I.signalingState),this.logger.safe.info(`[${g}] onsignalingstatechange signalingState: ${I.signalingState}`),this.transportStateProvider&&this.transportStateProvider.subscribeForDtlsTransportState(),this.configProvider.config.reconnectOnPcClose&&!this.terminated&&"closed"===I.signalingState&&this.isTransportConnected()&&this.raiseError({type:je.MEDIA_ERROR.unexpectedClose,detail:"PeerConnection is closed"},g)},I.onicecandidateerror=g=>{const m=g,[f,S]=[m.address,m.port];if(this.logger.safe.warn(`On ICE candidate error ${m.url} | ${f}:${S}: code ${m.errorCode}: ${m.errorText}`),!this.isConnected()||this.iceCandidatesDeferred.isPending){const g={address:f,port:+S,url:m.url,errorCode:m.errorCode,errorText:m.errorText};this.statsGatherer.addIceCandidateError(g),this.diagnostics?.addIceCandidateError(g)}};const onAddTrack=g=>{const{track:m,receiver:f,transceiver:S}=g,v=g.streams[0]??new MediaStream([m]);if(!(this.configProvider.config.addAudioStreamBeforeConnection&&je.TRACK_KIND.audio===m.kind)&&!this.isConnected())return this.logger.safe.info("ontrack handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onAddTrack(g)));this.logger.safe.info(`ontrack track ${m.id}, stream: ${v?.id}, transceiver=${S?.mid}`);let C=v?.active;if(!C&&this.configProvider.config.useInactiveAudioTrack&&"audio"===m.kind&&(this.logger.safe.warn("ontrack override forcing to use inactive audio stream"),C=!0),!C||"stopped"===S?.currentDirection||S?.stopped)return void this.logger.safe.info("ontrack ignore non active stream");let _=this.mediaManager.getMediaEntityByRemoteStreamId(v.id);if(_||(this.logger.safe.info(`cannot find media entity with stream id ${v.id} trying to fallback`),v.getAudioTracks()[0]&&(_=this.mediaManager.getMediaEntitiesByModality(je.MODALITY.audio)[0])),_){const g=this.createReceiveStream(v,f,m,_);_.setRemoteTrackId(m.id),this.addReceiveStreamTransforms(f,_.getModality()),this.receiveStreamCollection.add(g)}else this.logger.safe.error(`could not find media entity for an added stream: ${v.id}`)};I.onaddstream=g=>{this.logger.safe.info(`onaddstream stream: ${g.stream.id}`)},I.ontrack=onAddTrack;const onRemoveStream=g=>{if(!this.isConnected())return this.logger.safe.info("onremovestream handling postponed till PC is connected"),void this.toBeCalledAfterConnected.push((()=>onRemoveStream(g)));this.logger.safe.info(`onremovestream stream: ${g.stream.id}`),this.receiveStreamCollection.remove(g.stream.id)};I.onremovestream=onRemoveStream,I.onicecandidate=m=>{const f=m.candidate;if(f){const m=parseCandidateString(f.candidate);if(this.logger.safe.info(`[${g}] onicecandidate candidate: component:${m.component} protocol:${m.protocol} prio:${m.priority} type:${m.type} port:${m.port}`),this.logger.unsafe.info(`[${g}] candidate details: ${f.candidate}`),"1"!==m.component)return;if(this.iceCandidateReceived=!0,this.statsGatherer.sessionInfo.setCandidateDetails(m),this.diagnostics?.setCandidateDetails(m),!this.relayCandidateGathered&&f.candidate.indexOf("typ relay")>-1){const g={priority:f.priority?.toString()||m.priority,time:Date.now()-this.iceRelayCandidatesGatherStartTime};this.statsGatherer.sessionInfo.setRelayCandidateInfo(g),this.diagnostics&&(this.diagnostics.relayCandidateInfo=g),this.relayCandidateGathered=!0}}else this.logger.safe.info(`[${g}] onicecandidate candidate: null`);if(!this.iceCandidatesDeferred.isPending)return;const S=!this.initiator||!this.context.config.webrtcIceGatheringTimeoutIncreased,v=this.iceHostCandidateOnly||0===C.length;if(!f&&S||v){f&&this.logger.safe.info(`[${g}] Not waiting for ICE candidates, hoping that host/prflx is enough`),this.logger.safe.info(`[${g}] Is connected:`,this.isConnected(),I.iceConnectionState,I.signalingState);let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled&&f){m=this.sessionDescription.createLocalOffer(I.localDescription.sdp).hasUnbundledIceCandidates()}m&&this.completeCandidateGathering(g)}else if(this.relayCandidateGathered){let m=!0;if(this.context.configProvider.mediaConfig.isTransportUnbundled){m=this.sessionDescription.createLocalOffer(I.localDescription.sdp).hasUnbundledRelayIceCandidates()}m&&(this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),this.completeCandidateGathering(g))}},I.onicegatheringstatechange=()=>{this.logger.safe.info(`onicegatheringstatechange iceGatheringState: ${I.iceGatheringState}`)};const handleTransportState=f=>{if(this.terminated)return;const S=this.wasConnected?generateCauseId():g,v=this.lastTransportConnectionState;if(this.lastTransportConnectionState=f,this.statsGatherer.sessionInfo.setIceConnectionState(f),this.diagnostics&&(this.diagnostics.iceConnectionState=f),"connecting"===f&&m.mark("transportConnecting"),"connected"===f||"completed"===f)m.markAndMeasure("transportConnecting","transportConnected"),this.onTransportConnected(S);else if("failed"===f||"closed"===f&&"failed"!==v){if(this.iceCandidatesDeferred.isPending)return this.logger.safe.info(`[${S}] ice failed while gathering candidates, suppressing error`),void this.completeCandidateGathering(S);this.raiseError({type:je.MEDIA_ERROR.iceConnectionError,detail:"ice transport failed"},S),this.configProvider.config.webrtcCloseAfterIceFailure&&I.close(),this.callbacks.onTransportFailed?.()}"disconnected"===f?(this.callbacks.onTransportDisconnected?.(g),this.startIceDisconnectedTimer(S)):this.clearIceDisconnectedTimer()};this.transportStateProvider=new cE(I,_,this.logger,this.configProvider,(g=>handleTransportState(g))),this.transceiverManager=new v_(this.logger,this.peerConnection,this.mediaManager,this.context,this.reinvitelessContext),this.streamSendersManager.registerRtpSenderManager(this.transceiverManager),allowDataChannel(this.context)&&!this.dataChannel&&(this.dataChannel=new ys(this.peerConnection,this.statsGatherer,this.logger,this.configProvider),this.callback.onDataChannelUpdated(this.dataChannel)),this.multiParty&&(this.contributingSources=new kC(this.logger.createChild("ContributingSources"),this.configProvider,this.activeSpeakerManager,new LC(this.logger.createChild("ContributingSourcesProvider"),I))),m.mark("startInitialize"),await this.encStreamsManager.initialize(),m.markAndMeasure("startInitialize","encStreamsManagerInitialize");const b=this.encStreamsManager.isWorkerLoaded();this.initAudioCodec(b),this.statsGatherer.sessionInfo.setEncodedStreamWorkerLoaded(b),this.diagnostics&&(this.diagnostics.encodedStreamWorker=b)}configureCrypto(g){let m=!1;const f=preferSdesSrtp(this.context);if(this.offeredDescription){const g=this.offeredDescription.getSrtpInfo();this.statsGatherer.sessionInfo.setOfferedSrtpInfo(g),this.diagnostics&&(this.diagnostics.offeredSrtp=g),m=!g.dtls||g.sdes&&f}else m=f;m&&(this.logger.safe.info("configuring peer connection to use sdes"),g.optional.push({DtlsSrtpKeyAgreement:!1}));const S={dtls:!m,sdes:!!m};return this.statsGatherer.sessionInfo.setNegotiatedSrtpInfo(S),this.diagnostics&&(this.diagnostics.negotiatedSrtp=S),m?0:1}configureCpuThreshold(g){this.configProvider.config.webrtcNativeCpuOveruseDisabled&&this.multiParty&&g.optional.push({googCpuOveruseDetection:!1})}completeCandidateGathering(g){this.iceCandidatesDeferred.isPending&&(this.logger.safe.info(`[${g}] ICE candidates gathered completely`),this.iceCandidatesDeferred.resolve())}onTransportConnected(g){if(this.logger.safe.info(`[${g}] audio transport connected`),this.statsGatherer.clearIceCandidateErrors(),this.diagnostics?.clearIceCandidateErrors(),!this.terminated)for(this.wasConnected=!0,this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval&&"have-remote-pranswer"===this.peerConnection.signalingState?this.handleEarlyMediaAudioState(g):this.callbacks.onAudioStateChanged?.(je.STREAMING_STATE.active,g),this.callbacks.onTransportConnected?.(g);this.toBeCalledAfterConnected.length;)this.toBeCalledAfterConnected.shift()()}handleEarlyMediaAudioState(g){const m=this.peerConnection.getReceivers().filter((g=>"audio"===g.track.kind))[0];if(!m)return this.logger.safe.warn(`[${g}] Connected transport with provisional answer with no audio receiver`),void this.callbacks.onAudioStateChanged?.(je.STREAMING_STATE.active,g);this.callbacks.onAudioStateChanged?.(je.STREAMING_STATE.started,g);const f=setInterval((async()=>{try{let S;this.logger.safe.debug(`[${g}] Polling audio receiver stats to detect early media start`);const v=await m.getStats();this.diagnostics?.registerEarlyMediaPoll();for(const g of v.values())if("inbound-rtp"===g.type){S=g;break}(this.terminated||!S||S.bytesReceived>0||"have-remote-pranswer"!==this.peerConnection.signalingState)&&(this.logger.safe.debug(`[${g}] Finished polling early media audio stats ${!this.terminated}`),this.terminated||this.callbacks.onAudioStateChanged?.(je.STREAMING_STATE.active,g),clearInterval(f))}catch(m){const S=stringifyObject(m);this.logger.safe.error(`[${g}] Error polling stats for pranswer: ${S}`),this.diagnostics?.addStatsError("WebrtcSession::earlyMediaPolling",S),this.callbacks.onAudioStateChanged?.(je.STREAMING_STATE.active,g),clearInterval(f)}}),this.configProvider.config.webrtcPranswerWaitForMediaPollingInterval)}startIceDisconnectedTimer(g){this.configProvider.config.iceDisconnectedTimeoutMs&&(this.iceDisconnectedTimer=setTimeout((()=>{this.logger.safe.error(`[${g}] ice disconnected for ${this.configProvider.config.iceDisconnectedTimeoutMs}ms. Raise ${je.MEDIA_ERROR.iceConnectionError}`),this.raiseError({type:je.MEDIA_ERROR.iceConnectionError,detail:"ice transport disconnected"},g)}),this.configProvider.config.iceDisconnectedTimeoutMs))}clearIceDisconnectedTimer(){this.iceDisconnectedTimer&&(clearTimeout(this.iceDisconnectedTimer),this.iceDisconnectedTimer=null)}raiseError(g,m=generateCauseId()){this.logger.safe.error(`[${m}] Media error occurred type: ${g.type} detail: ${g.detail}`),this.callbacks.onSessionErrorOccurred&&this.callbacks.onSessionErrorOccurred(g,m)}resetCandidateGathering(g){this.logger.safe.info(`[${g}] reset candidate gathering`),this.iceCandidatesDeferred.promise.then((()=>{}),(()=>{})),this.iceCandidatesDeferred.reject(new Error("reset candidate gathering")),this.iceCandidatesDeferred=new Sr,this.iceCandidateReceived=!1}checkIceCandidates(g){const m=this.hasIceCandidates(g);if(m===this.noIceCandidates&&(this.noIceCandidates=!this.noIceCandidates,this.ufdManager.signalEvent("NoNetwork",this.noIceCandidates?"Bad":"Good"),this.noIceCandidates))throw{type:je.MEDIA_ERROR.noNetworkError,detail:"no ice candidates"};if(m){const m=this.hasRelayIceCandidates(g);if(m===this.noRelayIceCandidates){if(!m&&this.isIceConnected())return;this.noRelayIceCandidates=!this.noRelayIceCandidates,this.ufdManager.signalEvent("NetworkRelaysNotReachable",this.noRelayIceCandidates?"Bad":"Good")}}}hasIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledIceCandidates():g.hasIceCandidates()}hasRelayIceCandidates(g){return this.configProvider.mediaConfig.isTransportUnbundled?g.hasUnbundledRelayIceCandidates():g.hasRelayIceCandidates()}doRetargetIfNeeded(g,m,f){const S=m.isIceRestart();this.logger.safe.info(`[${f}] ICE restart: ${S}`),this.context.configProvider.mediaConfig.isTransportUnbundled&&this.offeredDescription&&this.offeredDescription.isMSRTC()&&S&&!this.multiParty&&m.getSrtpInfo().sdes&&(g.newOffer=!0)}notifyStreamsChanged(){this.logger.safe.info(`Scheduling stream changed notification: ${this.streamsChangedNotificationScheduled}`),this.streamsChangedNotificationScheduled||this.negotiationCompletedPromise.promise.catch((()=>{})).then((()=>{this.streamsChangedNotificationScheduled=!1,this.streamsChangedListener&&this.streamsChangedListener()}))}async streamAdded(g){if(je.MODALITY.audio===g.getModality()&&(this.webrtcAudioRecvStream=g.getMediaStream(),await this.audioRenderer.setOutputDevice(this.deviceManager.getOutputDeviceId()),await this.updateAudioRendererStream(this.webrtcAudioRecvStream)),this.configProvider.config.mapSsrcToTrackForStats){const m=this.mediaManager.getMediaEntityByRemoteStreamId(g.getMediaStream().id);this.statsGatherer.setSsrcTrackPair(m.getRemoteSsrc(),m.getRemoteTrackId())}this.notifyStreamsChanged()}async updateAudioRendererStream(g){await this.audioRenderer.play(g),await this.deviceManager.effectsManager.setAecRefStream(g),this.rawIncomingAudioStreamManager.streamChanged(g)}streamRemoved(g){if(je.MODALITY.audio===g.getModality())this.audioRenderer.getStream()===g.getMediaStream()&&(this.audioRenderer.stop(),this.rawIncomingAudioStreamManager.streamChanged(null)),this.deviceManager.effectsManager.setAecRefStream(null),this.webrtcAudioRecvStream=null;else if(je.MODALITY.video===g.getModality()){const m=this.mediaManager.getMediaEntityByRemoteStreamId(g.getMediaStream().id);m?.getLocalRecvCapabilities()?.resetToInitial()}this.clearReceiveStreamTransforms(g.getReceiver()),g.dispose(),this.notifyStreamsChanged()}setNegotiatedModalities(g){console.log(`setNegotiatedModalities ${g}`),this.negotiatedModalities=g,this.statsGatherer.sessionInfo.setNegotiatedModalities(g),this.diagnostics&&(this.diagnostics.negotiatedModalities=g)}setupIceGatheringTimeout(g){this.iceRelayCandidatesGatherStartTime=Date.now();const m=this.context.config.webrtcIceGatheringTimeoutIncreased?this.configProvider.config.relayWaitSaneTimeoutMs:this.configProvider.config.webrtcIceGatheringTimeoutMs;if(!m)return;this.iceCandidatesTimer>0&&clearTimeout(this.iceCandidatesTimer);const f=this.iceCandidatesDeferred;this.iceCandidatesTimer=setTimeout((()=>{this.iceCandidatesTimer=0,f.isPending&&(this.logger.safe.warn(`[${g}] ICE candidates gathering terminated due to timeout ${m}`),f.resolve())}),m)}isConnected(){return this.isTransportConnected()&&"closed"!==this.peerConnection.signalingState}isFailed(){return this.peerConnection&&("failed"===this.lastTransportConnectionState||"closed"===this.lastTransportConnectionState)}hasRelayCandidates(){return this.relayCandidateGathered}isIceConnected(){return"connected"===this.peerConnection?.iceConnectionState||"completed"===this.peerConnection?.iceConnectionState}isTransportConnected(){return this.peerConnection&&("connected"===this.lastTransportConnectionState||"completed"===this.lastTransportConnectionState)}createReceiveStream(g,m,f,S){const v=this.configProvider.config.addFmtpToInitialSubscription?S.getLocalRecvCapabilities():null,C=this.configProvider.config.useMultiviewLimitsOnInitialRequest&&S.getModality()!==je.MODALITY.sharing?()=>this.remoteVideoManager.getMaxAllowedVideoFS():null,_=new i_(g,m,S.getModality(),+S.getXSourceStreamId(),this,v,C);return new dE(_,f,this.receiveStreamCollection,this.logger.createChild("RecvStream"),this.configProvider.config)}async requestSource(g,m,f,S){if(!this.multiParty)return;if((this.isMuteHold||this.negotiatedModalities[g]===je.MEDIA_STATE.inactive)&&f!==Sv.SourceNone)return await delay2(10),this.requestSource(g,m,f,S);if(this.negotiationCompletedPromise.isPending)try{await this.negotiationCompletedPromise.promise}catch{this.logger.safe.error("source request should be sent even if negotiation rejected")}if(!this.isConnected()){this.logger.safe.info("requestSource is postponed till transport is connected");const g=defer4();this.toBeCalledAfterConnected.push((()=>g.resolve())),await g.promise}const v=this.mediaManager.getMediaEntityByXSourceStreamId(m);return this.extensionsManager.getExtension("videoStreamControl").sendSourceRequest(m,f,v?.getMid(),S)}async assureStreamsAndDataChannel(g,m,f){this.logger.safe.info(`[${m}] assureStreamsAndDataChannel `,this.negotiatedModalities,"offered",this.offeredModalities," mod ",g),this.dataChannel&&this.dataChannel.updateDataModalityState(g.data),f?.mark("startConfigureHold");const S=await this.configureHold(this.negotiatedModalities,g,m);if(f?.markAndMeasure("startConfigureHold","configureHold"),S)return this.logger.safe.info(`[${m}] Hold is configured. Not updating streams`),g;const v=await this.streamSendersManager.update(g,!1,m,f?.clone("updateStreams"));return f?.markAndMeasure("configureHold","updateStreams"),this.dataChannel&&g.data&&(v.data=g.data),v}async configureHold(g,m,f){const S=isOnHold(g),v=isOnHold(m);return S!==v&&await this.streamSendersManager.setHold(v,f),v}getStreamTransformConfiguration(){return{unifiedPlanEnabled:!0,addPrefixForMsid:this.configProvider.config.addPrefixForMsidInSdp}}applyReceiveCapabilities(){const g=this.mediaManager.getMediaEntities().map((g=>g.getRemoteRecvCapabilities()));this.multiParty?this.qualityManager.setPendingCapabilities():this.qualityManager.setMaxCapabilities(g)}async onReceiveCapabilitiesChanged(g,m,f){if(!this.streamSendersManager)return!1;try{return await this.streamSendersManager.applyCapabilities(m,g,f),!0}catch(g){return!1}}onOptimalVideoCountChanged(g,m){this.callback.onOptimalVideoReceiversCountChanged&&this.callback.onOptimalVideoReceiversCountChanged(g),this.diagnostics.addOvcSubscriptionReport(g,this.subscriptionManager?.getSubscriptionsCount(),m)}async onSendBandwidthChanged(g){if(!this.isConnected())return;const m=this.extensionsManager.getExtension("videoStreamControl"),f=this.mediaManager.getMediaEntities().filter((g=>[je.MODALITY.video,je.MODALITY.sharing].indexOf(g.getModality())>-1)).filter((g=>g.isEnabled())).map((g=>g.getMid()));0!==f.length&&(await m.sendBandwidthInfo(f,g),this.statsGatherer.setReportedSendBandwidth(g),this.diagnostics&&(this.diagnostics.reportedSendBandwidth=g))}onMaxVideoSendCapabilitiesChanged(g,m){if("Video"===g&&this.configProvider.config.maxSendVideoCapabilitiesReportingForVideoEnabled||"ScreenShare"===g&&this.configProvider.config.maxSendVideoCapabilitiesReportingForSharingEnabled)return this.isConnected()?void this.notifyMaxVideoCapabilitiesChanged(g,m):(this.logger.safe.info("sendMaxVideoSendCapabilities is postponed till transport is connected"),void this.toBeCalledAfterConnected.push((()=>this.notifyMaxVideoCapabilitiesChanged(g,m))))}notifyMaxVideoCapabilitiesChanged(g,m){const f=this.extensionsManager.getExtension("videoStreamControl"),S=mediaTypeToModality(g),v=this.mediaManager.getMediaEntitiesByModality(S)[0];if(!v)return;const C=v.getMid();f.sendMaxVideoSendCapabilities([C],m)}createAudioRenderer(){this.audioRenderer=new kp(this.logger.createChild("AudioRenderer"),this.configProvider),this.context.maContext.domOverrides.onMediaElementAdded&&this.audioRenderer.on("onAudioElementAdded",this.context.maContext.domOverrides.onMediaElementAdded),this.context.maContext.domOverrides.onMediaElementRemoved&&this.audioRenderer.on("onAudioElementRemoved",this.context.maContext.domOverrides.onMediaElementRemoved),this.audioRenderer.on("onAudioPlaybackError",((g,m,f)=>this.onAudioPlaybackError(g,m,f)))}onAudioPlaybackError(g,m,f){const S={type:m,detail:f,isAudio:!0};this.deviceManager.raiseTelemetryEvent("reconnect_on_audio_playback_error",{error:g,mediaError:m,message:f}),this.context.reconnectRetry&&this.configProvider.config.audioRendererFailedRetryCodes?.includes(g)&&(this.logger.warn(`Reconnect required, attempt No: ${this.context.reconnectRetry}`),this.context.reconnectRetry--,this.raiseError(S))}getModalitiesForRollback(g){const m=removeChangedSendDirection(this.negotiatedModalities,this.negotiatingModalities);return this.logger.safe.debug(`[${g}] configured modalities for rollback: ${JSON.stringify(m)}`),m}fixLocalDescription(g){this.configProvider.config.insertFakeCandidateIfNeeded&&(this.iceCandidateReceived||!this.iceCandidateReceived&&this.isIceConnected())&&g.insertFakeCandidateIfNeeded(this.statsGatherer.sessionInfo,this.diagnostics),g.fixDataModality()}getSessionConfig(){return this.configProvider}getLocalMediaTrackId(g){const m=this.mediaManager.getLocalTracksInfo(),f=mediaTypeToModality(g),S=m.find((g=>g.modality===f));return S?S.trackId:null}addReceiveStreamTransforms(g,m){const f=this.encStreamsManager.initTransformsCollection(g,"Receiver",modalityToMediaType(m));f&&m!==je.MODALITY.audio&&this.configProvider.config.useInsertableStreams?.videoStreamAnalyzer&&f.addTransform(new g_(this.logger.createChild(`RecvStreamAnalyzer [${m}/${g.track.id}]`)))}clearReceiveStreamTransforms(g){this.encStreamsManager.clearTransformsCollection(g)}async checkVideoCodecsSupport(){try{const g=await this.capabiltityGatherer.getCapabilities("video");this.statsGatherer.setH264AvailableProfiles(g);const m=await qs.isCodecsSupported(this.configProvider.config.hevcCodecs);this.diagnostics&&(this.diagnostics.videoCapabilities=g,this.diagnostics.isCodecsSupported=m);const f=new Set(g?.codecs?.map((g=>g.mimeType.toLocaleLowerCase()))||[]);for(const g of this.configProvider.config.requiredVideoCodecs)if(!f.has(g)){this.ufdManager.signalEvent("NoRequiredVideoCodecs","Bad","Video");break}}catch(g){this.logger.safe.error(`failed to get video capability ${stringifyObject(g)}`)}}getMediaDescriptions(g){if(isOnHold(g))return{};const m=[];for(const f of this.mediaManager.getMediaEntities()){if(!f.getExtension("reinviteless"))continue;const S=g[f.getModality()],v={mid:f.getMid(),direction:!f.getLocalTrackId()&&hasSendDirectionality(S)?removeSendDirectionality(S):S};m.push(v)}return{descriptions:m}}updateSendStreamsReinviteless(g){if(isEmpty(this.negotiatedModalities)||isOnHold(this.negotiatedModalities)||isOnHold(this.configuredModalities))return!1;this.reinvitelessRequestedModalities=shallowClone(this.negotiatedModalities);for(const[g,m]of Object.entries(this.configuredModalities)){const f=this.mediaManager.getMediaEntitiesByModality(g)[0];f?.getExtension("reinviteless")&&(this.reinvitelessRequestedModalities[g]=m)}return!deepEqual(this.reinvitelessRequestedModalities,this.negotiatedModalities)&&(this.callbacks?.onUpdateMediaDescriptionsRequired?.(g),deepEqual(this.reinvitelessRequestedModalities,this.configuredModalities))}setBWSeed(g){if(!this.configProvider.config.setBWSeed)return;const m=this.extensionsManager.getExtension("bandwidthCache").getBWSeed();g.applyChannelParameters={multiChannelParameter:{mids:this.configProvider.config.bwSeedOptions.mids,mediaParameter:JSON.stringify({sendSideBWSeed:{seedValueBitsPerSec:m}})}},this.diagnostics.sentBWSeed=m}getSubscriptionManager(){return this.subscriptionManager}initAudioCodec(g){this.audioCodecManager.init(g);const m=this.audioCodecManager.decoder;m&&(m.on("usedDecoderChanged",(g=>{this.updateAudioRendererStream(g?m.stream:this.webrtcAudioRecvStream),this.statsGatherer.setAudioDecoderStatsProvider(g?m.getStatsProvider():void 0)})),this.audioCodecManager.on("negotiationNeeded",(g=>this.triggerRenegotiation(!0,g))))}configureAudioCodec(){this.audioCodecManager.prepareForNegotiation(this.initiator)}checkAudioCodecNegotiated(g){const m=this.audioCodecManager.negotiationCompleted();if(this.configProvider.mediaConfig.spatialAudioEnabled){const f=m?"Good":"Bad";this.ufdManager.signalEvent("SpatialAudioMUCHUnavailable",f,"Audio",!0,g)}}onIncomingVideoQualityChanged(g,m){1===g&&this.remoteVideoResolutionManager.limitResolutionOnPoorPerformance(m)}getVideoDeviceManager(){return this.context.callDeviceManager.getDeviceManager("Video")}setupCallDeviceManagerSubs(){this.callDeviceManagerSub=this.context.callDeviceManager.on("onSelectedVirtualDevicesChanged",(()=>{this.logger.info("VirtualDevice changed, disposing onLocalRendererStarted sub"),this.dmSub.dispose(),this.logger.info("New onLocalRendererStarted created"),this.dmSub=this.getVideoDeviceManager().on("onLocalRendererStarted",(g=>g.setStatsProvider(this.statsGatherer,this.mediaManager.getLocalTracksInfo())))}))}updateLocalMediaSources(){this.mediaManager.updateMediaEntitiesWithLocalTracks(),this.configProvider.config.mapSsrcToTrackForStats&&this.statsGatherer.updateStatsWithLocalSsrcTrackInfo();const g=this.streamSendersManager.getLocalMediaSources();this.qualityManager.updateRegisteredSources(g)}},YE={build:(g,m,f)=>new JE(g,m,f)},QE=class{constructor(g,m,f,S,v,C,_,E){this.logger=g,this.context=m,this.configProvider=f,this.diagnostics=S,this.ufdManager=v,this.deviceManager=C,this.capabilities=_,this.midCallTelemetry=E,this.activeSessions=[],this.pendingDeviceTelemetryEvents=[],this.pendingVideoEffectsTelemetryEvents=[],this.pendingAudioEffectsTelemetryEvents=[],this.callsCount=0,this.mediaConfig={},this.configProvider.on("configUpdated",(()=>this.configApplied())),this.deviceManager.on("onDeviceTelemetryEvent",(g=>this.onDeviceTelemetryEvent(g))),this.deviceManager.on("onVideoEffectsTelemetryEvent",(g=>this.onVideoEffectsTelemetryEvent(g))),this.deviceManager.on("onAudioEffectsTelemetryEvent",(g=>this.onAudioEffectsTelemetryEvent(g)))}createSession(g,m,f,S){this.configProvider.setMediaConfiguration(this.mediaConfig);const v=this.configProvider.getConfigView(f?.isConference),C=this.logger,_=this.diagnostics.newSession(v,m,this.logger.createChild("sessionDiagnostics")),E={getLogger:()=>C,getUfdManager:()=>this.ufdManager,maContext:this.context,config:f??{},configProvider:v,diagnostics:_.newNativeSessionDiag(),reconnectRetry:v.config.audioRendererFailedReconnectTimes,callDeviceManager:S},T=(v.mediaConfig.simulcastSessionEnabled?YE:l_).build(E,m,g),I=new gv(v,++this.callsCount,_);I.setMediaQosEnabled(!!this.mediaConfig.enableMediaQoS),I.setPortRangeConfigured(!!this.mediaConfig.mediaPortRanges);const b=new ov(T,m,E,g,I,this.configProvider,_);for(b.on("onTerminated",(g=>this.onSessionTerminated(g))),this.activeSessions.push(b),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector=KS.getInstance(this.logger.createChild("WebRtcInternals"),v),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length);this.pendingDeviceTelemetryEvents.length>0;)b.registerDeviceTelemetryEvent(this.pendingDeviceTelemetryEvents.pop());for(;this.pendingVideoEffectsTelemetryEvents.length>0;)b.registerVideoEffectsTelemetryEvent(this.pendingVideoEffectsTelemetryEvents.pop());for(;this.pendingAudioEffectsTelemetryEvents.length>0;)b.registerAudioEffectsTelemetryEvent(this.pendingAudioEffectsTelemetryEvents.pop());return b}getDeviceManager(){return this.deviceManager}getCapabilities(){return this.capabilities}getScreenSharingManager(){return new QS(this.deviceManager)}updateConfig(g,m,f,S){this.configProvider.updateConfig(g,m,f,S)}getConfig(){return this.configProvider.config}getConfigProvider(){return this.configProvider}setMediaConfig(g){(0,qS.merge)(this.mediaConfig,g),this.diagnostics.mediaConfig=this.mediaConfig}getMediaLogs(){return this.webRtcInternalsCollector?this.webRtcInternalsCollector.collect():Promise.resolve("")}dispose(g){return Promise.all([this.deviceManager.dispose(),this.capabilities.dispose(),...this.activeSessions.map((async m=>{await m.terminate(g,{}).catch((()=>{})),m.dispose()}))]).then((()=>{}),(()=>{}))}handleSendMidCallTelemetry(g){this.midCallTelemetry?.on("sendMidCallTelemetry",g)}configApplied(){window&&(this.configProvider.config.enableDevtoolsAPI?window.webMA||this.injectDevtoolsAPI():window.webMA&&delete window.webMA)}injectDevtoolsAPI(){const g={config:{addOverride:(g,m)=>this.configProvider.setConsoleOverride(g,m),setOverrides:g=>this.configProvider.setConsoleOverrides(g),clearOverride:g=>this.configProvider.clearConsoleOverride(g),clearAllOverrides:()=>this.configProvider.clearAllConsoleOverrides(),setConstraints:g=>this.configProvider.setCallConstraints(g),setRelayConfigOverride:g=>this.context.getRelayManager().setRelayOverride(g)},diagnosticsReport:this.diagnostics.reportGenerator,deviceManager:{setAudioProcessingFlags:g=>this.deviceManager.setAudioProcessingFlags(g)}};window.webMA=g}onDeviceTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerDeviceTelemetryEvent(g))):this.pendingDeviceTelemetryEvents.push(g)}onVideoEffectsTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerVideoEffectsTelemetryEvent(g))):this.pendingVideoEffectsTelemetryEvents.push(g)}onAudioEffectsTelemetryEvent(g){this.activeSessions.length>0?this.activeSessions.forEach((m=>m.registerAudioEffectsTelemetryEvent(g))):this.pendingAudioEffectsTelemetryEvents.push(g)}onSessionTerminated(g){remove2(this.activeSessions,(m=>m===g)),this.configProvider.updateSessionCount(this.activeSessions.length),this.webRtcInternalsCollector.updateSessionCount(this.activeSessions.length),0===this.activeSessions.length&&this.ufdManager.reset()}},XE=class{static build(g,m,f,S,v,C,_,E){return new QE(g,m,f,S,v,C,_,E)}};XE.constants=je,XE.helper=js;var ZE=class{constructor(g,m,f){g.logger??(g.logger=new Ia),g.domOverrides??(g.domOverrides={}),this.config=g;const S=g.mediaSettings;this.logger=new WS(g.safeLogger?.createChild("MA",S.debug),g.logger.createChild("MA",S.debug)),this.configProvider=new Dp(this.logger.createChild("configProvider"),f,S);const v=new Zm(this.configProvider);this.mediaAgentDiagnostics=new jS(this.configProvider,v),this.ufdManager=new Pa(this.logger.createChild("UFD"),this.configProvider),this.deviceManager=new Xm(this.logger.createChild("DeviceManager"),this.configProvider,v,g.domOverrides,this.ufdManager,g.webcvProvider,g.wasmdnsProvider,g.wasmaecProvider,g.wasmVqeProvider,g.createWasmWorkerCbs),this.capabilities=new ba(this.configProvider),jp.initialize(this.configProvider),m.on("OnECSChanged",(()=>{const g=m.getEcsConfig("SkypeWebMedia","mediaAgent");g?this.configProvider.updateConfig(g,m.ETag,m.getEcsConfig("ConfigIDs","SkypeWebMedia"),m.getEcsConfig("Headers","CountryCode")):this.logger.warn("No SkypeWebMedia.mediaAgent config.")}))}getDeviceManager(){return this.deviceManager}async buildAgent(g,m,f){if(!qs.hasMediaApi())throw[new eT(`${g} not supported by media agent provider`,"not_supported")];if(this.config?.detectH264Support&&!await qs.hasH264CodecSupport(this.config.logger))throw[new eT("H264 is not supported","not_supported")];const S=await buildEncodedStreamWorkerProvider(this.config.createWasmWorkerCbs,this.config.encodedStreamsWorkerProvider),v={getRelayManager:()=>m,getWebCVProvider:()=>this.config.webcvProvider,getWasmDnsProvider:()=>this.config.wasmdnsProvider,getWasmAecProvider:()=>this.config.wasmaecProvider,getWasmVqeProvider:()=>this.config.wasmVqeProvider,getEncodedStreamsWorkerProvider:()=>S,domOverrides:this.config.domOverrides,configProvider:this.configProvider};v.getRelayManager().initialize(this.configProvider);const C=XE.build(this.logger,v,this.configProvider,this.mediaAgentDiagnostics,this.ufdManager,this.deviceManager,this.capabilities,f);return C.constants=XE.constants,C}},eT=class extends Error{constructor(g,m="failure"){super(g),this.reason=m}};async function buildEncodedStreamWorkerProvider(g,m){if(g?.createEncodedStreamsWorker)return{getWorker:()=>g.createEncodedStreamsWorker()};if(m){const g=await m.getWorkerUrl();return{getWorker:()=>new Worker(g)}}return null}var tT=class{constructor(){this.supportedPlatforms=new Map([["Chrome","59.0"],["EdgeAnaheim","79.0"],["Safari","13.1"],["Electron","3.0"],["Firefox","96.0"],["WebView2","1.0"]]),this.experimentalPlatforms=new Map}getPlatformSupportLevel(g){const m=getBrowserInfo(),f=this.supportedPlatforms.get(m.name);if(g&&f&&isVersionGreaterOrEqual(m.version,f))return 1;if(g&&!f){if("Chromium"===m.engine||"ChromiumAVD"===m.engine)return 2;const g=this.experimentalPlatforms.get(m.name);if(g&&isVersionGreaterOrEqual(m.version,g))return 2}return 0}},iT=class extends Ve{constructor(g){super(),this.ecsFilters=g,this.config=null}get ETag(){return this.etag}async setEcsConfig(g){this.config=JSON.parse(g.ecsBlob),this.etag=g.etag,this.event("OnECSChanged").raise()}async setUserEcsServerUrl(g,m){throw new Error("Not implemented")}async getUserEcsServerUrl(g){throw new Error("Not implemented")}async setActiveUserForEcs(g){throw new Error("Not implemented")}async getEcsQueryParameters(){const g={};g.CLRelease=getTsCallingVersion();const m="_TS_BUILC_VERSION_".replace("C","D"),f=this.ecsFilters?.["UserInfo.Ring"]?.value,S=this.getTeamsExperience();g.CLRelease===m&&(g.CLRelease="9999.99"),f&&(g.audienceGroup=f,g.teamsRing=f),S&&(g.Experience=S);const v=getBrowserInfo();return g.BrowserName=v.name,g.BrowserEngine=v.engine,g.BrowserVersion=v.version,g.FormFactor=v.formFactor,qs.hardwareConcurrency&&(g.CPUCount=qs.hardwareConcurrency),JSON.stringify(g)}async ecsGetUserQueryParameters(g){return this.getEcsQueryParameters()}async shouldTriggerCQF(g,m,f){throw new Error("Not implemented")}getEcsConfig(g,m){const f=this.config&&this.config[g];return m?f&&f[m]:f}createEcsConfiguration(){return new class{constructor(g){this.provider=g}getBoolean(g,m){return this.provider.getEcsConfig(g,m)}getNumber(g,m){return this.provider.getEcsConfig(g,m)}getString(g,m){const f=this.provider.getEcsConfig(g,m);return JSON.stringify(f)}}(this)}getTeamsExperience(){return!0===this.ecsFilters?.isTeams2?.value?"teams2":!1===this.ecsFilters?.isTeams2?.value?"teams1":void 0}},nT=class{constructor(g){this._sharingSource=g}getId(){return this._sharingSource.getId()}getDeviceId(){return this._sharingSource.getDeviceId()}getType(){return this.mapSharingSourceType(this._sharingSource.getType())}getPreview(g,m,f){return Promise.reject("not implemented")}getPreviewAsync(g,m){return this._sharingSource.getPreviewAsync(g,m)}getDescription(){return this._sharingSource.getDescription()}getIcon(g,m){return this._sharingSource.getIcon(g,m)}getBounds(){}mapSharingSourceType(g){switch(g){case 1:return 1;case 2:return 2;case 3:return 3;default:throw new Error("Invalid sharing source type")}}},rT=class extends Ve{constructor(g){super(),this._screenSharingManager=g,this._screenSharingManager.onScreensChanged((()=>{this.event("screensChanged").raise()}))}enumerateScreensAsync(){return this._screenSharingManager.enumerateScreensAsync().then((g=>g.map((g=>new nT(g)))))}enumerateWindowsAsync(){return this._screenSharingManager.enumerateWindowsAsync().then((g=>g.map((g=>new nT(g)))))}enumerateCamerasAsync(){return this._screenSharingManager.enumerateCamerasAsync().then((g=>g.map((g=>new nT(g)))))}},sT=P,updateSignalingAgentConfig=(g,m)=>{if(!m)return g;const f={...g};if(m.ngIncoming&&m.ngOutgoing){const S=convertScreenSharingFlag(m.ngIncoming.isVBSSEnabled,m.ngOutgoing.isVBSSEnabled);f.cloudScreenSharingFlag=getParam(S,g.cloudScreenSharingFlag)}return m.ngOutgoing&&(f.emergencyCallCountry=convertEmergencyCallCountryFlag(m.ngOutgoing.isEmergencyCallingEnabled,g.emergencyCallCountry),f.isGVCOutgoingEnabled=getParam(m.ngOutgoing.isGVCEnabled,g.isGVCOutgoingEnabled),f.brokerEnabledOutgoing=getParam(m.ngOutgoing.isBrokerEnabled,g.brokerEnabledOutgoing)),m.ngIncoming&&(f.isGVCJoiningEnabled=getParam(m.ngIncoming.isGVCEnabled,g.isGVCJoiningEnabled),f.brokerEnabledIncoming=getParam(m.ngIncoming.isBrokerEnabled,g.brokerEnabledIncoming)),f.conversationServiceUrl=getUrl(m.conversationServiceUrl,g.conversationServiceUrl),f.uploadLogRequestUrl=getUrl(m.uploadLogRequestUrl,g.uploadLogRequestUrl),f.isConversationServiceUrlFromEcs=!!m.conversationServiceUrl,f.isUploadLogRequestUrlFromEcs=!!m.uploadLogRequestUrl,f.callingTokenLogicalUrl=getUrl(m.callingTokenLogicalUrl,g.callingTokenLogicalUrl),f.doHostlessCalling=getParam(m.allowHostlessCalls,g.doHostlessCalling),f.supportsCompressedServicePayload=getParam(m.supportCompressedTrouterPayload,g.supportsCompressedServicePayload),f.brokerRequestBatching=getParam(m.allowBrokerSubscribeBatching,g.brokerRequestBatching),f.brokerExclusively=getParam(m.brokerExclusively,g.brokerExclusively),f.handleMediaOfferFromPushNotification=getParam(m.handleMediaOfferFromPushNotification,g.handleMediaOfferFromPushNotification),f.handleNewOfferRequest=getParam(m.handleNewOfferRequest,g.handleNewOfferRequest),f.sendProgressFromCC=getParam(m.sendProgressFromCC,g.sendProgressFromCC),f.handleUnmuteMuteFromResponse=getParam(m.handleUnmuteMuteFromResponse,g.handleUnmuteMuteFromResponse),f.useInternalHttpDispatcher=getParam(m.webInternalHttpDispatcher,g.useInternalHttpDispatcher),(m.webInternalHttpDispatcherConfigNetworkRequest||g.requestTypeHttpDispatcherConfigMap)&&(m.webInternalHttpDispatcherConfigNetworkRequest=m.webInternalHttpDispatcherConfigNetworkRequest||{},g.requestTypeHttpDispatcherConfigMap=g.requestTypeHttpDispatcherConfigMap||{},f.requestTypeHttpDispatcherConfigMap={...g.requestTypeHttpDispatcherConfigMap,...m.webInternalHttpDispatcherConfigNetworkRequest}),(m.operationTypeHttpDispatcherConfigMap||g.operationTypeHttpDispatcherConfigMap)&&(m.operationTypeHttpDispatcherConfigMap=m.operationTypeHttpDispatcherConfigMap||{},g.operationTypeHttpDispatcherConfigMap=g.operationTypeHttpDispatcherConfigMap||{},f.operationTypeHttpDispatcherConfigMap={...g.operationTypeHttpDispatcherConfigMap,...m.operationTypeHttpDispatcherConfigMap}),(m.csaTimeoutConfiguration||g.csaTimeoutConfiguration)&&(m.csaTimeoutConfiguration=m.csaTimeoutConfiguration||{},g.csaTimeoutConfiguration=g.csaTimeoutConfiguration||{},f.csaTimeoutConfiguration={...g.csaTimeoutConfiguration,...m.csaTimeoutConfiguration}),f.autoJoinOnConflict=getParam(m.autoJoinOnConflict,g.autoJoinOnConflict),f.enableQuickSendAcceptanceAck=getParam(m.enableQuickSendAcceptanceAck,g.enableQuickSendAcceptanceAck),f.supportMediaRetargetWhileIncomingRenegotiation=getParam(m.supportMediaRetargetWhileIncomingRenegotiation,g.supportMediaRetargetWhileIncomingRenegotiation),f.enableCallEstablishmentTimeoutsForStartJoinCall=getParam(m.enableCallEstablishmentTimeoutsForStartJoinCall,g.enableCallEstablishmentTimeoutsForStartJoinCall),f.callingServiceSupportsCAETokens=getParam(m.callingServiceSupportsCAETokens,g.callingServiceSupportsCAETokens),f.callingServiceSupportsAADTokens=getParam(m.callingServiceSupportsAADTokens,g.callingServiceSupportsAADTokens),f.aadTokenExpirationTimeInSeconds=getParam(m.aadTokenExpirationTimeInSeconds,g.aadTokenExpirationTimeInSeconds),f.caeTokenExpirationTimeInSeconds=getParam(m.caeTokenExpirationTimeInSeconds,g.caeTokenExpirationTimeInSeconds),f.disableTokenMigrationHeader=getParam(m.disableTokenMigrationHeader,g.disableTokenMigrationHeader),f.enablePublishTokenTelemetry=getParam(m.enablePublishTokenTelemetry,g.enablePublishTokenTelemetry),f.refreshTimeBeforeTokenTimeoutInSeconds=getParam(m.refreshTimeBeforeTokenTimeoutInSeconds,g.refreshTimeBeforeTokenTimeoutInSeconds),f.forceClearExpiredTokens=getParam(m.forceClearExpiredTokens,g.forceClearExpiredTokens),f.enableRefreshToken=getParam(m.enableRefreshToken,g.enableRefreshToken),f.enableAsyncDisablePreheat=getParam(m.enableAsyncDisablePreheat,g.enableAsyncDisablePreheat),f.forceLowercaseHttpHeaders=getParam(m.forceLowercaseHttpHeaders,g.forceLowercaseHttpHeaders),f.enableResolveScreenSharingWhenNegotiationComplete=getParam(m.enableResolveScreenSharingWhenNegotiationComplete,g.enableResolveScreenSharingWhenNegotiationComplete),f.maxReinvitelessMediaForVideoForWeb=getParam(m.maxReinvitelessMediaForVideoForWeb,g.maxReinvitelessMediaForVideoForWeb),f.maxReinvitelessMediaForVBSSForWeb=getParam(m.maxReinvitelessMediaForVBSSForWeb,g.maxReinvitelessMediaForVBSSForWeb),f.enableRefreshTokenRetry=getParam(m.enableRefreshTokenRetry,g.enableRefreshTokenRetry),f.enableRefreshTokenRetryInSeconds=getParam(m.enableRefreshTokenRetryInSeconds,g.enableRefreshTokenRetryInSeconds),f.enableConversationTypeUpdateOnCallEnd=getParam(m.enableConversationTypeUpdateOnCallEnd,g.enableConversationTypeUpdateOnCallEnd),f.supportMissingTokenTypesInResponse=getParam(m.supportMissingTokenTypesInResponse,g.supportMissingTokenTypesInResponse),f.useSkypeTokenWhenNoAuthenticateHeader=getParam(m.useSkypeTokenWhenNoAuthenticateHeader,g.useSkypeTokenWhenNoAuthenticateHeader),f.enableAutoPromotion=getParam(m.enableAutoPromotion,g.enableAutoPromotion),f.enableTokenCache=getParam(m.enableTokenCache,g.enableTokenCache),f.enableBatchedSendMessageStatus=getParam(m.enableBatchedSendMessageStatus,g.enableBatchedSendMessageStatus),f.enableBatchedReceiveMessage=getParam(m.enableBatchedReceiveMessage,g.enableBatchedReceiveMessage),f.enableTokenCacheForGenericTokenAPI=getParam(m.enableTokenCacheForGenericTokenAPI,g.enableTokenCacheForGenericTokenAPI),f};function getParam(g,m){return null==g?m:g}function getUrl(g,m){return g||m}function convertScreenSharingFlag(g,m){return m&&g?"enabled":g?"recvOnly":!1===g&&!1===m?"disabled":void 0}function convertEmergencyCallCountryFlag(g,m){return!1===g?"":m}var aT,oT,lT="SkypeCalling",cT=class{constructor(g,m,f,S){this.signalingAgentConfig=g,this.ecsProvider=m,this.logger=f,this.telemetryLogger=S,this.ecsProvider.on("OnECSChanged",(()=>this.onEcsUpdate())),this.signalingAgentConfig.clientInformation+=`/TsCallingVersion=${getTsCallingVersion()}/Ovb=${getOvb()}`,this.signalingAgentConfig.piiScrubber={omit:sT.pii.Omit,mri:sT.pii.Mri},this.signalingAgent=new Bn(this.getSignalingAgentConfig())}getSignalingAgent(){return this.signalingAgent}onEcsUpdate(){const g=this.ecsProvider.getEcsConfig(lT);this.logger.info(`onEcsUpdate, ecsTag=${this.ecsProvider.ETag||""}, ecsConfig=${JSON.stringify(g)}`),this.signalingAgentConfig=updateSignalingAgentConfig(this.signalingAgentConfig,g),this.signalingAgentConfig.ecsEtag=this.ecsProvider.ETag,this.signalingAgent.updateSignalingAgentConfig(this.getSignalingAgentConfig())}getSignalingAgentConfig(){return this.signalingAgentConfig.oneDsTelemetryLogger=this.telemetryLogger,this.signalingAgentConfig}},dT={build:(g,m,f,S)=>new cT(g,m,f,S)};function isValidPersistenceLevel(g){return isNumber3(g)&&g>=1&&g<=2}(oT=aT||(aT={}))[oT.LocalStorage=1]="LocalStorage",oT[oT.SessionStorage=2]="SessionStorage",oT[oT.IndexedDb=3]="IndexedDb";var hT="readwrite",uT="result",gT="DBError: Unable to open database",pT="Database is not open",mT="DBError: Failed to Open Cursor",fT="DBError: Failed to delete the database",ST="DBError: Database does not exist",vT="DBError: Database upgrade required",yT="DBError: Feature not supported",CT=["indexedDB"],_T=isFunction2,ET=isString2;function _getDbFactory(){var g=getGlobal()||{},m=null;if(g)try{for(var f=0;f<CT.length;f++)if((m=g[CT[f]])&&_T(m.open))return m}catch(g){m=null}return m||null}function _debugLog(g,m){getGlobalInst("QUnit")&&console&&console.log("IndexedDbHelper ["+g+"] "+m)}function _warnLog(g,m,f){g&&g.warnToConsole("IndexedDbHelper ["+m+"] "+f)}function _eventReject(g,m,f,S){return function(v){f(new Error(m)),_debugLog(g,"["+S+"] event rejected")}}var TT=[];function _getDbContext(g,m){for(var f=null,S=0;S<TT.length;S++)if((f=TT[S]).name===g)return f;return f={name:g,sch:new Vh("IndexedDbHelper["+g+"]",m),dbHdl:[],add:function(m){f.dbHdl.push(m),_debugLog(g,"- dbOpened (add) -- hdls ["+f.dbHdl.length+"]")},remove:function(m){for(var S=f.dbHdl,v=0;v<S.length;v++)if(S[v]===m){S.splice(v,1);break}_debugLog(g,"- dbClosed (remove) -- hdls ["+f.dbHdl.length+"]")},isOpen:function(){return f.dbHdl.length>0},openHdl:function(){return f.dbHdl.length>0?f.dbHdl[0]:null}},TT.push(f),f}var IT=function(){function IndexedDbHelper2(g){dynamicProto(IndexedDbHelper2,this,(function(m){var f=_getDbFactory()||null;function _createStoreContext(m,f){var S=m.db.transaction(f,hT);return S.onabort=function(){_warnLog(g,m.dbName,"txn.onabort")},S.onerror=function(){_warnLog(g,m.dbName,"txn.onerror")},S.oncomplete=function(){_debugLog(m.dbName,"txn.oncomplete")},{db:m,store:S.objectStore(f),tx:S,tbl:f,openCursor:function(g,S){return _openCursor(m,f,g,S)},newTransaction:function(g){return _openStore(m,f,g)}}}function _openStore(g,m,f){if(!g||!g.db)return Dh.reject(new Error(pT));try{var S=f(_createStoreContext(g,m));return S instanceof Dh?S:Dh.resolve(S)}catch(g){return Dh.reject(g)}}function _openCursor(g,m,f,S){if(!g||!g.db)return Dh.reject(new Error(pT));var v=null;return f&&ET(f)?v=new bT(f):f&&f.isMatch&&(v=f),new Dh((function(f,C){var _=[],E=null,T=null;v&&v.keyRange&&(T=v.keyRange());var I=_createStoreContext(g,m);(E=T?I.store.openCursor(T):I.store.openCursor()).onerror=_eventReject(I.db.dbName,mT,C,"openCursor"),E.onsuccess=function(g){var m=g.target[uT];if(m){var E={store:I,cursor:m,continue:function(){m.continue()},done:function(){f(_)}},T=m.value;if(!v||v.isMatch(T))if(S)try{switch(S(E,T,_)){case 2:f(_);break;case 1:break;default:E.continue()}}catch(g){C(g)}else _.push(T),E.continue();else E.continue()}else f(_)}}))}function _scheduleEvent(g,m,f,S){return _getDbContext(g).sch.scheduleEvent(f,m,S)}m.isAvailable=function(){return!!f},m.openDb=function(m,S,v,C){return _scheduleEvent(m,"openDb",(function(_){return new Dh((function(E,T){var I=!1;function _createDbCtx(g,f,v,C,_){var E={db:f,dbName:m,dbVersion:S,ctx:null,isNew:C,txn:v?v.transaction:null};return _||(E.openStore=function(g,m){return _openStore(E,g,m)},E.openCursor=function(g,m,f){return _openCursor(E,g,m,f)}),E}function _databaseUpgrade(g,m){var f=_createDbCtx(null,g,m,!0,!0);if(C)I=!0,C(f).then((function(){f.txn||(f.txn=m.transaction)}),(function(g){try{m.transaction&&m.transaction.abort()}finally{T(g)}}));else try{m.transaction&&m.transaction.abort()}finally{T(new Error(vT))}}function _databaseOpen(f,S){var C=_getDbContext(m);C.add(f),f.onabort=function(S){_warnLog(g,m,"onabort -- closing the Db"),C.remove(f)},f.onerror=function(S){_warnLog(g,m,"onerror -- closing the Db"),C.remove(f)},f.onclose=function(S){_warnLog(g,m,"onclose -- closing the Db"),C.remove(f)},f.onversionchange=function(S){_warnLog(g,m,"onversionchange -- force closing the Db"),f.close(),C.remove(f)};var _=null,b=null;C.dbHdl.length>0&&(b=C.dbHdl[0]),_=_createDbCtx(C,b,S,I);try{v(_).then((function(g){E(g)}),T)}catch(g){T(g)}}var b=_getDbContext(m);if(null==f)T(new Error("No available storage factory"));else if(b.isOpen()){var A=_createDbCtx(b,b.openHdl(),null,!1);v(A).then(E,T)}else{var P=f.open(m,S);P.onblocked=function(f){_warnLog(g,m,"Db Open Blocked event ["+_+"] - "+(P.error||"")),T(new Error(gT))},P.onerror=function(f){_warnLog(g,m,"Db Open Error event ["+_+"] - "+(P.error||"")),T(new Error(gT))},P.onupgradeneeded=function(g){_debugLog(m,"Db Open Create/Upgrade needed event ["+_+"]");try{var f=g.target[uT];if(!f)return void T(new Error(gT));_databaseUpgrade(f,P)}catch(g){_eventReject(m,gT,T,_)(g)}},P.onsuccess=function(g){var m=g.target[uT];m?_databaseOpen(m,P):T(new Error(gT))}}}))}))},m.closeDb=function(g){_scheduleEvent(g,"closeDb",(function(m){var f=_getDbContext(g),S=f.dbHdl,v=S.length;if(v>0){for(var C=0;C<v;C++)S[C].close();f.dbHdl=[]}return Dh.resolve(1)}))},m.deleteDb=function(m){return null==f?Dh.resolve(!1):_scheduleEvent(m,"deleteDb",(function(S){var v=_getDbContext(m),C=v.dbHdl,_=C.length;if(_>0){_warnLog(g,m,"Db is open ["+_+"] force closing");for(var E=0;E<_;E++)C[E].close();v.dbHdl=[]}return new Dh((function(v,C){setTimeout((function(){try{_debugLog(m,"["+S+"] starting");var _=f.deleteDatabase(m);_.onerror=function(f){_warnLog(g,m,"["+S+"] error!!"),C(new Error(fT))},_.onblocked=function(f){_warnLog(g,m,"["+S+"] blocked!!"),C(new Error(fT))},_.onupgradeneeded=function(f){_warnLog(g,m,"["+S+"] upgrade needed!!"),C(new Error(fT))},_.onsuccess=function(g){_debugLog(m,"["+S+"] complete"),v(!0)},_debugLog(m,"["+S+"] started")}catch(f){_warnLog(g,m,"["+S+"] threw - "+f),C(new Error(fT+" - "+f))}}),0)}))}))},m.getDbDetails=function(g){return _scheduleEvent(g,"getDbDetails",(function(m){return null!=f&&f.databases?new Dh((function(m,S){f.databases().then((function(f){for(var v=0;v<f.length;v++)if(f[v].name===g)return void m(f[v]);S(new Error(ST))}),S)})):Dh.reject(new Error(yT))}),2e3)}}))}return IndexedDbHelper2.__ieDyn=1,IndexedDbHelper2}(),bT=function(){function SimpleQuery2(g){var m=[],f=null;dynamicProto(SimpleQuery2,this,(function(S){S.keyRange=function(){return f},S.parseQuery=function(g){if(m=[],g)for(var v=g.split(";"),C=0;C<v.length;C++){var _=v[C],E=_.indexOf("=");if(-1!==E){var T=_.substring(0,E),I=_.substring(E+1);0===T.indexOf("#")&&(T=T.substring(1),f||(f=IDBKeyRange.bound(I,I+"￿"))),S.startsWith(T,I)}}},S.startsWith=function(g,f){m.push({name:g,value:f,type:0})},S.contains=function(g,f){m.push({name:g,value:f,type:1})},S.isMatch=function(g){if(!m||0===m.length)return!0;if(!g)return!1;for(var f=0;f<m.length;f++){var S=m[f],v=g[S.name];if(v)if(0===S.type){if(0!==v.indexOf(S.value))return!1}else if(1===S.type&&-1===v.indexOf(S.value))return!1}return!0},g&&S.parseQuery(g)}))}return SimpleQuery2.__ieDyn=1,SimpleQuery2}(),AT=10,PT=1,RT=6e5,wT=1008e4,MT="Unknown",DT=-1,OT="DBError: Unable to add event",NT="DBError: Unable to update iKey",kT="AppInsightEvents.1",LT=1,FT="Evts",xT="iKey",UT=isValidPersistenceLevel;function _getTime2(){return(new Date).getTime()}function _eventReject2(g,m){return function(f){return m(new Error(g))}}function _createDb(g){g.objectStoreNames.contains(FT)||g.createObjectStore(FT,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1});g.objectStoreNames.contains(xT)||g.createObjectStore(xT,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})}function _updateiKey(g){return g.openStore(xT,(function(m){return new Dh((function(f,S){var v={iKey:g.ctx.iKey,tm:_getTime2()},C=m.store.put(v);C.onsuccess=function(g){f(C.result.toString())},C.onerror=function(g){S(new Error(OT))},C.onerror=_eventReject2(NT,S)}))}))}function _orderEventsByPriority(g){for(var m=[],f=2;f>=1;f--)for(var S=0;S<g.length;S++){var v=g[S];v&&v.evt.persistence===f&&m.push(v.evt)}return m}function _addEventByTime(g,m){for(var f=0;f<g.length;f++)if(m.tm<g[f].tm)return void g.splice(f,0,m);g.push(m)}function _getKeyIndex(g,m){for(var f=m.length,S=0;S<f;S++)if(g===m[S].id)return S;return-1}function _isOldItem(g,m){var f=g.tm;return _getTime2()-f>m}function _cursorContinueEvent(g){return function(m){return g.continue()}}function _cursorDeleteAndContinue(g){var m=g.cursor.delete();return m.onerror=_cursorContinueEvent(g),m.onsuccess=_cursorContinueEvent(g),1}function _getAllEventsForiKey(g,m){return g.openCursor(FT,m,(function(g,m,f){return f.push(m),0}))}function _deleteEvents(g,m,f){return g.openCursor(FT,m,(function(g,m,S){return f(m)?(S.push(m),_cursorDeleteAndContinue(g)):0}))}function _deleteOrphanedEvents(g){return new Dh((function(m,f){var S=!1;g.openCursor(xT,null,(function(g,m,f){var v=m.tm;return _getTime2()-v<wT?0:(S=!0,2)})).then((function(){if(S){var v={};_deleteEvents(g,null,(function(g){if(!g||!g.evt||!g.evt.iKey)return!0;var m=g.tm;return _getTime2()-m>wT||(v[g.evt.iKey]=1,!1)})).then((function(){var S=[];g.openCursor(xT,null,(function(g,m,f){var C=m.tm;return _getTime2()-C<wT||v[m.iKey]?0:(S.push(m),_cursorDeleteAndContinue(g))})).then((function(){m(S)}),f)}),f)}else m([])}),f)}))}function _moveOldEventsToCurrentStore(g){return g.openCursor(FT,"#key="+g.ctx.iKeyPrefix(),(function(m,f){var S=f.key;if(0===S.indexOf(g.ctx.iKeyPrefix())&&-1===S.indexOf(g.ctx.evtKeyPrefix())&&_isOldItem(f,RT)){f.key=g.ctx.evtKeyPrefix()+f.id;var v=m.store.store.put(f);return v.onerror=_cursorContinueEvent(m),v.onsuccess=function(g){try{_cursorDeleteAndContinue(m)}catch(g){m.continue()}},1}return 0}))}function _checkVersionAndMoveEventsToCurrentStorage(g){return new Dh((function(m,f){_deleteOrphanedEvents(g).then((function(){_moveOldEventsToCurrentStore(g).then(m,m)}),f)}))}function _dropEventsUpToPersistence(g,m){return new Dh((function(f,S){var v=0,C=g.ctx.evtKeyPrefix();function _resolveWithDroppedEvents(){f(v)}function _dropEvent(g,m){return new Dh((function(f){var S=g.store.delete(m.key);S.onsuccess=function(g){v++,f()},S.onerror=function(g){f()}}))}function _processCandidates(m){0!==m.length?g.openStore(FT,(function(g){for(var f=[],S=0;S<m.length;S++)f.push(_dropEvent(g,m[S]));return Dh.all(f).then(_resolveWithDroppedEvents,_resolveWithDroppedEvents)})):_resolveWithDroppedEvents()}g.openCursor(FT,"#key="+C,(function(g,f,S){return f.evt.persistence<=m&&0===f.key.indexOf(C)&&(_addEventByTime(S,f),S.length>AT&&S.splice(S.length-1,1)),0})).then(_processCandidates,(function(){f(0)}))}))}var VT=function(){function IndexedDbProvider2(g){dynamicProto(IndexedDbProvider2,this,(function(m){var f=null,S=null,v=MT,C=null,_=null,E=null,T=DT,I=0;function _openDb(g){function _handleDbUpgrade(g){return new Dh((function(m,f){_createDb(g.db),m()}))}function _handleDbOpen(m){return new Dh((function(f,S){var T={iKey:v,storageId:C,iKeyPrefix:function(){return _},evtKeyPrefix:function(){return E}};m.ctx=T,_updateiKey(m).then((function(){g(m).then(f,S)}),S)}))}return f.openDb(S,LT,_handleDbOpen,_handleDbUpgrade)}function _addDbEvent(g,m,f){return new Dh((function(S,v){function dropEvents(m,f){_dropEventsUpToPersistence(g,m).then((function(g){g>0&&(I-=g),f(g)}),(function(g){f(0)}))}function resolveAddEvent(g){S(m.evt)}function _insertNewEvent(){g.openStore(FT,(function(C){var _=C.store.put(m);_.onsuccess=function(v){f&&_updateiKey(g).then(resolveAddEvent,resolveAddEvent),I++,S(m.evt)},_.onerror=function(C){function _retryAddEvent(f){0===f&&v(new Error(OT)),_addDbEvent(g,m,!1).then((function(g){S(m.evt)}),(function(){v(new Error(OT))}))}f?dropEvents(1,(function(g){g>0?_retryAddEvent(g):m.evt.persistence>=2?dropEvents(2,(function(g){_retryAddEvent(g)})):v(new Error(OT))})):v(new Error(OT))}}))}T>0&&I>=T?dropEvents(1,(function(g){0===g?m.evt.persistence>=2?dropEvents(2,(function(g){_insertNewEvent()})):v(new Error(OT)):_insertNewEvent()})):_insertNewEvent()}))}m.id=g,m.initialize=function(g){var I=g.itemCtx.diagLog();if(!(f=new IT(I)).isAvailable())return f=null,!1;var b=g.itemCtx.getCfg(),A=g.storageConfig||{};return S=A.indexedDbName||kT,v=b.instrumentationKey||v,C=m.id||g.id||newGuid2(),E=(_=v+"::")+C+"::",T=A.maxStorageItems>0?A.maxStorageItems:T,_openDb((function(g){return g.isNew?Dh.resolve(!0):_checkVersionAndMoveEventsToCurrentStorage(g)})).then((function(g){}),(function(g){I.warnToConsole("IndexedDbProvider failed to initialize - "+(g||"<unknown>")),f=null})),!0},m.supportsSyncRequests=function(){return!1},m.getAllEvents=function(){return null!=f&&f.isAvailable()?_openDb((function(g){return new Dh((function(m,f){_getAllEventsForiKey(g,"#key="+g.ctx.evtKeyPrefix()).then((function(g){I=g.length,m(_orderEventsByPriority(g))}),f)}))})):Dh.resolve([])},m.addEvent=function(g,m,S){return null!=f&&f.isAvailable()?(m.id=m.id||newGuid2(),UT(m.persistence)||(m.persistence=1),_openDb((function(f){var S=g||m.id,v={key:f.ctx.evtKeyPrefix()+S,id:S,evt:m,tm:_getTime2(),v:PT};return _addDbEvent(f,v,!0)}))):Dh.resolve(m)},m.removeEvents=function(g){if(null==f||!f.isAvailable())return Dh.resolve([]);var m=[];return new Dh((function(f,S){_openDb((function(f){return f.openCursor(FT,"#key="+f.ctx.iKey,(function(f,S,v){if(-1!==_getKeyIndex(S.id,g)){var C=f.cursor.delete();return C.onerror=_cursorContinueEvent(f),C.onsuccess=function(){m.push(S.evt),f.continue()},1}return 0}))})).then((function(g){I-=m.length,f(m)}),(function(g){I-=m.length,f(m)}))}))},m.clear=function(){return null!=f&&f.isAvailable()?new Dh((function(g,m){_openDb((function(g){return _deleteEvents(g,"#key="+g.ctx.evtKeyPrefix(),(function(m){return 0===m.key.indexOf(g.ctx.evtKeyPrefix())}))})).then((function(m){I=0,g(_orderEventsByPriority(m))}),m)})):Dh.resolve([])},m.teardown=function(){f&&f.closeDb(S)}}))}return IndexedDbProvider2.__ieDyn=1,IndexedDbProvider2}(),BT=10,HT="3",$T="Version",GT=6e5,jT="AWTEvents",WT=5e6;function _isQuotaExceeded(g,m){var f=!1;return m instanceof DOMException&&(22!==m.code&&"QuotaExceededError"!==m.name&&1014!==m.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==m.name||g&&0!==g.length&&(f=!0)),f}function _getAvailableStorage(g){var m=getGlobal()||{},f=null;try{if(f=m[g]){var S="__storage_test__";f.setItem(S,S),f.removeItem(S)}}catch(g){_isQuotaExceeded(f,g)||(f=null)}return f}function _forEachMap(g,m){if(g)for(var f=objKeys(g),S=0;S<f.length;S++){var v=f[S];if(!m(g[v],v))break}}function _isMapEmpty(g){var m=!0;return _forEachMap(g,(function(g,f){return g&&(m=!1),m})),m}function _dropEventsUpToPersistence2(g,m){for(var f=1,S=0,_loop_1=function(){var g=[],v=m[f];if(_forEachMap(v,(function(m,f){return g.push(f),++S<BT})),S>0){for(var C=0;C<g.length;C++)delete v[g[C]];return{value:!0}}f++};f<=g&&S<BT;){var v=_loop_1();if("object"==typeof v)return v.value}return S>0}var qT=isValidPersistenceLevel,zT=function(){function WebStorageProvider2(g,m){dynamicProto(WebStorageProvider2,this,(function(f){var S=null,v=jT,C=null,_=HT,E=null,T=null,I=WT,b=null,A=null;function _newStore(g,m){return{key:g,db:m}}function _fetchStoredDb(g,m){void 0===m&&(m=!0);var f=null;if(S){var v=S.getItem(g);if(v)try{f=JSON.parse(v)}catch(m){S.removeItem(g)}}return m&&!f&&(f={events:{1:{},2:{},3:{}},lastAccessTime:0}),_newStore(g,f)}function _updateStoredDb(g,m){void 0===m&&(m=!0);var f=!0,v=g.db;if(v){m&&(v.lastAccessTime=(new Date).getTime());for(var C=1;C<=2;C++)if(!_isMapEmpty(v.events[C])){f=!1;break}}try{if(f)S&&S.removeItem(g.key);else{var _=JSON.stringify(v);if(_.length>I)return!1;S&&S.setItem(g.key,_)}}catch(g){return!1}return!0}function _clearDatabase(g){var m=[],f=_fetchStoredDb(g,!1),v=f.db;if(v){var C=v.events;try{for(var _=1;_<=2;_++)_forEachMap(C[_],(function(g,f){return g&&m.push(g),!0}))}catch(g){}S&&S.removeItem(f.key)}return m}function _checkVersionAndMoveEventsToCurrentStorage2(){if(S){for(var g=S.getItem(b),m=[],f=_fetchStoredDb(A),C=!1,E=0;E<S.length;E++){var I=S.key(E);if(0===I.indexOf(v)&&I!==b){if(g!==HT){m.push(_newStore(I,null));continue}var P=_fetchStoredDb(I,!1),R=P.db;if(R){if((new Date).getTime()-R.lastAccessTime>GT){for(var w=1,_loop_3=function(){var g=R.events[w],m=f.db.events[w];_forEachMap(g,(function(f,S){return(getTenantId(f.iKey)||f.iKey)===T&&(m[S]=f,delete g[S]),!0})),w++};w<=2;)_loop_3();C=!0,m.push(P)}}else m.push(_newStore(I,null))}}for(E=0;E<m.length;E++)_updateStoredDb(m[E],!1);C&&_updateStoredDb(f),S.setItem(b,_)}}f.id=m,S=_getAvailableStorage(g)||null,f.initialize=function(g){if(!S)return!1;var m=g.storageConfig||{};return I=m.maxStorageSizeInBytes>0?m.maxStorageSizeInBytes:I,v=m.storageKey||jT,C=f.id||g.id||newGuid2(),A=v+"."+C,b=v+$T,E=g.itemCtx.getCfg().instrumentationKey,T=getTenantId(E)||E,_checkVersionAndMoveEventsToCurrentStorage2(),!0},f.supportsSyncRequests=function(){return!0},f.getAllEvents=function(){try{var g=[],m=_fetchStoredDb(A,!1).db;if(m)for(var f=m.events,S=2;S>=1;S--)_forEachMap(f[S],(function(m){m&&((getTenantId(m.iKey)||m.iKey)===T&&g.push(m));return!0}));return Dh.resolve(g)}catch(g){return Dh.reject(g)}},f.addEvent=function(g,m,f){try{var S=_fetchStoredDb(A);m.id=m.id||newGuid2(),qT(m.persistence)||(m.persistence=1);for(var v=m.persistence,C=m.id,_=S.db.events;;){if(_[v][C]=m,_updateStoredDb(S))return Dh.resolve(m);if(delete _[v][C],!_dropEventsUpToPersistence2(v,_))return Dh.reject(new Error("Unable to free up event space"))}}catch(g){return Dh.reject(g)}},f.removeEvents=function(g){try{var m=_fetchStoredDb(A,!1),f=m.db;if(f){var S=f.events;try{for(var v=0;v<g.length;++v){var C=g[v];delete S[C.persistence][C.id]}if(_updateStoredDb(m))return Dh.resolve(g)}catch(g){}g=_clearDatabase(m.key)}return Dh.resolve(g)}catch(g){return Dh.reject(g)}},f.clear=function(){try{var g=[],m=_fetchStoredDb(A,!1),f=m.db;if(f){for(var S=f.events,_loop_2=function(m){var f=S[m];_forEachMap(f,(function(m){m&&((getTenantId(m.iKey)||m.iKey)===T&&(delete f[m.id],g.push(m)));return!0}))},v=2;v>=1;v--)_loop_2(v);_updateStoredDb(m)}return Dh.resolve(g)}catch(g){return Dh.reject(g)}},f.teardown=function(){try{var g=_fetchStoredDb(A,!1),m=g.db;m&&(m.lastAccessTime=0,_updateStoredDb(g,!1))}catch(g){}}}))}return WebStorageProvider2.__ieDyn=1,WebStorageProvider2}(),KT="3.2.9",JT="LocalStorage",YT=5,QT=isValidPersistenceLevel,XT=function(g){function LocalStorageChannel2(){var m=g.call(this)||this;return m.identifier=JT,m.priority=1009,m.version=KT,dynamicProto(LocalStorageChannel2,m,(function(g,m){var f,S,v,C;function _initDefaults(){f=!1,S=!1,v=null,C=[]}function _queueStorageEvent(g,m){v||(v=new Vh("LocalStorage")),v.scheduleEvent((function(g){return m(g)}),g)}function _sendStoredEventsToNextPlugin(m){doPerf(g.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){_queueStorageEvent("sendToNext",(function(f){return m.provider.getAllEvents().then((function(f){for(var S=0;S<f.length;S++)try{var v=f[S];(getTenantId(v.iKey)||v.iKey)===m.tenantId&&g.processNext(v,m.coreRootCtx.createNew())}catch(g){}}))}))}),(function(){return{iKeyConfig:m}}))}function _removeEvents(m,f){doPerf(g.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){_queueStorageEvent("removeEvents",(function(g){var S=[];return arrForEach(f,(function(g){(getTenantId(g.iKey)||g.iKey)===m.tenantId&&S.push(g)})),S.length>0?m.provider.removeEvents(S).then((function(g){})).catch((function(g){})):Dh.resolve()}))}),(function(){return{iKeyConfig:m,events:f}}))}function _shouldCacheEvent(g,m){return!(m.sync||m.persistence<g.minPersistenceCacheLevel)}function _tryGetIndexedDbProvider(g){var m=new VT;return m.initialize(g)||(m=null),m}function _tryGetWebStorageProvider(g,m){var f=new zT(g);return f.initialize(m)||(f=null),f}function _initializeProvider(g){for(var m=g.storageConfig.providers,f=null,S=0;!f&&S<m.length&&S<YT;)switch(m[S++]){case aT.LocalStorage:f=_tryGetWebStorageProvider("localStorage",g);break;case aT.SessionStorage:f=_tryGetWebStorageProvider("sessionStorage",g);break;case aT.IndexedDb:f=_tryGetIndexedDbProvider(g)}return f}function _getCoreItemCtx(m,f,S,v){m&&(m.extensionConfig=m.extensionConfig||[]),!v&&f&&(v=f.getProcessTelContext().getNext());var C=null,_=g._getTelCtx().getNext();return _&&(C=_.getPlugin()),new Ud(v,m,f,C)}function _createIkeyConfig(m,f,S,v){var _=g.identifier,E=m.extensionConfig=m.extensionConfig||[],T=E[_]=E[_]||{};T.providers||(T.providers=[aT.LocalStorage,aT.IndexedDb]);var I=_getCoreItemCtx(m,f,S,v),b={itemCtx:I,storageConfig:T,id:g.id},A=_initializeProvider(b);if(A){var P={iKey:m.instrumentationKey,tenantId:getTenantId(m.instrumentationKey)||m.instrumentationKey,minPersistenceCacheLevel:1,coreRootCtx:I,providerContext:b,provider:A};QT(T.minPersistenceLevel||-1)&&(P.minPersistenceCacheLevel=T.minPersistenceLevel),C.push(P),f.addNotificationListener({eventsSent:function(g){_removeEvents(P,g)},eventsDiscarded:function(g,m){_removeEvents(P,g)}}),_sendStoredEventsToNextPlugin(P)}}_initDefaults(),g.initialize=function(g,S,C,_){doPerf(S,(function(){return"LocalStorageChannel.initialize"}),(function(){f||(m.initialize(g,S,C),m.setInitialized(!1),f=!0,v=new Vh("LocalStorage",S.logger)),_createIkeyConfig(g,S,C,_)}),(function(){return{coreConfig:g,core:S,extensions:C,pluginChain:_}}))},g.processTelemetry=function(m,v){var _=m;if(f&&!S){v=g._getTelCtx(v),setProcessTelemetryTimings(m,g.identifier);var E=null;arrForEach(C,(function(g){g.iKey===m.iKey&&(E=g)}));var T=E?E.provider:null;if(_.sync||!T)return void g.processNext(_,v);_.id=_.id||newGuid2(),isValidPersistenceLevel(_.persistence)||(_.persistence=1),_shouldCacheEvent(E,_)&&_queueStorageEvent("processTelemetry",(function(g){return T.addEvent(_.id,_,v)}))}g.processNext(_,v)},g.pause=function(){S=!0},g.resume=function(){doPerf(g.core,(function(){return"LocalStorageChannel:resume"}),(function(){S=!1,arrForEach(C,(function(g){g.provider&&_sendStoredEventsToNextPlugin(g)}))}))},g._doTeardown=function(g,m){arrForEach(C,(function(g){var m=g.provider;m&&m.teardown()})),_initDefaults()},g.flush=function(g,m){}})),m}return __extendsFn(LocalStorageChannel2,g),LocalStorageChannel2.__ieDyn=1,LocalStorageChannel2}($d),ZT=XT,eI=class{constructor(g,m,f,S,v,C,_){this.logger=g,this.configProvider=m,this.clientInfo=f,this.eventLatency=S,this.contextProvider=v,this.accountCollectorURL=C,this.envOverride=_,this.manager=new _p,this.managerConfig=this.createConfigForManager(),this.currentTransmitProfile=je.REPORTING_PROFILE.RT_PROFILE,this.initManager(),this.uiVersion=this.getUiVersion(),this.configProvider.on("configUpdated",(()=>this.updateChannelConfig()))}createLogger(g){return new tI(g,this.manager,this.logger,this.configProvider,this.uiVersion,this.eventLatency,this.contextProvider,this.envOverride)}createConfigForManager(){const g={extensionConfig:{LocalStorage:{storageKey:"TsCalling"}},propertyConfiguration:{populateBrowserInfo:!0,populateOperatingSystemInfo:!0},channelConfiguration:{eventsLimitInMem:this.configProvider.config.eventsLimitInMem},endpointUrl:this.accountCollectorURL,enableCompoundKey:this.configProvider.config.enableCompoundKey};if(this.configProvider.config.useLocalStorageForOneDs){const m=new ZT;g.channels=[[m]]}return g}getUiVersion(){const g=this.clientInfo.match(/^.*?\/(\d+\/)(.*?)\/.*$/);return g?g[1]+g[2]:this.clientInfo}updateChannelConfig(){this.configProvider.config.eventsLimitInMem!==this.managerConfig.channelConfiguration.eventsLimitInMem&&this.manager.getPostChannel().setEventQueueLimits(this.configProvider.config.eventsLimitInMem),this.setTransmitProfile()}initManager(){this.manager.create(this.managerConfig,[]);this.manager.getPostChannel()._notificationManager.addNotificationListener({eventsDiscarded:(g,m)=>this.logDiscardedEvents(g,m),eventsSent:g=>this.logSentEvents(g)}),this.setTransmitProfile()}logDiscardedEvents(g,m){let f="discarded events:";g.forEach((g=>f=`${f+g.name};`)),this.logger.info(`${f} reason:${m}`)}logSentEvents(g){let m=`sent events: ${g[0]?.data?.CorrelationId&&getFrom("value",g[0].data.CorrelationId)}:`;g.forEach((g=>{m=`${m+g.name};`})),this.logger.info(`${m}`)}setTransmitProfile(){this.configProvider.config.transmitProfileTimings.length&&this.manager.getPostChannel()._loadTransmitProfiles({[this.configProvider.config.transmitProfileName]:this.configProvider.config.transmitProfileTimings}),this.configProvider.config.transmitProfileName!==this.currentTransmitProfile&&this.manager.getPostChannel()._setTransmitProfile(this.configProvider.config.transmitProfileName),this.currentTransmitProfile=this.configProvider.config.transmitProfileName}},tI=class{constructor(g,m,f,S,v,C,_,E){this.tenant=g,this.manager=m,this.logger=f,this.configProvider=S,this.uiVersion=v,this.eventLatency=C,this.contextProvider=_,this.envOverride=E,this.instanceConfig={extensions:[],extensionConfig:[]}}sendEvent(g){this.setEnvPropertiesToEveryEvent();const m=this.configProvider.config.telemetryTenants[this.tenant],f=this.manager.getInst(m)??this.manager.newInst(m,this.instanceConfig,[]),S=g.props,v={};switch(this.logger.info(`preparing event for delievery: ${g.props?.CorrelationId??""}/${g.eventName}`),this.tenant){case"signaling":S.SkypeId&&(v.user_id={value:S.SkypeId,kind:10},v.Skype_InitiatingUser_Username={value:S.SkypeId,kind:10},v.SkypeId={value:S.SkypeId,kind:10},delete S.SkypeId),this.uiVersion&&(v.ui_version={value:this.uiVersion,kind:0});break;case"media":case"tlePlayer":this.uiVersion&&(v.uiVersion={value:this.uiVersion,kind:0});break;case"realtimeMedia":this.uiVersion&&(v["AppInfo.Version"]={value:this.uiVersion,kind:0})}for(const g of Object.keys(S)){const m=S[g];v[g]={value:m?.value??m,kind:m?.piiKind??0}}const C={name:g.eventName,data:v,latency:this.eventLatency,persistence:Sh.Normal};this.configProvider.config.useSendBeaconSync&&(C.sync=2),this.logger.info(`about to send event ${JSON.stringify(C)}`),f.track(C)}setEnvPropertiesToEveryEvent(){const g=this.contextProvider?.();if(!deepEqual(this.ctx,g)&&(this.ctx=g,this.ctx))if(this.envOverride){for(const g of Object.keys(this.envOverride||{}))if(this.ctx[g]){const m=this.ctx[g].piiKind??0,f=convertContextProperty(this.ctx[g].value);this.manager.getPropertyManager().setProperty(this.envOverride[g],{value:f,kind:m})}}else for(const g of Object.keys(this.ctx)){const m=this.ctx[g].piiKind??0,f=convertContextProperty(this.ctx[g].value);this.manager.getPropertyManager().setProperty(g,{value:f,kind:m})}}},iI=class extends Ve{constructor(g,m,f){super(),this.relayManager=g,this.configProvider=m,this.logger=f,this.currentInfo={},this.currentAreaContent={},this.isEnabled=!1,this.isEnabled=this.configProvider.config.enableE911,m.on("configUpdated",(()=>{this.isEnabled=this.configProvider.config.enableE911,this.isEnabled&&(this.prober?.dispose(),this.prober=void 0,this.probeForIP())}))}get info(){return this.currentInfo}get areaContent(){return this.currentAreaContent}async getInfo(){return this.isEnabled&&!this.prober&&await this.probeForIP(),this.currentInfo}setClientInfo(g,m){if(this.isEnabled)switch(this.logger.info(`Client info for ${g} set`),g){case 3:this.mergeClientAreaInfo(JSON.parse(m));break;case 1:break;case 2:this.mergeClientNetworkInfo(JSON.parse(m))}}mergeClientAreaInfo(g){const m=JSON.stringify(this.currentAreaContent);this.currentAreaContent.geoCoordinates=g.geoCoordinates,removeUndefinedFields(this.currentAreaContent),JSON.stringify(this.currentAreaContent)!==m&&this.raiseChanged()}mergeClientNetworkInfo(g){if(0===Object.keys(g).length){const g=Object.keys(this.currentInfo).length+Object.keys(this.currentAreaContent).length;return this.currentInfo={},this.currentAreaContent={},void(g>0&&this.raiseChanged())}const m=JSON.stringify(this.currentInfo);this.currentInfo.bssid=g.bssid,this.currentInfo.bssidv6=g.bssidv6,this.currentInfo.e911=g.e911,this.currentInfo.mac=g.mac,this.currentInfo.macv6=g.macv6,this.currentInfo.subnetLengthIpv4=g.subnetLengthIpv4,this.currentInfo.subnetLengthIpv6=g.subnetLengthIpv6,removeUndefinedFields(this.currentInfo),JSON.stringify(this.currentInfo)!==m&&this.probeForIP().then((g=>{g||this.raiseChanged()}))}async probeForIP(){this.logger.info("Probing for public IP address...");const g=await this.ensureProber();if(await g.ensureOnline(),g.ipFromRelay){if((this.currentInfo.ipv4||this.currentInfo.ipv6)!==g.ipFromRelay)return delete this.currentInfo.ipv4,delete this.currentInfo.ipv6,this.currentInfo[zs.test(g.ipFromRelay)?"ipv4":"ipv6"]=g.ipFromRelay,this.raiseChanged(),!0}else if(0!==Object.keys(this.currentInfo).length)return this.currentInfo={},this.raiseChanged(),!0;return!1}async ensureProber(){if(this.prober)return this.prober;const g=createProbeIceServers(await this.relayManager.queryRelaysAsync({relayType:"turn"}),this.configProvider.config);return this.prober=new nv(g,new WS(this.logger.createChild("Prober"),this.logger.createChild("ProberUnsafe"))),this.prober}},nI=class extends Error{constructor(g,m=1){super(g),this.callSupport=m}};function createTelemetryLoggersFromConfig(g){let m={};return g.telemetryLoggers?m=g.telemetryLoggers:g.telemetryService?.getGenericTelemetryLogger&&g.telemetryTenants?Object.keys(g.telemetryTenants).forEach((f=>m[f]=g.telemetryService.getGenericTelemetryLogger(g.telemetryTenants[f]))):g.telemetryService&&(g.telemetryService.sendEvents||g.telemetryService.getCallingAdapter)&&(g.telemetryService.sendEvents&&(m.media={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendEvents([m])}},m.tlePlayer={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendEvents([m])}}),g.telemetryService?.sendRealTimeEvents&&(m.realtimeMedia={sendEvent(m){m.eventName&&(m.eventName=m.eventName.replace(/^(mdsc_)/,"")),g.telemetryService.sendRealTimeEvents([m])}}),g.telemetryService.getCallingAdapter&&(m.signaling={sendEvent(m){g.telemetryService.getCallingAdapter().sendEvent(m.eventName,m.props)}})),m}function createTelemetryLoggersForOneDs(g,m,f,S,v,C){const _={signaling:[],media:[],tlePlayer:[],realtimeMedia:[]};let E={signaling:{sendEvent:g=>_.signaling.push(g)},media:{sendEvent:g=>_.media.push(g)},tlePlayer:{sendEvent:g=>_.tlePlayer.push(g)},realtimeMedia:{sendEvent:g=>_.realtimeMedia.push(g)}};return m.configReceivedOrTimeout.then((async()=>{let T=(await v)?.serviceUrls?.OneDsCollectorUrl;if(T=T??m.config.collectorUrl,T){const v=new eI(g,m,f,m.config.eventLatency,S,T);E.signaling=v.createLogger("signaling"),E.media=v.createLogger("media"),E.tlePlayer=v.createLogger("tlePlayer");const C=new eI(g,m,f,m.config.eventLatencyRealTime,S,T,{"UserInfo.Ring":"Ring","UserInfo.TenantId":"TenantId","AppInfo.ClientType":"client_type","UserInfo.ETag":"AppInfo.EcsEtag",appversion:"First/Second Client VDI Desktop Version",vdiMode:"First/Second Client VDI Mode",vdiConnectedState:"First/Second Client VDI Connected State",vdiShimVersion:"First/Second Client VDI Shim Version",vdiProvider:"First/Second Client VDI Provider Version"});E.realtimeMedia=C.createLogger("realtimeMedia")}else E=createTelemetryLoggersFromConfig(C);for(const[g,m]of Object.entries(_))for(const f of m)E[g].sendEvent(f)})),E}var rI=class _PluginlessStack extends Ve{constructor(g,m){super(),this._config=g,this._ecsProvider=m,this.callRegistries=[],this._logger=new Je(this._config.logger).createChild("PluginlessStack"),this._platformManager=new tT,this._waitForAccountConfiguration=new Sr,this.platformCallConstraintsProvider=new Ke(this._logger.createChild("PlatformConstraintsProvider"))}async initializeMediaAgent(g){let m,f=null;if(!this._mediaAgentProvider)throw new nI("PluginlessStack initialize MediaAgent error, Media Stack not initialized",f);try{this._relayManager=g.relayManager||this.buildRelayManager(g.httpRequestDispatcher,g.tokenProvider,g.configProvider,g.appStateProvider,g.trapTokenCredentialsProvider),m=await this._mediaAgentProvider.buildAgent(this._config.platformType,this._relayManager,this._midCallTelemetry)}catch(g){const m=g.some((g=>"incompatible_version"===g.reason));f=m?2:1}if(!this._config.usePlatformSupportApi&&!this._config.callSettings?.useLwjForAllCalls){if(f)throw new nI("PluginlessStack initialization failed",f);{const g=(new tT).getPlatformSupportLevel(!0);if(1!==g&&2!==g)throw new nI("PluginlessStack initialization failed",1)}}m?(this._screenSharingManager=new rT(m.getScreenSharingManager()),this._waitForAccountConfigurationTimeout=window.setTimeout((()=>{this._waitForAccountConfiguration.resolve(void 0),this._waitForAccountConfigurationTimeout=void 0}),3e4),this._oneDsTelemetryLoggers=createTelemetryLoggersForOneDs(this._logger.createChild("OneDsLogger"),m.getConfigProvider(),g.clientInformation,this._config.telemetryContextProvider,this._waitForAccountConfiguration.promise,this._config),m.getConfigProvider().config.useOneDsLogger&&(this.signalingLoggerAdapter={sendEvent:(g,m)=>{const f={eventName:g,props:m};this._oneDsTelemetryLoggers.signaling.sendEvent(f)}}),this._mediaAgent=m,this._e911=new iI(this._relayManager,this._mediaAgent.getConfigProvider(),this._logger.createChild("E911")),this._e911?.changed((()=>{this.event("e911InfoChanged").raise(this._e911?.info,this._e911?.areaContent)}))):this._deviceManager=new $t}async initializeSignalingAgentProvider(g){this._trouterService=g.trouterService,this._signalingAgentProvider=dT.build(g.signalingAgentConfig,this._ecsProvider,this._config.logger,this.signalingLoggerAdapter)}static async build(g,m,f){try{const S=new _PluginlessStack({detectH264Support:g.mediaAgentFactoryConfig.detectH264Support,domOverrides:g.mediaAgentFactoryConfig.domOverrides,mediaSettings:g.mediaAgentFactoryConfig.settings,logger:g.logger,telemetryLoggers:g.telemetryLoggers,telemetryService:g.telemetryService,telemetryTenants:g.telemetryTenants,telemetryContextProvider:g.telemetryContextProvider,platformType:g.platformType,callSettings:g.callSettings,usePlatformSupportApi:g.usePlatformSupportApi,clientInformation:g.signalingAgentConfig.clientInformation},m);return S.initializeMediaProvider({detectH264Support:g.mediaAgentFactoryConfig.detectH264Support,domOverrides:g.mediaAgentFactoryConfig.domOverrides,mediaSettings:g.mediaAgentFactoryConfig.settings,logger:g.mediaAgentFactoryConfig.logger,safeLogger:g.mediaAgentFactoryConfig.safeLogger,webcvProvider:g.mediaAgentFactoryConfig.webcvProvider,wasmdnsProvider:g.mediaAgentFactoryConfig.wasmdnsProvider,wasmaecProvider:g.mediaAgentFactoryConfig.wasmaecProvider,wasmVqeProvider:g.mediaAgentFactoryConfig.wasmVqeProvider,createWasmWorkerCbs:g.mediaAgentFactoryConfig.createWasmWorkerCbs,encodedStreamsWorkerProvider:g.mediaAgentFactoryConfig.encodedStreamsWorkerProvider}),S.setMidCallTelemetry(f),S.initializeSignalingAgentProvider({signalingAgentConfig:g.signalingAgentConfig,trouterService:g.trouterService}),await S.initializeMediaAgent({httpRequestDispatcher:g.mediaAgentFactoryConfig.httpRequestDispatcher,tokenProvider:g.mediaAgentFactoryConfig.tokenProvider,configProvider:g.mediaAgentFactoryConfig.configProvider,appStateProvider:g.mediaAgentFactoryConfig.appStateProvider,clientInformation:g.signalingAgentConfig.clientInformation,trapTokenCredentialsProvider:g.mediaAgentFactoryConfig.trapTokenCredentialsProvider,relayManager:g.mediaAgentFactoryConfig.relayManager}),S}catch(g){throw g instanceof nI?g:new nI(`${g}`)}}static async buildBaseStack(g,m){const f=new _PluginlessStack(g,m);return f.initializeMediaProvider({detectH264Support:g.detectH264Support,domOverrides:g.domOverrides,mediaSettings:g.mediaSettings,logger:g.logger,safeLogger:g.safeLogger,webcvProvider:g.webcvProvider,wasmdnsProvider:g.wasmdnsProvider,wasmaecProvider:g.wasmaecProvider,wasmVqeProvider:g.wasmVqeProvider,createWasmWorkerCbs:g.createWasmWorkerCbs,encodedStreamsWorkerProvider:g.encodedStreamsWorkerProvider}),f}async init(){}async dispose(g=generateCauseId()){const m=this._logger.createFnLogger("dispose",g);m.info("Dispose"),this._ecsProvider.dispose();const handleDisposeError=g=>{m.warn("Failed:",g)},f=this.callRegistries.map((m=>m.dispose(g).catch(handleDisposeError)));await Promise.all(f),await this._mediaAgent.dispose(g).catch(handleDisposeError),m.info("media agent is disposed"),this.callRegistries=[],m.info("call registries are disposed"),this._screenSharingManager&&(this._screenSharingManager.dispose(g),this._screenSharingManager=void 0,m.info("screensharing manager is disposed")),this._deviceManager=void 0,super.dispose()}getCallRegistry(){return this._logger.info("returning default callRegistry"),this.callRegistries[0]?this.callRegistries[0]:this._createCallRegistry()}async createCallRegistry(g,m=generateCauseId()){const f=g?mriOrId(g.id):void 0,S=this._logger.createFnLogger(`createCallRegistry[identity=${f}]`,m),v=this.callRegistries.find((m=>m.identity===g.id));return v&&!v.isDisposing?(S.info(`callRegistry already exists for ${mriOrId(g.id)}`),v):(v?.isDisposing&&await v.disposePromise,this._createCallRegistry(g))}createCompositor(g){throw new Error("Method not implemented.")}_createCallRegistry(g){if(!this._trouterService)throw new nI("Unable to create call registry, trouter service undefined");if(!this._mediaAgent)throw new nI("Unable to create call registry, media agent undefined");if(!this._signalingAgentProvider)throw new nI("Unable to create call registry, signaling agent undefined");const m=new ca(this._trouterService,this._signalingAgentProvider,this._mediaAgent,this._logger,createTelemetryLoggersFromConfig(this._config),this._ecsProvider,g,this._oneDsTelemetryLoggers);return m.on("disposed",(()=>{this.callRegistries.splice(this.callRegistries.indexOf(m),1)})),m.on("accountConfigurationReceived",(g=>{0===this._waitForAccountConfiguration.state&&(this._waitForAccountConfiguration.resolve(g),window.clearTimeout(this._waitForAccountConfigurationTimeout)),this._relayManager.setDefaultRelayConfig(g.relayConfig)})),m.on("locationInfoSet",((g,m)=>{this._e911?.setClientInfo(g,m)})),this.callRegistries.push(m),m}initializeMediaProvider(g){const m=(0,Le.assign)({},g);this._mediaAgentProvider=new ZE(m,this._ecsProvider,this.platformCallConstraintsProvider),this._deviceManager=new ga(this._mediaAgentProvider.getDeviceManager())}setMidCallTelemetry(g){this._midCallTelemetry=g}buildRelayManager(g,m,f,S,v){const C=g||new ke(this._logger);return build({logger:this._logger,tokenProvider:m,trapTokenCredentialsProvider:v,configProvider:()=>f.getRelayConfig(),request:{get:(g,m)=>C.getAsync(g,C.getRequestOptions("GET",m?.headers,null,m?.timeout)),isOnline:S.isOnline},newTokenProvider:()=>this._signalingAgentProvider.getSignalingAgent().authTokenManager.getToken(generateGuid())})}getDeviceManager(){return this._deviceManager}createDeviceManager(g){return this._deviceManager}getScreenSharingManager(){return this._screenSharingManager}getSetup(){}getEcsProvider(){return this._ecsProvider}getCallFeedback(){return null}getAiMdp(){return null}fireIntent(g,m){}getVersion(){return{build:getTsCallingVersion(),ovb:getOvb()}}getMediaStatus(){return null}getVideoCapabilityLimits(){return null}async setMediaConfig(g){this._mediaAgent.setMediaConfig(g)}async getE911Info(){return this._e911?.getInfo()}setPlatformCallConstraints(g){this.platformCallConstraintsProvider.setConstraints(g)}getPlatformSupportLevel(){return this._platformManager.getPlatformSupportLevel(!!this._mediaAgent)}getLiveStreamClient(){const getTelemetryLogger=()=>createTelemetryLoggersFromConfig(this._config).tlePlayer;return new Ht(this._ecsProvider.createEcsConfiguration(),this._logger.createChild("LiveStreamClient"),getTelemetryLogger)}createVoipCallCoordinator(){}async setLogFileName(g,m,f){throw new Error("not supported")}aggregateDiagnosticLogs(g){return Promise.reject("not supported")}extendBrbFeedback(g,m){return Promise.reject("not supported")}async addOcclusion(g,m,f,S,v,C){}async removeOcclusion(g,m,f,S){}async flushLogs(){throw new Error("not supported")}},sI={build(g){const m=g.telemetryContextProvider?.(),f=new iT(m),S=new _a;return initLogger(g,f,S),rI.build(g,f,S)},buildBaseStack(g){const m=g.telemetryContextProvider?.(),f=new iT(m);return rI.buildBaseStack(g,f)},getVersion:()=>({build:getTsCallingVersion(),ovb:getOvb()})};
/*! Bundled license information:

@microsoft/dynamicproto-js/lib/dist/esm/dynamicproto-js.js:
  (*!
   * Microsoft Dynamic Proto Utility, 1.1.8
   * Copyright (c) Microsoft and contributors. All rights reserved.
   *)
*/
if("object"==typeof v.exports&&"object"==typeof S){var __cp=(g,m,f,S)=>{if(m&&"object"==typeof m||"function"==typeof m)for(let v of Object.getOwnPropertyNames(m))Object.prototype.hasOwnProperty.call(g,v)||v===f||Object.defineProperty(g,v,{get:()=>m[v],enumerable:!(S=Object.getOwnPropertyDescriptor(m,v))||S.enumerable});return g};v.exports=__cp(v.exports,S)}return v.exports}))}));const M=400,D=401,O=403,N=404,k=405,L=408,F=409,x=410,U=412,V=415,B=422,H=500,$=501,G="19:preview-",j={Date:!0,RegExp:!0,String:!0,Number:!0},W=3e3,q={CALL_CLIENT:{LOWER_LIMIT:4e4,UPPER_LIMIT:40099},CALL_STACK:{LOWER_LIMIT:40100,UPPER_LIMIT:40199},CALL_AGENT:{LOWER_LIMIT:40200,UPPER_LIMIT:40599},DEVICE_MANAGER:{LOWER_LIMIT:40600,UPPER_LIMIT:40699},CALL:{LOWER_LIMIT:41e3,UPPER_LIMIT:41799},LOBBY:{LOWER_LIMIT:41800,UPPER_LIMIT:41899},CTE_MID_TIER_POLICY_SERVICE:{LOWER_LIMIT:41900,UPPER_LIMIT:41999},REMOTE_PARTICIPANT:{LOWER_LIMIT:42e3,UPPER_LIMIT:42499},LOCAL_VIDEO_STREAM:{LOWER_LIMIT:43e3,UPPER_LIMIT:43099},REMOTE_VIDEO_STREAM:{LOWER_LIMIT:43100,UPPER_LIMIT:43199},VIEW:{LOWER_LIMIT:43200,UPPER_LIMIT:43599},LOCAL_AUDIO_STREAM:{LOWER_LIMIT:43600,UPPER_LIMIT:43699},REMOTE_AUDIO_STREAM:{LOWER_LIMIT:43700,UPPER_LIMIT:43799},IDENTIFIER:{LOWER_LIMIT:44e3,UPPER_LIMIT:44099},INTERNAL:{LOWER_LIMIT:44100,UPPER_LIMIT:44199},FEATURES:{LOWER_LIMIT:45e3,UPPER_LIMIT:47999,AUDIO_EFFECTS:{LOWER_LIMIT:45e3,UPPER_LIMIT:45049},AUDIO_ZONES:{LOWER_LIMIT:45050,UPPER_LIMIT:45099},CALL_SURVEY:{LOWER_LIMIT:45100,UPPER_LIMIT:45149},CAPABILITIES:{LOWER_LIMIT:45150,UPPER_LIMIT:45199},CAPTIONS:{LOWER_LIMIT:45200,UPPER_LIMIT:45249},COMPOSSED_STREAM:{LOWER_LIMIT:45250,UPPER_LIMIT:45299},DATA_CHANNEL:{LOWER_LIMIT:45300,UPPER_LIMIT:45349},DEBUG_INFO:{LOWER_LIMIT:45350,UPPER_LIMIT:45399},DIAGNOSTICS:{LOWER_LIMIT:45400,UPPER_LIMIT:45449},DOMINANT_SPEAKER:{LOWER_LIMIT:45450,UPPER_LIMIT:45499},LIVE_STREAM:{LOWER_LIMIT:45500,UPPER_LIMIT:45549},MEDIA_STATS:{LOWER_LIMIT:45550,UPPER_LIMIT:45599},OPTIMAL_VIDEO_COUNT:{LOWER_LIMIT:45600,UPPER_LIMIT:45649},PPTLIVE:{LOWER_LIMIT:45650,UPPER_LIMIT:45699},PRECALL_DIAGNOSTICS:{LOWER_LIMIT:45700,UPPER_LIMIT:45749},RAISE_HAND:{LOWER_LIMIT:45750,UPPER_LIMIT:45799},REACTION:{LOWER_LIMIT:45800,UPPER_LIMIT:45849},RECORDING:{LOWER_LIMIT:45850,UPPER_LIMIT:45899},SPOTLIGHT:{LOWER_LIMIT:45900,UPPER_LIMIT:45949},TEAMS_MEETING_AUDIO_CONFERENCING:{LOWER_LIMIT:45950,UPPER_LIMIT:45999},TRANSCRIPTION:{LOWER_LIMIT:46e3,UPPER_LIMIT:46049},TRANSFER:{LOWER_LIMIT:46050,UPPER_LIMIT:46099},UNMIXED_AUDIO:{LOWER_LIMIT:46100,UPPER_LIMIT:46149},VIDEO_EFFECTS:{LOWER_LIMIT:46150,UPPER_LIMIT:46199},LOCAL_RECORDING:{LOWER_LIMIT:46200,UPPER_LIMIT:46249}}},z={CALL_CLIENT:{SUBCODE_RANGE:{LOWER_LIMIT:q.CALL_CLIENT.LOWER_LIMIT,UPPER_LIMIT:q.CALL_CLIENT.UPPER_LIMIT},INIT_CALL_CLIENT:{message:"Failed to initialize CallClient",code:H,subCode:4e4,resultCategories:["UnexpectedClientError"]},CREATE_CALL_AGENT:{message:"Failed to create CallAgent",code:F,subCode:40001,resultCategories:["UnexpectedClientError"]},CREATE_TEAMS_CALL_AGENT:{message:"Failed to create TeamsCallAgent",code:F,subCode:40002,resultCategories:["UnexpectedClientError"]},RELAY_INFO:g=>({message:`Error processing relay information. Possibly invalid url: ${g}`,code:M,subCode:40003,resultCategories:["ExpectedError"]}),RELAY_UNRECOGNIZED_SCHEMA:{message:"Error processing relay information. Unrecognized schema",code:M,subCode:40004,resultCategories:["ExpectedError"]},PROXY_SHORT_URL:{message:"Failed setup proxy, the url is too short",code:M,subCode:40005,resultCategories:["ExpectedError"]},PROXY_PROTOCOL:{message:"Failed setup proxy, the protocol is not https or http",code:M,subCode:40006,resultCategories:["ExpectedError"]},SETUP_PROXY:g=>({message:`Setup failed. Proxy url is invalid: ${g}`,code:M,subCode:40007,resultCategories:["ExpectedError"]}),ONE_CALL_AGENT_PER_CALL_CLIENT:{message:"CallClient instance can support only one CallAgent or TeamsCallAgent create new CallClient instance to create new CallAgent or TeamsCallAgent",code:M,subCode:40008,resultCategories:["ExpectedError"]},EMERGENCY_CODE_TOO_LONG:{message:"EmergencyCountryCode is invalid, max length is 10",code:M,subCode:40009,resultCategories:["ExpectedError"]}},CALL_STACK:{SUBCODE_RANGE:{LOWER_LIMIT:q.CALL_STACK.LOWER_LIMIT,UPPER_LIMIT:q.CALL_STACK.UPPER_LIMIT},BAD_PROTOCOL:{message:"ACS Web Calling SDK must be used through https, file:, or localhost",code:M,subCode:40100,resultCategories:["ExpectedError"]},BASE_STACK_INIT_TIMEOUT:{message:"Failed to create stack base due to timeout during initialization",code:L,subCode:40101,resultCategories:["UnexpectedClientError"]},BASE_STACK_INIT_FAILED:{message:"Failed to create stack base due to failure in intialization",code:H,subCode:40102,resultCategories:["UnexpectedClientError"]},BASE_STACK_CREATE_FAILED:{message:"Base stack failed to create",code:H,subCode:40103,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_TIMEOUT:{message:"User stack init timeout",code:L,subCode:40104,resultCategories:["UnexpectedClientError"]},USER_STACK_INIT_FAILED:{message:"User stack init failed",code:H,subCode:40105,resultCategories:["UnexpectedClientError"]},PARSE_CONFIG:{message:"Unable to parse configuration",code:H,subCode:40106,resultCategories:["UnexpectedClientError"]},SET_STACK_CONFIG:{message:"Failed to set configuration for stack",code:H,subCode:40107,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager due to internal call stack undefined",code:H,subCode:40108,resultCategories:["UnexpectedClientError"]},SET_STACK_PARAMS:{message:"Failed to initialize callclient",code:H,subCode:40109,resultCategories:["UnexpectedClientError"]},FOUND_UNDEFINED_CONFIGS:g=>({message:`Found undefined configs in ECS response: {${g}}`,code:H,subCode:40110,resultCategories:["UnexpectedClientError"]}),SIGNALING_SERVICE_CREATE_FAIL:{message:"Failed to create trouter service",code:H,subCode:40111,resultCategories:["UnexpectedClientError"]},SIGNALING_INIT_FAIL:{message:"Signaling init failed",code:H,subCode:40112,resultCategories:["UnexpectedClientError"]},SIGNALING_SERVICE_ALREADY_INITIALIZED:{message:"Signaling service already initialized",code:H,subCode:40113,resultCategories:["ExpectedError"]},SIGNALING_SERVICE_CREATE_TIMEOUT:g=>({message:`Signaling init timeout, request took longer than ${g} ms`,code:L,subCode:40114,resultCategories:["UnexpectedClientError"]}),SIGNALING_UNINITIALIZED:{message:"Signaling failed to initialize.",code:U,subCode:40115,resultCategories:["UnexpectedClientError"]}},CALL_AGENT:{SUBCODE_RANGE:{LOWER_LIMIT:q.CALL_AGENT.LOWER_LIMIT,UPPER_LIMIT:q.CALL_AGENT.UPPER_LIMIT},PROXY_CUSTOM_TURN_FORBIDDEN:{message:"Using proxy or custom TURN for calls involving Teams is disabled",code:O,subCode:40200,resultCategories:["ExpectedError"]},PARSE_ACCESSTOKEN:{message:"Failed to parse AccessToken",code:H,subCode:40201,resultCategories:["UnexpectedClientError"]},CANT_CALL_YOURSELF:{message:"Call to yourself is not supported.",code:M,subCode:40202,resultCategories:["ExpectedError"]},ACS_ALREADY_DISPOSED:{message:"Call Agent is already disposed",code:F,subCode:40203,resultCategories:["ExpectedError"]},CTE_ALREADY_DISPOSED:{message:"Teams Call Agent is already disposed",code:F,subCode:40204,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:40205,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:40206,resultCategories:["ExpectedError"]}),MESH_DEVICETYPE_V2:{message:"Device type must be msft-acs-mesh-deviceType-v2 to join immersive call",code:M,subCode:40207,resultCategories:["ExpectedError"]},STACK_NOT_INIT:{message:"Failed to start or join call, call stack did not initialize",code:H,subCode:40208,resultCategories:["UnexpectedClientError"]},INVALID_CALL_CONFIG:{message:"Invalid call configuration",code:M,subCode:40209,resultCategories:["ExpectedError"]},INVALID_MEETING_LINK:{message:"Invalid meeting link",code:M,subCode:40210,resultCategories:["ExpectedError"]},INVALID_TFL_MEETING_LINK:{message:"Invalid TFL meeting link",code:M,subCode:40211,resultCategories:["ExpectedError"]},GROUPCALL_THREADID:{message:"Starting a group call must include thread ID in StartTeamsGroupCallOptions.",code:M,subCode:40212,resultCategories:["ExpectedError"]},ONE_TO_ONE_THREADID:{message:"Starting a one to one with thread ID is invalid.",code:M,subCode:40213,resultCategories:["ExpectedError"]},CTE_DISPLAY_NAME:{message:"Display name is not allowed to be set for Teams users.",code:M,subCode:40214,resultCategories:["ExpectedError"]},DISPLAYNAME_TOO_LONG:{message:"Display name is too long.",code:M,subCode:40215,resultCategories:["ExpectedError"]},INIT_FAIL:{message:"Failed to create CallAgent",code:H,subCode:40216,resultCategories:["UnexpectedClientError"]},GET_TOKEN_BEFORE_INIT:{message:"Attempted to get AccessToken before initialization",code:B,subCode:40217,resultCategories:["UnexpectedClientError"]},INVALID_PUSHNOTIFICAITON_DATA:{message:"Invalid push notification data provided",code:M,subCode:40218,resultCategories:["ExpectedError"]},PUSHNOTIFICAITON_FAIL:{message:"Failed to handle push notification",code:H,subCode:40219,resultCategories:["UnexpectedClientError"]},INCOMING_PUSH_NOTIFICATION_NO_PAYLOAD:{message:"Invalid Incoming Call push notification payload provided",code:M,resultCategories:["UnexpectedServerError"],subCode:40220},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED:{message:"No 'incomingCallContext' provided in event payload",code:M,resultCategories:["UnexpectedServerError"],subCode:40221},INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD:{message:"Invalid Incoming Call push notification payload data provided",code:M,resultCategories:["UnexpectedServerError"],subCode:40222},INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED:{message:"Incoming Call is already being processed",code:M,resultCategories:["ExpectedError"],subCode:40223},INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS:{message:"Failed to handle Incoming Call push notification",code:H,resultCategories:["UnexpectedClientError"],subCode:40224},INCOMING_PUSH_NOTIFICATION_CALL_MISSED:{message:"Missed call",code:M,resultCategories:["ExpectedError"],subCode:40225},USERIDS_MUST_BE_OBJECTS:{message:"AssertIsObject failed. : userIds must be object",code:M,resultCategories:["ExpectedError"],subCode:40226},USERIDS_CANNOT_BE_NULL:{message:"AssertNotNull failed. : userIds cannot be null",code:M,resultCategories:["ExpectedError"],subCode:40227},ACS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create call agent, call agent for this ACS Id already exists",code:F,resultCategories:["ExpectedError"],subCode:40228},ACS_CALLAGENT_TOKEN_ONLY:{message:"CallAgent must be created only with ACS token",code:O,resultCategories:["ExpectedError"],subCode:40229},TEAMS_CALLAGENT_ALREADY_EXSISTS:{message:"Failed to create call agent, call agent for this ACS Id already exists",code:F,resultCategories:["ExpectedError"],subCode:40230},TEAMS_CALLAGENT_TOKEN_ONLY:{message:"TeamsCallAgent must be created only with Teams token",code:O,resultCategories:["ExpectedError"],subCode:40231},FAILED_TO_GET_TOKEN:{message:"Failed to get token",code:F,resultCategories:["UnexpectedClientError"],subCode:40232},REFRESHED_TOKEN_INVALID_USERID:{message:"Refreshed AccessToken User Id doesnt match initial User Id.",code:M,resultCategories:["ExpectedError"],subCode:40233},REFRESHED_TOKEN_RETRIES:{message:"Access token is expired and failed to fetch a valid one after retries.",code:M,resultCategories:["ExpectedError"],subCode:40234},ACCESSTOKEN_EXPIRED:{message:"AccessToken expired",code:D,resultCategories:["ExpectedError"],subCode:40235}},DEVICE_MANAGER:{SUBCODE_RANGE:{LOWER_LIMIT:q.DEVICE_MANAGER.LOWER_LIMIT,UPPER_LIMIT:q.DEVICE_MANAGER.UPPER_LIMIT},GET_MEDIA_STREAM_TRACK:{message:"Failed to get raw device stream track",code:H,subCode:40600,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM_DEVICE_UNAVAILABLE:{message:"Failed to get raw device stream track, make sure there is available device",code:U,subCode:40601,resultCategories:["UnexpectedClientError"]},GET_DM:{message:"Failed to get device manager.",code:H,subCode:40602,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:40603,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:40604,resultCategories:["ExpectedError"]}),ACCESS_DM:{message:"Unable to access device manager",code:H,subCode:40605,resultCategories:["UnexpectedClientError"]},SPEAKER_ENUMERATION_UNSUPPORTED:{message:"This device does not support speaker enumeration.",code:k,subCode:40606,resultCategories:["ExpectedError"]},SELECT_MICROPHONE_TIMEOUT:{message:"Microphone selection timed out.",code:L,subCode:40607,resultCategories:["UnexpectedClientError"]},SELECT_MICROPHONE_FAIL:{message:"There was an issue with selecting the microphone",code:H,subCode:40608,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_TIMEOUT:{message:"Speaker selection timed out.",code:L,subCode:40609,resultCategories:["UnexpectedClientError"]},SELECT_SPEAKER_FAIL:{message:"There was an issue with selecting the speaker",code:H,subCode:40610,resultCategories:["UnexpectedClientError"]},SPEAKER_SELECTION_UNSUPPORTED:{message:"This device does not support speaker selection.",code:k,subCode:40611,resultCategories:["ExpectedError"]},ONE_PERMISSION_ATLEAST:{message:"At least one permission must be requested",code:M,subCode:40612,resultCategories:["ExpectedError"]},PERMISSION_NOT_GRANTED_OR_FAILED:g=>({message:`Permissions not granted or failed: ${g}`,code:M,subCode:40613,resultCategories:["ExpectedError"]}),ADP_FAIL:{message:"Failed to get audio video permissions",code:H,subCode:40614,resultCategories:["UnexpectedClientError"]},INVALID_DEVICE:{message:"The device argument is invalid",code:M,subCode:40615,resultCategories:["ExpectedError"]},DEVICE_NOT_SELECTABLE:{message:"The device is not selectable",code:M,subCode:40616,resultCategories:["ExpectedError"]}},CALL:{SUBCODE_RANGE:{LOWER_LIMIT:q.CALL.LOWER_LIMIT,UPPER_LIMIT:q.CALL.UPPER_LIMIT},OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL:g=>({message:`${g} operation is not allowed during Emergency Call`,code:H,subCode:41e3,resultCategories:["ExpectedError"]}),OPERATION_FAILED:g=>({message:`${g} failed`,code:H,subCode:41001,resultCategories:["UnexpectedClientError"]}),REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED:{message:"Unable to get remote audio stream, getMediaStream returned undefined",code:H,subCode:41002,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR:{message:"Unable to get remote audio stream, getMediaStream returned error",code:H,subCode:41003,resultCategories:["UnexpectedClientError"]},REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED:{message:"Getting raw audio media strema is currently dissabled",code:F,subCode:41004,resultCategories:["ExpectedError"]},ACCEPT_INCOMING_CALL:{message:"Failed to accept the Incoming Call",code:H,subCode:41005,resultCategories:["UnexpectedClientError"]},ACCEPT_NOT_RINGING:{message:"Call cannot be accepted because it is not in Ringing state",code:M,subCode:41006,resultCategories:["ExpectedError"]},REJECT_NOT_RINGING:{message:"Call cannot be rejectd because it is not in Ringing state",code:M,subCode:41007,resultCategories:["ExpectedError"]},LOCAL_AUDIO_GET_MEDIA_STREAM:{message:"Failed to get raw stream from local audio stream",code:H,subCode:41008,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_SET_MEDIA_STREAM:{message:"Failed to set raw input audio stream",code:H,subCode:41009,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNSET_MEDIA_STREAM:{message:"Failed to unset raw input audio stream",code:H,subCode:41010,resultCategories:["UnexpectedClientError"]},LOCAL_AUDIO_UNDEFINED_STACK:{message:"Failed to process audio because of internal call stack error",code:H,subCode:41011,resultCategories:["UnexpectedClientError"]},REMOVE_LOCAL_VIDEO_ON_BAD_UFD:(g,m,f)=>({message:`Removing local video stream due to video fail UFD being raised before call connected. UFD: ${g}, value: ${m}, call direction: ${f}`,code:F,subCode:41012,resultCategories:["UnexpectedClientError"]}),STOP_AUDIO_ON_BAD_UFD:(g,m)=>({message:`Failed to stop audio on microphone device not functioning or capture mute event ${g} with value ${m}`,code:M,subCode:41013,resultCategories:["UnexpectedClientError"]}),INSTANTIATE_CALL:{message:"Failed to instantiate the Call",code:H,subCode:41014,resultCategories:["UnexpectedClientError"]},MIC_MUTE:{message:"Failed to mute microphone",code:H,subCode:41015,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE:{message:"Failed to unmute microphone",code:M,subCode:41016,resultCategories:["UnexpectedClientError"]},MIC_UNMUTE_AND_STARTAUDIO:{message:"Failed to unmute and start audio, microphone device not functioning",code:x,subCode:41017,resultCategories:["UnexpectedClientError"]},MUTE_ALL_PARTICIPANTS_DISABLED:{message:"Mute other participants disabled.",code:O,subCode:41018,resultCategories:["ExpectedError"]},MUTE_ALL_PARTICIPANTS:{message:"Failed to mute all remote participants",code:H,subCode:41019,resultCategories:["UnexpectedClientError"]},MUTE_INCOMING_AUDIO:{message:"Failed to mute incoming audio",code:H,subCode:41020,resultCategories:["UnexpectedClientError"]},UNMUTE_INCOMING_AUDIO:{message:"Failed to unmute incoming audio",code:H,subCode:41021,resultCategories:["UnexpectedClientError"]},DTMF_TONE:{message:"Failed to send DTMF tone",code:M,subCode:41022,resultCategories:["UnexpectedClientError"]},INVALID_DTMF_TONE:{message:"Invalid value passed to DtfmTone",code:B,subCode:41023,resultCategories:["ExpectedError"]},START_AUDIO_BEFORE_VIDEO:{message:"Failed to start audio before starting video",code:M,subCode:41024,resultCategories:["UnexpectedClientError"]},STREAM_NULL:{message:"Failed to start video, localVideoStream cannot be null",code:M,subCode:41025,resultCategories:["ExpectedError"]},STREAM_IS_NOT_LVS:{message:"Failed to start video, localVideoStream is not an instance of LocalVideoStream",code:M,subCode:41026,resultCategories:["ExpectedError"]},VIDEO_ALREADY_ON:{message:"Failed to start video, local video is already on",code:M,subCode:41027,resultCategories:["ExpectedError"]},VIDEO_SET_MEDIA_STREAM:{message:"Failed to set media stream",code:H,subCode:41028,resultCategories:["UnexpectedClientError"]},START_VIDEO:{message:"Failed to start video",code:H,subCode:41029,resultCategories:["UnexpectedClientError"]},VIDEO_ALREADY_OFF:{message:"Failed to stop video, local video is already off",code:M,subCode:41030,resultCategories:["ExpectedError"]},VIDEO_UNDEFINED_STACK:{message:"Failed to process video because of internal call stack error",code:H,subCode:41031,resultCategories:["UnexpectedClientError"]},STOP_WRONG_STREAM:{message:"Invalid LocalVideoStream, this LocalVideoStream is not being sent",code:M,subCode:41032,resultCategories:["ExpectedError"]},HOLD_CALL:{message:"Failed to hold call",code:H,subCode:41033,resultCategories:["UnexpectedClientError"]},RESUME_CALL:{message:"Failed to resume call",code:H,subCode:41034,resultCategories:["UnexpectedClientError"]},SS_ALREADY_ON:{message:"Failed to start screen share, screen share is already on. Must stop and start again.",code:M,subCode:41035,resultCategories:["ExpectedError"]},SS_RAW_STREAM_IS_NOT_LVS:{message:"Failed to start raw screen sharing, localVideoStream is not an instance of LocalVideoStream",code:M,subCode:41036,resultCategories:["ExpectedError"]},SS_RAW_STREAM_UNDEFINED:{message:"Unable to get media stram from local video stream for screen sharing",code:H,subCode:41037,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_SET:{message:"Failed to set media stream for screen sharing",code:B,subCode:41038,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_GET:{message:"Failed to get media stream for screen sharing",code:B,subCode:41039,resultCategories:["UnexpectedClientError"]},START_SS:{message:"Failed to start screen sharing",code:H,subCode:41040,resultCategories:["UnexpectedClientError"]},SS_ALREADY_OFF:{message:"Failed to stop screen share, screen share is already off",code:M,subCode:41041,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:41042,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:41043,resultCategories:["ExpectedError"]}),ONLY_SINGLE_VIDEO_STREAM:{message:"Only single LocalVideoStream is supported currently",code:M,subCode:41044,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LVS:{message:"Stream is not an instance of LocalVideoStream",code:M,subCode:41045,resultCategories:["ExpectedError"]},ONLY_SINGLE_AUDIO_STREAM:{message:"Only single LocalAudioStream is supported currently",code:M,subCode:41046,resultCategories:["ExpectedError"]},NOT_INSTANCE_OF_LAS:{message:"Stream is not an instance of LocalAudioStream",code:M,subCode:41047,resultCategories:["ExpectedError"]},VIDEO_FAILED_TO_START:g=>({message:`Video failed to start during call-${g} process.`,code:x,subCode:41048,resultCategories:["UnexpectedClientError"]}),AUDIO_FAILED_TO_START:g=>({message:`Audio failed to start during call-${g} process.`,code:M,subCode:41049,resultCategories:["UnexpectedClientError"]}),LARGEMEETING_FORCE_ISAVAILABLE:{message:"Failed to force isAvailable flag to false during large meeting",code:H,subCode:41050,resultCategories:["UnexpectedClientError"]},LARGEMEETING_DISPOSE_VIEW:{message:"Failed to dispose view in large meeting",code:H,subCode:41051,resultCategories:["UnexpectedClientError"]},ADD_UNKNOWN:{message:"Not able to add unkown participant.",code:M,subCode:41052,resultCategories:["ExpectedError"]},PARTICIPANT_ALREADY_IN_CALL:g=>({message:`${g} is already in the call`,code:M,subCode:41053,resultCategories:["ExpectedError"]}),PARTICIPANT_NOT_IN_CALL:g=>({message:`${g} is not in the call.`,code:M,subCode:41054,resultCategories:["ExpectedError"]}),CTE_ADDPARTICIPANT_NO_THREAD_ID:{message:"Add participant failed: thread ID is missing in options.",code:M,subCode:41055,resultCategories:["ExpectedError"]},CTE_VOICE_NOT_ENABLED:{message:"Teams Enterprise voice is not enabled. Teams user is not eligible to make PSTN call",code:U,subCode:41056,resultCategories:["ExpectedError"]},SERVER_CALL_ID:{message:"Failed to get server call Id",code:H,subCode:41057,resultCategories:["UnexpectedClientError"]},VOLUME_TRACK:{message:"failed to getMediaStreamTrack",code:H,subCode:41058,resultCategories:["UnexpectedClientError"]},VOLUME_INIT:{message:"Failed to setup volume calcualtor using AudioContext, please retry getVolumeindicator on a working audio stream with exponential backoff",code:H,subCode:41059,resultCategories:["UnexpectedClientError"]},VOLUME_EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:M,subCode:41060,resultCategories:["ExpectedError"]}),VOLUME_EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe to event ${g}, unknown event name`,code:M,subCode:41061,resultCategories:["ExpectedError"]}),VOLUME_GET:{message:"Failed to setup volume calculator, please retry after exponential backoff",code:H,subCode:41062,resultCategories:["UnexpectedClientError"]},GET_SERVER_CALL_ID:{message:"Failed to get serverCallId, serverCallId is empty",code:N,subCode:41063,resultCategories:["UnexpectedClientError"]},MEDIA_CONSTRAINTS_DISABLED:{message:"Setting call constraints is disabled",code:F,subCode:41064,resultCategories:["ExpectedError"]},SET_CONSTRAINTS_START_OR_ACCEPT:g=>({message:`Error setting call constraints at call ${g}`,code:H,subCode:41065,resultCategories:["UnexpectedClientError"]}),SET_CONSTRAINTS_MID_CALL:{message:"Error setting call constraints during mid-call",code:H,subCode:41066,resultCategories:["UnexpectedClientError"]},SET_CONSTRAINTS:g=>({message:`Error setting video constraints during call stage: ${g}`,code:H,subCode:41067,resultCategories:["UnexpectedClientError"]}),ACCEPT_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call accept",code:H,subCode:41068,resultCategories:["UnexpectedClientError"]},CALLSTART_VIDEO_CONSTRAINTS:{message:"Error setting video constraints during call start",code:H,subCode:41069,resultCategories:["UnexpectedClientError"]},SET_VIDEO_CONSTRAINTS:{message:"Failed to set call constraints during mid call",code:H,subCode:41070,resultCategories:["UnexpectedClientError"]},START_SS_CALL_NOT_CONNECTED:{message:"Failed to start screen sharing. Call must be in connected state",code:U,subCode:41071,resultCategories:["ExpectedError"]},STOP_SS_CALL_NOT_CONNECTED:{message:"Failed to stop screen sharing. Call must be in connected state",code:U,subCode:41072,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_DISABLED:{message:"Accessing raw media stream is currently not enabled",code:U,subCode:41073,resultCategories:["ExpectedError"]},ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC:{message:"The raw media stream function is currently not available",code:H,subCode:41074,resultCategories:["UnexpectedClientError"]},SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA:{message:"Failed to start raw screen sharing, localVideoStream doesn't contain a raw media stream",code:M,subCode:41075,resultCategories:["ExpectedError"]}},LOBBY:{SUBCODE_RANGE:{LOWER_LIMIT:q.LOBBY.LOWER_LIMIT,UPPER_LIMIT:q.LOBBY.UPPER_LIMIT},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:41800,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:41801,resultCategories:["ExpectedError"]}),CONV_UNSUPPORTED:{message:"Current conversation type doesn't support lobby admit and reject",code:M,subCode:41802,resultCategories:["ExpectedError"]},ALREADY_IN_MEETING:g=>({message:`${g} is already in the meeting`,code:M,subCode:41803,resultCategories:["ExpectedError"]}),NOT_IN_LOBBY:g=>({message:`${g} is not in the lobby`,code:M,subCode:41804,resultCategories:["ExpectedError"]}),UNAUTHORIZED_ADMIT_REJECT:{message:"only Organizer, Co-organizer or Presenter can admit/reject participants from lobby",code:O,subCode:41805,resultCategories:["ExpectedError"]}},CTE_MID_TIER_POLICY_SERVICE:{SUBCODE_RANGE:{LOWER_LIMIT:q.CTE_MID_TIER_POLICY_SERVICE.LOWER_LIMIT,UPPER_LIMIT:q.CTE_MID_TIER_POLICY_SERVICE.UPPER_LIMIT},TEAMS_USER_ID_NOT_PROVIDED:{message:"Caller's MicrosoftTeamsUserIdentifier wasn't provided. Fetching Teams user policies and settings cannot proceed",code:M,subCode:41900,resultCategories:["ExpectedError"]},FETCH_POLICY:{message:"Error Fetching Teams user policy from ACS MiddleTier Service",code:H,subCode:41901,resultCategories:["UnexpectedServerError"]},DERIVE_EMERGENCY_POLICY:{message:"Unable to derive emergency policy from ACS MiddleTier Service response",code:H,subCode:41902,resultCategories:["UnexpectedServerError"]},TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch teamsCallingPolicy from ACS MiddleTier Service response",code:H,subCode:41903,resultCategories:["UnexpectedServerError"]},TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED:{message:"Unable to fetch teamsMeetingPolicy from ACS MiddleTier Service response",code:H,subCode:41904,resultCategories:["UnexpectedServerError"]},TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED:{message:"Unable to fetch featureTypes from ACS MiddleTier Service response",code:H,subCode:41905,resultCategories:["UnexpectedServerError"]}},REMOTE_PARTICIPANT:{SUBCODE_RANGE:{LOWER_LIMIT:q.REMOTE_PARTICIPANT.LOWER_LIMIT,UPPER_LIMIT:q.REMOTE_PARTICIPANT.UPPER_LIMIT},MUTE_PARTICIPANT_DISABLED:{message:"Mute other participants disabled.",code:O,subCode:42e3,resultCategories:["ExpectedError"]},MUTE_PARTICIPANT_FAILED:{message:"Failed to mute specific participant",code:H,subCode:42001,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:42002,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe to event ${g}, unknown event name`,code:B,subCode:42003,resultCategories:["ExpectedError"]})},LOCAL_VIDEO_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.LOCAL_VIDEO_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.LOCAL_VIDEO_STREAM.UPPER_LIMIT},SOURCE_UNAVAILABLE:{message:"Video operation failure SourceUnavailableError",code:U,subCode:43e3,resultCategories:["ExpectedError"]},PERMISSION_DENIED:{message:"Video operation failure PermissionDeniedError",code:O,subCode:43001,resultCategories:["ExpectedError"]},UNKNOWN:{message:"Video operation failure UnknownFailureForVideoOperation",code:H,subCode:43002,resultCategories:["UnexpectedClientError"]},WRONG_STREAM_TYPE:{message:"Failed to create local video stream, source was not of type VideoDeviceInfo or MediaStream",code:M,subCode:43003,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to switch source, source was not of type VideoDeviceInfo",code:M,subCode:43004,resultCategories:["ExpectedError"]},SWITCH_SAME_SOURCE:{message:"Unable to switch to the same source",code:M,subCode:43005,resultCategories:["ExpectedError"]},CANT_GET_DEVICE_TYPE:{message:"Unable to get device type",code:H,subCode:43006,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM:{message:"Failed to get media stream",code:H,subCode:43007,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to set media stream source is not MediaStream",code:M,subCode:43008,resultCategories:["ExpectedError"]},SET_MEDIA_STREAM_UNDEFINED_FUNC:{message:"Unable to set media stream",code:H,subCode:43009,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM:{message:"Failed to set media stream",code:H,subCode:43010,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:43011,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:43012,resultCategories:["ExpectedError"]})},REMOTE_VIDEO_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.REMOTE_VIDEO_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.REMOTE_VIDEO_STREAM.UPPER_LIMIT},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:43100,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:43101,resultCategories:["ExpectedError"]}),GET_RAW_MEDIA_STREAM:{message:"Not able to get media stream",code:H,subCode:43102,resultCategories:["UnexpectedClientError"]},STREAM_NOTAVAILABLE:{message:"The stream is currently not availalbe, subscribe to stream.isAvailable property to get notified when it is ready to get media stream",code:M,subCode:43103,resultCategories:["ExpectedError"]},SUBSCRIBE_MEDIA_STREAM_TIMEOUT:{message:"Failed to subscribe to media stream, timeout",code:L,subCode:43104,resultCategories:["UnexpectedClientError"]},GET_TRACK:{message:"Failed to get media stream",code:H,subCode:43105,resultCategories:["UnexpectedClientError"]},TRACK_UNMUTED_TIMEOUT:{message:"Failed to subscribe to media stream, muted",code:L,subCode:43106,resultCategories:["UnexpectedClientError"]},GET_MEDIA_STREAM:{message:"Failed to get raw media stream",code:H,subCode:43107,resultCategories:["UnexpectedClientError"]}},VIEW:{SUBCODE_RANGE:{LOWER_LIMIT:q.VIEW.LOWER_LIMIT,UPPER_LIMIT:q.VIEW.UPPER_LIMIT},ISAVAILABLE_FALSE:{message:"Failed to create view, remote stream is not available",code:U,subCode:43200,resultCategories:["ExpectedError"]},START_ALREADY_DISPOSED:{message:"Failed to start stream, already disposed",code:k,subCode:43201,resultCategories:["ExpectedError"]},STREAM_BECAME_UNAVAILABLE:{message:"Failed to start stream, stream became unavailable",code:N,subCode:43202,resultCategories:["ExpectedError"]},TIMEOUT:{message:"Failed to render stream, timeout",code:L,subCode:43203,resultCategories:["UnexpectedClientError"]},SUBSCRIBE:{message:"Failed to start stream, fail to subscribe",code:H,subCode:43204,resultCategories:["UnexpectedClientError"]},START:{message:"Failed to start stream, internal error",code:H,subCode:43205,resultCategories:["UnexpectedClientError"]},SCALING_MODE:{message:"Failed to updateScalingMode, failed to update",code:H,subCode:43206,resultCategories:["UnexpectedClientError"]},LARGE_MEETING_VIEW_DISPOSED:{message:"Failed to start stream, disposing stream because participant is not a dominant speaker in the large meeting",code:k,subCode:43207,resultCategories:["ExpectedError"]},REMOTE_VIDEO_STREAM_DISPOSED:{message:"Failed to start stream, disposing stream because remote video stream is disposing",code:k,subCode:43208,resultCategories:["ExpectedError"]},APP_VIEW_DISPOSED:{message:"Failed to start stream, disposing stream",code:k,subCode:43209,resultCategories:["ExpectedError"]},RENDERER_DISPOSE_ALREADY_DISPOSED:{message:"Failed to dispose stream, already disposed",code:M,subCode:43210,resultCategories:["ExpectedError"]},REMOTE_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose remote renderer",code:H,subCode:43211,resultCategories:["UnexpectedClientError"]},VIEW_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRendererView, videoStream must be either LocalVideoStream or RemoteVideoStream type",code:M,subCode:43212,resultCategories:["ExpectedError"]},VIEW_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is disposed",code:M,subCode:43213,resultCategories:["ExpectedError"]},RENDER_FAIL_STREAM_DISPOSED:{message:"Failed to render, stream disposed",code:M,subCode:43214,resultCategories:["ExpectedError"]},SCALING_MODE_DISPOSED:{message:"Failed to updateScalingMode, VideoStreamRendererView is disposed",code:M,subCode:43215,resultCategories:["ExpectedError"]},SCALING_MODE_WRONG_VAL:{message:"Failed to updateScalingMode, wrong scalingMode value",code:M,subCode:43216,resultCategories:["ExpectedError"]},DISPOSE_FAIL:{message:"Failed to dispose view",code:H,subCode:43217,resultCategories:["UnexpectedClientError"]},RENDERER_WRONG_STREAM_TYPE:{message:"Failed to create VideoStreamRenderer, videoStream must be either LocalVideoStream or RemoteVideoStreamCommon type",code:M,subCode:43218,resultCategories:["ExpectedError"]},RENDERER_DISPOSED:{message:"Failed to create view, VideoStreamRenderer is disposed",code:M,subCode:43219,resultCategories:["ExpectedError"]},MAX_NUM_OF_VIEWS_REACHED:g=>({message:`Failed to create view, maximum number of ${g} active RemoteVideoStream has been reached`,code:M,subCode:43220,resultCategories:["ExpectedError"]}),CREATE_VIEW_FAILED:{message:"Failed to create view",code:H,subCode:43221,resultCategories:["UnexpectedClientError"]},RENDERER_ALREADY_DISPOSED:{message:"Failed to dispose, VideoStreamRendererView is already disposed",code:M,subCode:43222,resultCategories:["ExpectedError"]},UNKNOWN_STREAM_TYPE:{message:"Unknown stream type",code:M,subCode:43223,resultCategories:["ExpectedError"]},LOCAL_RENDERER_DISPOSE_FAIL:{message:"Failed to dispose local renderer",code:H,subCode:43224,resultCategories:["UnexpectedClientError"]}},LOCAL_AUDIO_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.LOCAL_AUDIO_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.LOCAL_AUDIO_STREAM.UPPER_LIMIT},WRONG_STREAM_TYPE:{message:"Failed to create local audio stream, source is not of type AudioDeviceInfo or MediaStream",code:M,subCode:43600,resultCategories:["ExpectedError"]},SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:M,subCode:43601,resultCategories:["ExpectedError"]},GET_MEDIA_STREAM:{message:"Failed to get media stream source is not AudioDeviceInfo or MediaStream",code:H,subCode:43602,resultCategories:["UnexpectedClientError"]},SET_MEDIA_STREAM_WRONG_TYPE:{message:"Failed to switch stream on local audio, source is not of type MediaStream",code:M,subCode:43603,resultCategories:["ExpectedError"]},SWITCH_SOURCE_WRONG_TYPE:{message:"Failed to create local audio stream, source is not a microphone",code:M,subCode:43604,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:43605,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:43606,resultCategories:["ExpectedError"]})},REMOTE_AUDIO_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.REMOTE_AUDIO_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.REMOTE_AUDIO_STREAM.UPPER_LIMIT}},IDENTIFIER:{SUBCODE_RANGE:{LOWER_LIMIT:q.IDENTIFIER.LOWER_LIMIT,UPPER_LIMIT:q.IDENTIFIER.UPPER_LIMIT},PARSE_PHONENUMBER:{message:"Unable to parse PhoneNumberIdentifier object",code:B,subCode:44e3,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_USER:{message:"Unable to parse MicrosoftTeamsUserIdentifier object",code:B,subCode:44001,resultCategories:["ExpectedError"]},PARSE_MSFT_TEAMS_APP:{message:"Unable to parse MicrosoftTeamsAppIdentifier object",code:B,subCode:44002,resultCategories:["ExpectedError"]},PARSE_IDENTIFIER:{message:"Unable to parse Identifier object, please check the syntax",code:B,subCode:44003,resultCategories:["ExpectedError"]},INVALID_COMM_USER:{message:"Invalid CommunicationUser identifier specified",code:B,subCode:44004,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_RAWID:{message:"Invalid MicrosoftTeamsUser rawId specified",code:B,subCode:44005,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_USER_USERID:{message:"Invalid MicrosoftTeamsUser microsoftTeamsUserId specified",code:B,subCode:44006,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_RAWID:{message:"Invalid MicrosoftTeamsApp rawId specified",code:B,subCode:44007,resultCategories:["ExpectedError"]},INVALID_MSFT_TEAMS_APP_APPID:{message:"Invalid MicrosoftTeamsApp teamsAppId specified",code:B,subCode:44008,resultCategories:["ExpectedError"]},INVALID_UNKNOWN_IDENTIFIER:{message:"Invalid identifier specified, please specify an id",code:B,subCode:44009,resultCategories:["ExpectedError"]},PARSE_INVALID_IDENTIFIER:{message:"Unable to parse Identifier object",code:B,subCode:44010,resultCategories:["ExpectedError"]},INVALID_IDENTIFIER_ARRAY:{message:"AssertIsArrayOfIdentifiers failed. : userIds must be array of CommunicationIdentifier",code:B,subCode:44011,resultCategories:["ExpectedError"]},NO_CLOUD_PREFIX_FOUND:{message:"No cloud prefix found in identity",code:F,subCode:44012,resultCategories:["ExpectedError"]}},INTERNAL:{SUBCODE_RANGE:{LOWER_LIMIT:q.INTERNAL.LOWER_LIMIT,UPPER_LIMIT:q.INTERNAL.UPPER_LIMIT},ECS_CONFIG_EMPTY:{message:"Config is empty",code:H,subCode:44100,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MISSING_ACS:{message:"Missing ACS config key",code:H,subCode:44101,resultCategories:["UnexpectedServerError"]},ECS_CONFIG_MERGING_ERROR:{message:"Error while merging config",code:H,subCode:44102,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE:{message:"Failed to initialize telemetry",code:H,subCode:44103,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED:{message:"Failed to initialize telemetry",code:H,subCode:44104,resultCategories:["UnexpectedClientError"]},TELEMETRY_FAILED_TO_INITIALIZE:g=>({message:`Failed to create and initialize telemetry logger for ${g}`,code:H,subCode:44105,resultCategories:["UnexpectedClientError"]}),TELEMETRY_FAILED_TO_FLUSH:{message:"Failed to flush telemetry",code:H,subCode:44106,resultCategories:["UnexpectedClientError"]},TELEMETRY_LOGGER_INIT_FAIL:{message:"Failed to initialize telemetry logger",code:H,subCode:44107,resultCategories:["UnexpectedClientError"]},NO_TOKEN_PROVIDED:{message:"No CommunicationTokenCredential provided",code:D,subCode:44108,resultCategories:["ExpectedError"]},EMPTY_TOKEN:{message:"AccessToken is empty",code:D,subCode:44109,resultCategories:["ExpectedError"]},GET_TOKEN:{message:"Failed to get AccessToken",code:D,subCode:44110,resultCategories:["UnexpectedClientError"]},TOKEN_PAYLOAD_UNDEFINED:{message:"Invalid token",code:D,subCode:44111,resultCategories:["ExpectedError"]},TOKEN_UNDEFINED:{message:"Failed to parse AccessToken",code:D,subCode:44112,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE:{message:"AccessToken does not contain 'voip' or 'voip.join' scope",code:D,subCode:44113,resultCategories:["ExpectedError"]},INVALID_TOKEN_SCOPE_FORMAT:{message:"Wrong AccessToken scope format. Scope is expected to be a string that contains 'voip'",code:D,subCode:44114,resultCategories:["ExpectedError"]},RESOURCE_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS resource Id",code:D,subCode:44115,resultCategories:["ExpectedError"]},USERID_NOT_FOUND_IN_TOKEN:{message:"AccessToken does not contain ACS user Id",code:D,subCode:44116,resultCategories:["ExpectedError"]},PARSE_TOKEN_FAIL:{message:"Failed to parse AccessToken",code:D,subCode:44117,resultCategories:["UnexpectedClientError"]},OPERATION_TIMEDOUT:{message:"Operation timed out",code:L,subCode:44118,resultCategories:["UnexpectedClientError"]}},FEATURES:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.UPPER_LIMIT},AUDIO_EFFECTS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.AUDIO_EFFECTS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.AUDIO_EFFECTS.UPPER_LIMIT},SET_ECHO_CANCELLATION:g=>({message:`Error while trying to ${g?"start":"stop"} echo cancellation`,code:H,subCode:45e3,resultCategories:["UnexpectedClientError"]}),SET_NOISE_SUPPRESSION:g=>({message:`Error while trying to ${g?"start":"stop"} noise suppression`,code:H,subCode:45001,resultCategories:["UnexpectedClientError"]}),EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:M,subCode:45002,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:M,subCode:45003,resultCategories:["ExpectedError"]}),DISABLED:{message:"Setting audio effects is disabled.",code:O,subCode:45004,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:M,subCode:45005,resultCategories:["ExpectedError"]},SOURCE_UNSUPPORTED:{message:"Current source is not supported",code:V,subCode:45006,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:H,subCode:45007,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"Audio effects feature is disposed. Create a new AudioEffects feature instance.",code:M,subCode:45008,resultCategories:["ExpectedError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:H,subCode:45009,resultCategories:["UnexpectedClientError"]},FAILED_TO_GET_DM:{message:"Internal error - DM missing",code:H,subCode:45010,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:H,subCode:45011,resultCategories:["UnexpectedClientError"]},AEC_PROVIDER_MISSING:{message:"Internal error - stack aec provider missing",code:H,subCode:45012,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:M,subCode:45013,resultCategories:["ExpectedError"]},INVALID_EFFECT_ECHO:{message:"Invalid or no echo cancellation effect provided",code:M,subCode:45014,resultCategories:["ExpectedError"]},INVALID_EFFECT_NOISE_SUPP:{message:"Invalid or no noise suppression effect provided",code:M,subCode:45015,resultCategories:["ExpectedError"]},UNSUPPORTED_EFFECT:g=>({message:`${g} is not supported.`,code:V,subCode:45016,resultCategories:["UnexpectedClientError"]}),SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:$,subCode:45017,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT_GAINCONTROL:{message:"Invalid or no auto gain control effect provided",code:M,subCode:45018,resultCategories:["ExpectedError"]},SET_AUTO_GAIN_CONTROL:g=>({message:`Error while trying to ${g?"start":"stop"} auto gain control`,code:H,subCode:45019,resultCategories:["UnexpectedClientError"]}),AUDIO_FLAGS:{message:"Error setting browser audio processing flags",code:H,subCode:45020,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting audio effects.",code:H,subCode:45021,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping audio effects.",code:H,subCode:45022,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing audio effects feature.",code:H,subCode:45023,resultCategories:["UnexpectedClientError"]}},AUDIO_ZONES:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.AUDIO_ZONES.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.AUDIO_ZONES.UPPER_LIMIT}},CALL_SURVEY:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.CALL_SURVEY.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.CALL_SURVEY.UPPER_LIMIT},INVALID_SURVEY:g=>({message:`${g}.`,code:M,subCode:45100,resultCategories:["ExpectedError"]}),SUBMIT_TIMEOUT:{message:"Please try again.",code:L,subCode:45101,resultCategories:["UnexpectedClientError"]}},CAPABILITIES:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.CAPABILITIES.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.CAPABILITIES.UPPER_LIMIT}},CAPTIONS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.CAPTIONS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.CAPTIONS.UPPER_LIMIT},INITIALIZE:{message:"Failed to initialize Captions.",code:H,subCode:45200,resultCategories:["UnexpectedClientError"]},DISABLED:{message:"Feature is not enabled.",code:U,subCode:45201,resultCategories:["ExpectedError"]},SPOKEN_LANG_UNSUPPORTED:{message:"Spoken language requested is not supported.",code:M,subCode:45202,resultCategories:["ExpectedError"]},MEETING_POLICY_DISABLED:{message:"Captions feature is disabled in meeting policy.",code:O,subCode:45203,resultCategories:["ExpectedError"]},CALLING_POLICY_DISABLED:{message:"Captions feature is disabled in calling policy.",code:O,subCode:45204,resultCategories:["ExpectedError"]},START_FAILED:{message:"Could not start captions.",code:H,subCode:45205,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_NOT_STARTED:{message:"Cannot update spoken language as captions has not started.",code:M,subCode:45206,resultCategories:["ExpectedError"]},SPOKEN_LANG_DISABLED:{message:"Set spoken language is not enabled.",code:U,subCode:45207,resultCategories:["ExpectedError"]},UPDATE_LANGUAGE_GET_TOKEN:{message:"Unable to update spoken language. Failed to get token.",code:D,subCode:45208,resultCategories:["UnexpectedClientError"]},UPDATE_LANGUAGE_FAILED:{message:"Unable to update spoken language.",code:H,subCode:45209,resultCategories:["UnexpectedClientError"]},UPDATE_CAPTIONS_NOT_STARTED:{message:"Cannot update caption language as captions has not started.",code:M,subCode:45210,resultCategories:["ExpectedError"]},CAPTIONS_LANG_DISABLED:{message:"Set caption language is not enabled.",code:U,subCode:45211,resultCategories:["ExpectedError"]},CAPTIONS_LANG_TEAMS_LICENSE:{message:"Set caption language failed. Teams premium license is needed to use this feature.",code:D,subCode:45212,resultCategories:["ExpectedError"]},CAPTIONS_LANG_UNSUPPORTED:{message:"Caption language requested is not supported.",code:M,subCode:45213,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_GET_TOKEN:{message:"Null token",code:D,subCode:45214,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_FAILED:{message:"Unable to update caption language.",code:H,subCode:45215,resultCategories:["UnexpectedClientError"]},CTE_POLICY_FETCH_FAIL:{message:"Failed to fetch policy for Teams Captions.",code:H,subCode:45216,resultCategories:["UnexpectedClientError"]},ALREADY_ACTIVE:{message:"Captions already active",code:M,subCode:45217,resultCategories:["ExpectedError"]},STOP_NOT_ACTIVE:{message:"Captions feature is not active.",code:M,subCode:45218,resultCategories:["ExpectedError"]},ALREADY_STARTING:{message:"Operation in progress",code:M,subCode:45219,resultCategories:["ExpectedError"]},SPOKEN_LANGUAGE_ALREADY_SET:{message:"Spoken language already set",code:M,subCode:45220,resultCategories:["ExpectedError"]},UPDATE_CAPTIONS_NOT_ACTIVE:{message:'"Unable to update caption language as Captions is not active.',code:M,subCode:45221,resultCategories:["ExpectedError"]},CAPTIONS_LANG_ALREADY_SET:{message:"Caption language already set.",code:M,subCode:45222,resultCategories:["ExpectedError"]}},COMPOSSED_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.COMPOSSED_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.COMPOSSED_STREAM.UPPER_LIMIT}},DATA_CHANNEL:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.DATA_CHANNEL.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.DATA_CHANNEL.UPPER_LIMIT},DISPOSED:{message:"DataChannel has been disposed",code:H,subCode:45300,resultCategories:["UnexpectedClientError"]},SENDER_NOT_READY:{message:"Sender is not ready",code:H,subCode:45301,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_CHANNEL_ID:{message:"No available channel id",code:H,subCode:45302,resultCategories:["UnexpectedClientError"]},INVALID_CHANNEL_ID:{message:"Invalid channel id",code:M,subCode:45303,resultCategories:["ExpectedError"]},INVALID_BITRATE_IN_KBPS:{message:"Invalid bitrateInKbps",code:M,subCode:45304,resultCategories:["ExpectedError"]},INVALID_PARTICIPANTS:{message:"Invalid participants",code:M,subCode:45305,resultCategories:["ExpectedError"]},TOO_MANY_PARTICIPANTS:{message:"Too many participants",code:M,subCode:45306,resultCategories:["ExpectedError"]},NO_VALID_PARTICIPANT:{message:"No valid participant",code:M,subCode:45307,resultCategories:["ExpectedError"]},MSG_DATA_EMPTY:{message:"Message data is empty",code:M,subCode:45308,resultCategories:["ExpectedError"]},MSG_DATA_TOO_LARGE:{message:"The size of message data is too large",code:M,subCode:45309,resultCategories:["ExpectedError"]},INVALID_MSG_LENGTH:{message:"Invalid message length",code:H,subCode:45310,resultCategories:["UnexpectedClientError"]},BUFFER_FULL:{message:"The buffer is full. Please wait and try again",code:H,subCode:45311,resultCategories:["UnexpectedClientError"]},SENDER_CLOSED:{message:"The sender has been closed",code:M,subCode:45312,resultCategories:["ExpectedError"]},NO_AVAILABLE_RELIABLE_CHANNEL:{message:"Currently there is no available reliable channel",code:H,subCode:45313,resultCategories:["UnexpectedClientError"]},NO_AVAILABLE_UNRELIABLE_CHANNEL:{message:"Currently there is no available unreliable channel",code:H,subCode:45314,resultCategories:["UnexpectedClientError"]},CHANNEL_ALREADY_ALLOCATED:{message:"Unable allocate the channel because a channel with the same channelId has already been allocated",code:H,subCode:45315,resultCategories:["UnexpectedClientError"]},INVALID_BITRATE:{message:"Invalid bitrate",code:M,subCode:45316,resultCategories:["ExpectedError"]},TRAFFIC_LIMITED:{message:"Traffic is limited",code:M,subCode:45317,resultCategories:["ExpectedError"]},SEND_FAIL:{message:"Failed to send message.",code:H,subCode:45318,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:(g,m)=>({message:`Not able to ${g} subscribe to event ${m}, unknown event name`,code:B,subCode:45319,resultCategories:["ExpectedError"]}),WRONG_ARGUMENT_TYPE:(g,m)=>({message:`TypeError: Expect '${g}' to be of type '${m}'`,code:M,subCode:45320,resultCategories:["ExpectedError"]}),WRONG_ARGUMENT_VALUE:(g,m)=>({message:`ValueError: Expect '${g}' to be ${m}`,code:M,subCode:45321,resultCategories:["ExpectedError"]}),CANT_FIND_CHANNEL_ID:g=>({message:`Cannot find the channelId ${g}`,code:M,subCode:45322,resultCategories:["ExpectedError"]}),FAILED_TO_CREATE_SENDER:{message:"Failed to create the sender.",code:H,subCode:45323,resultCategories:["UnexpectedClientError"]}},DEBUG_INFO:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.DEBUG_INFO.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.DEBUG_INFO.UPPER_LIMIT}},DIAGNOSTICS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.DIAGNOSTICS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.DIAGNOSTICS.UPPER_LIMIT},INCORRECT_VALUETYPE_MAPPED:(g,m,f)=>({message:`Mapped to an incorrect value type=${typeof m}, diagnostic value=${m}, for diagnostic ${f}`,code:H,subCode:45400,resultCategories:["UnexpectedClientError"]}),EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:45401,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:45402,resultCategories:["ExpectedError"]}),INCORRECT_VALUE_MAPPED:(g,m)=>({message:`Cannot map ts quality level ${g} for ${m}`,code:H,subCode:45403,resultCategories:["UnexpectedClientError"]})},DOMINANT_SPEAKER:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.DOMINANT_SPEAKER.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.DOMINANT_SPEAKER.UPPER_LIMIT}},LIVE_STREAM:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.LIVE_STREAM.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.LIVE_STREAM.UPPER_LIMIT},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:45500,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:45501,resultCategories:["ExpectedError"]}),INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:M,subCode:45502,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:M,subCode:45503,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:M,subCode:45504,resultCategories:["ExpectedError"]}},LOCAL_RECORDING:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.LOCAL_RECORDING.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.LOCAL_RECORDING.UPPER_LIMIT},ONLY_AVAILABLE_IN_MEETINGS:{message:"Local Recording feature is only available in meetings",code:M,subCode:46200,resultCategories:["ExpectedError"]},DISABLED:{message:"Local Recording feature is disabled",code:k,subCode:46201,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:46202,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:46203,resultCategories:["ExpectedError"]})},MEDIA_STATS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.MEDIA_STATS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.MEDIA_STATS.UPPER_LIMIT},INVALID_AGGREGATION_INTERVAL_RANGE:{message:"Invalid aggregationInterval value range.",code:M,subCode:45550,resultCategories:["ExpectedError"]},INVALID_DATAPOINTS_AGGREGATION_RANGE:{message:"invalid dataPointsPerAggregation value range.",code:M,subCode:45551,resultCategories:["ExpectedError"]},DISPOSED:{message:"MediaStatsCallFeature has been disposed.",code:M,subCode:45552,resultCategories:["ExpectedError"]}},OPTIMAL_VIDEO_COUNT:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.OPTIMAL_VIDEO_COUNT.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.OPTIMAL_VIDEO_COUNT.UPPER_LIMIT},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:45600,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:45601,resultCategories:["ExpectedError"]})},PPTLIVE:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.PPTLIVE.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.PPTLIVE.UPPER_LIMIT}},PRECALL_DIAGNOSTICS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.PRECALL_DIAGNOSTICS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.PRECALL_DIAGNOSTICS.UPPER_LIMIT},SET_DEVICE_FAIL:{message:"Failed to set default microphone or speaker with error",code:U,subCode:45700,resultCategories:["UnexpectedClientError"]},GET_DIAGNOSTICS_INFO:{message:"Unable to return call diagnostic information.",code:H,subCode:45701,resultCategories:["UnexpectedClientError"]},VIDEO_STREAM_TIMEOUT:{message:"Timeout in checking media stream status",code:H,subCode:45702,resultCategories:["UnexpectedClientError"]},GET_CALL_AGENT:{message:"Failed to get existing call agent or create a new one",code:H,subCode:45703,resultCategories:["UnexpectedClientError"]},CONNECT_FAIL:{message:"Test call failed to connect",code:H,subCode:45704,resultCategories:["UnexpectedClientError"]},RENDER_VIDEO:{message:"Call failed to render video.",code:H,subCode:45705,resultCategories:["UnexpectedClientError"]},HANGUP_FAIL:{message:"Test call failed hang up the call",code:H,subCode:45706,resultCategories:["UnexpectedClientError"]},VIDEO_MEDIASTATS:{message:"Failed to get video call media stats",code:H,subCode:45707,resultCategories:["UnexpectedClientError"]},CALL_CONNECT_TIMEOUT:g=>({message:`Call timeout after ${g}`,code:L,subCode:45708,resultCategories:["UnexpectedClientError"]})},RAISE_HAND:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.RAISE_HAND.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.RAISE_HAND.UPPER_LIMIT},INITIALIZE:{message:"Could not initialize raise hand feature.",code:H,subCode:45750,resultCategories:["UnexpectedClientError"]},RAISE_HAND_PUBLISH_STATE:{message:"Could not change a participant state.",code:H,subCode:45751,resultCategories:["UnexpectedServerError"]},RAISE_HAND_FAIL:{message:"Could not change a participant state.",code:H,subCode:45752,resultCategories:["UnexpectedServerError"]},LOWER_HAND_FAIL:{message:"Could not change a participant state.",code:H,subCode:45753,resultCategories:["UnexpectedServerError"]},LOWER_REMOTEPARTICIPANTS_HANDS_FAIL:{message:"Could not change a participant state.",code:H,subCode:45754,resultCategories:["UnexpectedServerError"]},LOWER_ALL_HANDS_FAIL:{message:"Could not change a participant state.",code:H,subCode:45755,resultCategories:["UnexpectedServerError"]}},REACTION:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.REACTION.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.REACTION.UPPER_LIMIT},CALL_NOT_CONNECTED:{message:"Call is not connected yet to send reaction",code:M,subCode:45800,resultCategories:["ExpectedError"]},NOT_SUPPORTED_1TO1_CTE:{message:"Reaction send is not supported for 1:1 direct calling with teams identity",code:M,subCode:45801,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE_FAIL_POLICY:{message:"Unable to register listener due to meeting policy",code:O,subCode:45802,resultCategories:["ExpectedError"]},EVENT_UNSUBSCRIBE_FAIL_POLICY:{message:"Unable to deregister listener due to meeting policy",code:O,subCode:45803,resultCategories:["ExpectedError"]},SEND_FAIL_POLICY:{message:"Unable to send reaction due to meeting policy",code:O,subCode:45804,resultCategories:["ExpectedError"]},STATE_SERVICE_CONNECT_FAIL:{message:"Could not create state service proxy web-socket connection",code:H,subCode:45805,resultCategories:["UnexpectedServerError"]},MAP_CREATE_FAIL:{message:"Could not create sync map to exchange reaction",code:H,subCode:45806,resultCategories:["UnexpectedServerError"]},NOT_INIT_YET:{message:"Unable to handle send reaction",code:M,subCode:45807,resultCategories:["ExpectedError"]},SEND_REACTION_FAIL:{message:"Unable to handle send reaction",code:H,subCode:45808,resultCategories:["UnexpectedClientError"]},RECEIVE_REACTION_FAIL:{message:"Unable to parse reaction",code:H,subCode:45809,resultCategories:["UnexpectedClientError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:45810,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:45811,resultCategories:["ExpectedError"]})},RECORDING:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.RECORDING.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.RECORDING.UPPER_LIMIT},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:B,subCode:45850,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:B,subCode:45851,resultCategories:["ExpectedError"]})},SPOTLIGHT:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.SPOTLIGHT.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.SPOTLIGHT.UPPER_LIMIT},ALREADY_SPOTLIGHTED:{message:"Bad request. All participants are already spotlighted",code:M,subCode:45900,resultCategories:["ExpectedError"]},START_SPOTLIGHT_FAILED:{message:"Internal Error. Start spotlight for participants failed",code:H,subCode:45901,resultCategories:["UnexpectedServerError"]},SPOTLIGHT_LIGHT_MAX_REACHED:g=>({message:`startSpotlight failed. ${g} is the max number of participants that can be Spotlighted`,code:M,subCode:45902,resultCategories:["ExpectedError"]}),UNSUPPORTED_ROLE_TYPE:(g,m)=>({message:`${g} spotlight failed. User does not have a Presenter or Organizer role in ${m}`,code:O,subCode:45903,resultCategories:["ExpectedError"]})},TEAMS_MEETING_AUDIO_CONFERENCING:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UPPER_LIMIT},ONLY_AVAILABLE_IN_MEETINGS:{message:"Teams meeting audio conferencing feature is only available in meetings",code:M,subCode:45950,resultCategories:["ExpectedError"]},DISABLED:{message:"Teams meeting audio conferencing details feature is disabled",code:k,subCode:45951,resultCategories:["ExpectedError"]},UNAVAILABLE_BEFORE_JOINING:{message:"Teams meeting audio conferencing details are not available before joining the Teams meeting",code:M,subCode:45952,resultCategories:["ExpectedError"]},UNVAILABLE_IN_LOBBY:{message:"Teams meeting audio conferencing details are not available in Lobby",code:M,subCode:45953,resultCategories:["ExpectedError"]},DETAILS_NOT_CONFIGURED:{message:"Teams meeting audio conferencing details is not configured",code:M,subCode:45954,resultCategories:["UnexpectedClientError"]},GET_DETAILS_FAILED:{message:"Error retrieving Teams meeting audio conferencing details",code:H,subCode:45955,resultCategories:["UnexpectedServerError"]}},TRANSCRIPTION:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.TRANSCRIPTION.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.TRANSCRIPTION.UPPER_LIMIT}},TRANSFER:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.TRANSFER.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.TRANSFER.UPPER_LIMIT},TRANSFER_TO_TARGET_FAILED:{message:"Transfer to target failed",code:H,subCode:46050,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_CALL_TYPE:{message:"Transfer is not supported in this call",code:M,subCode:46051,resultCategories:["ExpectedError"]},TARGET_NOT_RECOGNIZED:{message:"Transfer target is not recognized.",code:M,subCode:46052,resultCategories:["ExpectedError"]},INVALID_TARGET_TYPE:g=>({message:`Invalid target participant type detected:${g}.`,code:M,subCode:46053,resultCategories:["ExpectedError"]})},UNMIXED_AUDIO:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.UNMIXED_AUDIO.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.UNMIXED_AUDIO.UPPER_LIMIT},UNAVAILABLE:{message:"UnmixedAudio is not available.",code:H,subCode:46100,resultCategories:["UnexpectedClientError"]},PENDING_OPERATION:{message:"The operation cannot be done because there is a pending operation",code:M,subCode:46101,resultCategories:["ExpectedError"]},UNSUPPORTED_OPERATION:{message:"The operation is not supported in peer-to-peer call",code:M,subCode:46102,resultCategories:["ExpectedError"]},ENABLED:{message:"Unmixed audio has been enabled",code:M,subCode:46103,resultCategories:["ExpectedError"]},DISABLED:{message:"Unmixed audio has been disabled",code:M,subCode:46104,resultCategories:["ExpectedError"]},DISPOSED:{message:"Unmixed audio has been disposed",code:M,subCode:46105,resultCategories:["ExpectedError"]},EVENT_SUBSCIBE_UNSUBSCRIBE:(g,m)=>({message:`Unable to ${g} to event ${m}, unknown event name`,code:B,subCode:46106,resultCategories:["ExpectedError"]}),WRONG_ARGUMENT_TYPE:(g,m)=>({message:`TypeError: Expect '${g}' to be of type '${m}'`,code:M,subCode:46107,resultCategories:["ExpectedError"]}),WRONG_ARGUMENT_VALUE:(g,m)=>({message:`ValueError: Expect '${g}' to be ${m}`,code:M,subCode:46108,resultCategories:["ExpectedError"]}),INVALID_STATE:g=>({message:`Invalid state: ${g}`,code:M,subCode:46109,resultCategories:["ExpectedError"]}),UNKNOWN_ERROR:{message:"Unknown error",code:H,subCode:46110,resultCategories:["UnexpectedClientError"]},FAILED_TO_ENABLE:(g,m)=>({message:`Failed to enable unmixed audio: AudioContext=${g}, UnmixedAudio=${m}`,code:H,subCode:46111,resultCategories:["UnexpectedClientError"]}),FAILED_TO_DISABLE:(g,m)=>({message:`Failed to disable unmixed audio: AudioContext=${g}, UnmixedAudio=${m}`,code:H,subCode:46112,resultCategories:["UnexpectedClientError"]}),FAILED_TO_INITIALIZE:{message:"Failed to initialize unmixed audio.",code:H,subCode:46113,resultCategories:["UnexpectedClientError"]}},VIDEO_EFFECTS:{SUBCODE_RANGE:{LOWER_LIMIT:q.FEATURES.VIDEO_EFFECTS.LOWER_LIMIT,UPPER_LIMIT:q.FEATURES.VIDEO_EFFECTS.UPPER_LIMIT},DISABLED:{message:"Disabled.",code:O,subCode:46150,resultCategories:["ExpectedError"]},START_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:M,subCode:46151,resultCategories:["ExpectedError"]},UNSUPPORTED_SOURCE:{message:"Current source is unsupported to use effects",code:V,subCode:46152,resultCategories:["ExpectedError"]},START_DEVICE_MANAGER:{message:"Failed to get device manager to start effects.",code:H,subCode:46153,resultCategories:["UnexpectedClientError"]},PROVIDER_UNAVAILABLE:{message:"EffectProvider not available",code:H,subCode:46154,resultCategories:["UnexpectedClientError"]},WEBCV_PROVIDER_FAILED:{message:"Failed to get WebCV provider.",code:H,subCode:46155,resultCategories:["UnexpectedClientError"]},UNSUPPORTED_EFFECT:{message:"Effect is not supported.",code:$,subCode:46156,resultCategories:["UnexpectedClientError"]},STOP_DISPOSED:{message:"VideoEffects feature is disposed. Create a new VideoEffects Feature instance.",code:M,subCode:46157,resultCategories:["UnexpectedClientError"]},STOP_DEVICE_MANAGER:{message:"Failed to get device manager to stop effects.",code:H,subCode:46158,resultCategories:["UnexpectedClientError"]},INVALID_EFFECT:{message:"Invalid effect provided",code:M,subCode:46159,resultCategories:["ExpectedError"]},EVENT_SUBSCRIBE:g=>({message:`Not able to subscribe to event ${g}, unknown event name`,code:M,subCode:46160,resultCategories:["ExpectedError"]}),EVENT_UNSUBSCRIBE:g=>({message:`Not able to unsubscribe event ${g}, unknown event name`,code:M,subCode:46161,resultCategories:["ExpectedError"]}),EFFECT_PROVIDER_TIMEOUT:{message:"Timed promise; rejected.",code:L,subCode:46162,resultCategories:["UnexpectedClientError"]},SUPPORT_CHECK_FAILED:{message:"Error while checking support",code:$,subCode:46163,resultCategories:["UnexpectedClientError"]},START_FAILED:{message:"Error starting video effects",code:H,subCode:46164,resultCategories:["UnexpectedClientError"]},STOP_FAILED:{message:"Error stopping video effects",code:H,subCode:46165,resultCategories:["UnexpectedClientError"]},DISPOSE_FAILED:{message:"Error disposing video effects feature",code:H,subCode:46166,resultCategories:["UnexpectedClientError"]}}}};class CallingCommunicationError extends Error{constructor(g,m){if(super(),this._code=0,this._subCode=0,this._resultCategories=[],this.name="CallingCommunicationError",m instanceof CallingCommunicationError)return this._code=m.code,this._subCode=m.subCode,this._resultCategories=m.resultCategories,this.message=m.message,void(this.stack=m.stack);this.message=g.message,this._code=g.code,this._subCode=g.subCode,this._resultCategories=g.resultCategories,m instanceof Error&&(this.stack=m.stack)}get code(){return this._code}get subCode(){return this._subCode}get resultCategories(){return this._resultCategories}}const K=Symbol("loggerKeySymbol");var J,Y,Q;function syncOperation(g){return operationDecoratorFactory(g||"",!1)}function asyncOperation(g){return operationDecoratorFactory(g||"",!0)}!function(g){g.CallAgent="CallAgent",g.TeamsCallAgent="TeamsCallAgent"}(J||(J={})),function(g){g.Call="Call",g.TeamsCall="TeamsCall"}(Y||(Y={})),function(g){g.IncomingCall="IncomingCall",g.TeamsIncomingCall="TeamsIncomingCall"}(Q||(Q={}));const validateEmergencyCallOperation=g=>(m,f,S)=>{const v=S.value;return S.value=function(...m){if(this.kind===Y.TeamsCall&&this.isEmergencyCallInProgress())throw new CallingCommunicationError(z.CALL.OPERATION_NOT_ALLOWED_DURING_EMERGENCY_CALL(g));return v.apply(this,m)},S},operationDecoratorFactory=(g,m)=>m?(m,f,S)=>{const v=S.value;return S.value=async function(...m){let f;const S=+new Date;tryToLogAcsMessage(this,g,"started");try{f=await v.apply(this,m),tryToLogAcsMessage(this,g,"succeeded",S)}catch(m){const f=new CallingCommunicationError(z.CALL.OPERATION_FAILED(g),m);throw tryToLogAcsError(this,g,m,S),f}return f},S}:(m,f,S)=>{const v=S.value;return S.value=function(...m){let f;const S=+new Date;tryToLogAcsMessage(this,g,"started");try{f=v.apply(this,m),tryToLogAcsMessage(this,g,"succeeded",S)}catch(m){const f=new CallingCommunicationError(z.CALL.OPERATION_FAILED(g),m);throw tryToLogAcsError(this,g,m,S),f}return f},S};function tryToLogAcsMessage(g,m,f,S){const v=getAcsLogger(g);if(v){const g=S?`in ${(+new Date-S)/1e3}s`:"";v.info(`op:${m}, ${f} ${g}`)}}function tryToLogAcsError(g,m,f,S){const v=getAcsLogger(g);try{if(v){const g=S?`in ${(+new Date-S)/1e3}s`:"";v.error(`op:${m} failed, message=${f.message}, code=${f.code}${f.subCode?`, subCode=${f.subCode}`:""} ${g}`),f&&v.error(`op:${m} failed, message=${f.message}, code=${f.code}, subCode=${f.subCode}, resultCategories=${f.resultCategories}, time elapsed=${g}`)}}catch(f){}}function getAcsLogger(g){try{const m=Reflect.getMetadata(K,g);if(m)return g[m]}catch(g){}}function generateGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(g=>{const m=16*Math.random()|0;return("x"===g?m:3&m|8).toString(16)}))}var X="function",Z="object",ee="undefined",te="prototype",ie="hasOwnProperty",ne=Object,re=ne[te],se=ne.assign,ae=ne.create,oe=ne.defineProperty,le=re[ie];function getGlobal(){return typeof globalThis!==ee&&globalThis?globalThis:typeof self!==ee&&self?self:typeof window!==ee&&window?window:typeof global!==ee&&global?global:null}function throwTypeError(g){throw new TypeError(g)}function objCreateFn(g){if(ae)return ae(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==Z&&m!==X&&throwTypeError("Object prototype may only be an Object:"+g),tmpFunc[te]=g,new tmpFunc}(getGlobal()||{}).Symbol,(getGlobal()||{}).Reflect;var __objAssignFnImpl=function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])re[ie].call(m,v)&&(g[v]=m[v]);return g},ce=se||__objAssignFnImpl,extendStaticsFn=function(g,m){return extendStaticsFn=ne.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m[ie](f)&&(g[f]=m[f])},extendStaticsFn(g,m)};function __extendsFn(g,m){function __(){this.constructor=g}typeof m!==X&&null!==m&&throwTypeError("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn(g,m),g[te]=null===m?objCreateFn(m):(__[te]=m[te],new __)}var de,he={Unknown:0,NonRetryableStatus:1,InvalidEvent:2,SizeLimitExceeded:3,KillSwitch:4,QueueFull:5},ue="undefined",ge="constructor",pe="prototype",me="function",fe="_dynInstFuncs",Se="_isDynProxy",ve="_dynClass",ye="_dynCls$",Ce="_dynInstChk",_e=Ce,Ee="_dfOpts",Te="_unknown_",Ie="__proto__",be="_dyn"+Ie,Ae="__dynProto$Gbl",Pe="_dynInstProto",Re="useBaseInst",we="setInstFuncs",Me=Object,De=Me.getPrototypeOf,Oe=Me.getOwnPropertyNames;
/*!
 * Microsoft Dynamic Proto Utility, 1.1.9
 * Copyright (c) Microsoft and contributors. All rights reserved.
 */function _getGlobal(){var g;return typeof globalThis!==ue&&(g=globalThis),g||typeof self===ue||(g=self),g||typeof window===ue||(g=window),g||typeof global===ue||(g=global),g||{}}var Ne,ke=_getGlobal(),Le=ke[Ae]||(ke[Ae]={o:(de={},de[we]=!0,de[Re]=!0,de),n:1e3});function _hasOwnProperty(g,m){return g&&Me[pe].hasOwnProperty.call(g,m)}function _isObjectOrArrayPrototype(g){return g&&(g===Me[pe]||g===Array[pe])}function _isObjectArrayOrFunctionPrototype(g){return _isObjectOrArrayPrototype(g)||g===Function[pe]}function _getObjProto(g){var m;if(g){if(De)return De(g);var f=g[Ie]||g[pe]||(g[ge]?g[ge][pe]:null);m=g[be]||f,_hasOwnProperty(g,be)||(delete g[Pe],m=g[be]=g[Pe]||g[be],g[Pe]=f)}return m}function _forEachProp(g,m){var f=[];if(Oe)f=Oe(g);else for(var S in g)"string"==typeof S&&_hasOwnProperty(g,S)&&f.push(S);if(f&&f.length>0)for(var v=0;v<f.length;v++)m(f[v])}function _isDynamicCandidate(g,m,f){return m!==ge&&typeof g[m]===me&&(f||_hasOwnProperty(g,m))}function _throwTypeError(g){throw new TypeError("DynamicProto: "+g)}function _getInstanceFuncs(g){var m={};return _forEachProp(g,(function(f){!m[f]&&_isDynamicCandidate(g,f,!1)&&(m[f]=g[f])})),m}function _hasVisited(g,m){for(var f=g.length-1;f>=0;f--)if(g[f]===m)return!0;return!1}function _getBaseFuncs(g,m,f,S){function _instFuncProxy(g,m,f){var v=m[f];if(v[Se]&&S){var C=g[fe]||{};!1!==C[_e]&&(v=(C[m[ve]]||{})[f]||v)}return function(){return v.apply(g,arguments)}}var v={};_forEachProp(f,(function(g){v[g]=_instFuncProxy(m,f,g)}));for(var C=_getObjProto(g),_=[];C&&!_isObjectArrayOrFunctionPrototype(C)&&!_hasVisited(_,C);)_forEachProp(C,(function(g){!v[g]&&_isDynamicCandidate(C,g,!De)&&(v[g]=_instFuncProxy(m,C,g))})),_.push(C),C=_getObjProto(C);return v}function _getInstFunc(g,m,f,S){var v=null;if(g&&_hasOwnProperty(f,ve)){var C=g[fe]||{};if((v=(C[f[ve]]||{})[m])||_throwTypeError("Missing ["+m+"] "+me),!v[Ce]&&!1!==C[_e]){for(var _=!_hasOwnProperty(g,m),E=_getObjProto(g),T=[];_&&E&&!_isObjectArrayOrFunctionPrototype(E)&&!_hasVisited(T,E);){var I=E[m];if(I){_=I===S;break}T.push(E),E=_getObjProto(E)}try{_&&(g[m]=v),v[Ce]=1}catch(g){C[_e]=!1}}}return v}function _getProtoFunc(g,m,f){var S=m[g];return S===f&&(S=_getObjProto(m)[g]),typeof S!==me&&_throwTypeError("["+g+"] is not a "+me),S}function _populatePrototype(g,m,f,S,v){function _createDynamicPrototype(g,m){var dynProtoProxy=function(){return(_getInstFunc(this,m,g,dynProtoProxy)||_getProtoFunc(m,g,dynProtoProxy)).apply(this,arguments)};return dynProtoProxy[Se]=1,dynProtoProxy}if(!_isObjectOrArrayPrototype(g)){var C=f[fe]=f[fe]||{},_=C[m]=C[m]||{};!1!==C[_e]&&(C[_e]=!!v),_forEachProp(f,(function(m){_isDynamicCandidate(f,m,!1)&&f[m]!==S[m]&&(_[m]=f[m],delete f[m],(!_hasOwnProperty(g,m)||g[m]&&!g[m][Se])&&(g[m]=_createDynamicPrototype(g,m)))}))}}function _checkPrototype(g,m){if(De){for(var f=[],S=_getObjProto(m);S&&!_isObjectArrayOrFunctionPrototype(S)&&!_hasVisited(f,S);){if(S===g)return!0;f.push(S),S=_getObjProto(S)}return!1}return!0}function _getObjName(g,m){return _hasOwnProperty(g,pe)?g.name||m||Te:((g||{})[ge]||{}).name||m||Te}function dynamicProto(g,m,f,S){_hasOwnProperty(g,pe)||_throwTypeError("theClass is an invalid class definition.");var v=g[pe];_checkPrototype(v,m)||_throwTypeError("["+_getObjName(g)+"] not in hierarchy of ["+_getObjName(m)+"]");var C=null;_hasOwnProperty(v,ve)?C=v[ve]:(C=ye+_getObjName(g,"_")+"$"+Le.n,Le.n++,v[ve]=C);var _=dynamicProto[Ee],E=!!_[Re];E&&S&&void 0!==S[Re]&&(E=!!S[Re]);var T=_getInstanceFuncs(m);f(m,_getBaseFuncs(v,m,T,E));var I=!!De&&!!_[we];I&&S&&(I=!!S[we]),_populatePrototype(v,C,m,T,!1!==I)}dynamicProto[Ee]=Le.o,function(g){g[g.CRITICAL=1]="CRITICAL",g[g.WARNING=2]="WARNING"}(Ne||(Ne={}));var Fe={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},xe="on",Ue="attachEvent",Ve="addEventListener",Be="detachEvent",He="removeEventListener",$e=oe;function objToString(g){return re.toString.call(g)}function isUndefined(g){return void 0===g||typeof g===ee}function isNullOrUndefined(g){return null===g||isUndefined(g)}function isNotNullOrUndefined(g){return!isNullOrUndefined(g)}function hasOwnProperty(g,m){return g&&le.call(g,m)}function isObject(g){return typeof g===Z}function isFunction(g){return typeof g===X}function attachEvent(g,m,f,S){void 0===S&&(S=!1);var v=!1;if(!isNullOrUndefined(g))try{isNullOrUndefined(g[Ve])?isNullOrUndefined(g[Ue])||(g[Ue](xe+m,f),v=!0):(g[Ve](m,f,S),v=!0)}catch(g){}return v}function detachEvent(g,m,f,S){if(void 0===S&&(S=!1),!isNullOrUndefined(g))try{isNullOrUndefined(g[He])?isNullOrUndefined(g[Be])||g[Be](xe+m,f):g[He](m,f,S)}catch(g){}}function objForEachKey(g,m){if(g)for(var f in g)le.call(g,f)&&m.call(g,f,g[f])}function strEndsWith(g,m){if(g&&m){var f=m.length,S=g.length;if(g===m)return!0;if(S>=f){for(var v=S-1,C=f-1;C>=0;C--){if(g[v]!=m[C])return!1;v--}return!0}}return!1}function strStartsWith(g,m){var f=!1;if(g&&m){var S=m.length;if(g===m)return!0;if(g.length>=S){for(var v=0;v<S;v++)if(g[v]!==m[v])return!1;f=!0}}return f}function strContains(g,m){return!(!g||!m)&&-1!==g.indexOf(m)}function isDate(g){return"[object Date]"===objToString(g)}function isArray(g){return"[object Array]"===objToString(g)}function isError(g){return"[object Error]"===objToString(g)}function isString(g){return"string"==typeof g}function isNumber(g){return"number"==typeof g}function isBoolean(g){return"boolean"==typeof g}function toISOString(g){if(isDate(g)){var pad=function(g){var m=String(g);return 1===m.length&&(m="0"+m),m};return g.getUTCFullYear()+"-"+pad(g.getUTCMonth()+1)+"-"+pad(g.getUTCDate())+"T"+pad(g.getUTCHours())+":"+pad(g.getUTCMinutes())+":"+pad(g.getUTCSeconds())+"."+String((g.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"}}function arrForEach(g,m,f){for(var S=g.length,v=0;v<S&&(!(v in g)||-1!==m.call(f||g,g[v],v,g));v++);}function arrIndexOf(g,m,f){for(var S=g.length,v=f||0,C=Math.max(v>=0?v:S-Math.abs(v),0);C<S;C++)if(C in g&&g[C]===m)return C;return-1}function strTrim(g){return"string"!=typeof g?g:g.replace(/^\s+|\s+$/g,"")}var Ge=!{toString:null}.propertyIsEnumerable("toString"),je=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys(g){var m=typeof g;m===X||m===Z&&null!==g||throwTypeError("objKeys called on non-object");var f=[];for(var S in g)g&&le.call(g,S)&&f.push(S);if(Ge)for(var v=je.length,C=0;C<v;C++)g&&le.call(g,je[C])&&f.push(je[C]);return f}function objDefineAccessors(g,m,f,S){if($e)try{var v={enumerable:!0,configurable:!0};return f&&(v.get=f),S&&(v.set=S),$e(g,m,v),!0}catch(g){}return!1}function dateNow(){var g=Date;return g.now?g.now():(new g).getTime()}function getExceptionName(g){return isError(g)?g.name:""}function setValue(g,m,f,S,v){var C=f;return g&&((C=g[m])===f||v&&!v(C)||S&&!S(f)||(C=f,g[m]=C)),C}function getSetValue(g,m,f){var S;return g?!(S=g[m])&&isNullOrUndefined(S)&&(S=isUndefined(f)?{}:f,g[m]=S):S=isUndefined(f)?{}:f,S}function isNotTruthy(g){return!g}function isTruthy(g){return!!g}function throwError(g){throw new Error(g)}function optimizeObject(g){return g&&(g=ne(se?se({},g):g)),g}var We="window",qe="document",ze="navigator",Ke="location",Je="console",Ye="performance",Qe="JSON",Xe="crypto",Ze="msCrypto",et="ReactNative",tt="msie",it="trident/",nt=null,rt=null,st=!1;function getGlobalInst(g){var m=getGlobal();return m&&m[g]?m[g]:g===We&&hasWindow()?window:null}function hasWindow(){return Boolean(typeof window===Z&&window)}function getWindow(){return hasWindow()?window:getGlobalInst(We)}function hasDocument(){return Boolean(typeof document===Z&&document)}function getDocument(){return hasDocument()?document:getGlobalInst(qe)}function hasNavigator(){return Boolean(typeof navigator===Z&&navigator)}function getNavigator(){return hasNavigator()?navigator:getGlobalInst(ze)}function getLocation(g){if(g&&st){var m=getGlobalInst("__mockLocation");if(m)return m}return typeof location===Z&&location?location:getGlobalInst(Ke)}function getConsole(){return typeof console!==ee?console:getGlobalInst(Je)}function getPerformance(){return getGlobalInst(Ye)}function hasJSON(){return Boolean(typeof JSON===Z&&JSON||null!==getGlobalInst(Qe))}function getJSON(){return hasJSON()?JSON||getGlobalInst(Qe):null}function getCrypto(){return getGlobalInst(Xe)}function getMsCrypto(){return getGlobalInst(Ze)}function isReactNative(){var g=getNavigator();return!(!g||!g.product)&&g.product===et}function isIE(){var g=getNavigator();if(g&&(g.userAgent!==rt||null===nt)){var m=((rt=g.userAgent)||"").toLowerCase();nt=strContains(m,tt)||strContains(m,it)}return nt}function dumpObj(g){var m=Object[te].toString.call(g),f="";return"[object Error]"===m?f="{ stack: '"+g.stack+"', message: '"+g.message+"', name: '"+g.name+"'":hasJSON()&&(f=getJSON().stringify(g)),m+f}var at="AI (Internal): ",ot="AI: ",lt="AITR_";function _sanitizeDiagnosticText(g){return g?'"'+g.replace(/\"/g,"")+'"':""}var ct=function(){function _InternalLogMessage(g,m,f,S){void 0===f&&(f=!1);var v=this;v.messageId=g,v.message=(f?ot:at)+g;var C="";hasJSON()&&(C=getJSON().stringify(S));var _=(m?" message:"+_sanitizeDiagnosticText(m):"")+(S?" props:"+_sanitizeDiagnosticText(C):"");v.message+=_}return _InternalLogMessage.dataType="MessageData",_InternalLogMessage}();function safeGetLogger(g,m){return(g||{}).logger||new dt(m)}var dt=function(){function DiagnosticLogger(g){this.identifier="DiagnosticLogger",this.queue=[];var m=0,f={};dynamicProto(DiagnosticLogger,this,(function(S){function _getConfigValue(m,f){var S=g[m];return isNullOrUndefined(S)?f:S}function _areInternalMessagesThrottled(){return m>=S.maxInternalMessageLimit()}isNullOrUndefined(g)&&(g={}),S.consoleLoggingLevel=function(){return _getConfigValue("loggingLevelConsole",0)},S.telemetryLoggingLevel=function(){return _getConfigValue("loggingLevelTelemetry",1)},S.maxInternalMessageLimit=function(){return _getConfigValue("maxMessageLimit",25)},S.enableDebugExceptions=function(){return _getConfigValue("enableDebugExceptions",!1)},S.throwInternal=function(g,m,v,C,_){void 0===_&&(_=!1);var E=new ct(m,v,_,C);if(S.enableDebugExceptions())throw E;if(!isUndefined(E)&&E&&!isUndefined(E.message)){var T=S.consoleLoggingLevel();if(_){var I=+E.messageId;!f[I]&&T>=Ne.WARNING&&(S.warnToConsole(E.message),f[I]=!0)}else T>=Ne.WARNING&&S.warnToConsole(E.message);S.logInternalMessage(g,E)}},S.warnToConsole=function(g){var m=getConsole();if(m){var f="log";m.warn&&(f="warn"),isFunction(m[f])&&m[f](g)}},S.resetInternalMessageCount=function(){m=0,f={}},S.logInternalMessage=function(g,v){if(!_areInternalMessagesThrottled()){var C=!0,_=lt+v.messageId;if(f[_]?C=!1:f[_]=!0,C&&(g<=S.telemetryLoggingLevel()&&(S.queue.push(v),m++),m===S.maxInternalMessageLimit())){var E="Internal events throttle limit per PageView reached for this app.",T=new ct(Fe.MessageLimitPerPVExceeded,E,!1);S.queue.push(T),S.warnToConsole(E)}}}}))}return DiagnosticLogger}(),ht="ctx",ut=function(){function PerfEvent(g,m,f){var S,v=this,C=!1;(v.start=dateNow(),v.name=g,v.isAsync=f,v.isChildEvt=function(){return!1},isFunction(m))&&(C=objDefineAccessors(v,"payload",(function(){return!S&&isFunction(m)&&(S=m(),m=null),S})));v.getCtx=function(g){return g?g===PerfEvent.ParentContextKey||g===PerfEvent.ChildrenContextKey?v[g]:(v[ht]||{})[g]:null},v.setCtx=function(g,m){if(g)if(g===PerfEvent.ParentContextKey)v[g]||(v.isChildEvt=function(){return!0}),v[g]=m;else if(g===PerfEvent.ChildrenContextKey)v[g]=m;else{(v[ht]=v[ht]||{})[g]=m}},v.complete=function(){var g=0,f=v.getCtx(PerfEvent.ChildrenContextKey);if(isArray(f))for(var S=0;S<f.length;S++){var _=f[S];_&&(g+=_.time)}v.time=dateNow()-v.start,v.exTime=v.time-g,v.complete=function(){},!C&&isFunction(m)&&(v.payload=m())}}return PerfEvent.ParentContextKey="parent",PerfEvent.ChildrenContextKey="childEvts",PerfEvent}(),gt=function(){function PerfManager(g){this.ctx={},dynamicProto(PerfManager,this,(function(m){m.create=function(g,m,f){return new ut(g,m,f)},m.fire=function(m){m&&(m.complete(),g&&g.perfEvent(m))},m.setCtx=function(g,f){g&&((m[ht]=m[ht]||{})[g]=f)},m.getCtx=function(g){return(m[ht]||{})[g]}}))}return PerfManager}(),pt="CoreUtils.doPerf";function doPerf(g,m,f,S,v){if(g){var C=g;if(C&&isFunction(C.getPerfMgr)&&(C=C.getPerfMgr()),C){var _=void 0,E=C.getCtx(pt);try{if(_=C.create(m(),S,v)){if(E&&_.setCtx&&(_.setCtx(ut.ParentContextKey,E),E.getCtx&&E.setCtx)){var T=E.getCtx(ut.ChildrenContextKey);T||(T=[],E.setCtx(ut.ChildrenContextKey,T)),T.push(_)}return C.setCtx(pt,_),f(_)}}catch(g){_&&_.setCtx&&_.setCtx("exception",g)}finally{_&&C.fire(_),C.setCtx(pt,E)}}}return f()}var mt=function(){function TelemetryPluginChain(g,m){var f=this,S=null,v=isFunction(g.processTelemetry),C=isFunction(g.setNextPlugin);f._hasRun=!1,f.getPlugin=function(){return g},f.getNext=function(){return S},f.setNext=function(g){S=g},f.processTelemetry=function(_,E){E||(E=m);var T=g?g.identifier:"TelemetryPluginChain";doPerf(E?E.core():null,(function(){return T+":processTelemetry"}),(function(){if(g&&v){f._hasRun=!0;try{E.setNext(S),C&&g.setNextPlugin(S),S&&(S._hasRun=!1),g.processTelemetry(_,E)}catch(f){var m=S&&S._hasRun;S&&m||E.diagLog().throwInternal(Ne.CRITICAL,Fe.PluginException,"Plugin ["+g.identifier+"] failed during processTelemetry - "+f),S&&!m&&S.processTelemetry(_,E)}}else S&&(f._hasRun=!0,S.processTelemetry(_,E))}),(function(){return{item:_}}),!_.sync)}}return TelemetryPluginChain}();function _createProxyChain(g,m){var f=[];if(g&&g.length>0)for(var S=null,v=0;v<g.length;v++){var C=g[v];if(C&&isFunction(C.processTelemetry)){var _=new mt(C,m);f.push(_),S&&S.setNext(_),S=_}}return f.length>0?f[0]:null}function _copyProxyChain(g,m,f){var S=[],v=!f;if(g)for(;g;){var C=g.getPlugin();(v||C===f)&&(v=!0,S.push(C)),g=g.getNext()}return v||S.push(f),_createProxyChain(S,m)}function _copyPluginChain(g,m,f){var S=g,v=!1;return f&&g&&(S=[],arrForEach(g,(function(g){(v||g===f)&&(v=!0,S.push(g))}))),f&&!v&&(S||(S=[]),S.push(f)),_createProxyChain(S,m)}var ft=function(){function ProcessTelemetryContext(g,m,f,S){var v=this,C=null;null!==S&&(g&&isFunction(g.getPlugin)?C=_copyProxyChain(g,v,S||g.getPlugin()):S?C=_copyPluginChain(g,v,S):isUndefined(S)&&(C=_createProxyChain(g,v))),v.core=function(){return f},v.diagLog=function(){return safeGetLogger(f,m)},v.getCfg=function(){return m},v.getExtCfg=function(g,f){var S;if(void 0===f&&(f={}),m){var v=m.extensionConfig;v&&g&&(S=v[g])}return S||f},v.getConfig=function(g,f,S){var C;void 0===S&&(S=!1);var _=v.getExtCfg(g,null);return _&&!isNullOrUndefined(_[f])?C=_[f]:m&&!isNullOrUndefined(m[f])&&(C=m[f]),isNullOrUndefined(C)?S:C},v.hasNext=function(){return null!=C},v.getNext=function(){return C},v.setNext=function(g){C=g},v.processNext=function(g){var m=C;m&&(C=m.getNext(),m.processTelemetry(g,v))},v.createNew=function(g,S){return void 0===g&&(g=null),new ProcessTelemetryContext(g||C,m,f,S)}}return ProcessTelemetryContext}(),St="iKey",vt="extensionConfig",yt="getPlugin",Ct=function(){function BaseTelemetryPlugin(){var g=this,m=!1,f=null,S=null;g.core=null,g.diagLog=function(m){return g._getTelCtx(m).diagLog()},g.isInitialized=function(){return m},g.setInitialized=function(g){m=g},g.setNextPlugin=function(g){S=g},g.processNext=function(g,m){m?m.processNext(g):S&&isFunction(S.processTelemetry)&&S.processTelemetry(g,null)},g._getTelCtx=function(m){void 0===m&&(m=null);var v=m;if(!v){var C=f||new ft(null,{},g.core);v=S&&S[yt]?C.createNew(null,S[yt]):C.createNew(null,S)}return v},g._baseTelInit=function(v,C,_,E){v&&setValue(v,vt,[],null,isNullOrUndefined),!E&&C&&(E=C.getProcessTelContext().getNext());var T=S;S&&S[yt]&&(T=S[yt]()),g.core=C,f=new ft(E,v,C,T),m=!0}}return BaseTelemetryPlugin.prototype.initialize=function(g,m,f,S){this._baseTelInit(g,m,f,S)},BaseTelemetryPlugin}(),_t="processTelemetry",Et="priority",Tt="setNextPlugin",It="isInitialized";function initializePlugins(g,m){for(var f=[],S=null,v=g.getNext();v;){var C=v.getPlugin();C&&(S&&isFunction(S[Tt])&&isFunction(C[_t])&&S[Tt](C),isFunction(C[It])&&C[It]()||f.push(C),S=C,v=v.getNext())}arrForEach(f,(function(f){f.initialize(g.getCfg(),g.core(),m,g.getNext())}))}function sortPlugins(g){return g.sort((function(g,m){var f=0,S=isFunction(m[_t]);return isFunction(g[_t])?f=S?g[Et]-m[Et]:1:S&&(f=-1),f}))}var bt=500,At="Channel has invalid priority",Pt=function(g){function ChannelController(){var m,f=g.call(this)||this;function _checkQueuePriority(g){arrForEach(g,(function(g){g.priority<bt&&throwError(At+g.identifier)}))}function _addChannelQueue(g){g&&g.length>0&&(_checkQueuePriority(g=g.sort((function(g,m){return g.priority-m.priority}))),m.push(g))}function _createChannelQueues(g,f){if(m=[],g&&arrForEach(g,(function(g){return _addChannelQueue(g)})),f){var S=[];arrForEach(f,(function(g){g.priority>bt&&S.push(g)})),_addChannelQueue(S)}}return f.identifier="ChannelControllerPlugin",f.priority=bt,dynamicProto(ChannelController,f,(function(g,S){g.setNextPlugin=function(g){},g.processTelemetry=function(g,S){m&&arrForEach(m,(function(m){m.length>0&&f._getTelCtx(S).createNew(m).processNext(g)}))},g.getChannelControls=function(){return m},g.initialize=function(f,v,C){g.isInitialized()||(S.initialize(f,v,C),_createChannelQueues((f||{}).channels,C),arrForEach(m,(function(g){return initializePlugins(new ft(g,f,v),C)})))}})),f}var m;return __extendsFn(ChannelController,g),ChannelController._staticInit=(objDefineAccessors(m=ChannelController.prototype,"ChannelControls",m.getChannelControls),void objDefineAccessors(m,"channelQueue",m.getChannelControls)),ChannelController}(Ct),Rt="toGMTString",wt="toUTCString",Mt="cookie",Dt="expires",Ot="enabled",Nt="isCookieUseDisabled",kt="disableCookiesUsage",Lt="_ckMgr",Ft="",xt=null,Ut=null,Vt=null,Bt=getDocument(),Ht={},$t={};function _gblCookieMgr(g,m){var f=createCookieMgr[Lt]||$t[Lt];return f||(f=createCookieMgr[Lt]=createCookieMgr(g,m),$t[Lt]=f),f}function _isMgrEnabled(g){return!g||g.isEnabled()}function _createCookieMgrConfig(g){var m=g.cookieCfg=g.cookieCfg||{};if(setValue(m,"domain",g.cookieDomain,isNotNullOrUndefined,isNullOrUndefined),setValue(m,"path",g.cookiePath||"/",null,isNullOrUndefined),isNullOrUndefined(m[Ot])){var f=void 0;isUndefined(g[Nt])||(f=!g[Nt]),isUndefined(g[kt])||(f=!g[kt]),m[Ot]=f}return m}function safeGetCookieMgr(g,m){var f;if(g)f=g.getCookieMgr();else if(m){var S=(m||{}).cookieCfg;f=S[Lt]?S[Lt]:createCookieMgr(m)}return f||(f=_gblCookieMgr(m,(g||{}).logger)),f}function createCookieMgr(g,m){var f=_createCookieMgrConfig(g||$t),S=f.path||"/",v=f.domain,C=!1!==f[Ot],_={isEnabled:function(){var g=C&&areCookiesSupported(m),f=$t[Lt];return g&&f&&_!==f&&(g=_isMgrEnabled(f)),g},setEnabled:function(g){C=!1!==g},set:function(g,m,C,E,T){if(_isMgrEnabled(_)){var I={},b=strTrim(m||Ft),A=b.indexOf(";");if(-1!==A&&(b=strTrim(m.substring(0,A)),I=_extractParts(m.substring(A+1))),setValue(I,"domain",E||v,isTruthy,isUndefined),!isNullOrUndefined(C)){var P=isIE();if(isUndefined(I[Dt])){var R=dateNow()+1e3*C;if(R>0){var w=new Date;w.setTime(R),setValue(I,Dt,_formatDate(w,P?Rt:wt)||_formatDate(w,P?Rt:wt)||Ft,isTruthy)}}P||setValue(I,"max-age",Ft+C,null,isUndefined)}var M=getLocation();M&&"https:"===M.protocol&&(setValue(I,"secure",null,null,isUndefined),null===Ut&&(Ut=!uaDisallowsSameSiteNone((getNavigator()||{}).userAgent)),Ut&&setValue(I,"SameSite","None",null,isUndefined)),setValue(I,"path",T||S,null,isUndefined),(f.setCookie||_setCookieValue)(g,_formatCookieValue(b,I))}},get:function(g){var m=Ft;return _isMgrEnabled(_)&&(m=(f.getCookie||_getCookieValue)(g)),m},del:function(g,m){_isMgrEnabled(_)&&_.purge(g,m)},purge:function(g,S){if(areCookiesSupported(m)){var v=((C={}).path=S||"/",C[Dt]="Thu, 01 Jan 1970 00:00:01 GMT",C);isIE()||(v["max-age"]="0"),(f.delCookie||_setCookieValue)(g,_formatCookieValue(Ft,v))}var C}};return _[Lt]=_,_}function areCookiesSupported(g){if(null===xt){xt=!1;try{xt=void 0!==(Bt||{})[Mt]}catch(m){g&&g.throwInternal(Ne.WARNING,Fe.CannotAccessCookie,"Cannot access document.cookie - "+getExceptionName(m),{exception:dumpObj(m)})}}return xt}function _extractParts(g){var m={};g&&g.length&&arrForEach(strTrim(g).split(";"),(function(g){if(g=strTrim(g||Ft)){var f=g.indexOf("=");-1===f?m[g]=null:m[strTrim(g.substring(0,f))]=strTrim(g.substring(f+1))}}));return m}function _formatDate(g,m){return isFunction(g[m])?g[m]():null}function _formatCookieValue(g,m){var f=g||Ft;return objForEachKey(m,(function(g,m){f+="; "+g+(isNullOrUndefined(m)?Ft:"="+m)})),f}function _getCookieValue(g){var m=Ft;if(Bt){var f=Bt[Mt]||Ft;Vt!==f&&(Ht=_extractParts(f),Vt=f),m=strTrim(Ht[g]||Ft)}return m}function _setCookieValue(g,m){Bt&&(Bt[Mt]=g+"="+m)}function uaDisallowsSameSiteNone(g){return!!isString(g)&&(!(!strContains(g,"CPU iPhone OS 12")&&!strContains(g,"iPad; CPU OS 12"))||(!!(strContains(g,"Macintosh; Intel Mac OS X 10_14")&&strContains(g,"Version/")&&strContains(g,"Safari"))||(!(!strContains(g,"Macintosh; Intel Mac OS X 10_14")||!strEndsWith(g,"AppleWebKit/605.1.15 (KHTML, like Gecko)"))||(!(!strContains(g,"Chrome/5")&&!strContains(g,"Chrome/6"))||(!(!strContains(g,"UnrealEngine")||strContains(g,"Chrome"))||!(!strContains(g,"UCBrowser/12")&&!strContains(g,"UCBrowser/11")))))))}var Gt="Extensions must provide callback to initialize",jt="_notificationManager",Wt=function(){function BaseCore(){var g,m,f,S,v,C=!1;dynamicProto(BaseCore,this,(function(_){_._extensions=new Array,m=new Pt,_.logger=objCreateFn({throwInternal:function(g,m,f,S,v){},warnToConsole:function(g){},resetInternalMessageCount:function(){}}),g=[],_.isInitialized=function(){return C},_.initialize=function(g,S,v,E){_.isInitialized()&&throwError("Core should not be initialized more than once"),g&&!isNullOrUndefined(g.instrumentationKey)||throwError("Please provide instrumentation key"),f=E,_[jt]=E,_.config=g||{},g.extensions=isNullOrUndefined(g.extensions)?[]:g.extensions,getSetValue(g,vt).NotificationManager=E,v&&(_.logger=v);var T=[];T.push.apply(T,S.concat(g.extensions)),T=sortPlugins(T);var I=[],b={};arrForEach(T,(function(g){(isNullOrUndefined(g)||isNullOrUndefined(g.initialize))&&throwError(Gt);var f=g.priority,S=g.identifier;g&&f&&(isNullOrUndefined(b[f])?b[f]=S:v.warnToConsole("Two extensions have same priority #"+f+" - "+b[f]+", "+S)),(!f||f<m.priority)&&I.push(g)})),T.push(m),I.push(m),T=sortPlugins(T),_._extensions=T,initializePlugins(new ft([m],g,_),T),initializePlugins(new ft(I,g,_),T),_._extensions=I,0===_.getTransmissionControls().length&&throwError("No channels available"),C=!0,_.releaseQueue()},_.getTransmissionControls=function(){return m.getChannelControls()},_.track=function(m){setValue(m,St,_.config.instrumentationKey,null,isNotTruthy),setValue(m,"time",toISOString(new Date),null,isNotTruthy),setValue(m,"ver","4.0",null,isNullOrUndefined),_.isInitialized()?_.getProcessTelContext().processNext(m):g.push(m)},_.getProcessTelContext=function(){var g=_._extensions,f=g;return g&&0!==g.length||(f=[m]),new ft(f,_.config,_)},_.getNotifyMgr=function(){return f||(f=objCreateFn({addNotificationListener:function(g){},removeNotificationListener:function(g){},eventsSent:function(g){},eventsDiscarded:function(g,m){},eventsSendRequest:function(g,m){}}),_[jt]=f),f},_.getCookieMgr=function(){return v||(v=createCookieMgr(_.config,_.logger)),v},_.setCookieMgr=function(g){v=g},_.getPerfMgr=function(){return S||_.config&&_.config.enablePerfMgr&&(S=new gt(_.getNotifyMgr())),S},_.setPerfMgr=function(g){S=g},_.eventCnt=function(){return g.length},_.releaseQueue=function(){g.length>0&&(arrForEach(g,(function(g){_.getProcessTelContext().processNext(g)})),g=[])}}))}return BaseCore}(),qt=function(){function NotificationManager(g){this.listeners=[];var m=!!(g||{}).perfEvtsSendAll;dynamicProto(NotificationManager,this,(function(g){g.addNotificationListener=function(m){g.listeners.push(m)},g.removeNotificationListener=function(m){for(var f=arrIndexOf(g.listeners,m);f>-1;)g.listeners.splice(f,1),f=arrIndexOf(g.listeners,m)},g.eventsSent=function(m){arrForEach(g.listeners,(function(g){g&&g.eventsSent&&setTimeout((function(){return g.eventsSent(m)}),0)}))},g.eventsDiscarded=function(m,f){arrForEach(g.listeners,(function(g){g&&g.eventsDiscarded&&setTimeout((function(){return g.eventsDiscarded(m,f)}),0)}))},g.eventsSendRequest=function(m,f){arrForEach(g.listeners,(function(g){if(g&&g.eventsSendRequest)if(f)setTimeout((function(){return g.eventsSendRequest(m,f)}),0);else try{g.eventsSendRequest(m,f)}catch(g){}}))},g.perfEvent=function(f){f&&(!m&&f.isChildEvt()||arrForEach(g.listeners,(function(g){if(g&&g.perfEvent)if(f.isAsync)setTimeout((function(){return g.perfEvent(f)}),0);else try{g.perfEvent(f)}catch(g){}})))}}))}return NotificationManager}(),zt=function(g){function AppInsightsCore(){var m=g.call(this)||this;return dynamicProto(AppInsightsCore,m,(function(g,m){function _validateTelemetryItem(g){if(isNullOrUndefined(g.name))throw _notifyInvalidEvent(g),Error("telemetry name required")}function _notifyInvalidEvent(m){var f=g.getNotifyMgr();f&&f.eventsDiscarded([m],he.InvalidEvent)}g.initialize=function(g,f,S,v){m.initialize(g,f,S||new dt(g),v||new qt(g))},g.track=function(f){doPerf(g.getPerfMgr(),(function(){return"AppInsightsCore:track"}),(function(){null===f&&(_notifyInvalidEvent(f),throwError("Invalid telemetry item")),_validateTelemetryItem(f),m.track(f)}),(function(){return{item:f}}),!f.sync)},g.addNotificationListener=function(m){var f=g.getNotifyMgr();f&&f.addNotificationListener(m)},g.removeNotificationListener=function(m){var f=g.getNotifyMgr();f&&f.removeNotificationListener(m)},g.pollInternalLogs=function(m){var f=g.config.diagnosticLogInterval;return f&&f>0||(f=1e4),setInterval((function(){var f=g.logger?g.logger.queue:[];arrForEach(f,(function(f){var S={name:m||"InternalMessageId: "+f.messageId,iKey:g.config.instrumentationKey,time:toISOString(new Date),baseType:ct.dataType,baseData:{message:f.message}};g.track(S)})),f.length=0}),f)}})),m}return __extendsFn(AppInsightsCore,g),AppInsightsCore}(Wt),Kt=4294967296,Jt=4294967295,Yt=!1,Qt=123456789,Xt=987654321;function _mwcSeed(g){g<0&&(g>>>=0),Qt=123456789+g&Jt,Xt=987654321-g&Jt,Yt=!0}function _autoSeedMwc(){try{var g=2147483647&dateNow();_mwcSeed((Math.random()*Kt^g)+g)}catch(g){}}function randomValue(g){return g>0?Math.floor(random32()/Jt*(g+1))>>>0:0}function random32(g){var m,f=getCrypto()||getMsCrypto();return f&&f.getRandomValues?m=f.getRandomValues(new Uint32Array(1))[0]&Jt:isIE()?(Yt||_autoSeedMwc(),m=mwcRandom32()&Jt):m=Math.floor(Kt*Math.random()|0),g||(m>>>=0),m}function mwcRandom32(g){var m=((Xt=36969*(65535&Xt)+(Xt>>16)&Jt)<<16)+(65535&(Qt=18e3*(65535&Qt)+(Qt>>16)&Jt))>>>0&Jt|0;return g||(m>>>=0),m}function addEventHandler(g,m){var f=!1,S=getWindow();S&&(f=attachEvent(S,g,m),f=attachEvent(S.body,g,m)||f);var v=getDocument();return v&&(f=ti.Attach(v,g,m)||f),f}function newGuid(){function randomHexDigit(){return randomValue(15)}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(ei,(function(g){var m=0|randomHexDigit();return("x"===g?m:3&m|8).toString(16)}))}function perfNow(){var g=getPerformance();return g&&g.now?g.now():dateNow()}function newId(g){void 0===g&&(g=22);for(var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",f=random32()>>>0,S=0,v="";v.length<g;)S++,v+=m.charAt(63&f),f>>>=6,5===S&&(f=(random32()<<2&4294967295|3&f)>>>0,S=0);return v}function generateW3CId(){for(var g,m=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],f="",S=0;S<4;S++)f+=m[15&(g=random32())]+m[g>>4&15]+m[g>>8&15]+m[g>>12&15]+m[g>>16&15]+m[g>>20&15]+m[g>>24&15]+m[g>>28&15];var v=m[8+(3&random32())|0];return f.substr(0,8)+f.substr(9,4)+"4"+f.substr(13,3)+v+f.substr(16,3)+f.substr(19,12)}var Zt,ei=/[xy]/g,ti={Attach:attachEvent,AttachEvent:attachEvent,Detach:detachEvent,DetachEvent:detachEvent},ii={NotSet:0,Pii_DistinguishedName:1,Pii_GenericData:2,Pii_IPV4Address:3,Pii_IPv6Address:4,Pii_MailSubject:5,Pii_PhoneNumber:6,Pii_QueryString:7,Pii_SipAddress:8,Pii_SmtpAddress:9,Pii_Identity:10,Pii_Uri:11,Pii_Fqdn:12,Pii_IPV4AddressLegacy:13,CustomerContent_GenericContent:32},ni={Normal:1,CostDeferred:2,RealTime:3,Immediate:4},ri={Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9},si=ce(ce({},Fe),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),ai="1DS-Web-JS-"+"3.1.2",oi=((Zt={})[0]=ri.Unspecified,Zt[2]=ri.Double,Zt[1]=ri.String,Zt[3]=ri.Bool,Zt[4098]=ri.Double,Zt[4097]=ri.String,Zt[4099]=ri.Bool,Zt),li=null,ci=(Boolean(getDocument()),Boolean(getWindow()));function isValueAssigned(g){return!(""===g||isNullOrUndefined(g))}function getTenantId(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return""}function isBeaconsSupported(){return null===li&&(li=hasNavigator()&&Boolean(getNavigator().sendBeacon)),li}function isLatency(g){return!!(g&&isNumber(g)&&g>=ni.Normal&&g<=ni.Immediate)}function sanitizeProperty(g,m,f){if(!m&&!isValueAssigned(m)||"string"!=typeof g)return null;var S=typeof m;if("string"===S||"number"===S||"boolean"===S||isArray(m))m={value:m};else if("object"!==S||m.hasOwnProperty("value")){if(isNullOrUndefined(m.value)||""===m.value||!isString(m.value)&&!isNumber(m.value)&&!isBoolean(m.value)&&!isArray(m.value))return null}else m={value:f?JSON.stringify(m):m};if(isArray(m.value)&&!isArrayValid(m.value))return null;if(!isNullOrUndefined(m.kind)){if(isArray(m.value)||!isValueKind(m.kind))return null;m.value=m.value.toString()}return m}function useXDomainRequest(){if(void 0!==typeof XMLHttpRequest){var g=getGlobalInst("XMLHttpRequest");if(g){var m=new g;return Boolean(isUndefined(m.withCredentials)&&void 0!==typeof XDomainRequest)}}}function getCommonSchemaMetaData(g,m,f){var S=-1;if(!isUndefined(g))if(m>0&&(32===m?S=8192:m<=13&&(S=m<<5)),isDataType(f))-1===S&&(S=0),S|=f;else{var v=oi[getFieldValueType(g)]||-1;-1!==S&&-1!==v?S|=v:v===ri.Double&&(S=v)}return S}function getCookie(g){return areCookiesSupported(null)?getCookieValue(safeGetCookieMgr(null),g):""}function getCookieValue(g,m,f){var S;return void 0===f&&(f=!0),g&&(S=g.get(m),f&&S&&decodeURIComponent&&(S=decodeURIComponent(S))),S||""}function createGuid(g){void 0===g&&(g="D");var m=newGuid();return"B"===g?m="{"+m+"}":"P"===g?m="("+m+")":"N"===g&&(m=m.replace(/-/g,"")),m}function extend(g,m,f,S,v){var C={},_=!1,E=0,T=arguments.length,I=arguments;for("[object Boolean]"===Object[te].toString.call(I[0])&&(_=I[0],E++);E<T;E++){objForEachKey(I[E],(function(g,m){_&&m&&isObject(m)?isArray(m)?(C[g]=C[g]||[],arrForEach(m,(function(m,f){m&&isObject(m)?C[g][f]=extend(!0,C[g][f],m):C[g][f]=m}))):C[g]=extend(!0,C[g],m):C[g]=m}))}return C}var di=perfNow;function isValueKind(g){return g===ii.NotSet||g>ii.NotSet&&g<=ii.Pii_IPV4AddressLegacy||g===ii.CustomerContent_GenericContent}function isDataType(g){return g>=0&&g<=9}function isArrayValid(g){return g.length>0}function addPageUnloadEventListener(g){var m=addEventHandler("beforeunload",g);return m=addEventHandler("unload",g)||m,m=addEventHandler("pagehide",g)||m}function setProcessTelemetryTimings(g,m){var f=g;f.timings=f.timings||{},f.timings.processTelemetryStart=f.timings.processTelemetryStart||{},f.timings.processTelemetryStart[m]=di()}function getFieldValueType(g){var m=0;if(null!=g){var f=typeof g;"string"===f?m=1:"number"===f?m=2:"boolean"===f?m=3:f===Z&&(m=4,isArray(g)?(m=4096,g.length>0&&(m|=getFieldValueType(g[0]))):hasOwnProperty(g,"value")&&(m=8192|getFieldValueType(g.value)))}return m}function isChromium(){return!!getGlobalInst("chrome")}var hi="version",ui="properties",gi=function(g){function AppInsightsCore(){var m=g.call(this)||this;return m.pluginVersionStringArr=[],m.pluginVersionString="",dynamicProto(AppInsightsCore,m,(function(g,m){g.initialize=function(f,S,v,C){doPerf(g,(function(){return"AppInsightsCore.initialize"}),(function(){if(f){f.endpointUrl||(f.endpointUrl="https://browser.events.data.microsoft.com/OneCollector/1.0/");var _=f.propertyStorageOverride;if(_&&(!_.getProperty||!_.setProperty))throw new Error("Invalid property storage override passed.");f.channels&&arrForEach(f.channels,(function(m){m&&arrForEach(m,(function(m){if(m.identifier&&m.version){var f=m.identifier+"="+m.version;g.pluginVersionStringArr.push(f)}}))}))}g.getWParam=function(){return"undefined"!=typeof document?0:-1},S&&arrForEach(S,(function(m){if(m&&m.identifier&&m.version){var f=m.identifier+"="+m.version;g.pluginVersionStringArr.push(f)}})),g.pluginVersionString=g.pluginVersionStringArr.join(";");try{m.initialize(f,S,v,C)}catch(m){g.logger.throwInternal(Ne.CRITICAL,si.ErrorProvidedChannels,"Channels must be provided through config.channels only")}g.pollInternalLogs("InternalLog")}),(function(){return{config:f,extensions:S,logger:v,notificationManager:C}}))},g.track=function(f){doPerf(g,(function(){return"AppInsightsCore.track"}),(function(){var S=f;if(S){S.timings=S.timings||{},S.timings.trackStart=di(),isLatency(S.latency)||(S.latency=ni.Normal);var v=S.ext=S.ext||{};v.sdk=v.sdk||{},v.sdk.ver=ai;var C=S.baseData=S.baseData||{};C[ui]||(C[ui]={});var _=C[ui];_[hi]||(_[hi]=""),""!==g.pluginVersionString&&(_[hi]=g.pluginVersionString)}m.track(S)}),(function(){return{item:f}}),!f.sync)}})),m}return __extendsFn(AppInsightsCore,g),AppInsightsCore}(zt),pi="function",mi="object",fi="undefined",Si="prototype",vi="hasOwnProperty",yi=Object,Ci=yi[Si],_i=yi.assign,Ei=yi.create,Ti=yi.defineProperty,Ii=Ci[vi];function getGlobal$1(){return typeof globalThis!==fi&&globalThis?globalThis:typeof self!==fi&&self?self:typeof window!==fi&&window?window:typeof global!==fi&&global?global:null}function throwTypeError$1(g){throw new TypeError(g)}function objCreateFn$1(g){if(Ei)return Ei(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==mi&&m!==pi&&throwTypeError$1("Object prototype may only be an Object:"+g),tmpFunc[Si]=g,new tmpFunc}(getGlobal$1()||{}).Symbol,(getGlobal$1()||{}).Reflect;var bi,__objAssignFnImpl$1=function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Ci[vi].call(m,v)&&(g[v]=m[v]);return g},Ai=_i||__objAssignFnImpl$1,extendStaticsFn$1=function(g,m){return extendStaticsFn$1=yi.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m[vi](f)&&(g[f]=m[f])},extendStaticsFn$1(g,m)};function __extendsFn$1(g,m){function __(){this.constructor=g}typeof m!==pi&&null!==m&&throwTypeError$1("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn$1(g,m),g[Si]=null===m?objCreateFn$1(m):(__[Si]=m[Si],new __)}!function(g){g[g.CRITICAL=1]="CRITICAL",g[g.WARNING=2]="WARNING"}(bi||(bi={}));var Pi={BrowserDoesNotSupportLocalStorage:0,BrowserCannotReadLocalStorage:1,BrowserCannotReadSessionStorage:2,BrowserCannotWriteLocalStorage:3,BrowserCannotWriteSessionStorage:4,BrowserFailedRemovalFromLocalStorage:5,BrowserFailedRemovalFromSessionStorage:6,CannotSendEmptyTelemetry:7,ClientPerformanceMathError:8,ErrorParsingAISessionCookie:9,ErrorPVCalc:10,ExceptionWhileLoggingError:11,FailedAddingTelemetryToBuffer:12,FailedMonitorAjaxAbort:13,FailedMonitorAjaxDur:14,FailedMonitorAjaxOpen:15,FailedMonitorAjaxRSC:16,FailedMonitorAjaxSend:17,FailedMonitorAjaxGetCorrelationHeader:18,FailedToAddHandlerForOnBeforeUnload:19,FailedToSendQueuedTelemetry:20,FailedToReportDataLoss:21,FlushFailed:22,MessageLimitPerPVExceeded:23,MissingRequiredFieldSpecification:24,NavigationTimingNotSupported:25,OnError:26,SessionRenewalDateIsZero:27,SenderNotInitialized:28,StartTrackEventFailed:29,StopTrackEventFailed:30,StartTrackFailed:31,StopTrackFailed:32,TelemetrySampledAndNotSent:33,TrackEventFailed:34,TrackExceptionFailed:35,TrackMetricFailed:36,TrackPVFailed:37,TrackPVFailedCalc:38,TrackTraceFailed:39,TransmissionFailed:40,FailedToSetStorageBuffer:41,FailedToRestoreStorageBuffer:42,InvalidBackendResponse:43,FailedToFixDepricatedValues:44,InvalidDurationValue:45,TelemetryEnvelopeInvalid:46,CreateEnvelopeError:47,CannotSerializeObject:48,CannotSerializeObjectNonSerializable:49,CircularReferenceDetected:50,ClearAuthContextFailed:51,ExceptionTruncated:52,IllegalCharsInName:53,ItemNotInArray:54,MaxAjaxPerPVExceeded:55,MessageTruncated:56,NameTooLong:57,SampleRateOutOfRange:58,SetAuthContextFailed:59,SetAuthContextFailedAccountName:60,StringValueTooLong:61,StartCalledMoreThanOnce:62,StopCalledWithoutStart:63,TelemetryInitializerFailed:64,TrackArgumentsNotSpecified:65,UrlTooLong:66,SessionStorageBufferFull:67,CannotAccessCookie:68,IdTooLong:69,InvalidEvent:70,FailedMonitorAjaxSetRequestHeader:71,SendBrowserInfoOnUserInit:72,PluginException:73,NotificationException:74,SnippetScriptLoadFailure:99,InvalidInstrumentationKey:100,CannotParseAiBlobValue:101,InvalidContentBlob:102,TrackPageActionEventFailed:103},Ri=Ti;function objToString$1(g){return Ci.toString.call(g)}function isUndefined$1(g){return void 0===g||typeof g===fi}function isNullOrUndefined$1(g){return null===g||isUndefined$1(g)}function isFunction$1(g){return typeof g===pi}function strContains$1(g,m){return!(!g||!m)&&-1!==g.indexOf(m)}function isArray$1(g){return"[object Array]"===objToString$1(g)}function isString$1(g){return"string"==typeof g}function isNumber$1(g){return"number"==typeof g}function arrForEach$1(g,m,f){for(var S=g.length,v=0;v<S&&(!(v in g)||-1!==m.call(f||g,g[v],v,g));v++);}var wi=!{toString:null}.propertyIsEnumerable("toString"),Mi=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];function objKeys$1(g){var m=typeof g;m===pi||m===mi&&null!==g||throwTypeError$1("objKeys called on non-object");var f=[];for(var S in g)g&&Ii.call(g,S)&&f.push(S);if(wi)for(var v=Mi.length,C=0;C<v;C++)g&&Ii.call(g,Mi[C])&&f.push(Mi[C]);return f}function objDefineAccessors$1(g,m,f,S){if(Ri)try{var v={enumerable:!0,configurable:!0};return f&&(v.get=f),S&&(v.set=S),Ri(g,m,v),!0}catch(g){}return!1}function dateNow$1(){var g=Date;return g.now?g.now():(new g).getTime()}function setValue$1(g,m,f,S,v){var C=f;return g&&((C=g[m])===f||v&&!v(C)||S&&!S(f)||(C=f,g[m]=C)),C}var Di="window",Oi="document",Ni="navigator",ki="console",Li="performance",Fi="JSON",xi="crypto",Ui="msCrypto",Vi="msie",Bi="trident/",Hi=null,$i=null;function getGlobalInst$1(g){var m=getGlobal$1();return m&&m[g]?m[g]:g===Di&&hasWindow$1()?window:null}function hasWindow$1(){return Boolean(typeof window===mi&&window)}function getWindow$1(){return hasWindow$1()?window:getGlobalInst$1(Di)}function hasDocument$1(){return Boolean(typeof document===mi&&document)}function getDocument$1(){return hasDocument$1()?document:getGlobalInst$1(Oi)}function hasNavigator$1(){return Boolean(typeof navigator===mi&&navigator)}function getNavigator$1(){return hasNavigator$1()?navigator:getGlobalInst$1(Ni)}function getConsole$1(){return typeof console!==fi?console:getGlobalInst$1(ki)}function getPerformance$1(){return getGlobalInst$1(Li)}function hasJSON$1(){return Boolean(typeof JSON===mi&&JSON||null!==getGlobalInst$1(Fi))}function getJSON$1(){return hasJSON$1()?JSON||getGlobalInst$1(Fi):null}function getCrypto$1(){return getGlobalInst$1(xi)}function getMsCrypto$1(){return getGlobalInst$1(Ui)}function isIE$1(){var g=getNavigator$1();if(g&&(g.userAgent!==$i||null===Hi)){var m=(($i=g.userAgent)||"").toLowerCase();Hi=strContains$1(m,Vi)||strContains$1(m,Bi)}return Hi}var Gi="AI (Internal): ",ji="AI: ",Wi="AITR_";function _sanitizeDiagnosticText$1(g){return g?'"'+g.replace(/\"/g,"")+'"':""}var qi=function(){function _InternalLogMessage(g,m,f,S){void 0===f&&(f=!1);var v=this;v.messageId=g,v.message=(f?ji:Gi)+g;var C="";hasJSON$1()&&(C=getJSON$1().stringify(S));var _=(m?" message:"+_sanitizeDiagnosticText$1(m):"")+(S?" props:"+_sanitizeDiagnosticText$1(C):"");v.message+=_}return _InternalLogMessage.dataType="MessageData",_InternalLogMessage}();function safeGetLogger$1(g,m){return(g||{}).logger||new zi(m)}var zi=function(){function DiagnosticLogger(g){this.identifier="DiagnosticLogger",this.queue=[];var m=0,f={};dynamicProto(DiagnosticLogger,this,(function(S){function _getConfigValue(m,f){var S=g[m];return isNullOrUndefined$1(S)?f:S}function _areInternalMessagesThrottled(){return m>=S.maxInternalMessageLimit()}isNullOrUndefined$1(g)&&(g={}),S.consoleLoggingLevel=function(){return _getConfigValue("loggingLevelConsole",0)},S.telemetryLoggingLevel=function(){return _getConfigValue("loggingLevelTelemetry",1)},S.maxInternalMessageLimit=function(){return _getConfigValue("maxMessageLimit",25)},S.enableDebugExceptions=function(){return _getConfigValue("enableDebugExceptions",!1)},S.throwInternal=function(g,m,v,C,_){void 0===_&&(_=!1);var E=new qi(m,v,_,C);if(S.enableDebugExceptions())throw E;if(!isUndefined$1(E)&&E&&!isUndefined$1(E.message)){var T=S.consoleLoggingLevel();if(_){var I=+E.messageId;!f[I]&&T>=bi.WARNING&&(S.warnToConsole(E.message),f[I]=!0)}else T>=bi.WARNING&&S.warnToConsole(E.message);S.logInternalMessage(g,E)}},S.warnToConsole=function(g){var m=getConsole$1();if(m){var f="log";m.warn&&(f="warn"),isFunction$1(m[f])&&m[f](g)}},S.resetInternalMessageCount=function(){m=0,f={}},S.logInternalMessage=function(g,v){if(!_areInternalMessagesThrottled()){var C=!0,_=Wi+v.messageId;if(f[_]?C=!1:f[_]=!0,C&&(g<=S.telemetryLoggingLevel()&&(S.queue.push(v),m++),m===S.maxInternalMessageLimit())){var E="Internal events throttle limit per PageView reached for this app.",T=new qi(Pi.MessageLimitPerPVExceeded,E,!1);S.queue.push(T),S.warnToConsole(E)}}}}))}return DiagnosticLogger}(),Ki="ctx",Ji=function(){function PerfEvent(g,m,f){var S,v=this,C=!1;(v.start=dateNow$1(),v.name=g,v.isAsync=f,v.isChildEvt=function(){return!1},isFunction$1(m))&&(C=objDefineAccessors$1(v,"payload",(function(){return!S&&isFunction$1(m)&&(S=m(),m=null),S})));v.getCtx=function(g){return g?g===PerfEvent.ParentContextKey||g===PerfEvent.ChildrenContextKey?v[g]:(v[Ki]||{})[g]:null},v.setCtx=function(g,m){if(g)if(g===PerfEvent.ParentContextKey)v[g]||(v.isChildEvt=function(){return!0}),v[g]=m;else if(g===PerfEvent.ChildrenContextKey)v[g]=m;else{(v[Ki]=v[Ki]||{})[g]=m}},v.complete=function(){var g=0,f=v.getCtx(PerfEvent.ChildrenContextKey);if(isArray$1(f))for(var S=0;S<f.length;S++){var _=f[S];_&&(g+=_.time)}v.time=dateNow$1()-v.start,v.exTime=v.time-g,v.complete=function(){},!C&&isFunction$1(m)&&(v.payload=m())}}return PerfEvent.ParentContextKey="parent",PerfEvent.ChildrenContextKey="childEvts",PerfEvent}(),Yi="CoreUtils.doPerf";function doPerf$1(g,m,f,S,v){if(g){var C=g;if(C&&isFunction$1(C.getPerfMgr)&&(C=C.getPerfMgr()),C){var _=void 0,E=C.getCtx(Yi);try{if(_=C.create(m(),S,v)){if(E&&_.setCtx&&(_.setCtx(Ji.ParentContextKey,E),E.getCtx&&E.setCtx)){var T=E.getCtx(Ji.ChildrenContextKey);T||(T=[],E.setCtx(Ji.ChildrenContextKey,T)),T.push(_)}return C.setCtx(Yi,_),f(_)}}catch(g){_&&_.setCtx&&_.setCtx("exception",g)}finally{_&&C.fire(_),C.setCtx(Yi,E)}}}return f()}var Qi=function(){function TelemetryPluginChain(g,m){var f=this,S=null,v=isFunction$1(g.processTelemetry),C=isFunction$1(g.setNextPlugin);f._hasRun=!1,f.getPlugin=function(){return g},f.getNext=function(){return S},f.setNext=function(g){S=g},f.processTelemetry=function(_,E){E||(E=m);var T=g?g.identifier:"TelemetryPluginChain";doPerf$1(E?E.core():null,(function(){return T+":processTelemetry"}),(function(){if(g&&v){f._hasRun=!0;try{E.setNext(S),C&&g.setNextPlugin(S),S&&(S._hasRun=!1),g.processTelemetry(_,E)}catch(f){var m=S&&S._hasRun;S&&m||E.diagLog().throwInternal(bi.CRITICAL,Pi.PluginException,"Plugin ["+g.identifier+"] failed during processTelemetry - "+f),S&&!m&&S.processTelemetry(_,E)}}else S&&(f._hasRun=!0,S.processTelemetry(_,E))}),(function(){return{item:_}}),!_.sync)}}return TelemetryPluginChain}();function _createProxyChain$1(g,m){var f=[];if(g&&g.length>0)for(var S=null,v=0;v<g.length;v++){var C=g[v];if(C&&isFunction$1(C.processTelemetry)){var _=new Qi(C,m);f.push(_),S&&S.setNext(_),S=_}}return f.length>0?f[0]:null}function _copyProxyChain$1(g,m,f){var S=[],v=!f;if(g)for(;g;){var C=g.getPlugin();(v||C===f)&&(v=!0,S.push(C)),g=g.getNext()}return v||S.push(f),_createProxyChain$1(S,m)}function _copyPluginChain$1(g,m,f){var S=g,v=!1;return f&&g&&(S=[],arrForEach$1(g,(function(g){(v||g===f)&&(v=!0,S.push(g))}))),f&&!v&&(S||(S=[]),S.push(f)),_createProxyChain$1(S,m)}var Xi=function(){function ProcessTelemetryContext(g,m,f,S){var v=this,C=null;null!==S&&(g&&isFunction$1(g.getPlugin)?C=_copyProxyChain$1(g,v,S||g.getPlugin()):S?C=_copyPluginChain$1(g,v,S):isUndefined$1(S)&&(C=_createProxyChain$1(g,v))),v.core=function(){return f},v.diagLog=function(){return safeGetLogger$1(f,m)},v.getCfg=function(){return m},v.getExtCfg=function(g,f){var S;if(void 0===f&&(f={}),m){var v=m.extensionConfig;v&&g&&(S=v[g])}return S||f},v.getConfig=function(g,f,S){var C;void 0===S&&(S=!1);var _=v.getExtCfg(g,null);return _&&!isNullOrUndefined$1(_[f])?C=_[f]:m&&!isNullOrUndefined$1(m[f])&&(C=m[f]),isNullOrUndefined$1(C)?S:C},v.hasNext=function(){return null!=C},v.getNext=function(){return C},v.setNext=function(g){C=g},v.processNext=function(g){var m=C;m&&(C=m.getNext(),m.processTelemetry(g,v))},v.createNew=function(g,S){return void 0===g&&(g=null),new ProcessTelemetryContext(g||C,m,f,S)}}return ProcessTelemetryContext}(),Zi="extensionConfig",en="getPlugin",tn=function(){function BaseTelemetryPlugin(){var g=this,m=!1,f=null,S=null;g.core=null,g.diagLog=function(m){return g._getTelCtx(m).diagLog()},g.isInitialized=function(){return m},g.setInitialized=function(g){m=g},g.setNextPlugin=function(g){S=g},g.processNext=function(g,m){m?m.processNext(g):S&&isFunction$1(S.processTelemetry)&&S.processTelemetry(g,null)},g._getTelCtx=function(m){void 0===m&&(m=null);var v=m;if(!v){var C=f||new Xi(null,{},g.core);v=S&&S[en]?C.createNew(null,S[en]):C.createNew(null,S)}return v},g._baseTelInit=function(v,C,_,E){v&&setValue$1(v,Zi,[],null,isNullOrUndefined$1),!E&&C&&(E=C.getProcessTelContext().getNext());var T=S;S&&S[en]&&(T=S[en]()),g.core=C,f=new Xi(E,v,C,T),m=!0}}return BaseTelemetryPlugin.prototype.initialize=function(g,m,f,S){this._baseTelInit(g,m,f,S)},BaseTelemetryPlugin}(),nn=4294967296,rn=4294967295,sn=!1,an=123456789,on=987654321;function _mwcSeed$1(g){g<0&&(g>>>=0),an=123456789+g&rn,on=987654321-g&rn,sn=!0}function _autoSeedMwc$1(){try{var g=2147483647&dateNow$1();_mwcSeed$1((Math.random()*nn^g)+g)}catch(g){}}function randomValue$1(g){return g>0?Math.floor(random32$1()/rn*(g+1))>>>0:0}function random32$1(g){var m,f=getCrypto$1()||getMsCrypto$1();return f&&f.getRandomValues?m=f.getRandomValues(new Uint32Array(1))[0]&rn:isIE$1()?(sn||_autoSeedMwc$1(),m=mwcRandom32$1()&rn):m=Math.floor(nn*Math.random()|0),g||(m>>>=0),m}function mwcRandom32$1(g){var m=((on=36969*(65535&on)+(on>>16)&rn)<<16)+(65535&(an=18e3*(65535&an)+(an>>16)&rn))>>>0&rn|0;return g||(m>>>=0),m}function newGuid$1(){function randomHexDigit(){return randomValue$1(15)}return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(cn,(function(g){var m=0|randomHexDigit();return("x"===g?m:3&m|8).toString(16)}))}function perfNow$1(){var g=getPerformance$1();return g&&g.now?g.now():dateNow$1()}var ln,cn=/[xy]/g,dn={Unspecified:0,String:1,Int32:2,UInt32:3,Int64:4,UInt64:5,Double:6,Bool:7,Guid:8,DateTime:9},hn={Normal:1,Critical:2};Ai(Ai({},Pi),{AuthHandShakeError:501,AuthRedirectFail:502,BrowserCannotReadLocalStorage:503,BrowserCannotWriteLocalStorage:504,BrowserDoesNotSupportLocalStorage:505,CannotParseBiBlobValue:506,CannotParseDataAttribute:507,CVPluginNotAvailable:508,DroppedEvent:509,ErrorParsingAISessionCookie:510,ErrorProvidedChannels:511,FailedToGetCookies:512,FailedToInitializeCorrelationVector:513,FailedToInitializeSDK:514,InvalidContentBlob:515,InvalidCorrelationValue:516,SessionRenewalDateIsZero:517,SendPostOnCompleteFailure:518,PostResponseHandler:519,SDKNotInitialized:520}),(ln={})[0]=dn.Unspecified,ln[2]=dn.Double,ln[1]=dn.String,ln[3]=dn.Bool,ln[4098]=dn.Double,ln[4097]=dn.String,ln[4099]=dn.Bool,Boolean(getDocument$1()),Boolean(getWindow$1());function getTenantId$1(g){if(g){var m=g.indexOf("-");if(m>-1)return g.substring(0,m)}return""}var un=perfNow$1;function setProcessTelemetryTimings$1(g,m){var f=g;f.timings=f.timings||{},f.timings.processTelemetryStart=f.timings.processTelemetryStart||{},f.timings.processTelemetryStart[m]=un()}var gn=isFunction$1;function _createPromiseAllOnResolvedFunction(g,m,f){return function(S){g[m]=S,f()}}var pn=function(){function ESPromise(g){var m=0,f=null,S=[];function _enqueue(g,v,C,_){S.push((function(){var S;try{(S=1===m?gn(g)?g(f):f:gn(v)?v(f):f)instanceof ESPromise?S.then(C,_):2!==m||gn(v)?C(S):_(S)}catch(g){return void _(g)}})),0!==m&&_processQueue()}function _processQueue(){if(S.length>0){var g=S.slice();S=[],setTimeout((function(){for(var m=0,f=g.length;m<f;++m)try{g[m]()}catch(g){}}),0)}}function _resolve(g){0===m&&(f=g,m=1,_processQueue())}function _reject(g){0===m&&(f=g,m=2,_processQueue())}dynamicProto(ESPromise,this,(function(g){g.then=function(g,m){return new ESPromise((function(f,S){_enqueue(g,m,f,S)}))},g.catch=function(m){return g.then(null,m)}})),function _initialize(){if(!gn(g))throw new TypeError("ESPromise: resolvedFunc argument is not a Function");try{g(_resolve,_reject)}catch(g){_reject(g)}}()}return ESPromise.resolve=function(g){return g instanceof ESPromise?g:g&&gn(g.then)?new ESPromise((function(m,f){try{g.then(m,f)}catch(g){f(g)}})):new ESPromise((function(m){m(g)}))},ESPromise.reject=function(g){return new ESPromise((function(m,f){f(g)}))},ESPromise.all=function(g){if(g&&g.length)return new ESPromise((function(m,f){try{for(var S=[],v=0,C=0;C<g.length;C++){var _=g[C];_&&gn(_.then)?(v++,_.then(_createPromiseAllOnResolvedFunction(S,C,(function(){0==--v&&m(S)})),f)):S[C]=_}0===v&&setTimeout((function(){m(S)}),0)}catch(g){f(g)}}))},ESPromise.race=function(g){return new ESPromise((function(m,f){if(g&&g.length)try{for(var _loop_1=function(S){var v=g[S];v&&gn(v.then)?v.then(m,f):setTimeout((function(){m(v)}),0)},S=0;S<g.length;S++)_loop_1(S)}catch(g){f(g)}}))},ESPromise}(),mn=6e5,fn=0,Sn=[],vn=[],yn=[];function _getTime(){return(new Date).getTime()}var Cn,_n=function(){function ESPromiseScheduler(g,m){var f=0,S=(g||"<unnamed>")+"."+fn;function _debugLog(g){var m=getGlobal$1();m&&m.QUnit&&console&&console.log("ESPromiseScheduler["+S+"] "+g)}function _warnLog(g){m&&m.warnToConsole("ESPromiseScheduler["+S+"] "+g)}fn++,dynamicProto(ESPromiseScheduler,this,(function(g){var m=null,v=0;function _removeQueuedEvent(g,m){for(var f=0;f<g.length;f++)if(g[f].id===m)return g.splice(f,1)[0];return null}g.scheduleEvent=function(g,C,_){var E=S+"."+v;v++,C&&(E+="-("+C+")");var T=E+"{"+f+"}";f++;var I={evt:null,tm:_getTime(),id:T,isRunning:!1,isAborted:!1};return I.evt=m?_waitForPreviousEvent(I,m):_startWaitingEvent(I),(m=I).evt._schId=T,I.evt;function _abortAndRemoveOldEvents(g){for(var m=_getTime(),f=m-mn,S=g.length,v=0;v<S;){var C=g[v];if(C&&C.tm<f){var _=null;C.abort?(_="Aborting ["+C.id+"] due to Excessive runtime ("+(m-C.tm)+" ms)",C.abort(_)):_="Removing ["+C.id+"] due to Excessive runtime ("+(m-C.tm)+" ms)",_warnLog(_),g.splice(v,1),S--}else v++}}function _cleanup(g,f){var S=!1,v=_removeQueuedEvent(Sn,g);if(v||(v=_removeQueuedEvent(yn,g),S=!0),v){v.to&&(clearTimeout(v.to),v.to=null);var C=_getTime()-v.tm;f?S?_warnLog("Timed out event ["+g+"] finally complete -- "+C+" ms"):_debugLog("Promise ["+g+"] Complete -- "+C+" ms"):(yn.push(v),_warnLog("Event ["+g+"] Timed out and removed -- "+C+" ms"))}else _debugLog("Failed to remove ["+g+"] from running queue");m&&m.id===g&&(m=null),_abortAndRemoveOldEvents(Sn),_abortAndRemoveOldEvents(vn),_abortAndRemoveOldEvents(yn)}function _removeScheduledEvent(g,m){return function(f){return _cleanup(g,!0),m&&m(f),f}}function _waitForFinalResult(g,m,f,S){m.then((function(m){return m instanceof pn?(_debugLog("Event ["+g+"] returned a promise -- waiting"),_waitForFinalResult(g,m,f,S),m):_removeScheduledEvent(g,f)(m)}),_removeScheduledEvent(g,S))}function _createScheduledEvent(g,m){var f=g.id;return new pn((function(S,v){_debugLog("Event ["+f+"] Starting -- waited for "+(g.wTm||"--")+" ms"),g.isRunning=!0,g.abort=function(m){g.abort=null,g.isAborted=!0,_cleanup(f,!1),v(new Error(m))};var C=m(f);C instanceof pn?(_&&(g.to=setTimeout((function(){_cleanup(f,!1),v(new Error("Timed out after ["+_+"] ms"))}),_)),_waitForFinalResult(f,C,(function(m){_debugLog("Event ["+f+"] Resolving after "+(_getTime()-g.tm)+" ms"),S(m)}),v)):(_debugLog("Promise ["+f+"] Auto completed as the start action did not return a promise"),S())}))}function _startWaitingEvent(m){var f=_getTime();return m.wTm=f-m.tm,m.tm=f,m.isAborted?pn.reject(new Error("["+E+"] was aborted")):(Sn.push(m),_createScheduledEvent(m,g))}function _waitForPreviousEvent(g,m){var f=new pn((function(f,S){var v=_getTime()-m.tm,C=m.id;_debugLog("["+E+"] is waiting for ["+C+":"+v+" ms] to complete before starting -- ["+vn.length+"] waiting and ["+Sn.length+"] running"),g.abort=function(m){g.abort=null,_removeQueuedEvent(vn,E),g.isAborted=!0,S(new Error(m))},m.evt.then((function(m){_removeQueuedEvent(vn,E),_startWaitingEvent(g).then(f,S)}),(function(m){_removeQueuedEvent(vn,E),_startWaitingEvent(g).then(f,S)}))}));return vn.push(g),f}}}))}return ESPromiseScheduler.incomplete=function(){return Sn},ESPromiseScheduler.waitingToStart=function(){return vn},ESPromiseScheduler}();function isValidPersistenceLevel(g){return isNumber$1(g)&&g>=hn.Normal&&g<=hn.Critical}!function(g){g[g.LocalStorage=1]="LocalStorage",g[g.SessionStorage=2]="SessionStorage",g[g.IndexedDb=3]="IndexedDb"}(Cn||(Cn={}));var En=10,Tn="3",In="Version",bn=6e5,An="AWTEvents",Pn=5e6,Rn=1,wn=2;function _isQuotaExceeded(g,m){var f=!1;return m instanceof DOMException&&(22!==m.code&&"QuotaExceededError"!==m.name&&1014!==m.code&&"NS_ERROR_DOM_QUOTA_REACHED"!==m.name||g&&0!==g.length&&(f=!0)),f}function _getAvailableStorage(g){var m=getGlobal$1()||{},f=null;try{if(f=m[g]){var S="__storage_test__";f.setItem(S,S),f.removeItem(S)}}catch(g){_isQuotaExceeded(f,g)||(f=null)}return f}function _forEachMap(g,m){if(g)for(var f=objKeys$1(g),S=0;S<f.length;S++){var v=f[S];if(!m(g[v],v))break}}function _isMapEmpty(g){var m=!0;return _forEachMap(g,(function(g,f){return g&&(m=!1),m})),m}function _dropEventsUpToPersistence(g,m){for(var f=Rn,S=0,_loop_1=function(){var g=[],v=m[f];if(_forEachMap(v,(function(m,f){return g.push(f),++S<En})),S>0){for(var C=0;C<g.length;C++)delete v[g[C]];return{value:!0}}f++};f<=g&&S<En;){var v=_loop_1();if("object"==typeof v)return v.value}return S>0}var Mn=isValidPersistenceLevel,Dn=function(){function WebStorageProvider(g,m){dynamicProto(WebStorageProvider,this,(function(f){var S=null,v=An,C=null,_=Tn,E=null,T=null,I=Pn,b=null,A=null;function _newStore(g,m){return{key:g,db:m}}function _fetchStoredDb(g,m){void 0===m&&(m=!0);var f=null;if(S){var v=S.getItem(g);if(v)try{f=JSON.parse(v)}catch(m){S.removeItem(g)}}return m&&!f&&(f={events:{1:{},2:{},3:{}},lastAccessTime:0}),_newStore(g,f)}function _updateStoredDb(g,m){void 0===m&&(m=!0);var f=!0,v=g.db;if(v){m&&(v.lastAccessTime=(new Date).getTime());for(var C=Rn;C<=wn;C++)if(!_isMapEmpty(v.events[C])){f=!1;break}}try{if(f)S&&S.removeItem(g.key);else{var _=JSON.stringify(v);if(_.length>I)return!1;S&&S.setItem(g.key,_)}}catch(g){return!1}return!0}function _clearDatabase(g){var m=[],f=_fetchStoredDb(g,!1),v=f.db;if(v){var C=v.events;try{for(var _=Rn;_<=wn;_++)_forEachMap(C[_],(function(g,f){return g&&m.push(g),!0}))}catch(g){}S&&S.removeItem(f.key)}return m}function _checkVersionAndMoveEventsToCurrentStorage(){if(S){for(var g=S.getItem(b),m=[],f=_fetchStoredDb(A),C=!1,E=0;E<S.length;E++){var I=S.key(E);if(0===I.indexOf(v)&&I!==b){if(g!==Tn){m.push(_newStore(I,null));continue}var P=_fetchStoredDb(I,!1),R=P.db;if(R){if((new Date).getTime()-R.lastAccessTime>bn){for(var w=Rn,_loop_3=function(){var g=R.events[w],m=f.db.events[w];_forEachMap(g,(function(f,S){return(getTenantId$1(f.iKey)||f.iKey)===T&&(m[S]=f,delete g[S]),!0})),w++};w<=wn;)_loop_3();C=!0,m.push(P)}}else m.push(_newStore(I,null))}}for(E=0;E<m.length;E++)_updateStoredDb(m[E],!1);C&&_updateStoredDb(f),S.setItem(b,_)}}f.id=m,S=_getAvailableStorage(g)||null,f.initialize=function(g){if(!S)return!1;var m=g.storageConfig||{};return I=m.maxStorageSizeInBytes>0?m.maxStorageSizeInBytes:I,v=m.storageKey||An,C=f.id||g.id||newGuid$1(),A=v+"."+C,b=v+In,E=g.itemCtx.getCfg().instrumentationKey,T=getTenantId$1(E)||E,_checkVersionAndMoveEventsToCurrentStorage(),!0},f.supportsSyncRequests=function(){return!0},f.getAllEvents=function(){try{var g=[],m=_fetchStoredDb(A,!1).db;if(m)for(var f=m.events,S=wn;S>=Rn;S--)_forEachMap(f[S],(function(m){m&&((getTenantId$1(m.iKey)||m.iKey)===T&&g.push(m));return!0}));return pn.resolve(g)}catch(g){return pn.reject(g)}},f.addEvent=function(g,m,f){try{var S=_fetchStoredDb(A);m.id=m.id||newGuid$1(),Mn(m.persistence)||(m.persistence=Rn);for(var v=m.persistence,C=m.id,_=S.db.events;;){if(_[v][C]=m,_updateStoredDb(S))return pn.resolve(m);if(delete _[v][C],!_dropEventsUpToPersistence(v,_))return pn.reject(new Error("Unable to free up event space"))}}catch(g){return pn.reject(g)}},f.removeEvents=function(g){try{var m=_fetchStoredDb(A,!1),f=m.db;if(f){var S=f.events;try{for(var v=0;v<g.length;++v){var C=g[v];delete S[C.persistence][C.id]}if(_updateStoredDb(m))return pn.resolve(g)}catch(g){}g=_clearDatabase(m.key)}return pn.resolve(g)}catch(g){return pn.reject(g)}},f.clear=function(){try{var g=[],m=_fetchStoredDb(A,!1),f=m.db;if(f){for(var S=f.events,_loop_2=function(m){var f=S[m];_forEachMap(f,(function(m){m&&((getTenantId$1(m.iKey)||m.iKey)===T&&(delete f[m.id],g.push(m)));return!0}))},v=wn;v>=Rn;v--)_loop_2(v);_updateStoredDb(m)}return pn.resolve(g)}catch(g){return pn.reject(g)}},f.teardown=function(){try{var g=_fetchStoredDb(A,!1),m=g.db;m&&(m.lastAccessTime=0,_updateStoredDb(g,!1))}catch(g){}}}))}return WebStorageProvider}(),On="readwrite",Nn="result",kn="DBError: Unable to open database",Ln="Database is not open",Fn="DBError: Failed to Open Cursor",xn="DBError: Failed to delete the database",Un="DBError: Database does not exist",Vn="DBError: Database upgrade required",Bn="DBError: Feature not supported",Hn=["indexedDB"],$n=isFunction$1,Gn=isString$1;function _getDbFactory(){var g=getGlobal$1()||{},m=null;if(g)try{for(var f=0;f<Hn.length;f++)if((m=g[Hn[f]])&&$n(m.open))return m}catch(g){m=null}return m||null}function _debugLog(g,m){getGlobalInst$1("QUnit")&&console&&console.log("IndexedDbHelper ["+g+"] "+m)}function _warnLog(g,m,f){g&&g.warnToConsole("IndexedDbHelper ["+m+"] "+f)}function _eventReject(g,m,f,S){return function(v){f(new Error(m)),_debugLog(g,"["+S+"] event rejected")}}var jn=[];function _getDbContext(g,m){for(var f=null,S=0;S<jn.length;S++)if((f=jn[S]).name===g)return f;return f={name:g,sch:new _n("IndexedDbHelper["+g+"]",m),dbHdl:[],add:function(m){f.dbHdl.push(m),_debugLog(g,"- dbOpened (add) -- hdls ["+f.dbHdl.length+"]")},remove:function(m){for(var S=f.dbHdl,v=0;v<S.length;v++)if(S[v]===m){S.splice(v,1);break}_debugLog(g,"- dbClosed (remove) -- hdls ["+f.dbHdl.length+"]")},isOpen:function(){return f.dbHdl.length>0},openHdl:function(){return f.dbHdl.length>0?f.dbHdl[0]:null}},jn.push(f),f}var Wn=function(){function IndexedDbHelper(g){dynamicProto(IndexedDbHelper,this,(function(m){var f=_getDbFactory()||null;function _createStoreContext(m,f){var S=m.db.transaction(f,On);return S.onabort=function(){_warnLog(g,m.dbName,"txn.onabort")},S.onerror=function(){_warnLog(g,m.dbName,"txn.onerror")},S.oncomplete=function(){_debugLog(m.dbName,"txn.oncomplete")},{db:m,store:S.objectStore(f),tx:S,tbl:f,openCursor:function(g,S){return _openCursor(m,f,g,S)},newTransaction:function(g){return _openStore(m,f,g)}}}function _openStore(g,m,f){if(!g||!g.db)return pn.reject(new Error(Ln));try{var S=f(_createStoreContext(g,m));return S instanceof pn?S:pn.resolve(S)}catch(g){return pn.reject(g)}}function _openCursor(g,m,f,S){if(!g||!g.db)return pn.reject(new Error(Ln));var v=null;return f&&Gn(f)?v=new qn(f):f&&f.isMatch&&(v=f),new pn((function(f,C){var _=[],E=null,T=null;v&&v.keyRange&&(T=v.keyRange());var I=_createStoreContext(g,m);(E=T?I.store.openCursor(T):I.store.openCursor()).onerror=_eventReject(I.db.dbName,Fn,C,"openCursor"),E.onsuccess=function(g){var m=g.target[Nn];if(m){var E={store:I,cursor:m,continue:function(){m.continue()},done:function(){f(_)}},T=m.value;if(!v||v.isMatch(T))if(S)try{switch(S(E,T,_)){case 2:f(_);break;case 1:break;default:E.continue()}}catch(g){C(g)}else _.push(T),E.continue();else E.continue()}else f(_)}}))}function _scheduleEvent(g,m,f,S){return _getDbContext(g).sch.scheduleEvent(f,m,S)}m.isAvailable=function(){return!!f},m.openDb=function(m,S,v,C){return _scheduleEvent(m,"openDb",(function(_){return new pn((function(E,T){var I=!1;function _createDbCtx(g,f,v,C,_){var E={db:f,dbName:m,dbVersion:S,ctx:null,isNew:C,txn:v?v.transaction:null};return _||(E.openStore=function(g,m){return _openStore(E,g,m)},E.openCursor=function(g,m,f){return _openCursor(E,g,m,f)}),E}function _databaseUpgrade(g,m){var f=_createDbCtx(null,g,m,!0,!0);if(C)I=!0,C(f).then((function(){f.txn||(f.txn=m.transaction)}),(function(g){try{m.transaction&&m.transaction.abort()}finally{T(g)}}));else try{m.transaction&&m.transaction.abort()}finally{T(new Error(Vn))}}function _databaseOpen(f,S){var C=_getDbContext(m);C.add(f),f.onabort=function(S){_warnLog(g,m,"onabort -- closing the Db"),C.remove(f)},f.onerror=function(S){_warnLog(g,m,"onerror -- closing the Db"),C.remove(f)},f.onclose=function(S){_warnLog(g,m,"onclose -- closing the Db"),C.remove(f)},f.onversionchange=function(S){_warnLog(g,m,"onversionchange -- force closing the Db"),f.close(),C.remove(f)};var _=null,b=null;C.dbHdl.length>0&&(b=C.dbHdl[0]),_=_createDbCtx(C,b,S,I);try{v(_).then((function(g){E(g)}),T)}catch(g){T(g)}}var b=_getDbContext(m);if(null==f)T(new Error("No available storage factory"));else if(b.isOpen()){var A=_createDbCtx(b,b.openHdl(),null,!1);v(A).then(E,T)}else{var P=f.open(m,S);P.onblocked=function(f){_warnLog(g,m,"Db Open Blocked event ["+_+"] - "+(P.error||"")),T(new Error(kn))},P.onerror=function(f){_warnLog(g,m,"Db Open Error event ["+_+"] - "+(P.error||"")),T(new Error(kn))},P.onupgradeneeded=function(g){_debugLog(m,"Db Open Create/Upgrade needed event ["+_+"]");try{var f=g.target[Nn];if(!f)return void T(new Error(kn));_databaseUpgrade(f,P)}catch(g){_eventReject(m,kn,T,_)(g)}},P.onsuccess=function(g){var m=g.target[Nn];m?_databaseOpen(m,P):T(new Error(kn))}}}))}))},m.closeDb=function(g){_scheduleEvent(g,"closeDb",(function(m){var f=_getDbContext(g),S=f.dbHdl,v=S.length;if(v>0){for(var C=0;C<v;C++)S[C].close();f.dbHdl=[]}return pn.resolve(1)}))},m.deleteDb=function(m){return null==f?pn.resolve(!1):_scheduleEvent(m,"deleteDb",(function(S){var v=_getDbContext(m),C=v.dbHdl,_=C.length;if(_>0){_warnLog(g,m,"Db is open ["+_+"] force closing");for(var E=0;E<_;E++)C[E].close();v.dbHdl=[]}return new pn((function(v,C){setTimeout((function(){try{_debugLog(m,"["+S+"] starting");var _=f.deleteDatabase(m);_.onerror=function(f){_warnLog(g,m,"["+S+"] error!!"),C(new Error(xn))},_.onblocked=function(f){_warnLog(g,m,"["+S+"] blocked!!"),C(new Error(xn))},_.onupgradeneeded=function(f){_warnLog(g,m,"["+S+"] upgrade needed!!"),C(new Error(xn))},_.onsuccess=function(g){_debugLog(m,"["+S+"] complete"),v(!0)},_debugLog(m,"["+S+"] started")}catch(f){_warnLog(g,m,"["+S+"] threw - "+f),C(new Error(xn+" - "+f))}}),0)}))}))},m.getDbDetails=function(g){return _scheduleEvent(g,"getDbDetails",(function(m){return null!=f&&f.databases?new pn((function(m,S){f.databases().then((function(f){for(var v=0;v<f.length;v++)if(f[v].name===g)return void m(f[v]);S(new Error(Un))}),S)})):pn.reject(new Error(Bn))}),2e3)}}))}return IndexedDbHelper}(),qn=function(){function SimpleQuery(g){var m=[],f=null;dynamicProto(SimpleQuery,this,(function(S){S.keyRange=function(){return f},S.parseQuery=function(g){if(m=[],g)for(var v=g.split(";"),C=0;C<v.length;C++){var _=v[C],E=_.indexOf("=");if(-1!==E){var T=_.substring(0,E),I=_.substring(E+1);0===T.indexOf("#")&&(T=T.substring(1),f||(f=IDBKeyRange.bound(I,I+"￿"))),S.startsWith(T,I)}}},S.startsWith=function(g,f){m.push({name:g,value:f,type:0})},S.contains=function(g,f){m.push({name:g,value:f,type:1})},S.isMatch=function(g){if(!m||0===m.length)return!0;if(!g)return!1;for(var f=0;f<m.length;f++){var S=m[f],v=g[S.name];if(v)if(0===S.type){if(0!==v.indexOf(S.value))return!1}else if(1===S.type&&-1===v.indexOf(S.value))return!1}return!0},g&&S.parseQuery(g)}))}return SimpleQuery}(),zn=10,Kn=1,Jn=6e5,Yn=1008e4,Qn="Unknown",Xn=-1,Zn="DBError: Unable to add event",er="DBError: Unable to update iKey",tr="AppInsightEvents.1",ir=1,nr="Evts",rr="iKey",sr=isValidPersistenceLevel;function _getTime$1(){return(new Date).getTime()}function _eventReject$1(g,m){return function(f){return m(new Error(g))}}function _createDb(g){g.objectStoreNames.contains(nr)||g.createObjectStore(nr,{keyPath:"key"}).createIndex("EvntId","key",{unique:!1});g.objectStoreNames.contains(rr)||g.createObjectStore(rr,{keyPath:"iKey"}).createIndex("iKey","iKey",{unique:!0})}function _updateiKey(g){return g.openStore(rr,(function(m){return new pn((function(f,S){var v={iKey:g.ctx.iKey,tm:_getTime$1()},C=m.store.put(v);C.onsuccess=function(g){f(C.result.toString())},C.onerror=function(g){S(new Error(Zn))},C.onerror=_eventReject$1(er,S)}))}))}function _orderEventsByPriority(g){for(var m=[],f=hn.Critical;f>=hn.Normal;f--)for(var S=0;S<g.length;S++){var v=g[S];v&&v.evt.persistence===f&&m.push(v.evt)}return m}function _addEventByTime(g,m){for(var f=0;f<g.length;f++)if(m.tm<g[f].tm)return void g.splice(f,0,m);g.push(m)}function _getKeyIndex(g,m){for(var f=m.length,S=0;S<f;S++)if(g===m[S].id)return S;return-1}function _isOldItem(g,m){var f=g.tm;return _getTime$1()-f>m}function _cursorContinueEvent(g){return function(m){return g.continue()}}function _cursorDeleteAndContinue(g){var m=g.cursor.delete();return m.onerror=_cursorContinueEvent(g),m.onsuccess=_cursorContinueEvent(g),1}function _getAllEventsForiKey(g,m){return g.openCursor(nr,m,(function(g,m,f){return f.push(m),0}))}function _deleteEvents(g,m,f){return g.openCursor(nr,m,(function(g,m,S){return f(m)?(S.push(m),_cursorDeleteAndContinue(g)):0}))}function _deleteOrphanedEvents(g){return new pn((function(m,f){var S=!1;g.openCursor(rr,null,(function(g,m,f){var v=m.tm;return _getTime$1()-v<Yn?0:(S=!0,2)})).then((function(){if(S){var v={};_deleteEvents(g,null,(function(g){if(!g||!g.evt||!g.evt.iKey)return!0;var m=g.tm;return _getTime$1()-m>Yn||(v[g.evt.iKey]=1,!1)})).then((function(){var S=[];g.openCursor(rr,null,(function(g,m,f){var C=m.tm;return _getTime$1()-C<Yn||v[m.iKey]?0:(S.push(m),_cursorDeleteAndContinue(g))})).then((function(){m(S)}),f)}),f)}else m([])}),f)}))}function _moveOldEventsToCurrentStore(g){return g.openCursor(nr,"#key="+g.ctx.iKeyPrefix(),(function(m,f){var S=f.key;if(0===S.indexOf(g.ctx.iKeyPrefix())&&-1===S.indexOf(g.ctx.evtKeyPrefix())&&_isOldItem(f,Jn)){f.key=g.ctx.evtKeyPrefix()+f.id;var v=m.store.store.put(f);return v.onerror=_cursorContinueEvent(m),v.onsuccess=function(g){try{_cursorDeleteAndContinue(m)}catch(g){m.continue()}},1}return 0}))}function _checkVersionAndMoveEventsToCurrentStorage(g){return new pn((function(m,f){_deleteOrphanedEvents(g).then((function(){_moveOldEventsToCurrentStore(g).then(m,m)}),f)}))}function _dropEventsUpToPersistence$1(g,m){return new pn((function(f,S){var v=0,C=g.ctx.evtKeyPrefix();function _resolveWithDroppedEvents(){f(v)}function _dropEvent(g,m){return new pn((function(f){var S=g.store.delete(m.key);S.onsuccess=function(g){v++,f()},S.onerror=function(g){f()}}))}function _processCandidates(m){0!==m.length?g.openStore(nr,(function(g){for(var f=[],S=0;S<m.length;S++)f.push(_dropEvent(g,m[S]));return pn.all(f).then(_resolveWithDroppedEvents,_resolveWithDroppedEvents)})):_resolveWithDroppedEvents()}g.openCursor(nr,"#key="+C,(function(g,f,S){return f.evt.persistence<=m&&0===f.key.indexOf(C)&&(_addEventByTime(S,f),S.length>zn&&S.splice(S.length-1,1)),0})).then(_processCandidates,(function(){f(0)}))}))}var ar=function(){function IndexedDbProvider(g){dynamicProto(IndexedDbProvider,this,(function(m){var f=null,S=null,v=Qn,C=null,_=null,E=null,T=Xn,I=0;function _openDb(g){function _handleDbUpgrade(g){return new pn((function(m,f){_createDb(g.db),m()}))}function _handleDbOpen(m){return new pn((function(f,S){var T={iKey:v,storageId:C,iKeyPrefix:function(){return _},evtKeyPrefix:function(){return E}};m.ctx=T,_updateiKey(m).then((function(){g(m).then(f,S)}),S)}))}return f.openDb(S,ir,_handleDbOpen,_handleDbUpgrade)}function _addDbEvent(g,m,f){return new pn((function(S,v){function dropEvents(m,f){_dropEventsUpToPersistence$1(g,m).then((function(g){g>0&&(I-=g),f(g)}),(function(g){f(0)}))}function resolveAddEvent(g){S(m.evt)}function _insertNewEvent(){g.openStore(nr,(function(C){var _=C.store.put(m);_.onsuccess=function(v){f&&_updateiKey(g).then(resolveAddEvent,resolveAddEvent),I++,S(m.evt)},_.onerror=function(C){function _retryAddEvent(f){0===f&&v(new Error(Zn)),_addDbEvent(g,m,!1).then((function(g){S(m.evt)}),(function(){v(new Error(Zn))}))}f?dropEvents(hn.Normal,(function(g){g>0?_retryAddEvent(g):m.evt.persistence>=hn.Critical?dropEvents(hn.Critical,(function(g){_retryAddEvent(g)})):v(new Error(Zn))})):v(new Error(Zn))}}))}T>0&&I>=T?dropEvents(hn.Normal,(function(g){0===g?m.evt.persistence>=hn.Critical?dropEvents(hn.Critical,(function(g){_insertNewEvent()})):v(new Error(Zn)):_insertNewEvent()})):_insertNewEvent()}))}m.id=g,m.initialize=function(g){var I=g.itemCtx.diagLog();if(!(f=new Wn(I)).isAvailable())return f=null,!1;var b=g.itemCtx.getCfg(),A=g.storageConfig||{};return S=A.indexedDbName||tr,v=b.instrumentationKey||v,C=m.id||g.id||newGuid$1(),E=(_=v+"::")+C+"::",T=A.maxStorageItems>0?A.maxStorageItems:T,_openDb((function(g){return g.isNew?pn.resolve(!0):_checkVersionAndMoveEventsToCurrentStorage(g)})).then((function(g){}),(function(g){I.warnToConsole("IndexedDbProvider failed to initialize - "+(g||"<unknown>")),f=null})),!0},m.supportsSyncRequests=function(){return!1},m.getAllEvents=function(){return null!=f&&f.isAvailable()?_openDb((function(g){return new pn((function(m,f){_getAllEventsForiKey(g,"#key="+g.ctx.evtKeyPrefix()).then((function(g){I=g.length,m(_orderEventsByPriority(g))}),f)}))})):pn.resolve([])},m.addEvent=function(g,m,S){return null!=f&&f.isAvailable()?(m.id=m.id||newGuid$1(),sr(m.persistence)||(m.persistence=hn.Normal),_openDb((function(f){var S=g||m.id,v={key:f.ctx.evtKeyPrefix()+S,id:S,evt:m,tm:_getTime$1(),v:Kn};return _addDbEvent(f,v,!0)}))):pn.resolve(m)},m.removeEvents=function(g){if(null==f||!f.isAvailable())return pn.resolve([]);var m=[];return new pn((function(f,S){_openDb((function(f){return f.openCursor(nr,"#key="+f.ctx.iKey,(function(f,S,v){if(-1!==_getKeyIndex(S.id,g)){var C=f.cursor.delete();return C.onerror=_cursorContinueEvent(f),C.onsuccess=function(){m.push(S.evt),f.continue()},1}return 0}))})).then((function(g){I-=m.length,f(m)}),(function(g){I-=m.length,f(m)}))}))},m.clear=function(){return null!=f&&f.isAvailable()?new pn((function(g,m){_openDb((function(g){return _deleteEvents(g,"#key="+g.ctx.evtKeyPrefix(),(function(m){return 0===m.key.indexOf(g.ctx.evtKeyPrefix())}))})).then((function(m){I=0,g(_orderEventsByPriority(m))}),m)})):pn.resolve([])},m.teardown=function(){f&&f.closeDb(S)}}))}return IndexedDbProvider}(),or="3.1.3",lr="LocalStorage",cr=5,dr=isValidPersistenceLevel,hr=function(g){function LocalStorageChannel(){var m=g.call(this)||this;return m.identifier=lr,m.priority=1009,m.version=or,dynamicProto(LocalStorageChannel,m,(function(g,m){var f=!1,S=!1,v=null,C=[];function _queueStorageEvent(g,m){v||(v=new _n("LocalStorage")),v.scheduleEvent((function(g){return m(g)}),g)}function _sendStoredEventsToNextPlugin(m){doPerf$1(g.core,(function(){return"LocalStorageChannel:_sendStoredEventsToNextPlugin"}),(function(){_queueStorageEvent("sendToNext",(function(f){return m.provider.getAllEvents().then((function(f){for(var S=0;S<f.length;S++)try{var v=f[S];(getTenantId$1(v.iKey)||v.iKey)===m.tenantId&&g.processNext(v,m.coreRootCtx.createNew())}catch(g){}}))}))}),(function(){return{iKeyConfig:m}}))}function _removeEvents(m,f){doPerf$1(g.core,(function(){return"LocalStorageChannel:_removeEvents"}),(function(){_queueStorageEvent("removeEvents",(function(g){var S=[];return arrForEach$1(f,(function(g){(getTenantId$1(g.iKey)||g.iKey)===m.tenantId&&S.push(g)})),S.length>0?m.provider.removeEvents(S).then((function(g){})).catch((function(g){})):pn.resolve()}))}),(function(){return{iKeyConfig:m,events:f}}))}function _shouldCacheEvent(g,m){return!(m.sync||m.persistence<g.minPersistenceCacheLevel)}function _tryGetIndexedDbProvider(g){var m=new ar;return m.initialize(g)||(m=null),m}function _tryGetWebStorageProvider(g,m){var f=new Dn(g);return f.initialize(m)||(f=null),f}function _initializeProvider(g){for(var m=g.storageConfig.providers,f=null,S=0;!f&&S<m.length&&S<cr;)switch(m[S++]){case Cn.LocalStorage:f=_tryGetWebStorageProvider("localStorage",g);break;case Cn.SessionStorage:f=_tryGetWebStorageProvider("sessionStorage",g);break;case Cn.IndexedDb:f=_tryGetIndexedDbProvider(g)}return f}function _getCoreItemCtx(m,f,S,v){m&&(m.extensionConfig=m.extensionConfig||[]),!v&&f&&(v=f.getProcessTelContext().getNext());var C=null,_=g._getTelCtx().getNext();return _&&(C=_.getPlugin()),new Xi(v,m,f,C)}function _createIkeyConfig(m,f,S,v){var _=g.identifier,E=m.extensionConfig=m.extensionConfig||[],T=E[_]=E[_]||{};T.providers||(T.providers=[Cn.LocalStorage,Cn.IndexedDb]);var I=_getCoreItemCtx(m,f,S,v),b={itemCtx:I,storageConfig:T,id:g.id},A=_initializeProvider(b);if(A){var P={iKey:m.instrumentationKey,tenantId:getTenantId$1(m.instrumentationKey)||m.instrumentationKey,minPersistenceCacheLevel:hn.Normal,coreRootCtx:I,providerContext:b,provider:A};dr(T.minPersistenceLevel||-1)&&(P.minPersistenceCacheLevel=T.minPersistenceLevel),C.push(P),f.addNotificationListener({eventsSent:function(g){_removeEvents(P,g)},eventsDiscarded:function(g,m){_removeEvents(P,g)}}),_sendStoredEventsToNextPlugin(P)}}g.initialize=function(g,S,C,_){doPerf$1(S,(function(){return"LocalStorageChannel.initialize"}),(function(){f||(m.initialize(g,S,C),m.setInitialized(!1),f=!0,v=new _n("LocalStorage",S.logger)),_createIkeyConfig(g,S,C,_)}),(function(){return{coreConfig:g,core:S,extensions:C,pluginChain:_}}))},g.processTelemetry=function(m,f){f=g._getTelCtx(f),setProcessTelemetryTimings$1(m,g.identifier);var v=null;arrForEach$1(C,(function(g){g.iKey===m.iKey&&(v=g)}));var _=S,E=v?v.provider:null,T=m;!T.sync&&E?(T.id=T.id||newGuid$1(),isValidPersistenceLevel(T.persistence)||(T.persistence=1),_shouldCacheEvent(v,T)&&_queueStorageEvent("processTelemetry",(function(g){return E.addEvent(T.id,T,f)})),_||g.processNext(T,f)):g.processNext(T,f)},g.pause=function(){S=!0},g.resume=function(){doPerf$1(g.core,(function(){return"LocalStorageChannel:resume"}),(function(){S=!1,arrForEach$1(C,(function(g){g.provider&&_sendStoredEventsToNextPlugin(g)}))}))},g.teardown=function(){arrForEach$1(C,(function(g){var m=g.provider;m&&m.teardown()})),C=[]},g.flush=function(g,m){}})),m}return __extendsFn$1(LocalStorageChannel,g),LocalStorageChannel}(tn),ur="function",gr="object",pr="undefined",mr="prototype",fr="hasOwnProperty",Sr=Object,vr=Sr.create,yr=null;function getGlobal$2(g){void 0===g&&(g=!0);var m=!1===g?null:yr;return m||(typeof globalThis!==pr&&(m=globalThis),m||typeof self===pr||(m=self),m||typeof window===pr||(m=window),m||typeof global===pr||(m=global),yr=m),m}function throwTypeError$2(g){throw new TypeError(g)}function objCreateFn$2(g){if(vr)return vr(g);if(null==g)return{};var m=typeof g;function tmpFunc(){}return m!==gr&&m!==ur&&throwTypeError$2("Object prototype may only be an Object:"+g),tmpFunc[mr]=g,new tmpFunc}(getGlobal$2()||{}).Symbol,(getGlobal$2()||{}).Reflect;var extendStaticsFn$2=function(g,m){return extendStaticsFn$2=Sr.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m[fr](f)&&(g[f]=m[f])},extendStaticsFn$2(g,m)};function __extendsFn$2(g,m){function __(){this.constructor=g}typeof m!==ur&&null!==m&&throwTypeError$2("Class extends value "+String(m)+" is not a constructor or null"),extendStaticsFn$2(g,m),g[mr]=null===m?objCreateFn$2(m):(__[mr]=m[mr],new __)}var Cr="REAL_TIME",_r="NEAR_REAL_TIME",Er="BEST_EFFORT",Tr=function(){function EventBatch(g,m){var f=m?[].concat(m):[],S=this;S.iKey=function(){return g},S.count=function(){return f.length},S.events=function(){return f},S.addEvents=function(g,m){return void 0===m&&(m=!0),g&&g.length>0?(f=m?f.concat(g):g.concat(f),g.length):0},S.split=function(m,S){var v=new EventBatch(g);if(m<f.length){var C=f.length-m;isNullOrUndefined(S)||(C=S<C?S:C),v.addEvents(f.splice(m,C),!0)}return v}}return EventBatch.create=function(g,m){return new EventBatch(g,m)},EventBatch}(),Ir=20,br=3984588,Ar=65e3,Pr=2e6,Rr=Math.min(Pr,Ar),wr="metadata",Mr="f",Dr=/\./,Or=function(){function Serializer(g,m,f,S){var v="data",C="baseData",_="ext",E=!!S,T=!0,I=m,b={};dynamicProto(Serializer,this,(function(m){function _isReservedField(g,m){var f=b[g];return void 0===f&&(g.length>=7&&(f=strStartsWith(g,"ext.metadata")||strStartsWith(g,"ext.web")),b[g]=f),f}function _processPathKeys(g,m,S,v,C,_,T){objForEachKey(g,(function(g,b){var A=null;if(b||isValueAssigned(b)){var P=S,R=g,w=C,M=m;if(E&&!v&&Dr.test(g)){var D=g.split("."),O=D.length;if(O>1){w&&(w=w.slice());for(var N=0;N<O-1;N++){var k=D[N];M=M[k]=M[k]||{},P+="."+k,w&&w.push(k)}R=D[O-1]}}if(A=!(v&&_isReservedField(P))&&I&&I.handleField(P,R)?I.value(P,R,b,f):sanitizeProperty(R,b,f)){var L=A.value;if(M[R]=L,_&&_(w,R,A),T&&"object"==typeof L&&!isArray(L)){var F=w;F&&(F=F.slice()).push(R),_processPathKeys(b,L,P+"."+R,v,F,_,T)}}}}))}m.createPayload=function(g,m,f,S,v){return{apiKeys:[],payloadBlob:"",overflow:null,sizeExceed:[],failedEvts:[],batches:[],numEvents:0,retryCnt:g,isTeardown:m,isSync:f,isBeacon:S,sendReason:v}},m.appendPayload=function(f,S,v){var C=f&&S&&!f.overflow;return C&&doPerf(g,(function(){return"Serializer:appendPayload"}),(function(){for(var g=S.events(),C=f.payloadBlob,_=f.numEvents,E=!1,T=[],I=[],b=f.isBeacon,A=b?Ar:br,P=b?Rr:Pr,R=0,w=0;R<g.length;){var M=g[R];if(M){if(_>=v){f.overflow=S.split(R);break}var D=m.getEventBlob(M);if(D&&D.length<=P){var O=D.length;if(C.length+O>A){f.overflow=S.split(R);break}C&&(C+="\n"),C+=D,++w>Ir&&(C.substr(0,1),w=0),E=!0,_++}else D?T.push(M):I.push(M),g.splice(R,1),R--}R++}if(T&&T.length>0&&f.sizeExceed.push(Tr.create(S.iKey(),T)),I&&I.length>0&&f.failedEvts.push(Tr.create(S.iKey(),I)),E){f.batches.push(S),f.payloadBlob=C,f.numEvents=_;var N=S.iKey();-1===arrIndexOf(f.apiKeys,N)&&f.apiKeys.push(N)}}),(function(){return{payload:f,theBatch:{iKey:S.iKey(),evts:S.events()},max:v}})),C},m.getEventBlob=function(m){try{return doPerf(g,(function(){return"Serializer.getEventBlob"}),(function(){var g={};g.name=m.name,g.time=m.time,g.ver=m.ver,g.iKey="o:"+getTenantId(m.iKey);var f={},S=m[_];S&&(g[_]=f,objForEachKey(S,(function(g,m){_processPathKeys(m,f[g]={},"ext."+g,!0,null,null,!0)})));var E=g[v]={};E.baseType=m.baseType;var I=E[C]={};return _processPathKeys(m.baseData,I,C,!1,[C],(function(g,m,S){_addJSONPropertyMetaData(f,g,m,S)}),T),_processPathKeys(m.data,E,v,!1,[],(function(g,m,S){_addJSONPropertyMetaData(f,g,m,S)}),T),JSON.stringify(g)}),(function(){return{item:m}}))}catch(g){return null}}}))}return Serializer}();function _addJSONPropertyMetaData(g,m,f,S){if(S&&g){var v=getCommonSchemaMetaData(S.value,S.kind,S.propertyType);if(v>-1){var C=g[wr];C||(C=g[wr]={f:{}});var _=C[Mr];if(_||(_=C[Mr]={}),m)for(var E=0;E<m.length;E++){var T=m[E];_[T]||(_[T]={f:{}});var I=_[T][Mr];I||(I=_[T][Mr]={}),_=I}_=_[f]={},isArray(S.value)?_.a={t:v}:_.t=v}}}
/**
* RetryPolicy.ts
* @author Abhilash Panwar (abpanwar)
* @copyright Microsoft 2018
*/var Nr,kr=.8,Lr=1.2,Fr=3e3,xr=6e5,Ur=function(){function RetryPolicy(){}return RetryPolicy.shouldRetryForStatus=function(g){return!(g>=300&&g<500&&408!==g&&429!==g||501===g||505===g)},RetryPolicy.getMillisToBackoffForRetry=function(g){var m=0,f=Fr*kr,S=Fr*Lr,v=Math.floor(Math.random()*(S-f))+f;return m=Math.pow(2,g)*v,Math.min(m,xr)},RetryPolicy}(),Vr=1e3,Br=function(){function KillSwitch(){var g={};function _normalizeTenants(g){var m=[];return g&&arrForEach(g,(function(g){m.push(strTrim(g))})),m}dynamicProto(KillSwitch,this,(function(m){m.setKillSwitchTenants=function(m,f){if(m&&f)try{var S=_normalizeTenants(m.split(","));if("this-request-only"===f)return S;for(var v=parseInt(f,10)*Vr,C=0;C<S.length;++C)g[S[C]]=dateNow()+v}catch(g){return[]}return[]},m.isTenantKilled=function(m){var f=g,S=strTrim(m);return void 0!==f[S]&&f[S]>dateNow()||(delete f[S],!1)}}))}return KillSwitch}(),Hr=function(){function ClockSkewManager(){var g=!0,m=!0,f=!0,S="use-collector-delta",v=!1;dynamicProto(ClockSkewManager,this,(function(C){C.allowRequestSending=function(){return g},C.firstRequestSent=function(){f&&(f=!1,v||(g=!1))},C.shouldAddClockSkewHeaders=function(){return m},C.getClockSkewHeaderValue=function(){return S},C.setClockSkew=function(f){v||(f?(S=f,m=!0,v=!0):m=!1,g=!0)}}))}return ClockSkewManager}(),$r="POST",Gr="Microsoft_ApplicationInsights_BypassAjaxInstrumentation",jr="drop",Wr="send",qr="requeue",zr="rspFail",Kr="oth",Jr="kill-tokens",Yr="kill-duration",Qr="kill-duration-seconds",Xr="time-delta-millis",Zr=((Nr={})[1]=qr,Nr[100]=qr,Nr[200]="sent",Nr[8004]=jr,Nr[8003]=jr,Nr);function _getResponseText(g){try{return g.responseText}catch(g){}return""}var es=function(){function HttpManager(g,m,f,S){this._responseHandlers=[];var v,C,_,E,T,I="?cors=true&content-type=application/x-json-stream&client-id=NO_AUTH&client-version="+ai,b=new Br,A=!1,P=new Hr,R=!1,w=0,M=!0,D=[],O={},N=[],k=null,L=!1;dynamicProto(HttpManager,this,(function(F){var x=!0;function _getSenderInterface(g){for(var m=0,f=null,S=0;null==f&&S<g.length;)1===(m=g[S])?useXDomainRequest()?f=_xdrSendPost:"undefined"!=typeof XMLHttpRequest&&(f=_xhrSendPost):2===m?f=_fetchSendPost:R&&3===m&&isBeaconsSupported()&&(f=_beaconSendPost),S++;return f?{_transport:m,sendPOST:f}:null}function _xdrSendPost(g,m,f){var S=new XDomainRequest;S.open($r,g.urlString),S.onload=function(){var g=_getResponseText(S);_doOnComplete(m,200,{},g),_handleCollectorResponse(g)},S.onerror=function(){_doOnComplete(m,400,{})},S.ontimeout=function(){_doOnComplete(m,500,{})},S.onprogress=function(){},f?S.send(g.data):v._setTimeoutOverride((function(){S.send(g.data)}),0)}function _fetchSendPost(g,m){var f,S=((f={body:g.data,method:$r})[Gr]=!0,f);x&&(S.credentials="include"),g.headers&&objKeys(g.headers).length>0&&(S.headers=g.headers),fetch(g.urlString,S).then((function(g){var f={},S="";g.headers&&g.headers.forEach((function(g,m){f[m]=g})),g.body&&g.text().then((function(g){S=g})),_doOnComplete(m,g.status,f,S),_handleCollectorResponse(S)})).catch((function(g){_doOnComplete(m,0,{})}))}function _xhrSendPost(g,m,f){function _appendHeader(g,m,f){if(!g[f]&&m&&m.getResponseHeader){var S=m.getResponseHeader(f);S&&(g[f]=strTrim(S))}return g}function _getAllResponseHeaders(g){var m={};return g.getAllResponseHeaders?m=_convertAllHeadersToMap(g.getAllResponseHeaders()):(m=_appendHeader(m,g,Xr),m=_appendHeader(m,g,Yr),m=_appendHeader(m,g,Qr)),m}function xhrComplete(g,f){_doOnComplete(m,g.status,_getAllResponseHeaders(g),f)}var S=new XMLHttpRequest;try{S[Gr]=!0}catch(g){}x&&(S.withCredentials=!0),S.open($r,g.urlString,!f),objForEachKey(g.headers,(function(g,m){S.setRequestHeader(g,m)})),S.onload=function(){var g=_getResponseText(S);xhrComplete(S,g),_handleCollectorResponse(g)},S.onerror=function(){xhrComplete(S)},S.ontimeout=function(){xhrComplete(S)},S.send(g.data)}function _doOnComplete(g,m,f,S){try{g(m,f,S)}catch(g){v.diagLog().throwInternal(Ne.WARNING,si.SendPostOnCompleteFailure,dumpObj(g))}}function _beaconSendPost(g,m,f){var S=200,C=g._thePayload;try{var _=getNavigator();if(!_.sendBeacon(g.urlString,g.data))if(C){var E=[];arrForEach(C.batches,(function(m){if(E&&m&&m.count()>0){for(var f=m.events(),S=0;S<f.length;S++)if(!_.sendBeacon(g.urlString,k.getEventBlob(f[S]))){E.push(m.split(S));break}}else E.push(m.split(0))})),_sendBatchesNotification(E,8003,C.isSync,!0)}else S=0}catch(g){v.diagLog().warnToConsole("Failed to send telemetry using sendBeacon API. Ex:"+g),S=0}finally{_doOnComplete(m,S,{},"")}}function _hasIdleConnection(){return!A&&w<m}function _clearQueue(){var g=N;return N=[],g}function _canSendPayload(g,m,f){var S=!1;return g&&g.length>0&&!A&&C&&k&&(S=m||_hasIdleConnection()&&(f>0||P.allowRequestSending())),S}function _createDebugBatches(g){var m={};return g&&arrForEach(g,(function(g,f){m[f]={iKey:g.iKey(),evts:g.events()}})),m}function _sendBatches(m,f,S,_,T,I){if(m&&0!==m.length)if(A)_sendBatchesNotification(m,1,_);else try{var P=m;doPerf(E,(function(){return"HttpManager:_sendBatches"}),(function(v){v&&(m=m.slice(0));for(var E=[],A=null,P=di(),R=(I||C&&3===C._transport)&&_canUseSendBeaconApi();_canSendPayload(m,_,f);){var w=m.shift();w&&w.count()>0&&(b.isTenantKilled(w.iKey())?E.push(w):(A=A||k.createPayload(f,S,_,R,T),k.appendPayload(A,w,g)?null!==A.overflow&&(m=[A.overflow].concat(m),A.overflow=null,_doPayloadSend(A,P,di(),T),P=di(),A=null):(_doPayloadSend(A,P,di(),T),P=di(),m=[w].concat(m),A=null)))}A&&_doPayloadSend(A,P,di(),T),m.length>0&&(N=m.concat(N)),_sendBatchesNotification(E,8004,_)}),(function(){return{batches:_createDebugBatches(P),retryCount:f,isTeardown:S,isSynchronous:_,sendReason:T,useSendBeacon:I}}),!_)}catch(g){v.diagLog().throwInternal(Ne.WARNING,si.CannotSerializeObject,"Unexpected Exception sending batch: "+dumpObj(g))}}function _buildQueryString(g){var m=I,f="";arrForEach(g.apiKeys,(function(g){f.length>0&&(f+=","),f+=g})),f.length>0&&(m+="&apikey="+f),m+="&upload-time="+dateNow().toString();var S=_getMsfpc(g);if(isValueAssigned(S)&&(m=m+"&ext.intweb.msfpc="+S),P.shouldAddClockSkewHeaders()&&(m+="&time-delta-to-apply-millis="+P.getClockSkewHeaderValue()),E.getWParam){var v=E.getWParam();v>=0&&(m+="&w="+v)}for(var C=0;C<D.length;C++)m+="&"+D[C].name+"="+D[C].value;return m}function _canUseSendBeaconApi(){return!M&&R&&isBeaconsSupported()}function _setTimingValue(g,m,f){g[m]=g[m]||{},g[m][v.identifier]=f}function _doPayloadSend(g,m,f,S){if(g&&g.payloadBlob&&g.payloadBlob.length>0){var T=_buildQueryString(g),I=di(),b="sendAttempt";doPerf(E,(function(){return"HttpManager:_doPayloadSend"}),(function(){for(var A=0;A<g.batches.length;A++)for(var R=g.batches[A].events(),D=0;D<R.length;D++){var N=R[D];if(L){var k=N.timings=N.timings||{};_setTimingValue(k,"sendEventStart",I),_setTimingValue(k,"serializationStart",m),_setTimingValue(k,"serializationCompleted",f)}N[b]>0?N[b]++:N[b]=1}_sendBatchesNotification(g.batches,1e3+(S||0),g.isSync,!0);var x={data:g.payloadBlob,urlString:T,headers:extend({},O),_thePayload:g,_sendReason:S},U=null,V=!!F.sendHook,B=C;_&&g.isBeacon&&2===g.sendReason&&(B=_),B&&(U=function(m){P.firstRequestSent();var onComplete=function(m,f){_retryRequestIfNeeded(m,f,g,S)};try{B.sendPOST(m,onComplete,g.isTeardown||g.isSync),F.sendListener&&F.sendListener(x,m,g.isSync||g.isTeardown,g.isBeacon)}catch(g){v.diagLog().warnToConsole("Unexpected exception sending payload. Ex:"+dumpObj(g)),_doOnComplete(onComplete,0,{})}}),doPerf(E,(function(){return"HttpManager:_doPayloadSend.sender"}),(function(){if(U)if(g.isSync||g.isBeacon||w++,V&&!g.isBeacon&&3!==B._transport){var m={data:x.data,urlString:x.urlString,headers:x.headers},f=!1;doPerf(E,(function(){return"HttpManager:_doPayloadSend.sendHook"}),(function(){try{F.sendHook(m,(function(g){f=!0,M||g._thePayload||(g._thePayload=g._thePayload||x._thePayload,g._sendReason=g._sendReason||x._sendReason),U(g)}),g.isSync||g.isTeardown)}catch(g){f||U(x)}}))}else U(x)}))}),(function(){return{thePayload:g,serializationStart:m,serializationCompleted:f,sendReason:S}}),g.isSync)}g.sizeExceed&&g.sizeExceed.length>0&&_sendBatchesNotification(g.sizeExceed,8003,g.isSync),g.failedEvts&&g.failedEvts.length>0&&_sendBatchesNotification(g.failedEvts,8002,g.isSync)}function _addEventCompletedTimings(g,m){L&&arrForEach(g,(function(g){_setTimingValue(g.timings=g.timings||{},"sendEventCompleted",m)}))}function _retryRequestIfNeeded(g,m,S,v){var C=9e3,_=null,E=!1,T=!1;try{var I=!0;if(typeof g!==ee){if(m){P.setClockSkew(m[Xr]);var A=m[Yr]||m["kill-duration-seconds"];arrForEach(b.setKillSwitchTenants(m[Jr],A),(function(g){arrForEach(S.batches,(function(m){if(m.iKey()===g){_=_||[];var f=m.split(0);S.numEvents-=f.count(),_.push(f)}}))}))}if(200===g)return void(C=200);(!Ur.shouldRetryForStatus(g)||S.numEvents<=0)&&(I=!1),C=9e3+g%1e3}if(I){C=100;var R=S.retryCnt;S.isSync||S.isBeacon||(R<f?(E=!0,_doAction((function(){S.isSync||S.isBeacon||w--,_sendBatches(S.batches,R+1,S.isTeardown,S.isSync,5,S.isBeacon)}),!0,Ur.getMillisToBackoffForRetry(R))):T=!0)}}finally{E||(P.setClockSkew(),_handleRequestFinished(S,C,v,T)),_sendBatchesNotification(_,8004,S.isSync)}}function _handleRequestFinished(g,m,f,S){try{S&&v._backOffTransmission(),200===m&&(S||g.isSync||v._clearBackOff(),_addCompleteTimings(g.batches)),_sendBatchesNotification(g.batches,m,g.isSync,!0)}finally{g.isSync||g.isBeacon||(w--,5!==f&&F.sendQueuedRequests(f,!g.isSync,g.isBeacon))}}function _addCompleteTimings(g){if(L){var m=di();arrForEach(g,(function(g){g&&g.count()>0&&_addEventCompletedTimings(g.events(),m)}))}}function _doAction(g,m,f){m?g():v._setTimeoutOverride(g,f)}function _convertAllHeadersToMap(g){var m={};isString(g)&&arrForEach(strTrim(g).split(/[\r\n]+/),(function(g){if(g){var f=g.indexOf(": ");if(-1!==f){var S=strTrim(g.substring(0,f)).toLowerCase(),v=strTrim(g.substring(f+1));m[S]=v}else m[strTrim(g)]=1}}));return m}function _getMsfpc(g){for(var m=0;m<g.batches.length;m++)for(var f=g.batches[m].events(),S=0;S<f.length;S++){var v=(f[S].ext||{}).intweb||{};if(isValueAssigned(v.msfpc))return encodeURIComponent(v.msfpc)}return""}function _handleCollectorResponse(g){var m=F._responseHandlers;try{for(var f=0;f<m.length;f++)try{m[f](g)}catch(g){v.diagLog().throwInternal(Ne.CRITICAL,si.PostResponseHandler,"Response handler failed: "+g)}if(g){var S=JSON.parse(g);isValueAssigned(S.webResult)&&isValueAssigned(S.webResult.msfpc)&&T.set("MSFPC",S.webResult.msfpc,31536e3)}}catch(g){}}function _sendBatchesNotification(g,m,f,C){if(g&&g.length>0&&S){var _=S[_getNotificationAction(m)];_&&doPerf(E,(function(){return"HttpManager:_sendBatchesNotification"}),(function(){_doAction((function(){try{_.call(S,g,m,f)}catch(g){v.diagLog().throwInternal(Ne.CRITICAL,si.NotificationException,"send request notification failed: "+g)}}),C||f,0)}),(function(){return{batches:_createDebugBatches(g),reason:m,isSync:f,sendSync:C}}),!f)}}function _getNotificationAction(g){var m=Zr[g];return isValueAssigned(m)||(m=Kr,g>=9e3&&g<=9999?m=zr:g>=8e3&&g<=8999?m=jr:g>=1e3&&g<=1999&&(m=Wr)),m}F.initialize=function(g,m,f,S,b){b||(b={}),I=g+I,E=m,T=m.getCookieMgr(),L=!E.config.disableEventTimings;var A=!!E.config.enableCompoundKey;v=f;var P=b.valueSanitizer,w=b.stringifyObjects;if(isUndefined(b.enableCompoundKey)||(A=!!b.enableCompoundKey),R=!isReactNative(),k=new Or(E,P,w,A),_=_getSenderInterface([3]),!(C=S)){M=!1;var D=getLocation();D&&D.protocol&&"file:"===D.protocol.toLowerCase()&&(x=!1);var O=[];O=isReactNative()?[2,1]:[1,2,3];var N=b.transports;N&&(isNumber(N)?O=[N].concat(O):isArray(N)&&(O=N.concat(O))),(C=_getSenderInterface(O))||v.diagLog().warnToConsole("No available transport to send events")}},F._getDbgPlgTargets=function(){return[C,b,k]},F.addQueryStringParameter=function(g,m){for(var f=0;f<D.length;f++)if(D[f].name===g)return void(D[f].value=m);D.push({name:g,value:m})},F.addHeader=function(g,m){O[g]=m},F.canSendRequest=function(){return _hasIdleConnection()&&P.allowRequestSending()},F.sendQueuedRequests=function(g,m,f){var S=!isNullOrUndefined(m)&&!m;_canSendPayload(N,S,0)&&_sendBatches(_clearQueue(),0,!1,S,g||0,!!f)},F.isCompletelyIdle=function(){return!A&&0===w&&0===N.length},F.addBatch=function(g){if(g&&g.count()>0){if(b.isTenantKilled(g.iKey()))return!1;N.push(g)}return!0},F.teardown=function(){N.length>0&&_sendBatches(_clearQueue(),0,!0,!0,2,!0)},F.pause=function(){A=!0},F.resume=function(){A=!1,F.sendQueuedRequests(4,!1)},F.sendSynchronousBatch=function(g,m,f){g&&g.count()>0&&_sendBatches([g],0,!1,!0,m||0,!!f)}}))}return HttpManager}(),ts=.25,is=500,ns=20,rs=6,ss=4,as=ci?window:void 0,os=2,ls=1,cs="eventsDiscarded",ds="overrideInstrumentationKey",hs=function(g){function PostChannel(){var m,f=g.call(this)||this;f.identifier="PostChannel",f.priority=1011,f.version="3.1.2";var S,v,C,_,E,T=!1,I=[],b=null,A=!1,P=0,R=500,w=0,M=1e4,D={},O=Cr,N=null,k=null,L=0,F=0,x={},U=-1,V=!0;return dynamicProto(PostChannel,f,(function(g,f){function _addEventToQueues(g,m){if(g.sendAttempt||(g.sendAttempt=0),g.latency||(g.latency=ni.Normal),g.ext&&g.ext.trace&&delete g.ext.trace,g.ext&&g.ext.user&&g.ext.user.id&&delete g.ext.user.id,V&&(g.ext=optimizeObject(g.ext),g.baseData&&(g.baseData=optimizeObject(g.baseData)),g.data&&(g.data=optimizeObject(g.data))),g.sync)if(L||A)g.latency=ni.RealTime,g.sync=!1;else if(v)return V&&(g=optimizeObject(g)),void v.sendSynchronousBatch(Tr.create(g.iKey,[g]),3);var f=g.latency,S=w,C=M;f===ni.Immediate&&(S=P,C=R);var _=!1;if(S<C)_=!_addEventToProperQueue(g,m);else{var E=ni.Normal,T=ns;f===ni.Immediate&&(E=ni.Immediate,T=1),_=!0,_dropEventWithLatencyOrLess(g.iKey,g.latency,E,T)&&(_=!_addEventToProperQueue(g,m))}_&&_notifyEvents(cs,[g],he.QueueFull)}function _sendEventsForLatencyAndAbove(g,m,f,S){var C=_queueBatches(g,m,f);return v.sendQueuedRequests(m,f,S),C}function _hasEvents(){return w>0}function _scheduleTimer(){if(U>=0&&_queueBatches(U,E,!0)&&v.sendQueuedRequests(E,!0,!1),P>0&&!k&&!A){var g=D[O][2];g>=0&&(k=_createTimer((function(){k=null,_sendEventsForLatencyAndAbove(ni.Immediate,1,!0),_scheduleTimer()}),g))}var m=D[O][1];!N&&!b&&m>=0&&!A&&(_hasEvents()?N=_createTimer((function(){N=null,_sendEventsForLatencyAndAbove(0===F?ni.RealTime:ni.Normal,1,!0),F++,F%=2,_scheduleTimer()}),m):F=0)}function _createTimer(m,f){0===f&&L&&(f=1);var S=1e3;return L&&(S=Ur.getMillisToBackoffForRetry(L-1)),g._setTimeoutOverride(m,f*S)}function _clearScheduledTimer(){null!==N&&(g._clearTimeoutOverride(N),N=null,F=0)}function _releaseAllQueuesUsingBeacons(m,f){_clearScheduledTimer(),b&&(g._clearTimeoutOverride(b),b=null),A||_sendEventsForLatencyAndAbove(ni.Normal,m,f,!0)}function _clearQueues(){x[ni.Immediate]={batches:[],iKeyMap:{}},x[ni.RealTime]={batches:[],iKeyMap:{}},x[ni.CostDeferred]={batches:[],iKeyMap:{}},x[ni.Normal]={batches:[],iKeyMap:{}}}function _getEventBatch(g,m,f){var S=x[m];S||(m=ni.Normal,S=x[m]);var v=S.iKeyMap[g];return!v&&f&&(v=Tr.create(g),S.batches.push(v),S.iKeyMap[g]=v),v}function _performAutoFlush(m,f){v.canSendRequest()&&!L&&(C>0&&w>C&&(f=!0),f&&null==b&&g.flush(m,null,20))}function _addEventToProperQueue(g,m){V&&(g=optimizeObject(g));var f=g.latency,S=_getEventBatch(g.iKey,f,!0);return!!S.addEvents([g],m)&&(f!==ni.Immediate?(w++,m&&0===g.sendAttempt&&_performAutoFlush(!g.sync,_>0&&S.count()>=_)):P++,!0)}function _dropEventWithLatencyOrLess(g,m,f,S){for(;f<=m;){var v=_getEventBatch(g,m,!0);if(v&&v.count()>0){var C=v.split(0,S),_=C.count();if(_>0)return f===ni.Immediate?P-=_:w-=_,_notifyBatchEvents(cs,[C],he.QueueFull),!0}f++}return _resetQueueCounts(),!1}function _resetQueueCounts(){for(var g=0,m=0,_loop_1=function(f){var S=x[f];S&&S.batches&&arrForEach(S.batches,(function(S){f===ni.Immediate?g+=S.count():m+=S.count()}))},f=ni.Normal;f<=ni.Immediate;f++)_loop_1(f);w=m,P=g}function _queueBatches(m,f,S){var C=!1;return!S||v.canSendRequest()?doPerf(g.core,(function(){return"PostChannel._queueBatches"}),(function(){for(var g=[],f=ni.Immediate;f>=m;){var S=x[f];S&&S.batches&&(arrForEach(S.batches,(function(m){v.addBatch(m)?C=C||m&&m.count()>0:g=g.concat(m.events()),f===ni.Immediate?P-=m.count():w-=m.count()})),S.batches=[],S.iKeyMap={}),f--}g.length>0&&_notifyEvents(cs,g,he.KillSwitch),C&&U>=m&&(U=-1,E=0)}),(function(){return{latency:m,sendReason:f}}),S):(U=U>=0?Math.min(U,m):m,E=Math.max(E,f)),C}function _flushImpl(g,m){_sendEventsForLatencyAndAbove(ni.Normal,m,!0),_waitForIdleManager((function(){g&&g(),I.length>0?b=_createTimer((function(){return _flushImpl(I.shift(),m)}),0):(b=null,_hasEvents()&&_scheduleTimer())}))}function _waitForIdleManager(g){v.isCompletelyIdle()?g():b=_createTimer((function(){_waitForIdleManager(g)}),ts)}function _resetTransmitProfiles(){_clearScheduledTimer(),_initializeProfiles(),O=Cr,_scheduleTimer()}function _initializeProfiles(){(D={})[Cr]=[2,1,0],D[_r]=[6,3,0],D[Er]=[18,9,0]}function _requeueEvents(m,f){var S=[];arrForEach(m,(function(m){m&&m.count()>0&&arrForEach(m.events(),(function(m){m&&(m.sync&&(m.latency=ni.RealTime,m.sync=!1),m.sendAttempt<rs?(setProcessTelemetryTimings(m,g.identifier),_addEventToQueues(m,!1)):S.push(m))}))})),S.length>0&&_notifyEvents(cs,S,he.NonRetryableStatus)}function _callNotification(m,f){var S=g._notificationManager||{},v=S[m];if(v)try{v.apply(S,f)}catch(f){g.diagLog().throwInternal(Ne.CRITICAL,si.NotificationException,m+" notification failed: "+f)}}function _notifyEvents(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];m&&m.length>0&&_callNotification(g,[m].concat(f))}function _notifyBatchEvents(g,m){for(var f=[],S=2;S<arguments.length;S++)f[S-2]=arguments[S];m&&m.length>0&&arrForEach(m,(function(m){m&&m.count()>0&&_callNotification(g,[m.events()].concat(f))}))}function _sendingEvent(g,m,f){g&&g.length>0&&_callNotification("eventsSendRequest",[m>=1e3&&m<=1999?m-1e3:0,!0!==f])}function _eventsSentEvent(g,m){_notifyBatchEvents("eventsSent",g,m),_scheduleTimer()}function _eventsDropped(g,m){_notifyBatchEvents(cs,g,m>=8e3&&m<=8999?m-8e3:he.Unknown)}function _eventsResponseFail(g){_notifyBatchEvents(cs,g,he.NonRetryableStatus),_scheduleTimer()}function _otherEvent(g,m){_notifyBatchEvents(cs,g,he.Unknown),_scheduleTimer()}function _setAutoLimits(){_=m&&m.disableAutoBatchFlushLimit?0:Math.max(is*(os+1),M/6)}_initializeProfiles(),_clearQueues(),_setAutoLimits(),v=new es(is,os,ls,{requeue:_requeueEvents,send:_sendingEvent,sent:_eventsSentEvent,drop:_eventsDropped,rspFail:_eventsResponseFail,oth:_otherEvent}),g._getDbgPlgTargets=function(){return[v]},g.initialize=function(_,E,T){doPerf(E,(function(){return"PostChannel:initialize"}),(function(){var I=E;f.initialize(_,E,T),g.setInitialized(!1);var b=g._getTelCtx();_.extensionConfig[g.identifier]=_.extensionConfig[g.identifier]||{},m=b.getExtCfg(g.identifier),g._setTimeoutOverride=m.setTimeoutOverride?m.setTimeoutOverride:setTimeout.bind(as),g._clearTimeoutOverride=m.clearTimeoutOverride?m.clearTimeoutOverride:clearTimeout.bind(as),V=!m.disableOptimizeObj&&isChromium();var A=I.getWParam;I.getWParam=function(){var g=0;return m.ignoreMc1Ms0CookieProcessing&&(g|=2),g|A()},m.eventsLimitInMem>0&&(M=m.eventsLimitInMem),m.immediateEventLimit>0&&(R=m.immediateEventLimit),m.autoFlushEventsLimit>0&&(C=m.autoFlushEventsLimit),_setAutoLimits(),m.httpXHROverride&&m.httpXHROverride.sendPOST&&(S=m.httpXHROverride),isValueAssigned(_.anonCookieName)&&v.addQueryStringParameter("anoncknm",_.anonCookieName),v.sendHook=m.payloadPreprocessor,v.sendListener=m.payloadListener;var P=m.overrideEndpointUrl?m.overrideEndpointUrl:_.endpointUrl;g._notificationManager=_.extensionConfig.NotificationManager,v.initialize(P,g.core,g,S,m),addPageUnloadEventListener((function(){_releaseAllQueuesUsingBeacons(2,!1)})),g.setInitialized(!0)}),(function(){return{coreConfig:_,core:E,extensions:T}}))},g.processTelemetry=function(f,S){setProcessTelemetryTimings(f,g.identifier);var v=(S=g._getTelCtx(S)).getExtCfg(g.identifier),C=!!m.disableTelemetry;v&&(C=C||!!v.disableTelemetry);var _=f;C||T||(m[ds]&&(_.iKey=m[ds]),v&&v[ds]&&(_.iKey=v[ds]),_addEventToQueues(_,!0),_scheduleTimer()),g.processNext(_,S)},g.setEventQueueLimits=function(g,m){M=g>0?g:1e4,C=m>0?m:0,_setAutoLimits();var f=w>g;if(!f&&_>0)for(var S=ni.Normal;!f&&S<=ni.RealTime;S++){var v=x[S];v&&v.batches&&arrForEach(v.batches,(function(g){g&&g.count()>=_&&(f=!0)}))}_performAutoFlush(!0,f)},g.teardown=function(){_releaseAllQueuesUsingBeacons(2,!1),T=!0,v.teardown()},g.pause=function(){_clearScheduledTimer(),A=!0,v.pause()},g.resume=function(){A=!1,v.resume(),_scheduleTimer()},g.addResponseHandler=function(g){v._responseHandlers.push(g)},g._loadTransmitProfiles=function(g){_resetTransmitProfiles(),objForEachKey(g,(function(g,m){var f=m.length;if(f>=2){var S=f>2?m[2]:0;if(m.splice(0,f-2),m[1]<0&&(m[0]=-1),m[1]>0&&m[0]>0){var v=m[0]/m[1];m[0]=Math.ceil(v)*m[1]}S>=0&&m[1]>=0&&S>m[1]&&(S=m[1]),m.push(S),D[g]=m}}))},g.flush=function(g,m,f){void 0===g&&(g=!0),A||(_clearScheduledTimer(),f=f||1,g?(_queueBatches(ni.Normal,f,g),_resetQueueCounts(),null==b?b=_createTimer((function(){_flushImpl(m,f)}),0):I.push(m)):(_sendEventsForLatencyAndAbove(ni.Normal,f,!1),null!=m&&m()))},g.setMsaAuthTicket=function(g){v.addHeader("AuthMsaDeviceTicket",g)},g.hasEvents=_hasEvents,g._setTransmitProfile=function(g){O!==g&&void 0!==D[g]&&(_clearScheduledTimer(),O=g,_scheduleTimer())},g._backOffTransmission=function(){L<ss&&(L++,_clearScheduledTimer(),_scheduleTimer())},g._clearBackOff=function(){L&&(L=0,_clearScheduledTimer(),_scheduleTimer())}})),f}return __extendsFn$2(PostChannel,g),PostChannel}(Ct),us=["AX","EX","SF","CS","CF","CT","CU","DC","DF","H5","HL","WS","WP"];function _validateAppExpId(g,m){void 0===m&&(m=us);var f=null;if(g)for(var S=g.split(","),v=0;v<S.length;v++)_isValidAppFlightId(S[v],m)&&(f?f+=","+S[v]:f=S[v]);return f}function _isValidAppFlightId(g,m){if(void 0===m&&(m=us),!g||g.length<4)return!1;for(var f=!1,S=256,v=g.substring(0,3).toString().toUpperCase(),C=0;C<m.length;C++)if(m[C]+":"===v&&g.length<=S){f=!0;break}return f}var gs=function(){function Application(g,m){this.core=m,this.appExpId=null,this.flightIdNameSpaces=us.slice(0),this.expIdCookieName="Treatments",this._cookieMgr=safeGetCookieMgr(m),this._propertiesConfig=g;var f=getDocument();if(f){var S=f.documentElement;f&&(this.locale=S.lang)}this.env=g.env?g.env:this._getMetaDataFromDOM("awa-").env}return Application.prototype.getExpId=function(){return this._propertiesConfig.expId?this._readExpIdFromCoreData(this._propertiesConfig.expId):this._readExpIdFromCookie()},Application.prototype._getMetaDataFromDOM=function(g){var m,f={},S=getDocument();if(S){m=S&&S.querySelectorAll("meta");for(var v=0;v<m.length;v++){var C=m[v];if(C.name)if(0===C.name.toLowerCase().indexOf(g))f[C.name.replace(g,"")]=C.content}}return f},Application.prototype._setAppExpId=function(g){g!==this.appExpId&&(this.appExpId=_validateAppExpId(g,this.flightIdNameSpaces))},Application.prototype._getAppExpId=function(){return this.appExpId},Application.prototype._readExpIdFromCookie=function(){var g=getCookieValue(this._cookieMgr,this.expIdCookieName);return this._setAppExpId(g),this._getAppExpId()},Application.prototype._readExpIdFromCoreData=function(g){return this._setAppExpId(g),this._getAppExpId()},Application.validateAppExpId=_validateAppExpId,Application._staticInit=void objDefineAccessors(Application.prototype,"expId",Application.prototype.getExpId),Application}(),ps=function(){function Cloud(){}return Cloud}(),ms=function(){function User(g,m,f){this.core=f;var S=this._cookieMgr=safeGetCookieMgr(f,g);if(S&&S.isEnabled()){var v=getCookieValue(S,"MUID");if(v&&this.setLocalId("t:"+v),m.enableApplicationInsightsUser){var C=getCookieValue(S,User.userCookieName);if(C){var _=C.split(User.cookieSeparator);_.length>0&&(this.id=_[0])}if(!this.id){this.id=newId(g&&!isUndefined(g.idLength)?g.idLength:22);var E=toISOString(new Date);this.accountAcquisitionDate=E;var T=[this.id,E],I=m.cookieDomain?m.cookieDomain:void 0;S.set(User.userCookieName,T.join(User.cookieSeparator),31536e3,I)}}}if("undefined"!=typeof navigator){var b=navigator;this.locale=b.userLanguage||b.language}}return User.prototype.getLocalId=function(){if(this._customLocalId)return this._customLocalId;var g=getCookieValue(this._cookieMgr,"MUID");g&&this.setLocalId("t:"+g)},User.prototype.setLocalId=function(g){this._customLocalId=g},User.cookieSeparator="|",User.userCookieName="ai_user",User._staticInit=void objDefineAccessors(User.prototype,"localId",User.prototype.getLocalId,User.prototype.setLocalId),User}(),fs={MSIE:"MSIE",CHROME:"Chrome",FIREFOX:"Firefox",SAFARI:"Safari",EDGE:"Edge",ELECTRON:"Electron",SKYPE_SHELL:"SkypeShell",PHANTOMJS:"PhantomJS",OPERA:"Opera"},Ss="([\\d,.]+)",vs="Unknown",ys="Edg/",Cs=function(){function Web(g,m){this._cookieMgr=safeGetCookieMgr(m),this._propertiesConfig=g;var f=getLocation();if(f){var S=f.hostname;S&&(this.domain="file:"===f.protocol?"local":S)}var v="undefined"!=typeof navigator?navigator.userAgent:"";if(g.userAgent&&(v=g.userAgent),g.populateBrowserInfo){if(v){var C=this._getBrowserName(v);this.browser=C,this.browserVer=this._getBrowserVersion(v,C)}var _=this._getScreenResolution();this.screenRes=_.w+"X"+_.h}}return Web.prototype.getUserConsent=function(){return this._propertiesConfig.userConsented||!!getCookieValue(this._cookieMgr,this._propertiesConfig.userConsentCookieName||"MSCC")},Web.prototype.getUserConsentDetails=function(){try{if(this._propertiesConfig.callback&&this._propertiesConfig.callback.userConsentDetails){var g=this._propertiesConfig.callback.userConsentDetails();if(g)return JSON.stringify({Required:!!g.Required&&g.Required,Analytics:!!g.Analytics&&g.Analytics,SocialMedia:!!g.SocialMedia&&g.SocialMedia,Advertising:!!g.Advertising&&g.Advertising})}}catch(g){}return null},Web.prototype._getBrowserName=function(g){return this._userAgentContainsString("OPR/",g)?fs.OPERA:this._userAgentContainsString(fs.PHANTOMJS,g)?fs.PHANTOMJS:this._userAgentContainsString(fs.EDGE,g)||this._userAgentContainsString(ys,g)?fs.EDGE:this._userAgentContainsString(fs.ELECTRON,g)?fs.ELECTRON:this._userAgentContainsString(fs.CHROME,g)?fs.CHROME:this._userAgentContainsString("Trident",g)?fs.MSIE:this._userAgentContainsString(fs.FIREFOX,g)?fs.FIREFOX:this._userAgentContainsString(fs.SAFARI,g)?fs.SAFARI:this._userAgentContainsString(fs.SKYPE_SHELL,g)?fs.SKYPE_SHELL:vs},Web.prototype._userAgentContainsString=function(g,m){return m.indexOf(g)>-1},Web.prototype._getBrowserVersion=function(g,m){return m===fs.MSIE?this._getIeVersion(g):this._getOtherVersion(m,g)},Web.prototype._getIeVersion=function(g){var m=g.match(new RegExp(fs.MSIE+" "+Ss));if(m)return m[1];var f=g.match(new RegExp("rv:"+Ss));return f?f[1]:void 0},Web.prototype._getOtherVersion=function(g,m){g===fs.SAFARI?g="Version":g===fs.EDGE&&this._userAgentContainsString(ys,m)&&(g="Edg");var f=m.match(new RegExp(g+"/"+Ss));return f?f[1]:vs},Web.prototype._getScreenResolution=function(){var g={h:0,w:0},m=getWindow();return m&&m.screen&&(g.h=screen.height,g.w=screen.width),g},Web._staticInit=void objDefineAccessors(Web.prototype,"userConsent",Web.prototype.getUserConsent),Web}(),_s={WINDOWS:"Windows",MACOSX:"Mac OS X",ANDROID:"Android",IOS:"iOS"},Es={WIN:/(windows|win32)/i,WINRT:/ arm;/i,WINPHONE:/windows\sphone\s\d+\.\d+/i,OSX:/(macintosh|mac os x)/i,IOS:/(ipad|iphone|ipod)(?=.*like mac os x)/i,LINUX:/(linux|joli|[kxln]?ubuntu|debian|[open]*suse|gentoo|arch|slackware|fedora|mandriva|centos|pclinuxos|redhat|zenwalk)/i,ANDROID:/android/i,CROS:/CrOS/i},Ts={5.1:"XP","6.0":"Vista",6.1:"7",6.2:"8",6.3:"8.1","10.0":"10"},Is="([\\d,.]+)",bs="([\\d,_,.]+)",As="Unknown",Ps=function(){function OperatingSystem(g){var m="undefined"!=typeof navigator?navigator.userAgent:"";if(g.userAgent&&(m=g.userAgent),m&&g.populateOperatingSystemInfo){var f=this._getOsName(m.toLowerCase());this.name=f,this.ver=this._getOsVersion(m,f)}}return OperatingSystem.prototype._getOsName=function(g){return g.match(Es.WINPHONE)?"Windows Phone":g.match(Es.WINRT)?"Windows RT":g.match(Es.WIN)?_s.WINDOWS:g.match(Es.IOS)?_s.IOS:g.match(Es.ANDROID)?_s.ANDROID:g.match(Es.LINUX)?"Linux":g.match(Es.CROS)?"Chrome OS":-1!==g.indexOf("x11")?"Unix":-1!==g.indexOf("blackberry")?"BlackBerry":-1!==g.indexOf("symbian")?"Symbian":-1!==g.indexOf("nokia")?"Nokia":g.match(Es.OSX)?_s.MACOSX:As},OperatingSystem.prototype._getOsVersion=function(g,m){return m===_s.WINDOWS?this._getGenericOsVersion(g,"Windows NT"):m===_s.ANDROID?this._getGenericOsVersion(g,m):m===_s.MACOSX?this._getMacOsxVersion(g):m===_s.IOS?this._getIosVersion(g):As},OperatingSystem.prototype._getGenericOsVersion=function(g,m){var f=g.match(new RegExp(m+" "+Is));return f?Ts[f[1]]?Ts[f[1]]:f[1]:As},OperatingSystem.prototype._getMacOsxVersion=function(g){var m=g.match(new RegExp(_s.MACOSX+" "+bs));if(m){var f=m[1].replace(/_/g,".");if(f){var S=this._getDelimiter(f);return S?f.split(S)[0]:f}}return As},OperatingSystem.prototype._getIosVersion=function(g){var m=g.match(new RegExp("OS "+bs));if(m){var f=m[1].replace(/_/g,".");if(f){var S=this._getDelimiter(f);return S?f.split(S)[0]:f}}return As},OperatingSystem.prototype._getDelimiter=function(g){return g.indexOf(".")>-1?".":g.indexOf("_")>-1?"_":null},OperatingSystem}(),Rs=function(){function IntWeb(g,m){this.core=m,g.serviceName&&(this.serviceName=g.serviceName),this._cookieMgr=safeGetCookieMgr(m)}return IntWeb.prototype.getMsfpc=function(){return getCookieValue(this._cookieMgr,"MSFPC")},IntWeb.prototype.getAnid=function(){return getCookieValue(this._cookieMgr,"ANON").slice(0,34)},IntWeb._staticInit=(objDefineAccessors(IntWeb.prototype,"msfpc",IntWeb.prototype.getMsfpc),void objDefineAccessors(IntWeb.prototype,"anid",IntWeb.prototype.getAnid)),IntWeb}(),ws=1048576,Ms=2097152,Ds=function(){function Utc(g){this.popSample=100,this.eventFlags=0,g.hashIdentifiers&&(this.eventFlags=this.eventFlags|ws),g.dropIdentifiers&&(this.eventFlags=this.eventFlags|Ms)}return Utc}(),Os=function(){function Loc(){var g=(new Date).getTimezoneOffset(),m=g%60,f=(g-m)/60,S="+";f>0&&(S="-"),f=Math.abs(f),m=Math.abs(m),this.tz=S+(f<10?"0"+f:f.toString())+":"+(m<10?"0"+m:m.toString())}return Loc}(),Ns=function(){function Device(){}return Device}(),ks=function(){function Session(){}return Session.prototype.setId=function(g){this.customId=g},Session.prototype.getId=function(){return isString(this.customId)?this.customId:this.automaticId},Session._staticInit=void objDefineAccessors(Session.prototype,"id",Session.prototype.getId,Session.prototype.setId),Session}(),Ls=function(){function Trace(g,m,f,S){if(g.enableApplicationInsightsTrace){this.traceId=m||generateW3CId(),this.parentId=f,this.name=S;var v=getLocation();v&&v.pathname&&(this.name=v.pathname)}}return Trace}(),Fs=function(){function AppExtensionKeys(){}return AppExtensionKeys.id="id",AppExtensionKeys.ver="ver",AppExtensionKeys.appName="name",AppExtensionKeys.locale="locale",AppExtensionKeys.expId="expId",AppExtensionKeys.env="env",AppExtensionKeys}(),xs=function(){function WebExtensionKeys(){}return WebExtensionKeys.domain="domain",WebExtensionKeys.browser="browser",WebExtensionKeys.browserVer="browserVer",WebExtensionKeys.screenRes="screenRes",WebExtensionKeys.userConsent="userConsent",WebExtensionKeys.consentDetails="consentDetails",WebExtensionKeys}(),Us=function(){function UserExtensionKeys(){}return UserExtensionKeys.locale="locale",UserExtensionKeys.localId="localId",UserExtensionKeys.id="id",UserExtensionKeys}(),Vs=function(){function OSExtKeys(){}return OSExtKeys.osName="name",OSExtKeys.ver="ver",OSExtKeys}(),Bs=function(){function SDKExtKeys(){}return SDKExtKeys.ver="ver",SDKExtKeys.seq="seq",SDKExtKeys.installId="installId",SDKExtKeys.epoch="epoch",SDKExtKeys}(),Hs=function(){function IntWebExtKeys(){}return IntWebExtKeys.msfpc="msfpc",IntWebExtKeys.anid="anid",IntWebExtKeys.serviceName="serviceName",IntWebExtKeys}(),$s=function(){function UtcExtKeys(){}return UtcExtKeys.popSample="popSample",UtcExtKeys.eventFlags="eventFlags",UtcExtKeys}(),Gs=function(){function LocExtKeys(){}return LocExtKeys.tz="tz",LocExtKeys}(),js=function(){function SessionExtKeys(){}return SessionExtKeys.sessionId="sesId",SessionExtKeys}(),Ws=function(){function DeviceExtKeys(){}return DeviceExtKeys.localId="localId",DeviceExtKeys.deviceClass="deviceClass",DeviceExtKeys.make="make",DeviceExtKeys.model="model",DeviceExtKeys}(),qs=function(){function CloudExtKeys(){}return CloudExtKeys.role="role",CloudExtKeys.roleInstance="roleInstance",CloudExtKeys.roleVer="roleVer",CloudExtKeys}(),zs=function(){function TraceExtKeys(){}return TraceExtKeys.traceId="traceID",TraceExtKeys.traceName="name",TraceExtKeys.parentId="parentID",TraceExtKeys}(),Ks=function(){function Extensions(){}return Extensions.UserExt="user",Extensions.DeviceExt="device",Extensions.TraceExt="trace",Extensions.WebExt="web",Extensions.AppExt="app",Extensions.OSExt="os",Extensions.SdkExt="sdk",Extensions.IntWebExt="intweb",Extensions.UtcExt="utc",Extensions.LocExt="loc",Extensions.CloudExt="cloud",Extensions}(),Js="MicrosoftApplicationsTelemetryDeviceId";
/**
* Cloud.ts
* @author Hector Hernandez (hectorh)
* @copyright Microsoft 2020
*/function _saveData(g,m,f,S){m?m.setProperty(f,S):g.set(f,S,31536e3)}function _getData(g,m,f){return m?m.getProperty(f)||"":getCookieValue(g,f)}var Ys,Qs,Xs=function(){function Sdk(g,m){this._sequenceId=0;var f=g.propertyStorageOverride;this.seq=this._sequenceId,this.epoch=random32(!1).toString();var S=safeGetCookieMgr(m,g);if(S.isEnabled()||f){var v=_getData(S,f,Js);v||(v=newGuid()),_saveData(S,f,Js,v),this.installId=v}else S.purge(Js)}return Sdk.prototype.getSequenceId=function(){return++this._sequenceId},Sdk}();function canUseLocalStorage(){return void 0===Ys&&(Ys=!!_getVerifiedStorageObject(Qs.LocalStorage)),Ys}function _getLocalStorageObject(){return canUseLocalStorage()?_getVerifiedStorageObject(Qs.LocalStorage):null}function _getVerifiedStorageObject(g){var m,f,S=null;try{var v=getGlobal();if(!v)return null;f=new Date,(S=g===Qs.LocalStorage?v.localStorage:v.sessionStorage)&&isFunction(S.setItem)&&(S.setItem(f,f),m=S.getItem(f)!==f,S.removeItem(f),m&&(S=null))}catch(g){S=null}return S}function setStorage(g,m,f){var S=_getLocalStorageObject();if(null!==S)try{return S.setItem(m,f),!0}catch(m){Ys=!1,g.throwInternal(Ne.CRITICAL,si.BrowserCannotWriteLocalStorage,"Browser failed write to local storage. "+m)}return!1}function getStorage(g,m){var f=_getLocalStorageObject();if(null!==f)try{return f.getItem(m)}catch(m){Ys=!1,g.throwInternal(Ne.CRITICAL,si.BrowserCannotReadLocalStorage,"Browser failed read of local storage. "+m)}return null}!function(g){g[g.LocalStorage=0]="LocalStorage",g[g.SessionStorage=1]="SessionStorage"}(Qs||(Qs={}));var Zs=function(){function SessionManager(g,m){var f,S,v=safeGetLogger(g),C=safeGetCookieMgr(g);dynamicProto(SessionManager,this,(function(g){var _=getDefaultConfig(m);function getDefaultConfig(g){return{sessionRenewalMs:g.sessionRenewalMs&&function(){return g.sessionRenewalMs},sessionExpirationMs:g.sessionExpirationMs&&function(){return g.sessionExpirationMs},cookieDomain:g.cookieDomain&&function(){return g.cookieDomain},namePrefix:g.namePrefix&&function(){return g.namePrefix},sessionAsGuid:function(){return g.sessionAsGuid},idLength:function(){return g.idLength?g.idLength:22}}}function _initializeAutomaticSession(){var m=getCookie(S());if(m&&isFunction(m.split))_initializeAutomaticSessionWithData(m);else{var f=getStorage(v,S());f&&_initializeAutomaticSessionWithData(f)}g.automaticSession.getId()||_renew()}function _initializeAutomaticSessionWithData(m){var f=g.automaticSession,S=m.split("|");S.length>0&&f.setId(S[0]);try{if(S.length>1){var C=+S[1];f.acquisitionDate=+new Date(C),f.acquisitionDate=f.acquisitionDate>0?f.acquisitionDate:0}if(S.length>2){var _=+S[2];f.renewalDate=+new Date(_),f.renewalDate=f.renewalDate>0?f.renewalDate:0}}catch(g){v.throwInternal(Ne.CRITICAL,si.ErrorParsingAISessionCookie,"Error parsing ai_session cookie, session will be reset: "+g)}0===f.renewalDate&&v.throwInternal(Ne.WARNING,si.SessionRenewalDateIsZero,"AI session renewal date is 0, session will be reset.")}function _renew(){var m=g.automaticSession,f=(new Date).getTime(),S=g.config.sessionAsGuid();!isUndefined(S)&&S?isBoolean(S)?m.setId(createGuid()):m.setId(createGuid(S)):m.setId(newId(_&&_.idLength?_.idLength():22)),m.acquisitionDate=f,m.renewalDate=f,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate),canUseLocalStorage()||v.throwInternal(Ne.WARNING,si.BrowserDoesNotSupportLocalStorage,"Browser does not support local storage. Session durations will be inaccurate.")}function _setCookie(m,v,_){var E=v+g.config.sessionExpirationMs(),T=_+g.config.sessionRenewalMs(),I=new Date,b=[m,v,_];E<T?I.setTime(E):I.setTime(T);var A=g.config.cookieDomain?g.config.cookieDomain():null;C.set(S(),b.join("|")+";expires="+I.toUTCString(),null,A),f=(new Date).getTime()}function _setStorage(g,m,f){setStorage(v,S(),[g,m,f].join("|"))}isFunction(m.sessionExpirationMs)||(_.sessionExpirationMs=function(){return SessionManager.acquisitionSpan}),isFunction(m.sessionRenewalMs)||(_.sessionRenewalMs=function(){return SessionManager.renewalSpan}),g.config=_,S=function(){return g.config.namePrefix&&g.config.namePrefix()?SessionManager.cookieNameConst+g.config.namePrefix():SessionManager.cookieNameConst},g.automaticSession=new ks,g.update=function(){g.automaticSession.getId()||_initializeAutomaticSession();var m=g.automaticSession,S=g.config,v=(new Date).getTime(),C=v-m.acquisitionDate>S.sessionExpirationMs(),_=v-m.renewalDate>S.sessionRenewalMs();if(C||_)_renew();else{(!f||v-f>SessionManager.cookieUpdateInterval)&&(m.renewalDate=v,_setCookie(m.getId(),m.acquisitionDate,m.renewalDate))}},g.backup=function(){var m=g.automaticSession;_setStorage(m.getId(),m.acquisitionDate,m.renewalDate)}}))}return SessionManager.acquisitionSpan=864e5,SessionManager.renewalSpan=18e5,SessionManager.cookieUpdateInterval=6e4,SessionManager.cookieNameConst="ai_session",SessionManager}(),ea=isString,ta=function(){function TelemetryContext(g,m,f){this.app=new gs(m,f),this.cloud=new ps,this.user=new ms(g,m,f),this.os=new Ps(m),this.web=new Cs(m,f),this.sdk=new Xs(g,f),this.intWeb=new Rs(m,f),this.utc=new Ds(m),this.loc=new Os,this.device=new Ns,this.telemetryTrace=new Ls(m),this.sessionManager=new Zs(f,m),this.session=new ks}return TelemetryContext.prototype.getSessionId=function(){var g=this.session;if(g&&ea(g.customId))return g.customId;var m=this.sessionManager;m.update();var f=m.automaticSession;if(f){var S=f.getId();S&&ea(S)&&(g.automaticId=S)}return g.automaticId},TelemetryContext.prototype.applyApplicationContext=function(g){var m=this.app;ea(m.id)&&(g.ext[Ks.AppExt][Fs.id]=m.id),ea(m.ver)&&(g.ext[Ks.AppExt][Fs.ver]=m.ver),ea(m.name)&&(g.ext[Ks.AppExt][Fs.appName]=m.name),ea(m.locale)&&(g.ext[Ks.AppExt][Fs.locale]=m.locale);var f=m.getExpId();ea(f)&&(g.ext[Ks.AppExt][Fs.expId]=f),ea(m.env)&&(g.ext[Ks.AppExt][Fs.env]=m.env)},TelemetryContext.prototype.applyUserContext=function(g){var m=this.user,f=m.getLocalId();ea(f)&&(g.ext[Ks.UserExt][Us.localId]=f),ea(m.locale)&&(g.ext[Ks.UserExt][Us.locale]=m.locale),ea(m.id)&&(g.ext[Ks.UserExt][Us.id]=m.id)},TelemetryContext.prototype.applyWebContext=function(g){var m=this.web;ea(m.domain)&&(g.ext[Ks.WebExt][xs.domain]=m.domain),ea(m.browser)&&(g.ext[Ks.WebExt][xs.browser]=m.browser),ea(m.browserVer)&&(g.ext[Ks.WebExt][xs.browserVer]=m.browserVer),ea(m.screenRes)&&(g.ext[Ks.WebExt][xs.screenRes]=m.screenRes),g.ext[Ks.WebExt][xs.userConsent]=m.getUserConsent(),g.ext[Ks.WebExt][xs.consentDetails]=m.getUserConsentDetails()},TelemetryContext.prototype.applyOsContext=function(g){var m=this.os;ea(m.name)&&(g.ext[Ks.OSExt][Vs.osName]=m.name),ea(m.ver)&&(g.ext[Ks.OSExt][Vs.ver]=m.ver)},TelemetryContext.prototype.applySdkContext=function(g){var m=this.sdk;g.ext[Ks.SdkExt][Bs.seq]=m.getSequenceId(),g.ext[Ks.SdkExt][Bs.epoch]=m.epoch,ea(m.installId)&&(g.ext[Ks.SdkExt][Bs.installId]=m.installId)},TelemetryContext.prototype.applyIntWebContext=function(g){var m=this.intWeb,f=m.getMsfpc();ea(f)&&(g.ext[Ks.IntWebExt][Hs.msfpc]=f);var S=m.getAnid();ea(S)&&(g.ext[Ks.IntWebExt][Hs.anid]=S),ea(m.serviceName)&&(g.ext[Ks.IntWebExt][Hs.serviceName]=m.serviceName)},TelemetryContext.prototype.applyUtcContext=function(g){var m=this.utc;g.ext[Ks.UtcExt][$s.popSample]=m.popSample,m.eventFlags>0&&(g.ext[Ks.UtcExt][$s.eventFlags]=m.eventFlags)},TelemetryContext.prototype.applyLocContext=function(g){g.ext[Ks.LocExt][Gs.tz]=this.loc.tz},TelemetryContext.prototype.applySessionContext=function(g){g.ext[Ks.AppExt][js.sessionId]=this.getSessionId()},TelemetryContext.prototype.applyDeviceContext=function(g){var m=this.device;ea(m.localId)&&(g.ext[Ks.DeviceExt][Ws.localId]=m.localId),ea(m.make)&&(g.ext[Ks.DeviceExt][Ws.make]=m.make),ea(m.model)&&(g.ext[Ks.DeviceExt][Ws.model]=m.model),ea(m.deviceClass)&&(g.ext[Ks.DeviceExt][Ws.deviceClass]=m.deviceClass)},TelemetryContext.prototype.applyCloudContext=function(g){var m=this.cloud;ea(m.role)&&(g.ext[Ks.CloudExt][qs.role]=m.role),ea(m.roleInstance)&&(g.ext[Ks.CloudExt][qs.roleInstance]=m.roleInstance),ea(m.roleVer)&&(g.ext[Ks.CloudExt][qs.roleVer]=m.roleVer)},TelemetryContext.prototype.applyAITraceContext=function(g){var m=this.telemetryTrace;ea(m.traceId)&&(g.ext[Ks.TraceExt][zs.traceId]=m.traceId),ea(m.name)&&(g.ext[Ks.TraceExt][zs.traceName]=m.name),ea(m.parentId)&&(g.ext[Ks.TraceExt][zs.parentId]=m.parentId)},TelemetryContext}(),ia=function(g){function PropertiesPlugin(){var m,f=g.call(this)||this;f.identifier="SystemPropertiesCollector",f.priority=3,f.version="3.1.2";var S={};return dynamicProto(PropertiesPlugin,f,(function(v,C){function _addPropertiesIfAbsent(g,m){g&&objForEachKey(g,(function(g,f){m[g]||(m[g]=f)}))}v.initialize=function(S,C,_){g.prototype.initialize.call(f,S,C,_),m=new ta(S,v._getTelCtx().getExtCfg(v.identifier),C)},v.processTelemetry=function(g,f){setProcessTelemetryTimings(g,v.identifier),f=v._getTelCtx(f);var C=g.ext=g.ext?g.ext:{};g.data=g.data?g.data:{},C[Ks.AppExt]=C[Ks.AppExt]||{},C[Ks.UserExt]=C[Ks.UserExt]||{},C[Ks.WebExt]=C[Ks.WebExt]||{},C[Ks.OSExt]=C[Ks.OSExt]||{},C[Ks.SdkExt]=C[Ks.SdkExt]||{},C[Ks.IntWebExt]=C[Ks.IntWebExt]||{},C[Ks.UtcExt]=C[Ks.UtcExt]||{},C[Ks.LocExt]=C[Ks.LocExt]||{},C[Ks.DeviceExt]=C[Ks.DeviceExt]||{},C[Ks.TraceExt]=C[Ks.TraceExt]||{},C[Ks.CloudExt]=C[Ks.CloudExt]||{},m.applyApplicationContext(g),m.applyUserContext(g),m.applyWebContext(g),m.applyOsContext(g),m.applySdkContext(g),m.applyIntWebContext(g),m.applyUtcContext(g),m.applyLocContext(g),m.applySessionContext(g),m.applyDeviceContext(g),m.applyAITraceContext(g),m.applyCloudContext(g),arrForEach(objKeys(C),(function(g){0===objKeys(C[g]).length&&delete C[g]})),_addPropertiesIfAbsent(S,g.data),v.processNext(g,f)},v.getPropertiesContext=function(){return m},v.setProperty=function(g,m){S[g]=m}})),f}return __extendsFn$2(PropertiesPlugin,g),PropertiesPlugin}(Ct);const na="Skype",ra="ConfigIDs",sa="This type of config is not currently supported.",aa="Ecs Service has not yet responded. Try calling this API again in sometime.",oa="Possible duplicate call. Ecs already initialized for this confiugration definition.",la={Public:"https://ic3.events.data.microsoft.com/OneCollector/1.0/",PublicEUDB:"https://eu-ic3.events.data.microsoft.com/OneCollector/1.0/",GccHigh:"https://tb.events.data.microsoft.com/OneCollector/1.0/",Dod:"https://pf.events.data.microsoft.com/OneCollector/1.0/",AirGap08:"https://collector.azure.eaglex.ic.gov/OneCollector/1.0/",AirGap09:"https://collector.azure.microsoft.scloud/OneCollector/1.0/",Enterprise:"https://teams.events.data.microsoft.com/OneCollector/1.0",EnterpriseEUDB:"https://eu-teams.events.data.microsoft.com/OneCollector/1.0"};var ca,da;!function(g){g.Public="Public",g.GccHigh="GCCHigh",g.Dod="DoD",g.AirGap08="AirGap08",g.AirGap09="AirGap09"}(ca||(ca={})),function(g){g.OrgId="orgid",g.Acs="acs",g.Spool="spool",g.GccHigh="gcch",g.GccHighAcs="gcch-acs",g.Dod="dod",g.DodAcs="dod-acs",g.AirGap08="ag08",g.AirGap08Acs="ag08-acs",g.AirGap09="ag09",g.AirGap09Acs="ag09-acs"}(da||(da={}));const ha={Public_EcsServer_Url:"https://ecs.communication.microsoft.com",GccHigh_EcsServer_Url:"https://config.ecs.gov.teams.microsoft.us",Dod_EcsServer_Url:"https://config.ecs.dod.teams.microsoft.us",AirGap08_EcsServer_Url:"https://config.ecs.teams.eaglex.ic.go",AirGap09_EcsServer_Url:"https://config.ecs.teams.microsoft.scloud",Enterprise_Ecs_ServerUrl:"https://config.teams.microsoft.com"},ua={Public_ConversationServiceUrl:"https://api.flightproxy.skype.com/api/v2/cpconv",Public_TrouterServiceUrl:"https://go.trouter.communication.microsoft.com/v4/a",Public_RegistrarServiceUrl:"https://prod.registrar.skype.com/v3/registrations",Public_MdnTrapServiceUrl:"https://edge.skype.com/trap",Public_MdnTrapServiceTokenUrl:"https://edge.skype.com/trap/tokens",Public_MdnTrapRelaySkypeFqdns:"worldaz.tr.skype.com",Public_MdnTrapRelayTurnFqdns:"turn.azure.com",Public_MdnTrapRelayTurnUrl:"",GccHigh_ConversationServiceUrl:"https://api.cc.gov.teams.microsoft.us/conv/",GccHigh_TrouterServiceUrl:"https://go.trouter.gov.teams.microsoft.us/v4/a",GccHigh_RegistrarServiceUrl:"https://registrar.gov.teams.microsoft.us/v3/registrations",GccHigh_MdnTrapServiceUrl:"https://trap.gov.teams.microsoft.us",GccHigh_MdnTrapServiceTokenUrl:"https://trap.gov.teams.microsoft.us/tokens",GccHigh_MdnTrapRelaySkypeFqdns:"tr.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnFqdns:"turn.gov.teams.microsoft.us",GccHigh_MdnTrapRelayTurnUrl:"https://turn.gov.teams.microsoft.us/relay",Dod_ConversationServiceUrl:"https://api.cc.dod.teams.microsoft.us/conv/",Dod_TrouterServiceUrl:"https://go.trouter.dod.teams.microsoft.us/v4/a",Dod_RegistrarServiceUrl:"https://registrar.dod.teams.microsoft.us/v3/registrations",Dod_MdnTrapServiceUrl:"https://trap.dod.teams.microsoft.us",Dod_MdnTrapServiceTokenUrl:"https://trap.dod.teams.microsoft.us/tokens",Dod_MdnTrapRelaySkypeFqdns:"tr.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnFqdns:"turn.dod.teams.microsoft.us",Dod_MdnTrapRelayTurnUrl:"https://turn.dod.teams.microsoft.us/relay",AirGap08_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap08_TrouterServiceUrl:"https://go.trouter.teams.eaglex.ic.gov/v4/a",AirGap08_RegistrarServiceUrl:"https://api.registrar.teams.eaglex.ic.gov/v3/registrations",AirGap09_ConversationServiceUrl:"https://api.cc.skype.com/conv/",AirGap09_TrouterServiceUrl:"https://go.trouter.teams.microsoft.scloud/v4/a",AirGap09_RegistrarServiceUrl:"https://api.registrar.teams.microsoft.scloud/v3/registrations",Enterprise_ConversationServiceUrl:"https://api.flightproxy.teams.microsoft.com/api/v2/epconv",Enterprise_TrouterServiceUrl:"https://go.trouter.teams.microsoft.com/v4/a",Enterprise_RegistrarServiceUrl:"https://teams.microsoft.com/registrar/prod/v3/registrations",Enterprise_MdnTrapServiceUrl:"https://teams.microsoft.com/trap",Enterprise_MdnTrapServiceTokenUrl:"https://teams.microsoft.com/trap/tokens",Enterprise_MdnTrapRelaySkypeFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnFqdns:"worldaz.relay.teams.microsoft.com",Enterprise_MdnTrapRelayTurnUrl:""};var ga;!function(g){g.Public_ConversationServiceUrl_EUDB="https://api.flightproxy.skype.com/api/v2/cpconv",g.Public_TrouterServiceUrl_EUDB="https://go-eu.trouter.communication.microsoft.com/v4/a",g.Public_RegistrarServiceUrl_EUDB="https://emea.prod.registrar.skype.com/v3/registrations",g.Public_MdnTrapServiceUrl_EUDB="https://edge.skype.com/trap",g.Public_MdnTrapServiceTokenUrl_EUDB="https://edge.skype.com/trap/tokens",g.Public_MdnTrapRelaySkypeFqdns_EUDB="eu.relay.skype.com",g.Public_MdnTrapRelayTurnFqdns_EUDB="eu.relay.skype.com",g.Public_MdnTrapRelayTurnUrl_EUDB="",g.Enterprise_ConversationServiceUrl_EUDB="https://api.flightproxy.teams.microsoft.com/api/v2/epconv",g.Enterprise_TrouterServiceUrl_EUDB="https://go-eu.trouter.teams.microsoft.com/v4/a",g.Enterprise_RegistrarServiceUrl_EUDB="https://teams.microsoft.com/registrar/prod/v3/registrations",g.Enterprise_MdnTrapServiceUrl_EUDB="https://teams.microsoft.com/trap",g.Enterprise_MdnTrapServiceTokenUrl_EUDB="https://teams.microsoft.com/trap/tokens",g.Enterprise_MdnTrapRelaySkypeFqdns_EUDB="euaz.relay.teams.microsoft.com",g.Enterprise_MdnTrapRelayTurnFqdns_EUDB="euaz.relay.teams.microsoft.com",g.Enterprise_MdnTrapRelayTurnUrl_EUDB=""}(ga||(ga={}));const pa={...ua,...ha},ma={baseServiceUrl:"https://global.mtgw.prod.communication.microsoft.com/",policyUrlSuffix:"acsmt/v1/useraggregatepolicysettings/",policyUrlSuffixV2:"acsmt/v2/useraggregatepolicysettings/"};var fa;!function(g){g.Consumer="consumer",g.Enterprise="enterprise"}(fa||(fa={}));const Sa=["europe","france","germany","norway","switzerland","sweden"],va=["emea","fr","de","se"],ya=Array.from(new Set(Sa.concat(["qatar","uae","africa","uk"]))),Ca=["asiapacific","india","japan","korea","australia"],_a=["unitedstates","brazil","canada"];var Ea,Ta;!function(g){g.EU="EU",g.RoW="RoW"}(Ea||(Ea={})),function(g){g.APAC="APAC",g.NOAM="NOAM",g.EMEA="EMEA",g.UNKNOWN=""}(Ta||(Ta={}));const Ia={AUDIO:{JITTER:{GOOD:30,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},VIDEO:{JITTER:{GOOD:20,AVERAGE:75},RTT:{GOOD:200,AVERAGE:350},PACKETS_LOSS_PERCENTAGE:{GOOD:3,AVERAGE:6}},BANDWIDTH:{GOOD:1500,AVERAGE:500},CALL:{DURATION_IN_SEC:30,GROUP_ID:generateGuid(),AGGREGATION:{INTERVAL:1e3,DATAPOINTS:1},VIDEO_SIZE:{heigth:720,width:1280},MEDIASTREAM_TIMEOUT_IN_SEC:15,CONNECT_TIMEOUT_IN_SEC:10}};var ba;!function(g){g.AcsOrganizerRole="acsorganizer",g.AcsPresenterRole="acspresenter",g.AcsAttendeeRole="acsattendee",g.AcsConsumerRole="acsconsumer",g.TeamsOrganizer="organizer",g.TeamsAttendee="attendee",g.TeamsPresenter="presenter",g.TeamsCoorganizer="coorganizer"}(ba||(ba={}));const Aa=["airpod","bluetooth","hands-free","stereo","wireless","citrix hdx","remote audio","vmware","built-in","integrated","internal","teams","high definition","facetime","macbook","smartaudio","front","rear","back","iphone","ipad","display","displayport","dp","hdmi","amd","nvidia","intel","analog","digital","dock","line( in| out)?","s/pdif","external","thunderbolt\\d*","usb","panoramic","desktop","capture","cable","cam","virtual","manycam","snap camera","obs","vb-audio","vaio","effect","sink","source","default","test"];let Pa="3617";const getPlatformId=()=>Pa,Ra=2e3,wa=5e4,Ma=3e4,Da=25e3,Oa=6e3,Na=5e3,ka=1e3,La=3,Fa="acs_broadcast_channel",xa=5e3,Ua=500,Va=!1,Ba=500,Ha=512,$a=0,Ga=.4,ja=200,Wa=100,qa=255,za=-127,Ka=6e3,Ja=2500,Ya=1500,Qa=5e3,Xa=12,Za=2e4,eo=6e4,to=0,io=6e3,no=100,ro=4,so="4cf9ed87f7dc4e148f77855cd1f2fdca-61fb83a7-6672-4264-806f-7aded29f9b49-7618",ao="53fdaa090eb946b5a1d6cbdeb4f2ef66-bcbf6380-2590-41cc-ae60-9e467cd51835-7413",oo="1cae5691997646c98b01d15beddae7a3-ce16e198-bc32-420f-ac64-42bb916111af-6865",lo="2efdf03d07594586a5977c404e185186-71b046c4-f48f-4ba7-96d3-2a74b54e1d46-7326",co="708a9eb9fe2646fe8f4c37b7eee2e3da-9b97485a-57b9-43a8-8177-07ca7a653a30-6706",ho=7e3,uo=10,go="28:8133db4c-c049-4346-9edd-273f164a9227",po="28:b1902c3e-b9f7-4650-9b23-5772bd429747",mo="ACS-Public",fo="Teams-Public",So=["en-us"],vo=["en"],yo="en-us",Co=10,_o="setLanguage",Eo="transcription",To=["scheduledMeeting","adhocMeeting"],Io=["28:f4693563-c70b-4e4d-bda6-01792aa21440","28:e32c9418-a835-4eb1-bfb9-733fa74dd6e8"],bo=["28:5f2511f1-6da9-41d9-80d9-af7da23a2c27","28:accb0009-8d12-4cfe-969c-39b204e3ed0c"],Ao="tlePlayer",Po=256,Ro="0.0",wo=!0,Mo=Symbol("global_telemetry_logger"),Do=Symbol("global_call_client_index"),Oo=107,No="orgid",ko="dod",Lo="gcch",Fo="8:",xo="28:",Uo="4:",Vo=":",Bo="Unknown",Ho="ACSWeb",$o=Fo+(No+Vo),Go=Fo+(ko+Vo),jo=Fo+(Lo+Vo),Wo=Fo+("teamsvisitor"+Vo),qo=Fo+("acs"+Vo),zo=Fo+("spool"+Vo),Ko=Fo+("dod-acs"+Vo),Jo=Fo+("gcch-acs"+Vo),Yo=xo+(No+Vo),Qo=xo+(Lo+Vo),Xo=xo+(ko+Vo),Zo={audioBitrate:{aggregation_needed:!1,raw_data_reduction:!0},videoBitrate:{aggregation_needed:!1,raw_data_reduction:!0},downloadBitrate:{aggregation_needed:!0,multiplier:8,integer:!0,calculation_method:"rate"},bufferLengthInMs:{aggregation_needed:!0},mediaDelayInMs:{aggregation_needed:!0,is_internal:!0},videoHeight:{aggregation_needed:!1,raw_data_reduction:!0},videoWidth:{aggregation_needed:!1,raw_data_reduction:!0},playerHeight:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},playerWidth:{aggregation_needed:!1,raw_data_reduction:!0,is_internal:!0},currentPlayPosition:{aggregation_needed:!1,raw_data_reduction:!0}};var el,tl;!function(g){g.GroupCall="joinGroupId",g.GroupChatCall="joinThreadId",g.TeamsCoordinates="joinMeetingCoordinates",g.TeamsMeetingId="joinMeetingId",g.TeamsMeetingLink="joinMeetingLink",g.RoomCall="joinRoom",g.Unknown="Unknown"}(el||(el={})),function(g){g.Organizer="Organizer",g.Coorganizer="Co-organizer",g.Attendee="Attendee",g.Presenter="Presenter",g.Consumer="Consumer",g.Unknown="Unknown"}(tl||(tl={}));const il={"msft-acs-room-deviceType":"room","msft-acs-3proom-deviceType":"3proom","msft-acs-mesh-deviceType":"mesh","msft-acs-mesh-deviceType-v2":"meshV2"};var nl,rl;!function(g){g.onlyUsedProxy="onlyUsedProxy",g.onlyUsedNonMsftTurn="onlyUsedNonMsftTurn",g.usedProxyAndNonMsftTurn="usedProxyAndNonMsftTurn",g.noCustomProxyAndTurnUsed="noCustomProxyAndTurnUsed"}(nl||(nl={})),function(g){g.RoleRestricted="RoleRestricted",g.FeatureNotSupported="FeatureNotSupported",g.ClientRestricted="ClientRestricted",g.MeetingRestricted="MeetingRestricted",g.UserPolicyRestricted="UserPolicyRestricted",g.NotInitialized="NotInitialized",g.Capable="Capable",g.NotCapable="NotCapable",g.CapabilityNotApplicableForTheCallType="CapabilityNotApplicableForTheCallType"}(rl||(rl={}));const sl="roomsRoleBasedCapabilities",al="teamsRoleBasedCapabilities",ol=/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,ll=/(\:[0-9]{1,6})(?=$|\/|\?)/;var cl,dl;!function(g){g.TeamsProMgmt="TeamsProMgmt"}(cl||(cl={})),function(g){g.Disabled="Disabled",g.DisabledUserOverride="DisabledUserOverride"}(dl||(dl={}));const hl={Unknown:"Unknown",UsbCamera:"UsbCamera",CaptureAdapter:"CaptureAdapter",Virtual:"Virtual",ScreenSharing:"ScreenSharing"};var ul;function getMriFromIdentifier(g){const m=f(g);switch(m.kind){case ul.communicationUser:return m.communicationUserId;case ul.phoneNumber:if(m.rawId)return`${m.rawId}`;if(m.phoneNumber)return`${Uo}${m.phoneNumber}`;throw new CallingCommunicationError(z.IDENTIFIER.PARSE_PHONENUMBER);case ul.microsoftTeamsUser:if(m.rawId)return m.rawId;if(m.microsoftTeamsUserId){if(m.isAnonymous)return`${Wo}${m.microsoftTeamsUserId}`;if("public"===m.cloud)return`${$o}${m.microsoftTeamsUserId}`;if("dod"===m.cloud)return`${Go}${m.microsoftTeamsUserId}`;if("gcch"===m.cloud)return`${jo}${m.microsoftTeamsUserId}`;if(!m.cloud)return`${$o}${m.microsoftTeamsUserId}`}throw new CallingCommunicationError(z.IDENTIFIER.PARSE_MSFT_TEAMS_USER);case ul.microsoftTeamsApp:if(m.rawId)return m.rawId;if(m.teamsAppId){if("public"===m.cloud)return`${Yo}${m.teamsAppId}`;if("dod"===m.cloud)return`${Xo}${m.teamsAppId}`;if("gcch"===m.cloud)return`${Qo}${m.teamsAppId}`;if(!m.cloud)return`${Yo}${m.teamsAppId}`}throw new CallingCommunicationError(z.IDENTIFIER.PARSE_MSFT_TEAMS_APP);case"unknown":return m.id;default:throw new CallingCommunicationError(z.IDENTIFIER.PARSE_IDENTIFIER)}}function constructIdentifierKindFromMri(g){return g.startsWith($o)?{kind:ul.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(8),isAnonymous:!1,cloud:"public"}:g.startsWith(Go)?{kind:ul.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(6),isAnonymous:!1,cloud:"dod"}:g.startsWith(jo)?{kind:ul.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(7),isAnonymous:!1,cloud:"gcch"}:g.startsWith(Wo)?{kind:ul.microsoftTeamsUser,rawId:g,microsoftTeamsUserId:g.substring(15),isAnonymous:!0}:g.startsWith(Uo)?{kind:ul.phoneNumber,rawId:g,phoneNumber:g.substring(2)}:g.startsWith(qo)||g.startsWith(zo)||g.startsWith(Jo)||g.startsWith(Ko)?{kind:ul.communicationUser,communicationUserId:g}:g.startsWith(Yo)?{kind:ul.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(9),cloud:"public"}:g.startsWith(Qo)?{kind:ul.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(8),cloud:"gcch"}:g.startsWith(Xo)?{kind:ul.microsoftTeamsApp,rawId:g,teamsAppId:g.substring(7),cloud:"dod"}:{kind:ul.unknown,id:g}}function isCallingApplication(g){return!!g.startsWith(xo)}function isGlobalCallingApplication(g){return!(!g.startsWith(xo)||g.startsWith(Yo)||g.startsWith(Xo)||g.startsWith(Qo))}function validateIdentifier(g){const m=f(g);switch(m.kind){case ul.communicationUser:if(!(m.communicationUserId.startsWith(qo)||m.communicationUserId.startsWith(zo)||m.communicationUserId.startsWith(Jo)||m.communicationUserId.startsWith(Ko)))throw new CallingCommunicationError(z.IDENTIFIER.INVALID_COMM_USER);return m;case"phoneNumber":return m;case ul.microsoftTeamsUser:if(m.rawId&&!m.rawId.startsWith($o)&&!m.rawId.startsWith(Go)&&!m.rawId.startsWith(jo)&&!m.rawId.startsWith(Wo))throw new CallingCommunicationError(z.IDENTIFIER.INVALID_MSFT_TEAMS_USER_RAWID);if(!m.microsoftTeamsUserId)throw new CallingCommunicationError(z.IDENTIFIER.INVALID_MSFT_TEAMS_USER_USERID);return m;case ul.microsoftTeamsApp:if(m.rawId&&!m.rawId.startsWith(xo))throw new CallingCommunicationError(z.IDENTIFIER.INVALID_MSFT_TEAMS_APP_RAWID);if(!m.teamsAppId)throw new CallingCommunicationError(z.IDENTIFIER.INVALID_MSFT_TEAMS_APP_APPID);return m;case ul.unknown:if(!m.id)throw new CallingCommunicationError(z.IDENTIFIER.INVALID_UNKNOWN_IDENTIFIER);return m;default:throw new CallingCommunicationError(z.IDENTIFIER.PARSE_INVALID_IDENTIFIER)}}function assertIsArrayOfIdentifiers(g){if(!(g instanceof Array))throw new CallingCommunicationError(z.IDENTIFIER.INVALID_IDENTIFIER_ARRAY)}function getCloudTypeFromSkypeId(g){const m=g.substring(0,g.indexOf(":"));if(!m)throw new CallingCommunicationError(z.IDENTIFIER.NO_CLOUD_PREFIX_FOUND);switch(m){case da.OrgId:case da.Acs:case da.Spool:return ca.Public;case da.GccHigh:case da.GccHighAcs:return ca.GccHigh;case da.Dod:case da.DodAcs:return ca.Dod;case da.AirGap08:case da.AirGap08Acs:return ca.AirGap08;case da.AirGap09:case da.AirGap09Acs:return ca.AirGap09;default:return ca.Public}}!function(g){g.communicationUser="communicationUser",g.microsoftTeamsUser="microsoftTeamsUser",g.microsoftTeamsApp="microsoftTeamsApp",g.phoneNumber="phoneNumber",g.unknown="unknown",g.group="group"}(ul||(ul={}));const gl="1.22.2.0_stable",pl="1.22.2";function getSdkInternalVersion(){const g="ACS_CLIENT_INTERNAL_SZK_VERSION".replace("Z","D");return gl===g?"1.0.0.0":gl}function getSdkVersion(){const g="ACS_CLIENT_SZK_VERSION".replace("Z","D");return pl===g?"1.0.0.0":pl}function getDateInIsoFormat(){return(new Date).toISOString()}function arrayMergeCustomizer(g,m){if(Array.isArray(g))return m.slice()}function isNonEmptyArray(g){return Array.isArray(g)&&0!==g.length}function isNullOrUndefined$2(g){return null==g||void 0===g}function valueOrDefault(g,m){return void 0!==g?g:m}function isPromiseLike(g){return!!g&&"function"==typeof g.then}function safeJsonStringify(g){try{return JSON.stringify(g,null,2)}catch(m){return`failed to stringify obj ${g}`}}function isIpv4Address(g){return new RegExp(ol).test(g)}let ml,fl={telemetry:{callStatsFlushTimeout:Oa,discardedTelemetryRetryTimeout:Na,discardedEventsBufferMaxLength:ka,discardedEventsMaxRetries:La,telemetryFlushTimeout:Ra,allowedEvents:[],blockedEvents:["acs_calling_feature_usage","acs_calling_call_client_init"],limit:{outSideCall:{enabled:!1,deltaTimeInMs:15e3,includedEvents:[],excludedEvents:[]},rates:[]},telemetryBeforeUnload:!1,gzipTelemetryPayload:!0,localStorageEnable:!1,mediaStatsConfig:{enabled:!0,throttleTelemetry:1,aggregationInterval:10,dataPointsPerAggregation:6,metricsProperties:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},liveStreamStatsConfig:{enabled:!1,fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",additionalStats:{},dataToSend:{raw:!1,min:!0,max:!0,sum:!0,count:!0}},reportSdkUaToService:!1,reportEnvToService:!1,sendNetworkChangedTelemetry:!1,deviceChangedEvents:{enabled:!1,piiSafeWordsMode:"merge",piiSafeWords:Aa},maxExistingReportedParticipants:25},mediaStats:{blockMetrics:{},transformMetrics:{},fetchInterval:1,aggregationInterval:10,dataPointsPerAggregation:6,pollingMethod:"interval",timerThrottlingFilter:{enabled:!1,delayRatio:0,filterRange:{"audio.send":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"audio.receive":{bitrate:{min:0,max:535500},packetsPerSecond:{min:0,max:200},packetsLostPerSecond:{min:0,max:200}},"video.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:66},frameRateEncoded:{min:0,max:66},frameRateSent:{min:0,max:66}},"video.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:66},frameRateDecoded:{min:0,max:66},frameRateReceived:{min:0,max:66}},"screenShare.send":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateInput:{min:0,max:33},frameRateEncoded:{min:0,max:33},frameRateSent:{min:0,max:33}},"screenShare.receive":{bitrate:{min:0,max:8e6},packetsPerSecond:{min:0,max:1e3},packetsLostPerSecond:{min:0,max:1e3},frameRateOutput:{min:0,max:33},frameRateDecoded:{min:0,max:33},frameRateReceived:{min:0,max:33}}}}},debugInfo:{broadcastChannelName:Fa,tabsBroadcastDelay:xa,tabsUpdateDelay:Ua,enableLogDump:Va,maxLogDumpLength:Ba,includeList:[],excludeList:[]},volumeIndicator:{fftSize:Ha,minDecibels:za,maxDecibels:$a,smoothingConstant:Ga,microphoneVolumeSampleIntervalMs:ja,normalisedMaxVolume:Wa,maxAvailableVolume:qa},telemetryEvents:{eventNameToPriority:{eventName:["acs_calling_call_stats"],priority:[ni.Immediate]}},rendering:{remoteVideo:{createViewTimeout:Ka,createViewUnsubscribeTimeout:Ja,debounceTimeout:Ya,createViewSendMediaStats:!0,createViewSendMediaStatsMaxLength:120,createViewSendMediaStatsInitialMaxLength:1,createViewFailureNetworkUfdCheckWindowInMs:2e3,forceCheckIfVideoWasAttachedToDom:!0,checkIfVideoAttachedToDom_poll:!0,checkIfVideoAttachedToDom_intervalTime:Qa,checkIfVideoAttachedToDom_intervalMaxTries:Xa,checkIfVideoAttachedToDom_timeout:Za,createViewSenderStatsDuration:eo,registeredViewIdsMaxLength:to,getMediaStreamTimeout:io,largeMeeting:{handleVideoRendering:!0,participantCountThreshold:no,dominantSpeakersWithVideoOn_topCount:ro}}},captions:{acsBotMri:go,teamsBotMri:po,clientInfo:mo,availableLanguages:So,enabled:!0,acs:{botMri:go,clientInfo:{ring:mo},spokenLanguages:{enabled:!0,languages:So}},teams:{botMri:po,clientInfo:{ring:fo},spokenLanguages:{enabled:!0,languages:So},captionLanguages:{enabled:!1,languages:vo}}},audioEffects:{enableAudioEffects:!1},videoEffects:{enableVideoEffects:!1,effectInitTimeThresholdInMs:2e4,fpsWarningThreshold:5,waitTimeToInitiateFpsChecksInMs:2e4,fpsCheckIntervalTimeInMs:3e3},calling:{enableMuteOthers:!0,enableSmePassFakeConversation:!1,doNotWaitForTrouter:!1,hangUpCallOnPageHide:!1,maxNumberOfTokenFetchRetries:10,deviceSelectionTimeoutInMs:3e3,deviceNotFunctioningMuted:!0,muteUnmuteOnMicrophoneNotFunctioning:!1,unmuteDelayForMicrophoneNotFunctioningInMs:0,preventStopAudio:!1,preventFakeMute:!1,osAutoRecoverAudio:!1,deviceCaptureMuteRecover:!1,allowMuteOnBadUfd:!0,preventStopVideo:!0,mediaMetricsDeviceEventsEnabled:!1,allowAccessRawMediaStream:!1,applyViewLimit:!1,deviceCaptureMutedVideo:!0,removeLvsCheckOnCallStartAndCallAccept:!1,removeLocalAudioStreamCheckOnCallStartAndCallAccept:!1,constraints:{enabled:!1,maxOutgoingResolution:0,maxOutgoingFrameRate:0,maxOutgoingVideoBitrate:0},supportLiveStreaming:!1,liveStreamingBotIds:Io,composedStreamBotIds:bo,setDeviceType:!1,devicePermissions:{splitAskAudioVideo:!1,timeoutInBetween:0,getCurrentState:!0},applicationSettingsUrls:{Public_ConversationServiceUrl:pa.Public_ConversationServiceUrl,Public_TrouterServiceUrl:pa.Public_TrouterServiceUrl,Public_RegistrarServiceUrl:pa.Public_RegistrarServiceUrl,Public_MdnTrapServiceUrl:pa.Public_MdnTrapServiceUrl,Public_MdnTrapServiceTokenUrl:pa.Public_MdnTrapServiceTokenUrl,Public_MdnTrapRelaySkypeFqdns:pa.Public_MdnTrapRelaySkypeFqdns,Public_MdnTrapRelayTurnFqdns:pa.Public_MdnTrapRelayTurnFqdns,Public_MdnTrapRelayTurnUrl:pa.Public_MdnTrapRelayTurnUrl,GccHigh_ConversationServiceUrl:pa.GccHigh_ConversationServiceUrl,GccHigh_TrouterServiceUrl:pa.GccHigh_TrouterServiceUrl,GccHigh_RegistrarServiceUrl:pa.GccHigh_RegistrarServiceUrl,GccHigh_MdnTrapServiceUrl:pa.GccHigh_MdnTrapServiceUrl,GccHigh_MdnTrapServiceTokenUrl:pa.GccHigh_MdnTrapServiceTokenUrl,GccHigh_MdnTrapRelaySkypeFqdns:pa.GccHigh_MdnTrapRelaySkypeFqdns,GccHigh_MdnTrapRelayTurnFqdns:pa.GccHigh_MdnTrapRelayTurnFqdns,GccHigh_MdnTrapRelayTurnUrl:pa.GccHigh_MdnTrapRelayTurnUrl,Dod_ConversationServiceUrl:pa.Dod_ConversationServiceUrl,Dod_TrouterServiceUrl:pa.Dod_TrouterServiceUrl,Dod_RegistrarServiceUrl:pa.Dod_RegistrarServiceUrl,Dod_MdnTrapServiceUrl:pa.Dod_MdnTrapServiceUrl,Dod_MdnTrapServiceTokenUrl:pa.Dod_MdnTrapServiceTokenUrl,Dod_MdnTrapRelaySkypeFqdns:pa.Dod_MdnTrapRelaySkypeFqdns,Dod_MdnTrapRelayTurnFqdns:pa.Dod_MdnTrapRelayTurnFqdns,Dod_MdnTrapRelayTurnUrl:pa.Dod_MdnTrapRelayTurnUrl,AirGap08_ConversationServiceUrl:pa.AirGap08_ConversationServiceUrl,AirGap08_TrouterServiceUrl:pa.AirGap08_TrouterServiceUrl,AirGap08_RegistrarServiceUrl:pa.AirGap08_RegistrarServiceUrl,AirGap09_ConversationServiceUrl:pa.AirGap09_ConversationServiceUrl,AirGap09_TrouterServiceUrl:pa.AirGap09_TrouterServiceUrl,AirGap09_RegistrarServiceUrl:pa.AirGap09_RegistrarServiceUrl,Enterprise_ConversationServiceUrl:pa.Enterprise_ConversationServiceUrl,Enterprise_TrouterServiceUrl:pa.Enterprise_TrouterServiceUrl,Enterprise_RegistrarServiceUrl:pa.Enterprise_RegistrarServiceUrl,Enterprise_MdnTrapServiceUrl:pa.Enterprise_MdnTrapServiceUrl,Enterprise_MdnTrapServiceTokenUrl:pa.Enterprise_MdnTrapServiceTokenUrl,Enterprise_MdnTrapRelaySkypeFqdns:pa.Enterprise_MdnTrapRelaySkypeFqdns,Enterprise_MdnTrapRelayTurnFqdns:pa.Enterprise_MdnTrapRelayTurnFqdns,Enterprise_MdnTrapRelayTurnUrl:pa.Enterprise_MdnTrapRelayTurnUrl},applicationSettingsEudbUrls:{Public_ConversationServiceUrl_EUDB:ga.Public_ConversationServiceUrl_EUDB,Public_TrouterServiceUrl_EUDB:ga.Public_TrouterServiceUrl_EUDB,Public_RegistrarServiceUrl_EUDB:ga.Public_RegistrarServiceUrl_EUDB,Public_MdnTrapServiceUrl_EUDB:ga.Public_MdnTrapServiceUrl_EUDB,Public_MdnTrapServiceTokenUrl_EUDB:ga.Public_MdnTrapServiceTokenUrl_EUDB,Public_MdnTrapRelaySkypeFqdns_EUDB:ga.Public_MdnTrapRelaySkypeFqdns_EUDB,Public_MdnTrapRelayTurnFqdns_EUDB:ga.Public_MdnTrapRelayTurnFqdns_EUDB,Public_MdnTrapRelayTurnUrl_EUDB:ga.Public_MdnTrapRelayTurnUrl_EUDB,Enterprise_ConversationServiceUrl_EUDB:ga.Enterprise_ConversationServiceUrl_EUDB,Enterprise_TrouterServiceUrl_EUDB:ga.Enterprise_TrouterServiceUrl_EUDB,Enterprise_RegistrarServiceUrl_EUDB:ga.Enterprise_RegistrarServiceUrl_EUDB,Enterprise_MdnTrapServiceUrl_EUDB:ga.Enterprise_MdnTrapServiceUrl_EUDB,Enterprise_MdnTrapServiceTokenUrl_EUDB:ga.Enterprise_MdnTrapServiceTokenUrl_EUDB,Enterprise_MdnTrapRelaySkypeFqdns_EUDB:ga.Enterprise_MdnTrapRelaySkypeFqdns_EUDB,Enterprise_MdnTrapRelayTurnFqdns_EUDB:ga.Enterprise_MdnTrapRelayTurnFqdns_EUDB,Enterprise_MdnTrapRelayTurnUrl_EUDB:ga.Enterprise_MdnTrapRelayTurnUrl_EUDB},maxDisplayNameLength:256,callDiagnostics:Ia,eudb:{isEnabled:!0,countries:Sa,regions:va,defaultDataLocationEurope:!1,EmeaTenants:ya,ApacTenants:Ca,NoamTenants:_a,acsCompliantEvents:{},isRgnClaimEnabledForACS:!0,sendRegionToNgc:!0},tfl:{isEnabled:!1,hosts:["teams.live.com"]},lobbyAdmitAndReject:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},localRecording:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},enableCustomTurnUsage:!1,allowProxyForTeamsCalls:!1,allowCustomTurnForTeamsCalls:!1,spotlight:{enabled:!0,maxSpotlightParticipants:7,supportedRoles:["presenter","organizer","coorganizer"],meetingTypes:["scheduledMeeting"]},teamsMeetingAudioConferencing:{enabled:!0,supportedConversationTypes:["scheduledMeeting","adHocMeeting"]},transfer:{autoAccept:!0},reaction:{enabled:!0,telemetryEventAggregationIntervalInSecond:3,enableStateServiceConsoleLogs:!0,StateServiceProxySettings:{batchedRequestsEnabled:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,pingTimeoutInMs:2e4,pongTimeoutInMs:5e3,maxSessionRetries:2,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheLength:64,maxOfflineMessageCacheTimeInMs:2e4,autoRoutingEnabled:!0}},pptlive:{enabled:!0,wdParams:{wdModernSlideShowInTeams:!0,wdPresenterViewInTeams:!1,wdForceModernSlideShowInTeams:!1,isMovePrivateViewingToPPTEnabled:!0},appSettings:{takeFocusOnBoot:!0,enableAdvanceOnClick:!1,enableAdvanceOnTap:!1},stateServiceProxySettings:{batchedRequestsEnabled:!1,maxRoundtripRaw:300,pingTimeoutInMs:15e3,pongTimeoutInMs:15e3,retryIntervalsInMs:[1e3,2e3,4e3],verbose:!1,websocketAliveTimeAfterLoseFocusInMS:3e4,autoRoutingEnabled:!0,useServiceGeneratedClientId:!0,offlineMessageCacheEnabled:!0,maxOfflineMessageCacheTimeInMs:2e4,maxOfflineMessageCacheLength:64,allowReconnectOnSendMessage:!0},enableStateServiceInPreviewerFeatures:'["Ink","Media","Nav","NavSync","PresUrl","PresUrlBoot"]',featureGates:'{"ModernSlideShowAllowListForFileType":"pptx;ppsx;potx;pptm;ppsm;pot;ppt;odp;pps"}'},blacklistedBots:[],musicOnHoldEnabled:!0},dataChannel:{maxReceiveBufferSize:2097152,receiveTimeoutInMs:12e4,maxSendBandwidth:5e5,maxBroadcastPacketRate:80,defaultBitrate:32e3,maxMessageSize:32768,enableBroadcastLimitOnReliableChannel:!1,dataIdConfigs:[]},unmixedAudio:{maxStreamSize:7,operationTimeoutInMs:1e4,skipProviderStateCheck:!1},roles:{acsOrganizer:ba.AcsOrganizerRole,acsPresenter:ba.AcsPresenterRole,acsAttendee:ba.AcsAttendeeRole,acsConsumer:ba.AcsConsumerRole,teamsAttendee:ba.TeamsAttendee,teamsOrganizer:ba.TeamsOrganizer,teamsPresenter:ba.TeamsPresenter,teamsCoorganizer:ba.TeamsCoorganizer},roomsRoleBasedCapabilities:{presenter:getDefaultCapabilities("roomJoin","Presenter"),attendee:getDefaultCapabilities("roomJoin","Attendee"),consumer:getDefaultCapabilities("roomJoin","Consumer")},teamsRoleBasedCapabilities:{organizer:getDefaultCapabilities("teamsMeetingJoin","Organizer"),coorganizer:getDefaultCapabilities("teamsMeetingJoin","Co-organizer"),presenter:getDefaultCapabilities("teamsMeetingJoin","Presenter"),attendee:getDefaultCapabilities("teamsMeetingJoin","Attendee")},environments:{android:{chrome:{minVersion:Ro,isSupportedOnSdkVersion:wo},edgeanaheim:{minVersion:Ro,isSupportedOnSdkVersion:wo}},ios:{safari:{minVersion:Ro,isSupportedOnSdkVersion:wo},chrome:{minVersion:Ro,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")},applewebview:{minVersion:Ro,isSupportedOnSdkVersion:wo}},mac:{chrome:{minVersion:Ro,isSupportedOnSdkVersion:wo},safari:{minVersion:Ro,isSupportedOnSdkVersion:wo},edgeanaheim:{minVersion:Ro,isSupportedOnSdkVersion:wo},firefox:{minVersion:Ro,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}},windows:{chrome:{minVersion:Ro,isSupportedOnSdkVersion:wo},chromium:{minVersion:Ro,isSupportedOnSdkVersion:wo},edgeanaheim:{minVersion:Ro,isSupportedOnSdkVersion:wo},firefox:{minVersion:Ro,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}},linux:{chrome:{minVersion:Ro,isSupportedOnSdkVersion:wo},firefox:{minVersion:Ro,isSupportedOnSdkVersion:!getSdkVersion().includes("stable")}}},MiddleTier:{enabled:!1,maxRetry:3,baseServiceUrl:ma.baseServiceUrl,policyUrlSuffix:ma.policyUrlSuffix,policyUrlSuffixV2:ma.policyUrlSuffixV2,userPolicySettingsApi:!1},PowerPointStateServiceUrl:{public:{amer:"https://usc.pptservicescast.officeapps.live.com",apac:"https://apac.pptservicescast.officeapps.live.com",emea:"https://emea.pptservicescast.officeapps.live.com",uk:"https://ukc.pptservicescast.officeapps.live.com",eu:"https://euc.pptservicescast.officeapps.live.com",in:"https://inc.pptservicescast.officeapps.live.com",au:"https://auc.pptservicescast.officeapps.live.com",ca:"https://canc.pptservicescast.officeapps.live.com",fr:"https://fr.pptservicescast.officeapps.live.com",jp:"https://jpc.pptservicescast.officeapps.live.com",ae:"https://ae.pptservicescast.officeapps.live.com",kr:"https://krc.pptservicescast.officeapps.live.com",sg:"https://sg.pptservicescast.officeapps.live.com",za:"https://za.pptservicescast.officeapps.live.com",de:"https://de.pptservicescast.officeapps.live.com",ch:"https://ch.pptservicescast.officeapps.live.com",no:"https://no.pptservicescast.officeapps.live.com",br:"https://pptservicescast.officeapps.live.com",se:"https://se.pptservicescast.officeapps.live.com",qa:"https://qa.pptservicescast.officeapps.live.com",gallatin:"https://pptservicescast.osi.microsoftonline.cn",pl:"https://pl.pptservicescast.officeapps.live.com",it:"https://euc.pptservicescast.officeapps.live.com",il:"https://pptservicescast.officeapps.live.com",mx:"https://pptservicescast.officeapps.live.com"},gcc:"https://pptservicescast.gcc.osi.office365.us",gcch:"https://pptservicescast.osi.office365.us",dod:"https://pptservicescast.osi.apps.mil",ag08:"https://pptservicescast.osi.eaglex.ic.gov",ag09:"https://pptservicescast.osi.microsoft.scloud"}};function setAcsEcsConfig(g){if(!g)throw new CallingCommunicationError(z.INTERNAL.ECS_CONFIG_EMPTY);if(!g.AcsCallingSDKWeb)throw new CallingCommunicationError(z.INTERNAL.ECS_CONFIG_MISSING_ACS);try{const m=fl.telemetry.deviceChangedEvents.piiSafeWords.slice();R.mergeWith(fl,g.AcsCallingSDKWeb,arrayMergeCustomizer);const f=fl.telemetry.deviceChangedEvents;"merge"===f.piiSafeWordsMode&&(f.piiSafeWords=R.union(m,f.piiSafeWords))}catch(g){throw new CallingCommunicationError(z.INTERNAL.ECS_CONFIG_MERGING_ERROR)}}function getAcsEcsConfig(){return fl}function setMediaConfig(g){ml=g}function getMediaConfig(){return ml}function getDefaultCapabilities(g,m){let f={turnVideoOn:!0,unmuteMic:!0,shareScreen:!0,removeParticipant:!0,hangUpForEveryOne:!0,addCommunicationUser:!0,addTeamsUser:!0,addPhoneNumber:!0,manageLobby:!0,spotlightParticipant:!0,removeParticipantsSpotlight:!0,blurBackground:!0,startLiveCaptions:!0,stopLiveCaptions:!0,raiseHand:!0,pstnDialOut:!0,muteOthers:!0,useReactions:!0};if("teamsMeetingJoin"==g){if("Presenter"==m||"Co-organizer"==m||"Organizer"==m)return{...f};if("Attendee"==m){let g={...f};return g.removeParticipant=!1,g.manageLobby=!1,g.spotlightParticipant=!1,g.removeParticipantsSpotlight=!1,g.shareScreen=!1,g.muteOthers=!1,g}}if("roomJoin"==g){let g={...f};if(g.removeParticipant=!1,g.hangUpForEveryOne=!1,g.addCommunicationUser=!1,g.addTeamsUser=!1,g.manageLobby=!1,g.spotlightParticipant=!1,g.removeParticipantsSpotlight=!1,g.blurBackground=!1,g.startLiveCaptions=!1,g.stopLiveCaptions=!1,g.raiseHand=!1,"Presenter"==m)return{...g};if("Attendee"==m){let m={...g};return m.shareScreen=!1,m.muteOthers=!1,m.addPhoneNumber=!1,m.pstnDialOut=!1,m}if("Consumer"==m){let m={...g};return m.turnVideoOn=!1,m.unmuteMic=!1,m.shareScreen=!1,m.muteOthers=!1,m.addPhoneNumber=!1,m.pstnDialOut=!1,m}}return f}const Sl=["response","responseText","responseURL","status","state","statusText","timeout","withCredentials","stack","message","name","error","piiSafe","phase","code","participantId","phrase","subCode","reason"];function toTsScalingMode(g){switch(g){case"Crop":return 1;case"Fit":return 2;default:return 0}}function stringifyObject(g){return g.toString===Object.prototype.toString?JSON.stringify(g):g.toString()}function getSizeInBytes(g,m){try{return"string"==typeof g?new Blob([g]).size:g.byteLength}catch(g){return m.error(g),0}}function shallowEqual(g,m){const f=Object.keys(g);for(let S of f)if(g[S]!==m[S])return!1;return!0}function convertMapToFrozenJson(g){let m={};return g.forEach(((g,f)=>{m[f]=g})),Object.freeze(m)}function defer(){let g,m,f=!0;return{isPending:()=>f,promise:new Promise(((f,S)=>{g=f,m=S})),resolve:m=>{f&&(g(m),f=!1)},reject:g=>{f&&(m(g),f=!1)},dispose:()=>{f&&(m("disposed"),f=!1)}}}function timedDefer(g,m="Timed promise; rejected."){let f,S,v,C=!0;const timerStart=()=>{v=window.setTimeout((()=>{S(new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.EFFECT_PROVIDER_TIMEOUT))}),g)},timerStop=()=>{window.clearTimeout(v)};let _=new Promise(((g,m)=>{f=m=>{timerStop(),C=!1,g(m)},S=g=>{timerStop(),C=!1,m(g)}}));return{timerStart:timerStart,timerStop:timerStop,deferredPromise:{promise:_,resolve:f,reject:S,isPending:()=>C,dispose:()=>{S("disposed")}}}}function assertNotNull(g,m){if(null==g)throw new CallingCommunicationError(m)}function assertIsObject(g,m){if("object"!=typeof g)throw new CallingCommunicationError(m)}function parseJWT(g){let[,m]=g?.split(".");if(void 0===m)throw new CallingCommunicationError(z.INTERNAL.TOKEN_PAYLOAD_UNDEFINED);return m=m.replace(/-/g,"+").replace(/_/g,"/"),JSON.parse(decodeURIComponent(escape(atob(m))))}function logErrorAndThrow(g,m){throw m.error(`CallingCommunicationError: Message={${g.message},Code={${g.code}}, SubCode={${g.subCode}}, ResultCategories={${g.resultCategories}}`),new CallingCommunicationError(g)}function noop(){}function isEudbLocation(g,m){const f=getGeoLocations(g);return!!m&&!!f.find((g=>g===m))}function isEudbConfigurationsApplicable(g,m){return getAcsEcsConfig().calling.eudb.isEnabled&&isEudbLocation(g,m||"")}function isRgnClaimApplicable(g){return getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS||!!g&&g===fa.Enterprise||!1}function getGeoLocations(g){return isRgnClaimApplicable(g)?getAcsEcsConfig().calling.eudb.regions:getAcsEcsConfig().calling.eudb.countries}async function parseTokenCredential(g,m,f){let S;try{if(!g)throw new CallingCommunicationError(z.INTERNAL.NO_TOKEN_PROVIDED);try{S=(await g.getToken(f))?.token}catch(g){throw new CallingCommunicationError("The token returned from the tokenRefresher is expired."===g.message?z.CALL_AGENT.ACCESSTOKEN_EXPIRED:z.INTERNAL.GET_TOKEN)}if(!S)throw new CallingCommunicationError(z.INTERNAL.EMPTY_TOKEN)}catch(g){throw new CallingCommunicationError(z.INTERNAL.GET_TOKEN,g)}try{let g=parseJWT(S);if(!g)throw new CallingCommunicationError(z.INTERNAL.TOKEN_UNDEFINED);if("string"!=typeof g.acsScope)throw new CallingCommunicationError(z.INTERNAL.INVALID_TOKEN_SCOPE_FORMAT);if(!g.acsScope.split(",").find((g=>"voip"===g||"voip.join"===g)))throw new CallingCommunicationError(z.INTERNAL.INVALID_TOKEN_SCOPE);const f=g.resourceId,v=constructIdentifierKindFromMri(`8:${g.skypeid}`);if(!f&&!("microsoftTeamsUser"===v?.kind))throw new CallingCommunicationError(z.INTERNAL.RESOURCE_NOT_FOUND_IN_TOKEN);let C=g.skypeid;if(!C)throw new CallingCommunicationError(z.INTERNAL.USERID_NOT_FOUND_IN_TOKEN);const _=getCloudTypeFromSkypeId(C),E=!!g.tid,T=!!g.rgn;return{jwtToken:S,acsResourceId:f,identityMri:C,cloudType:_,isCte:E,region:(E||m?g.rgn:g.resourceLocation)||"",rgnClaimExists:T,exp:1e3*g.exp}}catch(g){throw new CallingCommunicationError(z.INTERNAL.PARSE_TOKEN_FAIL,g)}}function buildCallingUserAgent(g,m,f){const S=`azsdk-js-communication-calling/${g}`;let v="";if(f?.diagnostics?.appName){let g=f?.diagnostics?.appName.trim().replace(/\s/g,"_");g.length>64&&(m.warn("appName is too long, max allowed length is 64 chars, appName was truncated to max length"),g=g.substr(0,64)),v+=g?`${g}/`:"default/"}else v+="default/";if(f?.diagnostics?.appVersion){let g=f?.diagnostics?.appVersion.trim().replace(/\s/g,"_");g.length>64&&(m.warn("appVersion is too long, max allowed length is 64 chars, appVersion was truncated to max length"),g=g.substr(0,64)),v+=g||"0.0.0"}else v+="0.0.0";if(v+=` ${S}`,f?.diagnostics?.tags&&Array.isArray(f?.diagnostics?.tags)&&f?.diagnostics?.tags.length>0){let g=f?.diagnostics?.tags.map((g=>g.trim().replace(/\s/g,"_"))).filter((g=>!!g)).join(";");g.length>128&&(m.warn("tags are too long, max allowed length is 128 chars, tags were truncated to max length"),g=g.substr(0,128)),g.length>0&&(v+=" ("+g+").")}return v}function getJoinContextDescription(g){return g?g.groupId?el.GroupCall:!g.threadId||g.organizerId||g.tenantId||g.messageId?g.threadId&&g.organizerId&&g.tenantId&&g.messageId?el.TeamsCoordinates:g.meetingId?el.TeamsMeetingId:g.meetingLink?el.TeamsMeetingLink:g.roomId?el.RoomCall:el.Unknown:el.GroupChatCall:el.Unknown}function getPrintableObject(g,m=!1){const processStackTrace=g=>{try{return g.split("\n")[0]}catch(g){return"invalid stack"}};if(void 0===g)return"void";if(g instanceof Error)return g.toString();if(g instanceof String||g instanceof Number||g instanceof Boolean)return g.toString();try{return g.stack&&(g.stack=processStackTrace(g.stack)),(m?JSON.stringify(g):JSON.stringify(g,Sl,4)).replace(/(\r\n\t|\n|\r\t|\s)/gm,"")}catch(m){return`failed to get error information:${g&&"function"==typeof g.toString&&g.toString()} ${g&&g.response&&JSON.stringify(g.response)}`}}function permissionStateToBool(g,m){return m.info("permission state to boolean",g),"granted"===g}function getSafeObjectDiff(g,m,f=[]){let S=[];try{const v=Array.isArray(g);for(const C in g){const _=g[C],E=v?+C:C;if(!(C in m)){S.push({type:"REMOVE",path:[E],oldValue:g[C]});continue}const T=m[C],I="object"==typeof _&&"object"==typeof T;if(_&&T&&I&&!j[Object.getPrototypeOf(_).constructor.name]&&!f.includes(_)){const g=getSafeObjectDiff(_,T);S.push.apply(S,g.map((g=>(g.path.unshift(E),g))))}else _===T||I&&(isNaN(_)?_+""==T+"":+_==+T)||S.push({path:[E],type:"CHANGE",value:T,oldValue:_})}const C=Array.isArray(m);for(const f in m)f in g||S.push({type:"CREATE",path:[C?+f:f],value:m[f]})}catch(g){}return S}function advancedMeetingRoleToParticipantRole(g,m){const f={[g.roles.acsOrganizer.toLowerCase()]:tl.Organizer,[g.roles.teamsOrganizer.toLowerCase()]:tl.Organizer,[g.roles.acsPresenter.toLowerCase()]:tl.Presenter,[g.roles.teamsPresenter.toLowerCase()]:tl.Presenter,[g.roles.acsAttendee.toLowerCase()]:tl.Attendee,[g.roles.teamsAttendee.toLowerCase()]:tl.Attendee,[g.roles.acsConsumer.toLowerCase()]:tl.Consumer,[g.roles.teamsCoorganizer.toLowerCase()]:tl.Coorganizer};return m&&f[m.toString().toLowerCase()]?f[m.toString().toLowerCase()]:tl.Unknown}function hasMeetingDetailsChanged(g,m){return null==m.meetingCapability&&null!=g.meetingCapability||(null==m.capabilities&&null!=g.capabilities||!(R.isEqual(m.capabilities,g.capabilities)&&R.isEqual(m.meetingCapability,g.meetingCapability)))}function hasCoreMeetingCapabilitiesChanged(g,m){return!(!g.capabilities||null==g.capabilities.allowVideo||null!=m.capabilities?.allowVideo&&m.capabilities.allowVideo==g.capabilities.allowVideo)||(!(!g.meetingCapability||null==g.meetingCapability.allowIPVideo||null!=m.meetingCapability?.allowIPVideo&&m.meetingCapability.allowIPVideo==g.meetingCapability.allowIPVideo)||(!(!g.meetingCapability||null==g.meetingCapability.attendeeRestrictions||null!=m.meetingCapability?.attendeeRestrictions&&m.meetingCapability.attendeeRestrictions==g.meetingCapability.attendeeRestrictions)||(!(!g.meetingCapability||null==g.meetingCapability.allowPstnConferencing||null!=m.meetingCapability?.allowPstnConferencing&&m.meetingCapability.allowPstnConferencing==g.meetingCapability.allowPstnConferencing)||(!(!g.meetingCapability||null==g.meetingCapability.allowTranslatedCaptions||null!=m.meetingCapability?.allowTranslatedCaptions&&m.meetingCapability?.allowTranslatedCaptions==g.meetingCapability.allowTranslatedCaptions)||(!(!g.meetingCapability||null==g.meetingCapability.allowTranslatedTranscriptions||null!=m.meetingCapability?.allowTranslatedTranscriptions&&m.meetingCapability?.allowTranslatedTranscriptions==g.meetingCapability.allowTranslatedTranscriptions)||(!(!g.meetingCapability||null==g.meetingCapability.allowRaiseHands||null!=m.meetingCapability?.allowRaiseHands&&m.meetingCapability?.allowRaiseHands==g.meetingCapability.allowRaiseHands)||(!(!g.meetingCapability||null==g.meetingCapability.allowTeamsMeetingReactions||null!=m.meetingCapability?.allowTeamsMeetingReactions&&m.meetingCapability?.allowTeamsMeetingReactions==g.meetingCapability.allowTeamsMeetingReactions)||!(!g.meetingCapability||null==g.meetingCapability.presenterOption||null!=m.meetingCapability?.presenterOption&&m.meetingCapability?.presenterOption==g.meetingCapability.presenterOption))))))))}function isProxyAndCustomTurnAllowed(g,m,f,S,v){if(f||S&&"microsoftTeamsUser"===S.kind||v&&callContextHasTeamsJoinOptions(v)){const f=getAcsEcsConfig().calling.allowProxyForTeamsCalls,S=g.proxyInUse,v=getAcsEcsConfig().calling.allowCustomTurnForTeamsCalls,C=m.customRelayManagerInUse;if(S&&!f)return!1;if(C&&!v)return!1}return!0}function IsAdhocInteropCall(g){return!!g.find((g=>"microsoftTeamsUser"===f(g).kind))}function callContextHasTeamsJoinOptions(g){return!!(g.meetingId||g.meetingLink||g.messageId||g.organizerId||g.tenantId||g.threadId)}function initializeUfdsCorrelationIdCache(){return{1:{0:void 0,1:void 0,2:void 0,3:void 0},2:{0:void 0,1:void 0,2:void 0,3:void 0},3:{0:void 0,1:void 0,2:void 0,3:void 0},4:{0:void 0,1:void 0,2:void 0,3:void 0},5:{0:void 0,1:void 0,2:void 0,3:void 0},6:{0:void 0,1:void 0,2:void 0,3:void 0},7:{0:void 0,1:void 0,2:void 0,3:void 0},8:{0:void 0,1:void 0,2:void 0,3:void 0},9:{0:void 0,1:void 0,2:void 0,3:void 0},10:{0:void 0,1:void 0,2:void 0,3:void 0},11:{0:void 0,1:void 0,2:void 0,3:void 0},12:{0:void 0,1:void 0,2:void 0,3:void 0},13:{0:void 0,1:void 0,2:void 0,3:void 0},14:{0:void 0,1:void 0,2:void 0,3:void 0},15:{0:void 0,1:void 0,2:void 0,3:void 0},16:{0:void 0,1:void 0,2:void 0,3:void 0},17:{0:void 0,1:void 0,2:void 0,3:void 0},18:{0:void 0,1:void 0,2:void 0,3:void 0},19:{0:void 0,1:void 0,2:void 0,3:void 0},20:{0:void 0,1:void 0,2:void 0,3:void 0},21:{0:void 0,1:void 0,2:void 0,3:void 0},22:{0:void 0,1:void 0,2:void 0,3:void 0},23:{0:void 0,1:void 0,2:void 0,3:void 0},24:{0:void 0,1:void 0,2:void 0,3:void 0},25:{0:void 0,1:void 0,2:void 0,3:void 0},26:{0:void 0,1:void 0,2:void 0,3:void 0},27:{0:void 0,1:void 0,2:void 0,3:void 0},28:{0:void 0,1:void 0,2:void 0,3:void 0},29:{0:void 0,1:void 0,2:void 0,3:void 0},30:{0:void 0,1:void 0,2:void 0,3:void 0},31:{0:void 0,1:void 0,2:void 0,3:void 0},32:{0:void 0,1:void 0,2:void 0,3:void 0},33:{0:void 0,1:void 0,2:void 0,3:void 0},34:{0:void 0,1:void 0,2:void 0,3:void 0},35:{0:void 0,1:void 0,2:void 0,3:void 0},36:{0:void 0,1:void 0,2:void 0,3:void 0},37:{0:void 0,1:void 0,2:void 0,3:void 0},38:{0:void 0,1:void 0,2:void 0,3:void 0},39:{0:void 0,1:void 0,2:void 0,3:void 0},40:{0:void 0,1:void 0,2:void 0,3:void 0},41:{0:void 0,1:void 0,2:void 0,3:void 0},42:{0:void 0,1:void 0,2:void 0,3:void 0},43:{0:void 0,1:void 0,2:void 0,3:void 0},44:{0:void 0,1:void 0,2:void 0,3:void 0},45:{0:void 0,1:void 0,2:void 0,3:void 0},46:{0:void 0,1:void 0,2:void 0,3:void 0},47:{0:void 0,1:void 0,2:void 0,3:void 0},48:{0:void 0,1:void 0,2:void 0,3:void 0},49:{0:void 0,1:void 0,2:void 0,3:void 0},50:{0:void 0,1:void 0,2:void 0,3:void 0},51:{0:void 0,1:void 0,2:void 0,3:void 0},52:{0:void 0,1:void 0,2:void 0,3:void 0},53:{0:void 0,1:void 0,2:void 0,3:void 0},54:{0:void 0,1:void 0,2:void 0,3:void 0},55:{0:void 0,1:void 0,2:void 0,3:void 0},56:{0:void 0,1:void 0,2:void 0,3:void 0},57:{0:void 0,1:void 0,2:void 0,3:void 0},58:{0:void 0,1:void 0,2:void 0,3:void 0},59:{0:void 0,1:void 0,2:void 0,3:void 0},60:{0:void 0,1:void 0,2:void 0,3:void 0},61:{0:void 0,1:void 0,2:void 0,3:void 0},62:{0:void 0,1:void 0,2:void 0,3:void 0},63:{0:void 0,1:void 0,2:void 0,3:void 0},64:{0:void 0,1:void 0,2:void 0,3:void 0},65:{0:void 0,1:void 0,2:void 0,3:void 0},66:{0:void 0,1:void 0,2:void 0,3:void 0},67:{0:void 0,1:void 0,2:void 0,3:void 0},68:{0:void 0,1:void 0,2:void 0,3:void 0},69:{0:void 0,1:void 0,2:void 0,3:void 0},70:{0:void 0,1:void 0,2:void 0,3:void 0},71:{0:void 0,1:void 0,2:void 0,3:void 0},72:{0:void 0,1:void 0,2:void 0,3:void 0},73:{0:void 0,1:void 0,2:void 0,3:void 0},74:{0:void 0,1:void 0,2:void 0,3:void 0},75:{0:void 0,1:void 0,2:void 0,3:void 0},76:{0:void 0,1:void 0,2:void 0,3:void 0},77:{0:void 0,1:void 0,2:void 0,3:void 0}}}var vl=createCommonjsModule((function(g,m){var f="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;m.assign=function(g){for(var m=Array.prototype.slice.call(arguments,1);m.length;){var f=m.shift();if(f){if("object"!=typeof f)throw new TypeError(f+"must be non-object");for(var S in f)f.hasOwnProperty(S)&&(g[S]=f[S])}}return g},m.shrinkBuf=function(g,m){return g.length===m?g:g.subarray?g.subarray(0,m):(g.length=m,g)};var S={arraySet:function(g,m,f,S,v){if(m.subarray&&g.subarray)g.set(m.subarray(f,f+S),v);else for(var C=0;C<S;C++)g[v+C]=m[f+C]},flattenChunks:function(g){var m,f,S,v,C,_;for(S=0,m=0,f=g.length;m<f;m++)S+=g[m].length;for(_=new Uint8Array(S),v=0,m=0,f=g.length;m<f;m++)C=g[m],_.set(C,v),v+=C.length;return _}},v={arraySet:function(g,m,f,S,v){for(var C=0;C<S;C++)g[v+C]=m[f+C]},flattenChunks:function(g){return[].concat.apply([],g)}};m.setTyped=function(g){g?(m.Buf8=Uint8Array,m.Buf16=Uint16Array,m.Buf32=Int32Array,m.assign(m,S)):(m.Buf8=Array,m.Buf16=Array,m.Buf32=Array,m.assign(m,v))},m.setTyped(f)})),yl=4,Cl=0,_l=1,El=2;function zero(g){for(var m=g.length;--m>=0;)g[m]=0}var Tl=0,Il=1,bl=2,Al=3,Pl=258,Rl=29,wl=256,Ml=wl+1+Rl,Dl=30,Ol=19,Nl=2*Ml+1,kl=15,Ll=16,Fl=7,xl=256,Ul=16,Vl=17,Bl=18,Hl=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],$l=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],Gl=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],jl=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],Wl=512,ql=new Array(2*(Ml+2));zero(ql);var zl=new Array(2*Dl);zero(zl);var Kl=new Array(Wl);zero(Kl);var Jl=new Array(Pl-Al+1);zero(Jl);var Yl=new Array(Rl);zero(Yl);var Ql,Xl,Zl,ec=new Array(Dl);function StaticTreeDesc(g,m,f,S,v){this.static_tree=g,this.extra_bits=m,this.extra_base=f,this.elems=S,this.max_length=v,this.has_stree=g&&g.length}function TreeDesc(g,m){this.dyn_tree=g,this.max_code=0,this.stat_desc=m}function d_code(g){return g<256?Kl[g]:Kl[256+(g>>>7)]}function put_short(g,m){g.pending_buf[g.pending++]=255&m,g.pending_buf[g.pending++]=m>>>8&255}function send_bits(g,m,f){g.bi_valid>Ll-f?(g.bi_buf|=m<<g.bi_valid&65535,put_short(g,g.bi_buf),g.bi_buf=m>>Ll-g.bi_valid,g.bi_valid+=f-Ll):(g.bi_buf|=m<<g.bi_valid&65535,g.bi_valid+=f)}function send_code(g,m,f){send_bits(g,f[2*m],f[2*m+1])}function bi_reverse(g,m){var f=0;do{f|=1&g,g>>>=1,f<<=1}while(--m>0);return f>>>1}function bi_flush(g){16===g.bi_valid?(put_short(g,g.bi_buf),g.bi_buf=0,g.bi_valid=0):g.bi_valid>=8&&(g.pending_buf[g.pending++]=255&g.bi_buf,g.bi_buf>>=8,g.bi_valid-=8)}function gen_bitlen(g,m){var f,S,v,C,_,E,T=m.dyn_tree,I=m.max_code,b=m.stat_desc.static_tree,A=m.stat_desc.has_stree,P=m.stat_desc.extra_bits,R=m.stat_desc.extra_base,w=m.stat_desc.max_length,M=0;for(C=0;C<=kl;C++)g.bl_count[C]=0;for(T[2*g.heap[g.heap_max]+1]=0,f=g.heap_max+1;f<Nl;f++)(C=T[2*T[2*(S=g.heap[f])+1]+1]+1)>w&&(C=w,M++),T[2*S+1]=C,S>I||(g.bl_count[C]++,_=0,S>=R&&(_=P[S-R]),E=T[2*S],g.opt_len+=E*(C+_),A&&(g.static_len+=E*(b[2*S+1]+_)));if(0!==M){do{for(C=w-1;0===g.bl_count[C];)C--;g.bl_count[C]--,g.bl_count[C+1]+=2,g.bl_count[w]--,M-=2}while(M>0);for(C=w;0!==C;C--)for(S=g.bl_count[C];0!==S;)(v=g.heap[--f])>I||(T[2*v+1]!==C&&(g.opt_len+=(C-T[2*v+1])*T[2*v],T[2*v+1]=C),S--)}}function gen_codes(g,m,f){var S,v,C=new Array(kl+1),_=0;for(S=1;S<=kl;S++)C[S]=_=_+f[S-1]<<1;for(v=0;v<=m;v++){var E=g[2*v+1];0!==E&&(g[2*v]=bi_reverse(C[E]++,E))}}function tr_static_init(){var g,m,f,S,v,C=new Array(kl+1);for(f=0,S=0;S<Rl-1;S++)for(Yl[S]=f,g=0;g<1<<Hl[S];g++)Jl[f++]=S;for(Jl[f-1]=S,v=0,S=0;S<16;S++)for(ec[S]=v,g=0;g<1<<$l[S];g++)Kl[v++]=S;for(v>>=7;S<Dl;S++)for(ec[S]=v<<7,g=0;g<1<<$l[S]-7;g++)Kl[256+v++]=S;for(m=0;m<=kl;m++)C[m]=0;for(g=0;g<=143;)ql[2*g+1]=8,g++,C[8]++;for(;g<=255;)ql[2*g+1]=9,g++,C[9]++;for(;g<=279;)ql[2*g+1]=7,g++,C[7]++;for(;g<=287;)ql[2*g+1]=8,g++,C[8]++;for(gen_codes(ql,Ml+1,C),g=0;g<Dl;g++)zl[2*g+1]=5,zl[2*g]=bi_reverse(g,5);Ql=new StaticTreeDesc(ql,Hl,wl+1,Ml,kl),Xl=new StaticTreeDesc(zl,$l,0,Dl,kl),Zl=new StaticTreeDesc(new Array(0),Gl,0,Ol,Fl)}function init_block(g){var m;for(m=0;m<Ml;m++)g.dyn_ltree[2*m]=0;for(m=0;m<Dl;m++)g.dyn_dtree[2*m]=0;for(m=0;m<Ol;m++)g.bl_tree[2*m]=0;g.dyn_ltree[2*xl]=1,g.opt_len=g.static_len=0,g.last_lit=g.matches=0}function bi_windup(g){g.bi_valid>8?put_short(g,g.bi_buf):g.bi_valid>0&&(g.pending_buf[g.pending++]=g.bi_buf),g.bi_buf=0,g.bi_valid=0}function copy_block(g,m,f,S){bi_windup(g),S&&(put_short(g,f),put_short(g,~f)),vl.arraySet(g.pending_buf,g.window,m,f,g.pending),g.pending+=f}function smaller(g,m,f,S){var v=2*m,C=2*f;return g[v]<g[C]||g[v]===g[C]&&S[m]<=S[f]}function pqdownheap(g,m,f){for(var S=g.heap[f],v=f<<1;v<=g.heap_len&&(v<g.heap_len&&smaller(m,g.heap[v+1],g.heap[v],g.depth)&&v++,!smaller(m,S,g.heap[v],g.depth));)g.heap[f]=g.heap[v],f=v,v<<=1;g.heap[f]=S}function compress_block(g,m,f){var S,v,C,_,E=0;if(0!==g.last_lit)do{S=g.pending_buf[g.d_buf+2*E]<<8|g.pending_buf[g.d_buf+2*E+1],v=g.pending_buf[g.l_buf+E],E++,0===S?send_code(g,v,m):(send_code(g,(C=Jl[v])+wl+1,m),0!==(_=Hl[C])&&send_bits(g,v-=Yl[C],_),send_code(g,C=d_code(--S),f),0!==(_=$l[C])&&send_bits(g,S-=ec[C],_))}while(E<g.last_lit);send_code(g,xl,m)}function build_tree(g,m){var f,S,v,C=m.dyn_tree,_=m.stat_desc.static_tree,E=m.stat_desc.has_stree,T=m.stat_desc.elems,I=-1;for(g.heap_len=0,g.heap_max=Nl,f=0;f<T;f++)0!==C[2*f]?(g.heap[++g.heap_len]=I=f,g.depth[f]=0):C[2*f+1]=0;for(;g.heap_len<2;)C[2*(v=g.heap[++g.heap_len]=I<2?++I:0)]=1,g.depth[v]=0,g.opt_len--,E&&(g.static_len-=_[2*v+1]);for(m.max_code=I,f=g.heap_len>>1;f>=1;f--)pqdownheap(g,C,f);v=T;do{f=g.heap[1],g.heap[1]=g.heap[g.heap_len--],pqdownheap(g,C,1),S=g.heap[1],g.heap[--g.heap_max]=f,g.heap[--g.heap_max]=S,C[2*v]=C[2*f]+C[2*S],g.depth[v]=(g.depth[f]>=g.depth[S]?g.depth[f]:g.depth[S])+1,C[2*f+1]=C[2*S+1]=v,g.heap[1]=v++,pqdownheap(g,C,1)}while(g.heap_len>=2);g.heap[--g.heap_max]=g.heap[1],gen_bitlen(g,m),gen_codes(C,I,g.bl_count)}function scan_tree(g,m,f){var S,v,C=-1,_=m[1],E=0,T=7,I=4;for(0===_&&(T=138,I=3),m[2*(f+1)+1]=65535,S=0;S<=f;S++)v=_,_=m[2*(S+1)+1],++E<T&&v===_||(E<I?g.bl_tree[2*v]+=E:0!==v?(v!==C&&g.bl_tree[2*v]++,g.bl_tree[2*Ul]++):E<=10?g.bl_tree[2*Vl]++:g.bl_tree[2*Bl]++,E=0,C=v,0===_?(T=138,I=3):v===_?(T=6,I=3):(T=7,I=4))}function send_tree(g,m,f){var S,v,C=-1,_=m[1],E=0,T=7,I=4;for(0===_&&(T=138,I=3),S=0;S<=f;S++)if(v=_,_=m[2*(S+1)+1],!(++E<T&&v===_)){if(E<I)do{send_code(g,v,g.bl_tree)}while(0!=--E);else 0!==v?(v!==C&&(send_code(g,v,g.bl_tree),E--),send_code(g,Ul,g.bl_tree),send_bits(g,E-3,2)):E<=10?(send_code(g,Vl,g.bl_tree),send_bits(g,E-3,3)):(send_code(g,Bl,g.bl_tree),send_bits(g,E-11,7));E=0,C=v,0===_?(T=138,I=3):v===_?(T=6,I=3):(T=7,I=4)}}function build_bl_tree(g){var m;for(scan_tree(g,g.dyn_ltree,g.l_desc.max_code),scan_tree(g,g.dyn_dtree,g.d_desc.max_code),build_tree(g,g.bl_desc),m=Ol-1;m>=3&&0===g.bl_tree[2*jl[m]+1];m--);return g.opt_len+=3*(m+1)+5+5+4,m}function send_all_trees(g,m,f,S){var v;for(send_bits(g,m-257,5),send_bits(g,f-1,5),send_bits(g,S-4,4),v=0;v<S;v++)send_bits(g,g.bl_tree[2*jl[v]+1],3);send_tree(g,g.dyn_ltree,m-1),send_tree(g,g.dyn_dtree,f-1)}function detect_data_type(g){var m,f=4093624447;for(m=0;m<=31;m++,f>>>=1)if(1&f&&0!==g.dyn_ltree[2*m])return Cl;if(0!==g.dyn_ltree[18]||0!==g.dyn_ltree[20]||0!==g.dyn_ltree[26])return _l;for(m=32;m<wl;m++)if(0!==g.dyn_ltree[2*m])return _l;return Cl}zero(ec);var tc=!1;function _tr_init(g){tc||(tr_static_init(),tc=!0),g.l_desc=new TreeDesc(g.dyn_ltree,Ql),g.d_desc=new TreeDesc(g.dyn_dtree,Xl),g.bl_desc=new TreeDesc(g.bl_tree,Zl),g.bi_buf=0,g.bi_valid=0,init_block(g)}function _tr_stored_block(g,m,f,S){send_bits(g,(Tl<<1)+(S?1:0),3),copy_block(g,m,f,!0)}function _tr_align(g){send_bits(g,Il<<1,3),send_code(g,xl,ql),bi_flush(g)}function _tr_flush_block(g,m,f,S){var v,C,_=0;g.level>0?(g.strm.data_type===El&&(g.strm.data_type=detect_data_type(g)),build_tree(g,g.l_desc),build_tree(g,g.d_desc),_=build_bl_tree(g),v=g.opt_len+3+7>>>3,(C=g.static_len+3+7>>>3)<=v&&(v=C)):v=C=f+5,f+4<=v&&-1!==m?_tr_stored_block(g,m,f,S):g.strategy===yl||C===v?(send_bits(g,(Il<<1)+(S?1:0),3),compress_block(g,ql,zl)):(send_bits(g,(bl<<1)+(S?1:0),3),send_all_trees(g,g.l_desc.max_code+1,g.d_desc.max_code+1,_+1),compress_block(g,g.dyn_ltree,g.dyn_dtree)),init_block(g),S&&bi_windup(g)}function _tr_tally(g,m,f){return g.pending_buf[g.d_buf+2*g.last_lit]=m>>>8&255,g.pending_buf[g.d_buf+2*g.last_lit+1]=255&m,g.pending_buf[g.l_buf+g.last_lit]=255&f,g.last_lit++,0===m?g.dyn_ltree[2*f]++:(g.matches++,m--,g.dyn_ltree[2*(Jl[f]+wl+1)]++,g.dyn_dtree[2*d_code(m)]++),g.last_lit===g.lit_bufsize-1}var ic={_tr_init:_tr_init,_tr_stored_block:_tr_stored_block,_tr_flush_block:_tr_flush_block,_tr_tally:_tr_tally,_tr_align:_tr_align};function adler32(g,m,f,S){for(var v=65535&g|0,C=g>>>16&65535|0,_=0;0!==f;){f-=_=f>2e3?2e3:f;do{C=C+(v=v+m[S++]|0)|0}while(--_);v%=65521,C%=65521}return v|C<<16|0}var nc=adler32;function makeTable(){for(var g,m=[],f=0;f<256;f++){g=f;for(var S=0;S<8;S++)g=1&g?3988292384^g>>>1:g>>>1;m[f]=g}return m}var rc=makeTable();function crc32(g,m,f,S){var v=rc,C=S+f;g^=-1;for(var _=S;_<C;_++)g=g>>>8^v[255&(g^m[_])];return-1^g}var sc,ac=crc32,oc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},lc=0,cc=1,dc=3,hc=4,uc=5,gc=0,pc=1,mc=-2,fc=-3,Sc=-5,vc=-1,yc=1,Cc=2,_c=3,Ec=4,Tc=0,Ic=2,bc=8,Ac=9,Pc=15,Rc=8,wc=256+1+29,Mc=30,Dc=19,Oc=2*wc+1,Nc=15,kc=3,Lc=258,Fc=Lc+kc+1,xc=32,Uc=42,Vc=69,Bc=73,Hc=91,$c=103,Gc=113,jc=666,Wc=1,qc=2,zc=3,Kc=4,Jc=3;function err(g,m){return g.msg=oc[m],m}function rank(g){return(g<<1)-(g>4?9:0)}function zero$1(g){for(var m=g.length;--m>=0;)g[m]=0}function flush_pending(g){var m=g.state,f=m.pending;f>g.avail_out&&(f=g.avail_out),0!==f&&(vl.arraySet(g.output,m.pending_buf,m.pending_out,f,g.next_out),g.next_out+=f,m.pending_out+=f,g.total_out+=f,g.avail_out-=f,m.pending-=f,0===m.pending&&(m.pending_out=0))}function flush_block_only(g,m){ic._tr_flush_block(g,g.block_start>=0?g.block_start:-1,g.strstart-g.block_start,m),g.block_start=g.strstart,flush_pending(g.strm)}function put_byte(g,m){g.pending_buf[g.pending++]=m}function putShortMSB(g,m){g.pending_buf[g.pending++]=m>>>8&255,g.pending_buf[g.pending++]=255&m}function read_buf(g,m,f,S){var v=g.avail_in;return v>S&&(v=S),0===v?0:(g.avail_in-=v,vl.arraySet(m,g.input,g.next_in,v,f),1===g.state.wrap?g.adler=nc(g.adler,m,v,f):2===g.state.wrap&&(g.adler=ac(g.adler,m,v,f)),g.next_in+=v,g.total_in+=v,v)}function longest_match(g,m){var f,S,v=g.max_chain_length,C=g.strstart,_=g.prev_length,E=g.nice_match,T=g.strstart>g.w_size-Fc?g.strstart-(g.w_size-Fc):0,I=g.window,b=g.w_mask,A=g.prev,P=g.strstart+Lc,R=I[C+_-1],w=I[C+_];g.prev_length>=g.good_match&&(v>>=2),E>g.lookahead&&(E=g.lookahead);do{if(I[(f=m)+_]===w&&I[f+_-1]===R&&I[f]===I[C]&&I[++f]===I[C+1]){C+=2,f++;do{}while(I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&I[++C]===I[++f]&&C<P);if(S=Lc-(P-C),C=P-Lc,S>_){if(g.match_start=m,_=S,S>=E)break;R=I[C+_-1],w=I[C+_]}}}while((m=A[m&b])>T&&0!=--v);return _<=g.lookahead?_:g.lookahead}function fill_window(g){var m,f,S,v,C,_=g.w_size;do{if(v=g.window_size-g.lookahead-g.strstart,g.strstart>=_+(_-Fc)){vl.arraySet(g.window,g.window,_,_,0),g.match_start-=_,g.strstart-=_,g.block_start-=_,m=f=g.hash_size;do{S=g.head[--m],g.head[m]=S>=_?S-_:0}while(--f);m=f=_;do{S=g.prev[--m],g.prev[m]=S>=_?S-_:0}while(--f);v+=_}if(0===g.strm.avail_in)break;if(f=read_buf(g.strm,g.window,g.strstart+g.lookahead,v),g.lookahead+=f,g.lookahead+g.insert>=kc)for(C=g.strstart-g.insert,g.ins_h=g.window[C],g.ins_h=(g.ins_h<<g.hash_shift^g.window[C+1])&g.hash_mask;g.insert&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[C+kc-1])&g.hash_mask,g.prev[C&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=C,C++,g.insert--,!(g.lookahead+g.insert<kc)););}while(g.lookahead<Fc&&0!==g.strm.avail_in)}function deflate_stored(g,m){var f=65535;for(f>g.pending_buf_size-5&&(f=g.pending_buf_size-5);;){if(g.lookahead<=1){if(fill_window(g),0===g.lookahead&&m===lc)return Wc;if(0===g.lookahead)break}g.strstart+=g.lookahead,g.lookahead=0;var S=g.block_start+f;if((0===g.strstart||g.strstart>=S)&&(g.lookahead=g.strstart-S,g.strstart=S,flush_block_only(g,!1),0===g.strm.avail_out))return Wc;if(g.strstart-g.block_start>=g.w_size-Fc&&(flush_block_only(g,!1),0===g.strm.avail_out))return Wc}return g.insert=0,m===hc?(flush_block_only(g,!0),0===g.strm.avail_out?zc:Kc):(g.strstart>g.block_start&&(flush_block_only(g,!1),g.strm.avail_out),Wc)}function deflate_fast(g,m){for(var f,S;;){if(g.lookahead<Fc){if(fill_window(g),g.lookahead<Fc&&m===lc)return Wc;if(0===g.lookahead)break}if(f=0,g.lookahead>=kc&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+kc-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),0!==f&&g.strstart-f<=g.w_size-Fc&&(g.match_length=longest_match(g,f)),g.match_length>=kc)if(S=ic._tr_tally(g,g.strstart-g.match_start,g.match_length-kc),g.lookahead-=g.match_length,g.match_length<=g.max_lazy_match&&g.lookahead>=kc){g.match_length--;do{g.strstart++,g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+kc-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart}while(0!=--g.match_length);g.strstart++}else g.strstart+=g.match_length,g.match_length=0,g.ins_h=g.window[g.strstart],g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+1])&g.hash_mask;else S=ic._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++;if(S&&(flush_block_only(g,!1),0===g.strm.avail_out))return Wc}return g.insert=g.strstart<kc-1?g.strstart:kc-1,m===hc?(flush_block_only(g,!0),0===g.strm.avail_out?zc:Kc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?Wc:qc}function deflate_slow(g,m){for(var f,S,v;;){if(g.lookahead<Fc){if(fill_window(g),g.lookahead<Fc&&m===lc)return Wc;if(0===g.lookahead)break}if(f=0,g.lookahead>=kc&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+kc-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart),g.prev_length=g.match_length,g.prev_match=g.match_start,g.match_length=kc-1,0!==f&&g.prev_length<g.max_lazy_match&&g.strstart-f<=g.w_size-Fc&&(g.match_length=longest_match(g,f),g.match_length<=5&&(g.strategy===yc||g.match_length===kc&&g.strstart-g.match_start>4096)&&(g.match_length=kc-1)),g.prev_length>=kc&&g.match_length<=g.prev_length){v=g.strstart+g.lookahead-kc,S=ic._tr_tally(g,g.strstart-1-g.prev_match,g.prev_length-kc),g.lookahead-=g.prev_length-1,g.prev_length-=2;do{++g.strstart<=v&&(g.ins_h=(g.ins_h<<g.hash_shift^g.window[g.strstart+kc-1])&g.hash_mask,f=g.prev[g.strstart&g.w_mask]=g.head[g.ins_h],g.head[g.ins_h]=g.strstart)}while(0!=--g.prev_length);if(g.match_available=0,g.match_length=kc-1,g.strstart++,S&&(flush_block_only(g,!1),0===g.strm.avail_out))return Wc}else if(g.match_available){if((S=ic._tr_tally(g,0,g.window[g.strstart-1]))&&flush_block_only(g,!1),g.strstart++,g.lookahead--,0===g.strm.avail_out)return Wc}else g.match_available=1,g.strstart++,g.lookahead--}return g.match_available&&(S=ic._tr_tally(g,0,g.window[g.strstart-1]),g.match_available=0),g.insert=g.strstart<kc-1?g.strstart:kc-1,m===hc?(flush_block_only(g,!0),0===g.strm.avail_out?zc:Kc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?Wc:qc}function deflate_rle(g,m){for(var f,S,v,C,_=g.window;;){if(g.lookahead<=Lc){if(fill_window(g),g.lookahead<=Lc&&m===lc)return Wc;if(0===g.lookahead)break}if(g.match_length=0,g.lookahead>=kc&&g.strstart>0&&(S=_[v=g.strstart-1])===_[++v]&&S===_[++v]&&S===_[++v]){C=g.strstart+Lc;do{}while(S===_[++v]&&S===_[++v]&&S===_[++v]&&S===_[++v]&&S===_[++v]&&S===_[++v]&&S===_[++v]&&S===_[++v]&&v<C);g.match_length=Lc-(C-v),g.match_length>g.lookahead&&(g.match_length=g.lookahead)}if(g.match_length>=kc?(f=ic._tr_tally(g,1,g.match_length-kc),g.lookahead-=g.match_length,g.strstart+=g.match_length,g.match_length=0):(f=ic._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++),f&&(flush_block_only(g,!1),0===g.strm.avail_out))return Wc}return g.insert=0,m===hc?(flush_block_only(g,!0),0===g.strm.avail_out?zc:Kc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?Wc:qc}function deflate_huff(g,m){for(var f;;){if(0===g.lookahead&&(fill_window(g),0===g.lookahead)){if(m===lc)return Wc;break}if(g.match_length=0,f=ic._tr_tally(g,0,g.window[g.strstart]),g.lookahead--,g.strstart++,f&&(flush_block_only(g,!1),0===g.strm.avail_out))return Wc}return g.insert=0,m===hc?(flush_block_only(g,!0),0===g.strm.avail_out?zc:Kc):g.last_lit&&(flush_block_only(g,!1),0===g.strm.avail_out)?Wc:qc}function Config(g,m,f,S,v){this.good_length=g,this.max_lazy=m,this.nice_length=f,this.max_chain=S,this.func=v}function lm_init(g){g.window_size=2*g.w_size,zero$1(g.head),g.max_lazy_match=sc[g.level].max_lazy,g.good_match=sc[g.level].good_length,g.nice_match=sc[g.level].nice_length,g.max_chain_length=sc[g.level].max_chain,g.strstart=0,g.block_start=0,g.lookahead=0,g.insert=0,g.match_length=g.prev_length=kc-1,g.match_available=0,g.ins_h=0}function DeflateState(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=bc,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new vl.Buf16(2*Oc),this.dyn_dtree=new vl.Buf16(2*(2*Mc+1)),this.bl_tree=new vl.Buf16(2*(2*Dc+1)),zero$1(this.dyn_ltree),zero$1(this.dyn_dtree),zero$1(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new vl.Buf16(Nc+1),this.heap=new vl.Buf16(2*wc+1),zero$1(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new vl.Buf16(2*wc+1),zero$1(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}function deflateResetKeep(g){var m;return g&&g.state?(g.total_in=g.total_out=0,g.data_type=Ic,(m=g.state).pending=0,m.pending_out=0,m.wrap<0&&(m.wrap=-m.wrap),m.status=m.wrap?Uc:Gc,g.adler=2===m.wrap?0:1,m.last_flush=lc,ic._tr_init(m),gc):err(g,mc)}function deflateReset(g){var m=deflateResetKeep(g);return m===gc&&lm_init(g.state),m}function deflateSetHeader(g,m){return g&&g.state?2!==g.state.wrap?mc:(g.state.gzhead=m,gc):mc}function deflateInit2(g,m,f,S,v,C){if(!g)return mc;var _=1;if(m===vc&&(m=6),S<0?(_=0,S=-S):S>15&&(_=2,S-=16),v<1||v>Ac||f!==bc||S<8||S>15||m<0||m>9||C<0||C>Ec)return err(g,mc);8===S&&(S=9);var E=new DeflateState;return g.state=E,E.strm=g,E.wrap=_,E.gzhead=null,E.w_bits=S,E.w_size=1<<E.w_bits,E.w_mask=E.w_size-1,E.hash_bits=v+7,E.hash_size=1<<E.hash_bits,E.hash_mask=E.hash_size-1,E.hash_shift=~~((E.hash_bits+kc-1)/kc),E.window=new vl.Buf8(2*E.w_size),E.head=new vl.Buf16(E.hash_size),E.prev=new vl.Buf16(E.w_size),E.lit_bufsize=1<<v+6,E.pending_buf_size=4*E.lit_bufsize,E.pending_buf=new vl.Buf8(E.pending_buf_size),E.d_buf=E.lit_bufsize>>1,E.l_buf=3*E.lit_bufsize,E.level=m,E.strategy=C,E.method=f,deflateReset(g)}function deflateInit(g,m){return deflateInit2(g,m,bc,Pc,Rc,Tc)}function deflate(g,m){var f,S,v,C;if(!g||!g.state||m>uc||m<0)return g?err(g,mc):mc;if(S=g.state,!g.output||!g.input&&0!==g.avail_in||S.status===jc&&m!==hc)return err(g,0===g.avail_out?Sc:mc);if(S.strm=g,f=S.last_flush,S.last_flush=m,S.status===Uc)if(2===S.wrap)g.adler=0,put_byte(S,31),put_byte(S,139),put_byte(S,8),S.gzhead?(put_byte(S,(S.gzhead.text?1:0)+(S.gzhead.hcrc?2:0)+(S.gzhead.extra?4:0)+(S.gzhead.name?8:0)+(S.gzhead.comment?16:0)),put_byte(S,255&S.gzhead.time),put_byte(S,S.gzhead.time>>8&255),put_byte(S,S.gzhead.time>>16&255),put_byte(S,S.gzhead.time>>24&255),put_byte(S,9===S.level?2:S.strategy>=Cc||S.level<2?4:0),put_byte(S,255&S.gzhead.os),S.gzhead.extra&&S.gzhead.extra.length&&(put_byte(S,255&S.gzhead.extra.length),put_byte(S,S.gzhead.extra.length>>8&255)),S.gzhead.hcrc&&(g.adler=ac(g.adler,S.pending_buf,S.pending,0)),S.gzindex=0,S.status=Vc):(put_byte(S,0),put_byte(S,0),put_byte(S,0),put_byte(S,0),put_byte(S,0),put_byte(S,9===S.level?2:S.strategy>=Cc||S.level<2?4:0),put_byte(S,Jc),S.status=Gc);else{var _=bc+(S.w_bits-8<<4)<<8;_|=(S.strategy>=Cc||S.level<2?0:S.level<6?1:6===S.level?2:3)<<6,0!==S.strstart&&(_|=xc),_+=31-_%31,S.status=Gc,putShortMSB(S,_),0!==S.strstart&&(putShortMSB(S,g.adler>>>16),putShortMSB(S,65535&g.adler)),g.adler=1}if(S.status===Vc)if(S.gzhead.extra){for(v=S.pending;S.gzindex<(65535&S.gzhead.extra.length)&&(S.pending!==S.pending_buf_size||(S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),flush_pending(g),v=S.pending,S.pending!==S.pending_buf_size));)put_byte(S,255&S.gzhead.extra[S.gzindex]),S.gzindex++;S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),S.gzindex===S.gzhead.extra.length&&(S.gzindex=0,S.status=Bc)}else S.status=Bc;if(S.status===Bc)if(S.gzhead.name){v=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),flush_pending(g),v=S.pending,S.pending===S.pending_buf_size)){C=1;break}C=S.gzindex<S.gzhead.name.length?255&S.gzhead.name.charCodeAt(S.gzindex++):0,put_byte(S,C)}while(0!==C);S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),0===C&&(S.gzindex=0,S.status=Hc)}else S.status=Hc;if(S.status===Hc)if(S.gzhead.comment){v=S.pending;do{if(S.pending===S.pending_buf_size&&(S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),flush_pending(g),v=S.pending,S.pending===S.pending_buf_size)){C=1;break}C=S.gzindex<S.gzhead.comment.length?255&S.gzhead.comment.charCodeAt(S.gzindex++):0,put_byte(S,C)}while(0!==C);S.gzhead.hcrc&&S.pending>v&&(g.adler=ac(g.adler,S.pending_buf,S.pending-v,v)),0===C&&(S.status=$c)}else S.status=$c;if(S.status===$c&&(S.gzhead.hcrc?(S.pending+2>S.pending_buf_size&&flush_pending(g),S.pending+2<=S.pending_buf_size&&(put_byte(S,255&g.adler),put_byte(S,g.adler>>8&255),g.adler=0,S.status=Gc)):S.status=Gc),0!==S.pending){if(flush_pending(g),0===g.avail_out)return S.last_flush=-1,gc}else if(0===g.avail_in&&rank(m)<=rank(f)&&m!==hc)return err(g,Sc);if(S.status===jc&&0!==g.avail_in)return err(g,Sc);if(0!==g.avail_in||0!==S.lookahead||m!==lc&&S.status!==jc){var E=S.strategy===Cc?deflate_huff(S,m):S.strategy===_c?deflate_rle(S,m):sc[S.level].func(S,m);if(E!==zc&&E!==Kc||(S.status=jc),E===Wc||E===zc)return 0===g.avail_out&&(S.last_flush=-1),gc;if(E===qc&&(m===cc?ic._tr_align(S):m!==uc&&(ic._tr_stored_block(S,0,0,!1),m===dc&&(zero$1(S.head),0===S.lookahead&&(S.strstart=0,S.block_start=0,S.insert=0))),flush_pending(g),0===g.avail_out))return S.last_flush=-1,gc}return m!==hc?gc:S.wrap<=0?pc:(2===S.wrap?(put_byte(S,255&g.adler),put_byte(S,g.adler>>8&255),put_byte(S,g.adler>>16&255),put_byte(S,g.adler>>24&255),put_byte(S,255&g.total_in),put_byte(S,g.total_in>>8&255),put_byte(S,g.total_in>>16&255),put_byte(S,g.total_in>>24&255)):(putShortMSB(S,g.adler>>>16),putShortMSB(S,65535&g.adler)),flush_pending(g),S.wrap>0&&(S.wrap=-S.wrap),0!==S.pending?gc:pc)}function deflateEnd(g){var m;return g&&g.state?(m=g.state.status)!==Uc&&m!==Vc&&m!==Bc&&m!==Hc&&m!==$c&&m!==Gc&&m!==jc?err(g,mc):(g.state=null,m===Gc?err(g,fc):gc):mc}function deflateSetDictionary(g,m){var f,S,v,C,_,E,T,I,b=m.length;if(!g||!g.state)return mc;if(2===(C=(f=g.state).wrap)||1===C&&f.status!==Uc||f.lookahead)return mc;for(1===C&&(g.adler=nc(g.adler,m,b,0)),f.wrap=0,b>=f.w_size&&(0===C&&(zero$1(f.head),f.strstart=0,f.block_start=0,f.insert=0),I=new vl.Buf8(f.w_size),vl.arraySet(I,m,b-f.w_size,f.w_size,0),m=I,b=f.w_size),_=g.avail_in,E=g.next_in,T=g.input,g.avail_in=b,g.next_in=0,g.input=m,fill_window(f);f.lookahead>=kc;){S=f.strstart,v=f.lookahead-(kc-1);do{f.ins_h=(f.ins_h<<f.hash_shift^f.window[S+kc-1])&f.hash_mask,f.prev[S&f.w_mask]=f.head[f.ins_h],f.head[f.ins_h]=S,S++}while(--v);f.strstart=S,f.lookahead=kc-1,fill_window(f)}return f.strstart+=f.lookahead,f.block_start=f.strstart,f.insert=f.lookahead,f.lookahead=0,f.match_length=f.prev_length=kc-1,f.match_available=0,g.next_in=E,g.input=T,g.avail_in=_,f.wrap=C,gc}sc=[new Config(0,0,0,0,deflate_stored),new Config(4,4,8,4,deflate_fast),new Config(4,5,16,8,deflate_fast),new Config(4,6,32,32,deflate_fast),new Config(4,4,16,16,deflate_slow),new Config(8,16,32,32,deflate_slow),new Config(8,16,128,128,deflate_slow),new Config(8,32,128,256,deflate_slow),new Config(32,128,258,1024,deflate_slow),new Config(32,258,258,4096,deflate_slow)];var Yc={deflateInit:deflateInit,deflateInit2:deflateInit2,deflateReset:deflateReset,deflateResetKeep:deflateResetKeep,deflateSetHeader:deflateSetHeader,deflate:deflate,deflateEnd:deflateEnd,deflateSetDictionary:deflateSetDictionary,deflateInfo:"pako deflate (from Nodeca project)"},Qc=!0,Xc=!0;try{String.fromCharCode.apply(null,[0])}catch(g){Qc=!1}try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(g){Xc=!1}for(var Zc=new vl.Buf8(256),ed=0;ed<256;ed++)Zc[ed]=ed>=252?6:ed>=248?5:ed>=240?4:ed>=224?3:ed>=192?2:1;Zc[254]=Zc[254]=1;var string2buf=function(g){var m,f,S,v,C,_=g.length,E=0;for(v=0;v<_;v++)55296==(64512&(f=g.charCodeAt(v)))&&v+1<_&&56320==(64512&(S=g.charCodeAt(v+1)))&&(f=65536+(f-55296<<10)+(S-56320),v++),E+=f<128?1:f<2048?2:f<65536?3:4;for(m=new vl.Buf8(E),C=0,v=0;C<E;v++)55296==(64512&(f=g.charCodeAt(v)))&&v+1<_&&56320==(64512&(S=g.charCodeAt(v+1)))&&(f=65536+(f-55296<<10)+(S-56320),v++),f<128?m[C++]=f:f<2048?(m[C++]=192|f>>>6,m[C++]=128|63&f):f<65536?(m[C++]=224|f>>>12,m[C++]=128|f>>>6&63,m[C++]=128|63&f):(m[C++]=240|f>>>18,m[C++]=128|f>>>12&63,m[C++]=128|f>>>6&63,m[C++]=128|63&f);return m};function buf2binstring(g,m){if(m<65537&&(g.subarray&&Xc||!g.subarray&&Qc))return String.fromCharCode.apply(null,vl.shrinkBuf(g,m));for(var f="",S=0;S<m;S++)f+=String.fromCharCode(g[S]);return f}var binstring2buf=function(g){for(var m=new vl.Buf8(g.length),f=0,S=m.length;f<S;f++)m[f]=g.charCodeAt(f);return m},buf2string=function(g,m){var f,S,v,C,_=m||g.length,E=new Array(2*_);for(S=0,f=0;f<_;)if((v=g[f++])<128)E[S++]=v;else if((C=Zc[v])>4)E[S++]=65533,f+=C-1;else{for(v&=2===C?31:3===C?15:7;C>1&&f<_;)v=v<<6|63&g[f++],C--;C>1?E[S++]=65533:v<65536?E[S++]=v:(v-=65536,E[S++]=55296|v>>10&1023,E[S++]=56320|1023&v)}return buf2binstring(E,S)},td={string2buf:string2buf,buf2binstring:function(g){return buf2binstring(g,g.length)},binstring2buf:binstring2buf,buf2string:buf2string,utf8border:function(g,m){var f;for((m=m||g.length)>g.length&&(m=g.length),f=m-1;f>=0&&128==(192&g[f]);)f--;return f<0||0===f?m:f+Zc[g[f]]>m?f:m}};function ZStream(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var id=ZStream,nd=Object.prototype.toString,rd=0,sd=4,ad=0,od=1,ld=2,cd=-1,dd=0,hd=8;function Deflate(g){if(!(this instanceof Deflate))return new Deflate(g);this.options=vl.assign({level:cd,method:hd,chunkSize:16384,windowBits:15,memLevel:8,strategy:dd,to:""},g||{});var m=this.options;m.raw&&m.windowBits>0?m.windowBits=-m.windowBits:m.gzip&&m.windowBits>0&&m.windowBits<16&&(m.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new id,this.strm.avail_out=0;var f=Yc.deflateInit2(this.strm,m.level,m.method,m.windowBits,m.memLevel,m.strategy);if(f!==ad)throw new Error(oc[f]);if(m.header&&Yc.deflateSetHeader(this.strm,m.header),m.dictionary){var S;if(S="string"==typeof m.dictionary?td.string2buf(m.dictionary):"[object ArrayBuffer]"===nd.call(m.dictionary)?new Uint8Array(m.dictionary):m.dictionary,(f=Yc.deflateSetDictionary(this.strm,S))!==ad)throw new Error(oc[f]);this._dict_set=!0}}function deflate$1(g,m){var f=new Deflate(m);if(f.push(g,!0),f.err)throw f.msg;return f.result}function deflateRaw(g,m){return(m=m||{}).raw=!0,deflate$1(g,m)}function gzip(g,m){return(m=m||{}).gzip=!0,deflate$1(g,m)}Deflate.prototype.push=function(g,m){var f,S,v=this.strm,C=this.options.chunkSize;if(this.ended)return!1;S=m===~~m?m:!0===m?sd:rd,"string"==typeof g?v.input=td.string2buf(g):"[object ArrayBuffer]"===nd.call(g)?v.input=new Uint8Array(g):v.input=g,v.next_in=0,v.avail_in=v.input.length;do{if(0===v.avail_out&&(v.output=new vl.Buf8(C),v.next_out=0,v.avail_out=C),(f=Yc.deflate(v,S))!==od&&f!==ad)return this.onEnd(f),this.ended=!0,!1;0!==v.avail_out&&(0!==v.avail_in||S!==sd&&S!==ld)||("string"===this.options.to?this.onData(td.buf2binstring(vl.shrinkBuf(v.output,v.next_out))):this.onData(vl.shrinkBuf(v.output,v.next_out)))}while((v.avail_in>0||0===v.avail_out)&&f!==od);return S===sd?(f=Yc.deflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===ad):S!==ld||(this.onEnd(ad),v.avail_out=0,!0)},Deflate.prototype.onData=function(g){this.chunks.push(g)},Deflate.prototype.onEnd=function(g){g===ad&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=vl.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg};var ud={Deflate:Deflate,deflate:deflate$1,deflateRaw:deflateRaw,gzip:gzip},gd=30,pd=12,md=function inflate_fast(g,m){var f,S,v,C,_,E,T,I,b,A,P,R,w,M,D,O,N,k,L,F,x,U,V,B,H;f=g.state,S=g.next_in,B=g.input,v=S+(g.avail_in-5),C=g.next_out,H=g.output,_=C-(m-g.avail_out),E=C+(g.avail_out-257),T=f.dmax,I=f.wsize,b=f.whave,A=f.wnext,P=f.window,R=f.hold,w=f.bits,M=f.lencode,D=f.distcode,O=(1<<f.lenbits)-1,N=(1<<f.distbits)-1;e:do{w<15&&(R+=B[S++]<<w,w+=8,R+=B[S++]<<w,w+=8),k=M[R&O];t:for(;;){if(R>>>=L=k>>>24,w-=L,0===(L=k>>>16&255))H[C++]=65535&k;else{if(!(16&L)){if(0==(64&L)){k=M[(65535&k)+(R&(1<<L)-1)];continue t}if(32&L){f.mode=pd;break e}g.msg="invalid literal/length code",f.mode=gd;break e}F=65535&k,(L&=15)&&(w<L&&(R+=B[S++]<<w,w+=8),F+=R&(1<<L)-1,R>>>=L,w-=L),w<15&&(R+=B[S++]<<w,w+=8,R+=B[S++]<<w,w+=8),k=D[R&N];i:for(;;){if(R>>>=L=k>>>24,w-=L,!(16&(L=k>>>16&255))){if(0==(64&L)){k=D[(65535&k)+(R&(1<<L)-1)];continue i}g.msg="invalid distance code",f.mode=gd;break e}if(x=65535&k,w<(L&=15)&&(R+=B[S++]<<w,(w+=8)<L&&(R+=B[S++]<<w,w+=8)),(x+=R&(1<<L)-1)>T){g.msg="invalid distance too far back",f.mode=gd;break e}if(R>>>=L,w-=L,x>(L=C-_)){if((L=x-L)>b&&f.sane){g.msg="invalid distance too far back",f.mode=gd;break e}if(U=0,V=P,0===A){if(U+=I-L,L<F){F-=L;do{H[C++]=P[U++]}while(--L);U=C-x,V=H}}else if(A<L){if(U+=I+A-L,(L-=A)<F){F-=L;do{H[C++]=P[U++]}while(--L);if(U=0,A<F){F-=L=A;do{H[C++]=P[U++]}while(--L);U=C-x,V=H}}}else if(U+=A-L,L<F){F-=L;do{H[C++]=P[U++]}while(--L);U=C-x,V=H}for(;F>2;)H[C++]=V[U++],H[C++]=V[U++],H[C++]=V[U++],F-=3;F&&(H[C++]=V[U++],F>1&&(H[C++]=V[U++]))}else{U=C-x;do{H[C++]=H[U++],H[C++]=H[U++],H[C++]=H[U++],F-=3}while(F>2);F&&(H[C++]=H[U++],F>1&&(H[C++]=H[U++]))}break}}break}}while(S<v&&C<E);S-=F=w>>3,R&=(1<<(w-=F<<3))-1,g.next_in=S,g.next_out=C,g.avail_in=S<v?v-S+5:5-(S-v),g.avail_out=C<E?E-C+257:257-(C-E),f.hold=R,f.bits=w},fd=15,Sd=852,vd=592,yd=0,Cd=1,_d=2,Ed=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],Td=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],Id=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],bd=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64],Ad=function inflate_table(g,m,f,S,v,C,_,E){var T,I,b,A,P,R,w,M,D,O=E.bits,N=0,k=0,L=0,F=0,x=0,U=0,V=0,B=0,H=0,$=0,G=null,j=0,W=new vl.Buf16(fd+1),q=new vl.Buf16(fd+1),z=null,K=0;for(N=0;N<=fd;N++)W[N]=0;for(k=0;k<S;k++)W[m[f+k]]++;for(x=O,F=fd;F>=1&&0===W[F];F--);if(x>F&&(x=F),0===F)return v[C++]=20971520,v[C++]=20971520,E.bits=1,0;for(L=1;L<F&&0===W[L];L++);for(x<L&&(x=L),B=1,N=1;N<=fd;N++)if(B<<=1,(B-=W[N])<0)return-1;if(B>0&&(g===yd||1!==F))return-1;for(q[1]=0,N=1;N<fd;N++)q[N+1]=q[N]+W[N];for(k=0;k<S;k++)0!==m[f+k]&&(_[q[m[f+k]]++]=k);if(g===yd?(G=z=_,R=19):g===Cd?(G=Ed,j-=257,z=Td,K-=257,R=256):(G=Id,z=bd,R=-1),$=0,k=0,N=L,P=C,U=x,V=0,b=-1,A=(H=1<<x)-1,g===Cd&&H>Sd||g===_d&&H>vd)return 1;for(;;){w=N-V,_[k]<R?(M=0,D=_[k]):_[k]>R?(M=z[K+_[k]],D=G[j+_[k]]):(M=96,D=0),T=1<<N-V,L=I=1<<U;do{v[P+($>>V)+(I-=T)]=w<<24|M<<16|D|0}while(0!==I);for(T=1<<N-1;$&T;)T>>=1;if(0!==T?($&=T-1,$+=T):$=0,k++,0==--W[N]){if(N===F)break;N=m[f+_[k]]}if(N>x&&($&A)!==b){for(0===V&&(V=x),P+=L,B=1<<(U=N-V);U+V<F&&!((B-=W[U+V])<=0);)U++,B<<=1;if(H+=1<<U,g===Cd&&H>Sd||g===_d&&H>vd)return 1;v[b=$&A]=x<<24|U<<16|P-C|0}}return 0!==$&&(v[P+$]=N-V<<24|64<<16|0),E.bits=x,0},Pd=0,Rd=1,wd=2,Md=4,Dd=5,Od=6,Nd=0,kd=1,Ld=2,Fd=-2,xd=-3,Ud=-4,Vd=-5,Bd=8,Hd=1,$d=2,Gd=3,jd=4,Wd=5,qd=6,zd=7,Kd=8,Jd=9,Yd=10,Qd=11,Xd=12,Zd=13,eh=14,th=15,ih=16,nh=17,rh=18,sh=19,ah=20,oh=21,lh=22,ch=23,dh=24,hh=25,uh=26,gh=27,ph=28,mh=29,fh=30,Sh=31,vh=852,yh=592,Ch=15;function zswap32(g){return(g>>>24&255)+(g>>>8&65280)+((65280&g)<<8)+((255&g)<<24)}function InflateState(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new vl.Buf16(320),this.work=new vl.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}function inflateResetKeep(g){var m;return g&&g.state?(m=g.state,g.total_in=g.total_out=m.total=0,g.msg="",m.wrap&&(g.adler=1&m.wrap),m.mode=Hd,m.last=0,m.havedict=0,m.dmax=32768,m.head=null,m.hold=0,m.bits=0,m.lencode=m.lendyn=new vl.Buf32(vh),m.distcode=m.distdyn=new vl.Buf32(yh),m.sane=1,m.back=-1,Nd):Fd}function inflateReset(g){var m;return g&&g.state?((m=g.state).wsize=0,m.whave=0,m.wnext=0,inflateResetKeep(g)):Fd}function inflateReset2(g,m){var f,S;return g&&g.state?(S=g.state,m<0?(f=0,m=-m):(f=1+(m>>4),m<48&&(m&=15)),m&&(m<8||m>15)?Fd:(null!==S.window&&S.wbits!==m&&(S.window=null),S.wrap=f,S.wbits=m,inflateReset(g))):Fd}function inflateInit2(g,m){var f,S;return g?(S=new InflateState,g.state=S,S.window=null,(f=inflateReset2(g,m))!==Nd&&(g.state=null),f):Fd}function inflateInit(g){return inflateInit2(g,Ch)}var _h,Eh,Th=!0;function fixedtables(g){if(Th){var m;for(_h=new vl.Buf32(512),Eh=new vl.Buf32(32),m=0;m<144;)g.lens[m++]=8;for(;m<256;)g.lens[m++]=9;for(;m<280;)g.lens[m++]=7;for(;m<288;)g.lens[m++]=8;for(Ad(Rd,g.lens,0,288,_h,0,g.work,{bits:9}),m=0;m<32;)g.lens[m++]=5;Ad(wd,g.lens,0,32,Eh,0,g.work,{bits:5}),Th=!1}g.lencode=_h,g.lenbits=9,g.distcode=Eh,g.distbits=5}function updatewindow(g,m,f,S){var v,C=g.state;return null===C.window&&(C.wsize=1<<C.wbits,C.wnext=0,C.whave=0,C.window=new vl.Buf8(C.wsize)),S>=C.wsize?(vl.arraySet(C.window,m,f-C.wsize,C.wsize,0),C.wnext=0,C.whave=C.wsize):((v=C.wsize-C.wnext)>S&&(v=S),vl.arraySet(C.window,m,f-S,v,C.wnext),(S-=v)?(vl.arraySet(C.window,m,f-S,S,0),C.wnext=S,C.whave=C.wsize):(C.wnext+=v,C.wnext===C.wsize&&(C.wnext=0),C.whave<C.wsize&&(C.whave+=v))),0}function inflate(g,m){var f,S,v,C,_,E,T,I,b,A,P,R,w,M,D,O,N,k,L,F,x,U,V,B,H=0,$=new vl.Buf8(4),G=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!g||!g.state||!g.output||!g.input&&0!==g.avail_in)return Fd;(f=g.state).mode===Xd&&(f.mode=Zd),_=g.next_out,v=g.output,T=g.avail_out,C=g.next_in,S=g.input,E=g.avail_in,I=f.hold,b=f.bits,A=E,P=T,U=Nd;e:for(;;)switch(f.mode){case Hd:if(0===f.wrap){f.mode=Zd;break}for(;b<16;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(2&f.wrap&&35615===I){f.check=0,$[0]=255&I,$[1]=I>>>8&255,f.check=ac(f.check,$,2,0),I=0,b=0,f.mode=$d;break}if(f.flags=0,f.head&&(f.head.done=!1),!(1&f.wrap)||(((255&I)<<8)+(I>>8))%31){g.msg="incorrect header check",f.mode=fh;break}if((15&I)!==Bd){g.msg="unknown compression method",f.mode=fh;break}if(b-=4,x=8+(15&(I>>>=4)),0===f.wbits)f.wbits=x;else if(x>f.wbits){g.msg="invalid window size",f.mode=fh;break}f.dmax=1<<x,g.adler=f.check=1,f.mode=512&I?Yd:Xd,I=0,b=0;break;case $d:for(;b<16;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(f.flags=I,(255&f.flags)!==Bd){g.msg="unknown compression method",f.mode=fh;break}if(57344&f.flags){g.msg="unknown header flags set",f.mode=fh;break}f.head&&(f.head.text=I>>8&1),512&f.flags&&($[0]=255&I,$[1]=I>>>8&255,f.check=ac(f.check,$,2,0)),I=0,b=0,f.mode=Gd;case Gd:for(;b<32;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.head&&(f.head.time=I),512&f.flags&&($[0]=255&I,$[1]=I>>>8&255,$[2]=I>>>16&255,$[3]=I>>>24&255,f.check=ac(f.check,$,4,0)),I=0,b=0,f.mode=jd;case jd:for(;b<16;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.head&&(f.head.xflags=255&I,f.head.os=I>>8),512&f.flags&&($[0]=255&I,$[1]=I>>>8&255,f.check=ac(f.check,$,2,0)),I=0,b=0,f.mode=Wd;case Wd:if(1024&f.flags){for(;b<16;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.length=I,f.head&&(f.head.extra_len=I),512&f.flags&&($[0]=255&I,$[1]=I>>>8&255,f.check=ac(f.check,$,2,0)),I=0,b=0}else f.head&&(f.head.extra=null);f.mode=qd;case qd:if(1024&f.flags&&((R=f.length)>E&&(R=E),R&&(f.head&&(x=f.head.extra_len-f.length,f.head.extra||(f.head.extra=new Array(f.head.extra_len)),vl.arraySet(f.head.extra,S,C,R,x)),512&f.flags&&(f.check=ac(f.check,S,R,C)),E-=R,C+=R,f.length-=R),f.length))break e;f.length=0,f.mode=zd;case zd:if(2048&f.flags){if(0===E)break e;R=0;do{x=S[C+R++],f.head&&x&&f.length<65536&&(f.head.name+=String.fromCharCode(x))}while(x&&R<E);if(512&f.flags&&(f.check=ac(f.check,S,R,C)),E-=R,C+=R,x)break e}else f.head&&(f.head.name=null);f.length=0,f.mode=Kd;case Kd:if(4096&f.flags){if(0===E)break e;R=0;do{x=S[C+R++],f.head&&x&&f.length<65536&&(f.head.comment+=String.fromCharCode(x))}while(x&&R<E);if(512&f.flags&&(f.check=ac(f.check,S,R,C)),E-=R,C+=R,x)break e}else f.head&&(f.head.comment=null);f.mode=Jd;case Jd:if(512&f.flags){for(;b<16;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(I!==(65535&f.check)){g.msg="header crc mismatch",f.mode=fh;break}I=0,b=0}f.head&&(f.head.hcrc=f.flags>>9&1,f.head.done=!0),g.adler=f.check=0,f.mode=Xd;break;case Yd:for(;b<32;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}g.adler=f.check=zswap32(I),I=0,b=0,f.mode=Qd;case Qd:if(0===f.havedict)return g.next_out=_,g.avail_out=T,g.next_in=C,g.avail_in=E,f.hold=I,f.bits=b,Ld;g.adler=f.check=1,f.mode=Xd;case Xd:if(m===Dd||m===Od)break e;case Zd:if(f.last){I>>>=7&b,b-=7&b,f.mode=gh;break}for(;b<3;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}switch(f.last=1&I,b-=1,3&(I>>>=1)){case 0:f.mode=eh;break;case 1:if(fixedtables(f),f.mode=ah,m===Od){I>>>=2,b-=2;break e}break;case 2:f.mode=nh;break;case 3:g.msg="invalid block type",f.mode=fh}I>>>=2,b-=2;break;case eh:for(I>>>=7&b,b-=7&b;b<32;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if((65535&I)!=(I>>>16^65535)){g.msg="invalid stored block lengths",f.mode=fh;break}if(f.length=65535&I,I=0,b=0,f.mode=th,m===Od)break e;case th:f.mode=ih;case ih:if(R=f.length){if(R>E&&(R=E),R>T&&(R=T),0===R)break e;vl.arraySet(v,S,C,R,_),E-=R,C+=R,T-=R,_+=R,f.length-=R;break}f.mode=Xd;break;case nh:for(;b<14;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(f.nlen=257+(31&I),I>>>=5,b-=5,f.ndist=1+(31&I),I>>>=5,b-=5,f.ncode=4+(15&I),I>>>=4,b-=4,f.nlen>286||f.ndist>30){g.msg="too many length or distance symbols",f.mode=fh;break}f.have=0,f.mode=rh;case rh:for(;f.have<f.ncode;){for(;b<3;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.lens[G[f.have++]]=7&I,I>>>=3,b-=3}for(;f.have<19;)f.lens[G[f.have++]]=0;if(f.lencode=f.lendyn,f.lenbits=7,V={bits:f.lenbits},U=Ad(Pd,f.lens,0,19,f.lencode,0,f.work,V),f.lenbits=V.bits,U){g.msg="invalid code lengths set",f.mode=fh;break}f.have=0,f.mode=sh;case sh:for(;f.have<f.nlen+f.ndist;){for(;O=(H=f.lencode[I&(1<<f.lenbits)-1])>>>16&255,N=65535&H,!((D=H>>>24)<=b);){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(N<16)I>>>=D,b-=D,f.lens[f.have++]=N;else{if(16===N){for(B=D+2;b<B;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(I>>>=D,b-=D,0===f.have){g.msg="invalid bit length repeat",f.mode=fh;break}x=f.lens[f.have-1],R=3+(3&I),I>>>=2,b-=2}else if(17===N){for(B=D+3;b<B;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}b-=D,x=0,R=3+(7&(I>>>=D)),I>>>=3,b-=3}else{for(B=D+7;b<B;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}b-=D,x=0,R=11+(127&(I>>>=D)),I>>>=7,b-=7}if(f.have+R>f.nlen+f.ndist){g.msg="invalid bit length repeat",f.mode=fh;break}for(;R--;)f.lens[f.have++]=x}}if(f.mode===fh)break;if(0===f.lens[256]){g.msg="invalid code -- missing end-of-block",f.mode=fh;break}if(f.lenbits=9,V={bits:f.lenbits},U=Ad(Rd,f.lens,0,f.nlen,f.lencode,0,f.work,V),f.lenbits=V.bits,U){g.msg="invalid literal/lengths set",f.mode=fh;break}if(f.distbits=6,f.distcode=f.distdyn,V={bits:f.distbits},U=Ad(wd,f.lens,f.nlen,f.ndist,f.distcode,0,f.work,V),f.distbits=V.bits,U){g.msg="invalid distances set",f.mode=fh;break}if(f.mode=ah,m===Od)break e;case ah:f.mode=oh;case oh:if(E>=6&&T>=258){g.next_out=_,g.avail_out=T,g.next_in=C,g.avail_in=E,f.hold=I,f.bits=b,md(g,P),_=g.next_out,v=g.output,T=g.avail_out,C=g.next_in,S=g.input,E=g.avail_in,I=f.hold,b=f.bits,f.mode===Xd&&(f.back=-1);break}for(f.back=0;O=(H=f.lencode[I&(1<<f.lenbits)-1])>>>16&255,N=65535&H,!((D=H>>>24)<=b);){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(O&&0==(240&O)){for(k=D,L=O,F=N;O=(H=f.lencode[F+((I&(1<<k+L)-1)>>k)])>>>16&255,N=65535&H,!(k+(D=H>>>24)<=b);){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}I>>>=k,b-=k,f.back+=k}if(I>>>=D,b-=D,f.back+=D,f.length=N,0===O){f.mode=uh;break}if(32&O){f.back=-1,f.mode=Xd;break}if(64&O){g.msg="invalid literal/length code",f.mode=fh;break}f.extra=15&O,f.mode=lh;case lh:if(f.extra){for(B=f.extra;b<B;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.length+=I&(1<<f.extra)-1,I>>>=f.extra,b-=f.extra,f.back+=f.extra}f.was=f.length,f.mode=ch;case ch:for(;O=(H=f.distcode[I&(1<<f.distbits)-1])>>>16&255,N=65535&H,!((D=H>>>24)<=b);){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(0==(240&O)){for(k=D,L=O,F=N;O=(H=f.distcode[F+((I&(1<<k+L)-1)>>k)])>>>16&255,N=65535&H,!(k+(D=H>>>24)<=b);){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}I>>>=k,b-=k,f.back+=k}if(I>>>=D,b-=D,f.back+=D,64&O){g.msg="invalid distance code",f.mode=fh;break}f.offset=N,f.extra=15&O,f.mode=dh;case dh:if(f.extra){for(B=f.extra;b<B;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}f.offset+=I&(1<<f.extra)-1,I>>>=f.extra,b-=f.extra,f.back+=f.extra}if(f.offset>f.dmax){g.msg="invalid distance too far back",f.mode=fh;break}f.mode=hh;case hh:if(0===T)break e;if(R=P-T,f.offset>R){if((R=f.offset-R)>f.whave&&f.sane){g.msg="invalid distance too far back",f.mode=fh;break}R>f.wnext?(R-=f.wnext,w=f.wsize-R):w=f.wnext-R,R>f.length&&(R=f.length),M=f.window}else M=v,w=_-f.offset,R=f.length;R>T&&(R=T),T-=R,f.length-=R;do{v[_++]=M[w++]}while(--R);0===f.length&&(f.mode=oh);break;case uh:if(0===T)break e;v[_++]=f.length,T--,f.mode=oh;break;case gh:if(f.wrap){for(;b<32;){if(0===E)break e;E--,I|=S[C++]<<b,b+=8}if(P-=T,g.total_out+=P,f.total+=P,P&&(g.adler=f.check=f.flags?ac(f.check,v,P,_-P):nc(f.check,v,P,_-P)),P=T,(f.flags?I:zswap32(I))!==f.check){g.msg="incorrect data check",f.mode=fh;break}I=0,b=0}f.mode=ph;case ph:if(f.wrap&&f.flags){for(;b<32;){if(0===E)break e;E--,I+=S[C++]<<b,b+=8}if(I!==(4294967295&f.total)){g.msg="incorrect length check",f.mode=fh;break}I=0,b=0}f.mode=mh;case mh:U=kd;break e;case fh:U=xd;break e;case Sh:return Ud;default:return Fd}return g.next_out=_,g.avail_out=T,g.next_in=C,g.avail_in=E,f.hold=I,f.bits=b,(f.wsize||P!==g.avail_out&&f.mode<fh&&(f.mode<gh||m!==Md))&&updatewindow(g,g.output,g.next_out,P-g.avail_out),A-=g.avail_in,P-=g.avail_out,g.total_in+=A,g.total_out+=P,f.total+=P,f.wrap&&P&&(g.adler=f.check=f.flags?ac(f.check,v,P,g.next_out-P):nc(f.check,v,P,g.next_out-P)),g.data_type=f.bits+(f.last?64:0)+(f.mode===Xd?128:0)+(f.mode===ah||f.mode===th?256:0),(0===A&&0===P||m===Md)&&U===Nd&&(U=Vd),U}function inflateEnd(g){if(!g||!g.state)return Fd;var m=g.state;return m.window&&(m.window=null),g.state=null,Nd}function inflateGetHeader(g,m){var f;return g&&g.state?0==(2&(f=g.state).wrap)?Fd:(f.head=m,m.done=!1,Nd):Fd}function inflateSetDictionary(g,m){var f,S=m.length;return g&&g.state?0!==(f=g.state).wrap&&f.mode!==Qd?Fd:f.mode===Qd&&nc(1,m,S,0)!==f.check?xd:updatewindow(g,m,S,S)?(f.mode=Sh,Ud):(f.havedict=1,Nd):Fd}var Ih={inflateReset:inflateReset,inflateReset2:inflateReset2,inflateResetKeep:inflateResetKeep,inflateInit:inflateInit,inflateInit2:inflateInit2,inflate:inflate,inflateEnd:inflateEnd,inflateGetHeader:inflateGetHeader,inflateSetDictionary:inflateSetDictionary,inflateInfo:"pako inflate (from Nodeca project)"},bh={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};function GZheader(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var Ah=GZheader,Ph=Object.prototype.toString;function Inflate(g){if(!(this instanceof Inflate))return new Inflate(g);this.options=vl.assign({chunkSize:16384,windowBits:0,to:""},g||{});var m=this.options;m.raw&&m.windowBits>=0&&m.windowBits<16&&(m.windowBits=-m.windowBits,0===m.windowBits&&(m.windowBits=-15)),!(m.windowBits>=0&&m.windowBits<16)||g&&g.windowBits||(m.windowBits+=32),m.windowBits>15&&m.windowBits<48&&0==(15&m.windowBits)&&(m.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new id,this.strm.avail_out=0;var f=Ih.inflateInit2(this.strm,m.windowBits);if(f!==bh.Z_OK)throw new Error(oc[f]);this.header=new Ah,Ih.inflateGetHeader(this.strm,this.header)}function inflate$1(g,m){var f=new Inflate(m);if(f.push(g,!0),f.err)throw f.msg;return f.result}function inflateRaw(g,m){return(m=m||{}).raw=!0,inflate$1(g,m)}Inflate.prototype.push=function(g,m){var f,S,v,C,_,E,T=this.strm,I=this.options.chunkSize,b=this.options.dictionary,A=!1;if(this.ended)return!1;S=m===~~m?m:!0===m?bh.Z_FINISH:bh.Z_NO_FLUSH,"string"==typeof g?T.input=td.binstring2buf(g):"[object ArrayBuffer]"===Ph.call(g)?T.input=new Uint8Array(g):T.input=g,T.next_in=0,T.avail_in=T.input.length;do{if(0===T.avail_out&&(T.output=new vl.Buf8(I),T.next_out=0,T.avail_out=I),(f=Ih.inflate(T,bh.Z_NO_FLUSH))===bh.Z_NEED_DICT&&b&&(E="string"==typeof b?td.string2buf(b):"[object ArrayBuffer]"===Ph.call(b)?new Uint8Array(b):b,f=Ih.inflateSetDictionary(this.strm,E)),f===bh.Z_BUF_ERROR&&!0===A&&(f=bh.Z_OK,A=!1),f!==bh.Z_STREAM_END&&f!==bh.Z_OK)return this.onEnd(f),this.ended=!0,!1;T.next_out&&(0!==T.avail_out&&f!==bh.Z_STREAM_END&&(0!==T.avail_in||S!==bh.Z_FINISH&&S!==bh.Z_SYNC_FLUSH)||("string"===this.options.to?(v=td.utf8border(T.output,T.next_out),C=T.next_out-v,_=td.buf2string(T.output,v),T.next_out=C,T.avail_out=I-C,C&&vl.arraySet(T.output,T.output,v,C,0),this.onData(_)):this.onData(vl.shrinkBuf(T.output,T.next_out)))),0===T.avail_in&&0===T.avail_out&&(A=!0)}while((T.avail_in>0||0===T.avail_out)&&f!==bh.Z_STREAM_END);return f===bh.Z_STREAM_END&&(S=bh.Z_FINISH),S===bh.Z_FINISH?(f=Ih.inflateEnd(this.strm),this.onEnd(f),this.ended=!0,f===bh.Z_OK):S!==bh.Z_SYNC_FLUSH||(this.onEnd(bh.Z_OK),T.avail_out=0,!0)},Inflate.prototype.onData=function(g){this.chunks.push(g)},Inflate.prototype.onEnd=function(g){g===bh.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=vl.flattenChunks(this.chunks)),this.chunks=[],this.err=g,this.msg=this.strm.msg};var Rh={Inflate:Inflate,inflate:inflate$1,inflateRaw:inflateRaw,ungzip:inflate$1},wh={};(0,vl.assign)(wh,ud,Rh,bh);var Mh=wh;function defer$1(){let g,m,f=!0;return{isPending:()=>f,promise:new Promise(((f,S)=>{g=f,m=S})),resolve:m=>{f&&(g(m),f=!1)},reject:g=>{f&&(m(g),f=!1)}}}function sleep(g){return new Promise((m=>_setTimeout(m,g)))}function _setTimeout(g,m){return globalThis.setTimeout(g,m)}function _clearTimeout(g){globalThis.clearTimeout(g)}function wait(g,m){const f=defer$1();let S;try{S=g()}catch(g){return Promise.reject(f.reject(g))}if(m<0)return S.finally((()=>{f.resolve(S)})),f.promise;const v=_setTimeout((()=>{f.isPending()&&f.reject(new CallingCommunicationError(z.INTERNAL.OPERATION_TIMEDOUT))}),m);return S.catch((g=>{_clearTimeout(v),f.isPending()&&f.reject(g)})).finally((()=>{_clearTimeout(v),f.isPending()&&f.resolve(S)})),f.promise}function dictOrderGreaterFirst(g,m){var f=g.toString(),S=m.toString();return f>S?1:f<S?-1:0}var Dh=dictOrderGreaterFirst;function _classCallCheck(g,m){if(!(g instanceof m))throw new TypeError("Cannot call a class as a function")}function _defineProperties(g,m){for(var f=0;f<m.length;f++){var S=m[f];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(g,S.key,S)}}function _createClass(g,m,f){return m&&_defineProperties(g.prototype,m),f&&_defineProperties(g,f),g}function _defineProperty(g,m,f){return m in g?Object.defineProperty(g,m,{value:f,enumerable:!0,configurable:!0,writable:!0}):g[m]=f,g}var Oh=function(){function PriorityQueue(){var g=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).comparator,m=void 0===g?Dh:g;_classCallCheck(this,PriorityQueue),_defineProperty(this,"comparator",void 0),this.comparator=m}return _createClass(PriorityQueue,null,[{key:"from",value:function from(g,m){throw new Error("not implemented")}}]),_createClass(PriorityQueue,[{key:"clear",value:function clear(){throw new Error("not implemented")}},{key:"toArray",value:function toArray(){throw new Error("not implemented")}},{key:"push",value:function push(g){throw new Error("not implemented")}},{key:"enqueue",value:function enqueue(g){return this.push(g)}},{key:"top",value:function top(){throw new Error("not implemented")}},{key:"peek",value:function peek(){return this.top()}},{key:"pop",value:function pop(){throw new Error("not implemented")}},{key:"dequeue",value:function dequeue(){return this.pop()}},{key:"merge",value:function merge(g){throw new Error("not implemented")}},{key:"isEmpty",value:function isEmpty(){throw new Error("not implemented")}},{key:"length",get:function get(){throw new Error("not implemented")}}]),PriorityQueue}();function _typeof(g){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function _typeof(g){return typeof g}:function _typeof(g){return g&&"function"==typeof Symbol&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},_typeof(g)}function _toConsumableArray(g){return _arrayWithoutHoles(g)||_iterableToArray(g)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(g){if(Symbol.iterator in Object(g)||"[object Arguments]"===Object.prototype.toString.call(g))return Array.from(g)}function _arrayWithoutHoles(g){if(Array.isArray(g)){for(var m=0,f=new Array(g.length);m<g.length;m++)f[m]=g[m];return f}}function _classCallCheck$1(g,m){if(!(g instanceof m))throw new TypeError("Cannot call a class as a function")}function _defineProperties$1(g,m){for(var f=0;f<m.length;f++){var S=m[f];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(g,S.key,S)}}function _createClass$1(g,m,f){return m&&_defineProperties$1(g.prototype,m),f&&_defineProperties$1(g,f),g}function _possibleConstructorReturn(g,m){return!m||"object"!==_typeof(m)&&"function"!=typeof m?_assertThisInitialized(g):m}function _getPrototypeOf(g){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(g){return g.__proto__||Object.getPrototypeOf(g)},_getPrototypeOf(g)}function _assertThisInitialized(g){if(void 0===g)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return g}function _inherits(g,m){if("function"!=typeof m&&null!==m)throw new TypeError("Super expression must either be null or a function");g.prototype=Object.create(m&&m.prototype,{constructor:{value:g,writable:!0,configurable:!0}}),m&&_setPrototypeOf(g,m)}function _setPrototypeOf(g,m){return _setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(g,m){return g.__proto__=m,g},_setPrototypeOf(g,m)}function _defineProperty$1(g,m,f){return m in g?Object.defineProperty(g,m,{value:f,enumerable:!0,configurable:!0,writable:!0}):g[m]=f,g}function getLargestIndex(g,m,f){var S=2*m,v=2*m+1,C=m;return S<g.length&&f(g[C],g[S])<0&&(C=S),v<g.length&&f(g[C],g[v])<0&&(C=v),C}function heapify(g,m,f){var S=getLargestIndex(g,m,f);if(S!==m){var v=g[m];g[m]=g[S],g[S]=v,heapify(g,S,f)}}function heapifyAll(g){for(var m=Math.floor(g.collection.length/2)-1;m>=0;--m)heapify(g.collection,m,g.comparator)}var Nh,kh,Lh,Fh,xh,Uh,Vh,Bh=function(g){function BinaryHeap(){var g,m;_classCallCheck$1(this,BinaryHeap);for(var f=arguments.length,S=new Array(f),v=0;v<f;v++)S[v]=arguments[v];return _defineProperty$1(_assertThisInitialized(m=_possibleConstructorReturn(this,(g=_getPrototypeOf(BinaryHeap)).call.apply(g,[this].concat(S)))),"collection",[]),m}return _inherits(BinaryHeap,Oh),_createClass$1(BinaryHeap,[{key:"clear",value:function clear(){this.collection.length=0}},{key:"toArray",value:function toArray(){return _toConsumableArray(this.collection).sort(this.comparator)}},{key:"top",value:function top(){if(0===this.length)throw new Error("invalid operation: top() called for empty BinaryHeap");return this.collection[0]}},{key:"pop",value:function pop(){if(0===this.length)throw new Error("invalid operation: pop() called for empty BinaryHeap");var g=this.collection[0];return this.collection.length>1?(this.collection[0]=this.collection.pop(),heapify(this.collection,0,this.comparator)):this.collection.pop(),g}},{key:"push",value:function push(g){this.collection.push(g);for(var m=this.collection,f=m.length-1,S=Math.floor(f/2);f>0&&this.comparator(m[S],m[f])<0;f=S,S=Math.floor(S/2)){var v=m[f];m[f]=m[S],m[S]=v}}},{key:"merge",value:function merge(g){this.collection=g instanceof BinaryHeap?this.collection.concat(g.collection):this.collection.concat(g.toArray()),heapifyAll(this),g.clear()}},{key:"isEmpty",value:function isEmpty(){return!this.collection.length}},{key:"length",get:function get(){return this.collection.length}}],[{key:"from",value:function from(g){var m=new BinaryHeap(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{});return m.collection=Array.from(g),heapifyAll(m),m}}]),BinaryHeap}(),Hh=Bh;class NotificationManager$1{constructor(g,m){this._tenantId=g,this.listeners=[],this._logger=m.createChild(`TelemetryLogger[${g}]`);const f=this._tenantId;m.log(`Notification Manager Notification Manager logger initialized for tenant ${f}`),this._discardedEventsBufferPQ=new Hh({comparator:(g,m)=>m.latency-g.latency})}addNotificationListener(g){this.listeners.find((m=>m===g))||this.listeners.push(g)}removeNotificationListener(g){this.listeners=this.listeners.filter((m=>m!==g))}eventsSent(g){const m=JSON.stringify(g);this._logger.log(`Notification Manager sent telemetry events ${m}`),this.listeners.forEach((m=>m.eventsSent&&m.eventsSent(g)))}eventsDiscarded(g,m){this._logger.log(`Notification Manager discarded telemetry events ${JSON.stringify(g)}, reason ${m} adding to retry buffer`),g.forEach((g=>{g.latency=g.latency||ni.Normal;const m=g;(m.sendAttempt||0)<=getAcsEcsConfig().telemetry.discardedEventsMaxRetries?this._discardedEventsBufferPQ.push(m):this._logger.log(`Notification Manager dropping event due to too many retries ${JSON.stringify(g)}`)}));const f=getAcsEcsConfig().telemetry.discardedEventsBufferMaxLength;for(;this._discardedEventsBufferPQ.length>f;)this._logger.log(` dropping event from retry buffer ${this._discardedEventsBufferPQ.dequeue()} due to overflow`);this.listeners.forEach((f=>f.eventsDiscarded&&f.eventsDiscarded(g,m)))}getDiscardedEvents(){const g=[],m=this._discardedEventsBufferPQ.length;for(let f=0;f<m;f++)g.push(this._discardedEventsBufferPQ.dequeue());return g}}class TelemetryLogManager{constructor(g,m,f,S){this._telemetryLoggers=new Map,this._eventsBufferMap=new Map,this._initialized=!1,this.sdkDiagnosticInformation="",this._telemetryRateLimit=new Map,this._mediaEventsReportedForTheCall={},this._logger=g.createChild("TelemetryLogManager"),this.sdkDiagnosticInformation=m,this._sdkInternaVersion=getSdkInternalVersion(),this._acsProxy=f,this._acsCustomRelayManager=S,getAcsEcsConfig().telemetry.limit.rates.forEach((g=>{this._telemetryRateLimit.set(g.eventName,{...g,windowStartTime:Date.now(),eventCount:0})}))}getTelemetryLoggers(){return this._telemetryLoggers}getEventsBufferMap(){return this._eventsBufferMap}isInitialized(){return this._initialized}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}initialize(g){if(!g.cloudType)throw this._logger.error("Failed to initialize telemetry loggers, invalid cloud type provided."),new CallingCommunicationError(z.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_INVALID_CLOUD_TYPE);if(this._initialized)throw this._logger.error("Failed to initialize telemetry loggers, telemetry log manager is already initialized."),new CallingCommunicationError(z.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE_ALREADY_INITIALIZED);this._telemetryLoggers.forEach(((m,f)=>{try{m.initialize(g),this._logger.log(`Initialized and flushed buffered telemetry logger for ${f}`)}catch(g){this._logger.warn(`Failed to initialize and flush buffered telemetry logger for ${f}`),this._telemetryLoggers.delete(f)}})),this._initialized=!0,this._caConfigBag=g,this._logger.log(`Telemetry log manager has been initialized for Call Client: ${this._caConfigBag.clientId}`)}clearTelemetryLoggers(){const g=this._telemetryLoggers.size;return this._telemetryLoggers=new Map,this._caConfigBag=void 0,this._initialized=!1,g}getMediaEventReportedPromise(g){if(!this._mediaEventsReportedForTheCall[g]){const m=defer();m.promise.catch(noop),this._mediaEventsReportedForTheCall[g]=m}return this._mediaEventsReportedForTheCall[g].promise}_reportMediaEventForTheCall(g){if(this._mediaEventsReportedForTheCall[g])this._mediaEventsReportedForTheCall[g].resolve();else{const m=defer();m.promise.catch(noop),m.resolve(),this._mediaEventsReportedForTheCall[g]=m}}_getEventDataWithoutPii(g){const m={};if(g.properties)for(const f of Object.keys(g.properties)){const S=g.properties[f];m[f]={value:S?.value??S,kind:S?.piiKind??0}}return m}sendEvent(g,m){try{if(this._logger.debug(`sending event=${g.name}`),this.checkIfEventIsBlocked(g.name)||this.shouldLimitSendingTelemetry(g.name)||this.isRateLimitExceeded(g.name))return void this._logger.debug(`event=${g.name} is blocked`);const f={name:g.name,data:g.properties};f?.name in qh&&(f.data=this._getEventDataWithoutPii(g)),void 0===f.data&&(f.data={}),f?.name===qh.mdsc_webrtc_session&&this._reportMediaEventForTheCall(f?.data?.CorrelationId),void 0!==typeof g.priority?f.latency=g.priority:f.latency=ni.Normal;const S=getAcsEcsConfig().telemetryEvents.eventNameToPriority.eventName.indexOf(g.name);-1!==S&&(f.latency=getAcsEcsConfig().telemetryEvents.eventNameToPriority.priority[S]),f.data.sdkVersion=this._sdkInternaVersion,f.data.platformId=getPlatformId();const v=`${getPlatformId()}/${this._sdkInternaVersion}`;f.data.uiVersion=v,f.data.ui_version=v,f.data.Platform_Uiversion=v,f.data.userAgent=`${this.sdkDiagnosticInformation} ${navigator.userAgent}`,f.data.clientTimestamp=+new Date,f.data.customProxyAndRelayUsage=this.getCustomProxyAndRelayTag();const C=g.tenant;let _=this._eventsBufferMap.get(C);_||(_=this._eventsBufferMap.set(C,[]).get(C));let E=this._telemetryLoggers.get(C);if(E||(E=new TelemetryLogger(C,this._logger,_,this._acsProxy),this._telemetryLoggers.set(C,E),this._logger.log(`Created telemetry logger for ${C}`)),this._initialized){if(!E.isInitialized())try{E.initialize(this._caConfigBag),this._logger.log(`Created and initialized telemetry logger for ${C}`)}catch(g){throw this._telemetryLoggers.delete(C),_?.push(f),this._logger.error(`Failed to create and initialize telemetry logger for ${C}`),new CallingCommunicationError(z.INTERNAL.TELEMETRY_FAILED_TO_INITIALIZE(C))}m&&E.getAppInsightsCore()?.addNotificationListener(m),E.sendEvent(f)}else _?.push(f)}catch(m){this._logger.warn(`Failed to send event ${g?.name}`)}}async flushAllEvents(g){if(this._logger.debug(`flushing events: ${this._telemetryLoggers.size}`),-1!==getAcsEcsConfig().telemetry.telemetryFlushTimeout){const flushLogger=(m,f)=>{try{const S=defer();S.promise.catch(noop);const v=wait((async()=>(f===oo&&await this.getMediaEventReportedPromise(g),S.promise)),getAcsEcsConfig().telemetry.telemetryFlushTimeout);return m.flushEvents((()=>{this._logger.debug("events flushed"),S.resolve()})),v.then(noop)}catch(g){throw new CallingCommunicationError(z.INTERNAL.TELEMETRY_FAILED_TO_FLUSH)}},m=[];return this._telemetryLoggers.forEach(((g,f)=>{m.push(flushLogger(g,f).catch((()=>{this._logger.warn("Failed to flush telemetry")})))})),Promise.all(m)}this._telemetryLoggers.forEach((g=>{try{g.flushEvents()}catch(g){this._logger.warn("Failed to flush telemetry")}}))}checkIfEventIsBlocked(g){if(Array.isArray(getAcsEcsConfig()?.telemetry?.blockedEvents)){const m=getAcsEcsConfig()?.telemetry?.blockedEvents;return Array.isArray(m)&&m?.indexOf(g)>-1||!1}return!1}shouldLimitSendingTelemetry(g){return getAcsEcsConfig().telemetry.limit.outSideCall.enabled&&(0===getAcsEcsConfig().telemetry.limit.outSideCall.includedEvents.length||getAcsEcsConfig().telemetry.limit.outSideCall.includedEvents.includes(g))&&!getAcsEcsConfig().telemetry.limit.outSideCall.excludedEvents.includes(g)&&TelemetryLogManager.callEndTimestamp!==Number.MAX_SAFE_INTEGER&&TelemetryLogManager.callEndTimestamp+getAcsEcsConfig().telemetry.limit.outSideCall.deltaTimeInMs-Date.now()<0}isRateLimitExceeded(g){const m=this._telemetryRateLimit.get(g);if(m){const f=Date.now();if(f-m.windowStartTime>m.windowSizeInMs&&(m.windowStartTime=f,m.eventCount=0),m.eventCount++,m.eventCount>m.maxEventPerWindow)return this._logger.info(`Telemetry event ${g} is rate limited`),!0}return!1}getCustomProxyAndRelayTag(){const g=this._acsProxy?.proxyInUse??!1,m=this._acsCustomRelayManager?.hasRelayConfig??!1;return g&&m?nl.usedProxyAndNonMsftTurn:g?nl.onlyUsedProxy:m?nl.onlyUsedNonMsftTurn:nl.noCustomProxyAndTurnUsed}}TelemetryLogManager.telemetryPayloadBytesOriginal=0,TelemetryLogManager.telemetryPayloadBytesCompressed=0,TelemetryLogManager.callEndTimestamp=0;class TelemetryLogger{constructor(g,m,f,S){this._tenantId=g,this._eventsBuffer=f,this._initialized=!1,this._networkOnline=!0,this._telemetryRetryIntervalRunning=!1,this._logger=m.createChild(`TelemetryLogger[${g}]`),this._acsProxy=S,window.addEventListener("online",(g=>{this._networkOnline=g.detail,this._networkOnline&&this._initialized&&!this._telemetryRetryIntervalRunning&&(this._logger.log("browser network back online starting telemetry send retry"),this.scheduleDiscardedTelemetryRetry())}))}initialize(g){if(this._initialized)this._logger.warn(`Telemetry logger for tenant: ${this._tenantId}, already initialized`);else try{const m=new ia;this._appInsightsCore=new gi,this._postChannel=new hs;const f={instrumentationKey:this._tenantId,extensions:[this._postChannel,m],disableCookiesUsage:!0},S={populateBrowserInfo:!0,populateOperatingSystemInfo:!0};void 0===f.extensionConfig&&(f.extensionConfig={}),f.extensionConfig[m.identifier]=S;const v={overrideEndpointUrl:this.getAriaCollectorUrl(g),payloadPreprocessor:getAcsEcsConfig().telemetry.gzipTelemetryPayload?(g,m)=>{this.gzipPayload(g,m)}:void 0};if(f.extensionConfig[this._postChannel.identifier]=v,Object.keys(getAcsEcsConfig().calling?.eudb?.acsCompliantEvents).length>0&&($h={...$h,...getAcsEcsConfig().calling.eudb.acsCompliantEvents}),getAcsEcsConfig().telemetry.localStorageEnable){const g=new hr;f.extensions?.push(g);const m={storageKey:"WebSdkTelemetry"};f.extensionConfig[g.identifier]=m}this._NotificationManager=new NotificationManager$1(this._tenantId,this._logger),this._appInsightsCore.initialize(f,[],void 0,this._NotificationManager),this._caConfigBag=g,this.scheduleDiscardedTelemetryRetry(),this._initialized=!0,this._eventsBuffer.forEach((g=>{this.sendEvent(g)})),this._eventsBuffer.splice(0,this._eventsBuffer.length)}catch(g){throw this._logger.error(`Failed to initialize telemetry logger for tenant: ${this._tenantId}`),new CallingCommunicationError(z.INTERNAL.TELEMETRY_LOGGER_INIT_FAIL)}}getCloudType(){return this._caConfigBag?.cloudType}getAcsResourceId(){return this._caConfigBag?.acsResourceId}getClientId(){return this._caConfigBag?.clientId}isInitialized(){return this._initialized}getAppInsightsCore(){return this._appInsightsCore}sendEvent(g){this._initialized&&(g?.name in $h&&this.appendEudbComplianceRegionToEvent(g),g?.data&&(g.data.clientId=this._caConfigBag?.clientId||"",0===g?.name?.indexOf("mdsc_webrtc")?g.data.metrics_AcsResourceId=this._caConfigBag?.acsResourceId||"":g.data.AcsResourceId=this._caConfigBag?.acsResourceId||"",g.data.cloudType=this._caConfigBag?.cloudType||"",g.data.identityType=this._caConfigBag?.identityType||""),this.sendAppInsightsCoreEvent(g))}scheduleDiscardedTelemetryRetry(){const g=getAcsEcsConfig().telemetry.discardedTelemetryRetryTimeout;let m=setInterval((async()=>{this._networkOnline?(this._NotificationManager?.getDiscardedEvents().forEach((g=>{this.sendEvent(g)})),this._telemetryRetryIntervalRunning=!0):(this._logger.log("browser lost network access stopping telemetry send retry"),clearInterval(m),this._telemetryRetryIntervalRunning=!1)}),g)}sendAppInsightsCoreEvent(g){this._appInsightsCore?.track(g)}flushEvents(g){this._initialized&&this._postChannel&&this._postChannel.flush(!1,g)}getAriaCollectorUrl(g){const m=isEudbConfigurationsApplicable(g.identityType,g.region);let f;if(g.identityType===fa.Enterprise)f=m?la.EnterpriseEUDB:la.Enterprise;else switch(g.cloudType){case ca.Public:f=m?la.PublicEUDB:la.Public;break;case ca.GccHigh:f=la.GccHigh;break;case ca.Dod:f=la.Dod;break;case ca.AirGap08:f=la.AirGap08;break;case ca.AirGap09:f=la.AirGap09;break;default:f=la.Public}return this._acsProxy?this._acsProxy.proxyfyUrl(f):f}gzipPayload(g,m){try{TelemetryLogManager.telemetryPayloadBytesOriginal+=getSizeInBytes(g.data,this._logger),g.data=Mh.gzip(g.data),g.urlString+="&content-encoding=gzip",TelemetryLogManager.telemetryPayloadBytesCompressed+=getSizeInBytes(g.data,this._logger)}catch(g){this._logger.warn("Failed to gzip with pako: ",g)}m(g)}getRegion(g){if(this._caConfigBag&&isRgnClaimApplicable(this._caConfigBag.identityType))switch(g){case"emea":case"de":return Ta.EMEA;case"apac":return Ta.APAC;case"noam":case"amer":return Ta.NOAM;default:return this._logger.log(`Unable to map region \`${g}\`, to EudbTenantRegion`),Ta.UNKNOWN}return g&&ya.includes(g)?Ta.EMEA:g&&Ca.includes(g)?Ta.APAC:g&&_a.includes(g)?Ta.NOAM:(this._logger.log(`Unable to map region \`${g}\`, to EudbTenantRegion`),Ta.UNKNOWN)}appendEudbComplianceRegionToEvent(g){let m=this.getTenantComplianceRegion();const f=this.getRegion(this._caConfigBag?.region);if(g.data){let S={};S[Gh]=m,S[Wh]=f,g.data[jh]=S}}getTenantComplianceRegion(){return this._caConfigBag&&isEudbConfigurationsApplicable(this._caConfigBag.identityType,this._caConfigBag.region)?Ea.EU:Ea.RoW}}!function(g){g.remote_view="remote_view",g.remote_stream="remote_stream",g.network_quality="network_quality",g.video_device_issue="video_device_issue",g.other_diagnostic="other_diagnostic",g.logger_event="logger_event",g.number_of_participants="number_of_participants",g.media_metrics_device_events="media_metrics_device_events",g.sdk_active_in_another_tab="sdk_active_in_another_tab",g.network_changed="network_changed"}(Nh||(Nh={})),function(g){g.acs_calling_call_attempt="acs_calling_call_attempt",g.acs_calling_call_connected="acs_calling_call_connected",g.acs_calling_call_failed="acs_calling_call_failed",g.acs_calling_call_accept_attempt="acs_calling_call_accept_attempt",g.acs_calling_call_accept_connected="acs_calling_call_accept_connected",g.acs_calling_call_accept_failed="acs_calling_call_accept_failed",g.acs_calling_call_reject_attempt="acs_calling_call_reject_attempt",g.acs_calling_call_reject_success="acs_calling_call_reject_success",g.acs_calling_call_reject_failed="acs_calling_call_reject_failed",g.acs_calling_call_hangup_attempt="acs_calling_call_hangup_attempt",g.acs_calling_call_hangup_success="acs_calling_call_hangup_success",g.acs_calling_call_hangup_failure="acs_calling_call_hangup_failure",g.acs_calling_call_progress="acs_calling_call_progress",g.acs_calling_stack_init="acs_calling_stack_init",g.acs_calling_get_device_manager="acs_calling_get_device_manager",g.acs_calling_config_fetched_attempt="acs_calling_config_fetched_attempt",g.acs_calling_config_fetched_success="acs_calling_config_fetched_success",g.acs_calling_config_fetched_failure="acs_calling_config_fetched_failure",g.acs_calling_signaling_init="acs_calling_signaling_init",g.acs_calling_call_agent="acs_calling_call_agent",g.acs_calling_call_agent_init_attempt="acs_calling_call_agent_init_attempt",g.acs_calling_call_agent_init_success="acs_calling_call_agent_init_success",g.acs_calling_call_agent_init_failure="acs_calling_call_agent_init_failure",g.acs_calling_create_view_attempt="acs_calling_create_view_attempt",g.acs_calling_create_view_success="acs_calling_create_view_success",g.acs_calling_create_view_failure="acs_calling_create_view_failure",g.acs_calling_dispose_view_attempt="acs_calling_dispose_view_attempt",g.acs_calling_dispose_view_success="acs_calling_dispose_view_success",g.acs_calling_dispose_view_failure="acs_calling_dispose_view_failure",g.acs_calling_start_video_attempt="acs_calling_start_video_attempt",g.acs_calling_start_video_success="acs_calling_start_video_success",g.acs_calling_start_video_failure="acs_calling_start_video_failure",g.acs_calling_stop_video_on_ufd_attempt="acs_calling_stop_video_on_ufd_attempt",g.acs_calling_stop_video_attempt="acs_calling_stop_video_attempt",g.acs_calling_stop_video_success="acs_calling_stop_video_success",g.acs_calling_stop_video_failure="acs_calling_stop_video_failure",g.acs_calling_call_hold_and_resume="acs_calling_call_hold_and_resume",g.acs_calling_start_screen_share="acs_calling_start_screen_share",g.acs_calling_stop_screen_share="acs_calling_stop_screen_share",g.acs_calling_audio_stream_volume="acs_calling_audio_stream_volume",g.acs_calling_call_stats="acs_calling_call_stats",g.acs_calling_participant_added_or_removed="acs_calling_participant_added_or_removed",g.acs_calling_adp_attempt="acs_calling_adp_attempt",g.acs_calling_adp_success="acs_calling_adp_success",g.acs_calling_adp_failure="acs_calling_adp_failure",g.acs_calling_client_operations="acs_calling_client_operations",g.acs_calling_device_permission_changed="acs_calling_device_permission_changed",g.acs_calling_local_audio_source_changed="acs_calling_local_audio_source_changed",g.acs_calling_start_audio_stream_track="acs_calling_start_audio_stream_track",g.acs_calling_stop_audio_stream_track="acs_calling_stop_audio_stream_track",g.acs_calling_get_remote_audio_stream_track="acs_calling_get_remote_audio_stream_track",g.acs_calling_get_raw_device_media_stream="acs_calling_get_raw_device_media_stream",g.acs_calling_media_stream="acs_calling_media_stream",g.acs_calling_page_hidden="acs_calling_page_hidden",g.acs_calling_orientation_changed="acs_calling_orientation_changed",g.acs_calling_token_expiration_changed="acs_calling_token_expiration_changed",g.acs_calling_token_expiration_changed_failure="acs_calling_token_expiration_changed_failure",g.acs_calling_token_expired="acs_calling_token_expired",g.acs_calling_token_has_no_data_location="acs_calling_token_has_no_data_location",g.acs_calling_mute_on_ufd_attempt="acs_calling_mute_on_ufd_attempt",g.acs_calling_mute_attempt="acs_calling_mute_attempt",g.acs_calling_mute_success="acs_calling_mute_success",g.acs_calling_mute_failure="acs_calling_mute_failure",g.acs_calling_unmute_attempt="acs_calling_unmute_attempt",g.acs_calling_unmute_success="acs_calling_unmute_success",g.acs_calling_unmute_failure="acs_calling_unmute_failure",g.acs_calling_start_audio_attempt="acs_calling_start_audio_attempt",g.acs_calling_start_audio_success="acs_calling_start_audio_success",g.acs_calling_start_audio_failure="acs_calling_start_audio_failure",g.acs_calling_unmute_speaker_attempt="acs_calling_unmute_speaker_attempt",g.acs_calling_unmute_speaker_success="acs_calling_unmute_speaker_success",g.acs_calling_unmute_speaker_failure="acs_calling_unmute_speaker_failure",g.acs_calling_stop_audio_attempt="acs_calling_stop_audio_attempt",g.acs_calling_stop_audio_success="acs_calling_stop_audio_success",g.acs_calling_stop_audio_failure="acs_calling_stop_audio_failure",g.acs_calling_prevent_stop_audio="acs_calling_prevent_stop_audio",g.acs_calling_captions="acs_calling_captions",g.acs_calling_mid_call_media_stats="acs_calling_mid_call_media_stats",g.acs_calling_mid_call_new_media_stats="acs_calling_mid_call_new_media_stats",g.acs_calling_mid_call_raw_media_stats="acs_calling_mid_call_raw_media_stats",g.acs_calling_datachannel="acs_calling_datachannel",g.acs_calling_datachannel_stats="acs_calling_datachannel_stats",g.acs_calling_unmixed_audio="acs_calling_unmixed_audio",g.acs_calling_livestream_stats="acs_calling_livestream_stats",g.acs_calling_livestream_raw_stats="acs_calling_livestream_raw_stats",g.acs_calling_survey="acs_calling_survey",g.acs_calling_switch_video_source_attempt="acs_calling_switch_video_source_attempt",g.acs_calling_switch_video_source_success="acs_calling_switch_video_source_success",g.acs_calling_switch_video_source_failure="acs_calling_switch_video_source_failure",g.acs_calling_diagnostics_attempt="acs_calling_diagnostics_attempt",g.acs_calling_diagnostics_result="acs_calling_diagnostics_result",g.acs_calling_feature_usage="acs_calling_feature_usage",g.acs_calling_middletier_gateway_fetch_policy="acs_calling_middletier_gateway_fetch_policy",g.acs_calling_middletier_gateway_emergency_content="acs_calling_middletier_gateway_emergency_content",g.acs_calling_middletier_gateway_fetch_user_policies_for_captions="acs_calling_middletier_gateway_fetch_user_policies_for_captions",g.acs_calling_call_client_init="acs_calling_call_client_init",g.acs_calling_tab_events="acs_calling_tab_events",g.acs_calling_lobby_events="acs_calling_lobby_events",g.acs_calling_handle_push_notification="acs_calling_handle_push_notification"}(kh||(kh={})),function(g){g.attempt="attempt",g.success="success",g.failure="failure",g.getter="getter",g.setter="setter",g.subscribe="subscribe",g.unsubscribe="unsubscribe",g.initialize="initialize",g.event="event"}(Lh||(Lh={})),function(g){g.lobbyAdmit="lobbyAdmit",g.lobbyAdmitAll="lobbyAdmitAll",g.lobbyReject="lobbyReject"}(Fh||(Fh={})),function(g){g.MuteMicrophone="MuteMicrophone",g.MuteAllRemoteParticipants="MuteAllRemoteParticipants",g.MuteSpecificParticipant="MuteSpecificParticipant",g.UnmuteMicrophone="UnmuteMicrophone",g.MuteIncomingAudio="MuteIncomingAudio",g.UnmuteIncomingAudio="UnmuteIncomingAudio"}(xh||(xh={})),function(g){g.Expected="expected",g.Unexpected="unexpected",g.Unknown="unknown"}(Uh||(Uh={})),function(g){g.CaptionsKindChanged="CaptionsKindChanged",g.FirstCaptionReceived="FirstCaptionReceived",g.FirstCaptionParsingError="FirstCaptionParsingError",g.InitializeCaptions="InitializeCaptions",g.LanguageChanged="LanguageChanged",g.SetSpokenLanguage="SetSpokenLanguage",g.SetCaptionLanguage="SetCaptionLanguage",g.SpokenLanguageChanged="SpokenLanguageChanged",g.StartCaptions="StartCaptions",g.StopCaptions="StopCaptions",g.UpdateIsActive="UpdateIsActive"}(Vh||(Vh={}));let $h={...kh,skypecosi_concore_web_csa_conversation_callmodality:"skypecosi_concore_web_csa_conversation_callmodality",skypecosi_concore_web_pluginless_modality_session:"skypecosi_concore_web_pluginless_modality_session",skypecosi_concore_web_pluginless_call_session:"skypecosi_concore_web_pluginless_call_session",skypecosi_concore_web_csa_conversation_httprequest:"skypecosi_concore_web_csa_conversation_httprequest"};const Gh="tenantComplianceRegion",jh="acsCompliancePayload",Wh="tenantRegion";var qh,zh,Kh,Jh,Yh,Qh,Xh,Zh,eu,tu,iu,nu,ru,su,au,ou,lu,cu,du,hu,uu,gu,pu;function parseMeetingUrl(g){try{const m=new URL(g),f=m.pathname.split("/"),S=decodeURIComponent(f[3]),v=f[4],C=JSON.parse(decodeURIComponent(m.search.replace("?context=",""))),_=C.Oid;return{threadId:S,messageId:v,organizerId:_,tenantId:C.Tid}}catch(g){throw new CallingCommunicationError(z.CALL_AGENT.INVALID_MEETING_LINK,g)}}function parseTflMeetingLink(g){try{const m=new URL(g),f=m.pathname.split("/"),S=decodeURIComponent(f[2]),v=decodeURIComponent(g);return{meetingUrl:v,meetingCode:S,passcode:m.searchParams.get("p")??void 0}}catch(g){throw new CallingCommunicationError(z.CALL_AGENT.INVALID_TFL_MEETING_LINK,g)}}function base64UrlEncoding(g){let m=btoa(g).replace(/=/g,"");m=m.replace(/\+/g,"-"),m=m.replace(/\//g,"_");for(const g of m)if(g.match(/[^A-Za-z0-9-_]/))throw new CallingCommunicationError(z.CALL.SERVER_CALL_ID);return m}!function(g){g.mdsc_webrtc_session="mdsc_webrtc_session",g.mdsc_webrtc_session_initial="mdsc_webrtc_session_initial"}(qh||(qh={})),function(g){g.Outgoing="Outgoing",g.Incoming="Incoming",g.TransferOutgoing="TransferOutgoing"}(zh||(zh={})),function(g){g.CreateCallAgent="CreateCallAgent",g.CreateTeamsCallAgent="CreateTeamsCallAgent",g.GetDeviceManager="GetDeviceManager",g.GetEnvironmentInfo="GetEnvironmentInfo",g.GetSDKVersion="GetSDKVersion",g.Feature="Feature"}(Kh||(Kh={})),function(g){g.StartCall="StartCall",g.Join="Join",g.HandlePushNotification="HandlePushNotification",g.Initialize="Initialize",g.Dispose="Dispose",g.CreateCall="CreateCall",g.Feature="Feature"}(Jh||(Jh={})),function(g){g.Call="Call",g.StartCall="StartCall",g.CallGroup="CallGroup",g.JoinGroup="JoinGroup",g.Accept="Accept",g.Reject="Reject",g.Mute="Mute",g.Unmute="Unmute",g.MuteAllRemoteParticipants="MuteAllRemoteParticipants",g.MuteIncomingAudio="MuteIncomingAudio",g.UnmuteIncomingAudio="UnmuteIncomingAudio",g.SendDtmf="SendDtmf",g.HangUp="HangUp",g.StartVideo="StartVideo",g.startAudio="startAudio",g.StopVideo="StopVideo",g.AddParticipant="AddParticipant",g.RemoveParticipant="RemoveParticipant",g.LobbyAdmitParticipant="LobbyAdmitParticipant",g.LobbyRejectParticipant="LobbyRejectParticipant",g.LobbyAdmitAll="LobbyAdmitAll",g.Hold="Hold",g.Resume="Resume",g.StartScreenShare="StartScreenShare",g.StopScreenShare="StopScreenShare",g.Transfer="Transfer",g.BindToCall="BindToCall",g.Feature="Feature",g.SetConstraints="SetConstraints"}(Yh||(Yh={})),function(g){g.Mute="Mute"}(Qh||(Qh={})),function(g){g.GetServerCallId="GetServerCallId"}(Xh||(Xh={})),function(g){g.CreateStackBase="CreateStackBase",g.GetDeviceManager="GetDeviceManager",g.InitializeStackForUser="InitializeStackForUser",g.InitializeEcsBase="InitializeEcsBase",g.InitializeEcsForUser="InitializeEcsForUser",g.Dispose="Dispose"}(Zh||(Zh={})),function(g){g.GetDeviceManager="GetDeviceManager",g.GetCameras="GetCameras",g.GetMicrophones="GetMicrophones",g.GetSpeakers="GetSpeakers",g.GetCamera="GetCamera",g.SelectCamera="SelectCamera",g.GetSelectedMicrophone="GetSelectedMicrophone",g.SelectMicrophone="SelectMicrophone",g.GetSelectedSpeaker="GetSelectedSpeaker",g.SelectSpeaker="SelectSpeaker",g.RenderPreviewVideo="RenderPreviewVideo",g.AskDevicePermission="AskDevicePermission"}(eu||(eu={})),function(g){g.Dispose="Dispose",g.UpdateScalingMode="UpdateScalingMode",g.Render="Render",g.RenderRemoteStream="RenderRemoteStream",g.RenderLocalStream="RenderLocalStream"}(tu||(tu={})),function(g){g.Dispose="Dispose",g.CreateView="CreateView"}(iu||(iu={})),function(g){g.SwitchSource="SwitchSource",g.Render="Render",g.GetMediaStream="GetMediaStream",g.SetMediaStream="SetMediaStream",g.SwitchVideo="SwitchVideo",g.Feature="Feature"}(nu||(nu={})),function(g){g.SwitchSource="SwitchSource",g.GetMediaStream="GetMediaStream",g.SetMediaStream="SetMediaStream",g.Feature="Feature"}(ru||(ru={})),function(g){g.SetScalingMode="SetScalingMode",g.Start="Start",g.Stop="Stop",g.SwitchDevice="SwitchDevice",g.Dispose="Dispose"}(su||(su={})),function(g){g.Render="Render",g.GetMediaStream="GetMediaStream"}(au||(au={})),function(g){g.Start="Start",g.Resume="Resume",g.Pause="Pause",g.SetScalingMode="SetScalingMode",g.Dispose="Dispose"}(ou||(ou={})),function(g){g.Start="Start",g.Resume="Resume",g.Pause="Pause",g.SetScalingMode="SetScalingMode",g.Dispose="Dispose",g.SetSourceObject="SetSourceObject"}(lu||(lu={})),function(g){g.SourceUnavailableError="SourceUnavailableError",g.PermissionDeniedError="permissionDeniedError",g.UnknownFailureForVideoOperation="UnknownFailureForVideoOperation"}(cu||(cu={})),function(g){g.BrowserNotSupported="BrowserNotSupported",g.IncompatibleVersions="IncompatibleVersions"}(du||(du={})),function(g){g.P2P="P2P",g.Multiparty="Multiparty",g.Unknown="Unknown"}(hu||(hu={})),function(g){g.GroupJoin="groupJoin",g.RoomJoin="roomJoin",g.TeamsMeetingJoin="teamsMeetingJoin",g.TransferToParticipant="transferToParticipant",g.TransferToCall="transferToCall",g.NoContext=""}(uu||(uu={})),function(g){g.Enabled="Enabled",g.UserOverride="UserOverride",g.Disabled="Disabled"}(gu||(gu={})),function(g){g.Standard="standard",g.MusicOnHold="musicOnHold"}(pu||(pu={}));var mu,fu,Su,vu,yu,Cu,__decorate=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallInfoCommonImpl{get threadId(){return this._threadId}get participantId(){return this._tsCall.participantId}constructor(g){this._tsCall=g}initialize(g,m,f){this._logger=m,this._eventEmitter=g,this._threadId=this._tsCall.threadId,this._tsCallChangedListener=this._tsCall.changed((()=>this.threadIdChanged(this._tsCall)))}async getServerCallId(){const g=JSON.parse(await this._tsCall.getJoinBlob()),m=g?.conversationUrl;if(!m)throw new CallingCommunicationError(z.CALL.GET_SERVER_CALL_ID);return base64UrlEncoding(m)}threadIdChanged(g){this._tsCall.threadId!==this._threadId&&(this._logger.log(`threadId changed from ${this._threadId} to ${g?.threadId}`),this._threadId=this._tsCall.threadId,this._eventEmitter.emit("threadIdChanged"))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._tsCallChangedListener?.dispose(),this._eventEmitter.removeAllListeners()}}__decorate([asyncOperation(Xh.GetServerCallId),__metadata("design:type",Function),__metadata("design:paramtypes",[]),__metadata("design:returntype",Promise)],CallInfoCommonImpl.prototype,"getServerCallId",null);class CallInfoImpl extends CallInfoCommonImpl{get groupId(){return this._groupId}get roomId(){return this._roomId}get callScenario(){const g=this._tsCall.callType;return 1!==g&&2!==g?hu.Unknown:1===g?hu.P2P:hu.Multiparty}get direction(){return this._config?.isIncoming?zh.Incoming:zh.Outgoing}get initiatorKind(){return constructIdentifierKindFromMri(this._tsCall.callerMri?this._tsCall.callerMri:"").kind}get targetKind(){if(this._tsCall.groupId)return this._tsCall.groupId;if(this._config?.roomId)return this._config.roomId;if(this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.meetingCode)return"TeamsMeetingJoinLink";if(this._tsCall.transferorMri)return"Transferee";if(1===this._tsCall.participants.length){return constructIdentifierKindFromMri(this._tsCall.participants[0].id).kind}return this._tsCall.participants.filter((g=>g.id!==this._tsCall.callerMri)).map((g=>constructIdentifierKindFromMri(g.id).kind)).toString()}get transferorKind(){return this._tsCall.transferorMri?constructIdentifierKindFromMri(this._tsCall.transferorMri||"").kind:""}get context(){if(this._tsCall.groupId)return uu.GroupJoin;if(this._config?.roomId||this._roomId)return uu.RoomJoin;if(this._tsCall.meetingData?.meetingUrl||this._tsCall.meetingData?.passcode||this._tsCall.threadId)return uu.TeamsMeetingJoin;if("unknown"!==this.transferorKind){if("transfer"===this._tsCall.incomingCallType)return uu.TransferToParticipant;if("replaces"===this._tsCall.incomingCallType)return uu.TransferToCall}return uu.NoContext}constructor(g,m={}){super(g);const f=this._tsCall.groupId;this._groupId=!f||f.startsWith("19:")||f.startsWith("99:")?void 0:f,this._roomId=m.roomId,this._config=m.config}}!function(g){g.AudioRaw="AudioRaw",g.VideoRaw="VideoRaw",g.ScreenSharingRaw="ScreenSharingRaw",g.VideoRawOrScreenSharingRaw="VideoRawOrScreenSharingRaw",g.Audio="Audio",g.Video="Video"}(mu||(mu={})),function(g){g.Local="Local",g.Remote="Remote"}(fu||(fu={})),function(g){g.getMediaStream="getMediaStream",g.setMediaStream="setMediaStream",g.startEffects="startEffects",g.stopEffects="stopEffects",g.isSupported="isSupported",g.subscribe="subscribe",g.fpsWarningThresholdReached="fpsWarningThresholdReached",g.timeForEffectsWarningReached="timeForEffectsWarningReached",g.effectsError="effectsError",g.switchSource="switchSource",g.render="render"}(Su||(Su={})),function(g){g.stun="stun",g.turn="turn",g.turns="turns"}(vu||(vu={})),function(g){g.tcp="tcp",g.tls="tls",g.udp="udp"}(yu||(yu={})),function(g){g.Public_App="Public_App",g.Internal_LargeMeetingVideoRendering="Internal_LargeMeetingVideoRendering",g.Internal_RemoteVideoStreamDisposed="Internal_RemoteVideoStreamDisposed"}(Cu||(Cu={}));var _u,Eu="object"==typeof Reflect?Reflect:null,Tu=Eu&&"function"==typeof Eu.apply?Eu.apply:function ReflectApply(g,m,f){return Function.prototype.apply.call(g,m,f)};function ProcessEmitWarning(g){console&&console.warn&&console.warn(g)}_u=Eu&&"function"==typeof Eu.ownKeys?Eu.ownKeys:Object.getOwnPropertySymbols?function ReflectOwnKeys(g){return Object.getOwnPropertyNames(g).concat(Object.getOwnPropertySymbols(g))}:function ReflectOwnKeys(g){return Object.getOwnPropertyNames(g)};var Iu=Number.isNaN||function NumberIsNaN(g){return g!=g};function EventEmitter(){EventEmitter.init.call(this)}var bu=EventEmitter,Au=once;EventEmitter.EventEmitter=EventEmitter,EventEmitter.prototype._events=void 0,EventEmitter.prototype._eventsCount=0,EventEmitter.prototype._maxListeners=void 0;var Pu,Ru,wu=10;function checkListener(g){if("function"!=typeof g)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof g)}function _getMaxListeners(g){return void 0===g._maxListeners?EventEmitter.defaultMaxListeners:g._maxListeners}function _addListener(g,m,f,S){var v,C,_;if(checkListener(f),void 0===(C=g._events)?(C=g._events=Object.create(null),g._eventsCount=0):(void 0!==C.newListener&&(g.emit("newListener",m,f.listener?f.listener:f),C=g._events),_=C[m]),void 0===_)_=C[m]=f,++g._eventsCount;else if("function"==typeof _?_=C[m]=S?[f,_]:[_,f]:S?_.unshift(f):_.push(f),(v=_getMaxListeners(g))>0&&_.length>v&&!_.warned){_.warned=!0;var E=new Error("Possible EventEmitter memory leak detected. "+_.length+" "+String(m)+" listeners added. Use emitter.setMaxListeners() to increase limit");E.name="MaxListenersExceededWarning",E.emitter=g,E.type=m,E.count=_.length,ProcessEmitWarning(E)}return g}function onceWrapper(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function _onceWrap(g,m,f){var S={fired:!1,wrapFn:void 0,target:g,type:m,listener:f},v=onceWrapper.bind(S);return v.listener=f,S.wrapFn=v,v}function _listeners(g,m,f){var S=g._events;if(void 0===S)return[];var v=S[m];return void 0===v?[]:"function"==typeof v?f?[v.listener||v]:[v]:f?unwrapListeners(v):arrayClone(v,v.length)}function listenerCount(g){var m=this._events;if(void 0!==m){var f=m[g];if("function"==typeof f)return 1;if(void 0!==f)return f.length}return 0}function arrayClone(g,m){for(var f=new Array(m),S=0;S<m;++S)f[S]=g[S];return f}function spliceOne(g,m){for(;m+1<g.length;m++)g[m]=g[m+1];g.pop()}function unwrapListeners(g){for(var m=new Array(g.length),f=0;f<m.length;++f)m[f]=g[f].listener||g[f];return m}function once(g,m){return new Promise((function(f,S){function eventListener(){void 0!==v&&g.removeListener("error",v),f([].slice.call(arguments))}var v;"error"!==m&&(v=function errorListener(f){g.removeListener(m,eventListener),S(f)},g.once("error",v)),g.once(m,eventListener)}))}Object.defineProperty(EventEmitter,"defaultMaxListeners",{enumerable:!0,get:function(){return wu},set:function(g){if("number"!=typeof g||g<0||Iu(g))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+g+".");wu=g}}),EventEmitter.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function setMaxListeners(g){if("number"!=typeof g||g<0||Iu(g))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+g+".");return this._maxListeners=g,this},EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return _getMaxListeners(this)},EventEmitter.prototype.emit=function emit(g){for(var m=[],f=1;f<arguments.length;f++)m.push(arguments[f]);var S="error"===g,v=this._events;if(void 0!==v)S=S&&void 0===v.error;else if(!S)return!1;if(S){var C;if(m.length>0&&(C=m[0]),C instanceof Error)throw C;var _=new Error("Unhandled error."+(C?" ("+C.message+")":""));throw _.context=C,_}var E=v[g];if(void 0===E)return!1;if("function"==typeof E)Tu(E,this,m);else{var T=E.length,I=arrayClone(E,T);for(f=0;f<T;++f)Tu(I[f],this,m)}return!0},EventEmitter.prototype.addListener=function addListener(g,m){return _addListener(this,g,m,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function prependListener(g,m){return _addListener(this,g,m,!0)},EventEmitter.prototype.once=function once(g,m){return checkListener(m),this.on(g,_onceWrap(this,g,m)),this},EventEmitter.prototype.prependOnceListener=function prependOnceListener(g,m){return checkListener(m),this.prependListener(g,_onceWrap(this,g,m)),this},EventEmitter.prototype.removeListener=function removeListener(g,m){var f,S,v,C,_;if(checkListener(m),void 0===(S=this._events))return this;if(void 0===(f=S[g]))return this;if(f===m||f.listener===m)0==--this._eventsCount?this._events=Object.create(null):(delete S[g],S.removeListener&&this.emit("removeListener",g,f.listener||m));else if("function"!=typeof f){for(v=-1,C=f.length-1;C>=0;C--)if(f[C]===m||f[C].listener===m){_=f[C].listener,v=C;break}if(v<0)return this;0===v?f.shift():spliceOne(f,v),1===f.length&&(S[g]=f[0]),void 0!==S.removeListener&&this.emit("removeListener",g,_||m)}return this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.removeAllListeners=function removeAllListeners(g){var m,f,S;if(void 0===(f=this._events))return this;if(void 0===f.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==f[g]&&(0==--this._eventsCount?this._events=Object.create(null):delete f[g]),this;if(0===arguments.length){var v,C=Object.keys(f);for(S=0;S<C.length;++S)"removeListener"!==(v=C[S])&&this.removeAllListeners(v);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(m=f[g]))this.removeListener(g,m);else if(void 0!==m)for(S=m.length-1;S>=0;S--)this.removeListener(g,m[S]);return this},EventEmitter.prototype.listeners=function listeners(g){return _listeners(this,g,!0)},EventEmitter.prototype.rawListeners=function rawListeners(g){return _listeners(this,g,!1)},EventEmitter.listenerCount=function(g,m){return"function"==typeof g.listenerCount?g.listenerCount(m):listenerCount.call(g,m)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?_u(this._events):[]},bu.once=Au;class BaseCallAgentFeature{constructor(g){this.disposed=!1,this.callAgent=g.callAgent,this.callClient=g.callClient,this.eventEmitter=new bu.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseCallClientFeature{constructor(g){this.disposed=!1,this.callClient=g.callClient,this.eventEmitter=new bu.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseCallFeature{constructor(g){this.disposed=!1,this.call=g.call,this.callAgent=g.callAgent,this.callInfo=g.callInfo,this.eventEmitter=new bu.EventEmitter}dispose(){this.disposed||(this.eventEmitter.removeAllListeners(),this.disposed=!0)}}class BaseVideoStreamFeature{constructor(g){this.disposed=!1,this.streamInstance=g.streamInstance,this.eventEmitter=new bu.EventEmitter}}class BaseAudioStreamFeature{constructor(g){this.disposed=!1,this.streamInstance=g.streamInstance,this.eventEmitter=new bu.EventEmitter}}!function(g){g[g.CallClientFeature=0]="CallClientFeature",g[g.CallAgentFeature=1]="CallAgentFeature",g[g.CallFeature=2]="CallFeature"}(Pu||(Pu={}));class FirstPartyCallFeature extends BaseCallFeature{}class FirstPartyCallAgentFeature extends BaseCallAgentFeature{}class FirstPartyCallClientFeature extends BaseCallClientFeature{}class FirstPartyVideoStreamFeature extends BaseVideoStreamFeature{}class FirstPartyAudioStreamFeature extends BaseAudioStreamFeature{}!function(g){g.Transfer="Transfer",g.StartCaptions="StartCaptions",g.StopCaptions="StopCaptions",g.SetSpokenLanguage="SetSpokenLanguage",g.SetCaptionLanguage="SetCaptionLanguage",g.getMediaStatsCollector="getMediaStatsCollector",g.disposeAllCollectors="disposeAllCollectors"}(Ru||(Ru={}));class ExtensibleFeatureImpl{constructor(g,m,f){this._logger=g,this._featureCtorContext=m,this._featureInitContext=f,this._apiObjInstances=new Map}getApiObjectInstance(g){if(!this._apiObjInstances.has(g)){const m=new g(this._featureCtorContext);return(m instanceof FirstPartyCallFeature||m instanceof FirstPartyCallAgentFeature||m instanceof FirstPartyCallClientFeature||m instanceof FirstPartyVideoStreamFeature||m instanceof FirstPartyAudioStreamFeature)&&m.initialize(this._featureInitContext,this._logger),this._apiObjInstances.set(g,m),m}return this._apiObjInstances.get(g)}dispose(){for(const[,g]of this._apiObjInstances)g.dispose()}}const Mu={commandUrl:"",processingModes:{closedCaptions:{state:"Inactive"},realTimeTranscript:{state:"Inactive"}},spokenLanguage:""};var Du,Ou;!function(g){g.Acs="acs",g.Teams="teams",g.Unknown="unknown"}(Du||(Du={})),function(g){g.Captions="captions",g.TeamsCaptions="teams_captions"}(Ou||(Ou={}));class BaseLanguageCallFeatureImplOverTsCall{constructor(g){this._eventEmitter=g,this._captionsModeKey="closedCaptions",this._transcriptModeKey="realTimeTranscript",this._transcriptionDataId=3,this._isCaptionsBot=g=>g.id===this._captionsBotMri,this._getBotMetadata=g=>g?.endpoints?.endpointDetails[0]?.endpointMetadata??void 0,this._getBotDataMediaStreamSourceId=g=>{if(g?.endpoints?.endpointDetails[0]?.mediaStreams){let m=g?.endpoints?.endpointDetails[0]?.mediaStreams;if(m.length>0)for(let g in m)if("data"===m[g].type)return m[g].sourceId}},this._isCaptionsEnabled=g=>"Active"===g?.processingModes?.[this._captionsModeKey]?.state,this._isTranscriptionEnabled=g=>"Active"===g?.processingModes?.[this._transcriptModeKey]?.state,this._copyBotMetaData=g=>{const m=this._getBotMetadata(g)||Mu;return JSON.parse(JSON.stringify(m))},this._isSpokenLanguageChanged=g=>g?.spokenLanguage===this._acsMetadata?.spokenLanguage}dispose(){this._acsMetadata=void 0}}function callFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get callApiCtor(){return g},activationOptions:m,isCallFeature:!0}}function callClientFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get callClientApiCtor(){return g},activationOptions:m,isCallClientFeature:!0}}function videoStreamFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get videoStreamApiCtor(){return g},activationOptions:m,isVideoStreamFeature:!0}}function audioStreamFeatureFactory(g,m={activationEvent:"OnFeatureAccess"}){return{get audioStreamApiCtor(){return g},activationOptions:m,isVideoStreamFeature:!0}}function getRoundedAverage(g,m,f=100){return Math.round((g/m+Number.EPSILON)*f)/f}function sendCallFeatureUsageTelemetry(g,m,f){try{const f={correlationId:g.correlationId||"",callId:g.callId,localParticipantId:g.localParticipantId,featureName:g.featureName,featureType:g.featureType,initializationType:g.initializationType,featureDetails:g.featureDetails,additionalDetails:g.additionalDetails||{}};m.sendEvent({name:kh.acs_calling_feature_usage,tenant:so,properties:f})}catch(m){f.debug(`Unable to send ${g.featureName} feature usage telemtery`)}}function sendCallClientFeatureUsageTelemetry(g,m,f){try{const f={featureName:g.featureName,featureType:g.featureType,initializationType:g.initializationType,featureDetails:g.featureDetails};m.sendEvent({name:kh.acs_calling_feature_usage,tenant:so,properties:f})}catch(m){f.debug(`Unable to send ${g.featureName} feature usage telemetry`)}}const Nu={0:"",1:"Success",2:"NoNgcEndpoint",3:"NetworkError",4:"MediaDroppedError",5:"BadRequest",6:"CallEstablishmentTimeout",7:"CallSetupError",8:"NoPermission",9:"Missed",10:"Declined",11:"Busy",12:"Cancelled",13:"Dropped",14:"PstnInsufficientFunds",15:"PstnSkypeoutAccountBlocked",16:"PstnCouldNotConnectToSkypeProxy",17:"PstnBlockedByUs",18:"PstnBlockedRegulatoryIndia",19:"PstnInvalidNumber",20:"PstnNumberForbidden",21:"PstnCallTerminated",22:"PstnNumberUnavailable",23:"PstnEmergencyCallDenied",24:"CallNotFound",25:"LocalError",26:"NotAcceptableHere",27:"CallForwarded",28:"CallForwardedToVoicemail",29:"SkypeTokenError",30:"CallAccepted",31:"LocalHttpStackError",32:"UnknownError",33:"PstnNoSubscriptionCover",34:"SessionNotFound",35:"SessionTimedOut",36:"PstnCreditExpired",37:"PstnCreditExpiredButEnough",38:"RetargetNotSupported",39:"EnterprisePstnInternalError",40:"EnterprisePstnUnavailable",41:"EnterprisePstnForbidden",42:"EnterprisePstnInvalidNumber",43:"EnterprisePstnMiscError",44:"Kicked",45:"NetworkRequestTimeoutError",46:"CallDoesNotExist",47:"MediaSetupFailure",48:"ServiceUnavailable",49:"SignalingError",50:"ConversationEstablishmentFailed",51:"TemporarilyUnavailable",52:"CannotConnectToNetworkError",53:"MediaRelayWhiteListingIssue",54:"NoSignalingFromPeer",55:"DeniedInLobby",56:"TimedOutInLobby",57:"CallFailedConflict",58:"DevicePermissionDenied",59:"ConfParticipantCountLimitReached",60:"ActionNotAllowed",61:"Abandoned",62:"ForbiddenDueToPolicy",63:"InsufficientCapabilitiesForCallee",64:"UserBlocked",65:"AccessDenied",66:"AnonymousJoinDisabledByPolicy",67:"NoLobbyForBroadcastJoin",68:"NotAllowedDueToInformationBarrier",69:"BroadcastLimitReached",70:"TeamParkPolicyDisabled",71:"B2bJoinDisabledByPolicy",72:"LocationBasedRoutingError",73:"ConfLobbyParticipantCountLimitReached",74:"DowngradeToStreamingClient",75:"CallRedirected",76:"CallIsEndToEndEncrypted"},convertTerminatedReasonToString=g=>{const m="UnknownError";return"number"==typeof g&&Nu[g]||m},ku={0:"",1:"AddingFailed",2:"NoResponse",3:"Declined",4:"NotReachable",5:"Blocked",6:"NotFriendOrAuthorized",7:"CallLimitReached",8:"CallNotFound",9:"NetworkError",10:"MediaDroppedError",11:"OtherError",12:"PstnInsufficientFunds",13:"PstnSkypeoutAccountBlocked",14:"PstnCouldNotConnectToSkypeProxy",15:"PstnBlockedByUs",16:"PstnBlockedRegulatoryIndia",17:"PstnInvalidNumber",18:"PstnNumberForbidden",19:"Busy",20:"PstnCallTerminated",21:"PstnNumberUnavailable",22:"PstnEmergencyCallDenied",23:"Cancelled",24:"Dropped",25:"PstnNoSubscriptionCover",26:"PstnCreditExpired",27:"PstnCreditExpiredButEnough",28:"EnterprisePstnInternalError",29:"EnterprisePstnUnavailable",30:"EnterprisePstnForbidden",31:"EnterprisePstnInvalidNumber",32:"EnterprisePstnMiscError",33:"Kicked",34:"NetworkRequestTimeoutError",35:"CallDoesNotExist",36:"MediaSetupFailure",37:"ServiceUnavailable",38:"SignalingError",39:"ConversationEstablishmentFailed",40:"TemporarilyUnavailable",41:"CannotConnectToNetworkError",42:"NoSignalingFromPeer",43:"ParticipantDoesNotExist",44:"DeniedInLobby",45:"TimedOutInLobby",46:"ConfParticipantCountLimitReached",47:"Abandoned",48:"ActionNotAllowed",49:"ForbiddenDueToPolicy",50:"InsufficientCapabilitiesForCallee",51:"AccessDenied",52:"NoPermission",53:"AnonymousJoinDisabledByPolicy",54:"NoLobbyForBroadcastJoin",55:"NotAllowedDueToInformationBarrier",56:"BroadcastLimitReached",57:"B2bJoinDisabledByPolicy",58:"LocationBasedRoutingError",59:"ConfLobbyParticipantCountLimitReached",60:"LobbyUserLeft"},convertParticipantStateReasonToString=g=>{const m="UnknownError";return"number"==typeof g&&ku[g]||m},Lu={0:"None",1:"Incoming Call",2:"Connecting",3:"Connected",4:"LocalHold",5:"RemoteHold",10:"InLobby",9:"EarlyMedia",6:"Disconnecting",7:"Disconnected",8:"Unknown",11:"Unknown",12:"Unknown",13:"Unknown",14:"Unknown",15:"Unknown"},Fu={0:"None",1:"RealTime",2:"Streaming"};function toDtmfTone(g){switch(g){case"Num0":return 0;case"Num1":return 1;case"Num2":return 2;case"Num3":return 3;case"Num4":return 4;case"Num5":return 5;case"Num6":return 6;case"Num7":return 7;case"Num8":return 8;case"Num9":return 9;case"Star":return 10;case"Pound":return 11;case"A":return 12;case"B":return 13;case"C":return 14;case"D":return 15;case"Flash":return 16;default:throw new CallingCommunicationError(z.CALL.INVALID_DTMF_TONE)}}function getCallEndReason(g,m){let f=0,S=0,v=Bo,C=[];return g.tsCall&&(f=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.callControllerCode||0,S=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.callControllerSubCode||0,C=g.tsCall.callEndDiagnosticsInfo&&g.tsCall.callEndDiagnosticsInfo.resultCategories||["Success"]),v=convertTerminatedReasonToString(m||g.tsCall?.terminatedReason||0),g.logger.error(`Call end reason=${v}, code=${f}, subCode=${S}, resultCategories=${C.toString()}`),{callEndReason:{message:v,code:f,subCode:S,resultCategories:C},callingCommunicationError:new CallingCommunicationError({message:v,code:f,subCode:S,resultCategories:C})}}function getRemoteParticipantCallEndReason(g,m,f){let S=0,v=0,C=Bo,_=[];if(m?.callEndDiagnosticsInfo)C=convertParticipantStateReasonToString(f||m.stateReason||0),S=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.callControllerCode||0,v=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.callControllerSubCode||0,_=m.callEndDiagnosticsInfo&&m.callEndDiagnosticsInfo.resultCategories||[];else{let m=getCallEndReason(g,f);S=m.callEndReason.code,v=m.callEndReason.subCode||0,_=m.callEndReason.resultCategories,C=m.callEndReason.message}return g.logger[0===S?"info":"error"](`Participant call end reason=${C}, code=${S}, subCode=${v}, resultCategories=${_.toString()}`),{callEndReason:{message:C,code:S,subCode:v,resultCategories:_},callingCommunicationError:new CallingCommunicationError({message:C,code:S,subCode:v,resultCategories:_})}}function handleVideoOperationFailure(g,m){let f;switch(m?.type?m.type:cu.UnknownFailureForVideoOperation){case cu.SourceUnavailableError:f=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SOURCE_UNAVAILABLE);break;case cu.PermissionDeniedError:f=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.PERMISSION_DENIED);break;default:f=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.UNKNOWN)}return f}function handleLobbyFailure(g,m,f){const S=void 0===m?.code?500:m?._code,v=m?.subCode||m?._subCode||0;return new CallingCommunicationError({message:f+", reason: "+(m?.phrase||m?.message||"unknown error"),code:S,subCode:v,resultCategories:m?.resultCategories||[]})}function handleRaiseHandFailure(g,m){return new CallingCommunicationError({message:m.message,code:g?.response?.status||m.code,subCode:m.subCode,resultCategories:m.resultCategories},g)}function handleFetchPoliciesFromAcsMiddleTierFailure(g,m){return new CallingCommunicationError({message:g?.response?.data?.operationFailure?.phrase||m.message,code:g?.response?.data?.operationFailure?.code||m.code,subCode:g?.response?.data?.operationFailure?.subCode||m.subCode,resultCategories:g?.response?.data?.operationFailure?.resultCategories||m.resultCategories},g)}function extractCommunicationServicesErrorForTelemetry(g){return{communicationServicesError:{message:g.message||"Unknown error",code:void 0===g.code?H:g.code,subCode:g.subCode||0,resultCategories:void 0===g.resultCategories||0===g.resultCategories.length?["UnexpectedClientError"]:g.resultCategories}}}function extractCallEndReasonForTelemetry(g){return{callEndReason:{message:g.message,code:void 0===g.code?H:g.code,subCode:g.subCode||0,resultCategories:void 0===g.resultCategories||0===g.resultCategories.length?["UnexpectedClientError"]:g.resultCategories}}}var __decorate$1=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$1=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const xu=Date.UTC(1900,0,1),Uu=3;class CaptionsCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new CaptionsCallFeatureImplOverTsCall(this.eventEmitter)}initialize(g,m){const f=generateGuid();this._impl.initialize(g.tsCall,g.call,g.callAgent,g.callAgent.getHttpRequestHelper(),g.telemetryLogManager,m,this._telemetryStartTime,f),this._logger=m,this._telemetryStartTime=+Date.now(),this._telemetryLogManager=g.telemetryLogManager,this._call=g.call}get name(){return this._sendFeatureUsage("name",Lh.getter),this._captionsTelemetryType.toString()}get _captionsTelemetryType(){return"TeamsCaptions"===this._impl.kind?Ou.TeamsCaptions:Ou.Captions}get captions(){return this._impl.captions}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:this._captionsTelemetryType,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class CaptionsCommonImpl{constructor(g,m){this._eventEmitter=m,this._impl=g}async startCaptions(g){await this._impl.startCaptions(g)}async stopCaptions(){await this._impl.stopCaptions()}async setSpokenLanguage(g){await this._impl.setSpokenLanguage(g)}get supportedSpokenLanguages(){return this._impl.supportedSpokenLanguages}get isCaptionsFeatureActive(){return this._impl.isCaptionsFeatureActive}get activeSpokenLanguage(){return this._impl.activeSpokenLanguage}get kind(){return this._impl.kind}}class CaptionsImpl extends CaptionsCommonImpl{constructor(g,m){super(g,m)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}}class TeamsCaptionsImpl extends CaptionsCommonImpl{constructor(g,m){super(g,m)}get supportedCaptionLanguages(){return this._impl.supportedCaptionLanguages}get activeCaptionLanguage(){return this._impl.activeCaptionLanguage}async setCaptionLanguage(g){await this._impl.setCaptionLanguage(g)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}}class CaptionsCallFeatureImplOverTsCall extends BaseLanguageCallFeatureImplOverTsCall{constructor(g,m,f,S){super(g),this._botParticipantId="",this._isCteUser=!1,this._isCaptionsActive=!1,this._firstTimeActive=!1,this._ecsCaptionsEnabled=!1,this._ecsSpokenLanguagesEnabled=!1,this._ecsSpokenLanguages=[],this._ecsCaptionLanguagesEnabled=!1,this._ecsCaptionLanguages=[],this._ecsAmtPolicyUrlSuffix="",this._hasReportedCaptionParseFailure=!1,this._hasReceivedFirstCaption=!1,this._currentLanguage="",this._currentCaptionLanguage="",this._participantSequenceIdMap={},this._addParticipantPromise=null,this._dataChannelHandler={onStarted:async(g,m)=>{},onStopped:async g=>{},onDataReceived:async(g,m,f)=>{let S;try{S=JSON.parse(m.toString())}catch(g){try{if(void 0===this._textDecoder)throw new Error("TextDecoder undefined.");S=JSON.parse(this._textDecoder.decode(m))}catch(g){return this._logger.error("Failed to parse Captions result",g),void(this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(Vh.FirstCaptionParsingError,Lh.failure,"",0,Uh.Unexpected,"Could not decode data packet.")))}}if(S){let g=[];S.textTracks?g=S.textTracks:S.recognitionResults&&(g=S.recognitionResults),g.forEach((g=>{try{const[m,S]=g.id.split("/");let v=parseInt(S,10);if(this._participantSequenceIdMap[g.userId]&&this._botParticipantId==m&&this._participantSequenceIdMap[g.userId]>v)return;this._botParticipantId=m,this._participantSequenceIdMap[g.userId]=v;const C=this._tsCall.participants.find((m=>m.id===g.userId))?.displayName||(this._internalCallAgent.getUserMri()===g.userId?this._internalCallAgent?.displayName:void 0),_={resultType:g.isFinal?"Final":"Partial",captionText:g.text,spokenText:g.originalText??g.text,timestamp:new Date(new Date(g.timestampAudioSent/1e4).getTime()+xu),speaker:{identifier:constructIdentifierKindFromMri(g.userId),displayName:C},spokenLanguage:g.spokenLanguage,captionLanguage:g.trackLanguage};if(this._currentLanguage!=g.spokenLanguage&&(this._currentLanguage=g.spokenLanguage,this._eventEmitter.emit("SpokenLanguageChanged")),!this.isCaptionsFeatureActive||this._mediaStreamSourceId!==f)return;this._hasReceivedFirstCaption||(this._hasReceivedFirstCaption=!0,this._sendCaptionsEvent(Vh.FirstCaptionReceived,Lh.success,"",0)),this._eventEmitter.emit("CaptionsReceived",_)}catch(g){this._logger.error("Failed to parse Captions result",g),this._hasReportedCaptionParseFailure||(this._hasReportedCaptionParseFailure=!0,this._sendCaptionsEvent(Vh.FirstCaptionParsingError,Lh.failure,"",0,Uh.Unexpected,"Error thrown during incoming caption result mapping."))}}))}}},this._handleBotRemoved=g=>{this._acsMetadata&&this._isCaptionsBot(g)&&(this.isCaptionsFeatureActive&&(this._isCaptionsActive=!1,this._eventEmitter.emit("CaptionsActiveChanged")),this._acsMetadata=void 0,this._firstTimeActive=!1)},this._telemetryStartTime=Date.now()}get isCaptionsFeatureActive(){return!!this._acsMetadata&&this._isCaptionsEnabled(this._acsMetadata)&&this._isCaptionsActive}get supportedSpokenLanguages(){return this._ecsSpokenLanguages}get supportedCaptionLanguages(){return this._ecsCaptionLanguages}get captions(){return this._captions}get kind(){return this._name===Ou.TeamsCaptions?"TeamsCaptions":"Captions"}get activeSpokenLanguage(){return this._currentLanguage}get activeCaptionLanguage(){return this._currentCaptionLanguage}get isTeamsConversationType(){return To.indexOf(this._tsCall.conversationType)>-1}get isTeamsUserInCall(){for(let g of this._tsCall.participants)if("microsoftTeamsUser"===constructIdentifierKindFromMri(g.id).kind)return!0;return!1}get isTeamsCallKind(){return this._call.kind===Y.TeamsCall}get isTeamsCaptionsBotInCall(){for(let g of this._tsCall.participants)if(g.id===getAcsEcsConfig().captions.teams.botMri)return!0;return!1}updateParticipantTranscriptionPrefsMetadata(g){let m;for(let g in this._tsCall.endpoints?.endpointDetails)if(this._tsCall.endpoints?.endpointDetails[g].participantId===this._tsCall.participantId){m=this._tsCall.endpoints?.endpointDetails[g];break}const f=m?.endpointMetadata??{transcriptionPrefs:{}};g?f.transcriptionPrefs?.closedCaptions?f.transcriptionPrefs.closedCaptions=g:f.transcriptionPrefs={closedCaptions:g}:f.transcriptionPrefs?.closedCaptions&&delete f.transcriptionPrefs.closedCaptions,this._tsCall.updateEndpointMetadata(JSON.stringify(f))}initialize(g,m,f,S,v,C,_,E){this._logger=C.createChild((()=>`CaptionsFeature::Call(id='${g.callId}', state='${g.state}')`)),this._tsCall=g,this._call=m,this._internalCallAgent=f,this._httpRequestHelper=S,this._telemetryLogManager=v,this._telemetryStartTime=_,this._isCteUser=f.isCteUser(),this._ecsCaptionsEnabled=getAcsEcsConfig().captions.enabled,this._name=this.isTeamsConversationType||this._isCteUser||this.isTeamsUserInCall||this.isTeamsCaptionsBotInCall||this.isTeamsCallKind?Ou.TeamsCaptions:Ou.Captions,this.updateCaptionsData(this._name),this._sendCaptionsEvent(Vh.InitializeCaptions,Lh.initialize,E,this._telemetryStartTime),this._initializationPromise=new Promise(((g,m)=>{this._initializeAsync(E).then((m=>g())).catch((g=>m(g)))}))}async _initializeAsync(g){try{this._textDecoder=new TextDecoder,this._tsCall.on("participantAdded",(async m=>{if(this._captions&&"Captions"===this._captions.kind&&"microsoftTeamsUser"===constructIdentifierKindFromMri(m.id).kind){if(this._captionsBotMri)try{await this._tsCall.removeParticipant(this._captionsBotMri)}catch(f){const S=new CallingCommunicationError({message:convertParticipantStateReasonToString(f),code:m.callEndDiagnosticsInfo?.callControllerCode||0,subCode:m.callEndDiagnosticsInfo?.callControllerSubCode||0,resultCategories:["UnexpectedClientError"]},f);this._sendCaptionsEvent(Vh.CaptionsKindChanged,Lh.failure,g,this._telemetryStartTime,Uh.Unexpected,S.message,S.code,S.subCode,extractCommunicationServicesErrorForTelemetry(S))}this.updateCaptionsData(Ou.TeamsCaptions),this._isCaptionsActive&&(this._currentLanguage&&this._ecsSpokenLanguages.includes(this._currentLanguage)?await this._captions.startCaptions({spokenLanguage:this._currentLanguage}):await this._captions.startCaptions()),this._eventEmitter.emit("CaptionsKindChanged"),this._sendCaptionsEvent(Vh.CaptionsKindChanged,Lh.success,g,this._telemetryStartTime)}})),this._tsCall.on("participantAdded",(async g=>{this._isCaptionsBot(g)&&(this._acsMetadata||(this._acsMetadata=this._copyBotMetaData(g),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(g),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler)))})),this._tsCall.on("participantRemoved",(async g=>{this._isCaptionsBot(g)&&this._handleBotRemoved(g)})),this._tsCall.on("participantUpdated",(async g=>{this._getBotMetadata(g)&&this._isCaptionsBot(g)&&this._acsMetadata&&(this._acsMetadata=this._copyBotMetaData(g),this._mediaStreamSourceId=this._getBotDataMediaStreamSourceId(g),!this._firstTimeActive&&this.isCaptionsFeatureActive&&(this._firstTimeActive=!0,this._eventEmitter.emit("CaptionsActiveChanged")))}));const m=this._tsCall.participants.find((g=>g.id===this._captionsBotMri));m&&(this._acsMetadata=this._copyBotMetaData(m),this._mediaStreamSourceId=m.getSourceIdForMediaType(3),await this._tsCall.startDataChannel(),await this._tsCall.dataChannelAdapter.addHandler(this._transcriptionDataId,this._dataChannelHandler))}catch(m){const f=new CallingCommunicationError(z.FEATURES.CAPTIONS.INITIALIZE);throw this._sendCaptionsEvent(Vh.InitializeCaptions,Lh.failure,g,this._telemetryStartTime,Uh.Unexpected,f.message,f.code,f.subCode,extractCommunicationServicesErrorForTelemetry(f)),this._logger.error(f.message),f}}updateCaptionsData(g){g===Ou.Captions?(this._name=Ou.Captions,this._captionsBotMri=getAcsEcsConfig().captions.acs.botMri,this._clientInfo=getAcsEcsConfig().captions.acs.clientInfo.ring,this._ecsSpokenLanguagesEnabled=getAcsEcsConfig().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=getAcsEcsConfig().captions.teams.spokenLanguages.languages,this._captions=new CaptionsImpl(this,this._eventEmitter)):g===Ou.TeamsCaptions&&(this._name=Ou.TeamsCaptions,this._captionsBotMri=getAcsEcsConfig().captions.teams.botMri,this._clientInfo=getAcsEcsConfig().captions.teams.clientInfo.ring,this._ecsSpokenLanguagesEnabled=getAcsEcsConfig().captions.teams.spokenLanguages.enabled,this._ecsSpokenLanguages=getAcsEcsConfig().captions.teams.spokenLanguages.languages,this._ecsCaptionLanguagesEnabled=getAcsEcsConfig().captions.teams.captionLanguages.enabled,this._ecsCaptionLanguages=getAcsEcsConfig().captions.teams.captionLanguages.languages,this._ecsAmtPolicyUrlSuffix=getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,this._captions=new TeamsCaptionsImpl(this,this._eventEmitter))}async startCaptions(g){this._telemetryStartTime=+Date.now();const m=generateGuid(),f=g?.spokenLanguage||yo;if(this._sendFeatureUsage("startCaptions",Lh.attempt),this._sendCaptionsEvent(Vh.StartCaptions,Lh.attempt,m,0),this._addParticipantPromise){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.ALREADY_STARTING);return this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("startCaptions",Lh.failure)}if(await this._initializationPromise,!this._ecsCaptionsEnabled){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.DISABLED);return this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Lh.failure),void this._logger.error("Feature is not enabled.")}if(!this._ecsSpokenLanguages.includes(f)){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED);throw this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),this._logger.error("Spoken language requested is not supported."),g}if(this._name===Ou.TeamsCaptions&&(this._mtPolicy=this._internalCallAgent.mtPolicyService,this._isCteUser)){try{this._mtPolicy.initialize({localParticipant:this._internalCallAgent.getUserMri(),skypeToken:await this._internalCallAgent.tokenProvider(),telemetryLogManager:this._telemetryLogManager}),await this._mtPolicy.fetchUserPoliciesFromAcsMiddleTier(this._tsCall.callId,this._tsCall.participantId,{policyUrlSuffix:this._ecsAmtPolicyUrlSuffix,userPolicies:["TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata"]}),this._mtCaptionsPolicyResult=JSON.parse(this._mtPolicy.getTeamsUserCaptionsPoliciesData())}catch(g){const f=new CallingCommunicationError(z.FEATURES.CAPTIONS.CTE_POLICY_FETCH_FAIL,g);this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,f.message,f.code,f.subCode,extractCommunicationServicesErrorForTelemetry(f)),this._logger.error("Unable to fetch policies")}if(this._mtCaptionsPolicyResult)if(this.isTeamsConversationType){if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForMeeting){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.MEETING_POLICY_DISABLED);throw this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Lh.failure),this._logger.error(g.message),g}}else if(!this._mtCaptionsPolicyResult?.isLiveCaptionsEnabledForCalling){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.CALLING_POLICY_DISABLED);throw this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Lh.failure),this._logger.error(g.message),g}}if(this._acsMetadata){if(this._isCaptionsEnabled(this._acsMetadata))if(this._isCaptionsActive){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.ALREADY_ACTIVE);this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("startCaptions",Lh.failure)}else this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(Vh.StartCaptions,Lh.success,m,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Lh.success),this._eventEmitter.emit("CaptionsActiveChanged")}else try{const g={participantInvitationData:{botData:{clientInfo:this._clientInfo,consumerType:"ACS",initiatorUserToken:this._name===Ou.TeamsCaptions?"":await this._internalCallAgent.tokenProvider(),spokenLanguage:f,mode:Eo,transcriptionModes:[this._captionsModeKey]}}};this._addParticipantPromise=this._tsCall.addParticipant(this._captionsBotMri,g),await this._addParticipantPromise,this._addParticipantPromise=null,this._currentLanguage!==f&&(this._currentLanguage=f,this._eventEmitter.emit("SpokenLanguageChanged")),this._isCaptionsActive=!0,"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata(!0),this._sendCaptionsEvent(Vh.StartCaptions,Lh.success,m,this._telemetryStartTime),this._sendFeatureUsage("startCaptions",Lh.success)}catch(g){const f=new CallingCommunicationError(z.FEATURES.CAPTIONS.START_FAILED);throw this._sendCaptionsEvent(Vh.StartCaptions,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,f.message,f.code,f.subCode,extractCommunicationServicesErrorForTelemetry(f)),this._sendFeatureUsage("startCaptions",Lh.failure),this._logger.error(f.message),f}}async stopCaptions(){this._telemetryStartTime=+Date.now();const g=generateGuid();if(this._sendFeatureUsage("stopCaptions",Lh.attempt),this._sendCaptionsEvent(Vh.StopCaptions,Lh.attempt,g,0),this.isCaptionsFeatureActive)this._isCaptionsActive=!1,this._sendCaptionsEvent(Vh.StopCaptions,Lh.success,g,this._telemetryStartTime),this._sendFeatureUsage("stopCaptions",Lh.success),this._eventEmitter.emit("CaptionsActiveChanged"),"Captions"===this._captions.kind&&this.updateParticipantTranscriptionPrefsMetadata();else{const m=new CallingCommunicationError(z.FEATURES.CAPTIONS.STOP_NOT_ACTIVE);this._sendCaptionsEvent(Vh.StopCaptions,Lh.failure,g,this._telemetryStartTime,Uh.Expected,m.message,m.code,m.subCode,extractCommunicationServicesErrorForTelemetry(m)),this._logger.warn(m.message)}this._isCaptionsActive=!1}async setSpokenLanguage(g){this._telemetryStartTime=+Date.now();const m=generateGuid();if(this._sendFeatureUsage("setSpokenLanguage",Lh.attempt),this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.attempt,m,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),this._logger.error(g.message),g}if(!this._isCaptionsActive){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_LANGUAGE_NOT_STARTED);return this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),void this._logger.warn(g.message)}if(!this._ecsSpokenLanguagesEnabled){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.SPOKEN_LANG_DISABLED);return this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),void this._logger.error(g.message)}if(g==this._currentLanguage){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.SPOKEN_LANGUAGE_ALREADY_SET);return this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("setSpokenLanguage",Lh.failure)}if(!this._ecsSpokenLanguages.includes(g)){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.SPOKEN_LANG_UNSUPPORTED);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),this._logger.error(g.message),g}try{const f=await this._internalCallAgent.tokenProvider();if(!f){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_LANGUAGE_GET_TOKEN);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),g}await this._sendSetLanguageRequest(g,"",f,this._acsMetadata.commandUrl),this._currentLanguage!==g&&(this._currentLanguage=g,this._eventEmitter.emit("SpokenLanguageChanged")),this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.success,m,this._telemetryStartTime),this._sendFeatureUsage("setSpokenLanguage",Lh.success)}catch(g){const f=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_LANGUAGE_FAILED,g);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,f.message,f.code,f.subCode,extractCommunicationServicesErrorForTelemetry(f)),this._sendFeatureUsage("setSpokenLanguage",Lh.failure),this._logger.error(f.message),f}}async setCaptionLanguage(g){this._telemetryStartTime=+Date.now();const m=generateGuid();if(this._sendFeatureUsage("setCaptionLanguage",Lh.attempt),this._sendCaptionsEvent(Vh.SetCaptionLanguage,Lh.attempt,m,0),await this._initializationPromise,!this._acsMetadata?.commandUrl){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_STARTED);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),this._logger.error(g.message),g}if(!this._isCaptionsActive){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_CAPTIONS_NOT_ACTIVE);return this._sendCaptionsEvent(Vh.SetCaptionLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),void this._logger.warn(g.message)}if(!this._ecsCaptionLanguagesEnabled){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.CAPTIONS_LANG_DISABLED);return this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),void this._logger.error(g.message)}if(this._isTranslatedCaptionsAllowed||this._tsCall.meetingDetails?.meetingCapability&&this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions&&(this._isTranslatedCaptionsAllowed=this._tsCall.meetingDetails.meetingCapability.allowTranslatedCaptions),!(this.isTeamsConversationType&&this._isTranslatedCaptionsAllowed||this._mtCaptionsPolicyResult?.isTeamsProMgmtSkuAvailable)){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.CAPTIONS_LANG_TEAMS_LICENSE);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),this._logger.error(g.message),g}if(g==this._currentCaptionLanguage){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.CAPTIONS_LANG_ALREADY_SET);return this._sendCaptionsEvent(Vh.SetCaptionLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),void this._sendFeatureUsage("setCaptionLanguage",Lh.failure)}if(!this._ecsCaptionLanguages.includes(g)){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.CAPTIONS_LANG_UNSUPPORTED);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Expected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),this._logger.error(g.message),g}try{const f=await this._internalCallAgent.tokenProvider();if(!f){const g=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_CAPTIONS_GET_TOKEN);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,g.message,g.code,g.subCode,extractCommunicationServicesErrorForTelemetry(g)),g}await this._sendSetLanguageRequest("",g,f,this._acsMetadata.commandUrl),this._currentCaptionLanguage!==g&&(this._currentCaptionLanguage=g,this._eventEmitter.emit("CaptionLanguageChanged")),this._sendCaptionsEvent(Vh.SetCaptionLanguage,Lh.success,m,this._telemetryStartTime),this._sendFeatureUsage("setCaptionLanguage",Lh.success)}catch(g){const f=new CallingCommunicationError(z.FEATURES.CAPTIONS.UPDATE_CAPTIONS_FAILED,g);throw this._sendCaptionsEvent(Vh.SetSpokenLanguage,Lh.failure,m,this._telemetryStartTime,Uh.Unexpected,f.message,f.code,f.subCode,extractCommunicationServicesErrorForTelemetry(f)),this._sendFeatureUsage("setCaptionLanguage",Lh.failure),this._logger.error(f.message),f}}dispose(){this._acsMetadata=void 0,this._textDecoder=void 0}_sendCaptionsEvent(g,m,f,S,v,C,_,E,T){let I={eventName:kh.acs_calling_captions,callId:this._call.id,correlationId:f,isExpected:v??"",localParticipantId:this._call.tsCall.participantId,featureType:this._name,featureDetails:{step:g},kindOfEvent:m,timestampInfo:S?{deltaTimeInMs:+Date.now()-S}:"",additionalDetails:{failureReason:C,code:_,subCode:E,...T}};try{this._telemetryLogManager.sendEvent({name:kh.acs_calling_captions,tenant:so,properties:I})}catch(g){this._logger.debug(`Unable to send ${this._name} feature usage telemtery`)}}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this._name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}async _sendSetLanguageRequest(g,m,f,S){const v=g?{type:_o,spokenLanguage:g}:{type:_o,subtitleLanguages:[m]},C={timestamp:(new Date).toISOString(),participantMri:this._internalCallAgent.getUserMri(),participantLegId:this._tsCall.participantId,action:_o,mode:Eo,actionParameters:v},_={headers:{"X-Microsoft-Skype-Chain-ID":this._tsCall.callId,Authorization:`Bearer ${f}`,"x-skypetoken":f},withCredentials:!0};return this._httpRequestHelper.sendRequestWithRetry("post",S,C,_,Uu)}}__decorate$1([asyncOperation(Ru.StartCaptions),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[Object]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"startCaptions",null),__decorate$1([asyncOperation(Ru.StopCaptions),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"stopCaptions",null),__decorate$1([asyncOperation(Ru.SetSpokenLanguage),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"setSpokenLanguage",null),__decorate$1([asyncOperation(Ru.SetCaptionLanguage),__metadata$1("design:type",Function),__metadata$1("design:paramtypes",[String]),__metadata$1("design:returntype",Promise)],CaptionsCallFeatureImplOverTsCall.prototype,"setCaptionLanguage",null);class RaiseHandCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new RaiseHandCallImplOverTsCall(this.eventEmitter)}get name(){return"RaiseHand"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}async raiseHand(){return this._impl.raiseHand()}async lowerHand(){return this._impl.lowerHand()}async lowerHands(g){return this._impl.lowerHands(g)}lowerAllHands(){return this._impl.lowerAllHands()}getRaisedHands(){return this._sendFeatureUsage("getRaisedHands",Lh.getter),this._impl.raisedHands}on(g,m){this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class RaiseHandCallImplOverTsCall{constructor(g){this.typeRankComparator=(g,m)=>void 0===g.publishedState?-1:void 0===m.publishedState?1:g.publishedState.typeRank-m.publishedState.typeRank,this._eventEmitter=g,this._currentRaiseHandStates=new Map}initialize(g,m,f,S){this._logger=S.createChild((()=>`RaiseHandFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=f,this._internalCallAgent=m,this._sendFeatureUsage("initialize",Lh.initialize);try{let extractMRIs=g=>new Map(this.getPublishedState(g).sort(this.typeRankComparator).map((g=>[g.id,g])));this._tsCall.on("publishedStatesChanged",(async g=>{let m=extractMRIs(g),f=this._currentRaiseHandStates;this._currentRaiseHandStates=m,this._currentRaiseHandStates.forEach(((g,m)=>{f.has(m)||this._eventEmitter.emit("raisedHandEvent",{identifier:constructIdentifierKindFromMri(m)})})),f.forEach(((g,m)=>{this._currentRaiseHandStates.has(m)||this._eventEmitter.emit("loweredHandEvent",{identifier:constructIdentifierKindFromMri(m)})}))})),this._tsCall.publishedStates&&(this._currentRaiseHandStates=extractMRIs(this._tsCall.publishedStates)),this._sendFeatureUsage("initialize",Lh.success)}catch(g){throw this._logger.error("Could not initialize raise hand feature.",g),this._sendFeatureUsage("initialize",Lh.failure),new CallingCommunicationError(z.FEATURES.RAISE_HAND.INITIALIZE,g)}}async raiseHand(){this._sendFeatureUsage("raiseHand",Lh.attempt);try{if(void 0!==this.getLocalRaiseHandState())return void this._sendFeatureUsage("raiseHand",Lh.failure);const g={level:"user",type:"raiseHands",content:"{}"};if(!await this._tsCall.publishState(g,w.generateCauseId()))throw new CallingCommunicationError(z.FEATURES.RAISE_HAND.RAISE_HAND_PUBLISH_STATE);this._sendFeatureUsage("raiseHand",Lh.success)}catch(g){throw this._logger.error("Could not change a participant state. Code: ",g?.response?.status),this._sendFeatureUsage("raiseHand",Lh.failure),handleRaiseHandFailure(g,z.FEATURES.RAISE_HAND.RAISE_HAND_FAIL)}}async lowerHand(){this._sendFeatureUsage("lowerHand",Lh.attempt);try{const g=this.getLocalRaiseHandState();if(void 0===g)return void this._sendFeatureUsage("lowerHand",Lh.failure);const m={stateIds:[g]};await this._tsCall.removeState(m,w.generateCauseId()),this._sendFeatureUsage("lowerHand",Lh.success)}catch(g){throw this._logger.error("Could not change a participant state. Code: ",g?.response?.status),this._sendFeatureUsage("lowerHand",Lh.failure),handleRaiseHandFailure(g,z.FEATURES.RAISE_HAND.LOWER_HAND_FAIL)}}async lowerHands(g){this._sendFeatureUsage("lowerHands",Lh.attempt);try{if(0===g.length)return void this._sendFeatureUsage("lowerHands",Lh.failure);if(0===this._currentRaiseHandStates.size)return void this._sendFeatureUsage("lowerHands",Lh.failure);const m=g.map((g=>getMriFromIdentifier(g))),f=this.findStateIdsForParticipantIds(m);await this._tsCall.removeState({stateIds:f},w.generateCauseId()),this._sendFeatureUsage("lowerHands",Lh.success)}catch(g){throw this._logger.error("Could not change a participant state.",g),this._sendFeatureUsage("lowerHands",Lh.failure),handleRaiseHandFailure(g,z.FEATURES.RAISE_HAND.LOWER_REMOTEPARTICIPANTS_HANDS_FAIL)}}async lowerAllHands(){this._sendFeatureUsage("lowerAllHands",Lh.attempt);try{await this._tsCall.removeStatesForEveryone({type:"raiseHands"},w.generateCauseId()),this._sendFeatureUsage("lowerAllHands",Lh.success)}catch(g){throw this._logger.error("Could not change a participant state.",g),this._sendFeatureUsage("lowerAllHands",Lh.failure),handleRaiseHandFailure(g,z.FEATURES.RAISE_HAND.LOWER_ALL_HANDS_FAIL)}}get raisedHands(){return 0===this._currentRaiseHandStates.size?[]:Array.from(this._currentRaiseHandStates.keys()).map(((g,m)=>({identifier:constructIdentifierKindFromMri(g),order:m+1})))}getLocalRaiseHandState(){const g=this.findStateIdsForParticipantIds([this._internalCallAgent.getUserMri()]);if(g&&g.length>0)return g[0]}findStateIdsForParticipantIds(g){return g&&0!==this._currentRaiseHandStates.size?Array.from(this._currentRaiseHandStates.entries()).filter((m=>g.includes(m[0]))).map((g=>g[1]?.publishedState?.stateId)).filter((g=>!!g)):[]}getPublishedState(g){return g.typeStates.filter((g=>"raiseHands"===g.type)).map((g=>g.participantStates)).flat()}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"RaiseHand",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}var Vu;!function(g){g.turnVideoOn="turnVideoOn",g.unmuteMic="unmuteMic",g.shareScreen="shareScreen",g.removeParticipant="removeParticipant",g.hangUpForEveryOne="hangUpForEveryOne",g.addCommunicationUser="addCommunicationUser",g.addTeamsUser="addTeamsUser",g.addPhoneNumber="addPhoneNumber",g.manageLobby="manageLobby",g.spotlightParticipant="spotlightParticipant",g.removeParticipantsSpotlight="removeParticipantsSpotlight",g.blurBackground="blurBackground",g.startLiveCaptions="startLiveCaptions",g.stopLiveCaptions="stopLiveCaptions",g.raiseHand="raiseHand",g.pstnDialOut="pstnDialOut",g.muteOthers="muteOthers",g.useReactions="useReactions"}(Vu||(Vu={}));class RoomsCapabilityResolver{constructor(g,m){this._logger=g,this._ecsConfig=m}getResolvedCapabilitiesBasedOnRole(g,m){let f={...m},S=g.toLocaleLowerCase();return S!==tl.Attendee.toLocaleLowerCase()&&S!==tl.Presenter.toLocaleLowerCase()&&S!==tl.Consumer.toLocaleLowerCase()&&S!==tl.Organizer.toLocaleLowerCase()||(this._ecsConfig[sl][S][Vu.turnVideoOn]?f.turnVideoOn={isPresent:this._ecsConfig[sl][S][Vu.turnVideoOn],reason:rl.Capable}:f.turnVideoOn={isPresent:this._ecsConfig[sl][S][Vu.turnVideoOn],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.unmuteMic]?f.unmuteMic={isPresent:this._ecsConfig[sl][S][Vu.unmuteMic],reason:rl.Capable}:f.unmuteMic={isPresent:this._ecsConfig[sl][S][Vu.unmuteMic],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.shareScreen]?f.shareScreen={isPresent:this._ecsConfig[sl][S][Vu.shareScreen],reason:rl.Capable}:f.shareScreen={isPresent:this._ecsConfig[sl][S][Vu.shareScreen],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.removeParticipant]?f.removeParticipant={isPresent:this._ecsConfig[sl][S][Vu.removeParticipant],reason:rl.Capable}:f.removeParticipant={isPresent:this._ecsConfig[sl][S][Vu.removeParticipant],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.muteOthers]?f.muteOthers={isPresent:this._ecsConfig[sl][S][Vu.muteOthers],reason:rl.Capable}:f.muteOthers={isPresent:this._ecsConfig[sl][S][Vu.muteOthers],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.pstnDialOut]?f.pstnDialOut={isPresent:this._ecsConfig[sl][S][Vu.pstnDialOut],reason:rl.Capable}:f.pstnDialOut={isPresent:this._ecsConfig[sl][S][Vu.pstnDialOut],reason:rl.RoleRestricted},this._ecsConfig[sl][S][Vu.addPhoneNumber]?f.addPhoneNumber={isPresent:this._ecsConfig[sl][S][Vu.addPhoneNumber],reason:rl.Capable}:f.addPhoneNumber={isPresent:this._ecsConfig[sl][S][Vu.addPhoneNumber],reason:rl.RoleRestricted}),f.removeParticipant={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.hangUpForEveryOne={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.addCommunicationUser={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.addTeamsUser={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.manageLobby={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.spotlightParticipant={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.removeParticipantsSpotlight={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.blurBackground={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.startLiveCaptions={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.stopLiveCaptions={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.raiseHand={isPresent:!1,reason:rl.CapabilityNotApplicableForTheCallType},f.useReactions={isPresent:!0,reason:rl.Capable},this._logger.log(`Capabilities resolved to : ${JSON.stringify(f)} on role change to ${g}`),f}}class TeamsCapabilityResolver{constructor(g,m){this._logger=g,this._ecsConfig=m}getResolvedCapabilitiesBasedOnRole(g,m){let f={...m},S=g.toLocaleLowerCase();return S!==tl.Attendee.toLocaleLowerCase()&&S!==tl.Presenter.toLocaleLowerCase()&&S!==tl.Consumer.toLocaleLowerCase()&&S!==tl.Organizer.toLocaleLowerCase()&&S!==tl.Coorganizer.toLocaleLowerCase()||(S=S.replace("-",""),m.turnVideoOn.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.turnVideoOn]?f.turnVideoOn={isPresent:!0,reason:rl.Capable}:f.turnVideoOn={isPresent:!1,reason:rl.RoleRestricted}),m.unmuteMic.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.unmuteMic]?f.unmuteMic={isPresent:!0,reason:rl.Capable}:f.unmuteMic={isPresent:!1,reason:rl.RoleRestricted}),m.shareScreen.reason!=rl.UserPolicyRestricted&&(this._ecsConfig[al][S][Vu.shareScreen]?f.shareScreen={isPresent:!0,reason:rl.Capable}:f.shareScreen={isPresent:!1,reason:rl.RoleRestricted}),this._ecsConfig[al][S][Vu.removeParticipant]?f.removeParticipant={isPresent:!0,reason:rl.Capable}:f.removeParticipant={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.hangUpForEveryOne]?f.hangUpForEveryOne={isPresent:!0,reason:rl.Capable}:f.hangUpForEveryOne={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.addCommunicationUser]?f.addCommunicationUser={isPresent:!0,reason:rl.Capable}:f.addCommunicationUser={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.addTeamsUser]?f.addTeamsUser={isPresent:!0,reason:rl.Capable}:f.addTeamsUser={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.addPhoneNumber]?f.addPhoneNumber={isPresent:!0,reason:rl.Capable}:f.addPhoneNumber={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.manageLobby]?f.manageLobby={isPresent:!0,reason:rl.Capable}:f.manageLobby={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.spotlightParticipant]?f.spotlightParticipant={isPresent:!0,reason:rl.Capable}:f.spotlightParticipant={isPresent:!1,reason:rl.RoleRestricted},this._ecsConfig[al][S][Vu.removeParticipantsSpotlight]?f.removeParticipantsSpotlight={isPresent:!0,reason:rl.Capable}:f.removeParticipantsSpotlight={isPresent:!1,reason:rl.RoleRestricted},m.blurBackground.reason!=rl.UserPolicyRestricted&&(this._ecsConfig[al][S][Vu.blurBackground]?f.blurBackground={isPresent:!0,reason:rl.Capable}:f.blurBackground={isPresent:!1,reason:rl.RoleRestricted}),m.startLiveCaptions.reason!=rl.UserPolicyRestricted&&(this._ecsConfig[al][S][Vu.startLiveCaptions]?f.startLiveCaptions={isPresent:!0,reason:rl.Capable}:f.startLiveCaptions={isPresent:!1,reason:rl.RoleRestricted}),m.stopLiveCaptions.reason!=rl.UserPolicyRestricted&&(this._ecsConfig[al][S][Vu.stopLiveCaptions]?f.stopLiveCaptions={isPresent:!0,reason:rl.Capable}:f.stopLiveCaptions={isPresent:!1,reason:rl.RoleRestricted}),m.raiseHand.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.raiseHand]?f.raiseHand={isPresent:!0,reason:rl.Capable}:f.raiseHand={isPresent:!1,reason:rl.RoleRestricted}),m.pstnDialOut.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.pstnDialOut]?f.pstnDialOut={isPresent:!0,reason:rl.Capable}:f.pstnDialOut={isPresent:!1,reason:rl.RoleRestricted}),m.muteOthers.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.muteOthers]?f.muteOthers={isPresent:!0,reason:rl.Capable}:f.muteOthers={isPresent:!1,reason:rl.RoleRestricted}),m.useReactions.reason!=rl.MeetingRestricted&&(this._ecsConfig[al][S][Vu.useReactions]?f.useReactions={isPresent:!0,reason:rl.Capable}:f.useReactions={isPresent:!1,reason:rl.RoleRestricted})),this._logger.log(`Capabilities resolved to : ${JSON.stringify(f)} on role change to ${g}`),f}getResolvedCapabilitiesBasedOnMeetingCapabilities(g,m){let f={...m};return null!=g.attendeeRestrictions&&("DisableVideo"!=g.attendeeRestrictions&&"DisableAv"!=g.attendeeRestrictions?f.turnVideoOn={isPresent:!0,reason:rl.Capable}:f.turnVideoOn={isPresent:!1,reason:rl.MeetingRestricted}),null!=g.attendeeRestrictions&&("DisableAv"!=g.attendeeRestrictions?f.unmuteMic={isPresent:!0,reason:rl.Capable}:f.unmuteMic={isPresent:!1,reason:rl.MeetingRestricted}),null!=g.allowRaiseHands&&(g.allowRaiseHands?f.raiseHand={isPresent:!0,reason:rl.Capable}:f.raiseHand={isPresent:!1,reason:rl.MeetingRestricted}),null!=g.allowPstnConferencing&&(g.allowPstnConferencing?f.pstnDialOut={isPresent:!0,reason:rl.Capable}:f.pstnDialOut={isPresent:!1,reason:rl.MeetingRestricted}),null!=g.allowTeamsMeetingReactions&&(g.allowTeamsMeetingReactions?f.useReactions={isPresent:!0,reason:rl.Capable}:f.useReactions={isPresent:!1,reason:rl.MeetingRestricted}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(f)} on meeting details change to ${g}`),f}getResolvedCapabilitiesBasedOnUserPolicy(g,m){let f={...m};return null!=g.teamsMeetingPolicy?.screenSharingMode&&("Disabled"==g.teamsMeetingPolicy?.screenSharingMode?f.shareScreen={isPresent:!1,reason:rl.UserPolicyRestricted}:f.shareScreen={isPresent:!0,reason:rl.Capable}),null!=g.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==g.teamsMeetingPolicy?.liveCaptionsEnabledType?f.startLiveCaptions={isPresent:!1,reason:rl.UserPolicyRestricted}:f.startLiveCaptions={isPresent:!0,reason:rl.Capable}),null!=g.teamsMeetingPolicy?.liveCaptionsEnabledType&&("Disabled"==g.teamsMeetingPolicy?.liveCaptionsEnabledType?f.stopLiveCaptions={isPresent:!1,reason:rl.UserPolicyRestricted}:f.stopLiveCaptions={isPresent:!0,reason:rl.Capable}),null!=g.teamsMeetingPolicy?.videoFiltersMode&&("NoFilters"==g.teamsMeetingPolicy?.videoFiltersMode?f.blurBackground={isPresent:!1,reason:rl.UserPolicyRestricted}:f.blurBackground={isPresent:!0,reason:rl.Capable}),this._logger.log(`Capabilities resolved to : ${JSON.stringify(f)} on user policy update to ${g}`),f}}class CapabilityResolverImpl{constructor(g,m,f,S,v,C,_){this._eventEmitter=g,this._logger=m,this._ecsConfig=f,this._userPolicy=_,this._role=C,this._callInfo=S,this._capabilities=this.initializeCapabilities(),this.doInitialCapabilityResolutionBasedOnRoleAndUserPolicy()}initializeCapabilities(){return this._logger.info("initializing capabilities"),"roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context?{turnVideoOn:{isPresent:!1,reason:rl.FeatureNotSupported},unmuteMic:{isPresent:!1,reason:rl.FeatureNotSupported},shareScreen:{isPresent:!1,reason:rl.FeatureNotSupported},removeParticipant:{isPresent:!1,reason:rl.FeatureNotSupported},hangUpForEveryOne:{isPresent:!1,reason:rl.FeatureNotSupported},addCommunicationUser:{isPresent:!1,reason:rl.FeatureNotSupported},addTeamsUser:{isPresent:!1,reason:rl.FeatureNotSupported},addPhoneNumber:{isPresent:!1,reason:rl.FeatureNotSupported},manageLobby:{isPresent:!1,reason:rl.FeatureNotSupported},spotlightParticipant:{isPresent:!1,reason:rl.FeatureNotSupported},removeParticipantsSpotlight:{isPresent:!1,reason:rl.FeatureNotSupported},blurBackground:{isPresent:!1,reason:rl.FeatureNotSupported},startLiveCaptions:{isPresent:!1,reason:rl.FeatureNotSupported},stopLiveCaptions:{isPresent:!1,reason:rl.FeatureNotSupported},raiseHand:{isPresent:!1,reason:rl.FeatureNotSupported},pstnDialOut:{isPresent:!1,reason:rl.FeatureNotSupported},muteOthers:{isPresent:!1,reason:rl.FeatureNotSupported},useReactions:{isPresent:!1,reason:rl.FeatureNotSupported}}:{turnVideoOn:{isPresent:!1,reason:rl.NotInitialized},unmuteMic:{isPresent:!1,reason:rl.NotInitialized},shareScreen:{isPresent:!1,reason:rl.NotInitialized},removeParticipant:{isPresent:!1,reason:rl.NotInitialized},hangUpForEveryOne:{isPresent:!1,reason:rl.NotInitialized},addCommunicationUser:{isPresent:!1,reason:rl.NotInitialized},addTeamsUser:{isPresent:!1,reason:rl.NotInitialized},addPhoneNumber:{isPresent:!1,reason:rl.NotInitialized},manageLobby:{isPresent:!1,reason:rl.NotInitialized},spotlightParticipant:{isPresent:!1,reason:rl.NotInitialized},removeParticipantsSpotlight:{isPresent:!1,reason:rl.NotInitialized},blurBackground:{isPresent:!1,reason:rl.NotInitialized},startLiveCaptions:{isPresent:!1,reason:rl.NotInitialized},stopLiveCaptions:{isPresent:!1,reason:rl.NotInitialized},raiseHand:{isPresent:!1,reason:rl.NotInitialized},pstnDialOut:{isPresent:!1,reason:rl.NotInitialized},muteOthers:{isPresent:!1,reason:rl.NotInitialized},useReactions:{isPresent:!1,reason:rl.NotInitialized}}}doInitialCapabilityResolutionBasedOnRoleAndUserPolicy(){"roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context||(this._role==tl.Unknown?this.resolveCapabilitiesBasedOnRole(tl.Attendee):this.resolveCapabilitiesBasedOnRole(this._role),this._userPolicy&&this.getCapabilityResolver()instanceof TeamsCapabilityResolver&&"roomJoin"!=this._callInfo.context&&this.resolveCapabilitiesBasedOnUserPolicy(this._userPolicy))}getCapabilityResolver(){return this._callInfo.context?.match("roomJoin")?new RoomsCapabilityResolver(this._logger,this._ecsConfig):(this._callInfo.context?.match("teamsMeetingJoin"),new TeamsCapabilityResolver(this._logger,this._ecsConfig))}getCapabilities(){return this._capabilities}resolveCapabilitiesBasedOnRole(g){let m=this.getCapabilityResolver();if(m){let f=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnRole(g,this._capabilities),!R.isEqual(f,this._capabilities)){const g=this.getChangedCapabilitiesInfo(f,this._capabilities,"RoleChanged");this._logger.info(`Capabilities has changed based on role, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(g)}`),this._eventEmitter.emit("capabilitiesChanged",g)}}}resolveCapabilitiesBasedOnMeetingCapabilities(g){let m=this.getCapabilityResolver();if(m&&m){const f=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnMeetingCapabilities(g,this._capabilities),!R.isEqual(f,this._capabilities)){const g=this.getChangedCapabilitiesInfo(f,this._capabilities,"MeetingOptionOrOrganizerPolicyChanged");this._logger.info(`Capabilities has changed due to meeting capabilities, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(g)}`),this._eventEmitter.emit("capabilitiesChanged",g)}}}resolveCapabilitiesBasedOnUserPolicy(g){let m=this.getCapabilityResolver();if(m&&m){let f=JSON.parse(JSON.stringify(this._capabilities));if(this._capabilities=m.getResolvedCapabilitiesBasedOnUserPolicy(g,this._capabilities),!R.isEqual(f,this._capabilities)){const g=this.getChangedCapabilitiesInfo(f,this._capabilities,"UserPolicyChanged");this._logger.info(`Capabilities has changed due to user policy, emitting capabilities changed event with capabilitiesChangeInfo: ${JSON.stringify(g)}`),this._eventEmitter.emit("capabilitiesChanged",g)}}}getChangedCapabilitiesInfo(g,m,f){let S={},v={};return Object.keys(g).forEach((f=>{g[f].isPresent!=m[f].isPresent&&(S[f]=g[f],v[f]=m[f])})),{oldValue:S,newValue:v,reason:f}}}class CapabilitiesFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._callInfo=g.callInfo,this._impl=new CapabilitiesImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"Capabilities"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.call,this._callInfo,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}get capabilities(){return this._sendFeatureUsage("getCapabilities",Lh.getter),this._impl.capabilities}on(g,m){this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Capabilities",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class CapabilitiesImplOverTsCall{constructor(g){this._eventEmitter=g}get capabilities(){return this._capabilityResolver.getCapabilities()}initialize(g,m,f,S,v,C){this._logger=C.createChild((()=>`CapabilitiesFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._call=f,this._callInfo=S,this._internalCallAgent=m,this._ecsConfig=getAcsEcsConfig(),this._timeToInitialize=new Date,this._userPolicies=this._internalCallAgent.getUserPolicy(),this._role=this._call.role,this._capabilityResolver=new CapabilityResolverImpl(this._eventEmitter,this._logger,this._ecsConfig,this._callInfo,this._tsCall,this._role,this._userPolicies),this._call.on("roleChanged",(()=>{if("roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context)return;let g=this._call.role;if("Unknown"!==g){this._capabilityResolver.resolveCapabilitiesBasedOnRole(g);let m=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after role set is "+m)}})),this._call.onMeetingChanged("meetingCapabilitiesChanged",(()=>{if("roomJoin"!=this._callInfo.context&&"teamsMeetingJoin"!=this._callInfo.context)return;let g={};g.allowVideo=this._tsCall.meetingDetails?.capabilities?.allowVideo,g.allowIPVideo=this._tsCall.meetingDetails?.meetingCapability?.allowIPVideo,g.attendeeRestrictions=this._tsCall.meetingDetails?.meetingCapability?.attendeeRestrictions,g.allowPstnConferencing=this._tsCall.meetingDetails?.meetingCapability?.allowPstnConferencing,g.allowTranslatedCaptions=this._tsCall.meetingDetails?.meetingCapability?.allowTranslatedCaptions,g.allowTranslatedTranscriptions=this._tsCall.meetingDetails?.meetingCapability?.allowTranslatedTranscriptions,g.allowRaiseHands=this._tsCall.meetingDetails?.meetingCapability?.allowRaiseHands,g.allowTeamsMeetingReactions=this._tsCall.meetingDetails?.meetingCapability?.allowTeamsMeetingReactions,g.presenterOption=this._tsCall.meetingDetails?.meetingCapability?.presenterOption,this._capabilityResolver.resolveCapabilitiesBasedOnMeetingCapabilities(g);let m=((new Date).getTime()-this._timeToInitialize.getTime())/1e3;this._logger.info("Time difference to initialize after meeting set up is"+m)}))}}var Bu,Hu,bitwise=function(g){var m=0;if(0==g.length)return m;for(var f=0;f<g.length;f++){m=(m<<5)-m+g.charCodeAt(f),m&=m}return m},binaryTransfer=function(g,m){var f="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";m=m||62;var S,v=[],C="",_=g<0?"-":"";for(g=Math.abs(g);g>=m;)S=g%m,g=Math.floor(g/m),v.push(f[S]);g>0&&v.push(f[g]);for(var E=v.length-1;E>=0;E--)C+=v[E];return _+C},dist=function(g){var m=typeof g;if("string"===m||"number"===m)return binaryTransfer(bitwise(String(g)),61).replace("-","Z");throw new Error("Unexpected input type")};!function(g){g.ping="ping",g.pong="pong"}(Bu||(Bu={}));class DebugInfoCallClientFeatureImpl extends FirstPartyCallClientFeature{constructor(g){super(g),this._impl=new DebugInfoImplOverTsCall;try{getSdkVersion().includes("stable")||(this._browserTabInfoImpl=new BrowserTabInfoImpl(this.eventEmitter))}catch(m){g.callClient.logger.error("Feature to detect multiple tabs is not supported on the current environment.")}}get name(){return this._sendFeatureUsage("name",Lh.getter),"DebugInfo"}get lastLocalParticipantId(){return this._sendFeatureUsage("lastLocalParticipantId",Lh.getter),this._impl.lastLocalParticipantId}get logs(){return this._impl.logDump}get localParticipantIdMap(){return this._impl.localParticipantIdMap}get incommingCallIdMap(){return this._impl.incommingCallIdMap}get lastCallId(){if(this._sendFeatureUsage("lastCallId",Lh.getter),this.lastLocalParticipantId)return this._impl.localParticipantIdMap[this.lastLocalParticipantId].callIds.slice(-1)[0]}get diagnosticInformation(){return this._impl.diagnosticInformation}get sdkVersion(){return getSdkVersion()}get acsResourceId(){return this._impl.AcsResourceId}get clientId(){return this._impl.clientId}dumpDebugInfoAsJSONString(){try{return JSON.stringify(this.toZip())}catch(g){return`JSON.stringify threw: ${g}`}}toZip(){return{clientId:this.clientId,lastLocalParticipantId:this.lastLocalParticipantId,localParticipantIdMap:this.localParticipantIdMap,incommingCallMap:this.incommingCallIdMap,AcsResourceId:this.acsResourceId,diagnosticInformation:this.diagnosticInformation,sdkVersion:this.sdkVersion,logs:this.logs}}dumpDebugInfo(){this._sendFeatureUsage("dumpDebugInfo",Lh.attempt);try{const g=Mh.deflate(this.dumpDebugInfoAsJSONString(),{to:"string"}),m=dist(g);return this._sendFeatureUsage("dumpDebugInfo",Lh.success),{dump:g,dumpId:`${generateGuid()}-${m}`}}catch(g){const m=`failed to deflate, error: ${g}`;return this.logger.error(m),this._sendFeatureUsage("dumpDebugInfo",Lh.failure),{dump:Mh.deflate(m,{to:"string"}),dumpId:generateGuid()}}}initialize(g,m){this._impl.initialize(g,m),this.logger=m,this._telemetryLogManager=g.telemetryLogManager,this._callClient=g.callClient,this._browserTabInfoImpl&&this._browserTabInfoImpl.initialize(g.callClient,m,g.telemetryLogManager),this._sendFeatureUsage("initialize",Lh.initialize)}async getEnvironmentInfo(){return this._sendFeatureUsage("getEnvironmentInfo",Lh.getter),await this._callClient.getEnvironmentInfoInternal()}get isAnotherCallClientActiveInSameTab(){return this._sendFeatureUsage("isAnotherCallClientActiveInSameTab",Lh.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isAnotherCallClientActiveInSameTab}get isCallClientActiveInAnotherTab(){return this._sendFeatureUsage("isCallClientActiveInAnotherTab",Lh.getter),!!this._browserTabInfoImpl&&this._browserTabInfoImpl.isCallClientActiveInAnotherTab}on(g,m){"isCallClientActiveInAnotherTabChanged"!==g&&"isAnotherCallClientActiveInSameTabChanged"!==g&&this.logger.error(`Not able to subscribe to event ${g}, unknown event name`),this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){"isCallClientActiveInAnotherTabChanged"!==g&&"isAnotherCallClientActiveInSameTabChanged"!==g&&this.logger.error(`Not able to unsubscribe to event ${g}, unknown event name`),this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"DebugInfo",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this.logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class DebugInfoImplOverTsCall{get diagnosticInformation(){return this._sdkDiagnosticInformation}get logDump(){return this._logger.log("Log dump requested"),this._logger.dumpAllLogs()}get AcsResourceId(){return this._callAgent?.getAcsResourceId()}get lastLocalParticipantId(){return this._lastLocalParticipantId}get localParticipantIdMap(){return this._localParticipantIdMap}get incommingCallIdMap(){return this._incommingCallIdMap}get clientId(){return this._callAgent?.getClientId()}constructor(){this._localParticipantIdMap={},this._incommingCallIdMap={}}initialize(g,m){this._logger=m,this._callAgent=g?.callClient?.callAgent,this._sdkDiagnosticInformation=g?.callClient.sdkDiagnosticInformation,this._logger.info("waiting for call agent to be created");const bindAndSubscribeToCallAgentEvents=()=>{this._callAgent=g?.callClient.callAgent,this.subscribeToCallAgentEvents()};g?.callClient.on("callAgentCreated",bindAndSubscribeToCallAgentEvents)}dispose(){}subscribeToCallAgentEvents(){try{this._callAgent?.on("callsUpdated",(g=>{[...g.added,...g.removed].forEach((g=>{this.updateLocalParticipantIdMap(g),g.on("idChanged",(()=>{this.updateLocalParticipantIdMap(g)}))}))})),this._callAgent?.on("incomingCall",(g=>{let m=g.incomingCall;m.on("callEnded",(g=>{try{this._incommingCallIdMap[m.id]=JSON.stringify(g.callEndReason)}catch(g){this._incommingCallIdMap[m.id]="callEnd reason unknown"}}));try{this._incommingCallIdMap[m.id]=JSON.stringify(g.incomingCall.callerInfo.identifier?.kind)}catch(g){this._incommingCallIdMap[m.id]="identifier kind unknown"}}))}catch(g){this._logger.info("failed to subscribe to call agent events, due to non initialized call agent")}}updateLocalParticipantIdMap(g){try{let m=this._localParticipantIdMap[g.tsCall.participantId]?.callIds.filter((m=>m!==g.tsCall.callId)).concat([g.tsCall.callId])??[g.tsCall.callId],f=[],S=[],v=g.callEndReason?JSON.stringify(g.callEndReason):g.state,C=g.state;this._localParticipantIdMap[g.tsCall.participantId]?.callEndReasons?(this._localParticipantIdMap[g.tsCall.participantId].callEndReasons.slice(-1)[0]!==v?(this._localParticipantIdMap[g.tsCall.participantId].callEndReasons.push(v),f=this._localParticipantIdMap[g.tsCall.participantId].callEndReasons):f=this._localParticipantIdMap[g.tsCall.participantId].callEndReasons,this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.slice(-1)[0]!==C?(this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.push(C),S=this._localParticipantIdMap[g.tsCall.participantId].stateTransitions):S=this._localParticipantIdMap[g.tsCall.participantId].stateTransitions):(f=[v],S=[g.state]),this._localParticipantIdMap[g.tsCall.participantId]={callIds:m,callEndReasons:f,stateTransitions:S},this._logger.info(`localParticipantIdMap: ${JSON.stringify(this._localParticipantIdMap)}`),g.on("stateChanged",(()=>{"Connected"===g.state&&(this._lastLocalParticipantId=g.tsCall.participantId,this._logger.info(`last patricipant id: ${this._lastLocalParticipantId}`)),this._localParticipantIdMap[g.tsCall.participantId].stateTransitions.slice(-1)[0]!==g.state&&this.localParticipantIdMap[g.tsCall.participantId].stateTransitions.push(g.state)}))}catch(g){this._logger.error(`exception occured while updating localParticipantId map: ${g}`)}}}class BrowserTabInfoImpl{get isCallClientActiveInAnotherTab(){return this._isCallClientActiveInAnotherTab}get isAnotherCallClientActiveInSameTab(){return this._isAnotherCallClientActiveInSameTab}constructor(g){this._eventEmitter=g,this._tabGroupId=BrowserTabInfoImpl.tabId,this._isCallClientActiveInAnotherTab=!1,this._isAnotherCallClientActiveInSameTab=!1,this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._isTabFirstLoadFlag=!0,this._intervalId=void 0,this._timeoutId=void 0,this._channel=new BroadcastChannel(getAcsEcsConfig().debugInfo.broadcastChannelName)}initialize(g,m,f){this._callClient=g,this._logger=m,this._telemetryLogManager=f;const S=getAcsEcsConfig().debugInfo.tabsBroadcastDelay,v=getAcsEcsConfig().debugInfo.tabsUpdateDelay;this.tabsCheck(),this._channel.postMessage({action:Bu.ping,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId}),this._timeoutId=setTimeout((()=>{this._areThereMultipleTabs&&(this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs),this._manyCallClientInSameTab&&(this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab),this.sendTabUpdateEvent(),this._isTabFirstLoadFlag=!1}),10),this._intervalId=setInterval((()=>{this._areThereMultipleTabs=null,this._manyCallClientInSameTab=null,this._channel.postMessage({action:Bu.ping,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId}),setTimeout((()=>{null===this._areThereMultipleTabs&&(this._areThereMultipleTabs=!1),null===this._manyCallClientInSameTab&&(this._manyCallClientInSameTab=!1),this.tabsUpdate()}),v)}),S)}tabsCheck(){this._channel.addEventListener("message",(g=>{g.data?.action!==Bu.ping&&g.data?.action!==Bu.pong||(g.data?.action===Bu.ping&&(BrowserTabInfoImpl.tabId===g.data.tabId?this._manyCallClientInSameTab=!0:BrowserTabInfoImpl.tabId!==g.data.tabId&&(this._areThereMultipleTabs=!0),this._channel.postMessage({action:Bu.pong,tabId:BrowserTabInfoImpl.tabId,groupId:this._tabGroupId})),g.data?.action===Bu.pong&&(BrowserTabInfoImpl.tabId===g.data.tabId?this._manyCallClientInSameTab=!0:BrowserTabInfoImpl.tabId!==g.data.tabId&&(this._areThereMultipleTabs=!0),this._tabGroupId!==g.data.groupId&&(this._tabGroupId=g.data.groupId)),this.tabsUpdate())}))}sendTabUpdateToCallEvent(){this._callClient.callAgent?._calls?.forEach((g=>g?.stats?.recordEvent({name:Nh.sdk_active_in_another_tab,callId:g.id,localParticipantId:g.tsCall.participantId,data:{tabId:BrowserTabInfoImpl.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab}})))}sendTabUpdateEvent(){const g={tabId:BrowserTabInfoImpl.tabId,tabGroupId:this._tabGroupId,isCallClientActiveInAnotherTab:this._isCallClientActiveInAnotherTab,isAnotherCallClientActiveInSameTab:this._isAnotherCallClientActiveInSameTab};this._telemetryLogManager.sendEvent({name:kh.acs_calling_tab_events,tenant:so,properties:g})}tabsUpdate(){this._isTabFirstLoadFlag||null===this._manyCallClientInSameTab||null===this._areThereMultipleTabs||this._isCallClientActiveInAnotherTab===this._areThereMultipleTabs&&this._isAnotherCallClientActiveInSameTab===this._manyCallClientInSameTab||(this._isAnotherCallClientActiveInSameTab!==this._manyCallClientInSameTab&&(this._logger.log(`isAnotherCallClientActiveInSameTab changed from ${this._isAnotherCallClientActiveInSameTab} to ${this._manyCallClientInSameTab}`),this._isAnotherCallClientActiveInSameTab=this._manyCallClientInSameTab,this._eventEmitter.emit("isAnotherCallClientActiveInSameTabChanged")),this._isCallClientActiveInAnotherTab!==this._areThereMultipleTabs&&(this._logger.log(`isCallClientActiveInAnotherTab changed from ${this._isCallClientActiveInAnotherTab} to ${this._areThereMultipleTabs}`),this._isCallClientActiveInAnotherTab=this._areThereMultipleTabs,this._eventEmitter.emit("isCallClientActiveInAnotherTabChanged")),this.sendTabUpdateEvent(),this.sendTabUpdateToCallEvent())}dispose(){this._channel.close(),void 0!==this._timeoutId&&clearTimeout(this._timeoutId),void 0!==this._intervalId&&clearInterval(this._intervalId)}}BrowserTabInfoImpl.tabId=generateGuid(),function(g){g[g.Good=1]="Good",g[g.Poor=2]="Poor",g[g.Bad=3]="Bad"}(Hu||(Hu={}));const $u="networkReconnect",Gu="networkReceiveQuality",ju="networkSendQuality",Wu="networkRelaysNotReachable",qu="noNetwork",zu="noSpeakerDevicesEnumerated",Ku="noMicrophoneDevicesEnumerated",Ju="microphoneNotFunctioning",Yu="microphoneMuteUnexpectedly",Qu="cameraStoppedUnexpectedly",Xu="capturerStoppedUnexpectedly",Zu="speakingWhileMicrophoneIsMuted",eg="cameraFreeze",tg="cameraStartFailed",ig="capturerStartFailed",ng="cameraStartTimedOut",rg="screenshareRecordingDisabled",sg="microphonePermissionDenied",ag="cameraPermissionDenied";class UserFacingDiagnosticsFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new UserFacingDiagnosticsImplOverTsCall}get name(){return this._sendFeatureUsage("name",Lh.getter),"Diagnostics"}get network(){return this._sendFeatureUsage("network",Lh.getter),this._impl.network}get media(){return this._sendFeatureUsage("media",Lh.getter),this._impl.media}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g,m),this._sendFeatureUsage("initialize",Lh.initialize)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Diagnostics",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class UserFacingDiagnosticsImplOverTsCall{get network(){return this._network}get media(){return this._media}constructor(){}initialize(g,m){this._network=new NetworkDiagnosticsImpl(g,m),this._media=new MediaDiagnosticsImpl(g,m)}dispose(){}}class UserFacingDiagnosticsImpl{constructor(g,m){this.logger=m,this._tsUfdUnknownValue=0,this.tsQualityToAcsQualityMap={1:Hu.Good,2:Hu.Poor,3:Hu.Bad},this.tssQualityToAcsBooleanMap={3:!0,1:!1},this._tsCall=g.tsCall,this.eventEmitter=new bu.EventEmitter,this._tsCall.on("callQualityChanged",(g=>{try{const m=this.mapTSQualityEventType(g.type,g.mediaType);if(m){if(g.value===this._tsUfdUnknownValue)return;const f=m,S=this.mapTSQualityLevel(m,g.value);let v;if("number"!=typeof S||S!==Hu.Good&&S!==Hu.Poor&&S!==Hu.Bad){if("boolean"!=typeof S)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.INCORRECT_VALUETYPE_MAPPED(typeof S,S,f));v="DiagnosticFlag"}else v="DiagnosticQuality";let C={diagnostic:f,value:S,valueType:v};this.logger.log(`Call diagnostic changed, diagnostic='${C.diagnostic}', value='${C.value}'`);const _="DiagnosticFlag"===C.valueType&&!0===C.value,E="DiagnosticQuality"===C.valueType&&(C.value===Hu.Bad||C.value===Hu.Poor);(_||E)&&this.logger.warn(`Call diagnostic error raised!, diagnostic='${C.diagnostic}', value='${C.value}', value type='${C.valueType}'`),this.eventEmitter.emit("diagnosticChanged",C)}}catch(g){this.logger.error(`${g?.message})`)}}))}}class NetworkDiagnosticsImpl extends UserFacingDiagnosticsImpl{constructor(g,m){super(g,m.createChild((()=>`[UserFacingDiagnosticsFeature:NetworkDiagnostics:Call(id='${g.tsCall.callId}', state='${g.tsCall.state}')]`))),this.latestNetworkDiagnostics=new Map}on(g,m){if("diagnosticChanged"!==g)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("diagnosticChanged"!==g&&"diagnosticFlagChanged"!==g)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}getLatest(){try{return convertMapToFrozenJson(this.latestNetworkDiagnostics)}catch(g){return this.logger.error("Failed to get latest network diagnostics"),{}}}mapTSQualityEventType(g){return{5:$u,2:Gu,1:ju,32:Wu,37:qu}[g]}mapTSQualityLevel(g,m){let f,S;switch(g){case $u:case Gu:case ju:S="DiagnosticQuality",f=this.tsQualityToAcsQualityMap[m];break;case Wu:case qu:S="DiagnosticFlag",f=this.tssQualityToAcsBooleanMap[m]}if(void 0===f)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED(m,g));return this.latestNetworkDiagnostics.set(g,{value:f,valueType:S}),f}}class MediaDiagnosticsImpl extends UserFacingDiagnosticsImpl{constructor(g,m){super(g,m.createChild((()=>`[UserFacingDiagnosticsFeature:MediaDiagnostics:Call(id='${g.tsCall.callId}', state='${g.tsCall.state}')]`))),this.latestMediaDiagnostics=new Map}on(g,m){if("diagnosticChanged"!==g)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("diagnosticChanged"!==g&&"diagnosticFlagChanged"!==g)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}getLatest(){try{return convertMapToFrozenJson(this.latestMediaDiagnostics)}catch(g){return this.logger.error("Failed to get latest media diagnostics"),{}}}mapTSQualityEventType(g,m){const f={44:zu,43:Ku,9:Ju,25:Yu,27:Zu,45:eg,33:tg,34:ng,55:rg,26:sg,47:ag};return this.overrideQualityEventsForMediaType(f[g],m)}overrideQualityEventsForMediaType(g,m){if(g===Yu)switch(m){case 1:return Qu;case 2:return Xu}return g===tg&&2===m?ig:g}mapTSQualityLevel(g,m){let f,S;switch(g){case zu:case Ku:case Ju:case Yu:case Zu:case eg:case tg:case ng:case rg:case sg:case ag:case Qu:case Xu:case ig:S="DiagnosticFlag",f=this.tssQualityToAcsBooleanMap[m]}if(void 0===f)throw new CallingCommunicationError(z.FEATURES.DIAGNOSTICS.INCORRECT_VALUE_MAPPED(m,g));return this.latestMediaDiagnostics.set(g,{value:f,valueType:S}),f}}class DominantSpeakersCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new DominantSpeakersCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"DominantSpeakers"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}get dominantSpeakers(){return this._sendFeatureUsage("dominantSpeakers",Lh.getter),this._impl.dominantSpeakers}on(g,m){this._sendFeatureUsage("dominantSpeakersChanged",Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage("dominantSpeakersChanged",Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"DominantSpeakers",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class DominantSpeakersCallImplOverTsCall{constructor(g){this._eventEmitter=g,this.localDominantList=[]}initialize(g,m,f,S,v=!1){this._logger=S.createChild((()=>`DominantSpeakersFeature${v?"Internal":""}::Call(id='${g.callId}')`)),this._tsCall=g,this.localDominantList=this._tsCall.dominantSpeakerInfo?.speakerList||[],this._tsCallChangedListener=this._tsCall.changed((()=>{let g=!1;if(this.localDominantList.length!=this._tsCall.dominantSpeakerInfo.speakerList.length)g=!0;else for(let m in this._tsCall.dominantSpeakerInfo.speakerList)if(this._tsCall.dominantSpeakerInfo.speakerList[m]!==this.localDominantList[m]){g=!0;break}g&&(this._logger.info("Dominant speakers list change detected"),this.localDominantList=this._tsCall.dominantSpeakerInfo.speakerList,this._eventEmitter.emit("dominantSpeakersChanged"))}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}get dominantSpeakers(){let g=Array();return this._tsCall.dominantSpeakerInfo.speakerList.map((m=>{g.push(constructIdentifierKindFromMri(m))})),{speakersList:g,timestamp:this._tsCall.dominantSpeakerInfo.timestamp||new Date}}dispose(){this._eventEmitter.removeAllListeners(),this._tsCallChangedListener?.dispose()}}class CallingEventEmitter extends bu.EventEmitter{constructor(g,m){super(),this._options={enableLogOn:!0,enableLogOff:!0,enableLogOnce:!0,enableLogEmit:!0},this._logger=g.createChild("CallingEventEmitter"),m&&(this._options=m)}on(g,m){return!1!==this._options.enableLogOn&&this._logger.info(`event:subscribe to ${g.toString()}`),super.on(g,m)}once(g,m){return!1!==this._options.enableLogOnce&&this._logger.info(`event:subscribe once to ${g.toString()}`),super.once(g,m)}off(g,m){return!1!==this._options.enableLogOff&&this._logger.info(`event:unsubscribed ${g.toString()}`),super.off(g,m)}emit(g,...m){try{return!1!==this._options.enableLogEmit&&this._logger.info(`event:emit ${g.toString()}`),super.emit(g,...m)}catch(m){return this._logger.warn(`Application threw an error while it handled the ${g.toString()} event`),!1}}}function createMediaStatsReportInternalObject(){return{audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}}}function getMax(g){let m=g.length>0?g[0]:0;return g.forEach((g=>{g>m&&(m=g)})),m}function getMin(g){let m=g.length>0?g[0]:0;return g.forEach((g=>{g<m&&(m=g)})),m}function getSum(g){let m=0,f=0;return g.forEach((g=>{const S=g-f,v=m+S;f=v-m-S,m=v})),m}const og=createMediaStatsReportInternalObject;class MediaStatsCalculator{constructor(g){this._metricsProperties=g,this._originalValues={},this._aggregateValues={},this._events=[],this._currentValues={}}addStats(g,m){const f=this._metricsProperties[g];if(void 0!==f&&!0!==f.skip){if(f.events){const S=f.output_key??g;m!==this._currentValues[S]&&(this._currentValues[S]=m,this._events.push({name:S,value:m,timestamp:Date.now()}))}else{let f=this._originalValues[g];void 0===f&&(f={raw:[],beginTime:Date.now()},this._originalValues[g]=f),f.raw.push(m)}return m}}aggregate(){for(const[g,m]of Object.entries(this._originalValues)){const f=this._metricsProperties[g],S=f.output_key??g;let v=this._aggregateValues[S];void 0===v&&(v={raw:[],timestamp:new Date(m.beginTime)},f.aggregable&&(v.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[S]=v);const C=m.raw;let _=C;if(f.aggregable&&v.aggregation){const g=C.filter((g=>"number"==typeof g&&!isNaN(g)));v.aggregation.count.push(g.length),v.aggregation.sum.push(getSum(g)),v.aggregation.max.push(getMax(g)),v.aggregation.min.push(getMin(g)),_=g}f.raw_data_reduction&&_.length>0&&(v.reduced=v.reduced||[],v.reduced.push(_[_.length-1])),_.forEach((g=>v.raw.push(g)))}this._originalValues={}}popAggregates(){const g=this._aggregateValues;return this._aggregateValues={},g}popEvents(){const g=this._events;return this._events=[],g}}class TelemetryCollector{constructor(g,m){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=og(),this._isActive=!1,m.aggregationInterval<1)throw new Error("invalid aggregationInterval value range");if(m.dataPointsPerAggregation<1)throw new Error("invalid dataPointsPerAggregation value range");this._metricsProperties=m.metricsPropertics,this._logger=g.createChild("TelemetryCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._aggregationInterval=m.aggregationInterval,this._dataPointsPerAggregation=m.dataPointsPerAggregation,this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}onReport(g){this._processMediaStatsReport(g)}onAdded(g){this._isActive!==g&&(this._isActive=g,this._callStateChanged.resolve(g))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(g){try{const m=[[g.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send,"send"],[g.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive,"recv"],[g.video.send,this._calculators.video.send,this._metricsProperties.video.send,"send"],[g.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive,"recv"],[g.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send,"send"],[g.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive,"recv"],[g.dataChannel,this._calculators.dataChannel,this._metricsProperties.dataChannel,""],[g.transports,this._calculators.transports,this._metricsProperties.transports,""]];for(const[f,S,v,C]of m){const m=[],_=Object.keys(S);Object.keys(f).forEach((_=>{const E=f[_],T=E.id;m.push(T),void 0===S[T]&&(S[T]=new MediaStatsCalculator(v));const addStats=(g,m)=>S[T].addStats(g,m);if(Object.keys(E).forEach((g=>addStats(g,E[g]))),"send"==C||"recv"==C){const m=E.transportId;if(void 0!==m){const f=g.transports[m];void 0!==f.rtt&&addStats("pairRttInMs",f.rttInMs),void 0!==f.availableIncomingBitrate&&"recv"==C&&addStats("availableBitrate",f.availableIncomingBitrate),void 0!==f.availableOutgoingBitrate&&"send"==C&&addStats("availableBitrate",f.availableOutgoingBitrate)}}}));_.filter((g=>!m.includes(g))).forEach((g=>{delete S[g]}))}}catch(g){this._logger.error(g)}}async _run(){let g=0;const flushData=()=>{if(0===g)return;const m={audio:{send:{},receive:{}},video:{send:{},receive:{}},screenShare:{send:{},receive:{}},dataChannel:{},transports:{}},f=[[m.audio.send,this._calculators.audio.send],[m.audio.receive,this._calculators.audio.receive],[m.video.send,this._calculators.video.send],[m.video.receive,this._calculators.video.receive],[m.screenShare.send,this._calculators.screenShare.send],[m.screenShare.receive,this._calculators.screenShare.receive],[m.dataChannel,this._calculators.dataChannel],[m.transports,this._calculators.transports]];for(const[g,m]of f)for(const[f,S]of Object.entries(m))g[f]={id:f,...S.popAggregates(),events:S.popEvents()};this._eventEmitter.emit("data",m),g=0};let m=1e3*this._aggregationInterval;for(;!this._disposed;){const f=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.dataChannel];if(this._isActive){m>0&&await wait((()=>this._callStateChanged.promise),m).catch((g=>{}));const S=Date.now();for(const g of f)for(const[,m]of Object.entries(g))m.aggregate();g++,g===this._dataPointsPerAggregation&&flushData();const v=Date.now();m=S+1e3*this._aggregationInterval-v}else flushData(),this._calculators=og(),await this._callStateChanged.promise.catch((g=>{})),m=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}function convertAltLayouts(g){const m=[];return g.sort(((g,m)=>g.id>m.id?1:g.id<m.id?-1:0)),g.forEach((g=>{const f=/^([^.]+)\.?([^.]+)?$/.exec(g.id);if(f&&f[2]){g.id=R.toString(f[2]);const S=R.toString(f[1]);if(m.length>0&&m[m.length-1].id===S){const f=m[m.length-1].altLayouts??[];f.push(g),m[m.length-1].altLayouts=f}else m.push(g)}else m.push(g)})),m}class MediaStatsCollectorImpl{constructor(g,m){if(this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=og(),this._isActive=!1,m.aggregationInterval<1)throw new CallingCommunicationError(z.FEATURES.MEDIA_STATS.INVALID_AGGREGATION_INTERVAL_RANGE);if(m.dataPointsPerAggregation<1)throw new CallingCommunicationError(z.FEATURES.MEDIA_STATS.INVALID_DATAPOINTS_AGGREGATION_RANGE);this._metricsProperties=m.metricsPropertics,this._logger=g.createChild("MediaStatsCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._aggregationInterval=m.aggregationInterval,this._dataPointsPerAggregation=m.dataPointsPerAggregation,this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChanged.resolve(!1),this._eventEmitter.removeAllListeners(),this._mediaStatsSource?.removeSink(this))}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}onReport(g){this._processMediaStatsReport(g)}onAdded(g){this._isActive!==g&&(this._isActive=g,this._callStateChanged.resolve(g))}onRemoved(){this.dispose()}pause(){this._isActive&&(this._isActive=!1,this._callStateChanged.resolve(!1))}resume(){this._isActive||(this._isActive=!0,this._callStateChanged.resolve(!0))}stop(){this.dispose()}_processMediaStatsReport(g){const m={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};try{const f=[[g.audio.send,m.audio.send,this._calculators.audio.send,this._metricsProperties.audio.send],[g.audio.receive,m.audio.receive,this._calculators.audio.receive,this._metricsProperties.audio.receive],[g.video.send,m.video.send,this._calculators.video.send,this._metricsProperties.video.send],[g.video.receive,m.video.receive,this._calculators.video.receive,this._metricsProperties.video.receive],[g.screenShare.send,m.screenShare.send,this._calculators.screenShare.send,this._metricsProperties.screenShare.send],[g.screenShare.receive,m.screenShare.receive,this._calculators.screenShare.receive,this._metricsProperties.screenShare.receive],[g.transports,m.transports,this._calculators.transports,this._metricsProperties.transports]];let S=!1;for(const[g,m,v,C]of f){const f=[],_=Object.keys(v);Object.keys(g).forEach((_=>{const E=g[_];let T=E.id;E.groupId&&(T=`${E.groupId}.${T}`,S=!0);const I={id:T};f.push(T),void 0===v[T]&&(v[T]=new MediaStatsCalculator(C)),Object.keys(E).forEach((g=>{const m=C[g];if(m&&!0!==m.skip){const f=v[T].addStats(g,E[g]),S=m.output_key??g;I[S]=f}})),m.push(I)}));_.filter((g=>!f.includes(g))).forEach((g=>{delete v[g]}))}S&&(m.video.send=convertAltLayouts(m.video.send),m.screenShare.send=convertAltLayouts(m.screenShare.send))}catch(g){this._logger.error(g)}this._eventEmitter.emit("sampleReported",m)}async _run(){let g=0;const flushData=()=>{if(0===g)return;const m={audio:{send:[],receive:[]},video:{send:[],receive:[]},screenShare:{send:[],receive:[]},transports:[]};for(const[g,f]of Object.entries(this._calculators.audio.send))m.audio.send.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.audio.receive))m.audio.receive.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.video.send))m.video.send.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.video.receive))m.video.receive.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.screenShare.send))m.screenShare.send.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.screenShare.receive))m.screenShare.receive.push({id:g,...f.popAggregates()});for(const[g,f]of Object.entries(this._calculators.transports))m.transports.push({id:g,...f.popAggregates()});m.video.send=convertAltLayouts(m.video.send),m.screenShare.send=convertAltLayouts(m.screenShare.send),this._eventEmitter.emit("summaryReported",m),g=0};let m=1e3*this._aggregationInterval;for(;!this._disposed;){const f=[this._calculators.audio.send,this._calculators.audio.receive,this._calculators.video.send,this._calculators.video.receive,this._calculators.screenShare.send,this._calculators.screenShare.receive,this._calculators.transports];if(this._isActive){m>0&&await wait((()=>this._callStateChanged.promise),m).catch((g=>{}));const S=Date.now();for(const g of f)for(const[,m]of Object.entries(g))m.aggregate();g++,g===this._dataPointsPerAggregation&&flushData();const v=Date.now();m=S+1e3*this._aggregationInterval-v}else flushData(),this._calculators=og(),await this._callStateChanged.promise.catch((g=>{})),m=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}class AbstractTicker{constructor(){this._eventEmitter=new bu.EventEmitter,this._getCurrentTime=globalThis.performance&&"function"==typeof globalThis.performance.now?()=>globalThis.performance.now():()=>Date.now()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._eventEmitter.removeAllListeners()}}class IntervalTicker extends AbstractTicker{constructor(g){super(),this._intervalInMs=g,this._handle=0}start(){this._handle||(this._handle=globalThis.setInterval((()=>{this._eventEmitter.emit("tick")}),this._intervalInMs))}stop(){this._handle&&(globalThis.clearInterval(this._handle),this._handle=0)}dispose(){this.stop(),super.dispose()}}class ChainedTimeoutTicker extends AbstractTicker{constructor(g){super(),this._intervalInMs=g,this._callQueue=Promise.resolve(),this._state={isRunning:!1}}start(){if(this._state.isRunning)return;const g={isRunning:!0};this._state=g;const runLoop=async()=>{for(;g.isRunning;){const g=this._getCurrentTime();this._eventEmitter.emit("tick");const m=this._getCurrentTime()-g;m<this._intervalInMs&&await sleep(this._intervalInMs-m)}};this._callQueue=this._callQueue.then((()=>runLoop())).catch((()=>{}))}stop(){this._state.isRunning&&(this._state.isRunning=!1)}dispose(){this._state.isRunning=!1,super.dispose()}}class TickerFactory{static createTicker(g,m){if("interval"===g)return new IntervalTicker(m);if("timeout"===g)return new ChainedTimeoutTicker(m);throw new Error(`Invalid tickerType: ${g}`)}}class StatsPoller{constructor(g,m,f,S){this._tsCall=g,this._logger=m,this._dataEventRefCount=0,this._lastFetchTime=0,this._timerDelayRatio=0,this._pendingStats=!1,this._fetchInterval=f,this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1});const v=1e3*f;this._ticker=TickerFactory.createTicker(S,v),this._ticker.on("tick",(()=>{const g=Date.now();this._lastFetchTime>0&&(this._timerDelayRatio=(g-this._lastFetchTime)/v),this._lastFetchTime=g,this._dataEventRefCount>0&&!1===this._pendingStats&&(this._pendingStats=!0,this.getStats().then((g=>{g&&this._eventEmitter.emit("data",g)})).catch((g=>{this._logger.error(g)})).finally((()=>{this._pendingStats=!1})))}));const checkState=()=>{[10,3].includes(this._tsCall.state)?this._start():this._stop()};this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{checkState()})),checkState()}dispose(){this._callStateChangedHandle.dispose(),this._ticker.dispose()}get fetchInterval(){return this._fetchInterval}get timerDelayRatio(){return this._timerDelayRatio}_start(){this._lastFetchTime=0,this._timerDelayRatio=0,this._ticker.start()}_stop(){this._ticker.stop()}on(g,m){this._dataEventRefCount++,this._eventEmitter.on(g,m)}off(g,m){this._dataEventRefCount--,this._eventEmitter.off(g,m)}}class MediaStatsPoller extends StatsPoller{constructor(g,m,f){super(g,m.createChild("MediaStatsPoller"),f.fetchInterval,f.pollingMethod)}async getStats(){return{report:this._tsCall.getMediaSessionStats(),delayRatio:this.timerDelayRatio}}}var lg;!function(g){g[g.Running=0]="Running",g[g.Paused=1]="Paused",g[g.Stopped=2]="Stopped"}(lg||(lg={}));class MediaStatsSourceNode{constructor(){this._sinks=[],this._transformers=[],this._state=lg.Running}_setTransformers(g){this._transformers=g.slice()}addSink(g){g.source=this,this._sinks.push(g),g.onAdded(this._state===lg.Running)}removeSink(g){g.source===this&&(R.pull(this._sinks,g),g.source=void 0,g.onRemoved())}removeAllSinks(){const g=this._sinks;this._sinks=[],g.forEach((g=>{g.source=void 0,g.onRemoved()}))}send(g){if(this._state!==lg.Running)return;let m=g;this._transformers.length&&(m=this._transformers.reduce(((g,m)=>m.transform(g)),g)),this._sinks.forEach((g=>g.onReport(m)))}pause(){this._state===lg.Running&&(this._state=lg.Paused,this._sinks.forEach((g=>g.pause())))}resume(){this._state===lg.Paused&&(this._state=lg.Running,this._sinks.forEach((g=>g.resume())))}stop(){this._state!==lg.Stopped&&this._sinks.forEach((g=>g.stop()))}}class MediaStatsReportSourceNode extends MediaStatsSourceNode{constructor(g){super(),this._setTransformers(g)}onReport(g){if(void 0===g.report)return;const m=createMediaStatsReportInternalObject();m.metadata=m.metadata??{},m.metadata.delayRatio=g.delayRatio;const f=[[g.report.audio.send,m.audio.send],[g.report.audio.recv,m.audio.receive],[g.report.video.send,m.video.send],[g.report.video.recv,m.video.receive],[g.report.screenShare.send,m.screenShare.send],[g.report.screenShare.recv,m.screenShare.receive],[g.report.data,m.dataChannel],[g.report.transports,m.transports]],extractKV=g=>{const m={};return Object.entries(g).forEach((g=>{const f=g[0],S=g[1];"altLayouts"!==f&&null!=S&&(m[f]=S)})),m};f.forEach((g=>{const m=g[0];if(void 0!==m){const f=g[1];m.forEach((g=>{const m=R.toString(g.id);if(f[m]=extractKV(g),void 0!==g.altLayouts){g.altLayouts.forEach((g=>{const S=g.id,v=extractKV(g);v.groupId=m,f[S]=v}))}}))}})),this.send(m)}}class MediaStatsReportFilterNode extends MediaStatsSourceNode{constructor(g){super(),this._setTransformers(g)}onAdded(g){}onRemoved(){}onReport(g){this.send(g)}get source(){return this._mediaStatsSource}set source(g){this._mediaStatsSource=g}}class ParticipantMappingManager{constructor(g){this._tsCall=g,this._activeParticipantMris=new Set,this._sourceIdToParticipantInfo=new Map,this._listenerHandles=[],this._config=getAcsEcsConfig(),this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._activeParticipantMris.has(g.id)&&this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._activeParticipantMris.delete(g.id),this._removeMapping(g)}))),this._tsCall.participants?.forEach((g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))}_updateMapping(g){const m=g.id,f=[],S=this._config.calling.composedStreamBotIds;g.endpoints?.endpointDetails?.forEach((g=>{g.mediaStreams?.forEach((v=>{f.push(v.sourceId),this._sourceIdToParticipantInfo.set(v.sourceId,{mri:m,participantId:g.participantId,isComposedStream:S.includes(m)})}))}))}_removeMapping(g){g.endpoints?.endpointDetails?.forEach((g=>{g.mediaStreams?.forEach((g=>{this._sourceIdToParticipantInfo.delete(g.sourceId)}))}))}findParticipantInfo(g){let m=this._sourceIdToParticipantInfo.get(g);if(void 0===m&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const g=this._tsCall.participants[0],f=g.endpoints?.endpointDetails[0];m={mri:g.id,participantId:f?.participantId??"",isComposedStream:!1}}return m}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._sourceIdToParticipantInfo.clear(),this._listenerHandles.forEach((g=>g.dispose()))}}class MediaStatsTelemetryLogger{constructor(g,m,f,S){this._tsCall=g,this._call=m,this._telemetryLogManager=f,this._config=S,this._participantMappingManager=new ParticipantMappingManager(this._tsCall)}dispose(){this._participantMappingManager.dispose()}log(g){const m=this._config.telemetry.mediaStatsConfig;[{type:"audio",direction:"send",value:g.audio.send},{type:"audio",direction:"recv",value:g.audio.receive},{type:"video",direction:"send",value:g.video.send},{type:"video",direction:"recv",value:g.video.receive},{type:"screen",direction:"send",value:g.screenShare.send},{type:"screen",direction:"recv",value:g.screenShare.receive},{type:"data",direction:"",value:g.dataChannel},{type:"transport",direction:"",value:g.transports}].forEach((g=>{const f=Object.values(g.value);f.forEach((S=>{const v={id:S.id},C={id:S.id};Object.keys(S).forEach((g=>{const f=g;if("id"===g)return;if("events"===g){const g=S[f];return void(g.length>0&&(v.events=JSON.stringify(g)))}const _=S[f];if(m.dataToSend.raw){const g={};_?.timestamp&&(g.timestamp=_?.timestamp),m.dataToSend.raw&&(g.raw=_?.raw),C[f]=g}const E={};void 0!==_.aggregation?(_.timestamp&&(E.timestamp=_.timestamp),m.dataToSend.min&&(E.min=_.aggregation.min),m.dataToSend.max&&(E.max=_.aggregation.max),m.dataToSend.sum&&(E.sum=_.aggregation.sum),m.dataToSend.count&&(E.count=_.aggregation.count)):(_.timestamp&&(E.timestamp=_.timestamp),_.reduced?E.raw=_.reduced:_.raw&&(E.raw=_.raw)),v[f]=E}));let _="",E="";if(("video"===g.type||"screen"===g.type)&&"recv"===g.direction){const g=S;if(void 0!==g.streamId&&g.streamId.raw?.length){const m=g.streamId.raw[0],f=this._participantMappingManager.findParticipantInfo(m);_=f?.participantId??"",E=f?.isComposedStream?"ComposedVideoStream":"RemoteVideoStream"}}if(Object.keys(v).length>1){const m={mediaType:g.type,mediaDirection:g.direction,stats:v,callId:this._tsCall.callId,remoteParticipantId:_,localParticipantId:this._tsCall.participantId,videoStreamKind:E,streamCount:f.length,appliedFrameHeightMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameHeight?.max,appliedBitrateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.bitrate?.max,appliedFrameRateMaxSentConstraint:this._call.mediaConstraintsManager.currentVideoConstraints?.send?.frameRate?.max};this._sendMidCallNewMediaStats(m)}if(m.dataToSend.raw&&Object.keys(C).length>1){const m={mediaType:g.type,mediaDirection:g.direction,stats:C,callId:this._tsCall.callId,remoteParticipantId:_,localParticipantId:this._tsCall.participantId,videoStreamKind:E,streamCount:f.length};this._sendMidCallRawMediaStats(m)}}))}))}_sendMidCallNewMediaStats(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_mid_call_new_media_stats,tenant:so,properties:g})}_sendMidCallRawMediaStats(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_mid_call_raw_media_stats,tenant:so,properties:g})}}function cloneReport(){return{transform:g=>R.cloneDeep(g)}}function transformStatsReport(g){return{transform:m=>([[m.audio.send,g.audio.send],[m.audio.receive,g.audio.receive],[m.video.send,g.video.send],[m.video.receive,g.video.receive],[m.screenShare.send,g.screenShare.send],[m.screenShare.receive,g.screenShare.receive],[m.dataChannel,g.dataChannel],[m.transports,g.transports]].forEach((g=>{const m=g[0],f=g[1];R.forEach(f,((g,f)=>{!0!==g.disabled&&R.forEach(m,(m=>{let S=m[g.source];void 0!==S&&(void 0!==g.multiplier&&"number"==typeof S&&(S*=g.multiplier),g.integer&&(S=R.toInteger(S)),m[f]=S)}))}))})),m)}}function blockMetrics(g){const m=["audio.send","audio.receive","video.send","video.receive","screenShare.send","screenShare.receive","dataChannel","transports"];return{transform:f=>(R.forEach(m,(m=>{const S=R.get(f,m),v=R.get(g,m,[]);R.forEach(S,(g=>{v.forEach((m=>{"id"!==m&&delete g[m]}))}))})),f)}}function filterMetricsByRangeLimit(g,m){return{transform:f=>{const S=f.metadata?.delayRatio,v=g>0&&void 0!==S&&S>g;return R.forEach(m,((g,m)=>{const S=R.get(f,m);R.forEach(S,(m=>{R.forEach(g,((g,f)=>{if(v)delete m[f];else{const S=m[f];(void 0!==g.max&&S>g.max||void 0!==g.min&&S<g.min||R.isNaN(S))&&delete m[f]}}))}))})),f}}}const cg={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},frameRateInput:{aggregable:!0},frameWidthInput:{aggregable:!0},frameHeightInput:{aggregable:!0},framesEncoded:{},frameRateEncoded:{aggregable:!0},framesSent:{},frameRateSent:{aggregable:!0},frameWidthSent:{aggregable:!0},frameHeightSent:{aggregable:!0},keyFramesEncoded:{},transportId:{}},dg={codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},streamId:{},jitterBufferDelayInMs:{aggregable:!0},frameRateDecoded:{aggregable:!0},frameRateReceived:{aggregable:!0},frameWidthReceived:{aggregable:!0},frameHeightReceived:{aggregable:!0},longestFreezeDurationInMs:{},totalFreezeDurationInMs:{},framesReceived:{},framesDropped:{},framesDecoded:{},keyFramesDecoded:{},transportId:{}},hg={audio:{send:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},audioInputLevel:{aggregable:!0},transportId:{}},receive:{codecName:{},bitrate:{aggregable:!0},jitterInMs:{aggregable:!0},packets:{},packetsPerSecond:{aggregable:!0},packetsLost:{},packetsLostPerSecond:{aggregable:!0},rttInMs:{aggregable:!0},jitterBufferDelayInMs:{aggregable:!0},audioOutputLevel:{aggregable:!0},healedRatio:{aggregable:!0},transportId:{}}},video:{send:cg,receive:dg},screenShare:{send:cg,receive:dg},dataChannel:{incomingBitrate:{aggregable:!0},outgoingBitrate:{aggregable:!0},messagesSentPerSecond:{aggregable:!0},messagesReceivedPerSecond:{aggregable:!0}},transports:{rttInMs:{aggregable:!0},availableIncomingBitrate:{aggregable:!0},availableOutgoingBitrate:{aggregable:!0}}},ug={codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},framesEncoded:{raw_data_reduction:!0},framesSent:{raw_data_reduction:!0},keyFramesEncoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0},groupId:{raw_data_reduction:!0}},gg={codecName:{raw_data_reduction:!0},streamId:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},longestFreezeDurationInMs:{skip:!0},totalFreezeDurationInMs:{raw_data_reduction:!0},framesReceived:{raw_data_reduction:!0},framesDropped:{raw_data_reduction:!0},framesDecoded:{raw_data_reduction:!0},keyFramesDecoded:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},pg={audio:{send:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}},receive:{codecName:{raw_data_reduction:!0},packets:{raw_data_reduction:!0},packetsLost:{raw_data_reduction:!0},jitterBufferDelayInMs:{output_key:"jitterBufferInMs"},pairRttInMs:{aggregable:!0},availableBitrate:{aggregable:!0},transportId:{skip:!0}}},video:{send:ug,receive:gg},screenShare:{send:ug,receive:gg},dataChannel:{state:{raw_data_reduction:!0},dataChannelIdentifier:{raw_data_reduction:!0},messagesSent:{raw_data_reduction:!0},bytesSent:{raw_data_reduction:!0},messagesReceived:{raw_data_reduction:!0},bytesReceived:{raw_data_reduction:!0}},transports:{candidateType:{events:!0},relayProtocol:{events:!0}}},mg={multiplier:1e3,integer:!0,source:"jitter"},fg={multiplier:1e3,integer:!0,source:"rtt"},Sg={integer:!0,source:"jitterBufferMs"},vg={jitterInMs:mg,rttInMs:fg},yg={jitterInMs:mg,rttInMs:fg,jitterBufferDelayInMs:Sg,streamId:{source:"msi"},longestFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"longestFreezeDuration"},totalFreezeDurationInMs:{multiplier:1e3,integer:!0,source:"totalFreezeDuration"}},Cg={audio:{send:{jitterInMs:mg,rttInMs:fg,audioInputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}},receive:{jitterInMs:mg,rttInMs:fg,jitterBufferDelayInMs:Sg,audioOutputLevel:{multiplier:65536,integer:!0,source:"audioLevel"}}},video:{send:vg,receive:yg},screenShare:{send:vg,receive:yg},dataChannel:{incomingBitrate:{source:"recvBitrate"},outgoingBitrate:{source:"sendBitrate"}},transports:{rttInMs:fg}};class MediaStatsManager{constructor(g,m,f,S){this._tsCall=g,this._call=m,this._logger=f,this._disposed=!1;const v=getAcsEcsConfig();this._config=v.mediaStats,this._statsPoller=new MediaStatsPoller(this._tsCall,this._logger,this._config);const C=[transformStatsReport(R.merge(R.cloneDeep(Cg),this._config.transformMetrics))];this._config.timerThrottlingFilter.enabled&&C.push(filterMetricsByRangeLimit(this._config.timerThrottlingFilter.delayRatio,this._config.timerThrottlingFilter.filterRange)),this._mediaStatsSourceNode=new MediaStatsReportSourceNode(C);const _=[3,10];this._isCallActive=_.includes(this._tsCall.state),this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{const g=_.includes(this._tsCall.state);this._isCallActive!==g&&(this._isCallActive=g,g?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause())}));const E=this._config.blockMetrics;if(Object.keys(E).length>0){const g=new MediaStatsReportFilterNode([cloneReport(),blockMetrics(E)]);this._mediaStatsSourceNode.addSink(g),this._collectorsSourceNode=g}else this._collectorsSourceNode=this._mediaStatsSourceNode;const T=v.telemetry.mediaStatsConfig;if(T.enabled){const g=new MediaStatsTelemetryLogger(this._tsCall,this._call,S,v),m=R.merge(R.cloneDeep(hg),pg,T.metricsProperties),f=new TelemetryCollector(this._logger,{aggregationInterval:T.aggregationInterval,dataPointsPerAggregation:T.dataPointsPerAggregation,metricsPropertics:m});f.on("data",(m=>g.log(m))),this._mediaStatsSourceNode.addSink(f)}this._isCallActive?this._mediaStatsSourceNode.resume():this._mediaStatsSourceNode.pause(),this._dataEventListener=g=>{this._mediaStatsSourceNode.onReport(g)},this._statsPoller.on("data",this._dataEventListener)}createCollector(g){if(this._disposed)throw new CallingCommunicationError(z.FEATURES.MEDIA_STATS.DISPOSED);const m=this._config,f=new MediaStatsCollectorImpl(this._logger,{aggregationInterval:g?.aggregationInterval??m.aggregationInterval,dataPointsPerAggregation:g?.dataPointsPerAggregation??m.dataPointsPerAggregation,metricsPropertics:hg});return this._collectorsSourceNode.addSink(f),f}dispose(){this._disposed||(this._disposed=!0,this._statsPoller.off("data",this._dataEventListener),this._mediaStatsSourceNode.stop(),this._callStateChangedHandle.dispose())}}class MediaStatsCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}get name(){return this._sendFeatureUsage("name",Lh.getter),"MediaStats"}createCollector(g){this._sendFeatureUsage("createCollector",Lh.attempt);const m=this._statsManager.createCollector(g);return this._sendFeatureUsage("creaetCollector",Lh.success),m}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._statsManager=new MediaStatsManager(g.tsCall,this._call,this._logger,this._telemetryLogManager),this._sendFeatureUsage("initialize",Lh.initialize)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"MediaStats",featureType:"Call",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._statsManager.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}var _g,Eg;!function(g){g[g.None=0]="None",g[g.Started=1]="Started",g[g.Paused=2]="Paused",g[g.Ended=3]="Ended"}(_g||(_g={}));class RecordingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new RecordingCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"Recording"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Lh.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Lh.getter),this._impl.recordings}on(g,m){if("isRecordingActiveChanged"!==g&&"recordingsUpdated"!==g)throw new CallingCommunicationError(z.FEATURES.RECORDING.EVENT_SUBSCRIBE(g));this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("isRecordingActiveChanged"!==g&&"recordingsUpdated"!==g)throw new CallingCommunicationError(z.FEATURES.RECORDING.EVENT_UNSUBSCRIBE(g));this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Recording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class RecordingCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._recordingBots=new Map,this._recordingBotChangedSubs=new WeakMap,this._recordingInitiatorMap=new Map,this._isRecordingActive=!1,this._updateIsCallRecorded=g=>this._isRecordingActive!==g&&(this._isRecordingActive=g,this._logger.info(`Updating isCallRecorded to ${g}`),!0),this._handleRecordingBotAdded=g=>{const handleRecordingBotChanged=()=>{let m,f=!1,S=!1;if(this._hasRecordingState(g)){if(this._recordingBots.has(g.id)){let f=this._getRecordingBotEndpoint(g);if(m=this._recordingBots.get(g.id),f&&m){m.endpoint=f;let g=f.userId?this._recordingInitiatorMap.get(f.userId):void 0;S=m.recordingInfo?.update(f,g)??!1}}else m=this._getRecordingBotInfo(g),m&&(this._logger.info("Adding recording bot"),this._recordingBots.set(g.id,m),f=!0);this._sendEvents(S?[m]:void 0,f?[m]:void 0,void 0,this._updateIsCallRecorded(this._isRecordingEnabled()))}};handleRecordingBotChanged(),this._recordingBotChangedSubs.set(g,g.changed(handleRecordingBotChanged))},this._handleRecordingBotRemoved=g=>{let m=this._recordingBots.get(g.id);this._recordingBots.delete(g.id),this._recordingBotChangedSubs.get(g)?.dispose(),this._recordingBotChangedSubs.delete(g),this._logger.info(`Updating recordingState to ${m?.endpoint?.state}`),m?.recordingInfo?.dispose(),this._sendEvents([m],void 0,[m],this._updateIsCallRecorded(this._isRecordingEnabled()))},this._sendEvents=(g,m,f,S)=>{g&&g.forEach((g=>g?.recordingInfo?.sendRecordingStateChanged()));let v=!!m&&m.length>0,C=!!f&&f.length>0;(v||C)&&this._eventEmitter.emit("recordingsUpdated",{added:this._getRecordingInfos(m),removed:this._getRecordingInfos(f)}),S&&this._eventEmitter.emit("isRecordingActiveChanged")},this._hasRecordingState=g=>g?.endpoints?.endpointDetails?.some((g=>!!g?.endpointMetadata?.__platform?.recording?.compliance?.state||!!g?.endpointMetadata?.processingModes?.recording?.state))??!1,this._getRecordingInfos=g=>{if(g)return g.map((g=>g?.recordingInfo)).filter((g=>!!g))},this._isRecordingEnabled=()=>{let g=!1;try{this._recordingBots.forEach((m=>{g||(g="Active"===m?.endpoint?.state)}))}catch(g){this._logger.info("Unable to read recording state: ",g)}return g},this._getRecordingInfoImpl=g=>{if(null==g)return;if("Active"!==g.state&&"Inactive"!==g.state)return;let m;return void 0!==g.userId&&(m=this._recordingInitiatorMap.get(g.userId)),new RecordingInfoImpl(g.state,this._eventEmitter,m)},this._getRecordingBotInfo=g=>{let m=this._getRecordingBotEndpoint(g);return m?{endpoint:m,recordingInfo:this._getRecordingInfoImpl(m)}:void 0},this._getRecordingBotEndpoint=g=>{let m=g.endpoints?.endpointDetails.map((g=>{let m=g?.endpointMetadata?.__platform?.recording?.compliance?.state,f=g?.endpointMetadata?.__platform?.recording?.compliance?.userId,S=g?.endpointMetadata?.processingModes?.recording?.state,v=g?.endpointMetadata?.processingModes?.recording?.userId;if(m||S)return{state:m??S,userId:f??v}})).filter((g=>null!=g));if(m&&0!=m.length)return m.length>1&&this._logger.log(`Unexpected: multiple recording endpoints: ${m?.map((g=>g?.state??"undefined")).join(", ")}`),m[0]}}get isRecordingActive(){return this._isRecordingActive}get recordings(){return Array.from(this._recordingBots.values()).map((g=>g?.recordingInfo)).filter((g=>!!g))}initialize(g,m,f){this._logger=f.createChild((()=>`RecordingFeature::Call(id='${g.callId}', state='${g.state}')`)),g.on("callStateChanged",(async()=>{3===g.state&&this._initInitiatorMap(g)})),g.on("participantAdded",(async g=>{isCallingApplication(g.id)?this._handleRecordingBotAdded(g):void 0===g||this._recordingInitiatorMap.has(g.id)||this._recordingInitiatorMap.set(g.id,g.displayName)})),g.on("participantRemoved",(async g=>{isCallingApplication(g.id)?this._handleRecordingBotRemoved(g):void 0!==g&&this._recordingInitiatorMap.has(g.id)&&this._recordingInitiatorMap.delete(g.id)})),g.on("participantUpdated",(async g=>{void 0!==g&&this._recordingInitiatorMap.has(g.id)&&this._recordingInitiatorMap.set(g.id,g.displayName)}))}dispose(){let g=this._updateIsCallRecorded(!1),m=Array.from(this._recordingBots.values());m.forEach((g=>g?.recordingInfo?.dispose())),this._sendEvents(void 0,void 0,m,g)}_initInitiatorMap(g){const{participants:m}=g;[...m].forEach((g=>{isCallingApplication(g.id)||this._recordingInitiatorMap.set(g.id,g.displayName)}))}}class RecordingInfoImpl{constructor(g,m,f){this.state=this.getRecordingState(g),this._eventEmitter=m,this.displayName=f}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}update(g,m){if(null==g)return!1;let f=this.getRecordingState(g.state);return f!=this.state&&(this.state=f,void 0!==m&&(this.displayName=m),!0)}dispose(){this.state=_g.Ended}sendRecordingStateChanged(){this._eventEmitter.emit("recordingStateChanged")}getRecordingState(g){let m=_g.None;switch(g?.toLocaleLowerCase()){case"active":m=_g.Started;break;case"inactive":m=_g.Paused;break;default:m=_g.None}return m}}!function(g){g[g.None=0]="None",g[g.Started=1]="Started",g[g.Ended=2]="Ended"}(Eg||(Eg={}));const Tg={ACTIVE:"active",INACTIVE:"inactive"};class LocalRecordingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new LocalRecordingCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"LocalRecording"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}get isRecordingActive(){return this._sendFeatureUsage("isRecordingActive",Lh.getter),this._impl.isRecordingActive}get recordings(){return this._sendFeatureUsage("recordings",Lh.getter),this._impl.recordings}on(g,m){if("isLocalRecordingActiveChanged"!==g&&"localRecordingsUpdated"!==g)throw new CallingCommunicationError(z.FEATURES.RECORDING.EVENT_SUBSCRIBE(g));this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("isLocalRecordingActiveChanged"!==g&&"localRecordingsUpdated"!==g)throw new CallingCommunicationError(z.FEATURES.RECORDING.EVENT_UNSUBSCRIBE(g));this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m,f){let S=f?{code:f?.code||H,subCode:f?.subCode||0,failureReason:f?.message||""}:void 0;sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"LocalRecording",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:S},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class LocalRecordingCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._localRecordingInitiators=new Map,this._sendEvents=(g,m,f)=>{let S=!!g&&g.length>0,v=!!m&&m.length>0;(S||v)&&this._eventEmitter.emit("localRecordingsUpdated",{added:g,removed:m}),f&&this._eventEmitter.emit("isLocalRecordingActiveChanged")},this._isEnabled=getAcsEcsConfig().calling.localRecording.enabled,this._supportedConversationTypes=getAcsEcsConfig().calling.localRecording.supportedConversationTypes}get isRecordingActive(){return this._localRecordingInitiators.size>0}get recordings(){return Array.from(this._localRecordingInitiators.values())}initialize(g,m,f){if(this._logger=f.createChild((()=>`LocalRecordingFeature::Call(id='${g.callId}', state='${g.state}')`)),!this._isEnabled){const g="Local Recording feature is is disabled",m=new CallingCommunicationError(z.FEATURES.LOCAL_RECORDING.DISABLED);throw this._logger.error(g),m}g.on("callStateChanged",(async()=>{if(3===g.state){if(!this._supportedConversationTypes.includes(g.conversationType)){const g="Local Recording feature is only available in meetings",m=new CallingCommunicationError(z.FEATURES.LOCAL_RECORDING.ONLY_AVAILABLE_IN_MEETINGS);throw this._logger.error(g),m}this.initLocalRecordingStatus(g)}})),g.on("participantUpdated",(m=>this._onParticipantUpdatedEvent(g,m,m.endpoints?.endpointDetails)))}dispose(){let g=this._localRecordingInitiators.size>0,m=Array.from(this._localRecordingInitiators.values());m.forEach((g=>g?.dispose())),g&&(g=0==this._localRecordingInitiators.size),this._sendEvents(void 0,m,g)}hasOngoingLocalRecording(g){return g?.some((g=>(g.propertyBag?.localRecording?.value?.state||"")===Tg.ACTIVE))||!1}initLocalRecordingStatus(g){const{participants:m}=g,f=[...m];this._localRecordingInitiators=new Map(f.filter((g=>this.hasOngoingLocalRecording(g.endpoints?.endpointDetails))).map((g=>[g.id,this._getLocalRecordingInfo(g)])))}_onParticipantUpdatedEvent(g,m,f){m?isCallingApplication(m.id)||(this.hasOngoingLocalRecording(f)?this._tryAddLocalRecordingInitiator(g,m):this._tryRemoveLocalRecordingInitiator(g,m)):this._logger.error(`Empty participant, skip update event processing. CallId: ${g.callId}`)}_tryAddLocalRecordingInitiator(g,m){const{callId:f}=g;if(!this._localRecordingInitiators.has(m.id)){this._logger.info(`Add local recording participant: ${m.id}, callId: ${f}`);let g=this._getLocalRecordingInfo(m);this._localRecordingInitiators.set(m.id,g),this._sendEvents([g],void 0,1==this._localRecordingInitiators.size)}}_tryRemoveLocalRecordingInitiator(g,m){const{callId:f}=g;if(this._localRecordingInitiators.has(m.id)){this._logger.info(`Remove local recording participant: ${m.id}, callId: ${f}`);let g=this._localRecordingInitiators.get(m.id);g.update(Tg.INACTIVE),this._localRecordingInitiators.delete(m.id),this._sendEvents(void 0,[g],0==this._localRecordingInitiators.size)}}_getLocalRecordingInfo(g){let m=g.displayName;return new LocalRecordingInfoImpl(Tg.ACTIVE,m)}}class LocalRecordingInfoImpl{constructor(g,m){this.state=this.getRecordingState(g),this.displayName=m}update(g){let m=this.getRecordingState(g);return m!=this.state&&(this.state=m,!0)}dispose(){this.state=Eg.Ended}getRecordingState(g){let m=Eg.None;switch(g?.toLocaleLowerCase()){case"active":m=Eg.Started;break;case"inactive":m=Eg.Ended;break;default:m=Eg.None}return m}}class TranscriptionCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TranscriptionCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"Transcription"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}get isTranscriptionActive(){return this._sendFeatureUsage("isTranscriptionActive",Lh.getter),this._impl.isTranscriptionActive}on(g,m){this._sendFeatureUsage("isTranscriptionActiveChanged",Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage("isTranscriptionActiveChanged",Lh.unsubscribe),this.eventEmitter.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transcription",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class TranscriptionCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._botChangedSubs=new Map,this._isTranscriptionActive=!1,this._updateIsTranscriptionActive=g=>{this._isTranscriptionActive!==g&&(this._isTranscriptionActive=g,this._logger.info(`Updating isTranscriptionActive to ${g}`),this._eventEmitter.emit("isTranscriptionActiveChanged"))},this._isCallingApplication=g=>isCallingApplication(g.id),this._handleBotRemoved=g=>{this._botChangedSubs.get(g)?.dispose(),this._botChangedSubs.delete(g),this._checkIfAbotIsTranscribing()},this._handleBotAdded=g=>{this._botChangedSubs.set(g,g.changed(this._checkIfAbotIsTranscribing)),this._checkIfAbotIsTranscribing()},this._checkIfAbotIsTranscribing=()=>{try{Array.from(this._botChangedSubs.keys()).find((g=>g.endpoints?.endpointDetails?.find((g=>"Active"===g?.endpointMetadata?.processingModes?.realTimeTranscript?.state))))?this._updateIsTranscriptionActive(!0):this._updateIsTranscriptionActive(!1)}catch(g){this._logger.warn("Unable to read transcription state: ",g)}}}get isTranscriptionActive(){return this._isTranscriptionActive}initialize(g,m,f){this._logger=f.createChild((()=>`TranscriptionFeature::Call(id='${g.callId}', state='${g.state}')`)),g.on("participantAdded",(g=>{this._isCallingApplication(g)&&this._handleBotAdded(g)})),g.participants.forEach((g=>{this._isCallingApplication(g)&&this._handleBotAdded(g)})),g.on("participantRemoved",(g=>{this._isCallingApplication(g)&&this._handleBotRemoved(g)}))}dispose(){this._updateIsTranscriptionActive(!1),this._botChangedSubs.forEach(((g,m)=>g.dispose())),this._botChangedSubs.clear()}}class TransferImpl{get state(){return this._state}get error(){return this._error}constructor(g,m,f=!0){return this._eventEmitter=new bu.EventEmitter,this._lastTsTransferState=0,this._getTransferEndReason=(g,m=0)=>{let f=m,S=0,v=g||"Unknown";this._tsCall&&(f=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo.callControllerCode||m,S=this._tsCall.transferDiagnosticsInfo&&this._tsCall.transferDiagnosticsInfo?.callControllerSubCode||0,v=convertTerminatedReasonToString(this._tsCall.terminatedReason));const C={code:f,subCode:S};return this._logger[0===f?"info":"error"](`Transfer end reason=${v}, code=${f}, subCode=${S}`),C},this._state="None",this._logger=m.createChild((()=>"Transfer")),this._logger.log("created"),this._tsCall=g,f?4!==g.state?(this._logger.error("Transfer end reason= call must be on hold before transfer"),this._error={code:U},void this.setTransferState(4)):(this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState),void this._tsCall.changed((()=>{this._tsCall.transferState!==this._lastTsTransferState&&(this._logger.log(`tsCall transfer state changed=${this._tsCall.transferState}`),this._lastTsTransferState=this._tsCall.transferState,this.setTransferState(this._tsCall.transferState))}))):(this._logger.error("Transfer end reason= call was not found with this callId"),this._error={code:U},void this.setTransferState(4))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}setTransferState(g){let m,f;const S={0:"None",1:"Transferring",2:"Transferring",3:"Transferred",4:"Failed"};S[g]?(m=S[g],"Failed"===m&&(f=this._getTransferEndReason(),this._error=f),this._logger.log(`Mapped ts transfer state:[${g}] to [${m}]`),this._setTransferState(m)):this._logger.warn(`unable to map tsCall state=[${g}] to transfer state`)}_setTransferState(g){g!==this._state&&(this._logger.log(`transfer state changed [${this._state}]=>[${this.state}]`),this._state=g,this._eventEmitter.emit("stateChanged"))}}var __decorate$2=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$2=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TransferCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TransferCallImplOverTsCall(this.eventEmitter)}get name(){return this._sendFeatureUsage("name",Lh.getter),"Transfer"}transfer(g,m){return this._impl.transfer(g,m)}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m),this._sendFeatureUsage("initialize",Lh.initialize)}on(g,m){this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._call.id,localParticipantId:this._call.tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class TransferCallImplOverTsCall{constructor(g){this._eventEmitter=g,this._autoAccept=getAcsEcsConfig().calling.transfer.autoAccept}initialize(g,m,f,S){this._logger=S.createChild((()=>`TransferFeature::Call(id='${g.callId}', state='${g.state}')`)),this._telemetryLogManager=f,this._tsCall=g,this._callAgent=m,g.on("transferRequested",(g=>{const m=this.getTransferRequestPayload(g);if(this._autoAccept){const g=m.accept();this._eventEmitter.emit("transferAccepted",{targetCall:g})}}))}transfer(g,m){let f="safe";if(g.targetCallId&&(f="consultative"),this._sendFeatureUsage(f,Lh.attempt),!this.isTransferable(this._tsCall))throw this._sendFeatureUsage(f,Lh.failure),new CallingCommunicationError(z.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE);try{let S;switch(f){case"safe":return S=this.transferToParticipant(g.targetParticipant,m),this._sendFeatureUsage(f,Lh.success),S;case"consultative":return S=this.transferToCall(g.targetCallId,m),this._sendFeatureUsage(f,Lh.success),S}}catch(g){if(this._sendFeatureUsage(f,Lh.failure),g instanceof CallingCommunicationError)throw g}throw this._sendFeatureUsage(f,Lh.failure),new CallingCommunicationError(z.FEATURES.TRANSFER.TARGET_NOT_RECOGNIZED)}getTransferRequestPayload(g){const m=constructIdentifierKindFromMri(g.transferContext.targetMri);if("communicationUser"===m.kind||"phoneNumber"===m.kind||"microsoftTeamsUser"===m.kind||"unknown"===m.kind||"microsoftTeamsApp"===m.kind){let m=!1;const f={accept:()=>{let f;try{if(f=this._callAgent.createTransferTargetCall(g.transferContext),m)return this._logger.info("Transfer accept was called when transfer action is already in progress."),f;m=!0;const S={threadId:"",messageId:void 0,transferContext:g.transferContext,mediaPeerType:0};f.startCallInternal(void 0,!1,void 0,S).catch((f=>{m=!1,g.onCompleted(7),this._logger.error("Transfer to target failed at call start")}));const callReplacementCallBack=()=>{if(m)switch(f.state){case"Connected":m=!1,g.onCompleted(1),this._logger.info("Transfer Completed"),f.off("stateChanged",(()=>{}));break;case"Disconnected":m=!1,g.onCompleted(7),this._logger.info(`Transfer call disconnected. \n                                            code = ${f.callEndReason?.code} \n                                            subcode = ${f.callEndReason?.subCode} \n                                            message = ${f.callEndReason?.message} \n                                            result categories = ${f.callEndReason?.resultCategories}`),f.off("stateChanged",(()=>{}))}};return f.on("stateChanged",callReplacementCallBack),f}catch(f){throw m=!1,g.onCompleted(7),this._logger.error("Transfer to target failed at call create"),new CallingCommunicationError(z.FEATURES.TRANSFER.TRANSFER_TO_TARGET_FAILED,f)}}};return f}throw new CallingCommunicationError(z.FEATURES.TRANSFER.INVALID_TARGET_TYPE(m))}isTransferable(g){return 1===g.callType||g.participants.filter((g=>!isCallingApplication(g.id))).length<=2}transferToParticipant(g,m){let f=getMriFromIdentifier(g);4===this._tsCall.state&&this._tsCall.callSafeTransfer(f,void 0,m);return new TransferImpl(this._tsCall,this._logger)}transferToCall(g,m){const f=this._callAgent.getCallByCallId(g);if(f&&!this.isTransferable(f))throw new CallingCommunicationError(z.FEATURES.TRANSFER.UNSUPPORTED_CALL_TYPE);f&&4===this._tsCall.state&&this._tsCall.callConsultativeTransfer(f,void 0,void 0,m);return new TransferImpl(this._tsCall,this._logger,!!f)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Transfer",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){}}__decorate$2([syncOperation(Ru.Transfer),__metadata$2("design:type",Function),__metadata$2("design:paramtypes",[Object,Object]),__metadata$2("design:returntype",Object)],TransferCallImplOverTsCall.prototype,"transfer",null);class VideoDeviceInfoImpl{constructor(g,m,f,S){this._name=g,this._id=m,this._deviceType=f,this._deviceManager=S}get name(){return this._name}setName(g){this._name=g}get id(){return this._id}setId(g){this._id=g}get deviceType(){return this._deviceType}setDeviceType(g){this._deviceType=g}get deviceManager(){return this._deviceManager}}function loggerProperty(g,m){Reflect.defineMetadata(K,m,g)}function Deque(g){if(this._capacity=getCapacity(g),this._length=0,this._front=0,Ig(g)){for(var m=g.length,f=0;f<m;++f)this[f]=g[f];this._length=m}}Deque.prototype.toArray=function Deque$toArray(){for(var g=this._length,m=new Array(g),f=this._front,S=this._capacity,v=0;v<g;++v)m[v]=this[f+v&S-1];return m},Deque.prototype.push=function Deque$push(g){var m=arguments.length,f=this._length;if(m>1){var S=this._capacity;if(f+m>S){for(var v=0;v<m;++v){this._checkCapacity(f+1),this[C=this._front+f&this._capacity-1]=arguments[v],f++,this._length=f}return f}for(var C=this._front,v=0;v<m;++v)this[C+f&S-1]=arguments[v],C++;return this._length=f+m,f+m}return 0===m?f:(this._checkCapacity(f+1),this[v=this._front+f&this._capacity-1]=g,this._length=f+1,f+1)},Deque.prototype.pop=function Deque$pop(){var g=this._length;if(0!==g){var m=this._front+g-1&this._capacity-1,f=this[m];return this[m]=void 0,this._length=g-1,f}},Deque.prototype.shift=function Deque$shift(){var g=this._length;if(0!==g){var m=this._front,f=this[m];return this[m]=void 0,this._front=m+1&this._capacity-1,this._length=g-1,f}},Deque.prototype.unshift=function Deque$unshift(g){var m=this._length,f=arguments.length;if(f>1){if(m+f>(v=this._capacity)){for(var S=f-1;S>=0;S--){this._checkCapacity(m+1);var v=this._capacity;this[_=(this._front-1&v-1^v)-v]=arguments[S],m++,this._length=m,this._front=_}return m}var C=this._front;for(S=f-1;S>=0;S--){var _;this[_=(C-1&v-1^v)-v]=arguments[S],C=_}return this._front=C,this._length=m+f,m+f}if(0===f)return m;this._checkCapacity(m+1);v=this._capacity;return this[S=(this._front-1&v-1^v)-v]=g,this._length=m+1,this._front=S,m+1},Deque.prototype.peekBack=function Deque$peekBack(){var g=this._length;if(0!==g)return this[this._front+g-1&this._capacity-1]},Deque.prototype.peekFront=function Deque$peekFront(){if(0!==this._length)return this[this._front]},Deque.prototype.get=function Deque$get(g){var m=g;if(m===(0|m)){var f=this._length;if(m<0&&(m+=f),!(m<0||m>=f))return this[this._front+m&this._capacity-1]}},Deque.prototype.isEmpty=function Deque$isEmpty(){return 0===this._length},Deque.prototype.clear=function Deque$clear(){for(var g=this._length,m=this._front,f=this._capacity,S=0;S<g;++S)this[m+S&f-1]=void 0;this._length=0,this._front=0},Deque.prototype.toString=function Deque$toString(){return this.toArray().toString()},Deque.prototype.valueOf=Deque.prototype.toString,Deque.prototype.removeFront=Deque.prototype.shift,Deque.prototype.removeBack=Deque.prototype.pop,Deque.prototype.insertFront=Deque.prototype.unshift,Deque.prototype.insertBack=Deque.prototype.push,Deque.prototype.enqueue=Deque.prototype.push,Deque.prototype.dequeue=Deque.prototype.shift,Deque.prototype.toJSON=Deque.prototype.toArray,Object.defineProperty(Deque.prototype,"length",{get:function(){return this._length},set:function(){throw new RangeError("")}}),Deque.prototype._checkCapacity=function Deque$_checkCapacity(g){this._capacity<g&&this._resizeTo(getCapacity(1.5*this._capacity+16))},Deque.prototype._resizeTo=function Deque$_resizeTo(g){var m=this._capacity;this._capacity=g;var f=this._front,S=this._length;f+S>m&&arrayMove(this,0,this,m,f+S&m-1)};var Ig=Array.isArray;function arrayMove(g,m,f,S,v){for(var C=0;C<v;++C)f[C+S]=g[C+m],g[C+m]=void 0}function pow2AtLeast(g){return g>>>=0,g-=1,g|=g>>1,g|=g>>2,g|=g>>4,g|=g>>8,(g|=g>>16)+1}function getCapacity(g){if("number"!=typeof g){if(!Ig(g))return 16;g=g.length}return pow2AtLeast(Math.min(Math.max(16,g),1073741824))}var bg=Deque;class DefaultLogger{static overrideDefaultLogDump(){if(DefaultLogger.logDump.isEmpty())DefaultLogger.logDump=new bg(getAcsEcsConfig()?.debugInfo?.maxLogDumpLength);else{let g=new bg(getAcsEcsConfig()?.debugInfo?.maxLogDumpLength);for(;DefaultLogger.logDump.length>0;){const m=DefaultLogger.logDump.shift();m&&g.push(m)}DefaultLogger.logDump=g}}constructor(g,m=[],f=DefaultLogger.defaultLogRedirect){this._azureLogger=g,this._namespace=m,this._logRedirectCallback=f}createChild(g){return new DefaultLogger(this._azureLogger,[...this._namespace,"string"==typeof g?()=>g:g])}createFnLogger(g,m,...f){return this.createChild(this.getPrefix(g,m)+f.join(""))}log(...g){const m=this.getMessage(g);this._azureLogger.verbose(m),this._logRedirectCallback(`log:${m}`)}debug(...g){const m=this.getMessage(g);this._azureLogger.verbose(m),this._logRedirectCallback(`debug:${m}`)}info(...g){const m=this.getMessage(g);this._azureLogger.info(m),this._logRedirectCallback(`info:${m}`)}warn(...g){const m=this.getMessage(g);this._azureLogger.warning(m),this._logRedirectCallback(`warn:${m}`)}error(...g){const m=this.getMessage(g);this._azureLogger.error(this.getMessage(g)),this._logRedirectCallback(`error::${m}`)}getMessage(...g){return`${getDateInIsoFormat()} ${this.getNamespace()} ${g.join(" ")}`}getNamespace(){return this._namespace.map((g=>g())).join(":")}getPrefix(g,m){let f="";return m&&(f+=m),g&&(f+=g),f}redirectLog(g){this._logRedirectCallback=m=>{DefaultLogger.defaultLogRedirect(m),g(m)}}dumpAllLogs(){return[...DefaultLogger.logDump.toArray()]}}DefaultLogger.logDump=new bg(Ba),DefaultLogger.defaultLogRedirect=g=>{if(getAcsEcsConfig()?.debugInfo?.enableLogDump){const sizeCheck=()=>{DefaultLogger.logDump.length>getAcsEcsConfig()?.debugInfo?.maxLogDumpLength&&DefaultLogger.logDump.shift()};if(getAcsEcsConfig()?.debugInfo?.includeList.some((m=>R.includes(g,m))))return DefaultLogger.logDump.push(g),void sizeCheck();if(!getAcsEcsConfig()?.debugInfo?.excludeList.some((m=>R.includes(g,m))))return DefaultLogger.logDump.push(g),void sizeCheck()}};var __decorate$3=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$3=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class StreamTelemetryEventSender{constructor(g){this._telemetryLogManager=g}sendMediaStreamEvent(g){this._telemetryLogManager?.sendEvent({name:kh.acs_calling_media_stream,tenant:so,properties:{correlationId:g.correlationId,mediaType:g.mediaType,operation:g.operation,timestampInfo:g.timestampInfo,streamType:g.streamType||fu.Local,additionalDetails:g.additionalDetails||"",kindOfEvent:g.kindOfEvent||"",callId:g.callId||"",localPaticipantId:g.localParticipantId||""}})}}__decorate$3([loggerProperty,__metadata$3("design:type",Object)],StreamTelemetryEventSender.prototype,"logger",void 0);var Ag,__decorate$4=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$4=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalVideoStream{constructor(m){if(this._disposed=!1,this._call=new Set,this._canStartEffects=!1,this.kind="LocalVideoStream",this._renderers=[],this._disposeRenderer=g=>{this.logger.log("disposing renderer");try{g.dispose(),this.logger.log("renderer disposed")}catch(g){this.logger.log("failed to dispose renderer")}},!(m instanceof VideoDeviceInfoImpl||m instanceof MediaStream))throw new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.WRONG_STREAM_TYPE);const f=g("ACS-calling");this.logger=new DefaultLogger(f,[()=>`LocalVideoStream:${m.id}`]),this.logger.info("created"),this._eventEmitter=new CallingEventEmitter(this.logger),this.setSource(m),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._telemetryLogManager)}on(g,m){if("videoSourceChanged"!==g)throw new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("videoSourceChanged"!==g)throw new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.off(g,m)}get source(){return this._source}get mediaStreamType(){return this._mediaStreamType}get telemetryLogManager(){return this._telemetryLogManager}get callStackWebCVProvider(){return this.source?.deviceManager?.callStackWebCvProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackVideoEffectsStatusManager??null}get canStartEffects(){return this._canStartEffects}async switchSource(g){const m=this.logger.createFnLogger(nu.SwitchSource),f=+new Date,S=generateGuid(),v={timestampInfo:{attemptTimestamp:f},correlationId:S,operation:Su.switchSource,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",kindOfEvent:Lh.attempt,mediaType:mu.Video,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),!(g instanceof VideoDeviceInfoImpl)){const g=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SWITCH_SOURCE_WRONG_TYPE),m={correlationId:S,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.switchSource,additionalDetails:{failureReason:g.message,code:B,...extractCommunicationServicesErrorForTelemetry(g)},timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,mediaType:mu.Video,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(m),g}if(this._source===g){const g=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SWITCH_SAME_SOURCE),m={correlationId:S,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.switchSource,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,mediaType:mu.Video,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(m),g}try{if("RawMedia"===this._mediaStreamType){Array.from(this._call.values()).some((g=>g.localVideoStream===this))&&g.deviceManager.getTsDeviceManager().unsetRawMediaStream?.(1)}g.deviceManager.getTsDeviceManager().selectDevices({camera:g.id}),this.setSource(g);const m={correlationId:S,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:mu.Video,operation:Su.switchSource,timestampInfo:{deltaTimeInMs:+new Date-f},streamType:fu.Local,kindOfEvent:Lh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(m)}catch(g){const v=handleVideoOperationFailure(m,g),C={correlationId:S,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.switchSource,additionalDetails:{failureReason:v.message,code:B,...extractCommunicationServicesErrorForTelemetry(v)},timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,mediaType:mu.Video,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),v}}dispose(){this.logger.log("Disposing LocalVideoStream."),this._disposed?this.logger.log("already disposed"):(this.disposeRawStream(),this._renderers.forEach((g=>this._disposeRenderer(g))),this._renderers=[],this._disposed=!0)}async getMediaStream(){const g=generateGuid();let m=+new Date;const f={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",timestampInfo:{attemptTimestamp:m},operation:Su.getMediaStream,kindOfEvent:Lh.attempt,mediaType:mu.VideoRaw,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(f),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const f={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:mu.VideoRaw,operation:Su.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:fu.Local,kindOfEvent:Lh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(f),new MediaStream(this._mediaStreamSource.clone())}try{let f;if("ScreenSharing"===this._source.deviceType?f=2:"UsbCamera"!==this._source.deviceType&&"CaptureAdapter"!==this._source.deviceType&&"Virtual"!==this._source.deviceType||(f=1),!f)throw new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.CANT_GET_DEVICE_TYPE);this._rawStream||(this._rawStream=this.source.deviceManager.getRawDeviceMediaStream(f));const S={correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",mediaType:mu.VideoRaw,operation:Su.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:fu.Local,kindOfEvent:Lh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(S);const v=await(this._rawStream?.getMediaStream());return new MediaStream(v.clone())}catch(f){const S=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.GET_MEDIA_STREAM,f),v={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.getMediaStream,additionalDetails:{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)},kindOfEvent:Lh.failure,mediaType:mu.VideoRaw,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),S}}async setMediaStream(g){const m=generateGuid();let f,S=+new Date,v=!1,C=!1,_=mu.VideoRawOrScreenSharingRaw;for(let g of this._call){const m=g;if(m.localScreenSharingStream===this||m.localVideoStream===this){f=m.deviceManager,C=!0,m.localVideoStream===this?(v=!0,_=mu.VideoRaw):m.localScreenSharingStream===this&&(v=!1,_=mu.ScreenSharingRaw);break}}const E={timestampInfo:{attemptTimestamp:S},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.setMediaStream,kindOfEvent:Lh.attempt,mediaType:_,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(E),!(g instanceof MediaStream)){const g=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE),f={timestampInfo:{deltaTimeInMs:+new Date-S},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.setMediaStream,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Lh.failure,mediaType:_,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(f),g}if(this.setSource(g),getAcsEcsConfig()?.calling?.allowAccessRawMediaStream)try{if(C){const m=f?.getTsDeviceManager();if(!m?.setRawMediaStream)throw new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM_UNDEFINED_FUNC);v?m.setRawMediaStream(g,1):m.setRawMediaStream(g,2)}this._renderers.forEach((m=>{m.setSourceObject(g)}));const E={timestampInfo:{deltaTimeInMs:+new Date-S},correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.setMediaStream,kindOfEvent:Lh.success,mediaType:_,streamType:fu.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(E)}catch(g){const f=new CallingCommunicationError(z.LOCAL_VIDEO_STREAM.SET_MEDIA_STREAM,g),v={correlationId:m,callId:this.getCall()?.id||"",localParticipantId:this.getLocalParticipantId()||"",operation:Su.setMediaStream,additionalDetails:{failureReason:f.message,code:f.code,...extractCommunicationServicesErrorForTelemetry(f)},timestampInfo:{deltaTimeInMs:+new Date-S},kindOfEvent:Lh.failure,mediaType:_,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),f}}addCall(g){this._call.add(g)}removeCall(g){this._call.delete(g)}feature(g){return this._extensibleApi||(this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(g.videoStreamApiCtor)}registerRenderer(g){this._renderers.push(g)}unregisterRenderer(g){const m=this._renderers.indexOf(g);-1!==m&&this._renderers.splice(m,1)}getStreamMetadata(){let g,m,f=this.getCall();this._source instanceof VideoDeviceInfoImpl?(g=this.source.deviceManager,m=this.source.deviceType):this._mediaStreamSource instanceof MediaStream&&f&&(g=f.deviceManager);let S=-1;return f&&("Video"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&f.localVideoStream===this?S=f.tsCall.mediaStreams[0][0]?.id||-1:("ScreenSharing"===this._mediaStreamType||"RawMedia"===this.mediaStreamType&&f.localScreenSharingStream===this)&&(S=f.tsCall.mediaStreams[1][0]?.id||-1)),{source:"local",sourceId:S,streamType:this.mediaStreamType,deviceType:m||"",callId:f?.id||"",localParticipantId:f?.tsCall.participantId||"",deviceManagerPermissionState:g?JSON.stringify({cameraPermission:g.getVideoDevicePermission(),microphonePermission:g.getAudioDevicePermission()}):"",acsResourceId:g?.getAcsResourceId()||"",clientId:g?.getClientId()||""}}getLocalParticipantId(){let g="";const m=this.getCall();return m&&(g=m.tsCall.participantId),g}getCall(){for(const g of this._call)if(g.localVideoStreams.includes(this))return g}setSource(g){if(g instanceof VideoDeviceInfoImpl)this._telemetryLogManager=g.deviceManager.telemetryLogManager,this._source=g,this._mediaStreamType="ScreenSharing"===g.deviceType?"ScreenSharing":"Video",this._mediaStreamSource=void 0,this._rawStream=void 0,this._canStartEffects=!0;else{try{1===globalThis[Do]&&(this._telemetryLogManager=globalThis[Mo])}catch(g){this.logger.error("Failed to retrive telemetry logger for localVideoStream")}this._source={name:"CustomMediaStream",id:generateGuid(),deviceType:"Virtual"},this._mediaStreamSource=g,this._mediaStreamType="RawMedia",this._canStartEffects=!1}this._eventEmitter.emit("videoSourceChanged",{source:this})}subscribeToRawStreamChangedIfNeeded(){this._source instanceof VideoDeviceInfoImpl&&!this._videoSourceChangedSub&&(this._videoSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("videoSourceChanged",{source:this})})))}disposeRawStream(){this._rawStream&&this._rawStream.dispose(),this._videoSourceChangedSub?.dispose(),this._videoSourceChangedSub=void 0}}__decorate$4([loggerProperty,__metadata$4("design:type",Object)],LocalVideoStream.prototype,"logger",void 0),__decorate$4([asyncOperation(nu.SwitchSource),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[Object]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"switchSource",null),__decorate$4([asyncOperation(nu.GetMediaStream),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"getMediaStream",null),__decorate$4([asyncOperation(nu.SetMediaStream),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[MediaStream]),__metadata$4("design:returntype",Promise)],LocalVideoStream.prototype,"setMediaStream",null),__decorate$4([syncOperation(nu.Feature),__metadata$4("design:type",Function),__metadata$4("design:paramtypes",[Object]),__metadata$4("design:returntype","function"==typeof(Ag="undefined"!=typeof TFeature&&TFeature)?Ag:Object)],LocalVideoStream.prototype,"feature",null);class AudioDeviceInfoImpl{constructor(g,m,f,S,v){this._name=g,this._id=m,this._isSystemDefault=f,this._deviceType=S,this._deviceManager=v}get name(){return this._name}setName(g){this._name=g}get id(){return this._id}setId(g){this._id=g}get isSystemDefault(){return this._isSystemDefault}setIsSystemDefault(g){this._isSystemDefault=g}get deviceType(){return this._deviceType}setDeviceType(g){this._deviceType=g}get deviceManager(){return this._deviceManager}}var __decorate$5=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$5=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class VolumeImpl{constructor(g,m,f,S,v){this._workQueue=Promise.resolve(),this.logger=g.createChild("volume indicator"),this._eventEmitter=new CallingEventEmitter(this.logger,{enableLogEmit:!1}),this._isInitialized=!1,this._level=0,this._streamType=m,this._callId=S,this._localParticipantId=v,this._telemetryLogManager=f}get isInitialized(){return this._isInitialized}initialize(g){if(void 0===g)throw this.logger.error("failed to getMediaStreamTrack"),new CallingCommunicationError(z.CALL.VOLUME_TRACK);const m=generateGuid(),f=+new Date;try{this.sendVolumeEvent({eventName:kh.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),this.bindToAudioStreamVolume(g),this.sendVolumeEvent({eventName:kh.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:""})}catch(g){const S=new CallingCommunicationError(z.CALL.VOLUME_INIT,g);throw this.logger.error(S.message),this.sendVolumeEvent({eventName:kh.acs_calling_audio_stream_volume,correlationId:m,callId:this._callId||"",localParticipantId:this._localParticipantId||"",streamType:this._streamType,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}}),S}}bindToAudioStreamVolume(g){let[m,f]=this.setupVolumeCalculator(g);this._level=m();let S=setInterval((()=>{let g=m();g!==this._level&&(this._level=g,this._eventEmitter.emit("levelChanged"))}),getAcsEcsConfig()?.volumeIndicator?.microphoneVolumeSampleIntervalMs);this._volumeCallBackInterval=S,this._audioContext=f}setupVolumeCalculator(g){const m=new MediaStream(g),f=new AudioContext,S=f.createMediaStreamSource(m),v=f.createAnalyser();S.connect(v),v.fftSize=getAcsEcsConfig().volumeIndicator.fftSize,v.minDecibels=getAcsEcsConfig().volumeIndicator.minDecibels,v.maxDecibels=getAcsEcsConfig().volumeIndicator.maxDecibels,v.smoothingTimeConstant=getAcsEcsConfig().volumeIndicator.smoothingConstant;const C=new Uint8Array(v.frequencyBinCount);return[()=>{try{v.getByteFrequencyData(C);let g=0;for(const m of C)g+=m;const m=g/C.length;return m*getAcsEcsConfig().volumeIndicator.normalisedMaxVolume/getAcsEcsConfig().volumeIndicator.maxAvailableVolume}catch(g){return this.logger.error("error in calculating audio stream volume"),0}},f]}dispose(){this._isInitialized=!1;try{this._audioContext?.close().catch((g=>{this.logger.error("unable to close AudioContext")}))}catch(g){this.logger.error("unable to close MicrophoneAudioContext")}this._volumeCallBackInterval&&clearInterval(this._volumeCallBackInterval)}on(g,m){if("levelChanged"!==g)throw new CallingCommunicationError(z.CALL.VOLUME_EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("levelChanged"!==g)throw new CallingCommunicationError(z.CALL.VOLUME_EVENT_UNSUBSCRIBE(g));"levelChanged"===g&&1===this._eventEmitter.listenerCount("levelChanged")&&this.dispose()}get level(){return this._level}getVolumeIndicator(g){const executeSerialisedAsync=()=>{if(!this.isInitialized)try{this.initialize(g),this._isInitialized=!0}catch(g){const m=new CallingCommunicationError(z.CALL.VOLUME_GET,g);throw this.logger.error(m.message),m}return this},m=this._workQueue.then((()=>executeSerialisedAsync()));return this._workQueue=m.then(noop,noop),m}sendVolumeEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send screen share telemetry")}}}__decorate$5([loggerProperty,__metadata$5("design:type",Object)],VolumeImpl.prototype,"logger",void 0);var Pg,Rg,wg,__decorate$6=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$6=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalAudioStream{constructor(m){this.canStartEffects=!1;const f=g("ACS-calling");if(this.logger=new DefaultLogger(f,[()=>`LocalAudioStream for default device with source: ${!!m}`]),this._eventEmitter=new CallingEventEmitter(this.logger),!(m instanceof AudioDeviceInfoImpl||m instanceof MediaStream))throw new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.WRONG_STREAM_TYPE);if(m instanceof AudioDeviceInfoImpl&&"Microphone"!==m.deviceType)throw new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.SOURCE_WRONG_TYPE);m instanceof AudioDeviceInfoImpl?(this._source=m,this._mediaStreamType="Audio",this.canStartEffects=!0):(this._source={name:"CustomMediaStream",id:generateGuid(),deviceType:"Virtual",isSystemDefault:!1},this._mediaStreamSource=m,this._mediaStreamType="RawMedia",this.canStartEffects=!1),this._disposed=!1;try{1===globalThis[Do]&&(this._telemetryLogManager=globalThis[Mo])}catch(g){this.logger.error("Failed to retrive telemetry logger for localAudioStream")}m instanceof AudioDeviceInfoImpl&&(this._telemetryLogManager=m.deviceManager.telemetryLogManager),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._telemetryLogManager),this._volumeIndicator=new VolumeImpl(this.logger,"LocalAudioStream",this._telemetryLogManager),this.logger.info("created")}on(g,m){if("audioSourceChanged"!==g)throw new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("audioSourceChanged"!==g)throw new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.off(g,m)}feature(g){return this._extensibleApi||(this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{streamInstance:this},{streamInstance:this,telemetryLogManager:this.telemetryLogManager})),this._extensibleApi.getApiObjectInstance(g.audioStreamApiCtor)}get mediaStreamType(){return this._mediaStreamType}get source(){return this._source}get telemetryLogManager(){return this._telemetryLogManager}get callStackWasmVqeProvider(){return this.source?.deviceManager?.callStackWasmVqeProvider??null}get callStackEffectsStatusManager(){return this.source?.deviceManager?.callStackAudioEffectsStatusManager??null}async getMediaStream(){const g=generateGuid(),m=+new Date,f={timestampInfo:{attemptTimestamp:m},correlationId:g,operation:Su.getMediaStream,kindOfEvent:Lh.attempt,mediaType:mu.AudioRaw,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(f),this.subscribeToRawStreamChangedIfNeeded(),this._mediaStreamSource){const f={correlationId:g,mediaType:mu.AudioRaw,operation:Su.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:fu.Local,kindOfEvent:Lh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(f),this._mediaStreamSource}if(this._source instanceof AudioDeviceInfoImpl)try{this._rawStream=this._source.deviceManager.getRawDeviceMediaStream(0);const f=await(this._rawStream?.getMediaStream()),S={correlationId:g,mediaType:mu.AudioRaw,operation:Su.getMediaStream,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:fu.Local,kindOfEvent:Lh.success};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),f}catch(S){const f=new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM,S),v={correlationId:g,operation:Su.getMediaStream,additionalDetails:{failureReason:f.message,code:f.code,...extractCommunicationServicesErrorForTelemetry(f)},timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Lh.failure,mediaType:mu.AudioRaw,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),f}const S=new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.GET_MEDIA_STREAM),v={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:Su.getMediaStream,additionalDetails:{failureReason:S.message,code:B,...extractCommunicationServicesErrorForTelemetry(S)},kindOfEvent:Lh.failure,mediaType:mu.AudioRaw,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(v),S}async setMediaStream(g){const m=generateGuid();let f=+new Date;const S={timestampInfo:{attemptTimestamp:f},correlationId:m,operation:Su.setMediaStream,kindOfEvent:Lh.attempt,mediaType:mu.AudioRaw,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),!(g instanceof MediaStream)){const g=new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.SET_MEDIA_STREAM_WRONG_TYPE),S={timestampInfo:{deltaTimeInMs:+new Date-f},correlationId:m,operation:Su.setMediaStream,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Lh.failure,mediaType:mu.AudioRaw,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),g}this.canStartEffects=!1,this._mediaStreamSource=new MediaStream(g.getAudioTracks()),this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose();const v={correlationId:m,mediaType:mu.AudioRaw,operation:Su.setMediaStream,timestampInfo:{deltaTimeInMs:+new Date-f},streamType:fu.Local,kindOfEvent:Lh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(v)}async switchSource(g){const m=+new Date,f=generateGuid();this.canStartEffects=!0;const S={timestampInfo:{attemptTimestamp:m},correlationId:f,operation:Su.switchSource,kindOfEvent:Lh.attempt,mediaType:mu.Audio,streamType:fu.Local};if(this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),g instanceof AudioDeviceInfoImpl&&"Microphone"!==g.deviceType){const g=new CallingCommunicationError(z.LOCAL_AUDIO_STREAM.SWITCH_SOURCE_WRONG_TYPE),S={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:f,operation:Su.switchSource,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)},kindOfEvent:Lh.failure,mediaType:mu.Audio,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),g}this._source!==g&&(this._source.deviceManager.selectMicrophone(g),this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose());const v={correlationId:f,mediaType:mu.Audio,operation:Su.switchSource,timestampInfo:{deltaTimeInMs:+new Date-m},streamType:fu.Local,kindOfEvent:Lh.success};this._localStreamTelemetryEventSender.sendMediaStreamEvent(v)}dispose(){this.logger.log("LocalAudioStream disposing"),this._disposed?this.logger.log("Already disposed"):(this._disposed=!0,this.disposeRawStream(),this._volumeIndicator.dispose(),this._eventEmitter.removeAllListeners(),this.logger.log("LocalAudioStream disposed"))}async getVolume(){return this._volumeIndicator.isInitialized?this._volumeIndicator:this._volumeIndicator.getVolumeIndicator(await this.getMediaStream())}subscribeToRawStreamChangedIfNeeded(){this._source instanceof AudioDeviceInfoImpl&&!this._audioSourceChangedSub&&(this._audioSourceChangedSub=this._rawStream?.changed((()=>{this._eventEmitter.emit("audioSourceChanged",{source:this}),this._volumeIndicator.dispose()})))}disposeRawStream(){this._audioSourceChangedSub?.dispose(),this._rawStream?.dispose(),this._audioSourceChangedSub=void 0}getStreamMetadata(){const g=this.source.deviceManager;return{source:"local",streamType:this.mediaStreamType,deviceType:this.source.deviceType,deviceManagerPermissionState:JSON.stringify({cameraPermission:g.getVideoDevicePermission(),microphonePermission:g.getAudioDevicePermission()}),acsResourceId:g.getAcsResourceId()||"",clientId:g.getClientId()}}}__decorate$6([loggerProperty,__metadata$6("design:type",Object)],LocalAudioStream.prototype,"logger",void 0),__decorate$6([syncOperation(ru.Feature),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[Object]),__metadata$6("design:returntype","function"==typeof(Pg="undefined"!=typeof TFeature&&TFeature)?Pg:Object)],LocalAudioStream.prototype,"feature",null),__decorate$6([asyncOperation(ru.GetMediaStream),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"getMediaStream",null),__decorate$6([asyncOperation(ru.SetMediaStream),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[MediaStream]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"setMediaStream",null),__decorate$6([asyncOperation(ru.SwitchSource),__metadata$6("design:type",Function),__metadata$6("design:paramtypes",[Object]),__metadata$6("design:returntype",Promise)],LocalAudioStream.prototype,"switchSource",null),function(g){g[g.JITTER=0]="JITTER",g[g.RTT=1]="RTT",g[g.PACKETS_LOSS=2]="PACKETS_LOSS",g[g.BIT_RATE=3]="BIT_RATE",g[g.BANDWIDTH=4]="BANDWIDTH"}(Rg||(Rg={})),function(g){g[g.AUDIO=0]="AUDIO",g[g.VIDEO=1]="VIDEO"}(wg||(wg={}));const Mg="Unknown";var Dg,Og;function collectMediaStatsForCreateView(g,m,f,S){const v=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength,C=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsInitialMaxLength,_=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","healedRatio","lossRate"],E=["bitrate","packetsPerSecond","packetsLostPerSecond","jitterInMs","rttInMs","pairRttInMs","frameRateDecoded","frameRateReceived","frameWidthReceived","frameHeightReceived","longestFreezeDurationInMs","totalFreezeDurationInMs","framesReceived","framesDropped","framesDecoded","keyFramesDecoded"],T=E;if(f.audio.receive.length>0){const S=f.audio.receive[0];g.audio=g.audio??{},m.audio=m.audio??{},_.forEach((f=>{const _=f;if(void 0!==S[_]&&g.audio){const m=S[_];if(void 0===g.audio[_])g.audio[_]=[m];else{const f=g.audio[_]?.length;f>=v&&g.audio[_]?.shift(),g.audio[_]?.push(m)}}if(void 0!==S[_]&&m.audio){const g=S[_];if(void 0===m.audio[_])m.audio[_]=[g];else{const f=m.audio[_]?.length;f<C&&m.audio[_]?.push(g)}}}))}if(f.video.receive.length>0){const _=f.video.receive.find((g=>g.streamId===S));void 0!==_&&(g.video=g.video??{},m.video=m.video??{},E.forEach((f=>{const S=f;if(void 0!==_[S]&&g.video){const m=_[S];if(void 0===g.video[S])g.video[S]=[m];else{const f=g.video[S]?.length;f>=v&&g.video[S]?.shift(),g.video[S]?.push(m)}}if(void 0!==_[S]&&m.video){const g=_[S];if(void 0===m.video[S])m.video[S]=[g];else{const f=m.video[S]?.length;f<C&&m.video[S]?.push(g)}}})))}if(f.screenShare.receive.length>0){const _=f.screenShare.receive.find((g=>g.streamId===S));void 0!==_&&(g.screenShare=g.screenShare??{},m.screenShare=m.screenShare??{},T.forEach((f=>{const S=f;if(void 0!==_[S]&&g.screenShare){const m=_[S];if(void 0===g.screenShare[S])g.screenShare[S]=[m];else{const f=g.screenShare[S]?.length;f>=v&&g.screenShare[S]?.shift(),g.screenShare[S]?.push(m)}}if(void 0!==_[S]&&m.screenShare){const g=_[S];if(void 0===m.screenShare[S])m.screenShare[S]=[g];else{const f=m.screenShare[S]?.length;f<C&&m.screenShare[S]?.push(g)}}})))}}function calculateFirstAverage(g){if(g?.count.length&&g?.count[0]){return getRoundedAverage(g.sum[0],g.count[0])}return NaN}function calculateFirstSum(g){return g?.count.length&&g?.count[0]?g.sum[0]:NaN}!function(g){g.Supported="Supported",g.NotSupported="NotSupported",g.Unknown="Unknown"}(Dg||(Dg={})),function(g){g.CompleteTest="CompleteTest",g.StartTest="StartTest",g.DeviceAccess="DeviceAccess",g.DeviceEnumerations="DeviceEnumerations",g.InCallDiagnostics="InCallDiagnostics",g.BrowserSupport="BrowserSupport"}(Og||(Og={}));class PreCallDiagnosticsFeatureImpl extends FirstPartyCallClientFeature{constructor(g){super(g),this._impl=new PreCallDiagnosticsImpl}initialize(g,m){const f=g.callClient;this._logger=m;const S={diagnostics:{tags:["diagnostics"]}},v=f.createInstance(S);this._telemetryLogManager=v.telemetryLogManager,this._impl.intialize(f,v,m,this._telemetryLogManager),this._sendFeatureUsage("initialize",Lh.initialize)}get name(){return this._sendFeatureUsage("name",Lh.getter),"PreCallDiagnostics"}startTest(g,m){return this._impl.startTest(g,m)}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._sendFeatureUsage("dispose",Lh.attempt),this.disposed?this._sendFeatureUsage("dispose",Lh.failure):(this._impl.dispose(),super.dispose(),this._sendFeatureUsage("dispose",Lh.success))}}class PreCallDiagnosticsImpl{constructor(){this._printableObjectAll=!0,this._completeTestInfo={name:"",succeeded:!0},this._diagnosticsTestRunIds=[],this._callMediaStatistics=defer(),this._inCallDiagnostics={connected:!1,diagnostics:{audio:{jitter:Mg,packetLoss:Mg,rtt:Mg},video:{jitter:Mg,packetLoss:Mg,rtt:Mg}},bandWidth:Mg},this._diagnosticsMediaTelemetry={jitter:{audio:{inbound:0,outbound:0},video:{inbound:0,outbound:0}},rtt:{audio:0,video:0},packets:{audioSent:0,audioSentLost:0,audioReceived:0,audioReceivedLost:0,videoSent:0,videoSentLost:0,videoReceived:0,videoReceivedLost:0},bandWidth:0},this._isCreatingNewCallAgent=!1}intialize(g,m,f,S){this._internalCallClient=m,this._mainCallClient=g,this._logger=f,this._telemetryLogManager=S}async getDevices(g,m){let f=[];try{switch(m){case"Speaker":f=await g.getSpeakers();break;case"Microphone":f=await g.getMicrophones();break;default:f=await g.getCameras()}}catch(g){this._logger.warn("Failed to get speakers")}return f}async startTest(g,m){this._sendFeatureUsage("startTest",Lh.attempt),this._currentTestRunId=generateGuid(),this._diagnosticsTestRunIds.push(this._currentTestRunId),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.CompleteTest}}),this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.StartTest}});try{this._internalDeviceManager=await this._internalCallClient.getDeviceManager();const g=this._internalCallClient.callAgent,m=await this._mainCallClient.getDeviceManager();g?.tsStack?.getDeviceManager().selectDevices({speaker:m.selectedSpeaker?.id,microphone:m.selectedMicrophone?.id});const f=await this._internalCallClient.getDeviceManager(),S={mic:(await this.getDevices(f,"Microphone")).length,speaker:(await this.getDevices(f,"Speaker")).length};this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.StartTest,!0,`Device selection successful. Result: ${getPrintableObject(S,this._printableObjectAll)}`)})}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.SET_DEVICE_FAIL,g);throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.StartTest,!1,"Device selection failed."),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.warn(g),this._sendFeatureUsage("startTest",Lh.failure),m}try{return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.StartTest,!0,"StartTest succeeded")}),this._sendFeatureUsage("startTest",Lh.success),m?{deviceAccess:m.deviceAccess?this.deviceAccess():void 0,deviceEnumeration:m.deviceEnumeration?this.deviceEnumeration():void 0,inCallDiagnostics:m.inCallDiagnostics?this.getInCallDiagnostics(g):void 0,browserSupport:m.browserSupport?this.getBrowserSupport():void 0,callMediaStatistics:m.callMediaStatistics?this.getcallMediaStatistics():void 0,id:this._currentTestRunId}:{deviceAccess:this.deviceAccess(),deviceEnumeration:this.deviceEnumeration(),inCallDiagnostics:this.getInCallDiagnostics(g),browserSupport:this.getBrowserSupport(),callMediaStatistics:this.getcallMediaStatistics(),id:this._currentTestRunId}}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.GET_DIAGNOSTICS_INFO,g);throw this._logger.error(m.message),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.StartTest,!1,"StartTest failed."),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._sendFeatureUsage("startTest",Lh.failure),m}}async getBrowserSupport(){let g;this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.BrowserSupport}});try{const m=await this._mainCallClient.getEnvironmentInfoInternal();g={browser:m.isSupportedBrowser?Dg.Supported:Dg.NotSupported,os:m.isSupportedPlatform?Dg.Supported:Dg.NotSupported},this.updateTestInfo(Og.BrowserSupport,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Browser support successful. Result: ${getPrintableObject(g,this._printableObjectAll)}`,name:Og.BrowserSupport}})}catch(m){g={browser:Dg.Unknown,os:Dg.Unknown},this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.BrowserSupport,!1,`Browser support failed. Error: ${getPrintableObject(m)}`)}),this._logger.error(`Browser support failed: ${m}`)}return new Promise((m=>m(g)))}async renderHiddenVideoElement(g,m){let f,S=g.tsCall,v=S.mediaStreams;try{await new Promise(((g,m)=>{f=S.changed((()=>{void 0!==v[0]&&v[0].length>0&&v[0][0].isAvailable&&(g(),f?.dispose(),this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call mediaStreams successful.",name:Og.InCallDiagnostics}}))})),setTimeout((()=>{this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,"Call mediaStreams failed. Error: Timeout")}),m(new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_STREAM_TIMEOUT))}),1e3*this._diagnosticsEcsConfig.CALL.MEDIASTREAM_TIMEOUT_IN_SEC)}));let C=S.mediaStreams[0][0],_=document.getElementById("_hiddenSelfRemoteStream");_&&_.remove(),_=document.createElement("div"),_.id="_hiddenSelfRemoteStream",_.style.position="relative",_.style.height="0px",_.style.width="0px";const E=document.createElement("div");E.style.position="absolute",E.style.height=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.heigth+"px",E.style.width=this._diagnosticsEcsConfig.CALL.VIDEO_SIZE.width+"px",E.style.bottom="0px",E.style.left="-2000px",_.appendChild(E),document.getElementsByTagName("body")[0].appendChild(_),this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Video element rendering successful. CallId: ${g.id}, localParticipantId: ${m}`,name:Og.InCallDiagnostics}}),await C.start(E)}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,`Call mediaStreams failed. Error: ${getPrintableObject(g)}`)}),this._logger.warn("Failed to render hidden video element")}}sineWaveAudioStream(){const g=new window.AudioContext,m=g.createMediaStreamDestination(),f=g.createOscillator();f.type="sine",f.frequency.value=500,f.connect(m),f.start();const{stream:S}=m;return new LocalAudioStream(S)}async receiveAndPlayCallAudio(g,m){try{const f=new window.AudioContext,S=new MediaStream;f.createMediaStreamSource(S).connect(f.destination),this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call mediaStreams audio track succeeded. CallId: ${g.id}, localParticipantId: ${m}`,name:Og.InCallDiagnostics}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,`Call mediaStreams audio track failed. Error: ${getPrintableObject(g)}`)}),this._logger.warn("Failed to send audio to call.")}}async getcallMediaStatistics(){return this._callMediaStatistics.promise}setEcsConfig(){this._diagnosticsEcsConfig=getAcsEcsConfig()?.calling?.callDiagnostics}async getInCallDiagnostics(g){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.InCallDiagnostics}}),this.setEcsConfig();const m={groupId:this._diagnosticsEcsConfig.CALL.GROUP_ID},f=await this.getDevices(this._internalDeviceManager,"Camera");let S,v="";0!==f.length&&(S=[new LocalVideoStream(f[0])]);const C={videoOptions:{localVideoStreams:S},audioOptions:{muted:!1,localAudioStreams:[this.sineWaveAudioStream()]}};let _;try{_=await(this._mainCallClient.callAgent?.getExistingCallAgentWithToken(g)),_?this._internalCallClient.setCallAgent(_):(this._isCreatingNewCallAgent=!0,await this._internalCallClient.createCallAgent(g)),this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Create CallAgent successful.",name:Og.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.GET_CALL_AGENT,g);throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}const E=this._internalCallClient.callAgent?.join(m,C);if(E){try{await this.waitCallConnected(E),v=E.tsCall.participantId,this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:"Call connected successfully",name:Og.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.CONNECT_FAIL,g);throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}try{this.updateTestInfo(Og.InCallDiagnostics,!0),await this.renderHiddenVideoElement(E,v)}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.RENDER_VIDEO,g);throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),m}this.receiveAndPlayCallAudio(E,v);const g=E.feature(callFeatureFactory(MediaStatsCallFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}));this._callMediaStatistics.resolve(g);g.createCollector({aggregationInterval:this._diagnosticsEcsConfig.CALL.AGGREGATION.INTERVAL,dataPointsPerAggregation:this._diagnosticsEcsConfig.CALL.AGGREGATION.DATAPOINTS}).on("summaryReported",(g=>this.gatherCallStatistics(g)));try{await sleep(1e3*this._diagnosticsEcsConfig.CALL.DURATION_IN_SEC),await E.hangUp({forEveryone:!0}),this.updateTestInfo(Og.InCallDiagnostics,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Call hangup successful. Result: ${getPrintableObject(this._inCallDiagnostics,this._printableObjectAll)}`,name:Og.InCallDiagnostics}})}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.HANGUP_FAIL,g);throw this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.InCallDiagnostics,!1,m.message),additionalDetails:{...extractCommunicationServicesErrorForTelemetry(m)}}),this._logger.error(m.message),m}this.dispose()}return this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:this._completeTestInfo.succeeded,result:this._completeTestInfo.result||"InCallDiagnostics succeeded.",name:Og.CompleteTest}}),this._inCallDiagnostics}async waitCallConnected(g){await new Promise((async(m,f)=>{g.on("stateChanged",(()=>{"Connected"==g.state&&(this._inCallDiagnostics.connected=!0,m()),"Disconnected"==g.state&&f("Call disconnected")}));const S=this._diagnosticsEcsConfig.CALL.CONNECT_TIMEOUT_IN_SEC;await sleep(1e3*S),f(new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.CALL_CONNECT_TIMEOUT(S)))}))}qualityGrade(g,m,f){return g<=m?"Good":g>=f?"Bad":"Average"}bandwidthQualityGrade(g,m,f){return g>=m?"Good":g<=f?"Bad":"Average"}getQualityGradeForMetric(g,m,f){switch(g){case Rg.JITTER:return f===wg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.JITTER.GOOD,this._diagnosticsEcsConfig.AUDIO.JITTER.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.JITTER.GOOD,this._diagnosticsEcsConfig.VIDEO.JITTER.AVERAGE);case Rg.RTT:return f===wg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.RTT.GOOD,this._diagnosticsEcsConfig.AUDIO.RTT.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.RTT.GOOD,this._diagnosticsEcsConfig.VIDEO.RTT.AVERAGE);case Rg.PACKETS_LOSS:return f===wg.AUDIO?this.qualityGrade(m,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.AUDIO.PACKETS_LOSS_PERCENTAGE.AVERAGE):this.qualityGrade(m,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.GOOD,this._diagnosticsEcsConfig.VIDEO.PACKETS_LOSS_PERCENTAGE.AVERAGE);case Rg.BANDWIDTH:return this.bandwidthQualityGrade(m,this._diagnosticsEcsConfig.BANDWIDTH.GOOD,this._diagnosticsEcsConfig.BANDWIDTH.AVERAGE);default:return Mg}}gatherCallStatistics(g){try{const m=g.audio.receive.length?g.audio.receive[0]:void 0,f=g.audio.send.length?g.audio.send[0]:void 0,S=g.video.receive.length?g.video.receive[0]:void 0,v=g.video.send.length?g.video.send[0]:void 0,C=g.transports.length?g.transports[0]:void 0;this._diagnosticsMediaTelemetry.jitter.audio.inbound=calculateFirstAverage(m?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.audio.outbound=calculateFirstAverage(f?.jitterInMs?.aggregation);const _=Math.max(this._diagnosticsMediaTelemetry.jitter.audio?.inbound,this._diagnosticsMediaTelemetry.jitter.audio?.outbound);this._inCallDiagnostics.diagnostics.audio.jitter=this.getQualityGradeForMetric(Rg.JITTER,_,wg.AUDIO),this._diagnosticsMediaTelemetry.rtt.audio=calculateFirstAverage(f?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.audio.rtt=this.getQualityGradeForMetric(Rg.JITTER,this._diagnosticsMediaTelemetry.rtt.audio,wg.AUDIO),this._diagnosticsMediaTelemetry.packets.audioSent=calculateFirstSum(f?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioSentLost=calculateFirstSum(f?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceived=calculateFirstSum(m?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.audioReceivedLost=calculateFirstSum(m?.packetsLostPerSecond?.aggregation);const E=this._diagnosticsMediaTelemetry.packets.audioSent-this._diagnosticsMediaTelemetry.packets.audioSentLost,T=this._diagnosticsMediaTelemetry.packets.audioReceived-this._diagnosticsMediaTelemetry.packets.audioReceivedLost,I=Math.max(E,T)/this._diagnosticsMediaTelemetry.packets.audioSent*100;this._inCallDiagnostics.diagnostics.audio.packetLoss=this.getQualityGradeForMetric(Rg.PACKETS_LOSS,I,wg.AUDIO),this._diagnosticsMediaTelemetry.jitter.video.inbound=calculateFirstAverage(S?.jitterInMs?.aggregation),this._diagnosticsMediaTelemetry.jitter.video.outbound=calculateFirstAverage(v?.jitterInMs?.aggregation);const b=Math.max(this._diagnosticsMediaTelemetry.jitter.video.inbound,this._diagnosticsMediaTelemetry.jitter.video.outbound);this._inCallDiagnostics.diagnostics.video.jitter=this.getQualityGradeForMetric(Rg.JITTER,b,wg.VIDEO),this._diagnosticsMediaTelemetry.rtt.video=calculateFirstAverage(v?.rttInMs?.aggregation),this._inCallDiagnostics.diagnostics.video.rtt=this.getQualityGradeForMetric(Rg.RTT,this._diagnosticsMediaTelemetry.rtt.video,wg.VIDEO),this._diagnosticsMediaTelemetry.packets.videoSent=calculateFirstSum(v?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoSentLost=calculateFirstSum(v?.packetsLostPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceived=calculateFirstSum(S?.packetsPerSecond?.aggregation),this._diagnosticsMediaTelemetry.packets.videoReceivedLost=calculateFirstSum(S?.packetsLostPerSecond?.aggregation);const A=this._diagnosticsMediaTelemetry.packets.videoSent-this._diagnosticsMediaTelemetry.packets.videoSentLost,P=this._diagnosticsMediaTelemetry.packets.videoReceived-this._diagnosticsMediaTelemetry.packets.videoReceivedLost,R=Math.max(A,P)/this._diagnosticsMediaTelemetry.packets.videoSent*100;this._inCallDiagnostics.diagnostics.video.packetLoss=this.getQualityGradeForMetric(Rg.PACKETS_LOSS,R,wg.VIDEO),this._diagnosticsMediaTelemetry.bandWidth=calculateFirstAverage(C?.availableOutgoingBitrate?.aggregation),this._inCallDiagnostics.bandWidth=this.getQualityGradeForMetric(Rg.BANDWIDTH,this._diagnosticsMediaTelemetry.bandWidth,wg.AUDIO)}catch(g){const m=new CallingCommunicationError(z.FEATURES.PRECALL_DIAGNOSTICS.VIDEO_MEDIASTATS,g);this._logger.error("Failed to get audio call media stats:",m.message),this._callMediaStatistics.reject(m)}}async deviceAccess(){this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.DeviceAccess}});const g=this._internalDeviceManager.askDevicePermission({audio:!0,video:!0});try{const m=await g;this.updateTestInfo(Og.DeviceAccess,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Access successful. Result: ${getPrintableObject(m,this._printableObjectAll)}`,name:Og.DeviceAccess}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.DeviceAccess,!1,"Device Access failed.")})}return g}async deviceEnumeration(){const g={microphone:Mg,camera:Mg,speaker:Mg};this.telemetryLogAttemptEvents({diagnosticsTestRunId:this._currentTestRunId,testAttemptDetails:{name:Og.DeviceEnumerations}});try{const m=0!==(await this.getDevices(this._internalDeviceManager,"Microphone")).length,f=0!==(await this.getDevices(this._internalDeviceManager,"Camera")).length,S=0!==(await this.getDevices(this._internalDeviceManager,"Speaker")).length;g.microphone=m?"Available":"NotAvailable",g.camera=f?"Available":"NotAvailable",g.speaker=S?"Available":"NotAvailable",this.updateTestInfo(Og.DeviceEnumerations,!0),this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:{succeeded:!0,result:`Device Enumeration successful. Result: ${getPrintableObject(g,this._printableObjectAll)}`,name:Og.DeviceEnumerations}})}catch(g){this.telemetryLogResultEvents({diagnosticsTestRunId:this._currentTestRunId,testResultDetails:this.updateTestInfo(Og.DeviceEnumerations,!1,"Device Enumeration failed.")}),this._logger.error(`Couldn't find mic, camera, or speaker: ${g}`)}return g}telemetryLogAttemptEvents(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_diagnostics_attempt,tenant:so,properties:{name:g.testAttemptDetails.name,diagnosticsTestRunId:g.diagnosticsTestRunId}})}telemetryLogResultEvents(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_diagnostics_result,tenant:so,properties:{name:g.testResultDetails.name,diagnosticsTestRunId:g.diagnosticsTestRunId,succeeded:g.testResultDetails.succeeded,result:g.testResultDetails.result,additionalDetails:g.additionalDetails||{}}})}updateTestInfo(g,m,f){return this._completeTestInfo.succeeded&&(this._completeTestInfo={succeeded:m,name:g,result:f}),{succeeded:m,name:g,result:f||""}}_sendFeatureUsage(g,m){sendCallClientFeatureUsageTelemetry({featureName:"PreCallDiagnostics",featureType:"CallClient",initializationType:"OnExtendedObjectConstructor",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this._isCreatingNewCallAgent&&this._internalCallClient.callAgent?.dispose()}}class Debounce{constructor(g,m){this._debounce=void 0,this._updateFunction=g,this._timeout=m}debounce(){this._debounce?(clearTimeout(this._debounce),this._debounce=setTimeout((()=>{this._updateFunction(),this._debounce=void 0}),this._timeout)):(this._updateFunction(),this._debounce=setTimeout((()=>{this._debounce=void 0}),this._timeout))}flush(){this._debounce&&(clearTimeout(this._debounce),this._debounce=void 0,this._updateFunction())}}class RemoteVideoStreamCommonImpl{constructor(g,m,f,S,v,C){this._isReceiving=!1,this._mediaStreamType="Video",this._renderers=[],this._disposed=!1,this._size={height:0,width:0},this._setType=g=>{0===g.type?this._mediaStreamType="Video":1===g.type?this._mediaStreamType="ScreenSharing":2===g.type&&(this._mediaStreamType="LiveStream")},this._disposeRenderer=g=>{this.logger.log("disposing renderer");try{g.dispose(Cu.Internal_RemoteVideoStreamDisposed),this.logger.log("renderer disposed")}catch(g){this.logger.log("failed to dispose renderer")}},this.tsStream=g,this._setType(this.tsStream),this.logger=m.createChild((()=>`Stream:{id=${this.tsStream.id}}:{type=${this._mediaStreamType}}`)),this.telemetryLogManager=v,this.kind=C,this._eventEmitter=new CallingEventEmitter(this.logger),this.call=f,this._tsParticipantId=S,this.sendRemoteVideoStreamTelemetry(),this._debounceSize=this.createDebounceSize(),this._debounceIsReceiving=new Debounce((()=>{const g=this._renderers?.filter((g=>!!g?.isRendering)).length>0;this._isReceiving!==g&&(this._isReceiving=g,this.logger.info(`isReceiving changed to ${this._isReceiving}`),this._eventEmitter.emit("isReceivingChanged"),this.sendRemoteVideoStreamTelemetry())}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout),this._registeredViewIdsMaxLength=getAcsEcsConfig().rendering.remoteVideo.registeredViewIdsMaxLength,this.logger.info("created")}on(g,m){if("sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}get id(){return this.tsStream.id}get isReceiving(){return this._isReceiving}get tsParticipantId(){return this._tsParticipantId}get remoteParticipantId(){return this.tsStream.participantId??""}get mediaStreamType(){return this._mediaStreamType}get size(){return{height:this._size.height,width:this._size.width}}updateSize(){this._debounceSize.debounce()}updateIsReceiving(){this._debounceIsReceiving.debounce()}flushIsReceiving(){this._debounceIsReceiving.flush()}registerRenderer(g){this._renderers.push(g),this.logger.info(`Renderer registered, view id: ${g.viewId}`)}unregisterRenderer(g){const m=this._renderers.indexOf(g);-1!==m&&(this._renderers.splice(m,1),this.logger.info(`Renderer un-registered, view id: ${g.viewId}`))}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._disposed=!0,this._streamChangedHandler&&this._streamChangedHandler.dispose(),this._renderers.forEach((g=>this._disposeRenderer(g))),this._renderers=[],this._eventEmitter.removeAllListeners())}getRegisteredViewIds(){let g=this._renderers.map((g=>g.viewId));return this._registeredViewIdsMaxLength&&(g=g.slice(0,this._registeredViewIdsMaxLength)),g.join(", ")}sendRemoteVideoStreamTelemetry(){this.call.stats.recordEvent({name:Nh.remote_stream,callId:this.call.id,localParticipantId:this.call.tsCall.participantId,data:{...this.getStreamMetadata()}})}createDebounceSize(){return new Debounce((()=>{let g={height:0,width:0};this._renderers?.forEach((m=>{m?.isRendering&&m.size.height>g.height&&m.size.width>g.width&&(g.height=m.size.height,g.width=m.size.width)}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout),this._size.height===g.height&&this._size.width===g.width||(this._size.height=g.height,this._size.width=g.width,this.logger.info(`stream size changed to { height: ${this._size.height}, width: ${this._size.width} }`),this._eventEmitter.emit("sizeChanged"),this.sendRemoteVideoStreamTelemetry())}),getAcsEcsConfig().rendering.remoteVideo.debounceTimeout)}}class LiveStreamStatsCalculator{constructor(g){this._statsInfo=g,this._originalValues={},this._aggregateValues={}}isDiffMethod(g){return"diff"==g||"last2"==g||"rate"===g}addStats(g,m){const f=this._statsInfo[g];let S=this._originalValues[g];if(void 0===S&&(S={raw:[],calc:[],lastTime:Date.now(),beginTime:Date.now()},this._originalValues[g]=S),this.isDiffMethod(f.calculation_method)){S.raw.push(m);const g=Date.now(),v=S.lastTime;if(S.lastTime=g,S.raw.length>1){m=S.raw[S.raw.length-1]-S.raw[S.raw.length-2],"rate"===f.calculation_method&&(m=m/(g-v)*1e3),void 0!==f.multiplier&&(m*=f.multiplier),!0===f.integer&&(m|=0),S.calc.push(m)}else"rate"===f.calculation_method&&(m=0)}else void 0!==f.multiplier&&"number"==typeof m&&(m*=f.multiplier),!0===f.integer&&(m|=0),S.raw.push(m);return m}aggregate(){const g={};for(const[m,f]of Object.entries(this._originalValues)){const S=this._statsInfo[m];if(void 0===S||!1===S.show)continue;this.isDiffMethod(S.calculation_method)&&f.raw.length>0&&(g[m]={raw:[f.raw[f.raw.length-1]],calc:[],lastTime:f.lastTime,beginTime:0});let v=this._aggregateValues[m];void 0===v&&(v={raw:[],timestamp:new Date(f.beginTime)},S.aggregation_needed&&(v.aggregation={count:[],sum:[],max:[],min:[]}),this._aggregateValues[m]=v);const C=f.calc?.length?f.calc:f.raw;let _=C;if(S.aggregation_needed&&v.aggregation){const g=C.filter((g=>"number"==typeof g&&!isNaN(g)));v.aggregation.count.push(g.length),v.aggregation.sum.push(getSum(g)),v.aggregation.max.push(getMax(g)),v.aggregation.min.push(getMin(g)),_=g}S.raw_data_reduction&&_.length>0&&(v.reduced=v.reduced||[],v.reduced.push(_[_.length-1])),_.forEach((g=>v.raw.push(g)))}this._originalValues=g}popAggregates(){const g={};for(const[m,f]of Object.entries(this._aggregateValues)){g[this._statsInfo[m].name??m]=f}return this._aggregateValues={},g}}class LiveStreamStatsCollectorImpl{constructor(g,m,f){if(this._tsCall=g,this._aggregationInterval=0,this._dataPointsPerAggregation=0,this._disposed=!1,this._calculators=new Map,f.aggregationInterval<1)throw new CallingCommunicationError(z.FEATURES.LIVE_STREAM.INVALID_AGGREGATION_INTERVAL_RANGE);if(f.dataPointsPerAggregation<1)throw new CallingCommunicationError(z.FEATURES.LIVE_STREAM.INVALID_DATAPOINTS_AGGREGATION_RANGE);this._logger=m.createChild("LiveStreamStatsCollector"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._callStateChanged=defer$1(),this._statsPoller=f.statsPoller,this._statsInfo=f.statsInfo,this._aggregationInterval=f.aggregationInterval,this._dataPointsPerAggregation=f.dataPointsPerAggregation,this._isInternal=f.isInternal,this._dataEventListener=g=>{void 0!==g&&this._processData(g)},this._statsPoller.on("data",this._dataEventListener);const S=[3,10];let v=S.includes(this._tsCall.state);this._callStateChangedHandle=this._tsCall.on("callStateChanged",(()=>{v!==S.includes(this._tsCall.state)&&(v=!v,this._callStateChanged.resolve(v))})),this._run()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._disposed||(this._disposed=!0,this._callStateChangedHandle.dispose(),this._callStateChanged.resolve(!1),this._statsPoller.off("data",this._dataEventListener),this._eventEmitter.emit("dispose"),this._eventEmitter.removeAllListeners())}_processData(g){const m={},f=Object.keys(g);0!==f.length&&(f.forEach((f=>{const S=g[f],v={};let C=this._calculators.get(f);C||(C=new LiveStreamStatsCalculator(this._statsInfo),this._calculators.set(f,C));for(const[g,m]of Object.entries(S)){const f=this._statsInfo[g];if(f&&!1!==f.show&&(this._isInternal||!f.is_internal)){const S=C.addStats(g,m);v[f.name??g]=S}}m[f]=v})),Object.keys(m).length>0&&this._eventEmitter.emit("sampleReported",m))}async _run(){let g=0;const filterReducedRaw=g=>(Object.keys(g).forEach((m=>{g[m].reduced&&!this._isInternal&&delete g[m].reduced})),g),flushData=()=>{if(0===this._calculators.size||0===g)return;const m=[],f={};this._calculators.forEach(((g,S)=>{const v=filterReducedRaw(g.popAggregates());0===Object.keys(v).length?m.push(S):(v.reduced&&!this._isInternal&&delete v.reduced,f[S]=v)}));try{this._eventEmitter.emit("summaryReported",f)}catch(g){this._logger.error(`summary event: ${g}`)}m.forEach((g=>{this._calculators.delete(g)})),g=0},m=[3,10];let f=1e3*this._aggregationInterval;for(;!this._disposed;){if(m.includes(this._tsCall.state)){f>0&&await wait((()=>this._callStateChanged.promise),f).catch((g=>{}));const m=Date.now();this._calculators.size>0&&(this._calculators.forEach((g=>{g.aggregate()})),g++,g===this._dataPointsPerAggregation&&flushData());const S=Date.now();f=m+1e3*this._aggregationInterval-S}else flushData(),this._calculators.clear(),await this._callStateChanged.promise.catch((g=>{})),f=1e3*this._aggregationInterval;this._callStateChanged.isPending()||(this._callStateChanged=defer$1())}flushData()}}class LiveStreamStatsPoller extends StatsPoller{constructor(g,m,f,S){super(g,m.createChild("LiveStreamStatsPoller"),f.fetchInterval,f.pollingMethod),this._liveStreams=S}async getStats(){const g={};return this._liveStreams.forEach(((m,f)=>{try{const f=m.tsStream.getStats();if(f){const m=f.id.toString(),S={id:m};"number"==typeof f.player_downloadBitrate&&(S.videoBitrate=f.player_downloadBitrate),"number"==typeof f.player_audioDownloadBitrate&&(S.audioBitrate=f.player_audioDownloadBitrate),"number"==typeof f.player_totalDownloadedBytes&&(S.downloadBitrate=f.player_totalDownloadedBytes,S.totalDownloadBytes=f.player_totalDownloadedBytes),"number"==typeof f.player_videoBufferLength&&(S.bufferLengthInMs=Math.round(1e3*f.player_videoBufferLength)),void 0!==f.player_mediaHeight&&(S.videoHeight=f.player_mediaHeight),void 0!==f.player_mediaWidth&&(S.videoWidth=f.player_mediaWidth),void 0!==f.player_playerHeight&&(S.playerHeight=f.player_playerHeight),void 0!==f.player_playerWidth&&(S.playerWidth=f.player_playerWidth),"number"==typeof f.player_mediaDelay&&(S.mediaDelayInMs=Math.round(1e3*f.player_mediaDelay)),"number"==typeof f.player_currentPlayPosition&&(S.currentPlayPosition=Math.round(1e3*f.player_currentPlayPosition)/1e3),g[m]=S}}catch(g){this._logger.error(`fetch live stream stats failed: ${g}`)}})),Object.keys(g).length>0?g:void 0}}class LiveStreamStatsTelemetryLogger{constructor(g,m,f){this._tsCall=g,this._telemetryLogManager=m,this._config=f}log(g){Object.entries(g).forEach((([g,m])=>{const f={id:g},S={id:g};if(Object.entries(m).forEach((([g,m])=>{const v=g,C={};if(this._config.dataToSend.raw){const g={};m?.timestamp&&(g.timestamp=m.timestamp),m?.raw&&(g.raw=m?.raw),void 0===g.raw&&delete S[v],S[v]=g}void 0!==m?.aggregation?(m?.timestamp&&(C.timestamp=m?.timestamp),this._config.dataToSend.min&&(C.min=m?.aggregation.min),this._config.dataToSend.max&&(C.max=m?.aggregation.max),this._config.dataToSend.sum&&(C.sum=m?.aggregation.sum),this._config.dataToSend.count&&(C.count=m?.aggregation.count),m?.aggregation.sum&&m?.aggregation.count&&(C.average=getSum(m?.aggregation.sum)/getSum(m?.aggregation.count))):(m?.timestamp&&(C.timestamp=m.timestamp),m?.reduced?C.raw=m?.reduced:void 0!==m?.raw&&(C.raw=m?.raw)),f[v]=C})),Object.keys(f).length>1){const g={stats:f,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamStatsEvent(g)}if(this._config.dataToSend.raw&&Object.keys(S).length>1){const g={stats:S,callId:this._tsCall.callId||"",localParticipantId:this._tsCall.participantId||""};this._sendLiveStreamRawStatsEvent(g)}}))}_sendLiveStreamStatsEvent(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_livestream_stats,tenant:so,properties:g})}_sendLiveStreamRawStatsEvent(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_livestream_raw_stats,tenant:so,properties:g})}}class LiveStreamStatsManager{constructor(g,m,f,S){this._tsCall=g,this._logger=m,this._collectors=[],this._disposed=!1,this._externalStatsInfo={};const v=getAcsEcsConfig().telemetry.liveStreamStatsConfig;this._config=v,this._statsPoller=new LiveStreamStatsPoller(this._tsCall,this._logger,v,S);const C={...Zo,...v.additionalStats};if(Object.entries(C).filter((([,g])=>!g.is_internal)).forEach((([g,m])=>{this._externalStatsInfo[g]=m})),v.enabled){const g=new LiveStreamStatsCollectorImpl(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:v.aggregationInterval,dataPointsPerAggregation:v.dataPointsPerAggregation,statsInfo:C,isInternal:!0}),m=new LiveStreamStatsTelemetryLogger(this._tsCall,f,v);g.on("summaryReported",(g=>{m.log(g)})),this._collectors.push(g)}}createStatsCollector(g){if(this._disposed)throw new CallingCommunicationError(z.FEATURES.LIVE_STREAM.DISPOSED);const m=this._config,f=new LiveStreamStatsCollectorImpl(this._tsCall,this._logger,{statsPoller:this._statsPoller,aggregationInterval:g?.aggregationInterval??m.aggregationInterval,dataPointsPerAggregation:g?.dataPointsPerAggregation??m.dataPointsPerAggregation,statsInfo:this._externalStatsInfo,isInternal:!1});return f.on("dispose",(()=>{this._collectors=this._collectors.filter((g=>g!==f))})),this._collectors.push(f),f}dispose(){this._disposed||(this._disposed=!0,this._collectors.forEach((g=>{g.dispose()})))}}class BotStreamCommonCallFeature{constructor(g,m){this._featureName=g,this._targetBotIds=m,this._streamIdToStreamMap=new Map}initialize(g,m,f,S,v){this._logger=v.createChild((()=>`${this._featureName}::Call(id='${g.callId}')`)),this._telemetryLogManager=S,this._call=f,this._tsCall=g,this.observeBotParticipantsAlreadyInCall(),this._tsCall.on("participantAdded",(async g=>{this.observeBotParticipantJustJoinedCall(g)})),this._tsCall.on("participantRemoved",(async g=>{this.removeStreamOfTheBotJustRemovedFromCall(g)}))}disposeAllBotStreams(){this._streamIdToStreamMap.forEach((g=>g.dispose())),this._streamIdToStreamMap.clear()}observeBotParticipantsAlreadyInCall(){this._tsCall.participants.forEach((g=>{this.isExpectedBotParticipant(g)&&(this._logger.info(`${this._featureName} Bot already in the call`),this.observeBotParticipant(g))}))}observeBotParticipantJustJoinedCall(g){this.isExpectedBotParticipant(g)&&(this._logger.info(`${this._featureName} Bot added`),this.observeBotParticipant(g))}removeStreamOfTheBotJustRemovedFromCall(g){if(this.isExpectedBotParticipant(g)){this._logger.info(`${this._featureName} Bot removed`);const m=[];this.removeAllStreams(g,m),this.checkVideoStreamAddedOrRemoved([],m)}}observeBotParticipant(g){g.changed((()=>{this._logger.info(`${this._featureName} Bot - changed event triggered. state: ${g.state}`),this._mapStreams(g)})),this._logger.info(`Composition Bot state: ${g.state}`),this._mapStreams(g)}_mapStreams(g){const m=[],f=[],mapStreamsOfType=S=>{if(g)if(isNonEmptyArray(g.streams&&g.streams[S])){let v=g.streams[S];this._logger.log(`Stream Type: ${S}`),v.forEach((f=>{if(void 0===f.id&&(f.id=-1),!this._streamIdToStreamMap.get(f.id)){const S=this.createConcreteVideoStream(f,g.id);this._logger.log(`${this._featureName} stream created, type==${S.mediaStreamType} id=${f.id}`),m.push(S)}})),this._streamIdToStreamMap.forEach((m=>{m.tsParticipantId!==g.id||v.some((g=>g.id===m.id))||f.push(m)}))}else this.removeAllStreams(g,f)};this.getStreamTypes().forEach((g=>mapStreamsOfType(g))),this.checkVideoStreamAddedOrRemoved(m,f)}removeAllStreams(g,m){this._streamIdToStreamMap.forEach((f=>{f.tsParticipantId===g.id&&m.push(f)}))}checkVideoStreamAddedOrRemoved(g,m){if(g.length>0||m.length>0){const handleNewStream=g=>{this._streamIdToStreamMap.set(g.id,g)},handleRemovedStream=g=>{const m=this._streamIdToStreamMap.get(g.id);m&&(this._logger.log(`stream removed, type==${m.mediaStreamType} id=${g.id}`),this._streamIdToStreamMap.delete(g.id),m.dispose())};g.forEach(handleNewStream),m.forEach(handleRemovedStream),this.emitVideoStreamsUpdatedEvent({added:g,removed:m})}}isExpectedBotParticipant(g){return this._targetBotIds.includes(g.id)}}class LiveStreamCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new LiveStreamCallFeatureImplOverTsCall(this.eventEmitter,this.name)}get name(){return"LiveStream"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}dispose(){this._impl.dispose(),super.dispose()}get liveStreams(){return this._impl.liveStreams}get participantCount(){return this._impl.streamingClientCount}on(g,m){if("liveStreamsUpdated"!==g&&"participantCountChanged"!==g)throw new CallingCommunicationError(z.FEATURES.LIVE_STREAM.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("liveStreamsUpdated"!==g&&"participantCount"!==g)throw new CallingCommunicationError(z.FEATURES.LIVE_STREAM.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}createStatsCollector(g){return this._impl.createStatsCollector(g)}}class LiveStreamCallFeatureImplOverTsCall extends BotStreamCommonCallFeature{constructor(g,m){super(m,getAcsEcsConfig().calling.liveStreamingBotIds),this._eventEmitter=g}initialize(g,m,f,S,v){super.initialize(g,m,f,S,v),this._statsManager=new LiveStreamStatsManager(g,v,S,this._streamIdToStreamMap),this._tsCall.participantCounts&&null!=this._tsCall.participantCounts.streamingClients&&(this._participantCount=this._tsCall.participantCounts.streamingClients),this._tsCall.on("participantCountsUpdated",(()=>{if(this._tsCall.participantCounts&&this._participantCount!==this._tsCall.participantCounts.streamingClients){const g=this._participantCount;this._participantCount=this._tsCall.participantCounts.streamingClients,this._logger.log(`tsCall participantCount changed from ${g} to ${this._participantCount}`),this._eventEmitter.emit("participantCountChanged")}}))}dispose(){super.disposeAllBotStreams(),this._statsManager.dispose()}createStatsCollector(g){return this._statsManager.createStatsCollector(g)}get liveStreams(){return[...this._streamIdToStreamMap.values()].map((g=>g))}get streamingClientCount(){return this._participantCount??0}createConcreteVideoStream(g,m){return new LiveVideoStreamImpl(g,this._logger,this._call,this._callAgent,m,this._telemetryLogManager)}getStreamTypes(){return[2]}emitVideoStreamsUpdatedEvent(g){return this._eventEmitter.emit("liveStreamsUpdated",g)}}class LiveVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,f,S,v,C){super(g,m,f,v,C,"LiveVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class ComposedStreamCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new ComposedStreamCallFeatureImplOverTsCall(this.eventEmitter,this.name)}get name(){return"ComposedStream"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}dispose(){this._impl.dispose(),super.dispose()}get composedStreams(){return this._impl.composedStreams}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}}class ComposedStreamCallFeatureImplOverTsCall extends BotStreamCommonCallFeature{constructor(g,m){super(m,getAcsEcsConfig().calling.composedStreamBotIds),this._eventEmitter=g}initialize(g,m,f,S,v){super.initialize(g,m,f,S,v)}dispose(){super.disposeAllBotStreams()}get composedStreams(){return[...this._streamIdToStreamMap.values()].map((g=>g))}createConcreteVideoStream(g,m){return new ComposedVideoStreamImpl(g,this._logger,this._call,this._callAgent,m,this._telemetryLogManager)}getStreamTypes(){return[0]}emitVideoStreamsUpdatedEvent(g){return this._eventEmitter.emit("composedStreamsUpdated",g)}}class ComposedVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,f,S,v,C){super(g,m,f,v,C,"ComposedVideoStream")}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this.getRegisteredViewIds(),height:this._size.height,width:this._size.width,isDisposed:this._disposed}}}class EffectsCapabilityChecker{constructor(g,m){this._logger=g,this._environmentInfo=m,this._videoEffectsEnabled=!1,this._audioEffectsEnabled=!1,this._videoEffectsSupported=!1,this._audioEffectsSupported=!1,this._config=getAcsEcsConfig(),this._mediaConfig=getMediaConfig(),this._videoEffectsEnabled=!(!this._mediaConfig?.enableVideoEffects||!this._config?.videoEffects?.enableVideoEffects),this._audioEffectsEnabled=!!this._config?.audioEffects?.enableAudioEffects,this._videoEffectsEnabled&&(this._videoEffectsSupported=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported())}async videoEffectsSupported(){if(this._videoEffectsEnabled){const g=this._mediaConfig?.webcv?.useWasmEffects?this._isWasmVideoEffectSupported():this._isWebgl2EffectSupported();this._videoEffectsSupported=g&&this._isCurrentEnvironmentSDKSupported()}else this._logger.info("Video effects are disabled."),this._videoEffectsSupported=!1;return this._videoEffectsSupported}async audioEffectsSupported(g){return this._audioEffectsEnabled?this._audioEffectsSupported=this._isBrowserEffect(g)?this._isBrowserEffectSupported(g):await this._isWasmAudioEffectSupported():(this._logger.info("Audio effects are disabled."),this._audioEffectsSupported=!1),this._audioEffectsSupported}_isBrowserEffect(g){if("string"==typeof g)switch(g){case"BrowserEchoCancellation":case"BrowserNoiseSuppression":case"BrowserAutoGainControl":return!0;default:return!1}return!1}_isBrowserEffectSupported(g){const m=window.navigator?.mediaDevices?.getSupportedConstraints?.();if(m)switch(g){case"BrowserEchoCancellation":return!!m.echoCancellation;case"BrowserNoiseSuppression":return!!m.noiseSuppression;case"BrowserAutoGainControl":return!!m.autoGainControl;default:return!1}return!1}_isCurrentEnvironmentSDKSupported(){return!!(this._environmentInfo.isSupportedBrowser&&this._environmentInfo.isSupportedBrowserVersion&&this._environmentInfo.isSupportedEnvironment&&this._environmentInfo.isSupportedPlatform)}_isWasmVideoEffectSupported(){return this._mediaConfig?.webcv?.useWasmEffects?!!window.MediaStreamTrackProcessor||(this._logger.info("WASM effects disabled, insertable streams are not supported"),!1):(this._logger.info("WASM effects disabled by WebCV feature flag"),!1)}_isWebgl2EffectSupported(){return this._isCurrentRendererSupported()&&this._isWebGL2Supported()}_isCurrentRendererSupported(){const g=this._mediaConfig?.webcv?.webGLUnsupportedRenderers??[];let m=!1;try{const f=document.createElement("canvas").getContext("webgl"),S=f?.getExtension("WEBGL_debug_renderer_info"),v=S&&f?.getParameter(S.UNMASKED_RENDERER_WEBGL);return v&&!g.some((g=>g===v))?m=!0:this._logger.info(`Unsupported renderer: ${stringifyObject(v)}`),m}catch(g){return this._logger.warn(`Error trying to check compatibility: ${JSON.stringify(g)}`),!1}}_isWebGL2Supported(){try{const g=document.createElement("canvas").getContext("webgl2");if(!g)return this._logger.info("WebGL2 context is not supported"),!1;const m=g.getSupportedExtensions(),f=this._mediaConfig?.webcv?.webGLRequiredExtensions.filter((g=>!m?.includes(g)));if(f.length>0)return this._logger.info(`Unsupported WebGL2 extensions: ${stringifyObject(f)}`),!1}catch(g){return this._logger.error(`isWebGL2Supported: ${stringifyObject(g)}`),!1}return!0}async _isWasmAudioEffectSupported(){return window.AudioWorkletNode?!!window.WebAssembly||(this._logger.info("WebAssembly is not supported"),!1):(this._logger.info("AudioWorkletNode is not supported"),!1)}}const Ng=[{acsEffect:"Off",tsCallingEffect:0},{acsEffect:"BackgroundBlur",tsCallingEffect:1},{acsEffect:"BackgroundReplacement",tsCallingEffect:16}];class VideoEffectsFeatureImpl extends FirstPartyVideoStreamFeature{constructor(){super(...arguments),this._effect=null,this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[],this._tsCallingEffectCapability=0,this._tsCallingSupportedEffects=[{acsEffect:"Off",tsCallingEffect:0}],this._activeEffects=[],this.configUpdatedCallback=async g=>{console.log("config updated callback");const m=this._internalDeviceManager.getTsDeviceManager();if("BackgroundReplacement"===g){const g=(this._effect?._internalHandle?.effectConfig).backgroundImageUrl;g&&await m.setBackgroundImageAsync("",g)}},this.processingErrorCallback=async g=>{const m=generateGuid();this.eventEmitter.emit("effectsError",g);const f=this.getEffectNameForTelemetry(this._effect?.name),S=this.getUsageDetailsForTelemetry("Internal handle error",f);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.effectsError,kindOfEvent:Lh.failure,additionalDetails:{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g),usageDetails:S}}),await this.stopEffects()},this.effectStatusChangedCallback=(g,m)=>{if(m.length>0){const g=this._effect?.name?[this._effect.name]:m;this.eventEmitter.emit("effectsStarted",g)}else{const m=this._effect?.name?[this._effect.name]:g;this.eventEmitter.emit("effectsStopped",m)}}}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this.updateEffectStatusManager()}get name(){return"VideoEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g&&"fpsWarningThresholdReached"!==g&&"timeForEffectsWarningReached"!==g)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m);const f=generateGuid();this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:f,operation:Su.subscribe,additionalDetails:{usageDetails:`Subscribed to ${g}`}})}off(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g&&"fpsWarningThresholdReached"!==g&&"timeForEffectsWarningReached"!==g)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}async isSupported(g){const m=generateGuid(),f=+new Date,S=this.getEffectNameForTelemetry(g?.name),v=this.getUsageDetailsForTelemetry("",S);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,kindOfEvent:Lh.attempt,additionalDetails:{usageDetails:v}});try{const S=this.getEffectInternalCast(g);if(this.disposed)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.START_DISPOSED);if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const v=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new EffectsCapabilityChecker(this._logger,v));const C=await this._supportChecker.videoEffectsSupported();this._logger.info(`Support check for ${S.name} resulted in: ${C}`);const _=this.getUsageDetailsForTelemetry("",S.name);return this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.success,additionalDetails:{usageDetails:_}}),C}catch(S){const v=new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.SUPPORT_CHECK_FAILED,S);this._logger.error(v.message);const C=this.getEffectNameForTelemetry(g?.name),_=this.getUsageDetailsForTelemetry("",C);throw this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v),usageDetails:_}}),v}}async startEffects(g){const m=generateGuid(),f=+new Date,S=this.getEffectNameForTelemetry(g?.name),v=this.getUsageDetailsForTelemetry("",S);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,kindOfEvent:Lh.attempt,additionalDetails:{usageDetails:v}});try{if(!getAcsEcsConfig().videoEffects.enableVideoEffects)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.DISABLED);if(this.disposed)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.START_DISPOSED);if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_SOURCE);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this.updateEffectStatusManager(),this.subscribeToStreamInstanceEvents();const S=window.performance.now();this._effect=this.getEffectInternalCast(g);if(!await this.isSupported(g))throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT);const v=this._internalDeviceManager.getTsDeviceManager();if(!v)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.START_DEVICE_MANAGER);this.setConfigForEffects(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();const C=await this._effect._internalHandle.getEffectProvider();if(!C)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.PROVIDER_UNAVAILABLE);const _=await C.getVideoEffectProvider(),E=this.streamInstance.callStackWebCVProvider;if(!E)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.WEBCV_PROVIDER_FAILED);E.videoEffectProviderDeferredPromise.resolve(_),0===this._tsCallingEffectCapability&&(this._tsCallingEffectCapability=await(v?.getDeviceEffectsCapabilityAsync(""))),this._tsCallingSupportedEffects=this.getTsCallingSupportedEffects();const T=this._tsCallingSupportedEffects.find((g=>g.acsEffect===this._effect?.name));if(!T)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT);await(v?.setDeviceEffectsAsync("",T.tsCallingEffect)),this._effectsStatusManager.setActiveEffects([this._effect.name]),this._logger.info(`Video effects started: ${this._effect.name}`);const I=window.performance.now();this.handleEffectsInitTimeEvent(S,I),this.handleFpsWarningEvent();const b=this.getUsageDetailsForTelemetry("",this._effect.name);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.success,additionalDetails:{usageDetails:b}})}catch(S){const v=new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.START_FAILED,S);this._logger?.error(v.message),this.eventEmitter.emit("effectsError",v),this.clearFpsCheckInterval();const C=this.getEffectNameForTelemetry(g?.name),_=this.getUsageDetailsForTelemetry("",C);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v),usageDetails:_}})}}async stopEffects(){const g=generateGuid(),m=+new Date;this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:g,operation:Su.stopEffects,kindOfEvent:Lh.attempt});try{if(this.clearFpsCheckInterval(),this.disposed)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.STOP_DISPOSED);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const f=this._internalDeviceManager.getTsDeviceManager();if(!f)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.STOP_DEVICE_MANAGER);this.updateEffectStatusManager();const S=this._tsCallingSupportedEffects.find((g=>"Off"===g.acsEffect));if(!S)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.UNSUPPORTED_EFFECT);await f.setDeviceEffectsAsync("",S.tsCallingEffect),this._effectsStatusManager?.setActiveEffects([]);const v=this.getEffectNameForTelemetry(this._effect?.name);this._logger.info(`Video effects stopped: ${v}`),this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:g,operation:Su.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Lh.success})}catch(f){const S=new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.STOP_FAILED,f);this._logger?.error(S.message),this.eventEmitter.emit("effectsError",S),this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:g,operation:Su.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Lh.failure,additionalDetails:{failureReason:S.message,code:S.code,...extractCommunicationServicesErrorForTelemetry(S)}})}}async dispose(){try{if(this.disposed)return void this._logger.info("VideoEffects feature already disposed");this._effect&&(await this.stopEffects(),this._effect._internalHandle.dispose(),this._effect=null),this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.disposed=!0,this._logger.info("VideoEffects feature disposed")}catch(g){const m=new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.DISPOSE_FAILED,g);this._logger?.error(m.message),this.eventEmitter.emit("effectsError",m)}}getEffectInternalCast(g){if("BackgroundBlur"===g?.name&&this.isValidEffectInstance(g))return g;if("BackgroundReplacement"===g?.name&&this.isValidEffectInstance(g))return g;throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.INVALID_EFFECT)}isValidEffectInstance(g){let m;return("BackgroundBlur"===g.name&&void 0!==g._internalHandle||"BackgroundReplacement"===g.name&&void 0!==g._internalHandle)&&(m=g,this.hasValidInternalHandle(m._internalHandle))}hasValidInternalHandle(g){return void 0!==g.effectConfig&&void 0!==g.getEffectProvider&&void 0!==g.dispose&&void 0!==g.getStats&&void 0!==g.setConfig}getTsCallingSupportedEffects(){const g=[];return Object.values(Ng).forEach((m=>{(this._tsCallingEffectCapability&m.tsCallingEffect)===m.tsCallingEffect&&g.push(m)})),g}subscribeToEffectEvents(){this._effect&&this._internalDeviceManager?(this._effect._internalHandle.on("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.on("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}disposeEffectEventSubscriptions(){this._effect?(this._effect._internalHandle.off("configUpdated",this.configUpdatedCallback),this._effect._internalHandle.off("processingError",this.processingErrorCallback)):this._logger.debug("No effect instance found.")}subscribeToStreamInstanceEvents(){this.streamInstance.on("videoSourceChanged",(async g=>{g.source&&"Video"!==g.source.mediaStreamType&&await this.stopEffects()}))}handleEffectsInitTimeEvent(g,m){if(!this._effect)return void this._logger.debug("No effect active");const f=generateGuid(),S=m-g,v=this._effect._internalHandle.effectConfig.effectInitTimeThresholdInMs;if(this._logger.info(`Time for effects to start: ${S}ms`),v&&S>v){this.eventEmitter.emit("timeForEffectsWarningReached",this._effect.name);const g=this.getUsageDetailsForTelemetry(`Threshold value: ${v}ms`,this._effect.name);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:f,operation:Su.timeForEffectsWarningReached,additionalDetails:{usageDetails:g}})}}handleFpsWarningEvent(){if(!this._effect)return void this._logger.debug("No effect active");this.clearFpsCheckInterval();const g=getAcsEcsConfig(),m=generateGuid(),f=g.videoEffects.waitTimeToInitiateFpsChecksInMs,S=g.videoEffects.fpsCheckIntervalTimeInMs;this._fpsWarningThresholdValue=this._effect._internalHandle.effectConfig.fpsWarningThreshold??g.videoEffects.fpsWarningThreshold;const startFpsChecker=()=>{const g=window.setInterval((()=>{const f=this._effect?._internalHandle.getStats(),S=f?.processor.fpsAvg;if(this._logger.info(`Effects avg fps check interval poll. Current Avg - ${S}`),S&&S<this._fpsWarningThresholdValue){this.eventEmitter.emit("fpsWarningThresholdReached",this._effect?.name),window.clearInterval(g),this._logger.info(`Effects fps warning threshold hit at ${S}fps`);const f=this.getUsageDetailsForTelemetry(`Fps reported: ${S}, Fps warning threshold value: ${this._fpsWarningThresholdValue}`,this._effect?.name);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.fpsWarningThresholdReached,additionalDetails:{usageDetails:f}})}}),S);this._fpsWarningEventIntervalIds.push(g)},v=window.setTimeout(startFpsChecker,f);this._fpsWarningEventTimeoutIds.push(v)}setConfigForEffects(){if(!this._effect)return void this._logger.debug("No effect active");const g=this._effect._internalHandle.configProvider.config.videoEffects??this._effect._internalHandle.configProvider.config,m=getMediaConfig(),f=getAcsEcsConfig();if(m?.enableVideoEffects&&f?.videoEffects?.enableVideoEffects&&(g.enableVideoEffects=m.enableVideoEffects&&f.videoEffects.enableVideoEffects),g.effectConfig={...g.effectConfig,effectInitTimeThresholdInMs:f.videoEffects.effectInitTimeThresholdInMs,fpsWarningThreshold:f.videoEffects.fpsWarningThreshold},m.webcv){const f=m.webcv;g.webcvConfig={...g.webcvConfig,...f}}this._effect._internalHandle.setConfig(g),this._logger.info(`Config for effects set: ${stringifyObject(g)}`)}sendFeatureUsageTelemetry(g){if(this._telemetryLogManager)try{const m={correlationId:g.correlationId,mediaType:mu.VideoRaw,streamType:fu.Local,operation:g.operation,timestampInfo:g.timestampInfo||{},kindOfEvent:g.kindOfEvent||"",additionalDetails:g.additionalDetails||""};this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:m})}catch(m){this._logger.debug(`Unable to send ${g.operation} telemetry`)}else this._logger.debug("Telemetry error. Instance is undefined.")}getEffectNameForTelemetry(g){let m="UNKNOWN";return g?m="string"==typeof g?g:JSON.stringify(g):this._effect?.name?m=this._effect.name:this._activeEffects?.[0]&&(m=JSON.stringify(this._activeEffects[0])),m}getUsageDetailsForTelemetry(g,m=""){return`${m?`[${m}] `:""}${g}`}clearFpsCheckInterval(){this._fpsWarningEventIntervalIds.forEach((g=>{window.clearInterval(g)})),this._fpsWarningEventTimeoutIds.forEach((g=>{window.clearTimeout(g)})),this._fpsWarningEventIntervalIds=[],this._fpsWarningEventTimeoutIds=[]}updateEffectStatusManager(){this.streamInstance.canStartEffects?(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this._effectsStatusManager||(this._effectsStatusManager=this._internalDeviceManager.callStackVideoEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback)),this._activeEffects=this._effectsStatusManager.getActiveEffects()):this._logger.warn("Cannot update status manager, current source is not supported.")}}class ParticipantMappingManager$1{constructor(g){this._tsCall=g,this._activeParticipantMris=new Set,this._participantMriToSourceId=new Map,this._sourceIdToParticipantMri=new Map,this._sourceIdToParticipantId=new Map,this._listenerHandles=[],this._eventEmitter=new bu.EventEmitter,this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g),this._eventEmitter.emit("participantAdded",g.id)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._activeParticipantMris.has(g.id)&&this._updateMapping(g)&&this._eventEmitter.emit("participantUpdated",g.id)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._activeParticipantMris.delete(g.id),this._removeMapping(g),this._eventEmitter.emit("participantRemoved",g.id)}))),this._tsCall.participants.forEach((g=>{this._activeParticipantMris.add(g.id),this._updateMapping(g)}))}_updateMapping(g){const m=g.id,f=[];g.endpoints?.endpointDetails?.forEach((g=>{const m=g.mediaStreams?.find((g=>"data"===g.type));m&&(f.push(m.sourceId),this._sourceIdToParticipantId.set(m.sourceId,g.participantId))}));const S=this._participantMriToSourceId.get(m);return f.sort(),!R.isEqual(f,S)&&(this._participantMriToSourceId.set(m,f),f.forEach((g=>{this._sourceIdToParticipantMri.set(g,m)})),!0)}_removeMapping(g){const m=g.id,f=this._participantMriToSourceId.get(m)||[];this._participantMriToSourceId.delete(m),f.forEach((g=>{this._sourceIdToParticipantMri.delete(g),this._sourceIdToParticipantId.delete(g)}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}findParticipantMri(g){let m=this._sourceIdToParticipantMri.get(g);return void 0===m&&this.isP2P()&&this._tsCall.participants.length&&(m=this._tsCall.participants[0].id),m}findParticipantId(g){let m=this._sourceIdToParticipantId.get(g);if(void 0===m&&this.isP2P()&&this._tsCall.participants.length&&this._tsCall.participants[0].endpoints?.endpointDetails.length){const g=this._tsCall.participants[0].endpoints?.endpointDetails[0];m=g.participantId}return m}findSourceIds(g){return this._participantMriToSourceId.get(g)??[]}isP2P(){return 1===this._tsCall.callType}dispose(){this._activeParticipantMris.clear(),this._participantMriToSourceId.clear(),this._sourceIdToParticipantMri.clear(),this._sourceIdToParticipantId.clear(),this._listenerHandles.forEach((g=>g.dispose())),this._eventEmitter.removeAllListeners()}}const kg=2147483648,Lg=65535,Fg=1024,xg=255,Ug=8,Vg=64,Bg=4294967295,Hg="Normal",$g="Durable",Gg=.4,jg=.8;function invalidEventSubscription(g,m){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.EVENT_SUBSCRIBE(m,g))}function wrongArgumentType(g,m){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_TYPE(g,m))}function wrongArgumentValue(g,m){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.WRONG_ARGUMENT_VALUE(g,m))}function dataChannelHasBeenDisposed(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.DISPOSED)}function senderIsNotReady(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.SENDER_NOT_READY)}function noAvailableChannelId(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.NO_AVAILABLE_CHANNEL_ID)}function invalidChannelId(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.INVALID_CHANNEL_ID)}function tooManyParticipants(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.TOO_MANY_PARTICIPANTS)}function noValidParticipants(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.NO_VALID_PARTICIPANT)}function messageDataIsEmpty(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.MSG_DATA_EMPTY)}function messageDataSizeIsTooLarge(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.MSG_DATA_TOO_LARGE)}function invalidMessageLength(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.INVALID_MSG_LENGTH)}function sendBufferIsFull(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.BUFFER_FULL)}function senderIsClosed(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.SENDER_CLOSED)}function noAvailableReliableDataId(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.NO_AVAILABLE_RELIABLE_CHANNEL)}function noAvailableUnreliableDataId(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.NO_AVAILABLE_UNRELIABLE_CHANNEL)}function channelHasBeenAllocated(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.CHANNEL_ALREADY_ALLOCATED)}function channelNotFound(g){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.CANT_FIND_CHANNEL_ID(g))}function trafficLimited(){return new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.TRAFFIC_LIMITED)}function getErrorString(g){return g?.message??"Unknown"}function logError(g,m,f){const S=f.value;return f.value=function(...g){try{return S?.apply(this,g)}catch(g){throw this?._logger?.error(`${m}: ${getErrorString(g)}`),g}},f}function logErrorAsync(g,m,f){const S=f.value;return f.value=async function(...g){try{return await(S?.apply(this,g))}catch(g){throw this?._logger?.error(`${m}: ${getErrorString(g)}`),g}},f}class Message{constructor(){this._firstByte=0,this._channelVersion=0,this._channelId=0,this._sequenceNumber=0}static parse(g){if(g.length<Message.headerLength)throw invalidMessageLength();const m=new DataView(g.buffer),f=m.getUint8(0),S=m.getUint8(1),v=m.getUint16(2),C=m.getUint32(4),_=g.slice(Message.headerLength),E=new Message;return E._firstByte=f,E._channelVersion=S,E._channelId=v,E._sequenceNumber=C,E._data=_,E._serializedData=g,E}static create(g,m,f,S){const v=new Message,C=new Uint8Array(Message.headerLength+S.length),_=new DataView(C.buffer);return m&=255,g&=65535,f>>>=0,_.setUint8(0,0),_.setUint8(1,m),_.setUint16(2,g),_.setUint32(4,f),C.set(S,Message.headerLength),v._channelVersion=m,v._channelId=g,v._sequenceNumber=f,v._data=S,v._serializedData=C,v}get channelId(){return this._channelId}set channelId(g){this._channelId=g}get channelVersion(){return this._channelVersion}get sequenceNumber(){return this._sequenceNumber}get data(){return this._data}get serializedData(){return this._serializedData}isInternal(){return 0!=(128&this._firstByte)}isEmpty(){return 0===this._data.length}}var Wg;Message.headerLength=Ug,function(g){g[g.Initializing=0]="Initializing",g[g.Initialized=1]="Initialized",g[g.Started=2]="Started",g[g.Stopped=3]="Stopped",g[g.Destroyed=4]="Destroyed"}(Wg||(Wg={}));class DataChannelAdapter{constructor(g,m){this._eventEmitter=new bu.EventEmitter,this._state=Wg.Initializing,this._tsCall=g,this._dataId=m}async initialize(){const g={onStarted:async(g,m,f)=>{this._dataSendFunction=m,this._getStats=f,this._state=Wg.Started,this._eventEmitter.emit("stateChanged",this._state)},onStopped:async g=>{this._dataSendFunction=void 0,this._getStats=void 0,this._state=Wg.Stopped,this._eventEmitter.emit("stateChanged",this._state)},onDataReceived:async(g,m,f)=>{const S={sourceId:f,data:m};this._eventEmitter.emit("message",S)}};await(this._tsCall.dataChannelAdapter?.addHandler(this._dataId,g)),this._state<Wg.Initialized&&(this._state=Wg.Initialized)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}send(g,m){return this._dataSendFunction?this._dataSendFunction(g,m):Promise.reject(senderIsNotReady())}getStats(){return this._getStats?this._getStats():Promise.resolve({bufferSize:0,remainingBytes:0,remainingPackets:0})}get state(){return this._state}dispose(){if(this._state===Wg.Destroyed)return;const g=this._state;this._state=Wg.Destroyed,this._dataSendFunction=void 0,this._getStats=void 0,g!==Wg.Initializing&&this._tsCall.dataChannelAdapter?.removeHandler(this._dataId).catch(noop),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners()}}class DataChannelProcessor{constructor(g,m,f){const S=g.dataId;this._logger=f.createChild(`DataChannelProcessor(${S})`),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogOn:!1,enableLogOff:!1,enableLogOnce:!1,enableLogEmit:!1}),this._bufferFullErrorMessage=`dataId ${S} send queue is full`,this._dataChannelAdapter=new DataChannelAdapter(m,S),this._dataChannelAdapter.on("message",(g=>{try{const m=g.sourceId,f=Message.parse(g.data),S={sourceId:m,message:f};f.isInternal()?this._eventEmitter.emit("internalMessage",S):this._eventEmitter.emit("message",S)}catch(g){this._logger.error(`process message error: ${getErrorString(g)}`)}}))}async initialize(){await this._dataChannelAdapter.initialize()}async send(g){try{if(void 0===g.recipients)throw noValidParticipants();if(g.recipients.length>Vg)throw tooManyParticipants();await this._dataChannelAdapter.send(g.data,g.recipients)}catch(g){throw g?.message===this._bufferFullErrorMessage?sendBufferIsFull():new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.SEND_FAIL,g)}}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._eventEmitter.removeAllListeners(),this._dataChannelAdapter.dispose()}}class RecipientsManager{constructor(g){this._sourceIds=[],this._participantMappingManager=g,this._participantMapping=new Map,g.on("participantAdded",(g=>{if(this._participantMapping.has(g)){const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m),this._updateSourceIds()}})),g.on("participantUpdated",(g=>{if(this._participantMapping.has(g)){const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m),this._updateSourceIds()}})),g.on("participantRemoved",(g=>{this._participantMapping.has(g)&&(this._participantMapping.set(g,[]),this._updateSourceIds())}))}get sourceIds(){if(this._participantMappingManager.isP2P()||!(this._participantMapping.size>0)||0!==this._sourceIds.length)return this._sourceIds}setParticipants(g){const m=[];g.forEach((g=>{validateIdentifier(g),m.push(getMriFromIdentifier(g))})),this._participantMapping.clear(),m.forEach((g=>{const m=this._participantMappingManager.findSourceIds(g);this._participantMapping.set(g,m)})),this._updateSourceIds()}_updateSourceIds(){this._sourceIds=Array.from(this._participantMapping.values()).flat()}}var qg,__decorate$7=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$7=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};!function(g){g[g.Open=0]="Open",g[g.Closed=1]="Closed",g[g.Destroyed=2]="Destroyed"}(qg||(qg={}));class DataChannelSenderImpl{constructor(g,m,f,S,v,C){this._state=qg.Open;const _=getAcsEcsConfig().dataChannel;this._eventEmitter=new bu.EventEmitter,this._channelId=g,this._channelVersion=m,this._sequenceNumber=Math.floor(Math.random()*(Bg+1)),this._recipientsManager=new RecipientsManager(S),this._dataChannelMonitor=v,this._sendMessageFunction=f,this._maxMessageSize=_.maxMessageSize,this._logger=C.createChild(`DataChannelSender(${g},${m})`),this._logger.info("opened")}get channelId(){return this._channelId}get maxMessageSize(){return this._maxMessageSize}setParticipants(g){if(!Array.isArray(g))throw wrongArgumentType("participants","CommunicationIdentifier[]");if(g.length>Vg)throw tooManyParticipants();this._recipientsManager.setParticipants(g),this._logger.info(`participant size: ${g.length}`)}async sendMessage(g){if(this._dataChannelMonitor.updateAttemptStats(g.length),!(g instanceof Uint8Array))throw wrongArgumentType("data","Uint8Array");if(this._state===qg.Closed)throw senderIsClosed();if(0===g.length)throw messageDataIsEmpty();if(g.length>this._maxMessageSize)throw messageDataSizeIsTooLarge();const m=this._recipientsManager.sourceIds;await this._sendMessage(g,m),this._dataChannelMonitor.updateCommitStats(g.length)}close(){this._state<qg.Closed&&(this._sendMessage(new Uint8Array,[]).catch(noop),this._state=qg.Closed,this._eventEmitter.emit("close"),this._logger.info("closed"),this._dataChannelMonitor.close())}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this.close(),this._state!==qg.Destroyed&&(this._eventEmitter.removeAllListeners(),this._state=qg.Destroyed,this._logger.info("disposed"))}get channelVersion(){return this._channelVersion}get state(){return this._state}async _sendMessage(g,m){const f=Message.create(this._channelId,this._channelVersion,this._sequenceNumber,g);this._sequenceNumber=(this._sequenceNumber+1)%(Bg+1);const S={channelId:this._channelId,channelVersion:this._channelVersion,recipients:m,data:f.serializedData};await this._sendMessageFunction(S)}}__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[Array]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"setParticipants",null),__decorate$7([logErrorAsync,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[Uint8Array]),__metadata$7("design:returntype",Promise)],DataChannelSenderImpl.prototype,"sendMessage",null),__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"close",null),__decorate$7([logError,__metadata$7("design:type",Function),__metadata$7("design:paramtypes",[]),__metadata$7("design:returntype",void 0)],DataChannelSenderImpl.prototype,"dispose",null);class Node{constructor(g){this.value=g,this.next=void 0}}class Queue{constructor(){this.length=0,this.front=void 0,this.rear=void 0}enqueue(g){const m=new Node(g);this.front?(this.rear.next=m,this.rear=m):(this.front=m,this.rear=m),this.length++}dequeue(){if(!this.front)return;const g=this.front;return this.front===this.rear?(this.front=void 0,this.rear=void 0):this.front=this.front.next,this.length--,g.value}peek(){return this.front?.value}size(){return this.length}back(){return this.rear?.value}isEmpty(){return 0===length}clear(){this.front=void 0,this.rear=void 0,this.length=0}}var zg,__decorate$8=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$8=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};!function(g){g[g.Open=0]="Open",g[g.Closed=1]="Closed",g[g.Destroyed=2]="Destroyed"}(zg||(zg={}));class DataChannelReceiverImpl{constructor(g,m,f,S,v,C){this._receiveBuffers=new Queue,this._remainingBytes=0,this._state=zg.Open,this._channelVersion=0;const _=getAcsEcsConfig().dataChannel;this._logger=C.createChild(`DataChannelReceiver(${g},${S},${f})`),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._maxBufferSize=_.maxReceiveBufferSize,this._dataChannelMonitor=v,this._channelId=g,this._senderParticipantIdentifier=constructIdentifierKindFromMri(m),this._channelVersion=S,this._lastMessageTimestamp=Date.now(),this._logger.info("created.")}get channelId(){return this._channelId}get senderParticipantIdentifier(){return this._senderParticipantIdentifier}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}readMessage(){const g=this._receiveBuffers.dequeue();return g?.data&&(this._remainingBytes-=g.data.length),g}dispose(){this._state!==zg.Destroyed&&(this.close(),this._state=zg.Destroyed,this._receiveBuffers.clear(),this._eventEmitter.removeAllListeners())}close(){this._state===zg.Open&&(this._state=zg.Closed,this._eventEmitter.emit("close"),this._dataChannelMonitor.close())}get channelVersion(){return this._channelVersion}get lastMessageTimestamp(){return this._lastMessageTimestamp}get state(){return this._state}appendMessage(g){if(this._dataChannelMonitor.updateAttemptStats(g.data.length),this._state!==zg.Open)return;if(0===g.data.length)return void this.close();if(this._lastMessageTimestamp=Date.now(),this._remainingBytes+g.data.length>this._maxBufferSize)return;const m={sequenceNumber:g.sequenceNumber,data:g.data};this._receiveBuffers.enqueue(m),this._remainingBytes+=g.data.length,this._eventEmitter.emit("messageReady"),this._dataChannelMonitor.updateCommitStats(g.data.length)}}function logSenderOptions(g){const m=[];return void 0!==g.bitrateInKbps&&m.push(`bitrateInKbps=${g.bitrateInKbps}`),void 0!==g.channelId&&m.push(`channelId=${g.channelId}`),void 0!==g.participants&&m.push(`participants size=${g.participants.length}`),void 0!==g.priority&&m.push(`priority=${g.priority}`),void 0!==g.reliability&&m.push(`reliability=${g.reliability}`),m.join(",")}function compareChannelVersion(g,m){if(g===m)return 0;if(-1===m)return 1;const f=g-m;return f>0?f<xg/2?1:-1:-f>xg/2?1:-1}function nextChannelVersion(g){return g===xg?0:g+1}__decorate$8([logError,__metadata$8("design:type",Function),__metadata$8("design:paramtypes",[]),__metadata$8("design:returntype",Object)],DataChannelReceiverImpl.prototype,"readMessage",null),__decorate$8([logError,__metadata$8("design:type",Function),__metadata$8("design:paramtypes",[Message]),__metadata$8("design:returntype",void 0)],DataChannelReceiverImpl.prototype,"appendMessage",null);class DataChannelReceiversManager{constructor(g,m,f){this._timeoutHandle=0;const S=getAcsEcsConfig().dataChannel;this._eventEmitter=new bu.EventEmitter,this._participantMappingManager=g,this._dataChannelMonitor=m,this._logger=f,this._receivers=new Map,this._lastestVersion=new Map,this._receiveTimeoutInMs=S.receiveTimeoutInMs}_checkTimeoutReceivers(){Array.from(this._receivers.keys()).forEach((g=>{const m=this._receivers.get(g);if(void 0!==m){Date.now()-m.lastMessageTimestamp>=this._receiveTimeoutInMs&&m.close()}})),this._receivers.size>0&&(this._timeoutHandle=window.setTimeout((()=>{this._timeoutHandle=0,this._checkTimeoutReceivers(),Math.ceil(this._receiveTimeoutInMs/2)})))}appendMessage(g){const m=`${g.sourceId},${g.message.channelId}`,f=`${g.sourceId},${g.message.channelId},${g.message.channelVersion}`;let S=this._lastestVersion.get(m),v=this._receivers.get(f);const C=g.message;if(void 0===v){if(void 0!==S){if(-1===compareChannelVersion(C.channelVersion,S))return}if(this._lastestVersion.set(m,C.channelVersion),C.isEmpty())return;if(0===this._eventEmitter.listenerCount("dataChannelReceiverCreated"))return;const _=this._participantMappingManager.findParticipantMri(g.sourceId)??"",E=this._participantMappingManager.findParticipantId(g.sourceId)??"",T=this._dataChannelMonitor.createReceiverMonitor(C.channelId,C.channelVersion,E);this._logger.info(`channelId:${C.channelId} message from ${E}, sourceId:${g.sourceId}, channelVersion:${C.channelVersion}`),v=new DataChannelReceiverImpl(C.channelId,_,g.sourceId,C.channelVersion,T,this._logger),v.on("close",(()=>{this._receivers.delete(f)})),this._receivers.set(f,v),this._eventEmitter.emit("dataChannelReceiverCreated",v),0===this._timeoutHandle&&this._checkTimeoutReceivers()}v.appendMessage(C),C.isEmpty()&&this._receivers.delete(f)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){window.clearTimeout(this._timeoutHandle),this._timeoutHandle=0,this._receivers.forEach(((g,m)=>{g.dispose()})),this._lastestVersion.clear(),this._receivers.clear(),this._eventEmitter.removeAllListeners()}}const Kg=Lg-Fg+1;class RandomPickStrategy{constructor(g){this._channelIdsInUse=g}findAvailableChannelId(){if(this._channelIdsInUse.size>=Kg)throw noAvailableChannelId();const genId=()=>Math.floor(Math.random()*Kg)+Fg;let g;for(;(g=genId())&&this._channelIdsInUse.has(g););return g}}class ShuffleArrayStrategy{constructor(g){this._availableChannelIds=[],this._channelIdsInUse=g,this._initArray()}findAvailableChannelId(){if(0===this._availableChannelIds.length){if(this._channelIdsInUse.size>=Kg)throw noAvailableChannelId();this._initArray()}return this._availableChannelIds.pop()}_initArray(){const g=Array.from(this._channelIdsInUse,(g=>g)).sort();let m=0,f=0;for(;m<=Lg&&f<g.length;)m<g[f]?(this._availableChannelIds.push(m),m++):(m>g[f]||m++,f++);for(;m<=Lg;)this._availableChannelIds.push(m),m++;this._availableChannelIds=R.shuffle(this._availableChannelIds)}}class RandomChannelIdManager{constructor(){this._channelIdsInUse=new Set,this._highWaterMark=Math.ceil(Kg*jg),this._lowWaterMark=Math.floor(Kg*Gg),this._strategy=new RandomPickStrategy(this._channelIdsInUse)}addChannelId(g){g>=Fg&&g<=Lg&&(this._channelIdsInUse.add(g),this._channelIdsInUse.size>=this._highWaterMark&&this._strategy instanceof RandomPickStrategy&&(this._strategy=new ShuffleArrayStrategy(this._channelIdsInUse)))}removeChannelId(g){this._channelIdsInUse.delete(g),this._channelIdsInUse.size<this._lowWaterMark&&this._strategy instanceof ShuffleArrayStrategy&&(this._strategy=new RandomPickStrategy(this._channelIdsInUse))}findAvailableChannelId(){return this._strategy.findAvailableChannelId()}}class DurableDataIdResourceManager{constructor(g){this._dataIds=[],this._channelIds=new Map,g.forEach((g=>{this._dataIds.push({dataId:g.dataId,bandwidth:g.bandwidth,allocatedBandwidth:0})}))}allocate(g){const m=R.maxBy(this._dataIds,(m=>1-(m.allocatedBandwidth+g.bitrate)/m.bandwidth));if(void 0===m)throw noAvailableReliableDataId();return m.allocatedBandwidth+=g.bitrate,this._channelIds.set(g.channelId,{dataId:m.dataId,allocatedBandwidth:g.bitrate}),m.dataId}deallocate(g){const m=this._channelIds.get(g);if(void 0!==m){const f=this._dataIds.find((g=>g.dataId===m.dataId));void 0!==f&&(f.allocatedBandwidth-=m.allocatedBandwidth),this._channelIds.delete(g)}}getDataIds(g){const m=this._channelIds.get(g);return void 0!==m?[m.dataId]:[]}}function isPowerOf2(g){if(g.find((g=>!Number.isInteger(Math.log2(g)))))return!1;for(let m=1;m<g.length;m++)if(g[m]!==2*g[m-1])return!1;return!0}class DataIdSelectionNullStrategy{getDataIds(g){throw noAvailableUnreliableDataId()}getAllSum(){return 0}}class DataIdSelectionPower2Strategy{constructor(g){this._acsDataIdConfigs=[],this._bandwidthList=[],this._acsDataIdConfigs=g,g.forEach((g=>{this._bandwidthList.push(g.bandwidth/1e3)})),this._allSum=R.sumBy(g,(g=>g.bandwidth))}getDataIds(g){let m=[];const f=Math.ceil(g/1e3);if(f>=this._allSum)m=this._acsDataIdConfigs.map((g=>g.dataId));else{const g=this._bandwidthList[0]-1;let S=0;0!=(f&g)&&(S=this._bandwidthList.findIndex((g=>0==(g&f))),-1!==S&&(m.push(this._acsDataIdConfigs[S].dataId),S++));for(let g=S;g<this._bandwidthList.length;g++)this._bandwidthList[g]&f&&m.push(this._acsDataIdConfigs[g].dataId)}return m}getAllSum(){return this._allSum}}function powerSet(g){const m=[[]];return g.forEach((g=>{const f=[];m.forEach((m=>{f.push([...m,g])})),m.push(...f)})),m}class DataIdSelectionPowerSetSumStrategy{constructor(g){this._bandwidthMap=new Map,this._bandwidthMap.set(0,[]);powerSet(g).forEach((g=>{const m=R.sumBy(g,(g=>g.bandwidth)),f=this._bandwidthMap.get(m);(void 0===f||g.length<f.length)&&this._bandwidthMap.set(m,g.map((g=>g.dataId)))})),this._bandwidthList=Array.from(this._bandwidthMap.keys()).sort(((g,m)=>g-m))}getDataIds(g){const m=R.sortedIndex(this._bandwidthList,g),f=this._bandwidthList[m]??this._bandwidthList[this._bandwidthList.length-1];return this._bandwidthMap.get(f)||[]}getAllSum(){return R.last(this._bandwidthList)||0}}class BandwidthTable{constructor(g){(g=R.sortBy(g,(g=>g.bandwidth))).length?isPowerOf2(g.map((g=>g.bandwidth/1e3)))?this._dataIdSelectionStrategy=new DataIdSelectionPower2Strategy(g):this._dataIdSelectionStrategy=new DataIdSelectionPowerSetSumStrategy(g):this._dataIdSelectionStrategy=new DataIdSelectionNullStrategy}getDataIds(g){return this._dataIdSelectionStrategy.getDataIds(g)}getAllSum(){return this._dataIdSelectionStrategy.getAllSum()}}class LossyDataIdResourceManager{constructor(g){this._totalNormalPriorityBandwidth=0,this._totalHighPriorityBandwidth=0,this._configs=new Map,this._currentNormalPriorityDataIds=[],this._currentHighPriorityDataIds=[],this._normalPriorityTable=new BandwidthTable(g.filter((g=>"normal"===g.priority))),this._highPriorityTable=new BandwidthTable(g.filter((g=>"high"===g.priority)))}allocate(g){this._configs.set(g.channelId,g),"Normal"===g.priority?this._totalNormalPriorityBandwidth+=g.bitrate:"High"===g.priority&&(this._totalHighPriorityBandwidth+=g.bitrate),this._updateDataIds()}deallocate(g){const m=this._configs.get(g);void 0!==m&&(this._configs.delete(g),"Normal"===m.priority?this._totalNormalPriorityBandwidth-=m.bitrate:"High"===m.priority&&(this._totalHighPriorityBandwidth-=m.bitrate),this._updateDataIds())}getDataIds(g){const m=this._configs.get(g);if(void 0!==m){if("Normal"===m.priority)return this._currentNormalPriorityDataIds;if("High"===m.priority)return this._currentHighPriorityDataIds}return[]}_updateDataIds(){const g=this._highPriorityTable.getAllSum(),m=this._totalHighPriorityBandwidth-g;if(m>0){const g=this._totalNormalPriorityBandwidth+m;this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(g),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth).concat(this._currentNormalPriorityDataIds)}else this._currentNormalPriorityDataIds=this._normalPriorityTable.getDataIds(this._totalNormalPriorityBandwidth),this._currentHighPriorityDataIds=this._highPriorityTable.getDataIds(this._totalHighPriorityBandwidth)}}class DataIdMappingManager{constructor(g){const m=g.filter((g=>"reliable"===g.category)),f=g.filter((g=>"unicast"===g.category)),S=g.filter((g=>"broadcast"===g.category));this._reliableDataIdManager=new DurableDataIdResourceManager(m),this._unicastDataIdManager=new LossyDataIdResourceManager(f),this._broadcastDataIdManager=new LossyDataIdResourceManager(S),this._configs=new Map}allocate(g){let m=-1;if(this._configs.has(g.channelId))throw channelHasBeenAllocated();try{"Durable"===g.reliability?m=this._reliableDataIdManager.allocate(g):(this._unicastDataIdManager.allocate(g),this._broadcastDataIdManager.allocate(g)),this._configs.set(g.channelId,g)}catch(m){throw"Durable"===g.reliability?this._reliableDataIdManager.deallocate(g.channelId):(this._unicastDataIdManager.deallocate(g.channelId),this._broadcastDataIdManager.deallocate(g.channelId)),m}return m}deallocate(g){const m=this._configs.get(g);void 0!==m&&("Durable"===m.reliability?this._reliableDataIdManager.deallocate(g):(this._unicastDataIdManager.deallocate(g),this._broadcastDataIdManager.deallocate(g)),this._configs.delete(g))}getDataIdToSend(g,m,f){const S=this._configs.get(g);if(void 0!==S)return"Durable"===S.reliability?this._reliableDataIdManager.getDataIds(g):f?this._broadcastDataIdManager.getDataIds(g):this._unicastDataIdManager.getDataIds(g);throw channelNotFound(g)}}class DataChannelSendRecvMonitor{constructor(g){this._attemptCount=0,this._attemptBytes=0,this._commitCount=0,this._commitBytes=0,this._dataChannelTelemetryLogger=g,this._openTime=new Date,this._closeTime=this._openTime}updateAttemptStats(g){this._attemptCount++,this._attemptBytes+=g}updateCommitStats(g){this._commitCount++,this._commitBytes+=g}close(){this._closeTime=new Date}}class DataChannelSenderMonitor extends DataChannelSendRecvMonitor{constructor(g,m,f,S){super(S),this._channelId=g,this._channelVersion=m,this._correlationId=f}close(){super.close();const g={direction:"send",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,correlationId:this._correlationId};this._dataChannelTelemetryLogger.sendStatsEvent(g)}}class DataChannelReceiverMonitor extends DataChannelSendRecvMonitor{constructor(g,m,f,S){super(S),this._channelId=g,this._channelVersion=m,this._remoteParticipantId=f}close(){super.close();const g={direction:"recv",channelId:this._channelId,channelVersion:this._channelVersion,openTime:this._openTime,closeTime:this._closeTime,attemptCount:this._attemptCount,attemptBytes:this._attemptBytes,commitCount:this._commitCount,commitBytes:this._commitBytes,remoteParticipantId:this._remoteParticipantId};this._dataChannelTelemetryLogger.sendStatsEvent(g)}}class DataChannelMonitor{constructor(g){this._dataChannelTelemetryLogger=g}createSenderMonitor(g,m,f){return new DataChannelSenderMonitor(g,m,f,this._dataChannelTelemetryLogger)}createReceiverMonitor(g,m,f){return new DataChannelReceiverMonitor(g,m,f,this._dataChannelTelemetryLogger)}}class PacketRateLimiter{constructor(g){this._timeBucket=0,this._maxPacketRate=0,this._packetCount=0,this._maxPacketRate=g}canSend(g){let m=Math.ceil(g/1200);const f=window.performance.now();return Math.floor(f/1e3)==this._timeBucket&&(m+=this._packetCount),m<=this._maxPacketRate}update(g){let m=Math.ceil(g/1200);const f=window.performance.now(),S=Math.floor(f/1e3);S!==this._timeBucket&&(this._timeBucket=S,this._packetCount=0),this._packetCount+=m}}class BitrateLimiter{constructor(g){this._endTime=0,this._maxDataRate=0,this._maxDataRate=g/8}canSend(g){if(0===this._maxDataRate)return!0;const m=window.performance.now(),f=(this._endTime-m)/1e3;return!(f>0)||f+g/this._maxDataRate<=1}update(g){const m=window.performance.now(),f=this._maxDataRate?g/this._maxDataRate*1e3:0;this._endTime<m?this._endTime=m+f:this._endTime+=f}changeBitrate(g){this._maxDataRate=g/8}}class BitrateCalculator{constructor(){this._totalBytes=0,this._lastUpdateTime=window.performance.now(),this._lastUpdateBytes=0,this._currentBitrate=0}getBitrate(){return this._currentBitrate}update(g){this._totalBytes+=g}calculateBitrate(){const g=window.performance.now();g-this._lastUpdateTime>0&&(this._currentBitrate=8*(this._totalBytes-this._lastUpdateBytes)/(g-this._lastUpdateTime)),this._lastUpdateTime=g,this._lastUpdateBytes=this._totalBytes}}class SendTrafficLimiter{constructor(g,m){this._availableBytes=0,this._reducedBytes=0,this._lastUpdateTime=window.performance.now(),this._packetRateLimiter=new PacketRateLimiter(m),this._receiveBitrate=new BitrateCalculator,this._bitrateTimer=window.setInterval((()=>{this._receiveBitrate.calculateBitrate();const m=window.performance.now(),f=(m-this._lastUpdateTime)/1e3;this._availableBytes=g/8*f,this._reducedBytes=.8*this._receiveBitrate.getBitrate()/8*f,this._lastUpdateTime=m}),1e3)}canSend(g,m){return m?!!this._packetRateLimiter.canSend(g)&&this._availableBytes-this._reducedBytes>=g:this._availableBytes>=g}updateSendBytes(g,m){m&&this._packetRateLimiter.update(g),this._availableBytes-=g}updateReceiveBytes(g){this._receiveBitrate.update(g)}dispose(){window.clearInterval(this._bitrateTimer)}}var Jg,Yg;!function(g){g[g.Initializing=0]="Initializing",g[g.Initialized=1]="Initialized",g[g.Destroyed=2]="Destroyed"}(Jg||(Jg={}));class DataChannelManager{constructor(g,m,f){this._state=Jg.Initializing,this._initializedDefer=defer$1();const S=getAcsEcsConfig();this._logger=m,this._tsCall=g,this._dataChannelTelemtryLogger=f,this._participantMappingManager=new ParticipantMappingManager$1(g),this._dataChannelMonitor=new DataChannelMonitor(f),this._senders=new Map,this._receiversManager=new DataChannelReceiversManager(this._participantMappingManager,this._dataChannelMonitor,m),this._processors=new Map,this._channelVersions=new Map,this._randomChannelIdManager=new RandomChannelIdManager,this._dataIds=new Map,S.dataChannel.dataIdConfigs.forEach((g=>{const m=this._dataIds.get(g.dataId)??[];m.push(g.raw?{dataId:g.dataId,raw:g.raw}:{dataId:g.dataId,raw:g.raw,bandwidth:g.bandwidth??0,priority:g.priority??"normal",category:g.category??"reliable"}),this._dataIds.set(g.dataId,m)})),this._rateLimiters=new Map,this._sendTrafficLimiter=new SendTrafficLimiter(S.dataChannel.maxSendBandwidth,S.dataChannel.maxBroadcastPacketRate),this._enableBroadcastLimitOnReliableChannel=S.dataChannel.enableBroadcastLimitOnReliableChannel}async initialize(){const createProcessor=async g=>{const m=new DataChannelProcessor(g,this._tsCall,this._logger);return m.on("message",(m=>{const f=m.message;g.raw?f.channelId=g.dataId+kg:this._sendTrafficLimiter.updateReceiveBytes(f.data.length);try{this._receiversManager.appendMessage(m)}catch(m){this._logger.error(`Failed to appendMessage on dataId ${g.dataId}: ${getErrorString(m)}`)}})),await m.initialize(),m},g=[],m=new Map,f=Array.from(this._dataIds.keys());for(let S=0;S<f.length;S++){const v=f[S],C=this._dataIds.get(v)[0];try{const g=await createProcessor(C);m.set(v,g)}catch(m){g.push(v),this._dataIds.delete(v)}}const S=R.flatten(Array.from(this._dataIds.values())).filter((g=>!g.raw));this._dataIdMappingManager=new DataIdMappingManager(S),this._state===Jg.Initializing?(this._processors=m,S.forEach((g=>{this._rateLimiters.has(g.dataId)||this._rateLimiters.set(g.dataId,new BitrateLimiter(g.bandwidth))})),g.length&&this._dataChannelTelemtryLogger.sendCreateProcessorEvent({kindOfEvent:"failure",dataIds:g}),this._state=Jg.Initialized,this._initializedDefer.resolve()):m.forEach((g=>{g.dispose()}))}createSender(g,m){let f=g.channelId,S=!1;if(f>=kg){if(!0!==this._dataIds.get(f-kg)?.[0].raw)throw invalidChannelId();S=!0}else{if(f<0||f>Lg)throw invalidChannelId();0===f&&(f=this._randomChannelIdManager.findAvailableChannelId())}this._senders.get(f)?.close();const v=nextChannelVersion(this._channelVersions.get(f)??-1);let C=f>=kg?f-kg:-1,_=!1;-1===C&&this._state===Jg.Initialized&&(C=this._dataIdMappingManager.allocate({channelId:f,reliability:g.reliability,priority:g.priority,bitrate:1e3*g.bitrateInKbps}),_=!0);const sendFunction=async m=>{const v=m.data.length;if(-1===C&&!_){if(v===Ug)return;await this._initializedDefer.promise,_||(C=this._dataIdMappingManager.allocate({channelId:f,reliability:g.reliability,priority:g.priority,bitrate:1e3*g.bitrateInKbps}),_=!0)}const E=0===m.recipients?.length&&!this._participantMappingManager.isP2P();if(-1!==C)if(this._enableBroadcastLimitOnReliableChannel&&E&&!S){if(!this._sendTrafficLimiter.canSend(v,E))throw trafficLimited();const g=this._processors.get(C);await(g?.send(m)),this._sendTrafficLimiter.updateSendBytes(v,E)}else{const g=this._processors.get(C);await(g?.send(m))}else{const S=this._dataIdMappingManager.getDataIdToSend(f,v,E);try{const f=!this._sendTrafficLimiter.canSend(v,E);if(f&&"High"!==g.priority)throw trafficLimited();if(0===S.length)throw noAvailableUnreliableDataId();for(let g=0;g<S.length;g++)try{const C=S[g],_=this._dataIds.get(C)[0];if(f&&"normal"===_.priority)continue;const T=this._rateLimiters.get(C);if(T?.canSend(v)??!0){const g=this._processors.get(C);return await(g?.send(m)),T?.update(v),void this._sendTrafficLimiter.updateSendBytes(v,E)}}catch(g){}throw trafficLimited()}catch(g){this._logger.error(`Failed to send channelId ${f} message: ${getErrorString(g)}`)}}},E=this._dataChannelMonitor.createSenderMonitor(f,v,m),T=new DataChannelSenderImpl(f,v,sendFunction,this._participantMappingManager,E,this._logger);return T.on("close",(()=>{_&&this._dataIdMappingManager.deallocate(f),this._randomChannelIdManager.removeChannelId(f),this._senders.delete(f),setTimeout((()=>T.dispose()),0)})),void 0!==g.participants&&T.setParticipants(g.participants),this._senders.set(f,T),this._randomChannelIdManager.addChannelId(f),this._channelVersions.set(f,v),T}on(g,m){"dataChannelReceiverCreated"===g&&this._receiversManager.on("dataChannelReceiverCreated",m)}off(g,m){"dataChannelReceiverCreated"===g&&this._receiversManager.off("dataChannelReceiverCreated",m)}dispose(){this._state!==Jg.Destroyed&&(this._state=Jg.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(dataChannelHasBeenDisposed()),this._senders.forEach((g=>{g.dispose()})),this._receiversManager.dispose(),this._processors.forEach((g=>{g.dispose()})),this._sendTrafficLimiter.dispose(),this._participantMappingManager.dispose())}}class DataChannelTelemetryLogger{constructor(g,m){this._tsCall=g,this._telemetryLogManager=m}sendStatsEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId},...g};this._telemetryLogManager.sendEvent({name:kh.acs_calling_datachannel_stats,tenant:so,properties:m})}sendCreateSenderEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createSender"},...g};this._telemetryLogManager.sendEvent({name:kh.acs_calling_datachannel,tenant:so,properties:m})}sendCreateProcessorEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,operation:"createProcessor"},...g};this._telemetryLogManager.sendEvent({name:kh.acs_calling_datachannel,tenant:so,properties:m})}}class DataChannelCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}createDataChannelSender(g){const m=generateGuid(),f=getAcsEcsConfig();try{if(void 0!==g.bitrateInKbps&&"number"!=typeof g.bitrateInKbps)throw wrongArgumentType("bitrateInKbps","number");if(void 0!==g.channelId&&"number"!=typeof g.channelId)throw wrongArgumentType("channelId","number");if(void 0!==g.participants&&!Array.isArray(g.participants))throw wrongArgumentType("participants","CommunicationIdentifier[]");if(void 0!==g.priority&&-1===["High","Normal"].indexOf(g.priority))throw wrongArgumentValue("priority","High,Normal");if(void 0!==g.reliability&&-1===["Durable","Lossy"].indexOf(g.reliability))throw wrongArgumentValue("reliability","Durable,Lossy");const S={bitrateInKbps:Math.ceil(g.bitrateInKbps??f.dataChannel.defaultBitrate/1e3),channelId:g.channelId??0,participants:g.participants??[],priority:g.priority??Hg,reliability:g.reliability??$g};this._logger.info(`createDataChannelSender: ${logSenderOptions(g)}`),this._sendFeatureUsage("createDataChannelSender",Lh.attempt),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"attempt",correlationId:m,senderOptions:{channelId:g.channelId,bitrateInKbps:g.bitrateInKbps,participantsSize:g.participants?.length,priority:g.priority,reliability:g.reliability}});const v=this._dataChannelManager.createSender(S,m);return this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"success",correlationId:m,senderOptions:{channelId:v.channelId,bitrateInKbps:S.bitrateInKbps,participantsSize:S.participants?.length,priority:S.priority,reliability:S.reliability}}),this._logger.info(`The sender is created. channel id=${v.channelId}`),this._sendFeatureUsage("createDataChannelSender",Lh.success),v}catch(g){const f=new CallingCommunicationError(z.FEATURES.DATA_CHANNEL.FAILED_TO_CREATE_SENDER,g);throw this._logger.info(`Failed to create the sender: ${f.message}`),this._sendFeatureUsage("createDataChannelSender",Lh.failure),this._dataChannelTelemetryLogger.sendCreateSenderEvent({kindOfEvent:"failure",correlationId:m,failureReason:f.message,additionalDetails:{...extractCommunicationServicesErrorForTelemetry(f)}}),f}}async createDataChannelAdapter(g){const m=new DataChannelAdapter(this._tsCall,g);return await m.initialize(),m}initialize(g,m){this._tsCall=g.tsCall,this._logger=m.createChild("DataChannelCallFeature"),this._telemetryLogManager=g.telemetryLogManager,this._dataChannelTelemetryLogger=new DataChannelTelemetryLogger(this._tsCall,this._telemetryLogManager);const f=new DataChannelManager(this._tsCall,this._logger,this._dataChannelTelemetryLogger);this._dataChannelManager=f,this._dataChannelManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Lh.initialize)})).catch((g=>{this._logger.error(`initialize:${getErrorString(g)}`)}))}get name(){return this._sendFeatureUsage("name",Lh.getter),"DataChannel"}dispose(){this.disposed||(this._dataChannelManager?.dispose(),super.dispose())}on(g,m){if("dataChannelReceiverCreated"!==g)throw invalidEventSubscription(g,"subscribe");this._sendFeatureUsage(g,Lh.subscribe),"dataChannelReceiverCreated"===g&&this._dataChannelManager?.on("dataChannelReceiverCreated",m)}off(g,m){if("dataChannelReceiverCreated"!==g)throw invalidEventSubscription(g,"unsubscribe");this._sendFeatureUsage(g,Lh.unsubscribe),"dataChannelReceiverCreated"===g&&this._dataChannelManager?.off("dataChannelReceiverCreated",m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"DataChannel",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class SpotlightCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new SpotlightCallImplOverTsCall(this.eventEmitter),this._isSpotlightFeatureEnabled=getAcsEcsConfig().calling.spotlight.enabled}get name(){return"Spotlight"}initialize(g,m){this._logger=m,this._logger.info(`Spotlight feature enable flag: ${this._isSpotlightFeatureEnabled}`),this._isSpotlightFeatureEnabled?(this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)):this._logger.warn("Calls to spotlight APIs will perform no action or return default values where applicable")}async startSpotlight(g){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(g)&&await this._impl.startSpotlight(g)}async stopSpotlight(g){this._isSpotlightFeatureEnabled&&this.validateIdentifierParam(g)&&await this._impl.stopSpotlight(g)}async stopAllSpotlight(){this._isSpotlightFeatureEnabled&&await this._impl.stopAllSpotlight()}getSpotlightedParticipants(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("getSpotlightedParticipants",Lh.getter),this._impl.spotlightedParticipants):[]}get maxParticipantsToSpotlight(){return this._isSpotlightFeatureEnabled?(this._sendFeatureUsage("maxSpotlightSupportedState",Lh.getter),this._impl.maxSpotlightStateSupported):0}on(g,m){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m))}off(g,m){this._isSpotlightFeatureEnabled&&(this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m))}validateIdentifierParam(g=[]){try{return g.forEach((g=>validateIdentifier(g))),!0}catch(g){return!1}}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class SpotlightCallImplOverTsCall{constructor(g){this.typeRankComparator=(g,m)=>void 0===g.publishedState?-1:void 0===m.publishedState?1:g.publishedState.typeRank-m.publishedState.typeRank,this._eventEmitter=g,this._currentSpotlightStates=new Map;const m=getAcsEcsConfig().calling.spotlight;this._maxSpotlightStateSupported=m.maxSpotlightParticipants,this._supportedUserRoles=m.supportedRoles,this._meetingTypes=m.meetingTypes}initialize(g,m,f,S){this._logger=S.createChild((()=>`SpotlightFeature::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=f,this._internalCallAgent=m;const v="initialize";this._sendFeatureUsage(v,Lh.initialize);try{let extractMRIs=g=>new Map(this.getPublishedState(g).sort(this.typeRankComparator).map(((g,m)=>[g.id,{spotlightStateId:g.publishedState?.stateId,index:m+1}])));this._tsCall.on("publishedStatesChanged",(async g=>{let m=extractMRIs(g),f=[];m.forEach(((g,m)=>{this._currentSpotlightStates.has(m)||f.push({identifier:constructIdentifierKindFromMri(m),order:g?.index})}));let S=[];this._currentSpotlightStates.forEach(((g,f)=>{m.has(f)||S.push({identifier:constructIdentifierKindFromMri(f)})})),this._currentSpotlightStates=m,(f.length||S.length)&&this._eventEmitter.emit("spotlightChanged",{added:f,removed:S})})),this._tsCall.publishedStates&&(this._currentSpotlightStates=extractMRIs(this._tsCall.publishedStates)),this._sendFeatureUsage(v,Lh.success)}catch(g){this.handleSpotlightFailure(v,g)}}async startSpotlight(g){const m="startSpotlight";try{this._sendFeatureUsage(m,Lh.attempt);let f=this.getIdentifiersMri(g).filter((g=>!this._currentSpotlightStates.has(g)));if(!f.length)throw new CallingCommunicationError(z.FEATURES.SPOTLIGHT.ALREADY_SPOTLIGHTED);this.validateStartSpotlightConditions(f);const S={level:"user",type:"spotlight",content:"{}",participantIds:f};if(!await this._tsCall.publishState(S,w.generateCauseId()))throw new CallingCommunicationError(z.FEATURES.SPOTLIGHT.START_SPOTLIGHT_FAILED);this._sendFeatureUsage(m,Lh.success)}catch(g){this.handleSpotlightFailure(m,g)}}async stopSpotlight(g){const m="stopSpotlight";this._tsCall.publishedStates||this._logger.warn(`${m}: no participants is currently Spotlighted`);try{this._sendFeatureUsage(m,Lh.attempt);let f=this.getIdentifiersMri(g);this.validateStopSpotlightConditions(f);const S=this.findStateIdsForParticipantIds(f);await this._tsCall.removeState({stateIds:S},w.generateCauseId()),this._sendFeatureUsage(m,Lh.success)}catch(g){this.handleSpotlightFailure(m,g)}}async stopAllSpotlight(){const g="stopAllSpotlight";try{this._sendFeatureUsage(g,Lh.attempt),this.validateStopSpotlightConditions([]),await this._tsCall.removeStatesForEveryone({type:"spotlight"},w.generateCauseId()),this._sendFeatureUsage(g,Lh.success)}catch(m){this.handleSpotlightFailure(g,m)}}get spotlightedParticipants(){return this._tsCall.publishedStates?Array.from(this._currentSpotlightStates.keys()).map((g=>({identifier:constructIdentifierKindFromMri(g),order:this._currentSpotlightStates.get(g)?.index}))):[]}get maxSpotlightStateSupported(){return this._maxSpotlightStateSupported}findStateIdsForParticipantIds(g){return g.length&&this._tsCall.publishedStates?g.map((g=>this._currentSpotlightStates.get(g)?.spotlightStateId||"")).filter((g=>g.length)):[]}getPublishedState(g){return g.typeStates.filter((g=>"spotlight"===g.type)).map((g=>g.participantStates)).flat()}isUserRoleEligible(){const g=this._tsCall.advancedMeetingRole;return!!g&&!!this._supportedUserRoles.find((m=>m===g))}isRoleBasedConversationType(){const g=this._tsCall.conversationType;return!!g&&!!this._meetingTypes.find((m=>m===g))}getIdentifiersMri(g){return g&&g?.length?g.map((g=>getMriFromIdentifier(g))):[this._internalCallAgent.getUserMri()]}validateStartSpotlightConditions(g){if(this.spotlightedParticipants.length+g.length>this._maxSpotlightStateSupported)throw new CallingCommunicationError(z.FEATURES.SPOTLIGHT.SPOTLIGHT_LIGHT_MAX_REACHED(this._maxSpotlightStateSupported));if(this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new CallingCommunicationError(z.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE("Start",this._tsCall.conversationType))}validateStopSpotlightConditions(g){if(!(1===g.length&&g[0]===this._internalCallAgent.getUserMri())&&this.isRoleBasedConversationType()&&!this.isUserRoleEligible())throw new CallingCommunicationError(z.FEATURES.SPOTLIGHT.UNSUPPORTED_ROLE_TYPE("Stop",this._tsCall.conversationType))}handleSpotlightFailure(g,m){throw this._logger.error(JSON.stringify(m)),this._sendFeatureUsage(g,Lh.failure,m),m}_sendFeatureUsage(g,m,f){let S=f?{code:f?.code||H,subCode:f?.subCode||0,failureReason:f?.message||"",...extractCommunicationServicesErrorForTelemetry(f)}:void 0;sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"Spotlight",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:S},this._telemetryLogManager,this._logger)}}class CallSurveyFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new CallSurveyFeatureImplOverTsCall}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}get name(){return"CallSurvey"}dispose(){super.dispose()}submitSurvey(g){return this._impl.submitSurvey(g)}}class CallSurveyFeatureImplOverTsCall{initialize(g,m,f,S,v){this._tsCall=g,this._telemetryLogManager=S,this._logger=v}async submitSurvey(g){const m=+new Date,f=generateGuid();this.sendEndOfCallEvent("attempt",f);const S=this.validateSurvey(g);if(S){const g=new CallingCommunicationError(z.FEATURES.CALL_SURVEY.INVALID_SURVEY(S));throw this.sendEndOfCallEvent("failure",f,m,{failureReason:S,code:M,...extractCommunicationServicesErrorForTelemetry(g),isExpected:!0}),g}return new Promise(((S,v)=>{const C=this.createCallSurveyInternal(g);this.registerNotificationEventListener(C,f,m,S,v),this.sendEndOfCallEvent("success",f,m,void 0,C)}))}registerNotificationEventListener(g,m,f,S,v){const C={id:m,callId:g.callId,localParticipantId:g.localParticipantId,overallRating:g.overallRating,audioRating:g.audioRating,videoRating:g.videoRating,screenshareRating:g.screenshareRating};CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER.eventsSent=g=>{g.find((g=>g.name===kh.acs_calling_survey&&g.data?.correlationId===m&&"success"===g.data?.kindOfEvent))&&S(C)},CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER.eventsDiscarded=(g,S)=>{if(g.find((g=>g.name===kh.acs_calling_survey&&g.data?.correlationId===m&&"success"===g.data?.kindOfEvent))){const g=new CallingCommunicationError(z.FEATURES.CALL_SURVEY.SUBMIT_TIMEOUT);this.sendEndOfCallEvent("failure",m,f,{failureReason:g.message,code:g.code,...extractCommunicationServicesErrorForTelemetry(g)}),v(g)}}}sendEndOfCallEvent(g,m,f,S,v){try{const C={eventName:kh.acs_calling_survey,callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId,correlationId:m,kindOfEvent:g,timestampInfo:{deltaTimeInMs:0},additionalDetails:S};if(f){const g=+new Date;C.timestampInfo.deltaTimeInMs=g-f}"success"===g&&v?(C.overallRating=v.overallRating,C.audioRating=v.audioRating,C.videoRating=v.videoRating,C.screenshareRating=v.screenshareRating,this._telemetryLogManager.sendEvent({name:kh.acs_calling_survey,tenant:so,priority:ni.Immediate,properties:C},CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER)):this._telemetryLogManager.sendEvent({name:C.eventName,tenant:so,properties:C})}catch(g){this._logger.debug("Unable to send call survey telemetry")}}createCallSurveyInternal(g){let m={callId:this._tsCall?.callId,localParticipantId:this._tsCall?.participantId};return g&&(m.overallRating=g.overallRating,m.audioRating=g.audioRating,m.videoRating=g.videoRating,m.screenshareRating=g.screenshareRating),m}validateSurvey(g){let m="";return m=this.validateOverallRating(g.overallRating),m+=this.validateAudioRating(g.audioRating),m+=this.validateVideoRating(g.videoRating),m+=this.validateScreenshareRating(g.screenshareRating),""!==m||g.overallRating||g.audioRating||g.videoRating||g.screenshareRating||(m="At least one survey rating is required."),""===m&&(m=this.validateCallSurveyTypes(g)),m.trim()}validateOverallRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("overallRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("overallRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE),m}validateAudioRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("audioRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("audioRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE),m}validateVideoRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("videoRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("videoRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE),m}validateScreenshareRating(g){if(!g)return"";let m="";return this.isValidFiveStarRating(g)?g.scale&&!this.isRatingValueMatchesRatingScale(g.score,g.scale)?m=this.ratingOutOfRangeMessage(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE,g):g.scale&&!this.isValidQualityThreshold(g.scale)?m=this.thresholdOutOfRangeMessage("screenshareRating.scale.lowScoreThreshold",g):g.scale&&!this.isValidRatingScale(g.scale)&&(m=this.ratingScaleOutOfRangeMessage("screenshareRating.scale",g)):m=this.defaultRatingScaleMessage(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE),m}validateCallSurveyTypes(g){let m="";return g.overallRating&&(m=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE,g.overallRating.score),g.overallRating.issues&&(this.isArray(g.overallRating.issues)?g.overallRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.OVERALL_ISSUES[g]!==g))&&(m+="overallRating.issues array should be of type OverallIssue. "):m+="overallRating.issues should be of type Array<OverallIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("overallRating.scale",g.overallRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("overallRating",g.overallRating)),g.audioRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE,g.audioRating.score),g.audioRating.issues&&(this.isArray(g.audioRating.issues)?g.audioRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.AUDIO_ISSUES[g]!==g))&&(m+="audioRating.issues array should be of type AudioIssue. "):m+="audioRating.issues should be of type Array<AudioIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("audioRating.scale",g.audioRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("audioRating",g.audioRating)),g.videoRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE,g.videoRating.score),g.videoRating.issues&&(this.isArray(g.videoRating.issues)?g.videoRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.VIDEO_ISSUES[g]!==g))&&(m+="videoRating.issues array should be of type VideoIssue. "):m+="videoRating.issues should be of type Array<VideoIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("videoRating.scale",g.videoRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("videoRating",g.videoRating)),g.screenshareRating&&(m+=this.valueShouldBeNumber(CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE,g.screenshareRating.score),g.screenshareRating.issues&&(this.isArray(g.screenshareRating.issues)?g.screenshareRating.issues.some((g=>CallSurveyFeatureImplOverTsCall.SCREENSHARE_ISSUES[g]!==g))&&(m+="screenshareRating.issues array should be of type ScreenshareIssue. "):m+="screenshareRating.issues should be of type Array<ScreenshareIssue>. "),m+=this.ratingScaleShouldNotHaveUnexpectedProperties("screenshareRating.scale",g.screenshareRating.scale),m+=this.ratingShouldNotHaveUnexpectedProperties("screenshareRating",g.screenshareRating)),m}isNumber(g){return null!==g&&"number"==typeof g}isArray(g){return null!==g&&Array.isArray(g)}isValidFiveStarRating(g){return null==g||void 0!==g.scale||g.score>=1&&g.score<=5}isRatingValueMatchesRatingScale(g,m){return g>=m.lowerBound&&g<=m.upperBound}isValidQualityThreshold(g){return g.lowScoreThreshold>=g.lowerBound&&g.lowScoreThreshold<=g.upperBound}isValidRatingScale(g){return g.lowerBound>=0&&g.upperBound<=100}valueShouldBeNumber(g,m){return this.isNumber(m)?"":`${g} should be of type number. `}ratingScaleShouldNotHaveUnexpectedProperties(g,m){let f="";if(!m)return f;for(let S in m)void 0===CallSurveyFeatureImplOverTsCall.RATING_SCALE_KEYS[S]&&(f+=`${g} should not have ${S}. `);return f}ratingShouldNotHaveUnexpectedProperties(g,m){let f="";if(!m)return f;for(let S in m)void 0===CallSurveyFeatureImplOverTsCall.CALL_RATING_KEYS[S]&&(f+=`${g} should not have ${S}. `);return f}defaultRatingScaleMessage(g){return`In default scale ${g} should be 1 to 5. `}ratingOutOfRangeMessage(g,m){return`${g}: ${m.score} should be between ${m.scale?.lowerBound} and ${m.scale?.upperBound}. `}thresholdOutOfRangeMessage(g,m){return`${g}: ${m.scale?.lowScoreThreshold} should be between ${m.scale?.lowerBound} and ${m.scale?.upperBound}. `}ratingScaleOutOfRangeMessage(g,m){return`${g} lowerBound: ${m.scale?.lowerBound} and upperBound: ${m.scale?.upperBound} should be between 0 and 100. `}}CallSurveyFeatureImplOverTsCall.OVERALL_RATING_SCORE="overallRating.score",CallSurveyFeatureImplOverTsCall.AUDIO_RATING_SCORE="audioRating.score",CallSurveyFeatureImplOverTsCall.VIDEO_RATING_SCORE="videoRating.score",CallSurveyFeatureImplOverTsCall.SCREEN_SHARE_RATING_SCORE="screenshareRating.score",CallSurveyFeatureImplOverTsCall.NOTIFICATION_LISTENER={},CallSurveyFeatureImplOverTsCall.OVERALL_ISSUES={CallCannotInvite:"CallCannotInvite",CallCannotJoin:"CallCannotJoin",CallEndedUnexpectedly:"CallEndedUnexpectedly",HadToRejoin:"HadToRejoin",OtherIssues:"OtherIssues"},CallSurveyFeatureImplOverTsCall.AUDIO_ISSUES={AudioInterruption:"AudioInterruption",AudioNoise:"AudioNoise",AudioStoppedUnexpectedly:"AudioStoppedUnexpectedly",DistortedSpeech:"DistortedSpeech",Echo:"Echo",LowVolume:"LowVolume",NoLocalAudio:"NoLocalAudio",NoRemoteAudio:"NoRemoteAudio",OtherIssues:"OtherIssues"},CallSurveyFeatureImplOverTsCall.VIDEO_ISSUES={AudioVideoOutOfSync:"AudioVideoOutOfSync",DarkVideoReceived:"DarkVideoReceived",Freezes:"Freezes",LowQuality:"LowQuality",NoVideoReceived:"NoVideoReceived",NoVideoSent:"NoVideoSent",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},CallSurveyFeatureImplOverTsCall.SCREENSHARE_ISSUES={CannotPresent:"CannotPresent",Freezes:"Freezes",LargeDelay:"LargeDelay",LowQuality:"LowQuality",NoContentLocal:"NoContentLocal",NoContentRemote:"NoContentRemote",OtherIssues:"OtherIssues",StoppedUnexpectedly:"StoppedUnexpectedly"},CallSurveyFeatureImplOverTsCall.CALL_RATING_KEYS={score:"score",issues:"issues",scale:"scale"},CallSurveyFeatureImplOverTsCall.RATING_SCALE_KEYS={lowerBound:"lowerBound",upperBound:"upperBound",lowScoreThreshold:"lowScoreThreshold"};class AudioZonesCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new AudioZonesImpl(this.eventEmitter,this.name)}get name(){return"AudioZones"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m)}updateAudioZone(g){return this._impl.updateAudioZone(g)}dispose(){this._impl.dispose(),super.dispose()}get meetingGroupDetails(){return this._impl.meetingGroupDetails}on(g,m){this.eventEmitter.on(g,m)}off(g,m){this.eventEmitter.off(g,m)}}class AudioZonesImpl{constructor(g,m){this._eventEmitter=g,this._featureName=m}initialize(g,m,f,S,v){this._logger=v.createChild((()=>`${this._featureName}::Call(id='${g.callId}')`)),this._tsCall=g,this._tsCall.changed((()=>{this._logger.log("tsCall changed"),this.updateMeetingGroupDetails()}))}updateAudioZone(g){const m="updateAudioZone_"+generateGuid();return this._logger.log(`updateAudioZone toGroup=${g}, causeId=${m}`),this._tsCall.updateMeetingGroups(m,{scope:4,toGroup:g})}dispose(){this._meetingGroupDetails=void 0}get meetingGroupDetails(){return this._meetingGroupDetails}updateMeetingGroupDetails(){const g=this._tsCall.meetingGroupDetails;R.isEqual(g,this._meetingGroupDetails)||(this._meetingGroupDetails=g,this._eventEmitter.emit("meetingGroupDetailsChanged"))}}class OptimalVideoCountCallFeatureImpl extends FirstPartyCallFeature{_sendOVCTelemetryEvent(g){if(!this._telemetryLogManager)return;const m={callId:this._call?.id||"",localParticipantId:this._tsCall?.participantId||"",featureName:"OptimalVideoCount",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{step:g}};this._telemetryLogManager.sendEvent({name:kh.acs_calling_feature_usage,tenant:so,properties:m})}get optimalVideoCount(){return this._sendOVCTelemetryEvent(Lh.getter),this._tsCall?.optimalVideoCount?this._tsCall.optimalVideoCount:1}constructor(g){super(g),this.name="OptimalVideoCount",this._impl=new OptimalVideoCountCallFeatureImplOverTsCall(this.name,this.eventEmitter,this.optimalVideoCount)}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m),this._tsCall=g.tsCall,this._telemetryLogManager=g.telemetryLogManager,this._call=g.call}on(g,m){if("optimalVideoCountChanged"!==g)throw new CallingCommunicationError(z.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_SUBSCRIBE(g));this._sendOVCTelemetryEvent(Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){if("optimalVideoCountChanged"!==g)throw new CallingCommunicationError(z.FEATURES.OPTIMAL_VIDEO_COUNT.EVENT_UNSUBSCRIBE(g));this._sendOVCTelemetryEvent(Lh.unsubscribe),this.eventEmitter.off(g,m)}}class OptimalVideoCountCallFeatureImplOverTsCall{constructor(g,m,f){this._featureName=g,this._eventEmitter=m,this._optimalVideoCount=f}initialize(g,m,f,S,v){this._tsCall=g,this._logger=v,this._logger?.createChild((()=>`${this._featureName}::Call(id='${this._tsCall?.callId}')`)),this._tsCall.changed((()=>this.ovcChanged(g)))}ovcChanged(g){g?.optimalVideoCount&&g.optimalVideoCount!==this._optimalVideoCount&&(this._logger.log(`tsCall optimalVideoCount changed from ${this._optimalVideoCount} to ${g?.optimalVideoCount}`),this._eventEmitter.emit("optimalVideoCountChanged"))}}class BrowserAudioEffectsHelper{constructor(g,m){this._effectsStatusManager=g,this._logger=m,this._currentActiveBrowserEffects={},this._updateCurrentActive()}async setBrowserAudioEffects(g,m,f){try{this._updateCurrentActive(m);const S={autoGainControl:void 0!==f.autoGainControl?f.autoGainControl:this._currentActiveBrowserEffects.autoGainControl,echoCancellation:void 0!==f.echoCancellation?f.echoCancellation:this._currentActiveBrowserEffects.echoCancellation,noiseSuppression:void 0!==f.noiseSuppression?f.noiseSuppression:this._currentActiveBrowserEffects.noiseSuppression},v=this._calculateFlags(S);this._logger.info(`Setting browser audio processing flags to ${v}`),await g.setAudioProcessingFlags(v)}catch(g){throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.AUDIO_FLAGS,g)}}_updateCurrentActive(g){const m=g??this._effectsStatusManager.getActiveEffects();this._currentActiveBrowserEffects={},"BrowserAutoGainControl"===m?.autoGainControl?.[0]&&(this._currentActiveBrowserEffects.autoGainControl=!0),"BrowserEchoCancellation"===m?.echoCancellation?.[0]&&(this._currentActiveBrowserEffects.echoCancellation=!0),"BrowserNoiseSuppression"===m?.noiseSuppression?.[0]&&(this._currentActiveBrowserEffects.noiseSuppression=!0)}_calculateFlags(g){let m=0;return g.autoGainControl&&(m+=1),g.echoCancellation&&(m+=2),g.noiseSuppression&&(m+=4),m}}class AudioEffectsFeatureImpl extends FirstPartyAudioStreamFeature{constructor(){super(...arguments),this._wasmVqeInitialized=!1,this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this._currentEffects={},this._previousTsWasmEffectType=0,this._currentTsWasmEffectType=0,this.effectStatusChangedCallback=(g,m,f)=>{"start"===f&&this.eventEmitter.emit("effectsStarted",m),"stop"===f&&this.eventEmitter.emit("effectsStopped",m)},this.configUpdatedCallback=async g=>{this._logger?.info("configUpdated callback, no-op.")},this.processingErrorCallback=async g=>{const m=generateGuid();this._logger?.info("processingError callback"),this.eventEmitter.emit("effectsError",g);const f=this.getEffectsNameForTelemetry(this.activeEffects),S=this.getUsageDetailsForTelemetry("Internal handle error",f);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.stopEffects,kindOfEvent:Lh.failure,additionalDetails:{failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g),usageDetails:S}}),await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})}}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this.updateAudioEffectsStatusManager()}get name(){return"AudioEffects"}get activeEffects(){return this._effectsStatusManager?.getActiveEffects?.()??this._activeEffects}on(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("effectsStarted"!==g&&"effectsStopped"!==g&&"effectsError"!==g)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}async isSupported(g){const m=generateGuid(),f=+new Date,S=this.getUsageDetailsForTelemetry("",this.getEffectsNameForTelemetry(g));this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,kindOfEvent:Lh.attempt,additionalDetails:{usageDetails:S}});try{if(this.disposed)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.START_DISPOSED);if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const S=this._internalDeviceManager.getEnvironmentInfoInternal();this._supportChecker||(this._supportChecker=new EffectsCapabilityChecker(this._logger,S));let v=!1;if("object"==typeof g){const m=this.getEffectInternalCast(g);v=await this._supportChecker.audioEffectsSupported(m),this._logger?.info(`Support check for ${m.name} resulted in: ${v}`)}else"string"==typeof g&&(v=await this._supportChecker.audioEffectsSupported(g),this._logger?.info(`Support check for ${g} resulted in: ${v}`));const C=this.getEffectsNameForTelemetry(g),_=this.getUsageDetailsForTelemetry("",C);return this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.success,additionalDetails:{usageDetails:_}}),v}catch(S){const v=new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SUPPORT_CHECK_FAILED,S);this._logger?.error(v.message);const C=this.getEffectsNameForTelemetry(g),_=this.getUsageDetailsForTelemetry("",C);throw this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.isSupported,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v),usageDetails:_}}),v}}async startEffects(g){const m=generateGuid(),f=+new Date,S=this.getUsageDetailsForTelemetry("",this.getEffectsNameForTelemetry(g));this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,kindOfEvent:Lh.attempt,additionalDetails:{usageDetails:S}});try{const S=getAcsEcsConfig();if(!S?.audioEffects?.enableAudioEffects)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.DISABLED);if(this.disposed)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.START_DISPOSED);if(!this.streamInstance.canStartEffects)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SOURCE_UNSUPPORTED);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const v=this._internalDeviceManager.getTsDeviceManager();if(!v)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.START_DEVICE_MANAGER);this.updateAudioEffectsStatusManager(),this.subscribeToStreamInstanceEvents(),this.disposeEffectEventSubscriptions(),this.subscribeToEffectEvents();let C=this.activeEffects;g?.autoGainControl&&(C=await this.startStopAutoGainControl(v,C,!0,g.autoGainControl)),g?.echoCancellation&&(C=await this.startStopEchoCancellation(v,C,!0,g.echoCancellation)),g?.noiseSuppression&&(C=await this.startStopNoiseSuppression(v,C,!0,g.noiseSuppression)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await v.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(C,"start");const _=this.getEffectsNameForTelemetry(C),E=this.getUsageDetailsForTelemetry("",_);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.success,additionalDetails:{usageDetails:E}})}catch(S){const v=new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.START_FAILED,S);this._logger?.error(v.message),this.eventEmitter.emit("effectsError",v);const C=this.getEffectsNameForTelemetry(g),_=this.getUsageDetailsForTelemetry("",C);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.startEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v),usageDetails:_}})}}async stopEffects(g){const m=generateGuid(),f=+new Date,S=this.getEffectsNameForTelemetry(g),v=this.getUsageDetailsForTelemetry("",S);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.stopEffects,kindOfEvent:Lh.attempt,additionalDetails:{usageDetails:v}});try{if(this.disposed)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.STOP_DISPOSED);this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager);const S=this._internalDeviceManager.getTsDeviceManager();if(!S)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.STOP_DEVICE_MANAGER);this.updateAudioEffectsStatusManager();let v=this.activeEffects;g?.autoGainControl&&(v=await this.startStopAutoGainControl(S,v,!1)),g?.echoCancellation&&(v=await this.startStopEchoCancellation(S,v,!1)),g?.noiseSuppression&&(v=await this.startStopNoiseSuppression(S,v,!1)),this._currentTsWasmEffectType!==this._previousTsWasmEffectType&&await S.setAudioEffectsAsync("",this._currentTsWasmEffectType),this._effectsStatusManager?.setActiveEffects(v,"stop");const C=this.getEffectsNameForTelemetry(v),_=this.getUsageDetailsForTelemetry("",C);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.success,additionalDetails:{usageDetails:_}})}catch(S){const v=new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.STOP_FAILED,S);this._logger?.error(v.message),this.eventEmitter.emit("effectsError",v);const C=this.getEffectsNameForTelemetry(g),_=this.getUsageDetailsForTelemetry("",C);this.sendFeatureUsageTelemetry({eventName:kh.acs_calling_media_stream,correlationId:m,operation:Su.stopEffects,timestampInfo:{deltaTimeInMs:+new Date-f},kindOfEvent:Lh.failure,additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v),usageDetails:_}})}}async dispose(){try{if(this.disposed)return void this._logger?.info("AudioEffects feature already disposed");await this.stopEffects({echoCancellation:!0,noiseSuppression:!0}),this._currentEffects={},this.eventEmitter.removeAllListeners(),this._effectsStatusManager?.off("statusChanged",this.effectStatusChangedCallback),this.disposed=!0,this._logger?.info("AudioEffects feature disposed")}catch(g){const m=new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.DISPOSE_FAILED,g);this._logger?.error(m.message),this.eventEmitter.emit("effectsError",m)}}updateAudioEffectsStatusManager(){this.streamInstance.canStartEffects?(this._internalDeviceManager||(this._internalDeviceManager=this.streamInstance.source.deviceManager),this._effectsStatusManager||(this._effectsStatusManager=this._internalDeviceManager.callStackAudioEffectsStatusManager,this._effectsStatusManager.on("statusChanged",this.effectStatusChangedCallback)),this._activeEffects=this._effectsStatusManager.getActiveEffects(),this._browserAudioEffectsManager=new BrowserAudioEffectsHelper(this._effectsStatusManager,this._logger)):this._logger?.warn("Cannot update status manager, current source is not supported.")}async initializeWasmVqeInStack(g){if(this._wasmVqeInitialized)return void this._logger?.info("WasmVqe initialized already");if(!this._internalDeviceManager)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.FAILED_TO_GET_DM);const m=await g._internalHandle.getEffectProvider();if(!m)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.PROVIDER_UNAVAILABLE);const f=await m.getAudioEffectProvider(),S=this.streamInstance.callStackWasmVqeProvider;if(!S)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.AEC_PROVIDER_MISSING);S.providerValue=f,this._wasmVqeInitialized=!0}getEffectInternalCast(g){if("EchoCancellation"===g?.name&&this.isValidEffectInstance(g))return g;if("NoiseSuppression"===g?.name&&this.isValidEffectInstance(g))return g;if("DeepNoiseSuppression"===g?.name&&this.isValidEffectInstance(g))return g;throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT)}isValidEffectInstance(g){let m;return("EchoCancellation"===g.name&&g._internalHandle||"NoiseSuppression"===g.name&&g._internalHandle||!("DeepNoiseSuppression"!==g.name||!g._internalHandle))&&(m=g,this.hasValidInternalHandle(m._internalHandle))}hasValidInternalHandle(g){return!!(g.getEffectProvider&&g.dispose&&g.setConfig&&g.handleProcessingError)}updateCurrentTsWasmAudioEffectType(g,m,f){const S=f??this._effectsStatusManager?.getActiveEffects();let v=!!S?.echoCancellation?.includes("EchoCancellation"),C=!!S?.noiseSuppression?.includes("NoiseSuppression"),_=!!S?.noiseSuppression?.includes("DeepNoiseSuppression");switch(g){case"EchoCancellation":v=m;break;case"NoiseSuppression":C=m;break;case"DeepNoiseSuppression":_=m}this._previousTsWasmEffectType=this._currentTsWasmEffectType,v&&C?this._currentTsWasmEffectType=8:v&&_?this._currentTsWasmEffectType=16:v?this._currentTsWasmEffectType=4:C?this._currentTsWasmEffectType=1:_&&(this._currentTsWasmEffectType=2)}subscribeToStreamInstanceEvents(){this.streamInstance.on("audioSourceChanged",(async g=>{g.source&&"Audio"!==g.source.mediaStreamType&&await this.stopEffects({echoCancellation:!0,noiseSuppression:!0})}))}subscribeToEffectEvents(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.on("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.on("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.on("processingError",this.processingErrorCallback))}disposeEffectEventSubscriptions(){"object"==typeof this._currentEffects.echoCancellation&&(this._currentEffects.echoCancellation?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.echoCancellation?._internalHandle.off("processingError",this.processingErrorCallback)),"object"==typeof this._currentEffects.noiseSuppression&&(this._currentEffects.noiseSuppression?._internalHandle.off("configUpdated",this.configUpdatedCallback),this._currentEffects.noiseSuppression?._internalHandle.off("processingError",this.processingErrorCallback))}setConfigForEffects(g){const m=g._internalHandle.configProvider.config.audioEffects,f=getMediaConfig(),S=getAcsEcsConfig();f?.wasmvqe?.enableVqe&&S?.audioEffects?.enableAudioEffects&&(m.enableAudioEffects=f?.wasmvqe?.enableVqe&&S.audioEffects.enableAudioEffects),g._internalHandle.setConfig(m),this._logger?.info(`Config for audio effects set: ${stringifyObject(m)}`)}async startStopAutoGainControl(g,m,f,S){try{if(f&&S){if(!await this.isSupported(S))throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT(JSON.stringify(S)));if("BrowserAutoGainControl"!==S)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_GAINCONTROL);return await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{autoGainControl:!0})),this._logger?.info("Browser auto gain control started"),this._currentEffects.autoGainControl=S,m.autoGainControl=[S],m}switch(m?.autoGainControl?.[0]??""){case"":case"BrowserAutoGainControl":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{autoGainControl:!1})),this._logger?.info("Browser auto gain control stopped")}return m.autoGainControl=[],this._currentEffects.autoGainControl=void 0,m}catch(g){throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SET_AUTO_GAIN_CONTROL(f),g)}}async startStopEchoCancellation(g,m,f,S){try{if(f&&S){if(!await this.isSupported(S))throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT(JSON.stringify(S)));if("string"==typeof S&&"BrowserEchoCancellation"===S)await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{echoCancellation:!0})),this._logger?.info("Browser echo cancellation started"),this._currentEffects.echoCancellation=S,m.echoCancellation=[S];else{if("object"!=typeof S)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_ECHO);this._currentEffects.echoCancellation=this.getEffectInternalCast(S),this.setConfigForEffects(this._currentEffects.echoCancellation),await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.echoCancellation.name,!0,m),m.echoCancellation=[this._currentEffects.echoCancellation.name]}return m}switch(m?.echoCancellation?.[0]??""){case"":case"BrowserEchoCancellation":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{echoCancellation:!1})),this._logger?.info("Browser echo cancellation stopped");break;case"EchoCancellation":await this.initializeWasmVqeInStack(this._currentEffects.echoCancellation),this.updateCurrentTsWasmAudioEffectType("EchoCancellation",!1,m)}return m.echoCancellation=[],this._currentEffects.echoCancellation=void 0,m}catch(g){throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SET_ECHO_CANCELLATION(f),g)}}async startStopNoiseSuppression(g,m,f,S){try{if(f&&S){if(!await this.isSupported(S))throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.UNSUPPORTED_EFFECT(JSON.stringify(S)));if("string"==typeof S&&"BrowserNoiseSuppression"===S)await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{noiseSuppression:!0})),this._logger?.info("Browser noise cancellation started"),m.noiseSuppression=[S],this._currentEffects.noiseSuppression=S;else{if("object"!=typeof S)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.INVALID_EFFECT_NOISE_SUPP);this._currentEffects.noiseSuppression=this.getEffectInternalCast(S),this.setConfigForEffects(this._currentEffects.noiseSuppression),await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType(this._currentEffects.noiseSuppression.name,!0,m),m.noiseSuppression=[this._currentEffects.noiseSuppression.name]}return m}switch(m?.noiseSuppression?.[0]??""){case"":case"BrowserNoiseSuppression":await(this._browserAudioEffectsManager?.setBrowserAudioEffects(g,m,{noiseSuppression:!1})),this._logger?.info("Browser noise suppression stopped");break;case"NoiseSuppression":await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("NoiseSuppression",!1,m);break;case"DeepNoiseSuppression":await this.initializeWasmVqeInStack(this._currentEffects.noiseSuppression),this.updateCurrentTsWasmAudioEffectType("DeepNoiseSuppression",!1,m)}return m.noiseSuppression=[],this._currentEffects.noiseSuppression=void 0,m}catch(g){throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.SET_NOISE_SUPPRESSION(f),g)}}sendFeatureUsageTelemetry(g){if(this._telemetryLogManager)try{const m={correlationId:g.correlationId,mediaType:mu.AudioRaw,streamType:fu.Local,operation:g.operation,timestampInfo:g.timestampInfo||{},kindOfEvent:g.kindOfEvent||"",additionalDetails:g.additionalDetails||""};this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:m})}catch(m){this._logger?.debug(`Unable to send ${g.operation} telemetry`)}else this._logger?.debug("Telemetry error. Instance is undefined.")}getEffectsNameForTelemetry(g){return g?stringifyObject(g):"UNKNOWN"}getUsageDetailsForTelemetry(g,m){return`${m?`[${m}] `:""}${g}`}}function invalidEventSubscription$1(g,m){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.EVENT_SUBSCIBE_UNSUBSCRIBE(m,g))}function unmixedAudioIsNotAvailable(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.UNAVAILABLE)}function getErrorString$1(g){return R.isString(g)?g:g?.message??"Unknown"}function rethrowError(g){throw g instanceof CallingCommunicationError?g:new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.UNKNOWN_ERROR)}function hasPendingOpertion(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.PENDING_OPERATION)}function notSupportP2P(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.UNSUPPORTED_OPERATION)}function unmixedAudioHasBeenEnabled(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.ENABLED)}function unmixedAudioHasBeenDisabled(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.DISABLED)}function unmixedAudioHasBeenDisposed(){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.DISPOSED)}function invalidState(g){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.INVALID_STATE(g))}function failedToInitialize(g){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.FAILED_TO_INITIALIZE,g)}function failedToEnable(g,m){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.FAILED_TO_ENABLE(m.audioContextState,m.unmixedAudioState),g)}function failedToDisable(g,m){return new CallingCommunicationError(z.FEATURES.UNMIXED_AUDIO.FAILED_TO_DISABLE(m.audioContextState,m.unmixedAudioState),g)}class ParticipantMappingManager$2{constructor(g){this._tsCall=g,this._sourceIdMapping=new Map,this._participantIdMapping=new Map,this._listenerHandles=[],this._listenerHandles.push(this._tsCall.on("participantAdded",(g=>{this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantUpdated",(g=>{this._updateMapping(g)}))),this._listenerHandles.push(this._tsCall.on("participantRemoved",(g=>{this._removeMapping(g)}))),this._tsCall.participants.forEach((g=>{this._updateMapping(g)}))}_updateMapping(g){g.endpoints?.endpointDetails?.forEach((m=>{const f=m.mediaStreams?.find((g=>"audio"===g.type));if(f){const S={sourceId:f.sourceId,participantId:m.participantId,mri:g.id};this._sourceIdMapping.set(f.sourceId,S),this._participantIdMapping.set(m.participantId,S)}}))}_removeMapping(g){g.endpoints?.endpointDetails?.forEach((g=>{const m=g.mediaStreams?.find((g=>"audio"===g.type));m&&(this._sourceIdMapping.delete(m.sourceId),this._participantIdMapping.delete(g.participantId))}))}findParticipantInfoBySourceId(g){return this._sourceIdMapping.get(g)}findParticipantInfoByParticipantId(g){return this._participantIdMapping.get(g)}dispose(){this._sourceIdMapping.clear(),this._participantIdMapping.clear(),this._listenerHandles.forEach((g=>g.dispose()))}}class UnmixedAudioTelemetryLogger{constructor(g,m){this._tsCall=g,this._telemetryLogManager=m}sendActionEvent(g){const m={...{callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId},...g};this._telemetryLogManager.sendEvent({name:kh.acs_calling_unmixed_audio,tenant:so,properties:m})}}class UnmixedAudioActionTelemetryLogger{constructor(g,m){this._unmixedAudioTelemetryLogger=g,this._action=m,this._correlationId=generateGuid()}logAttempt(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"attempt",correlationId:this._correlationId})}logSuccess(){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"success",correlationId:this._correlationId})}logFailure(g,m){this._unmixedAudioTelemetryLogger.sendActionEvent({action:this._action,kindOfEvent:"failure",correlationId:this._correlationId,failureReason:g.message,...m,additionalDetails:{...extractCommunicationServicesErrorForTelemetry(g)}})}}class StatePromise{constructor(g,m){this._waitTimeoutInMs=g,this._expectedState=m,this._result=defer(),this._wait=wait((()=>this._result.promise),this._waitTimeoutInMs)}updateState(g){this._result.isPending()&&(g===this._expectedState?this._result.resolve():this._result.reject(new Error(`Unexpected active state: ${g}`)))}get waitState(){return this._expectedState}async wait(){await this._wait}cancel(){this._result.isPending()&&this._result.reject(new Error("Operation cancelled"))}}class UnmixedAudioContext{constructor(g,m){this._logger=g.createChild(`AudioContext:${m}`);const f=new AudioContext,stateChangeHandler=()=>{this._logger.info(`The AudioContext:${m} state changed to ${f.state}`),"closed"===f.state&&f.removeEventListener("statechange",stateChangeHandler)};f.addEventListener("statechange",stateChangeHandler),this._audioContext=f}async resume(g=0){if("closed"===this._audioContext.state)throw invalidState(this._audioContext.state);if("running"===this._audioContext.state)return;const m=new StatePromise(g,!0);return this._audioContext.resume().then((()=>{m.updateState(!0),this._logger.info("resumed")})).catch((g=>{this._logger.info(`Failed to resume: ${getErrorString$1(g)}`),m.updateState(!1)})),m.wait()}async close(){"closed"!==this._audioContext.state&&await this._audioContext.close().then((()=>{this._logger.info("closed")})).catch((g=>{this._logger.info(`Failed to close: ${getErrorString$1(g)}`)}))}get state(){return this._audioContext.state}get value(){return this._audioContext}}function getStateString(g){switch(g){case Yg.Uninitialized:return"Uninitialized";case Yg.Initializing:return"Initializing";case Yg.Initialized:return"Initialized";case Yg.Destroyed:return"Destroyed";case Yg.Aborted:return"Aborted"}}!function(g){g[g.Uninitialized=0]="Uninitialized",g[g.Initializing=1]="Initializing",g[g.Initialized=2]="Initialized",g[g.Destroyed=3]="Destroyed",g[g.Aborted=4]="Aborted"}(Yg||(Yg={}));class UnmixedAudioManager{constructor(g,m,f,S){this._state=Yg.Uninitialized,this._listenerHandles=[],this._audioContextSeq=0,this._activeStatePromises=new Set,this._lastestSpatialAudioRequest="none",this._pendingOperation=!1,this._initializedDefer=defer();try{this._tsCall=g,this._logger=m.createChild("UnmixedAudioManager"),this._eventEmitter=new CallingEventEmitter(this._logger,{enableLogEmit:!1}),this._unmixedAudioTelemetryLogger=f,this._participantManager=new ParticipantMappingManager$2(g),this._destinationStreamInfoMap=new Map,this._destinationStreamInfoList=new Array(S.maxStreamSize),this._sourceStreamInfoList=new Array(S.maxStreamSize),this._maxStreamSize=S.maxStreamSize,this._operationTimeoutInMs=S.operationTimeoutInMs,this._skipProviderStateCheck=S.skipProviderStateCheck}catch(g){throw this._state=Yg.Aborted,m.info(`Failed to create UnmixedAudioManager: ${getErrorString$1(g)}`),failedToInitialize(g)}}async initialize(){if(this._state!==Yg.Uninitialized)throw invalidState(getStateString(this._state));this._initializedDefer.isPending()||(this._initializedDefer=defer());const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"initialize");this._state=Yg.Initializing;try{if(g.logAttempt(),!this._tsCall.getUnmixedAudioProvider)throw unmixedAudioIsNotAvailable();if(this._tsUnmixedAudioProvider=this._tsUnmixedAudioProvider??await this._tsCall.getUnmixedAudioProvider(),!this._tsUnmixedAudioProvider)throw unmixedAudioIsNotAvailable();this._audioContext=this._audioContext??new UnmixedAudioContext(this._logger,this._audioContextSeq++),0===this._listenerHandles.length&&(this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onStreamSourcesUpdated",(g=>{this._state===Yg.Initialized&&this._onStreamSourcesUpdatedHandler(g)}))),this._listenerHandles.push(this._tsUnmixedAudioProvider.on("onActiveStateChanged",(()=>{if(this._state!==Yg.Initialized)return;const g=this._tsUnmixedAudioProvider?.active??!1;this._logger.info(`activeStateChanged to ${g}`),this._activeStatePromises.forEach((m=>{m.updateState(g)})),this._activeStatePromises.clear()})))),g.logSuccess(),this._logger.info(`Initialized with maxStreamSize ${this._maxStreamSize}. The AudioContext state is ${this._getAudioContextState()}.`),this._state=Yg.Initialized,this._initializedDefer.resolve()}catch(m){this._state=Yg.Uninitialized;const f=getErrorString$1(m);this._logger.info(`Failed to initialize: ${f}`);const S=failedToInitialize(m);g.logFailure(S),this._initializedDefer.reject(S)}return this._initializedDefer.promise}async enableUnmixedAudio(){const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"enable");try{if(![Yg.Uninitialized,Yg.Initializing,Yg.Initialized].includes(this._state))throw invalidState(getStateString(this._state));if(1===this._tsCall.callType)throw notSupportP2P();if(this._pendingOperation)throw hasPendingOpertion();if("enable"===this._lastestSpatialAudioRequest&&!this._skipProviderStateCheck&&"active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState())throw unmixedAudioHasBeenEnabled();let m;this._pendingOperation=!0,g.logAttempt(),this._state===Yg.Uninitialized?await this.initialize():this._state===Yg.Initializing&&await this._initializedDefer.promise,void 0!==this._audioContext&&"closed"!==this._getAudioContextState()||(this._cleaupAudioNodes(),this._audioContext=new UnmixedAudioContext(this._logger,this._audioContextSeq++)),"active"!==this._getUnmixedAudioProviderState()&&(m=new StatePromise(this._operationTimeoutInMs,!0),this._activeStatePromises.add(m));const f=[["resume AudioContext","running"===this._getAudioContextState()?void 0:this._audioContext.resume(this._operationTimeoutInMs)],["enable spatial audio config",this._enableSpatialAudio(!0)],["wait for the unmixed audio active state to change to true",m?.wait()]];await this._runTasks(f),this._pendingOperation=!1,g.logSuccess(),this._logger.info(`UnmixedAudio is enabled. The AudioContext state is ${this._getAudioContextState()}.`)}catch(m){const f=this._getAudioContextState(),S=this._getUnmixedAudioProviderState(),v=getErrorString$1(m);this._logger.info(`Failed to enable unmixed audio: ${v}. AudioContext=${f}, UnmixedAudio=${S}`);const C={audioContextState:f,unmixedAudioState:S},_=failedToEnable(m,C);!1===this._pendingOperation&&rethrowError(_),g.logFailure(_,C),this._pendingOperation=!1,rethrowError(_)}}async disableUnmixedAudio(){const g=new UnmixedAudioActionTelemetryLogger(this._unmixedAudioTelemetryLogger,"disable");try{if(![Yg.Initializing,Yg.Initialized].includes(this._state))throw invalidState(getStateString(this._state));if(1===this._tsCall.callType)throw notSupportP2P();if(this._pendingOperation)throw hasPendingOpertion();if("disable"===this._lastestSpatialAudioRequest&&"active"!==this._getUnmixedAudioProviderState())throw unmixedAudioHasBeenDisabled();let m;this._pendingOperation=!0,g.logAttempt(),this._state===Yg.Initializing&&await this._initializedDefer.promise,"inactive"!==this._getUnmixedAudioProviderState()&&(m=new StatePromise(this._operationTimeoutInMs,!1),this._activeStatePromises.add(m));const f=[["disable spatial audio config",this._enableSpatialAudio(!1)],["wait for the unmixed audio active state to change to false",m?.wait()]];await this._runTasks(f),this._pendingOperation=!1,g.logSuccess(),this._logger.info("UnmixedAudio is disabled")}catch(m){const f=this._getAudioContextState(),S=this._getUnmixedAudioProviderState(),v=getErrorString$1(m);this._logger.info(`Failed to disable unmixed audio: ${v}. AudioContext=${f}, UnmixedAudio=${S}`);const C={audioContextState:f,unmixedAudioState:S},_=failedToDisable(m,C);!1===this._pendingOperation&&rethrowError(_),g.logFailure(_,C),this._pendingOperation=!1,rethrowError(_)}}get isUnmixedAudioActive(){return this._state===Yg.Initialized&&("active"===this._getUnmixedAudioProviderState()&&"running"===this._getAudioContextState())}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}dispose(){this._state!==Yg.Destroyed&&(this._state=Yg.Destroyed,this._initializedDefer.isPending()&&this._initializedDefer.reject(unmixedAudioHasBeenDisposed()),this._listenerHandles.forEach((g=>g.dispose())),this._cleaupAudioNodes(),this._participantManager.dispose(),this._audioContext?.close(),this._activeStatePromises.forEach((g=>{g.cancel()})),this._activeStatePromises.clear(),this._eventEmitter.removeAllListeners())}_getAudioContextState(){return this._audioContext?.state??"unavailable"}_getUnmixedAudioProviderState(){return this._tsUnmixedAudioProvider?this._tsUnmixedAudioProvider.active?"active":"inactive":"unavailable"}_cleaupAudioNodes(){this._sourceStreamInfoList.forEach(((g,m)=>{const f=this._destinationStreamInfoList[m];void 0!==g&&void 0!==f&&g.audioNode.disconnect(f.audioNode),this._sourceStreamInfoList[m]=void 0,this._destinationStreamInfoList[m]=void 0})),this._destinationStreamInfoMap.clear()}_onStreamSourcesUpdatedHandler(g){const m=this._audioContext?.value;if(void 0===m||"running"!==m.state)return;const f=[];for(let S=0;S<this._maxStreamSize;S++){const v=S<g.length?g[S]:0,C=v?this._participantManager.findParticipantInfoBySourceId(v):void 0;let _=this._destinationStreamInfoList[S],E=this._sourceStreamInfoList[S];if(void 0===C)void 0!==_&&void 0!==E&&(E.audioNode.disconnect(_.audioNode),this._destinationStreamInfoList[S]=void 0);else{const g=this._tsUnmixedAudioProvider?.streams[S]??void 0;if(void 0!==E&&E.mediaStream!==g&&(void 0!==_&&E.audioNode.disconnect(_.audioNode),E=void 0,this._sourceStreamInfoList[S]=void 0),!g)continue;let v=!1;void 0!==E&&void 0!==_&&C.participantId!==_.participantId&&(E.audioNode.disconnect(_.audioNode),_=void 0,this._destinationStreamInfoList[S]=void 0),void 0===_&&(_=this._destinationStreamInfoMap.get(C.participantId),void 0===_&&(_={participantId:C.participantId,identifier:constructIdentifierKindFromMri(C.mri),audioNode:m.createMediaStreamDestination()},this._destinationStreamInfoMap.set(C.participantId,_)),this._destinationStreamInfoList[S]=_,v=!0),void 0===E&&(E={mediaStream:g,audioNode:m.createMediaStreamSource(g)},this._sourceStreamInfoList[S]=E,v=!0),v&&E.audioNode.connect(_.audioNode),f.push({id:C.sourceId,stream:_.audioNode.stream,participantId:C.participantId,identifier:_.identifier})}}this._eventEmitter.emit("participantSpeaking",{speakers:f})}async _enableSpatialAudio(g){await this._tsCall.setAudioMidcallConfigJson({enableSpatialAudio:g}),this._lastestSpatialAudioRequest=g?"enable":"disable"}async _runTasks(g){let m;if((await Promise.allSettled(g.map((g=>g[1])))).forEach(((f,S)=>{"rejected"===f.status&&(this._logger.info(`Failed to ${g[S][0]}: ${getErrorString$1(f.reason)}}`),m=f)})),void 0!==m)throw m.reason}}class UnmixedAudioCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g)}initialize(g,m){const f=getAcsEcsConfig().unmixedAudio;this._tsCall=g.tsCall,this._logger=m.createChild("UnmixedAudioCallFeature"),this._telemetryLogManager=g.telemetryLogManager;const S=new UnmixedAudioTelemetryLogger(this._tsCall,this._telemetryLogManager);this._unmixedAudioManager=new UnmixedAudioManager(this._tsCall,this._logger,S,f),this._unmixedAudioManager.initialize().then((()=>{this._sendFeatureUsage("initialize",Lh.initialize)})).catch((g=>{}))}get name(){return this._sendFeatureUsage("name",Lh.getter),"UnmixedAudio"}dispose(){this.disposed||(this._unmixedAudioManager.dispose(),super.dispose())}enableUnmixedAudio(){return this._unmixedAudioManager.enableUnmixedAudio()}disableUnmixedAudio(){return this._unmixedAudioManager.disableUnmixedAudio()}get isUnmixedAudioActive(){return this._unmixedAudioManager.isUnmixedAudioActive}on(g,m){if("participantSpeaking"!==g)throw invalidEventSubscription$1(g,"subscribe");this._sendFeatureUsage(g,Lh.subscribe),this._unmixedAudioManager.on(g,m)}off(g,m){if("participantSpeaking"!==g)throw invalidEventSubscription$1(g,"unsubscribe");this._sendFeatureUsage(g,Lh.unsubscribe),this._unmixedAudioManager.off(g,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"UnmixedAudio",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}}class TeamsMeetingAudioConferencingCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new TeamsMeetingConferencingCallFeatureImplOverTsCall}get name(){return"TeamsMeetingAudioConferencing"}initialize(g,m){this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}async getTeamsMeetingAudioConferencingDetails(){return this._impl.getTeamsMeetingAudioConferencingDetails()}dispose(){this.disposed||super.dispose()}}class TeamsMeetingConferencingCallFeatureImplOverTsCall{constructor(){this._isEnabled=getAcsEcsConfig().calling.teamsMeetingAudioConferencing.enabled,this._supportedConversationTypes=getAcsEcsConfig().calling.teamsMeetingAudioConferencing.supportedConversationTypes}initialize(g,m,f,S){this._logger=S.createChild((()=>`teamsMeetingAudioConferencing::Call(id='${g.callId}')`)),this._tsCall=g,this._telemetryLogManager=f,this._internalCallAgent=m;const v="initialize";if(this.sendFeatureUsage(v,Lh.initialize),!this.isSupportedConversationType()){const g=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS);throw this._logger.error(g.message),this.sendFeatureUsage(v,Lh.failure,g),g}this.sendFeatureUsage(v,Lh.success)}getTeamsMeetingAudioConferencingDetails(){const g="getTeamsMeetingAudioConferencingDetails";if(this.sendFeatureUsage(g,Lh.attempt),!this._isEnabled){const m=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DISABLED);return this._logger.error(m.message),this.sendFeatureUsage(g,Lh.failure,m),Promise.reject(m)}if(!this.isSupportedConversationType()){const m=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.ONLY_AVAILABLE_IN_MEETINGS);return this._logger.error(m.message),this.sendFeatureUsage(g,Lh.failure,m),Promise.reject(m)}let m;if(3!==this._tsCall.state)return m=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNAVAILABLE_BEFORE_JOINING),10===this._tsCall.state&&(m=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.UNVAILABLE_IN_LOBBY)),this.sendFeatureUsage(g,Lh.failure,m),this._logger.error(m.message),Promise.reject(m);let f={phoneNumbers:[],phoneConferenceId:""};try{const m=this._tsCall?.meetingDetails?.pstnDetails?.acpMcuInfo?.settings;if(!m)throw new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.DETAILS_NOT_CONFIGURED);{let g={tollPhoneNumber:m.tollNumber&&constructIdentifierKindFromMri(Uo+m.tollNumber),tollFreePhoneNumber:m.tollFreeNumber&&constructIdentifierKindFromMri(Uo+m.tollFreeNumber)};f={phoneNumbers:[g],phoneConferenceId:m.participantPasscode||""},this._logger.info("Teams meeting audio conferencing details was retrieved successfully")}return this.sendFeatureUsage(g,Lh.success),Promise.resolve(f)}catch(m){const f=new CallingCommunicationError(z.FEATURES.TEAMS_MEETING_AUDIO_CONFERENCING.GET_DETAILS_FAILED,m);throw this.sendFeatureUsage(g,Lh.failure,f),f}}isSupportedConversationType(){const g=this._tsCall.conversationType;let m=this._supportedConversationTypes.find((m=>m===g));return this._logger.info(`TeamsMeetingAudioConferencingDetails::ConversationType = \n            ${g}. ConversationType is supported = ${m}`),m}sendFeatureUsage(g,m,f){let S=f?{code:f?.code||H,subCode:f?.subCode||0,failureReason:f?.message||"",...extractCommunicationServicesErrorForTelemetry(f)}:void 0;sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"TeamsMeetingAudioConferencing",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:S},this._telemetryLogManager,this._logger)}}var Qg=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.TraceLevel=void 0,function(g){g[g.Error=10]="Error",g[g.Warning=15]="Warning",g[g.Info=50]="Info"}(m.TraceLevel||(m.TraceLevel={}))})),Xg=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.MessageTrackingOption=m.ConnectionState=m.ServiceGeneratedClientIdName=m.SystemCommandsStateName=m.ConfigurationName=m.SystemSessionStateName=m.StateSubscriptionsName=void 0,m.StateSubscriptionsName="ConfigStateSubscriptions",m.SystemSessionStateName="systemSessionState",m.ConfigurationName="config",m.SystemCommandsStateName="systemCommands",m.ServiceGeneratedClientIdName="serviceGeneratedClientId",function(g){g[g.Disconnected=0]="Disconnected",g[g.Connected=1]="Connected",g[g.Connecting=2]="Connecting"}(m.ConnectionState||(m.ConnectionState={})),function(g){g[g.All=0]="All",g[g.Last=1]="Last",g[g.None=2]="None"}(m.MessageTrackingOption||(m.MessageTrackingOption={}))})),Zg=function bind(g,m){return function wrap(){for(var f=new Array(arguments.length),S=0;S<f.length;S++)f[S]=arguments[S];return g.apply(m,f)}},ep=Object.prototype.toString;function isArray$3(g){return"[object Array]"===ep.call(g)}function isUndefined$2(g){return void 0===g}function isBuffer(g){return null!==g&&!isUndefined$2(g)&&null!==g.constructor&&!isUndefined$2(g.constructor)&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}function isArrayBuffer(g){return"[object ArrayBuffer]"===ep.call(g)}function isFormData(g){return"undefined"!=typeof FormData&&g instanceof FormData}function isArrayBufferView(g){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(g):g&&g.buffer&&g.buffer instanceof ArrayBuffer}function isString$2(g){return"string"==typeof g}function isNumber$2(g){return"number"==typeof g}function isObject$1(g){return null!==g&&"object"==typeof g}function isPlainObject(g){if("[object Object]"!==ep.call(g))return!1;var m=Object.getPrototypeOf(g);return null===m||m===Object.prototype}function isDate$1(g){return"[object Date]"===ep.call(g)}function isFile(g){return"[object File]"===ep.call(g)}function isBlob(g){return"[object Blob]"===ep.call(g)}function isFunction$2(g){return"[object Function]"===ep.call(g)}function isStream(g){return isObject$1(g)&&isFunction$2(g.pipe)}function isURLSearchParams(g){return"undefined"!=typeof URLSearchParams&&g instanceof URLSearchParams}function trim(g){return g.trim?g.trim():g.replace(/^\s+|\s+$/g,"")}function isStandardBrowserEnv(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach(g,m){if(null!=g)if("object"!=typeof g&&(g=[g]),isArray$3(g))for(var f=0,S=g.length;f<S;f++)m.call(null,g[f],f,g);else for(var v in g)Object.prototype.hasOwnProperty.call(g,v)&&m.call(null,g[v],v,g)}function merge(){var g={};function assignValue(m,f){isPlainObject(g[f])&&isPlainObject(m)?g[f]=merge(g[f],m):isPlainObject(m)?g[f]=merge({},m):isArray$3(m)?g[f]=m.slice():g[f]=m}for(var m=0,f=arguments.length;m<f;m++)forEach(arguments[m],assignValue);return g}function extend$1(g,m,f){return forEach(m,(function assignValue(m,S){g[S]=f&&"function"==typeof m?Zg(m,f):m})),g}function stripBOM(g){return 65279===g.charCodeAt(0)&&(g=g.slice(1)),g}var tp={isArray:isArray$3,isArrayBuffer:isArrayBuffer,isBuffer:isBuffer,isFormData:isFormData,isArrayBufferView:isArrayBufferView,isString:isString$2,isNumber:isNumber$2,isObject:isObject$1,isPlainObject:isPlainObject,isUndefined:isUndefined$2,isDate:isDate$1,isFile:isFile,isBlob:isBlob,isFunction:isFunction$2,isStream:isStream,isURLSearchParams:isURLSearchParams,isStandardBrowserEnv:isStandardBrowserEnv,forEach:forEach,merge:merge,extend:extend$1,trim:trim,stripBOM:stripBOM};function encode(g){return encodeURIComponent(g).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var ip=function buildURL(g,m,f){if(!m)return g;var S;if(f)S=f(m);else if(tp.isURLSearchParams(m))S=m.toString();else{var v=[];tp.forEach(m,(function serialize(g,m){null!=g&&(tp.isArray(g)?m+="[]":g=[g],tp.forEach(g,(function parseValue(g){tp.isDate(g)?g=g.toISOString():tp.isObject(g)&&(g=JSON.stringify(g)),v.push(encode(m)+"="+encode(g))})))})),S=v.join("&")}if(S){var C=g.indexOf("#");-1!==C&&(g=g.slice(0,C)),g+=(-1===g.indexOf("?")?"?":"&")+S}return g};function InterceptorManager(){this.handlers=[]}InterceptorManager.prototype.use=function use(g,m,f){return this.handlers.push({fulfilled:g,rejected:m,synchronous:!!f&&f.synchronous,runWhen:f?f.runWhen:null}),this.handlers.length-1},InterceptorManager.prototype.eject=function eject(g){this.handlers[g]&&(this.handlers[g]=null)},InterceptorManager.prototype.forEach=function forEach(g){tp.forEach(this.handlers,(function forEachHandler(m){null!==m&&g(m)}))};var np=InterceptorManager,rp=function normalizeHeaderName(g,m){tp.forEach(g,(function processHeader(f,S){S!==m&&S.toUpperCase()===m.toUpperCase()&&(g[m]=f,delete g[S])}))},sp=function enhanceError(g,m,f,S,v){return g.config=m,f&&(g.code=f),g.request=S,g.response=v,g.isAxiosError=!0,g.toJSON=function toJSON(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},g},ap=function createError(g,m,f,S,v){var C=new Error(g);return sp(C,m,f,S,v)},op=function settle(g,m,f){var S=f.config.validateStatus;f.status&&S&&!S(f.status)?m(ap("Request failed with status code "+f.status,f.config,null,f.request,f)):g(f)},lp=tp.isStandardBrowserEnv()?function standardBrowserEnv(){return{write:function write(g,m,f,S,v,C){var _=[];_.push(g+"="+encodeURIComponent(m)),tp.isNumber(f)&&_.push("expires="+new Date(f).toGMTString()),tp.isString(S)&&_.push("path="+S),tp.isString(v)&&_.push("domain="+v),!0===C&&_.push("secure"),document.cookie=_.join("; ")},read:function read(g){var m=document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)"));return m?decodeURIComponent(m[3]):null},remove:function remove(g){this.write(g,"",Date.now()-864e5)}}}():{write:function write(){},read:function read(){return null},remove:function remove(){}},cp=function isAbsoluteURL(g){return/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(g)},dp=function combineURLs(g,m){return m?g.replace(/\/+$/,"")+"/"+m.replace(/^\/+/,""):g},hp=function buildFullPath(g,m){return g&&!cp(m)?dp(g,m):m},up=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],gp=function parseHeaders(g){var m,f,S,v={};return g?(tp.forEach(g.split("\n"),(function parser(g){if(S=g.indexOf(":"),m=tp.trim(g.substr(0,S)).toLowerCase(),f=tp.trim(g.substr(S+1)),m){if(v[m]&&up.indexOf(m)>=0)return;v[m]="set-cookie"===m?(v[m]?v[m]:[]).concat([f]):v[m]?v[m]+", "+f:f}})),v):v},pp=tp.isStandardBrowserEnv()?function standardBrowserEnv(){var g,m=/(msie|trident)/i.test(navigator.userAgent),f=document.createElement("a");function resolveURL(g){var S=g;return m&&(f.setAttribute("href",S),S=f.href),f.setAttribute("href",S),{href:f.href,protocol:f.protocol?f.protocol.replace(/:$/,""):"",host:f.host,search:f.search?f.search.replace(/^\?/,""):"",hash:f.hash?f.hash.replace(/^#/,""):"",hostname:f.hostname,port:f.port,pathname:"/"===f.pathname.charAt(0)?f.pathname:"/"+f.pathname}}return g=resolveURL(window.location.href),function isURLSameOrigin(m){var f=tp.isString(m)?resolveURL(m):m;return f.protocol===g.protocol&&f.host===g.host}}():function isURLSameOrigin(){return!0},mp=function xhrAdapter(g){return new Promise((function dispatchXhrRequest(m,f){var S=g.data,v=g.headers,C=g.responseType;tp.isFormData(S)&&delete v["Content-Type"];var _=new XMLHttpRequest;if(g.auth){var E=g.auth.username||"",T=g.auth.password?unescape(encodeURIComponent(g.auth.password)):"";v.Authorization="Basic "+btoa(E+":"+T)}var I=hp(g.baseURL,g.url);function onloadend(){if(_){var S="getAllResponseHeaders"in _?gp(_.getAllResponseHeaders()):null,v={data:C&&"text"!==C&&"json"!==C?_.response:_.responseText,status:_.status,statusText:_.statusText,headers:S,config:g,request:_};op(m,f,v),_=null}}if(_.open(g.method.toUpperCase(),ip(I,g.params,g.paramsSerializer),!0),_.timeout=g.timeout,"onloadend"in _?_.onloadend=onloadend:_.onreadystatechange=function handleLoad(){_&&4===_.readyState&&(0!==_.status||_.responseURL&&0===_.responseURL.indexOf("file:"))&&setTimeout(onloadend)},_.onabort=function handleAbort(){_&&(f(ap("Request aborted",g,"ECONNABORTED",_)),_=null)},_.onerror=function handleError(){f(ap("Network Error",g,null,_)),_=null},_.ontimeout=function handleTimeout(){var m="timeout of "+g.timeout+"ms exceeded";g.timeoutErrorMessage&&(m=g.timeoutErrorMessage),f(ap(m,g,g.transitional&&g.transitional.clarifyTimeoutError?"ETIMEDOUT":"ECONNABORTED",_)),_=null},tp.isStandardBrowserEnv()){var b=(g.withCredentials||pp(I))&&g.xsrfCookieName?lp.read(g.xsrfCookieName):void 0;b&&(v[g.xsrfHeaderName]=b)}"setRequestHeader"in _&&tp.forEach(v,(function setRequestHeader(g,m){void 0===S&&"content-type"===m.toLowerCase()?delete v[m]:_.setRequestHeader(m,g)})),tp.isUndefined(g.withCredentials)||(_.withCredentials=!!g.withCredentials),C&&"json"!==C&&(_.responseType=g.responseType),"function"==typeof g.onDownloadProgress&&_.addEventListener("progress",g.onDownloadProgress),"function"==typeof g.onUploadProgress&&_.upload&&_.upload.addEventListener("progress",g.onUploadProgress),g.cancelToken&&g.cancelToken.promise.then((function onCanceled(g){_&&(_.abort(),f(g),_=null)})),S||(S=null),_.send(S)}))},fp={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset(g,m){!tp.isUndefined(g)&&tp.isUndefined(g["Content-Type"])&&(g["Content-Type"]=m)}function getDefaultAdapter(){var g;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(g=mp),g}function stringifySafely(g,m,f){if(tp.isString(g))try{return(m||JSON.parse)(g),tp.trim(g)}catch(g){if("SyntaxError"!==g.name)throw g}return(f||JSON.stringify)(g)}var Sp={transitional:{silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},adapter:getDefaultAdapter(),transformRequest:[function transformRequest(g,m){return rp(m,"Accept"),rp(m,"Content-Type"),tp.isFormData(g)||tp.isArrayBuffer(g)||tp.isBuffer(g)||tp.isStream(g)||tp.isFile(g)||tp.isBlob(g)?g:tp.isArrayBufferView(g)?g.buffer:tp.isURLSearchParams(g)?(setContentTypeIfUnset(m,"application/x-www-form-urlencoded;charset=utf-8"),g.toString()):tp.isObject(g)||m&&"application/json"===m["Content-Type"]?(setContentTypeIfUnset(m,"application/json"),stringifySafely(g)):g}],transformResponse:[function transformResponse(g){var m=this.transitional,f=m&&m.silentJSONParsing,S=m&&m.forcedJSONParsing,v=!f&&"json"===this.responseType;if(v||S&&tp.isString(g)&&g.length)try{return JSON.parse(g)}catch(g){if(v){if("SyntaxError"===g.name)throw sp(g,this,"E_JSON_PARSE");throw g}}return g}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function validateStatus(g){return g>=200&&g<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};tp.forEach(["delete","get","head"],(function forEachMethodNoData(g){Sp.headers[g]={}})),tp.forEach(["post","put","patch"],(function forEachMethodWithData(g){Sp.headers[g]=tp.merge(fp)}));var vp=Sp,yp=function transformData(g,m,f){var S=this||vp;return tp.forEach(f,(function transform(f){g=f.call(S,g,m)})),g},Cp=function isCancel(g){return!(!g||!g.__CANCEL__)};function throwIfCancellationRequested(g){g.cancelToken&&g.cancelToken.throwIfRequested()}var _p=function dispatchRequest(g){return throwIfCancellationRequested(g),g.headers=g.headers||{},g.data=yp.call(g,g.data,g.headers,g.transformRequest),g.headers=tp.merge(g.headers.common||{},g.headers[g.method]||{},g.headers),tp.forEach(["delete","get","head","post","put","patch","common"],(function cleanHeaderConfig(m){delete g.headers[m]})),(g.adapter||vp.adapter)(g).then((function onAdapterResolution(m){return throwIfCancellationRequested(g),m.data=yp.call(g,m.data,m.headers,g.transformResponse),m}),(function onAdapterRejection(m){return Cp(m)||(throwIfCancellationRequested(g),m&&m.response&&(m.response.data=yp.call(g,m.response.data,m.response.headers,g.transformResponse))),Promise.reject(m)}))},Ep=function mergeConfig(g,m){m=m||{};var f={},S=["url","method","data"],v=["headers","auth","proxy","params"],C=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],_=["validateStatus"];function getMergedValue(g,m){return tp.isPlainObject(g)&&tp.isPlainObject(m)?tp.merge(g,m):tp.isPlainObject(m)?tp.merge({},m):tp.isArray(m)?m.slice():m}function mergeDeepProperties(S){tp.isUndefined(m[S])?tp.isUndefined(g[S])||(f[S]=getMergedValue(void 0,g[S])):f[S]=getMergedValue(g[S],m[S])}tp.forEach(S,(function valueFromConfig2(g){tp.isUndefined(m[g])||(f[g]=getMergedValue(void 0,m[g]))})),tp.forEach(v,mergeDeepProperties),tp.forEach(C,(function defaultToConfig2(S){tp.isUndefined(m[S])?tp.isUndefined(g[S])||(f[S]=getMergedValue(void 0,g[S])):f[S]=getMergedValue(void 0,m[S])})),tp.forEach(_,(function merge(S){S in m?f[S]=getMergedValue(g[S],m[S]):S in g&&(f[S]=getMergedValue(void 0,g[S]))}));var E=S.concat(v).concat(C).concat(_),T=Object.keys(g).concat(Object.keys(m)).filter((function filterAxiosKeys(g){return-1===E.indexOf(g)}));return tp.forEach(T,mergeDeepProperties),f},Tp={name:"axios",version:"0.21.4",description:"Promise based HTTP client for the browser and node.js",main:"index.js",scripts:{test:"grunt test",start:"node ./sandbox/server.js",build:"NODE_ENV=production grunt build",preversion:"npm test",version:"npm run build && grunt version && git add -A dist && git add CHANGELOG.md bower.json package.json",postversion:"git push && git push --tags",examples:"node ./examples/server.js",coveralls:"cat coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js",fix:"eslint --fix lib/**/*.js"},repository:{type:"git",url:"https://github.com/axios/axios.git"},keywords:["xhr","http","ajax","promise","node"],author:"Matt Zabriskie",license:"MIT",bugs:{url:"https://github.com/axios/axios/issues"},homepage:"https://axios-http.com",devDependencies:{coveralls:"^3.0.0","es6-promise":"^4.2.4",grunt:"^1.3.0","grunt-banner":"^0.6.0","grunt-cli":"^1.2.0","grunt-contrib-clean":"^1.1.0","grunt-contrib-watch":"^1.0.0","grunt-eslint":"^23.0.0","grunt-karma":"^4.0.0","grunt-mocha-test":"^0.13.3","grunt-ts":"^6.0.0-beta.19","grunt-webpack":"^4.0.2","istanbul-instrumenter-loader":"^1.0.0","jasmine-core":"^2.4.1",karma:"^6.3.2","karma-chrome-launcher":"^3.1.0","karma-firefox-launcher":"^2.1.0","karma-jasmine":"^1.1.1","karma-jasmine-ajax":"^0.1.13","karma-safari-launcher":"^1.0.0","karma-sauce-launcher":"^4.3.6","karma-sinon":"^1.0.5","karma-sourcemap-loader":"^0.3.8","karma-webpack":"^4.0.2","load-grunt-tasks":"^3.5.2",minimist:"^1.2.0",mocha:"^8.2.1",sinon:"^4.5.0","terser-webpack-plugin":"^4.2.3",typescript:"^4.0.5","url-search-params":"^0.10.0",webpack:"^4.44.2","webpack-dev-server":"^3.11.0"},browser:{"./lib/adapters/http.js":"./lib/adapters/xhr.js"},jsdelivr:"dist/axios.min.js",unpkg:"dist/axios.min.js",typings:"./index.d.ts",dependencies:{"follow-redirects":"^1.14.0"},bundlesize:[{path:"./dist/axios.min.js",threshold:"5kB"}],_resolved:"https://skype.pkgs.visualstudio.com/_packaging/tps/npm/registry/axios/-/axios-0.21.4.tgz",_integrity:"sha1-xnuQ3AVo5cHPKwuFjEO6KOLtpXU=",_from:"axios@0.21.4"},Ip={};["object","boolean","number","function","string","symbol"].forEach((function(g,m){Ip[g]=function validator(f){return typeof f===g||"a"+(m<1?"n ":" ")+g}}));var bp={},Ap=Tp.version.split(".");function isOlderVersion(g,m){for(var f=m?m.split("."):Ap,S=g.split("."),v=0;v<3;v++){if(f[v]>S[v])return!0;if(f[v]<S[v])return!1}return!1}function assertOptions(g,m,f){if("object"!=typeof g)throw new TypeError("options must be an object");for(var S=Object.keys(g),v=S.length;v-- >0;){var C=S[v],_=m[C];if(_){var E=g[C],T=void 0===E||_(E,C,g);if(!0!==T)throw new TypeError("option "+C+" must be "+T)}else if(!0!==f)throw Error("Unknown option "+C)}}Ip.transitional=function transitional(g,m,f){var S=m&&isOlderVersion(m);function formatMessage(g,m){return"[Axios v"+Tp.version+"] Transitional option '"+g+"'"+m+(f?". "+f:"")}return function(f,v,C){if(!1===g)throw new Error(formatMessage(v," has been removed in "+m));return S&&!bp[v]&&(bp[v]=!0,console.warn(formatMessage(v," has been deprecated since v"+m+" and will be removed in the near future"))),!g||g(f,v,C)}};var Pp={isOlderVersion:isOlderVersion,assertOptions:assertOptions,validators:Ip},Rp=Pp.validators;function Axios(g){this.defaults=g,this.interceptors={request:new np,response:new np}}Axios.prototype.request=function request(g){"string"==typeof g?(g=arguments[1]||{}).url=arguments[0]:g=g||{},(g=Ep(this.defaults,g)).method?g.method=g.method.toLowerCase():this.defaults.method?g.method=this.defaults.method.toLowerCase():g.method="get";var m=g.transitional;void 0!==m&&Pp.assertOptions(m,{silentJSONParsing:Rp.transitional(Rp.boolean,"1.0.0"),forcedJSONParsing:Rp.transitional(Rp.boolean,"1.0.0"),clarifyTimeoutError:Rp.transitional(Rp.boolean,"1.0.0")},!1);var f=[],S=!0;this.interceptors.request.forEach((function unshiftRequestInterceptors(m){"function"==typeof m.runWhen&&!1===m.runWhen(g)||(S=S&&m.synchronous,f.unshift(m.fulfilled,m.rejected))}));var v,C=[];if(this.interceptors.response.forEach((function pushResponseInterceptors(g){C.push(g.fulfilled,g.rejected)})),!S){var _=[_p,void 0];for(Array.prototype.unshift.apply(_,f),_=_.concat(C),v=Promise.resolve(g);_.length;)v=v.then(_.shift(),_.shift());return v}for(var E=g;f.length;){var T=f.shift(),I=f.shift();try{E=T(E)}catch(g){I(g);break}}try{v=_p(E)}catch(g){return Promise.reject(g)}for(;C.length;)v=v.then(C.shift(),C.shift());return v},Axios.prototype.getUri=function getUri(g){return g=Ep(this.defaults,g),ip(g.url,g.params,g.paramsSerializer).replace(/^\?/,"")},tp.forEach(["delete","get","head","options"],(function forEachMethodNoData(g){Axios.prototype[g]=function(m,f){return this.request(Ep(f||{},{method:g,url:m,data:(f||{}).data}))}})),tp.forEach(["post","put","patch"],(function forEachMethodWithData(g){Axios.prototype[g]=function(m,f,S){return this.request(Ep(S||{},{method:g,url:m,data:f}))}}));var wp=Axios;function Cancel(g){this.message=g}Cancel.prototype.toString=function toString(){return"Cancel"+(this.message?": "+this.message:"")},Cancel.prototype.__CANCEL__=!0;var Mp=Cancel;function CancelToken(g){if("function"!=typeof g)throw new TypeError("executor must be a function.");var m;this.promise=new Promise((function promiseExecutor(g){m=g}));var f=this;g((function cancel(g){f.reason||(f.reason=new Mp(g),m(f.reason))}))}CancelToken.prototype.throwIfRequested=function throwIfRequested(){if(this.reason)throw this.reason},CancelToken.source=function source(){var g;return{token:new CancelToken((function executor(m){g=m})),cancel:g}};var Dp=CancelToken,Op=function spread(g){return function wrap(m){return g.apply(null,m)}},Np=function isAxiosError(g){return"object"==typeof g&&!0===g.isAxiosError};function createInstance(g){var m=new wp(g),f=Zg(wp.prototype.request,m);return tp.extend(f,wp.prototype,m),tp.extend(f,m),f}var kp=createInstance(vp);kp.Axios=wp,kp.create=function create(g){return createInstance(Ep(kp.defaults,g))},kp.Cancel=Mp,kp.CancelToken=Dp,kp.isCancel=Cp,kp.all=function all(g){return Promise.all(g)},kp.spread=Op,kp.isAxiosError=Np;var Lp=kp,Fp=kp;Lp.default=Fp;for(var xp=Lp,Up=createCommonjsModule((function(g){var m="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(m){var f=new Uint8Array(16);g.exports=function whatwgRNG(){return m(f),f}}else{var S=new Array(16);g.exports=function mathRNG(){for(var g,m=0;m<16;m++)0==(3&m)&&(g=4294967296*Math.random()),S[m]=g>>>((3&m)<<3)&255;return S}}})),Vp=[],Bp=0;Bp<256;++Bp)Vp[Bp]=(Bp+256).toString(16).substr(1);function bytesToUuid(g,m){var f=m||0,S=Vp;return[S[g[f++]],S[g[f++]],S[g[f++]],S[g[f++]],"-",S[g[f++]],S[g[f++]],"-",S[g[f++]],S[g[f++]],"-",S[g[f++]],S[g[f++]],"-",S[g[f++]],S[g[f++]],S[g[f++]],S[g[f++]],S[g[f++]],S[g[f++]]].join("")}var Hp,$p,Gp=bytesToUuid,jp=0,Wp=0;function v1(g,m,f){var S=m&&f||0,v=m||[],C=(g=g||{}).node||Hp,_=void 0!==g.clockseq?g.clockseq:$p;if(null==C||null==_){var E=Up();null==C&&(C=Hp=[1|E[0],E[1],E[2],E[3],E[4],E[5]]),null==_&&(_=$p=16383&(E[6]<<8|E[7]))}var T=void 0!==g.msecs?g.msecs:(new Date).getTime(),I=void 0!==g.nsecs?g.nsecs:Wp+1,b=T-jp+(I-Wp)/1e4;if(b<0&&void 0===g.clockseq&&(_=_+1&16383),(b<0||T>jp)&&void 0===g.nsecs&&(I=0),I>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");jp=T,Wp=I,$p=_;var A=(1e4*(268435455&(T+=122192928e5))+I)%4294967296;v[S++]=A>>>24&255,v[S++]=A>>>16&255,v[S++]=A>>>8&255,v[S++]=255&A;var P=T/4294967296*1e4&268435455;v[S++]=P>>>8&255,v[S++]=255&P,v[S++]=P>>>24&15|16,v[S++]=P>>>16&255,v[S++]=_>>>8|128,v[S++]=255&_;for(var R=0;R<6;++R)v[S+R]=C[R];return m||Gp(v)}var qp=v1;function v4(g,m,f){var S=m&&f||0;"string"==typeof g&&(m="binary"===g?new Array(16):null,g=null);var v=(g=g||{}).random||(g.rng||Up)();if(v[6]=15&v[6]|64,v[8]=63&v[8]|128,m)for(var C=0;C<16;++C)m[S+C]=v[C];return m||Gp(v)}var zp=v4,Kp=zp;Kp.v1=qp,Kp.v4=zp;var Jp=Kp,Yp=createCommonjsModule((function(g,m){var f=C&&C.__assign||function(){return f=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},f.apply(this,arguments)};function errorToString(g,m){if(void 0===m&&(m=!0),null==g)return"";if("string"==typeof g)return g;try{return JSON.stringify(g,circularReplacer(buildErrorJsonReplacer(m)))}catch(g){return"Stringifying error failed"}}Object.defineProperty(m,"__esModule",{value:!0}),m.errorToString=void 0,m.errorToString=errorToString;var buildErrorJsonReplacer=function(g){return void 0===g&&(g=!1),function(m,S){return S instanceof Error?f({name:S.name,message:S.message,stack:g?[]:("string"==typeof S.stack?S.stack:"").split("\n").map((function(g){return g.trim()})).filter((function(g){return!!g}))},S):S}},circularReplacer=function(g){var m=new WeakSet;return function(f,S){if("object"==typeof S&&null!==S){if(m.has(S))return;m.add(S)}return g(f,S)}}})),Qp=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.EvictingQueue=void 0;var f=function(){function EvictingQueue(g){this.maxSize=g,this._store=[]}return Object.defineProperty(EvictingQueue.prototype,"store",{get:function(){return this._store},enumerable:!1,configurable:!0}),Object.defineProperty(EvictingQueue.prototype,"size",{get:function(){return this._store.length},enumerable:!1,configurable:!0}),EvictingQueue.prototype.enqueue=function(g){this._store.length>=this.maxSize&&this._store.shift(),this._store.push(g)},EvictingQueue.prototype.dequeue=function(){return this._store.shift()},EvictingQueue.prototype.clear=function(){this._store=[]},EvictingQueue.prototype.forEach=function(g){this._store.forEach(g)},EvictingQueue}();m.EvictingQueue=f})),Xp=createCommonjsModule((function(g,m){var f=C&&C.__awaiter||function(g,m,f,S){function adopt(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function fulfilled(g){try{step(S.next(g))}catch(g){v(g)}}function rejected(g){try{step(S.throw(g))}catch(g){v(g)}}function step(g){g.done?f(g.value):adopt(g.value).then(fulfilled,rejected)}step((S=S.apply(g,m||[])).next())}))},S=C&&C.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function verb(g){return function(m){return step([g,m])}}function step(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=_.trys,(v=v.length>0&&v[v.length-1])||6!==C[0]&&2!==C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}};Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleSyncCell=void 0;var v=function(){function SimpleSyncCell(g,m,f,S,v){this.m_id=g,this.m_sender=m,this.m_shouldEmitEventForAllMessages=f,this.aggregation=v,this.m_events=new bu.EventEmitter,this.m_emitUnacknowledgedEventFor=null!=S?S:Xg.MessageTrackingOption.None}return SimpleSyncCell.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleSyncCell.prototype.off=function(g,m){return this.m_events.off(g,m),this},SimpleSyncCell.prototype.removeAllListeners=function(g){return this.m_events.removeAllListeners(g),this},SimpleSyncCell.prototype.id=function(){return this.m_id},SimpleSyncCell.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},SimpleSyncCell.prototype.getAsync=function(){return f(this,void 0,void 0,(function(){return S(this,(function(g){return[2,this.m_value]}))}))},SimpleSyncCell.prototype.setAsync=function(g){return f(this,void 0,void 0,(function(){var m;return S(this,(function(f){return this.m_value=g,m={messageId:Jp.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"set",value:JSON.stringify(this.m_value)},this.m_sender.sendStateMessage(m),[2]}))}))},SimpleSyncCell.prototype.delete=function(){this.m_value=void 0;var g={messageId:Jp.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"cell",operation:"delete",value:""};this.m_sender.sendStateMessage(g)},SimpleSyncCell.prototype.handleStateMessage=function(g){switch(g.operation){case"set":return void((JSON.stringify(this.m_value)!==g.value||this.m_shouldEmitEventForAllMessages)&&(this.m_value=JSON.parse(g.value),this.m_events.emit("valueChanged",this.m_value,g)));case"delete":return this.m_value=void 0,void this.m_events.emit("valueDeleted",this.m_value,g);default:return}},SimpleSyncCell.prototype.handleUnacknowledgedMessage=function(g){this.m_events.emit("valueUnacknowledged",g)},SimpleSyncCell.prototype.beginAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.beginAggregatedStateUpdating()},SimpleSyncCell.prototype.endAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.endAggregatedStateUpdating()},SimpleSyncCell}();m.SimpleSyncCell=v})),Zp=createCommonjsModule((function(g,m){function isPrefixDeleteMessage(g){return"delete"===g.operation&&"prefix"===g.value}Object.defineProperty(m,"__esModule",{value:!0}),m.isPrefixDeleteMessage=void 0,m.isPrefixDeleteMessage=isPrefixDeleteMessage})),em=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleSyncMap=void 0;var f=function(){function SimpleSyncMap(g,m,f,S,v){this.m_id=g,this.m_sender=m,this.m_shouldEmitEventForAllMessages=f,this.aggregation=v,this.m_events=new bu.EventEmitter,this.m_map=new Map,this.m_emitUnacknowledgedEventFor=null!=S?S:Xg.MessageTrackingOption.None}return SimpleSyncMap.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleSyncMap.prototype.off=function(g,m){return this.m_events.off(g,m),this},SimpleSyncMap.prototype.removeAllListeners=function(g){return this.m_events.removeAllListeners(g),this},SimpleSyncMap.prototype.id=function(){return this.m_id},SimpleSyncMap.prototype.messageTrackingOption=function(){return this.m_emitUnacknowledgedEventFor},SimpleSyncMap.prototype.get=function(g){return this.m_map.get(g)},SimpleSyncMap.prototype.set=function(g,m){this.m_map.set(g,m);var f={messageId:Jp.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"set",property:g,value:JSON.stringify(m)};this.m_sender.sendStateMessage(f)},SimpleSyncMap.prototype.delete=function(g){var m={messageId:Jp.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:g,value:""};this.performLocalDelete(m),this.m_sender.sendStateMessage(m)},SimpleSyncMap.prototype.deleteWithPrefix=function(g){var m={messageId:Jp.v4(),senderId:this.m_sender.senderId(),objectId:this.m_id,type:"map",operation:"delete",property:g,value:"prefix"};this.performLocalDelete(m),this.m_sender.sendStateMessage(m)},SimpleSyncMap.prototype.forEach=function(g){this.m_map.forEach(g)},SimpleSyncMap.prototype.handleStateMessage=function(g){switch(g.operation){case"set":return void this.handleSet(g);case"delete":return void this.handleDelete(g);default:return}},SimpleSyncMap.prototype.handleSet=function(g){if(!g.property)throw new Error("property is missing for a map.");(JSON.stringify(this.m_map.get(g.property))!==g.value||this.m_shouldEmitEventForAllMessages)&&(this.m_map.set(g.property,JSON.parse(g.value)),this.m_events.emit("valueChanged",g.property,g))},SimpleSyncMap.prototype.handleDelete=function(g){this.performLocalDelete(g),Zp.isPrefixDeleteMessage(g)?this.m_events.emit("valuesDeletedWithPrefix",g.property,g):this.m_events.emit("valueDeleted",g.property||"",g)},SimpleSyncMap.prototype.handleUnacknowledgedMessage=function(g){this.m_events.emit("valueUnacknowledged",g)},SimpleSyncMap.prototype.beginAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.beginAggregatedStateUpdating()},SimpleSyncMap.prototype.endAggregatedStateUpdating=function(){var g;null===(g=this.aggregation)||void 0===g||g.endAggregatedStateUpdating()},SimpleSyncMap.prototype.performLocalDelete=function(g){var m=this;if(g.property){var f=g.property;Zp.isPrefixDeleteMessage(g)?this.m_map.forEach((function(g,S){S.startsWith(f)&&m.m_map.delete(S)})):this.m_map.delete(g.property)}else this.m_map.clear()},SimpleSyncMap}();m.SimpleSyncMap=f})),tm=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleServicePerformanceTelemetry=m.SimpleServiceTelemetry=void 0;var f=function(){function SimpleServiceTelemetry(g,m,f){this.backendService="SimpleService",this.clientId=g,this.sessionId=m,this.wsReconnectCount=0,this.wsState=Xg.ConnectionState[Xg.ConnectionState.Disconnected],this.maxRoundtripRaw=f||0,this.roundtripTelemetry=new S,this.messageHandleTelemetry=new S,this.offlineCacheTelemetry={cachedCount:0,resentCount:0,expiredCount:0,rejectedCount:0},this.maxRoundtripRaw>0&&(this.roundtripRaw=[]),this.messagePendingAckCount=0,this.unacknowledgedMessagesCount=0,this.messageRequested={},this.messageReceived={},this.messageAcknowledged={}}return SimpleServiceTelemetry.prototype.addRoundtripLatency=function(g){this.roundtripRaw&&this.roundtripRaw.length<this.maxRoundtripRaw&&this.roundtripRaw.push(g),this.roundtripTelemetry.addLatency(g)},SimpleServiceTelemetry.prototype.addMessageHandleLatency=function(g){this.messageHandleTelemetry.addLatency(g)},SimpleServiceTelemetry.prototype.incrementAcknowledgedCount=function(g){this.incrementMessageCount(this.messageAcknowledged,g)},SimpleServiceTelemetry.prototype.incrementRequestedCount=function(g){this.incrementMessageCount(this.messageRequested,g)},SimpleServiceTelemetry.prototype.incrementReceivedCount=function(g){this.incrementMessageCount(this.messageReceived,g)},SimpleServiceTelemetry.prototype.incrementMessageCount=function(g,m){var f=g[m],S=void 0===f?1:f+1;g[m]=S},SimpleServiceTelemetry}();m.SimpleServiceTelemetry=f;var S=function(){function SimpleServicePerformanceTelemetry(){this.count=0,this.minValue=0,this.maxValue=0,this.avgValue=0}return SimpleServicePerformanceTelemetry.prototype.addLatency=function(g){this.count+=1,this.avgValue=this.avgValue+(g-this.avgValue)/this.count,this.minValue=this.count>1?Math.min(g,this.minValue):g,this.maxValue=Math.max(this.maxValue,g)},SimpleServicePerformanceTelemetry}();m.SimpleServicePerformanceTelemetry=S})),im=createCommonjsModule((function(g,m){var f=C&&C.__awaiter||function(g,m,f,S){function adopt(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function fulfilled(g){try{step(S.next(g))}catch(g){v(g)}}function rejected(g){try{step(S.throw(g))}catch(g){v(g)}}function step(g){g.done?f(g.value):adopt(g.value).then(fulfilled,rejected)}step((S=S.apply(g,m||[])).next())}))},S=C&&C.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function verb(g){return function(m){return step([g,m])}}function step(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=_.trys,(v=v.length>0&&v[v.length-1])||6!==C[0]&&2!==C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}};Object.defineProperty(m,"__esModule",{value:!0}),m.StateServiceWebSocketConnection=void 0;var v=function(){function StateServiceWebSocketConnection(g,m){var v=this;this.onopen=null,this.onclose=null,this.onerror=null,this.onmessage=null,this.onlog=null,this.ws=new WebSocket(g),this.settings=m,this.ws.onopen=function(g){return f(v,void 0,void 0,(function(){return S(this,(function(m){switch(m.label){case 0:return this.onopen&&this.onopen(g),[4,this.sendSetupMessages()];case 1:return m.sent(),[2]}}))}))},this.ws.onclose=function(g){v.onclose&&v.onclose(g)},this.ws.onerror=function(g){v.onerror&&v.onerror(g)},this.ws.onmessage=function(g){v.onmessage&&v.onmessage(g)}}return StateServiceWebSocketConnection.CreateAsync=function(g,m){return f(this,void 0,void 0,(function(){return S(this,(function(f){return[2,new StateServiceWebSocketConnection(g,m)]}))}))},Object.defineProperty(StateServiceWebSocketConnection.prototype,"name",{get:function(){return"WebSocket"},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"readyState",{get:function(){return this.ws.readyState},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"isOpen",{get:function(){return this.ws.readyState===WebSocket.OPEN},enumerable:!1,configurable:!0}),Object.defineProperty(StateServiceWebSocketConnection.prototype,"shouldSendPings",{get:function(){return!0},enumerable:!1,configurable:!0}),StateServiceWebSocketConnection.prototype.close=function(){this.ws.close()},StateServiceWebSocketConnection.prototype.send=function(g){this.ws.send(g)},StateServiceWebSocketConnection.prototype.sendSetupMessages=function(){return f(this,void 0,void 0,(function(){var g,m,f,v,C,_,E=this;return S(this,(function(S){switch(S.label){case 0:return(m=this.settings.getAuthTokenAsync)?[4,this.settings.getAuthTokenAsync()]:[3,2];case 1:m=S.sent(),S.label=2;case 2:return g=m,f=this.settings,v=f.metadata,C=f.subscriptions,_={authToken:g,metadata:v,subscriptions:C},this.settings.createSetupMessage(_).forEach((function(g){return E.send(g)})),[2]}}))}))},StateServiceWebSocketConnection}();m.StateServiceWebSocketConnection=v})),nm=createCommonjsModule((function(g,m){var f=C&&C.__awaiter||function(g,m,f,S){function adopt(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function fulfilled(g){try{step(S.next(g))}catch(g){v(g)}}function rejected(g){try{step(S.throw(g))}catch(g){v(g)}}function step(g){g.done?f(g.value):adopt(g.value).then(fulfilled,rejected)}step((S=S.apply(g,m||[])).next())}))},S=C&&C.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function verb(g){return function(m){return step([g,m])}}function step(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=_.trys,(v=v.length>0&&v[v.length-1])||6!==C[0]&&2!==C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}},v=C&&C.__values||function(g){var m="function"==typeof Symbol&&Symbol.iterator,f=m&&g[m],S=0;if(f)return f.call(g);if(g&&"number"==typeof g.length)return{next:function(){return g&&S>=g.length&&(g=void 0),{value:g&&g[S++],done:!g}}};throw new TypeError(m?"Object is not iterable.":"Symbol.iterator is not defined.")},_=C&&C.__importDefault||function(g){return g&&g.__esModule?g:{default:g}};Object.defineProperty(m,"__esModule",{value:!0}),m.SimpleStateServiceProxy=void 0;var E=_(xp),T=[2e3,2e3,3e3,3e3,5e3],I=4321,b=function(){function SimpleStateServiceProxy(g,m,f,S,v,C){var _;this.m_events=new bu.EventEmitter,this.m_clientId="",this.m_connectionState=Xg.ConnectionState.Disconnected,this.m_handlers=new Map,this.m_connection=null,this.m_clientIds=new Set,this.m_initTimeoutDurationInMS=0,this.m_retryAttempts=0,this.m_sessionRetryAttempts=0,this.m_maxSessionRetries=0,this.m_outboundMessageInfo=new Map,this.m_initPromise={promise:null,resolve:null,reject:null},this.m_messageBuffer=[],this.m_batchWaitTimeMS=20,this.m_batchMessageTypeName="list",this.m_closeConnectionTimer=null,this.m_lastCloseCode=0,this.m_lastCloseReason="",this.m_offlineMessageCache=[],this.m_unacknowledgedMessages=new Map,this.m_sessionId=g,this.m_logger=S,this.m_connectionAliveTimeAfterLoseFocusInMS=v.websocketAliveTimeAfterLoseFocusInMS,this.m_useServiceGeneratedClientId=v.useServiceGeneratedClientId||!1,this.m_wsUrl=f+"?docId="+this.m_sessionId+"&clientType="+m,v.correlationId&&(this.m_wsUrl+="&cid="+v.correlationId),v.isAutomation&&(this.m_wsUrl+="&automation=true"),v.autoRoutingEnabled&&(this.m_wsUrl+="&routing=true"),this.m_useServiceGeneratedClientId||(this.m_clientId=v.customClientId||Jp.v4(),this.m_wsUrl+="&clientId="+this.m_clientId),this.m_deltasBaseUrl=f.replace("wss://","https://").replace("ws://","http://"),this.setupSystemClientsCell(),this.setUpSystemCommandsCell(),this.setupServiceGeneratedClientIdCell(),this.m_useServiceGeneratedClientId&&(this.m_clientIdEvictingQueue=new Qp.EvictingQueue(20)),this.m_telemetry=new tm.SimpleServiceTelemetry(this.m_clientId,this.m_sessionId,v.maxRoundtripRaw),this.m_verbose=v.verbose||!1,this.m_batchedRequestsEnabled=v.batchedRequestsEnabled,this.m_initTimeoutDurationInMS=v.initTimeoutDurationInMs||0,this.m_pingTimeoutInMs=v.pingTimeoutInMs,this.m_pongTimeoutInMs=v.pongTimeoutInMs,this.m_user=C,this.m_metadata=v.metadata,this.m_retryIntervalsInMs=v.retryIntervalsInMs||T,this.m_maxSessionRetries=v.maxSessionRetries,this.m_offlineMessageCacheEnabled=v.offlineMessageCacheEnabled,this.m_maxOfflineMessageCacheTimeInMs=v.maxOfflineMessageCacheTimeInMs,this.m_maxOfflineMessageCacheLength=v.maxOfflineMessageCacheLength,this.m_allowReconnectOnMessageSend=v.allowReconnectOnSendMessage||!1,this.m_unacknowledgedMaxTimeInMs=null!==(_=v.unacknowledgeMessageTimeoutInMs)&&void 0!==_?_:0,this.m_subscriptions=v.subscriptions,this.m_connectionSettings={getAuthTokenAsync:this.getAuthToken.bind(this),createSetupMessage:this.createSetupMessage.bind(this),metadata:this.m_metadata,subscriptions:this.m_subscriptions}}return Object.defineProperty(SimpleStateServiceProxy.prototype,"lastCloseReason",{get:function(){return this.m_lastCloseReason},enumerable:!1,configurable:!0}),SimpleStateServiceProxy.prototype.senderId=function(){return this.m_clientId},SimpleStateServiceProxy.prototype.countOfOutboundMessagesNotRoundTrippedYet=function(){return this.m_outboundMessageInfo.size},SimpleStateServiceProxy.prototype.canRetry=function(){return this.m_connectionState===Xg.ConnectionState.Disconnected&&this.m_lastCloseCode!==I},SimpleStateServiceProxy.prototype.getServiceTelemetry=function(){return this.m_telemetry.wsState=Xg.ConnectionState[this.getConnectionState()],this.m_telemetry.messagePendingAckCount=this.m_outboundMessageInfo.size,this.m_telemetry},SimpleStateServiceProxy.prototype.activeClientCount=function(){return this.m_clientIds.size},SimpleStateServiceProxy.prototype.activeClientIds=function(){return this.m_clientIds},SimpleStateServiceProxy.prototype.clientId=function(){return this.m_clientId},SimpleStateServiceProxy.prototype.getConnectionState=function(){return this.m_connectionState},SimpleStateServiceProxy.prototype.on=function(g,m){return this.m_events.on(g,m),this},SimpleStateServiceProxy.prototype.connectAsync=function(){return f(this,void 0,void 0,(function(){var g=this;return S(this,(function(m){return this.m_initPromise.promise=new Promise((function(m,f){g.m_initPromise.resolve=m,g.m_initPromise.reject=f})),this.setConnectionState(Xg.ConnectionState.Connecting),[2,new Promise((function(m,v){return f(g,void 0,void 0,(function(){var g,f=this;return S(this,(function(S){switch(S.label){case 0:return g=this,[4,im.StateServiceWebSocketConnection.CreateAsync(this.m_wsUrl,this.m_connectionSettings)];case 1:return g.m_connection=S.sent(),this.m_connection.onopen=function(){f.handleConnectionOpen(),f.startInitTimeoutTimerWithRetry(f.m_initTimeoutDurationInMS,f.m_initPromise.reject),m()},this.m_connection.onerror=function(g){var S;f.m_logger.sendTraceTag(590213388,Qg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(S=f.m_connection)||void 0===S?void 0:S.name)+" onerror. {sessionId: "+f.m_sessionId+", ClientId: "+f.m_clientId+", Error: "+JSON.stringify(g)+"}"),f.retryConnection((function(g){var m,S="failed to reconnect after "+(null===(m=f.m_connection)||void 0===m?void 0:m.name)+" error: "+Yp.errorToString(g);f.m_logger.sendTraceTag(579463185,Qg.TraceLevel.Error,S),v(S)}),!1,(function(){return m()}))},this.m_connection.onlog=function(g){var m;f.m_logger.sendTraceTag(556909603,g.detail.level,"SimpleStateServiceProxy::log - "+(null===(m=f.m_connection)||void 0===m?void 0:m.name)+" {sessionId: "+f.m_sessionId+", ClientId: "+f.m_clientId+", Message: "+g.detail.message+"}")},this.m_connection.onclose=function(g){var S,C;f.m_logger.sendTraceTag(590213389,Qg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(S=f.m_connection)||void 0===S?void 0:S.name)+" onclose. {sessionId: "+f.m_sessionId+", ClientId: "+f.m_clientId+", Code: "+g.code+", Reason: "+g.reason+"}"),f.m_lastCloseCode=g.code,f.m_lastCloseReason=g.reason,g.code!==I?f.retryConnection((function(g){var m="failed to reconnect after service side disconnect: "+Yp.errorToString(g);f.m_logger.sendTraceTag(579463186,Qg.TraceLevel.Error,m),v(m)}),!1,(function(){return m()})):(f.setConnectionState(Xg.ConnectionState.Disconnected),f.m_logger.sendTraceTag(588009741,Qg.TraceLevel.Error,"SimpleStateServiceProxy::connect - "+(null===(C=f.m_connection)||void 0===C?void 0:C.name)+" onclose. Not retryable close code. {sessionId: "+f.m_sessionId+", ClientId: "+f.m_clientId+"}"))},this.m_connection.onmessage=function(g){var m;try{f.handleConnectionMessage(g)}catch(g){f.m_logger.sendTraceTag(590213390,Qg.TraceLevel.Error,"SimpleStateServiceProxy::onmessage - "+(null===(m=f.m_connection)||void 0===m?void 0:m.name)+" error. {sessionId: "+f.m_sessionId+", ClientId: "+f.m_clientId+", Error: "+Yp.errorToString(g)+"}")}},[2]}}))}))}))]}))}))},SimpleStateServiceProxy.prototype.close=function(){var g;this.m_logger.sendTraceTag(590213400,Qg.TraceLevel.Info,"SimpleStateServiceProxy::close. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.closeAndClearConnection(),this.m_retryTimer&&(clearTimeout(this.m_retryTimer),this.m_retryTimer=null),this.m_unacknowledgedMessages.clear(),this.clearPingPongTimer(),this.clearOfflineMessageCacheTimer(),this.clearInitTimeoutTimer(),this.clearUnacknowledgedTimer(),null===(g=this.m_clientIdEvictingQueue)||void 0===g||g.clear(),0!==this.countOfOutboundMessagesNotRoundTrippedYet()&&(this.m_events.emit("messageFailedToRoundTripOnClose",this.m_outboundMessageInfo.size),this.m_outboundMessageInfo.clear())},SimpleStateServiceProxy.prototype.sendStateMessage=function(g){this.sendStateMessageImpl(g)},SimpleStateServiceProxy.prototype.createMapAsync=function(g,m,v,C){return f(this,void 0,void 0,(function(){var f;return S(this,(function(S){return f=new em.SimpleSyncMap(g,this,m,v,C),this.m_handlers.set(g,f),[2,f]}))}))},SimpleStateServiceProxy.prototype.getMapAsync=function(g){return f(this,void 0,void 0,(function(){var m;return S(this,(function(f){return(m=this.m_handlers.get(g))?[2,m]:[2,null]}))}))},SimpleStateServiceProxy.prototype.waitMapAsync=function(g,m,v,C){return f(this,void 0,void 0,(function(){var f;return S(this,(function(S){switch(S.label){case 0:return[4,this.m_initPromise.promise];case 1:return S.sent(),[4,this.getMapAsync(g)];case 2:return(f=S.sent())?[3,4]:[4,this.createMapAsync(g,m,v,C)];case 3:f=S.sent(),S.label=4;case 4:return[2,f]}}))}))},SimpleStateServiceProxy.prototype.createCellAsync=function(g,m,v,C){return f(this,void 0,void 0,(function(){var f;return S(this,(function(S){return f=new Xp.SimpleSyncCell(g,this,m,v,C),this.m_handlers.set(g,f),[2,f]}))}))},SimpleStateServiceProxy.prototype.getCellAsync=function(g){return f(this,void 0,void 0,(function(){var m;return S(this,(function(f){return(m=this.m_handlers.get(g))?[2,m]:[2,null]}))}))},SimpleStateServiceProxy.prototype.waitCellAsync=function(g,m,v,C){return f(this,void 0,void 0,(function(){var f;return S(this,(function(S){switch(S.label){case 0:return this.m_logger.sendTraceTag(520161040,Qg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - awaiting initPromise "+g),[4,this.m_initPromise.promise];case 1:return S.sent(),this.m_logger.sendTraceTag(520161039,Qg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - getCellAsync "+g),[4,this.getCellAsync(g)];case 2:return(f=S.sent())?[3,4]:(this.m_logger.sendTraceTag(520161038,Qg.TraceLevel.Info,"SimpleStateServiceProxy::waitCellAsync - createCellAsync "+g),[4,this.createCellAsync(g,m,v,C)]);case 3:f=S.sent(),S.label=4;case 4:return[2,f]}}))}))},SimpleStateServiceProxy.prototype.onFocusChanged=function(g){var m=this;g?(window.clearTimeout(this.m_closeConnectionTimer),this.m_connection||(this.m_logger.sendTraceTag(590213392,Qg.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - retryConnection due to getting focus again. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.retryConnection((function(g){m.m_logger.sendTraceTag(579463187,Qg.TraceLevel.Error,"failed to reconnect after regaining focus: "+Yp.errorToString(g))}),!0))):this.m_closeConnectionTimer=window.setTimeout((function(){var g;m.m_connection&&(m.m_logger.sendTraceTag(590213391,Qg.TraceLevel.Info,"SimpleStateServiceProxy::onFocusChanged - "+(null===(g=m.m_connection)||void 0===g?void 0:g.name)+" close due to losing focus. {sessionId: "+m.m_sessionId+", ClientId: "+m.m_clientId+"}"),m.m_connection.onclose=function(){},m.m_connection.close(),m.m_connection=null)}),this.m_connectionAliveTimeAfterLoseFocusInMS)},SimpleStateServiceProxy.prototype.getHistoryAsync=function(g,m){return f(this,void 0,void 0,(function(){var f,v;return S(this,(function(S){switch(S.label){case 0:return(f=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),f.searchParams.append("docId",this.m_sessionId),f.searchParams.append("cid",this.m_clientId),f.searchParams.append("objectId",g),m&&f.searchParams.append("property",m),[4,E.default.get(f.toString())];case 1:return(v=S.sent().data).forEach((function(g){return g.value=JSON.parse(g.value)})),[2,v]}}))}))},SimpleStateServiceProxy.prototype.getHistoryWithPaginationAsync=function(g,m,v){return f(this,void 0,void 0,(function(){var f,C;return S(this,(function(S){switch(S.label){case 0:return(f=new URL(this.m_deltasBaseUrl)).searchParams.append("action","deltas"),f.searchParams.append("docId",this.m_sessionId),f.searchParams.append("cid",this.m_clientId),f.searchParams.append("objectId",g),f.searchParams.append("pagination","true"),v&&f.searchParams.append("cursor",v),m&&f.searchParams.append("property",m),[4,E.default.get(f.toString())];case 1:return(C=S.sent().data).messages.forEach((function(g){return g.value=JSON.parse(g.value)})),[2,C]}}))}))},SimpleStateServiceProxy.prototype.setupSystemClientsCell=function(){var g=this;this.m_clientsCell=new Xp.SimpleSyncCell("systemClients",this),this.m_handlers.set(this.m_clientsCell.id(),this.m_clientsCell),this.m_clientsCell.on("valueChanged",(function(m){g.m_clientIds=new Set(m),g.m_events.emit("activeClientCountChanged")}))},SimpleStateServiceProxy.prototype.setUpSystemCommandsCell=function(){var g=this;this.m_systemCommandsCell=new Xp.SimpleSyncCell(Xg.SystemCommandsStateName,this),this.m_handlers.set(this.m_systemCommandsCell.id(),this.m_systemCommandsCell),this.m_systemCommandsCell.on("valueChanged",(function(m){return f(g,void 0,void 0,(function(){var g,f,v;return S(this,(function(S){switch(S.label){case 0:return"refreshToken"===m?[3,1]:[3,6];case 1:if(!this.m_user||!this.m_user.getForceRefreshedTokenAsync)return[3,5];S.label=2;case 2:return S.trys.push([2,4,,5]),[4,this.m_user.getForceRefreshedTokenAsync()];case 3:return g=S.sent(),f={},g&&(f.authorization=g.token,f.authProvider=g.authProvider,f.mri=g.mri||"",f.huid=g.hashedUserEmail||""),this.sendConfigMessage(f),[3,5];case 4:return v=S.sent(),this.m_logger.sendTraceTag(574107847,Qg.TraceLevel.Error,"Error getting force refreshed auth token: "+Yp.errorToString(v)),[3,5];case 5:return[3,7];case 6:return this.m_logger.sendTraceTag(574107848,Qg.TraceLevel.Error,"Unknown system command cell value: "+m),[3,7];case 7:return[2]}}))}))}))},SimpleStateServiceProxy.prototype.setupServiceGeneratedClientIdCell=function(){var g=this;this.m_serviceGeneratedClientIdCell=new Xp.SimpleSyncCell(Xg.ServiceGeneratedClientIdName,this),this.m_handlers.set(this.m_serviceGeneratedClientIdCell.id(),this.m_serviceGeneratedClientIdCell),this.m_serviceGeneratedClientIdCell.on("valueChanged",(function(m){g.m_logger.sendTraceTag(520161037,Qg.TraceLevel.Info,"SimpleStateServiceProxy::serviceGeneratedClientId changed to "+m+"}"),g.setClientId(m,!0),g.processClientIdQueue(),g.m_useServiceGeneratedClientId&&(g.processOfflineMessageCache(!0),g.clearOfflineMessageCacheTimer())})),this.m_logger.sendTraceTag(509743689,Qg.TraceLevel.Info,"SimpleStateServiceProxy::setupServiceGeneratedClientIdCell completed.")},SimpleStateServiceProxy.prototype.handleConnectionOpen=function(){var g;this.m_logger.sendTraceTag(590213387,Qg.TraceLevel.Info,"SimpleStateServiceProxy::connect - "+(null===(g=this.m_connection)||void 0===g?void 0:g.name)+" onopen. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryAttempts=0,this.setConnectionState(Xg.ConnectionState.Connected),this.startPingTimer(),this.m_useServiceGeneratedClientId||(this.processOfflineMessageCache(!1),this.clearOfflineMessageCacheTimer())},SimpleStateServiceProxy.prototype.setConnectionState=function(g){this.m_connectionState!==g&&(this.m_connectionState=g,g===Xg.ConnectionState.Disconnected&&this.m_useServiceGeneratedClientId&&this.setClientId("",!1),this.m_events.emit("connectionStateChanged"))},SimpleStateServiceProxy.prototype.setClientId=function(g,m){this.m_clientId!==g&&(this.m_clientId=g,m&&this.m_events.emit("clientIdChanged"))},SimpleStateServiceProxy.prototype.processClientIdQueue=function(){var g=this;this.m_clientIdEvictingQueue&&this.m_clientIdEvictingQueue.forEach((function(m){m.senderId=g.m_clientId,g.sendConnectionMessage(m,!0)}))},SimpleStateServiceProxy.prototype.sendGetInitialSystemStateMessages=function(){try{var g={messageId:Jp.v4(),senderId:this.senderId(),objectId:Xg.SystemSessionStateName,type:"",operation:"get",value:""};this.sendStateMessage(g);var m={messageId:Jp.v4(),senderId:this.senderId(),objectId:Xg.ServiceGeneratedClientIdName,type:"",operation:"get",value:""};this.sendStateMessage(m),this.m_logger.sendTraceTag(509141838,Qg.TraceLevel.Info,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - sent messages.")}catch(g){this.m_logger.sendTraceTag(509141837,Qg.TraceLevel.Error,"SimpleStateServiceProxy::sendGetInitialSystemStateMessages - caught error "+g)}},SimpleStateServiceProxy.prototype.createSetupMessage=function(g){var m=g.authToken,f=g.metadata,S=g.subscriptions,v=[];if(m||f){var C={};m&&(C.authorization=m.token,C.authProvider=m.authProvider,C.mri=m.mri||"",C.huid=m.hashedUserEmail||""),f&&(C.metadata=JSON.stringify(f));var _={messageId:Jp.v4(),senderId:this.senderId(),objectId:Xg.ConfigurationName,type:"",operation:"",value:JSON.stringify(C)};v.push(JSON.stringify(_))}if(S){_={messageId:Jp.v4(),senderId:this.senderId(),objectId:Xg.StateSubscriptionsName,type:"",operation:"",value:JSON.stringify(S)};v.push(JSON.stringify(_))}return v},SimpleStateServiceProxy.prototype.sendConfigMessage=function(g){var m={messageId:Jp.v4(),senderId:this.senderId(),objectId:Xg.ConfigurationName,type:"",operation:"",value:JSON.stringify(g)};this.sendStateMessage(m)},SimpleStateServiceProxy.prototype.retryConnection=function(g,m,v){var C=this;if(this.clearPingPongTimer(),this.clearInitTimeoutTimer(),this.m_retryAttempts>=this.m_retryIntervalsInMs.length||this.m_sessionRetryAttempts>=this.m_maxSessionRetries)return this.setConnectionState(Xg.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213393,Qg.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection reached max retry attempts. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),void(g&&g(new Error("reached max retry attempts")));if(this.setConnectionState(Xg.ConnectionState.Connecting),m||this.m_connection&&!this.m_retryTimer){var _=this.m_retryIntervalsInMs[this.m_retryAttempts];this.m_retryAttempts+=1,this.m_sessionRetryAttempts+=1,this.m_telemetry.wsReconnectCount+=1,this.closeAndClearConnection(),this.m_retryTimer=setTimeout((function(){return f(C,void 0,void 0,(function(){var m;return S(this,(function(f){switch(f.label){case 0:this.m_logger.sendTraceTag(590213395,Qg.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}"),this.m_retryTimer=null,f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this.connectAsync()];case 2:return f.sent(),v&&v(),[3,4];case 3:return m=f.sent(),this.setConnectionState(Xg.ConnectionState.Disconnected),this.m_logger.sendTraceTag(590213396,Qg.TraceLevel.Error,"SimpleStateServiceProxy::retryConnection failed. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}, "+Yp.errorToString(m)),this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&g(m),[3,4];case 4:return[2]}}))}))}),_)}else this.m_logger.sendTraceTag(590213394,Qg.TraceLevel.Info,"SimpleStateServiceProxy::retryConnection skipped. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", NullConnection: "+(null===this.m_connection)+", NullRetryTimer: "+(null===this.m_retryTimer)+"}")},SimpleStateServiceProxy.prototype.startPingTimer=function(){var g=this;this.m_connection&&this.m_connection.shouldSendPings&&(this.m_pingTimeoutInMs<=0||this.m_pongTimeoutInMs<=0||(this.clearPingPongTimer(),this.m_pingTimer=setTimeout((function(){return f(g,void 0,void 0,(function(){return S(this,(function(g){return this.sendPingMessage(),this.m_pingTimer=null,[2]}))}))}),this.m_pingTimeoutInMs)))},SimpleStateServiceProxy.prototype.sendPingMessage=function(){var g=this;this.m_connection&&(this.m_connection.isOpen?(this.m_verbose&&this.m_logger.sendTraceTag(559952470,Qg.TraceLevel.Info,"SimpleStateServiceProxy::sendPingMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __ping__"),this.m_connection.send("__ping__"),this.clearPongTimer(),this.m_pongTimer=setTimeout((function(){return f(g,void 0,void 0,(function(){var g=this;return S(this,(function(m){return this.retryConnection((function(m){g.m_logger.sendTraceTag(579463188,Qg.TraceLevel.Error,"failed to reconnect after missing ping: "+Yp.errorToString(m))}),!1),this.m_pongTimer=null,[2]}))}))}),this.m_pongTimeoutInMs)):(this.retryConnection((function(m){g.m_logger.sendTraceTag(579463189,Qg.TraceLevel.Error,"failed to reconnect after closed connection: "+Yp.errorToString(m))}),!1),this.clearPongTimer()))},SimpleStateServiceProxy.prototype.clearPingPongTimer=function(){this.clearPingTimer(),this.clearPongTimer()},SimpleStateServiceProxy.prototype.clearPingTimer=function(){this.m_pingTimer&&(clearTimeout(this.m_pingTimer),this.m_pingTimer=null)},SimpleStateServiceProxy.prototype.clearPongTimer=function(){this.m_pongTimer&&(clearTimeout(this.m_pongTimer),this.m_pongTimer=null)},SimpleStateServiceProxy.prototype.handleConnectionMessage=function(g){if("string"==typeof g.data){if(this.startPingTimer(),"__pong__"===g.data)return void(this.m_verbose&&this.m_logger.sendTraceTag(559952471,Qg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", __pong__"));var m=Date.now();try{var f=JSON.parse(g.data);Array.isArray(f)&&f.length>0?this.handleAggregatedStateMessages(f):this.handleStateMessage(f),this.m_telemetry.addMessageHandleLatency(Date.now()-m),f.objectId===Xg.SystemSessionStateName?(this.m_logger.sendTraceTag(520161036,Qg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - systemSessionState - initPromise resolved."),this.m_initPromise.resolve(),this.clearInitTimeoutTimer()):f.objectId===Xg.ServiceGeneratedClientIdName&&this.m_logger.sendTraceTag(509743688,Qg.TraceLevel.Info,"SimpleStateServiceProxy::handleConnectionMessage - serviceGeneratedClientId received.")}catch(g){this.m_logger.sendTraceTag(578102302,Qg.TraceLevel.Error,"handleConnectionMessage: "+Yp.errorToString(g))}}else this.m_logger.sendTraceTag(590213397,Qg.TraceLevel.Error,"SimpleStateServiceProxy::handleConnectionMessage - Unknown data type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+typeof g.data+"}")},SimpleStateServiceProxy.prototype.handleAggregatedStateMessages=function(g){var m,f,S=this;if(g&&0!==g.length){var C=g.map((function(g){return JSON.parse(g)})),_={};C.forEach((function(g){return _[g.objectId]=1+(_[g.objectId]||0)})),Object.keys(_).forEach((function(g){if(_[g]>1){var m=S.m_handlers.get(g);m&&m.beginAggregatedStateUpdating&&m.beginAggregatedStateUpdating()}}));try{for(var E=v(C),T=E.next();!T.done;T=E.next()){var I=T.value;this.handleStateMessage(I)}}catch(g){m={error:g}}finally{try{T&&!T.done&&(f=E.return)&&f.call(E)}finally{if(m)throw m.error}}Object.keys(_).forEach((function(g){if(_[g]>1){var m=S.m_handlers.get(g);m&&m.endAggregatedStateUpdating&&m.endAggregatedStateUpdating()}}))}},SimpleStateServiceProxy.prototype.handleStateMessage=function(g){var m=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213398,Qg.TraceLevel.Info,"SimpleStateServiceProxy::handleStateMessage. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}"),"list"===g.type){JSON.parse(g.value).forEach((function(g){m.handleStateMessage(g)}))}else{if(this.m_user&&this.m_user.validateMessage&&!this.m_user.validateMessage(g))return void this.m_logger.sendTraceTag(588009742,Qg.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage rejected message: {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}");var f=this.getHandlerForMessage(g);if(g.senderId===this.senderId()&&(this.acknowledgeMessage(g,f),this.m_telemetry.incrementAcknowledgedCount(g.objectId)),this.measureMessageRoundTripLatency(g),this.m_telemetry.incrementReceivedCount(g.objectId),f)return void f.handleStateMessage(g)}},SimpleStateServiceProxy.prototype.getAuthToken=function(){return f(this,void 0,void 0,(function(){var g,m;return S(this,(function(f){switch(f.label){case 0:if(!this.m_user||!this.m_user.getAuthTokenAsync)return[3,4];f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this.m_user.getAuthTokenAsync()];case 2:return g=f.sent(),[3,4];case 3:return m=f.sent(),this.m_logger.sendTraceTag(578102469,Qg.TraceLevel.Error,"Error getting auth token: "+Yp.errorToString(m)),[3,4];case 4:return[2,g]}}))}))},SimpleStateServiceProxy.prototype.getHandlerForMessage=function(g){var m=this.m_handlers.get(g.objectId);return m||("cell"===g.type?m=new Xp.SimpleSyncCell(g.objectId,this):"map"===g.type?m=new em.SimpleSyncMap(g.objectId,this):this.m_logger.sendTraceTag(559204164,Qg.TraceLevel.Error,"SimpleStateServiceProxy::handleStateMessage - Unknown message type. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Type: "+g.type+"}"),m&&this.m_handlers.set(g.objectId,m),m)},SimpleStateServiceProxy.prototype.sendStateMessageImpl=function(g){var m,f=this;if(this.m_verbose&&this.m_logger.sendTraceTag(590213403,Qg.TraceLevel.Info,"SimpleStateServiceProxy::sendStateMessageImpl. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}"),g.objectId!==Xg.StateSubscriptionsName&&g.objectId!==Xg.ConfigurationName){if(this.m_outboundMessageInfo.set(g.messageId,Date.now()),this.m_telemetry.incrementRequestedCount(g.objectId),this.m_unacknowledgedMaxTimeInMs>0){var S=null===(m=this.getHandlerForMessage(g))||void 0===m?void 0:m.messageTrackingOption();if(S&&S!==Xg.MessageTrackingOption.None){var v=this.getUnacknowledgedMessagesMapKey(g,S);this.m_unacknowledgedMessages.set(v,{message:g,timestamp:Date.now()}),this.startUnacknowledgeMessageTimer()}}if(this.m_useServiceGeneratedClientId&&this.m_clientIdEvictingQueue&&!this.m_clientId&&"get"!==g.operation)return this.m_logger.sendTraceTag(508348254,Qg.TraceLevel.Info,"SimpleStateServiceProxy::enqueueMessage "+JSON.stringify(g)),void this.m_clientIdEvictingQueue.enqueue(g)}this.m_user&&this.m_user.patchMessage&&this.m_user.patchMessage(g),this.m_batchedRequestsEnabled?(this.m_messageBuffer.push(g),this.m_processBufferTimer||(this.m_processBufferTimer=setTimeout((function(){f.processMessageBuffer()}),this.m_batchWaitTimeMS))):this.sendConnectionMessage(g,!0)},SimpleStateServiceProxy.prototype.createListMessage=function(g){if(0!==g.length)return 1===g.length?g[0]:{value:JSON.stringify(g),type:this.m_batchMessageTypeName,operation:"",messageId:Jp.v4(),objectId:"batch",senderId:this.senderId()}},SimpleStateServiceProxy.prototype.processMessageBuffer=function(){var g=this.m_messageBuffer.length,m=this.m_messageBuffer.splice(0,g),f=this.createListMessage(m);this.m_processBufferTimer&&clearTimeout(this.m_processBufferTimer),this.m_processBufferTimer=null,f&&this.sendConnectionMessage(f,!0)},SimpleStateServiceProxy.prototype.processOfflineMessageCache=function(g){var m=this;this.m_offlineMessageCacheEnabled&&(this.m_offlineMessageCache.forEach((function(f){g&&(f.message.senderId=m.m_clientId),m.sendConnectionMessage(f.message,!1),m.m_telemetry.offlineCacheTelemetry.resentCount+=1})),this.m_offlineMessageCache=[])},SimpleStateServiceProxy.prototype.purgeOfflineMessageCache=function(){var g=this;if(this.m_offlineMessageCacheEnabled&&this.m_maxOfflineMessageCacheTimeInMs){var m=Date.now(),f=this.m_offlineMessageCache.filter((function(f){return g.m_maxOfflineMessageCacheTimeInMs&&f.timestamp+g.m_maxOfflineMessageCacheTimeInMs>=m}));this.m_telemetry.offlineCacheTelemetry.expiredCount+=this.m_offlineMessageCache.length-f.length,this.m_offlineMessageCache=f,0===this.m_offlineMessageCache.length&&this.clearOfflineMessageCacheTimer()}},SimpleStateServiceProxy.prototype.clearOfflineMessageCacheTimer=function(){this.m_offlineMessageCacheEnabled&&this.m_offlineMessageCacheTimer&&(clearInterval(this.m_offlineMessageCacheTimer),this.m_offlineMessageCacheTimer=null)},SimpleStateServiceProxy.prototype.getUnacknowledgedMessagesMapKey=function(g,m){return m===Xg.MessageTrackingOption.None?"":m===Xg.MessageTrackingOption.All?g.messageId:g.objectId},SimpleStateServiceProxy.prototype.startUnacknowledgeMessageTimer=function(){var g=this;this.m_unacknowledgedMaxTimeInMs>0&&!this.m_unacknowledgedTimer&&(this.m_unacknowledgedTimer=setInterval((function(){g.notifyUnacknowledgedMessages(),g.m_unacknowledgedMessages.size<=0&&g.clearUnacknowledgedTimer()}),this.m_unacknowledgedMaxTimeInMs/2))},SimpleStateServiceProxy.prototype.acknowledgeMessage=function(g,m){if(g.senderId===this.senderId()&&m&&!(this.m_unacknowledgedMessages.size<=0)){var f=this.getUnacknowledgedMessagesMapKey(g,m.messageTrackingOption()),S=this.m_unacknowledgedMessages.get(f);S&&g.messageId===S.message.messageId&&this.m_unacknowledgedMessages.delete(f)}},SimpleStateServiceProxy.prototype.notifyUnacknowledgedMessages=function(){var g=this,m=Date.now();this.m_unacknowledgedMessages.forEach((function(f,S){if(f.timestamp+g.m_unacknowledgedMaxTimeInMs<m){var v=g.getHandlerForMessage(f.message);null==v||v.handleUnacknowledgedMessage(f.message),g.m_unacknowledgedMessages.delete(S),g.m_telemetry.unacknowledgedMessagesCount+=1}}))},SimpleStateServiceProxy.prototype.clearUnacknowledgedTimer=function(){this.m_unacknowledgedTimer&&(clearInterval(this.m_unacknowledgedTimer),this.m_unacknowledgedTimer=null)},SimpleStateServiceProxy.prototype.startInitTimeoutTimerWithRetry=function(g,m){var f=this;this.startInitTimeoutTimer(g,(function(){f.m_logger.sendTraceTag(509141836,Qg.TraceLevel.Error,"SimpleStateServiceProxy::startInitTimeoutTimer - failed to init after "+g+" ms; requesting get messages and retrying"),f.sendGetInitialSystemStateMessages(),f.startInitTimeoutTimer(g,m)}))},SimpleStateServiceProxy.prototype.startInitTimeoutTimer=function(g,m){g>0&&(this.clearInitTimeoutTimer(),this.m_initTimeoutTimer=setTimeout((function(){m("Initialization timed out after "+g+" ms")}),g))},SimpleStateServiceProxy.prototype.clearInitTimeoutTimer=function(){this.m_initTimeoutTimer&&clearTimeout(this.m_initTimeoutTimer)},SimpleStateServiceProxy.prototype.sendConnectionMessage=function(g,m){var f,S,v=this;if(this.m_allowReconnectOnMessageSend&&this.m_connectionState===Xg.ConnectionState.Disconnected&&(this.updateRetryAttempts(),this.retryConnection((function(g){v.m_logger.sendTraceTag(559428289,Qg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - failed to reconnect with error: "+Yp.errorToString(g)+" ")}),!1)),this.m_offlineMessageCacheEnabled&&m){if(!this.m_connection||this.m_connectionState!==Xg.ConnectionState.Connected)return!this.m_maxOfflineMessageCacheLength||this.m_offlineMessageCache.length>=this.m_maxOfflineMessageCacheLength?(this.m_telemetry.offlineCacheTelemetry.rejectedCount+=1,void this.m_logger.sendTraceTag(570807006,Qg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - Dropping message because offline cache is full. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+(null===(f=this.m_connection)||void 0===f?void 0:f.readyState)+"}")):(!this.m_offlineMessageCacheTimer&&this.m_maxOfflineMessageCacheTimeInMs&&(this.m_offlineMessageCacheTimer=setInterval((function(){v.purgeOfflineMessageCache()}),this.m_maxOfflineMessageCacheTimeInMs/2)),this.m_offlineMessageCache.push({message:g,timestamp:Date.now()}),void(this.m_telemetry.offlineCacheTelemetry.cachedCount+=1))}else{if(!this.m_connection)return void this.m_logger.sendTraceTag(590213401,Qg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - connection is not set. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+"}");if(!this.m_connection.isOpen)return void this.m_logger.sendTraceTag(590213402,Qg.TraceLevel.Error,"SimpleStateServiceProxy::sendConnectionMessage - "+this.m_connection.name+" status is not open. {sessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", Status: "+this.m_connection.readyState+"}")}null===(S=this.m_connection)||void 0===S||S.send(JSON.stringify(g))},SimpleStateServiceProxy.prototype.closeAndClearConnection=function(){if(this.m_connection){if(this.m_connection.onclose=function(){},this.m_connection.isOpen)this.m_connection.close();else{var g=this.m_connection;g.onopen=function(){return g.close()}}this.m_connection=null}},SimpleStateServiceProxy.prototype.updateRetryAttempts=function(){this.m_retryAttempts>=this.m_retryIntervalsInMs.length&&(this.m_retryAttempts=0),this.m_sessionRetryAttempts>=this.m_maxSessionRetries&&(this.m_sessionRetryAttempts=0)},SimpleStateServiceProxy.prototype.measureMessageRoundTripLatency=function(g){if(g.senderId===this.senderId())try{var m=this.m_outboundMessageInfo.get(g.messageId);if(void 0!==m){this.m_outboundMessageInfo.delete(g.messageId);var f=Date.now()-m;this.m_events.emit("messageRoundTripped",{clientId:this.m_clientId,sessionId:this.m_sessionId,messageId:g.messageId,objectId:g.objectId,operation:g.operation,latencyInMs:f}),this.m_telemetry.addRoundtripLatency(f)}else this.m_verbose&&this.m_logger.sendTraceTag(590213404,Qg.TraceLevel.Info,"SimpleStateServiceProxy::measureMessageRoundTripLatency. Failed to find outbound message info for {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", ObjectId: "+g.objectId+", MessageId: "+g.messageId+"}")}catch(m){this.m_logger.sendTraceTag(590213405,Qg.TraceLevel.Error,"SimpleStateServiceProxy::measureMessageRoundTripLatency - Exception thrown error. {SessionId: "+this.m_sessionId+", ClientId: "+this.m_clientId+", MessageId: "+g.messageId+", Error: "+m.message+"}")}},SimpleStateServiceProxy}();m.SimpleStateServiceProxy=b})),rm=createCommonjsModule((function(g,m){var f=C&&C.__awaiter||function(g,m,f,S){function adopt(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function fulfilled(g){try{step(S.next(g))}catch(g){v(g)}}function rejected(g){try{step(S.throw(g))}catch(g){v(g)}}function step(g){g.done?f(g.value):adopt(g.value).then(fulfilled,rejected)}step((S=S.apply(g,m||[])).next())}))},S=C&&C.__generator||function(g,m){var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:verb(0),throw:verb(1),return:verb(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C;function verb(g){return function(m){return step([g,m])}}function step(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=_.trys,(v=v.length>0&&v[v.length-1])||6!==C[0]&&2!==C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}};function createStateServiceProxyAsync(g,m,v,C,_,E){return f(this,void 0,void 0,(function(){var f;return S(this,(function(S){switch(S.label){case 0:return[4,(f=new nm.SimpleStateServiceProxy(g,m,v,C,_,E)).connectAsync()];case 1:return S.sent(),[2,f]}}))}))}Object.defineProperty(m,"__esModule",{value:!0}),m.createStateServiceProxyAsync=void 0,m.createStateServiceProxyAsync=createStateServiceProxyAsync})),sm=createCommonjsModule((function(g,m){var f=C&&C.__createBinding||(Object.create?function(g,m,f,S){void 0===S&&(S=f),Object.defineProperty(g,S,{enumerable:!0,get:function(){return m[f]}})}:function(g,m,f,S){void 0===S&&(S=f),g[S]=m[f]}),S=C&&C.__exportStar||function(g,m){for(var S in g)"default"===S||m.hasOwnProperty(S)||f(m,g,S)};Object.defineProperty(m,"__esModule",{value:!0}),S(Qg,m),S(Xg,m),S(rm,m)}));class ReactionLogger{constructor(g){this.enableConsoleLog=getAcsEcsConfig().calling.reaction.enableStateServiceConsoleLogs,this._logger=g}sendTraceTag(g,m,f){this.enableConsoleLog&&this._logger.info(`Tag: ${g}, Leve: ${m}, Message: ${f}`)}}class ReactionFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._isCapable=!0,this.meetingCapabilityChangeHandler=()=>{this._isCapable=this._tsCall.meetingDetails?.meetingCapability?.allowTeamsMeetingReactions},this._impl=new ReactionImplOverStateService(this.eventEmitter),this._isReactionFeatureEnabled=getAcsEcsConfig().calling.reaction.enabled}get name(){return"Reaction"}initialize(g,m){this._tsCall=g.tsCall,this._call=g.call,this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._logger.info(`Meeting Reaction feature enable flag: ${this._isReactionFeatureEnabled}`),g.tsCall.on("callStateChanged",(()=>{this._isReactionFeatureEnabled&&3===g.tsCall.state?this._impl.initialize(g.tsCall,g.callAgent,g.call,g.telemetryLogManager,m):this._logger.warn("Calls to reaction APIs will perform no action or return default values where applicable")})),this._call.offMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler),this._call.onMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler)}async sendReaction(g){let m=generateGuid();if(this._sendFeatureUsage("sendReaction",Lh.attempt,void 0,m),3!=this._tsCall.state||1===this._tsCall.callType){const g=new CallingCommunicationError(3!=this._tsCall.state?z.FEATURES.REACTION.CALL_NOT_CONNECTED:z.FEATURES.REACTION.NOT_SUPPORTED_1TO1_CTE);throw this._sendFeatureUsage("sendReaction",Lh.failure,g,m),g}if(!this._isReactionFeatureEnabled||!this._isCapable){const g=new CallingCommunicationError(z.FEATURES.REACTION.SEND_FAIL_POLICY);throw this._sendFeatureUsage("sendReaction",Lh.failure,g,m),g}await this._impl.sendReaction(g,m)}on(g,m){if("reaction"!==g)throw new CallingCommunicationError(z.FEATURES.REACTION.EVENT_SUBSCRIBE(g));if(!this._isReactionFeatureEnabled){const g=new CallingCommunicationError(z.FEATURES.REACTION.EVENT_SUBSCRIBE_FAIL_POLICY);throw this._sendFeatureUsage("receiveReaction",Lh.failure,g),g}this._sendFeatureUsage("receiveReaction",Lh.subscribe),this._impl.on(g,m)}off(g,m){if("reaction"!==g)throw new CallingCommunicationError(z.FEATURES.REACTION.EVENT_UNSUBSCRIBE(g));if(!this._isReactionFeatureEnabled){const g=new CallingCommunicationError(z.FEATURES.REACTION.EVENT_UNSUBSCRIBE_FAIL_POLICY);throw this._sendFeatureUsage("receiveReaction",Lh.failure,g),g}this._sendFeatureUsage("receiveReaction",Lh.unsubscribe),this._impl.off(g,m)}dispose(){this.disposed||(this._call.offMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler),this._impl.dispose(),super.dispose())}_sendFeatureUsage(g,m,f,S){let v=f?{code:f?.code||H,subCode:f?.subCode||0,failureReason:f?.message||"",...extractCommunicationServicesErrorForTelemetry(f)}:void 0;sendCallFeatureUsageTelemetry({correlationId:S,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}}class ReactionImplOverStateService{constructor(g){this._wsUrl="",this._isCapable=!0,this.name="Reaction",this.meetingCapabilityChangeHandler=()=>{this._isCapable=this._tsCall.meetingDetails?.meetingCapability?.allowTeamsMeetingReactions},this._eventEmitter=g}initialize(g,m,f,S,v){void 0===this._proxy||this._proxy?.getConnectionState()===sm.ConnectionState.Disconnected?(this._logger=v.createChild((()=>`ReactionImplOverStateService::Call(id='${this._tsCall.callId}')`)),this._internalCallAgent=m,this._tsCall=g,this._call=f,this._docId=this._tsCall.callId,this._wsUrl=this.getEndpointUrl(),this._telemetryLogManager=S,this._sendAttempOrFailureFeatureUsage("initialize",Lh.attempt),this.start(),this._call.offMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler),this._call.onMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler)):v.info("State Service Proxy already has an active connection.")}async start(){const g=getAcsEcsConfig().calling.reaction.StateServiceProxySettings,m=Ho,f={getAuthTokenAsync:this.getAuthToken.bind(this)};try{this._proxy=await sm.createStateServiceProxyAsync(this._docId,m,this._wsUrl,new ReactionLogger(this._logger),g,f)}catch(g){return this._logger.error("Could not create state service proxy",g),void this._sendAttempOrFailureFeatureUsage("initialize",Lh.failure,new CallingCommunicationError(z.FEATURES.REACTION.STATE_SERVICE_CONNECT_FAIL,g))}try{this._reactionsMap=await this._proxy.createMapAsync("reactions",!0)}catch(g){return this._logger.error("Could not create state service proxy reaction map",g),void this._sendAttempOrFailureFeatureUsage("initialize",Lh.failure,new CallingCommunicationError(z.FEATURES.REACTION.MAP_CREATE_FAIL,g))}this._sendSuccessFeatureUsage("initialize",Lh.success),this._reactionsMap?.on("valueChanged",this.onReactionsReceived.bind(this))}async getAuthToken(){const g={token:await this._internalCallAgent.tokenProvider(),authProvider:"SKYPE",mri:this._internalCallAgent.getUserMri()};return Promise.resolve(g)}async sendReaction(g,m){if(!this._reactionsMap){this._logger.error("Reaction Map has not yet been initialized.");const g=new CallingCommunicationError(z.FEATURES.REACTION.NOT_INIT_YET);throw this._sendAttempOrFailureFeatureUsage("sendReaction",Lh.failure,g,m),g}try{return this._reactionsMap?.set(this._internalCallAgent.getUserMri(),{name:g.reactionType}),void this._sendSuccessFeatureUsage("sendReaction",Lh.success,m,g.reactionType)}catch(g){this._logger.error("Unable to send reaction",g);const f=new CallingCommunicationError(z.FEATURES.REACTION.SEND_REACTION_FAIL,g);throw this._sendAttempOrFailureFeatureUsage("sendReaction",Lh.failure,f,m),f}}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}async onReactionsReceived(g){if(3===this._tsCall.state&&this._isCapable){const m=generateGuid();this._sendAttempOrFailureFeatureUsage("receiveReaction",Lh.attempt,void 0,m);try{const f={reactionType:(await(this._reactionsMap?.get(g))).name};this._eventEmitter.emit("reaction",{identifier:g,reactionMessage:f}),this._sendSuccessFeatureUsage("receiveReaction",Lh.success,m,f.reactionType)}catch(g){this._logger.error("Unable to parse reaction",g);let f=new CallingCommunicationError(z.FEATURES.REACTION.RECEIVE_REACTION_FAIL,g);this._sendAttempOrFailureFeatureUsage("receiveReaction",Lh.failure,f,m)}}}dispose(){void 0!==this._telemetryLogManager&&(this._proxy?.getConnectionState()===sm.ConnectionState.Connected?(this._reactionsMap?.removeAllListeners("valueChanged"),this._proxy.close(),this._sendSuccessFeatureUsage("dispose",Lh.success),this._call.offMeetingChanged("meetingCapabilitiesChanged",this.meetingCapabilityChangeHandler)):this._sendSuccessFeatureUsage("dispose",Lh.failure))}_sendAttempOrFailureFeatureUsage(g,m,f,S){let v=f?{code:f?.code||H,subCode:f?.subCode||0,failureReason:f?.message||"",...extractCommunicationServicesErrorForTelemetry(f)}:void 0;sendCallFeatureUsageTelemetry({correlationId:S,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}_sendSuccessFeatureUsage(g,m,f,S){let v;v="initialize"===g||"dispose"==g?void 0:{reactionConstraint:{reactionType:S}},sendCallFeatureUsageTelemetry({correlationId:f,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:this.name,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:v},this._telemetryLogManager,this._logger)}getEndpointUrl(){const g=this._internalCallAgent._caConfigBag,m=g&&isEudbConfigurationsApplicable(g.identityType,g.region);var f=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer;switch(g?.cloudType){case ca.Public:m&&(f=getAcsEcsConfig().PowerPointStateServiceUrl.public.eu);break;case ca.GccHigh:f=getAcsEcsConfig().PowerPointStateServiceUrl.gcch;break;case ca.AirGap08:f=getAcsEcsConfig().PowerPointStateServiceUrl.ag08;break;case ca.AirGap09:f=getAcsEcsConfig().PowerPointStateServiceUrl.ag09;break;case ca.Dod:f=getAcsEcsConfig().PowerPointStateServiceUrl.dod;break;default:f=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer}return`wss://${new URL(f).hostname}/StateServiceHandler.ashx`}}class ContentSharingSession{get contentSharingSession(){return this._contentSharingSession}constructor(g){this._contentSharingSession=g}getFileDetails(){if(this.contentSharingSession){return JSON.parse(atob(this.contentSharingSession.contentSharingIdentity))}}}class PPTLiveCallFeatureImpl extends FirstPartyCallFeature{constructor(g){super(g),this._impl=new PPTLiveCallImplOverTsCall(this.eventEmitter)}on(g,m){this._sendFeatureUsage(g,Lh.subscribe),this.eventEmitter.on(g,m)}off(g,m){this._sendFeatureUsage(g,Lh.unsubscribe),this.eventEmitter.off(g,m)}get isActive(){return this._impl.isActive}get target(){return this._impl.target}get name(){return"PPTLive"}initialize(g,m){this._logger=m,this._telemetryLogManager=g.telemetryLogManager,this._tsCall=g.tsCall,this._impl.initialize(g.tsCall,g.callAgent,g.telemetryLogManager,m)}_sendFeatureUsage(g,m){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:g,featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m}},this._telemetryLogManager,this._logger)}dispose(){this.disposed||super.dispose()}}class PPTLiveCallImplOverTsCall{constructor(g){this._isActive=!1,this._updateIsActive=g=>this._isActive!==g&&(this._isActive=g,this._logger.info(`Updating isActive to ${g}`),!0),this._eventEmitter=g,this._target=document.createElement("div"),this._target.style.width="100%",this._target.style.height="100%"}initialize(g,m,f,S){this._logger=S.createChild((()=>`PPTLive::Call(id='${g.callId}')`)),this._tsCall=g,this._internalCallAgent=m,this._telemetryLogManager=f,this._tsCall.on("contentSharingChanged",(()=>{this._checkContentSharingSession(this._tsCall.contentSharingSessions)})),this._tsCall.on("callStateChanged",(()=>{this._updatePPTLive(this._tsCall.state)}))}get isActive(){return this._isActive}get target(){return this._target}_checkContentSharingSession(g){if(this._contentSharing&&0===g.length)this._updateIsActive(!1),this._contentSharing=void 0,this._target.innerHTML="",this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("endedPPTLive",Lh.success);else if(!this._contentSharing&&0!==g.length){if(!getAcsEcsConfig().calling.pptlive.enabled)return;this._contentSharing=new ContentSharingSession(g[0]),this._updatePPTLive(this._tsCall.state),this._sendFeatureUsage("startedPPTLive",Lh.attempt,this._contentSharing?.contentSharingSession?.contentSharingGuid)}}async _updatePPTLive(g){this._fileDetails=this._contentSharing?.getFileDetails(),this._fileDetails&&"ppt"===this._fileDetails.type&&3===g&&await this._startPPTLive(this._target)}_sendFeatureUsage(g,m,f){sendCallFeatureUsageTelemetry({callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"PPTLive",featureType:"Call",initializationType:"OnFeatureAccess",featureDetails:{name:g,step:m},additionalDetails:{pptLiveConstraint:{contentId:f}}},this._telemetryLogManager,this._logger)}_initViewerWithExperiment(g,m,f,S,v,C,_,E,T,I,b,A,P,R,w){const M={getAuthTokenAsync:!1,getForceRefreshedTokenAsync:!1},D=window.Microsoft,OnInitSuccess=g=>{g.GoToSlide(m,[],""),this._sendFeatureUsage("startedPPTLive",Lh.success,this._contentSharing?.contentSharingSession?.contentSharingGuid)},OnInitFailure=g=>{var m="Category: "+g.Category+"\nMessage: "+g.Message+"\nExtraInfo: "+g.ExtraInfo;this._sendFeatureUsage("startedPPTLive",Lh.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid),this._logger.error(m)},O=getAcsEcsConfig().calling.pptlive,N={entryPoint:"null"},k={Container:g,SessionInformation:{DocumentClickTime:new Date,HostInitTime:new Date,UiLocale:A,DataLocale:A,IsPresenter:!1,WdParams:{wdModernSlideShowInTeams:O.wdParams.wdModernSlideShowInTeams,wdPresenterViewInTeams:O.wdParams.wdPresenterViewInTeams,wdForceModernSlideShowInTeams:O.wdParams.wdForceModernSlideShowInTeams,isMovePrivateViewingToPPTEnabled:O.wdParams.isMovePrivateViewingToPPTEnabled},PptFeatureGates:O.featureGates,ParticipantId:E,EnableStateServiceInPreviewerFeatures:JSON.parse(O.enableStateServiceInPreviewerFeatures),StateServiceSettings:{stateServiceProxySettings:O.stateServiceProxySettings,regionalEndpointUrl:this._getEndpointUrl(),authEnabled:!1,rosterCheckEnabled:!1,stateServiceUser:M},ContentId:P,EndpointId:_,CallId:R,HostName:"ACSWeb",HostSessionId:T},WopiPrecheckInfo:{FileName:S,FileGetUrl:C,FileSize:v,CustomFontCatalogUrl:w,BundleInfo:{MajorVersion:f,Url:I},CreateNewInfo:null},ApplicationCustomSettings:{TakeFocusOnBoot:O.appSettings.takeFocusOnBoot,EnableAdvanceOnClick:O.appSettings.enableAdvanceOnClick,EnableAdvanceOnTap:O.appSettings.enableAdvanceOnTap},Diagnostics:N,FnOnInitializeSuccess:OnInitSuccess,FnOnInitializeFailure:OnInitFailure};b&&(k.ApplicationCustomSettings.EnableWacFallback=!1,k.ApplicationUrl=b),D.Office.PowerPoint.Bootstrap.Prefetch(),D.Office.PowerPoint.Bootstrap.InitializeWopiPending(k),this._updateIsActive(!0),this._eventEmitter.emit("isActiveChanged"),this._sendFeatureUsage("startedPPTLive",Lh.initialize,this._contentSharing?.contentSharingSession?.contentSharingGuid)}async _startPPTLive(g){this._fileDetails?.bootstrapperUrl&&await this._loadDynamicModule(this._fileDetails.bootstrapperUrl).then((()=>{this._fileDetails&&this._initViewerWithExperiment(g,Number(this._contentSharing?.contentSharingSession?.contentSharingState),this._fileDetails.majorVersion,this._fileDetails.name,this._fileDetails.fileSize,this._fileDetails.fileGetUrl,this._tsCall.endpointId,this._tsCall.participantId,generateGuid(),this._fileDetails.contentBundleUrl,this._fileDetails.wacUrl,navigator.language,this._fileDetails.id,this._tsCall.callId,this._fileDetails.customFontCatalogUrl)})).catch((()=>{this._sendFeatureUsage("startedPPTLive",Lh.failure,this._contentSharing?.contentSharingSession?.contentSharingGuid)}))}_getEndpointUrl(){const g=this._internalCallAgent._caConfigBag,m=g&&isEudbConfigurationsApplicable(g.identityType,g.region);let f=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer;switch(g?.cloudType){case ca.Public:m&&(f=getAcsEcsConfig().PowerPointStateServiceUrl.public.eu);break;case ca.GccHigh:f=getAcsEcsConfig().PowerPointStateServiceUrl.gcch;break;case ca.AirGap08:f=getAcsEcsConfig().PowerPointStateServiceUrl.ag08;break;case ca.AirGap09:f=getAcsEcsConfig().PowerPointStateServiceUrl.ag09;break;case ca.Dod:f=getAcsEcsConfig().PowerPointStateServiceUrl.dod;break;default:f=getAcsEcsConfig().PowerPointStateServiceUrl.public.amer}return f}async _loadDynamicModule(g){return new Function(`return (async () => await import('${g}'))()`)()}}const am={Recording:callFeatureFactory(RecordingCallFeatureImpl),Transfer:callFeatureFactory(TransferCallFeatureImpl),Transcription:callFeatureFactory(TranscriptionCallFeatureImpl),Captions:callFeatureFactory(CaptionsCallFeatureImpl),RaiseHand:callFeatureFactory(RaiseHandCallFeatureImpl),LocalRecording:callFeatureFactory(LocalRecordingCallFeatureImpl),Reaction:callFeatureFactory(ReactionFeatureImpl),Spotlight:callFeatureFactory(SpotlightCallFeatureImpl),PPTLive:callFeatureFactory(PPTLiveCallFeatureImpl),Capabilities:callFeatureFactory(CapabilitiesFeatureImpl),DominantSpeakers:callFeatureFactory(DominantSpeakersCallFeatureImpl),LiveStream:callFeatureFactory(LiveStreamCallFeatureImpl),ComposedStream:callFeatureFactory(ComposedStreamCallFeatureImpl),CallSurvey:callFeatureFactory(CallSurveyFeatureImpl),UserFacingDiagnostics:callFeatureFactory(UserFacingDiagnosticsFeatureImpl),MediaStats:callFeatureFactory(MediaStatsCallFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}),DebugInfo:callClientFeatureFactory(DebugInfoCallClientFeatureImpl,{activationEvent:"OnExtendedObjectConstructor"}),PreCallDiagnostics:callClientFeatureFactory(PreCallDiagnosticsFeatureImpl),VideoEffects:videoStreamFeatureFactory(VideoEffectsFeatureImpl),AudioEffects:audioStreamFeatureFactory(AudioEffectsFeatureImpl),DataChannel:callFeatureFactory(DataChannelCallFeatureImpl),OptimalVideoCount:callFeatureFactory(OptimalVideoCountCallFeatureImpl),UnmixedAudio:callFeatureFactory(UnmixedAudioCallFeatureImpl),AudioZones:callFeatureFactory(AudioZonesCallFeatureImpl),TeamsMeetingAudioConferencing:callFeatureFactory(TeamsMeetingAudioConferencingCallFeatureImpl)};function getRegisteredFeatures(g){switch(g){case Pu.CallClientFeature:return Object.entries(am).filter((g=>!0===g[1].isCallClientFeature)).map((g=>g[1]));case Pu.CallAgentFeature:return Object.entries(am).filter((g=>!0===g[1].isCallAgentFeature)).map((g=>g[1]));case Pu.CallFeature:return Object.entries(am).filter((g=>!0===g[1].isCallFeature)).map((g=>g[1]))}}class CallStats{constructor(g,m){this._eventBag=[],this.resetEventBag=()=>{this._eventBag=[]},this._logger=g.createChild("CallStats"),this._telemetryLogManager=m}recordEvent(g){try{if(getAcsEcsConfig()?.telemetry?.callStatsFlushTimeout<0)return;if(getAcsEcsConfig()?.telemetry?.blockedEvents?.indexOf(g.name)>-1)return;const m={...g,timestamp:+new Date};this._logger.debug(`CallStat recorded=${g.name}`),this._eventBag.push(m),this.scheduleTelemtryFlush()}catch(g){this._logger.debug("Failed to record call stats")}}flushEvents(){if(this._logger.debug(`CallStats sending telemetry, number of events=${this._eventBag.length}`),0!==this._eventBag.length)try{const g=this._eventBag.reduce(((g,m)=>(g[m.localParticipantId]?g[m.localParticipantId].events.push({name:m.name,timestamp:m.timestamp,...m.data}):g[m.localParticipantId]={callId:m.callId,localParticipantId:m.localParticipantId,events:[{name:m.name,timestamp:m.timestamp,...m.data}]},g)),{});Object.keys(g).forEach((m=>{this._telemetryLogManager.sendEvent({name:kh.acs_calling_call_stats,tenant:so,properties:{...g[m]}})})),this.resetEventBag()}catch(g){this._logger.debug("Failed to send call stats")}}scheduleTelemtryFlush(){this._callStatSendTimeout||(this._callStatSendTimeout=window.setTimeout((()=>{this.flushEvents(),this._callStatSendTimeout=void 0}),getAcsEcsConfig().telemetry.callStatsFlushTimeout))}}var __decorate$9=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$9=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteAudioStreamImpl{constructor(m,f,S,v){const C=g("ACS-calling");this.logger=new DefaultLogger(C,[()=>"RemoteAudioStream for media stream"]),this._source=m,this._disposed=!1,this._volumeIndicator=new VolumeImpl(this.logger,"RemoteAudioStream",f,S,v),this.logger.info("created")}async getMediaStream(){return await this._source.getMediaStream()}get source(){return this._source}dispose(){this.logger.log("dispose"),this._disposed?this.logger.log("already disposed"):(this._source?.dispose(),this._volumeIndicator.dispose(),this._disposed=!0)}async getVolume(){return this._volumeIndicator.isInitialized?this._volumeIndicator:this._volumeIndicator.getVolumeIndicator(await this.getMediaStream())}}__decorate$9([loggerProperty,__metadata$9("design:type",Object)],RemoteAudioStreamImpl.prototype,"logger",void 0);var om=createCommonjsModule((function(g,m){!function(f,S){var v="1.0.33",C="",_="?",E="function",T="undefined",I="object",b="string",A="major",P="model",R="name",w="type",M="vendor",D="version",O="architecture",N="console",k="mobile",L="tablet",F="smarttv",x="wearable",U="embedded",V=350,B="Amazon",H="Apple",$="ASUS",G="BlackBerry",j="Browser",W="Chrome",q="Firefox",z="Google",K="Huawei",J="LG",Y="Microsoft",Q="Motorola",X="Opera",Z="Samsung",ee="Sharp",te="Sony",ie="Xiaomi",ne="Zebra",re="Facebook",extend=function(g,m){var f={};for(var S in g)m[S]&&m[S].length%2==0?f[S]=m[S].concat(g[S]):f[S]=g[S];return f},enumerize=function(g){for(var m={},f=0;f<g.length;f++)m[g[f].toUpperCase()]=g[f];return m},has=function(g,m){return typeof g===b&&-1!==lowerize(m).indexOf(lowerize(g))},lowerize=function(g){return g.toLowerCase()},majorize=function(g){return typeof g===b?g.replace(/[^\d\.]/g,C).split(".")[0]:S},trim=function(g,m){if(typeof g===b)return g=g.replace(/^\s\s*/,C),typeof m===T?g:g.substring(0,V)},rgxMapper=function(g,m){for(var f,v,C,_,T,b,A=0;A<m.length&&!T;){var P=m[A],R=m[A+1];for(f=v=0;f<P.length&&!T;)if(T=P[f++].exec(g))for(C=0;C<R.length;C++)b=T[++v],typeof(_=R[C])===I&&_.length>0?2===_.length?typeof _[1]==E?this[_[0]]=_[1].call(this,b):this[_[0]]=_[1]:3===_.length?typeof _[1]!==E||_[1].exec&&_[1].test?this[_[0]]=b?b.replace(_[1],_[2]):S:this[_[0]]=b?_[1].call(this,b,_[2]):S:4===_.length&&(this[_[0]]=b?_[3].call(this,b.replace(_[1],_[2])):S):this[_]=b||S;A+=2}},strMapper=function(g,m){for(var f in m)if(typeof m[f]===I&&m[f].length>0){for(var v=0;v<m[f].length;v++)if(has(m[f][v],g))return f===_?S:f}else if(has(m[f],g))return f===_?S:f;return g},se={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},ae={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[D,[R,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[D,[R,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[R,D],[/opios[\/ ]+([\w\.]+)/i],[D,[R,X+" Mini"]],[/\bopr\/([\w\.]+)/i],[D,[R,X]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[R,D],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[D,[R,"UC"+j]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[D,[R,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[D,[R,"WeChat"]],[/konqueror\/([\w\.]+)/i],[D,[R,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[D,[R,"IE"]],[/yabrowser\/([\w\.]+)/i],[D,[R,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[R,/(.+)/,"$1 Secure "+j],D],[/\bfocus\/([\w\.]+)/i],[D,[R,q+" Focus"]],[/\bopt\/([\w\.]+)/i],[D,[R,X+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[D,[R,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[D,[R,"Dolphin"]],[/coast\/([\w\.]+)/i],[D,[R,X+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[D,[R,"MIUI "+j]],[/fxios\/([-\w\.]+)/i],[D,[R,q]],[/\bqihu|(qi?ho?o?|360)browser/i],[[R,"360 "+j]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[R,/(.+)/,"$1 "+j],D],[/(comodo_dragon)\/([\w\.]+)/i],[[R,/_/g," "],D],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[R,D],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[R],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[R,re],D],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[R,D],[/\bgsa\/([\w\.]+) .*safari\//i],[D,[R,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[D,[R,W+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[R,W+" WebView"],D],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[D,[R,"Android "+j]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[R,D],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[D,[R,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[D,R],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[R,[D,strMapper,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[R,D],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[R,"Netscape"],D],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[D,[R,q+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[R,D],[/(cobalt)\/([\w\.]+)/i],[R,[D,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[O,"amd64"]],[/(ia32(?=;))/i],[[O,lowerize]],[/((?:i[346]|x)86)[;\)]/i],[[O,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[O,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[O,"armhf"]],[/windows (ce|mobile); ppc;/i],[[O,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[O,/ower/,C,lowerize]],[/(sun4\w)[;\)]/i],[[O,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[O,lowerize]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[P,[M,Z],[w,L]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[P,[M,Z],[w,k]],[/\((ip(?:hone|od)[\w ]*);/i],[P,[M,H],[w,k]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[P,[M,H],[w,L]],[/(macintosh);/i],[P,[M,H]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[P,[M,K],[w,L]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[P,[M,K],[w,k]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[P,/_/g," "],[M,ie],[w,k]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[P,/_/g," "],[M,ie],[w,L]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[P,[M,"OPPO"],[w,k]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[P,[M,"Vivo"],[w,k]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[P,[M,"Realme"],[w,k]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[P,[M,Q],[w,k]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[P,[M,Q],[w,L]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[P,[M,J],[w,L]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[P,[M,J],[w,k]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[P,[M,"Lenovo"],[w,L]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[P,/_/g," "],[M,"Nokia"],[w,k]],[/(pixel c)\b/i],[P,[M,z],[w,L]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[P,[M,z],[w,k]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[P,[M,te],[w,k]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[P,"Xperia Tablet"],[M,te],[w,L]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[P,[M,"OnePlus"],[w,k]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[P,[M,B],[w,L]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[P,/(.+)/g,"Fire Phone $1"],[M,B],[w,k]],[/(playbook);[-\w\),; ]+(rim)/i],[P,M,[w,L]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[P,[M,G],[w,k]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[P,[M,$],[w,L]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[P,[M,$],[w,k]],[/(nexus 9)/i],[P,[M,"HTC"],[w,L]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony(?!-bra))[-_ ]?([-\w]*)/i],[M,[P,/_/g," "],[w,k]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[P,[M,"Acer"],[w,L]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[P,[M,"Meizu"],[w,k]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[P,[M,ee],[w,k]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[M,P,[w,k]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[M,P,[w,L]],[/(surface duo)/i],[P,[M,Y],[w,L]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[P,[M,"Fairphone"],[w,k]],[/(u304aa)/i],[P,[M,"AT&T"],[w,k]],[/\bsie-(\w*)/i],[P,[M,"Siemens"],[w,k]],[/\b(rct\w+) b/i],[P,[M,"RCA"],[w,L]],[/\b(venue[\d ]{2,7}) b/i],[P,[M,"Dell"],[w,L]],[/\b(q(?:mv|ta)\w+) b/i],[P,[M,"Verizon"],[w,L]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[P,[M,"Barnes & Noble"],[w,L]],[/\b(tm\d{3}\w+) b/i],[P,[M,"NuVision"],[w,L]],[/\b(k88) b/i],[P,[M,"ZTE"],[w,L]],[/\b(nx\d{3}j) b/i],[P,[M,"ZTE"],[w,k]],[/\b(gen\d{3}) b.+49h/i],[P,[M,"Swiss"],[w,k]],[/\b(zur\d{3}) b/i],[P,[M,"Swiss"],[w,L]],[/\b((zeki)?tb.*\b) b/i],[P,[M,"Zeki"],[w,L]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[M,"Dragon Touch"],P,[w,L]],[/\b(ns-?\w{0,9}) b/i],[P,[M,"Insignia"],[w,L]],[/\b((nxa|next)-?\w{0,9}) b/i],[P,[M,"NextBook"],[w,L]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[M,"Voice"],P,[w,k]],[/\b(lvtel\-)?(v1[12]) b/i],[[M,"LvTel"],P,[w,k]],[/\b(ph-1) /i],[P,[M,"Essential"],[w,k]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[P,[M,"Envizen"],[w,L]],[/\b(trio[-\w\. ]+) b/i],[P,[M,"MachSpeed"],[w,L]],[/\btu_(1491) b/i],[P,[M,"Rotor"],[w,L]],[/(shield[\w ]+) b/i],[P,[M,"Nvidia"],[w,L]],[/(sprint) (\w+)/i],[M,P,[w,k]],[/(kin\.[onetw]{3})/i],[[P,/\./g," "],[M,Y],[w,k]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[P,[M,ne],[w,L]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[P,[M,ne],[w,k]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[M,P,[w,N]],[/droid.+; (shield) bui/i],[P,[M,"Nvidia"],[w,N]],[/(playstation [345portablevi]+)/i],[P,[M,te],[w,N]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[P,[M,Y],[w,N]],[/smart-tv.+(samsung)/i],[M,[w,F]],[/hbbtv.+maple;(\d+)/i],[[P,/^/,"SmartTV"],[M,Z],[w,F]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[M,J],[w,F]],[/(apple) ?tv/i],[M,[P,H+" TV"],[w,F]],[/crkey/i],[[P,W+"cast"],[M,z],[w,F]],[/droid.+aft(\w)( bui|\))/i],[P,[M,B],[w,F]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[P,[M,ee],[w,F]],[/(bravia[\w ]+)( bui|\))/i],[P,[M,te],[w,F]],[/(mitv-\w{5}) bui/i],[P,[M,ie],[w,F]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[M,trim],[P,trim],[w,F]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[w,F]],[/((pebble))app/i],[M,P,[w,x]],[/droid.+; (glass) \d/i],[P,[M,z],[w,x]],[/droid.+; (wt63?0{2,3})\)/i],[P,[M,ne],[w,x]],[/(quest( 2)?)/i],[P,[M,re],[w,x]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[M,[w,U]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[P,[w,k]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[P,[w,L]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[w,L]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[w,k]],[/(android[-\w\. ]{0,9});.+buil/i],[P,[M,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[D,[R,"Edge"+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[D,[R,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[R,D],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[D,R]],os:[[/microsoft (windows) (vista|xp)/i],[R,D],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[R,[D,strMapper,se]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[R,"Windows"],[D,strMapper,se]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[D,/_/g,"."],[R,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[R,"Mac OS"],[D,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[D,R],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[R,D],[/\(bb(10);/i],[D,[R,G]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[D,[R,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[D,[R,q+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[D,[R,"webOS"]],[/crkey\/([\d\.]+)/i],[D,[R,W+"cast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[R,"Chromium OS"],D],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[R,D],[/(sunos) ?([\w\.\d]*)/i],[[R,"Solaris"],D],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[R,D]]},UAParser=function(g,m){if(typeof g===I&&(m=g,g=S),!(this instanceof UAParser))return new UAParser(g,m).getResult();var v=g||(typeof f!==T&&f.navigator&&f.navigator.userAgent?f.navigator.userAgent:C),_=m?extend(ae,m):ae;return this.getBrowser=function(){var g={};return g[R]=S,g[D]=S,rgxMapper.call(g,v,_.browser),g.major=majorize(g.version),g},this.getCPU=function(){var g={};return g[O]=S,rgxMapper.call(g,v,_.cpu),g},this.getDevice=function(){var g={};return g[M]=S,g[P]=S,g[w]=S,rgxMapper.call(g,v,_.device),g},this.getEngine=function(){var g={};return g[R]=S,g[D]=S,rgxMapper.call(g,v,_.engine),g},this.getOS=function(){var g={};return g[R]=S,g[D]=S,rgxMapper.call(g,v,_.os),g},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return v},this.setUA=function(g){return v=typeof g===b&&g.length>V?trim(g,V):g,this},this.setUA(v),this};UAParser.VERSION=v,UAParser.BROWSER=enumerize([R,D,A]),UAParser.CPU=enumerize([O]),UAParser.DEVICE=enumerize([P,M,w,N,k,F,L,x,U]),UAParser.ENGINE=UAParser.OS=enumerize([R,D]),g.exports&&(m=g.exports=UAParser),m.UAParser=UAParser;var oe=typeof f!==T&&(f.jQuery||f.Zepto);if(oe&&!oe.ua){var le=new UAParser;oe.ua=le.getResult(),oe.ua.get=function(){return le.getUA()},oe.ua.set=function(g){le.setUA(g);var m=le.getResult();for(var f in m)oe.ua[f]=m[f]}}}("object"==typeof window?window:C)}));const lm=[{name:"edge",engine:"Edge",key:"Edge"},{name:"edgeanaheim",engine:"Chromium",key:"Edg"},{name:"chromium",engine:"Chromium",key:"Chromium"},{name:"opera",engine:"Chromium",key:"OPR"},{name:"yandexbrowser",engine:"Chromium",key:"YaBrowser"},{name:"electron",engine:"Chromium",key:"Electron"},{name:"chrome",engine:"Chromium",key:"Chrome"},{name:"firefox",engine:"Firefox",key:"Firefox"},{name:"safari",engine:"Safari",key:"Safari"},{name:"applewebview",engine:"Safari",key:"Mac OS X"},{name:"ie",engine:"MSIE",key:"Trident"}],cm="0.0",dm="unknown";function getFormFactor(g){return/iPhone|iPad|iPod|Android|Mobi/i.test(g)?"Mobile":"Desktop"}function isAndroid(g){const m=!/like android/i.test(g),f=/android/i.test(g);return m&&f}let hm=new om.UAParser;function getEnvironmentDetails(){hm||(hm=new om.UAParser);return hm.getResult()}function getPlatformName(){const g=getEnvironmentDetails().ua;return-1!==g.indexOf("Edge")?"edge":-1!==g.indexOf("Electron")?"electron":-1!==g.indexOf("Chrome")?"chrome":-1!==g.indexOf("Firefox")?"firefox":-1!==g.indexOf("Safari")?"safari":-1!==g.indexOf("Mac OS X")?"applewebview":-1!==g.indexOf("Trident")?"ie":"unknown"}function updateBrowserName(g,m){return"edge"!==g&&"edgeanaheim"!==g||((m.includes("Edg/")||m.includes("EdgA/")||m.includes("EdgiOS/"))&&(g="edgeanaheim"),m.includes("Edge/")&&(g="edge")),g}function getBrowserName(g,m){const f=m.find((({key:m})=>g.includes(m)));if(!f)return dm;let S=f.name;return S=updateBrowserName(S,getEnvironmentDetails().ua),S}function updateBrowserEngine(g,m){const f=getOS();return"chrome"===g&&"ios"===f&&(m="Safari"),m}function getBrowserEngine(g,m){const f=m.find((({name:m})=>m===g));if(!f)return dm;let S=f.engine;return S=updateBrowserEngine(g,S),S}function getBrowserVersion(){const g=getEnvironmentDetails();return"WebKit"===g.browser.name&&-1!==g.ua.indexOf("Mac OS X")?g.os.version??cm:void 0!==g.browser.version?g.browser.version:cm}function getBrowserInfo(){const g=getEnvironmentDetails(),m=g.ua,f=getBrowserName(g.browser.name,lm);return{name:f,engine:getBrowserEngine(f,lm),version:getBrowserVersion(),formFactor:getFormFactor(m)}}function getOS(){const g=getEnvironmentDetails().ua;return/windows phone/i.test(g)?"windowsphone":/windows /i.test(g)?"windows":/macintosh/i.test(g)?"mac":/(ipod|iphone|ipad)/i.test(g)?"ios":isAndroid(g)?"android":/(web|hpw)[o0]s/i.test(g)?"webos":/tizen/i.test(g)?"tizen":/headlesschrome(?:\/([\w\.]+)| )/i.test(g)?"headlesschrome":/linux/i.test(g)?"linux":/CrOS/.test(g)?"chrome":"other"}function getInternalEnvInfo(){const g=getBrowserInfo();return`${`os=${getOS()};`} ${`osVer=${getOSVersion()};`} ${`browser=${g.name};`} ${`browserVer=${g.version};`} ${`formFactor=${g.formFactor};`}`}function getOSVersion(){const g=getEnvironmentDetails();return void 0!==g.os.version?g.os.version:cm}function isDigitMade(g){return/^\d+$/.test(g)}function checkVersionSupport(g,f){g=g.replace(/,/g,".").trim(),f=f.replace(/,/g,".").trim();let S=g.split("."),v=f.split("."),C=0;try{if(!S.every(isDigitMade)||!v.every(isDigitMade))return-2;for(;S.length<v.length;)S.push("0");for(;v.length<S.length;)v.push("0");let g=S.map(Number),m=v.map(Number);for(var _=0;_<g.length;_++)if(g[_]!==m[_]){if(g[_]>m[_])return 1;if(g[_]<m[_])return-1}}catch(g){m.log(`Error in browser check version support: ${g}`)}return C}function checkOsSupport(g){let m=getAcsEcsConfig()?.environments;return!!m.hasOwnProperty(g)}function checkOsBrowserSupport(g,m){let f=getAcsEcsConfig()?.environments;return!(!checkOsSupport(g)||!f[g].hasOwnProperty(m))&&f[g][m].isSupportedOnSdkVersion}function getMinBrowserVersion(g,m){let f=getAcsEcsConfig()?.environments;return f.hasOwnProperty(g)&&f[g].hasOwnProperty(m)?f[g][m].minVersion:cm}function getEnvironmentInfos(){let g,m,f=!1;const S=getEnvironmentDetails(),v=getOS(),C=getBrowserInfo().name,_=getBrowserInfo().version,E=checkOsSupport(v),T=checkOsBrowserSupport(v,C);if(T){checkVersionSupport(_,getMinBrowserVersion(v,C))>=0&&(f=!0)}return m={platform:S.os.name,browser:S.browser.name,browserVersion:S.browser.version},g={environment:m,isSupportedPlatform:E,isSupportedBrowser:T,isSupportedBrowserVersion:f,isSupportedEnvironment:E&&T&&f},g}var __decorate$a=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$a=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class MediaConstraintsManager{get currentVideoConstraints(){return this._currentVideoConstraints}constructor(g,m,f){this._tsCall=g,this._currentVideoConstraints={send:{frameHeight:{max:void 0},frameRate:{max:void 0},bitrate:{max:void 0}}},this._logger=m.createChild("MediaConstraintsManager"),this._telemetryLogManager=f}async setVideoConstraints(g,m,f,S){const v=this.getTelemetryPayload({video:g}),sendSuccessOrFailureTelemetryEvent=g=>{let v=g?{failureReason:g?g.message:void 0,code:g?g.code:void 0,...extractCommunicationServicesErrorForTelemetry(g)}:void 0;sendCallFeatureUsageTelemetry({correlationId:f,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:{deltaTimeInMs:+new Date-S},featureDetails:{name:"setConstraints",step:g?Lh.failure:Lh.success,stage:m},additionalDetails:{constraints:this.getTelemetryPayload({video:this._currentVideoConstraints}),...v}},this._telemetryLogManager,this._logger)};try{sendCallFeatureUsageTelemetry({correlationId:f,callId:this._tsCall.callId,localParticipantId:this._tsCall.participantId,featureName:"SetConstraints",featureType:"Call",initializationType:"None",timestampInfo:"",featureDetails:{name:"setConstraints",step:Lh.attempt,stage:m},additionalDetails:{constraints:v}},this._telemetryLogManager,this._logger);if(!getAcsEcsConfig().calling.constraints.enabled)throw this._logger.error("Setting call constraints is disabled"),new CallingCommunicationError(z.CALL.MEDIA_CONSTRAINTS_DISABLED);this._updateVideoConstraintsCache(g);const S={outgoingVideoLimit:{maxResolution:this._currentVideoConstraints.send?.frameHeight?.max,maxFramerate:this._currentVideoConstraints.send?.frameRate?.max,maxBitrate:this._currentVideoConstraints.send?.bitrate?.max}},C=this._tsCall.setCallConstraints?.(S);if("mid-call"!==m)C?.then((()=>{this._logger.info(`Successfully set call constraints at call ${m} - ${JSON.stringify(this._currentVideoConstraints)}`),sendSuccessOrFailureTelemetryEvent()})).catch((g=>{this._logger.error(`Error setting call constraints at call ${m}`);const f=new CallingCommunicationError(z.CALL.SET_CONSTRAINTS_START_OR_ACCEPT(m),g);sendSuccessOrFailureTelemetryEvent(f)}));else try{await C,this._logger.info(`Successfully set call constraints during ${m} - ${JSON.stringify(this._currentVideoConstraints)}`),sendSuccessOrFailureTelemetryEvent()}catch(g){throw new CallingCommunicationError(z.CALL.SET_CONSTRAINTS_MID_CALL,g)}return this._currentVideoConstraints}catch(g){const f=new CallingCommunicationError(z.CALL.SET_CONSTRAINTS(m),g);throw sendSuccessOrFailureTelemetryEvent(f),f}}getTelemetryPayload(g){return{video:{send:{frameHeight:{max:g.video?.send?.frameHeight?.max},frameRate:{max:g.video?.send?.frameRate?.max},bitrate:{max:g.video?.send?.bitrate?.max}}}}}_updateVideoConstraintsCache(g){const m=getAcsEcsConfig(),f=m.calling.constraints.maxOutgoingResolution,S=m.calling.constraints.maxOutgoingFrameRate,v=m.calling.constraints.maxOutgoingVideoBitrate,C=g?.send?.frameHeight?.max??this._currentVideoConstraints.send?.frameHeight?.max,_=g?.send?.frameRate?.max??this._currentVideoConstraints.send?.frameRate?.max,E=g?.send?.bitrate?.max??this._currentVideoConstraints.send?.bitrate?.max;this._currentVideoConstraints={send:{frameHeight:{max:this._getConstraintValue(f,"maxOutgoingResolution",C)},frameRate:{max:this._getConstraintValue(S,"maxOutgoingFrameRate",_)},bitrate:{max:this._getConstraintValue(v,"maxOutgoingBitrate",E)}}}}_getConstraintValue(g,m,f){return"number"==typeof f?f<1?void this._logger.info(`Received ${m} as 0 or less, removing ${m} constraint`):(g>0&&f>g&&(this._logger.info(`${m} value ${f} is larger than ${g}, resetting to ${g}`),f=g),f):void this._logger.warn(`Received invalid ${m} value, removing ${m} constraint`)}}__decorate$a([loggerProperty,__metadata$a("design:type",Object)],MediaConstraintsManager.prototype,"_logger",void 0);var __decorate$b=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$b=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LobbyImpl{constructor(g,m,f,S){this.logger=f.createChild("Lobby"),this._tsCall=g,this._eventEmitter=new CallingEventEmitter(this.logger),this._participants=new Map,this._call=m,this._telemetryLogManager=S,this._lobbySupportedConversationTypes=getAcsEcsConfig().calling.lobbyAdmitAndReject.supportedConversationTypes,this._isLobbyEnabled=getAcsEcsConfig().calling.lobbyAdmitAndReject.enabled,this._hasExpectedError=!1,this._isLobbyEnabled&&(this.getInLobbyParticipants(m.remoteParticipants),this._remoteParticipantUpdatedListener=g=>{if(0!==g.added.length&&g.added.forEach((g=>{"InLobby"===g.state&&this.addLobbyParticipant(g),g.on("stateChanged",(()=>{"InLobby"===g.state?this.addLobbyParticipant(g):"Connected"===g.state&&this.removeLobbyParticipant(g)}))})),0!==g.removed.length){if(0===this._call.remoteParticipants.length)return void this.removeAllLobbyParticipants();g.removed.forEach((g=>{this.removeLobbyParticipant(g)}))}},this._call.on("remoteParticipantsUpdated",this._remoteParticipantUpdatedListener))}on(g,m){if("lobbyParticipantsUpdated"!==g)throw new CallingCommunicationError(z.LOBBY.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("lobbyParticipantsUpdated"!==g)throw new CallingCommunicationError(z.LOBBY.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}async admit(g,m){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const f=generateGuid(),S=+new Date;this._sendLobbyAdmitAndRejectUsage("Start admit participant",Fh.lobbyAdmit,f,Lh.attempt,void 0);try{validateIdentifier(g),this.validateLobbyOperation(g),await this._tsCall.admitParticipant(getMriFromIdentifier(g));const m=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant admitted successfully",Fh.lobbyAdmit,f,Lh.success,m-S)}catch(g){let m=Uh.Unexpected;this._hasExpectedError&&(m=Uh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit participant from lobby",g,f,S,Fh.lobbyAdmit,m)}}async reject(g,m){if(!this._isLobbyEnabled)return void this.logger.warn("Lobby is not enabled");const f=generateGuid(),S=+new Date;this._sendLobbyAdmitAndRejectUsage("Start reject participant",Fh.lobbyReject,f,Lh.attempt,void 0);try{validateIdentifier(g),this.validateLobbyOperation(g),await this._tsCall.removeParticipant(getMriFromIdentifier(g));const m=+new Date;this._sendLobbyAdmitAndRejectUsage("Lobby participant rejected successfully",Fh.lobbyReject,f,Lh.success,m-S)}catch(g){let m=Uh.Unexpected;this._hasExpectedError&&(m=Uh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to reject participant from lobby",g,f,S,Fh.lobbyReject,m)}}async admitAll(g){const m=generateGuid(),f=+new Date;let S,v=0,C=0;if(!this._isLobbyEnabled)return this.logger.warn("Lobby is not enabled"),{successCount:v,failureCount:C};this._sendLobbyAdmitAndRejectUsage("Start admit all participants",Fh.lobbyAdmitAll,m,Lh.attempt,void 0);try{this.validateLobbyOperation(),await this._tsCall.admit({scope:"all"},w.generateCauseId()).then((g=>{if(S=g,g.result){const m=JSON.parse(g.result);v=m.successCount,C=m.failureCount}}));const g=+new Date;if(0!==C)return this._sendLobbyAdmitAndRejectUsage(`${v} participants are admitted successfully, ${C} participants admit failed. TransactionEnd: ${S}`,Fh.lobbyAdmitAll,m,Lh.success,g-f),{successCount:v,failureCount:C};this._sendLobbyAdmitAndRejectUsage("All participants are admitted successfully",Fh.lobbyAdmitAll,m,Lh.success,g-f)}catch(g){let S=Uh.Unexpected;this._hasExpectedError&&(S=Uh.Expected,this._hasExpectedError=!1),this.handleLobbyAdmitAndRejectFailure("Failed to admit all participants from lobby",g,m,f,Fh.lobbyAdmitAll,S)}return{successCount:v,failureCount:C}}get participants(){return this._isLobbyEnabled?Array.from(this._participants.values()):(this.logger.warn("Lobby is not enabled"),[])}getInLobbyParticipants(g){g.forEach((g=>{if("InLobby"===g.state){const m=getMriFromIdentifier(g.identifier);this._participants.set(m,g)}}))}removeAllLobbyParticipants(){if(0===this._participants.size)return;const g=Array.from(this._participants.values());this._participants.clear(),this.logger.info("All participants are removed from lobby"),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:g})}removeLobbyParticipant(g){const m=getMriFromIdentifier(g.identifier);this._participants.has(m)&&(this.logger.info(`${f(g.identifier).kind} is removed from lobby`),this._participants.delete(m),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[],removed:[g]}))}addLobbyParticipant(g){const m=getMriFromIdentifier(g.identifier);this._participants.has(m)||(this.logger.info(`${f(g.identifier).kind} is added to lobby`),this._participants.set(m,g),this._eventEmitter.emit("lobbyParticipantsUpdated",{added:[g],removed:[]}))}validateLobbyOperation(g){const m=this._tsCall.conversationType?this._tsCall.conversationType:"oneToOneCall";if(this.logger.info("Current conversation type is: ",m),!this._lobbySupportedConversationTypes.find((g=>g===m)))throw this._hasExpectedError=!0,new CallingCommunicationError(z.LOBBY.CONV_UNSUPPORTED);if(g){let m=this._call.remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(m&&"Connected"===m.state)throw this._hasExpectedError=!0,new CallingCommunicationError(z.LOBBY.ALREADY_IN_MEETING(f(g).kind));if(m&&"InLobby"!==m.state||!m)throw this._hasExpectedError=!0,new CallingCommunicationError(z.LOBBY.NOT_IN_LOBBY(f(g).kind))}if(this._call.role!==tl.Presenter&&this._call.role!==tl.Organizer&&this._call.role!==tl.Coorganizer)throw this._hasExpectedError=!0,new CallingCommunicationError(z.LOBBY.UNAUTHORIZED_ADMIT_REJECT)}handleLobbyAdmitAndRejectFailure(g,m,f,S,v,C){const _=+new Date,E=handleLobbyFailure(this.logger,m,g);throw this._sendLobbyAdmitAndRejectUsage(E.message,v,f,Lh.failure,_-S,C,m),E}_sendLobbyAdmitAndRejectUsage(g,m,f,S,v,C,_){S===Lh.failure?this.logger.error(g):this.logger.info(g),this.sendLobbyAdmitAndRejectEvent({eventName:kh.acs_calling_lobby_events,callId:this._call.id,localParticipantId:this._tsCall.participantId,correlationId:f,kindOfEvent:S,operation:m,isExpected:C??"",timestampInfo:v?{deltaTimeInMs:v}:"",additionalDetails:_?{failureReason:_.message,code:_.code,subCode:_.subCode,...extractCommunicationServicesErrorForTelemetry(_)}:""})}sendLobbyAdmitAndRejectEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send lobby admit and reject telemetry")}}}function getMmrRdpState(){const g=window.navigator.mediaDevices;if(g?.isRemote){const m=g?.MSRDC_MMR_Shim?.remoteObjectManager?.isConnected;if(!0===m)return"connected";if(!1===m)return"disconnected"}return""}function getMMRInfo(){const g=window.navigator.mediaDevices,m={isMMREnabled:g?.isRemote??!1};return m.isMMREnabled&&(g?.mmrClientVersion&&(m.mmrClientVersion=g.mmrClientVersion),g?.mmrExtensionVersion&&(m.mmrExtensionVersion=g.mmrExtensionVersion),g?.mmrHostVersion&&(m.mmrHostVersion=g.mmrHostVersion),g?.activityId&&(m.mmrActivityId=g.activityId),g?.connectionId&&(m.mmrConnectionId=g.connectionId),m.mmrRdpState=getMmrRdpState()),m}__decorate$b([loggerProperty,__metadata$b("design:type",Object)],LobbyImpl.prototype,"logger",void 0),__decorate$b([asyncOperation(Yh.LobbyAdmitParticipant),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object,Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"admit",null),__decorate$b([asyncOperation(Yh.LobbyRejectParticipant),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object,Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"reject",null),__decorate$b([asyncOperation(Yh.LobbyAdmitAll),__metadata$b("design:type",Function),__metadata$b("design:paramtypes",[Object]),__metadata$b("design:returntype",Promise)],LobbyImpl.prototype,"admitAll",null);class MmrRdpConnectionManager{constructor(g){this._lastState="",this._callback=g=>{const m=g?.detail?.state??"";m?m!==this._lastState&&(this._logger.info(`connection state is ${m}`),this._eventEmitter.emit("stateChange",m),this._lastState=m):this._logger.info("connection state is unknown")},this._logger=g.createChild("MmrRdpConnectionManager"),this._eventEmitter=new bu.EventEmitter;const m=window.navigator.mediaDevices;m?.isRemote&&(m?.addEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("listener registered"))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}get state(){return getMmrRdpState()}dispose(){const g=window.navigator.mediaDevices;g?.isRemote&&(g?.removeEventListener("rdpClientConnectionStateChanged",this._callback),this._logger.info("event listener unregistered")),this._eventEmitter.removeAllListeners()}}var __decorate$c=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$c=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteVideoStreamImpl extends RemoteVideoStreamCommonImpl{constructor(g,m,f,S,v,C,_){super(g,m,f,v,C,"RemoteVideoStream"),this._remoteParticipantIdentifier=_,this._isAvailable=!1,this.setIsAvailable=g=>{g!==this._isAvailable&&(this._isAvailable=!!g,this.logger.log(`isAvailable changed to ${this._isAvailable}`),this._eventEmitter.emit("isAvailableChanged",this._isAvailable),this.call.isHandlingLargeMeetingVideoRendering&&this.call.handleDominantSpeakersVideos(),super.sendRemoteVideoStreamTelemetry())};const handleIsAvailable=()=>{if("Video"===this.mediaStreamType&&f.isHandlingLargeMeetingVideoRendering){for(let g of f.getTopNDominantSpeakersWithVideoOn())if(this.tsStream.isAvailable&&getMriFromIdentifier(g.identifier)===getMriFromIdentifier(this._remoteParticipantIdentifier))return void this.setIsAvailable(!0);this.setIsAvailable(!1)}else this.setIsAvailable(this.tsStream.isAvailable)};this._streamChangedHandler=this.tsStream.changed((()=>{handleIsAvailable()})),handleIsAvailable()}on(g,m){if("isAvailableChanged"!==g&&"sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("isAvailableChanged"!==g&&"sizeChanged"!==g&&"isReceivingChanged"!==g)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}get isAvailable(){return this._isAvailable}async getMediaStream(){const g=generateGuid();let m=+new Date;const f={correlationId:g,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:Su.getMediaStream,mediaType:this.getMediaType(),streamType:fu.Remote,timestampInfo:{attemptTimestamp:m},kindOfEvent:Lh.attempt,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};this.sendMediaStreamEvent(f);try{if(!this.tsStream.getRawStream)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.GET_RAW_MEDIA_STREAM);if(!this.tsStream.isAvailable)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.STREAM_NOTAVAILABLE);const f=this.tsStream.getRawStream(),S=new Promise((async(g,m)=>{const S=setTimeout((()=>{v.dispose(),m(new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.SUBSCRIBE_MEDIA_STREAM_TIMEOUT))}),getAcsEcsConfig().rendering.remoteVideo.getMediaStreamTimeout),v=f.changed((()=>{tryToResolveGetStreamPromise()})),tryToResolveGetStreamPromise=async()=>{try{const m=await f.getMediaStream();if(!m)return void this.logger.warn("MediaStream is not yet ready.");clearTimeout(S),v.dispose(),g(m)}catch(g){this.logger.warn(`MediaStream is not yet ready, error=${g?.message||"unknown"}`)}};tryToResolveGetStreamPromise()})),v=await S,C=v.getVideoTracks()[0];if(!C)throw new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.GET_TRACK);const _=new Promise(((g,m)=>{const resolveUnmutedPromise=()=>{C.removeEventListener("unmute",resolveUnmutedPromise,!1),g()};C.addEventListener("unmute",resolveUnmutedPromise,!1),C.muted?setTimeout((()=>{C.removeEventListener("unmute",resolveUnmutedPromise,!1),m(new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.TRACK_UNMUTED_TIMEOUT))}),getAcsEcsConfig().rendering.remoteVideo.getMediaStreamTimeout):resolveUnmutedPromise()}));await _;const E={correlationId:g,additionalDetails:{remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},operation:Su.getMediaStream,mediaType:this.getMediaType(),streamType:fu.Remote,timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Lh.success,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};return this.sendMediaStreamEvent(E),v}catch(f){const S={correlationId:g,operation:Su.getMediaStream,mediaType:this.getMediaType(),streamType:fu.Remote,additionalDetails:{failureReason:f?.message||"",code:f.code||H,...extractCommunicationServicesErrorForTelemetry(f),remoteStreamMetadata:this.getStreamMetadata(),mediaSourceId:this.tsStream.mediaSourceId},timestampInfo:{deltaTimeInMs:+new Date-m},kindOfEvent:Lh.failure,localParticipantId:this.call.tsCall.participantId,callId:this.call.id};throw this.sendMediaStreamEvent(S),new CallingCommunicationError(z.REMOTE_VIDEO_STREAM.GET_MEDIA_STREAM,f)}}getStreamMetadata(){return{callId:this.call?.id,streamType:this.mediaStreamType,localParticipantId:this.call.tsCall.participantId,remoteParticipantId:this.remoteParticipantId,sourceId:this.id,source:"remote",rank:this.tsStream.rank,isAvailable:this.tsStream.isAvailable,isReceiving:this._isReceiving,isStreaming:this.tsStream.isStreaming,viewIdsRegistered:this._renderers.map((g=>g.viewId)).join(", "),height:this._size.height,width:this._size.width,isDisposed:this._disposed,optimalVideoCount:this.call?.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:this.call?.activeRemoteVideoStreamViews?.size||0}}dispose(){this.setIsAvailable(!1),super.dispose()}getMediaType(){return"ScreenSharing"===this.mediaStreamType?mu.ScreenSharingRaw:mu.VideoRaw}sendMediaStreamEvent(g){this.telemetryLogManager.sendEvent({name:kh.acs_calling_media_stream,tenant:so,properties:{timestampInfo:g.timestampInfo,correlationId:g.correlationId,additionalDetails:g.additionalDetails||"",kindOfEvent:g.kindOfEvent||"",mediaType:g.mediaType,streamType:g.streamType,operation:g.operation,localParticipantId:g.localParticipantId||"",callId:g.callId||""}})}}__decorate$c([asyncOperation(au.GetMediaStream),__metadata$c("design:type",Function),__metadata$c("design:paramtypes",[]),__metadata$c("design:returntype",Promise)],RemoteVideoStreamImpl.prototype,"getMediaStream",null);var __decorate$d=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$d=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let um=1;class RemoteStreamRenderer{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}get viewId(){return this._viewId}get size(){return{height:this._size.height,width:this._size.width}}constructor(g,m,f,S,v,C){this._target=g,this._viewId=m,this._videoStream=f,this._onDisposedCallback=v,this._eventEmitter=new bu.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!1,this._size={height:0,width:0},this._disposed=!1,this._handleTsRendererChanged=g=>{if(this.logger.debug(`rendering state is ${this._isRendering}, changed to ${this._tsRenderer?.isRendering}`),this._tsRenderer)if(this._tsRenderer.isRendering!==this._isRendering&&(this._isRendering=this._tsRenderer.isRendering,this._videoStream.updateIsReceiving(),this._isRendering&&this._renderingDeferred&&this._renderingDeferred.isPending()&&this._renderingDeferred.resolve(),g.log(`isRendering change to ${this._isRendering}`)),this._tsRenderer.isRendering){const g=this._tsRenderer.streamSize.height,m=this._tsRenderer.streamSize.width;g===this._size.height&&m===this._size.width||(this._size.height=g,this._size.width=m,this._videoStream.updateSize())}else this._size.height=0,this._size.width=0,this._videoStream.updateSize();this.sendRendererTelemetry()},this.sendRendererTelemetry=()=>{if(this._tsRenderer)try{const g={isRendering:this._tsRenderer.isRendering,streamWidth:this._tsRenderer.streamSize.width,streamHeight:this._tsRenderer.streamSize.height,isVideoAttached:this._target.isConnected,rendererWidth:this._target?.offsetWidth,rendererHeight:this._target?.offsetHeight};if(this.previousStats){if(shallowEqual(this.previousStats,g))return}else this.previousStats=g;this.previousStats=g;const m=this._videoStream.getStreamMetadata(),{callId:f,localParticipantId:S,isDisposed:v,viewIdsRegistered:C,height:_,width:E,...T}=m,I={...g,...T,viewId:this._viewId,disposed:this._disposed};this._videoStream.call.stats.recordEvent({name:Nh.remote_view,callId:f,localParticipantId:S,data:I})}catch(g){}},this._unsubscribeAvailabilityCallback=()=>{this._availableCallback&&("RemoteVideoStream"===this._videoStream.kind&&this._videoStream?.off("isAvailableChanged",this._availableCallback),this._availableCallback=void 0)},this._disposeTsRendererChangedObservable=()=>{this._tsRendererChanged&&(this._tsRendererChanged.dispose(),this._tsRendererChanged=void 0)},this._attemptToDisposeTsRenderer=()=>{if(this._tsRenderer){this.logger.debug("disposing underlying remote renderer");try{this._tsRenderer?.dispose(),this._tsRenderer=void 0}catch(g){throw this.logger.warn(`underlying remote renderer dispose failed with ${g?.message} error`),new CallingCommunicationError(z.VIEW.REMOTE_RENDERER_DISPOSE_FAIL)}}},this.logger=S.createChild("RemoteStreamRenderer"+um++),this.logger.log("created"),void 0!==C?.scalingMode&&(this._scalingMode=C.scalingMode),void 0!==C?.isMirrored&&(this._isMirrored=C.isMirrored),this._remoteStreamTelemetryEventSender=new StreamTelemetryEventSender(this._videoStream.telemetryLogManager)}async start(){const g=generateGuid(),m=+new Date,f=this.logger.createFnLogger(ou.Start),S={timestampInfo:{attemptTimestamp:m},correlationId:g,operation:Su.render,kindOfEvent:Lh.attempt,mediaType:this._videoStream.mediaStreamType,streamType:fu.Remote};if(this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(S),this._disposed)throw this.logger.warn("already disposed"),new CallingCommunicationError(z.VIEW.START_ALREADY_DISPOSED);try{f.info(`scalingMode=${toTsScalingMode(this._scalingMode)}`),this._videoStream.registerRenderer(this),this._renderingDeferred=defer$1(),this._renderingDeferred.promise.catch(noop),"RemoteVideoStream"===this._videoStream.kind&&(this._availableCallback=()=>{this._videoStream.isAvailable||(f.warn("stream isAvailable changed to false, attempting to reject operation"),this._renderingDeferred?.isPending()&&!this._disposed&&this._renderingDeferred?.reject(new CallingCommunicationError(z.VIEW.STREAM_BECAME_UNAVAILABLE)))},this._videoStream.on("isAvailableChanged",this._availableCallback)),this._videoStream.tsStream.start(this._target,{scalingMode:toTsScalingMode(this._scalingMode),transparent:!1}).then((g=>{if(this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._tsRenderer=g,this.logger.info("subscribed to video, waiting for the first frame"),this._disposed)throw this.logger.warn("already disposed, dispose underlying renderer"),this._attemptToDisposeTsRenderer(),new CallingCommunicationError(z.VIEW.START_ALREADY_DISPOSED);this.logger.info(`current state of rendering is ${this._tsRenderer.isRendering}`),this.sendRendererTelemetry(),-1!==getAcsEcsConfig().rendering.remoteVideo.createViewTimeout&&setTimeout((()=>{if(this._renderingDeferred?.isPending())try{this._renderingDeferred.reject(new CallingCommunicationError(z.VIEW.TIMEOUT))}catch(g){}}),getAcsEcsConfig().rendering.remoteVideo.createViewTimeout),this._tsRendererChanged=this._tsRenderer.changed((()=>this._handleTsRendererChanged(f))),this._tsRenderer.isRendering&&this._renderingDeferred?.isPending()&&(this._isRendering=!0,this._videoStream.updateIsReceiving(),this._size.width=g.streamSize.width,this._size.height=g.streamSize.height,this._videoStream.updateSize(),this._renderingDeferred.resolve())})).catch((g=>{if(this.logger.info("Failed to subscribe to video"),this._renderingDeferred?.isPending()){const m=new CallingCommunicationError(z.VIEW.SUBSCRIBE,g);this._renderingDeferred.reject(m)}})),await this._renderingDeferred.promise,this._videoStream.flushIsReceiving(),this._unsubscribeAvailabilityCallback(),getAcsEcsConfig().rendering.remoteVideo.forceCheckIfVideoWasAttachedToDom&&this._checkIfVideoWasAttachedToDom();const S={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:Su.render,kindOfEvent:Lh.success,mediaType:this._videoStream.mediaStreamType,streamType:fu.Remote};return this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(S),this}catch(f){this.logger.warn(`Failed to render, message=${f}`);try{this.dispose()}catch(g){this.logger.warn(`dispose failed with ${g?.message} error`)}const S=new CallingCommunicationError(z.VIEW.START,f);if(S.message!==z.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&S.message!==z.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const f=`Failed to render stream: ${S?.message||"unknown"}`,v={timestampInfo:{deltaTimeInMs:+new Date-m},correlationId:g,operation:Su.render,additionalDetails:{failureReason:f,code:B,...extractCommunicationServicesErrorForTelemetry(S)},kindOfEvent:Lh.failure,mediaType:this._videoStream.mediaStreamType,streamType:fu.Remote};this._remoteStreamTelemetryEventSender.sendMediaStreamEvent(v)}throw S}}async setScalingMode(g){if(!this._tsRenderer)throw new CallingCommunicationError(z.VIEW.SCALING_MODE);await this._tsRenderer.setScalingMode(toTsScalingMode(g)),this._scalingMode=g}dispose(g=Cu.Public_App){if(this._disposed)throw new CallingCommunicationError(z.VIEW.RENDERER_DISPOSE_ALREADY_DISPOSED);if(this._disposed=!0,this._disposeTsRendererChangedObservable(),this._unsubscribeAvailabilityCallback(),this._attemptToDisposeTsRenderer(),this._renderingDeferred?.isPending()){let m;switch(g){case Cu.Internal_LargeMeetingVideoRendering:m=z.VIEW.LARGE_MEETING_VIEW_DISPOSED;break;case Cu.Internal_RemoteVideoStreamDisposed:m=z.VIEW.REMOTE_VIDEO_STREAM_DISPOSED;break;default:m=z.VIEW.APP_VIEW_DISPOSED}this._renderingDeferred.reject(new CallingCommunicationError(m))}this._target&&this._target.remove();try{g!==Cu.Public_App&&this._onDisposedCallback(g)}catch(g){this.logger.debug(`dispose callback failed with ${g?.message} error`)}this._videoStream.unregisterRenderer(this),this._size.height=0,this._size.width=0,this._videoStream.updateSize(),this._isRendering=!1,this._videoStream.updateIsReceiving(),this._eventEmitter.removeAllListeners(),this._renderingDeferred=void 0}_checkIfVideoWasAttachedToDom(){if(getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_poll){let g=getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalMaxTries;const check=()=>{this._target.isConnected||g<=0?this.sendRendererTelemetry():(g--,g>=0&&setTimeout((()=>check),getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_intervalTime))};check()}else setTimeout((()=>{this._target.isConnected&&this.sendRendererTelemetry()}),getAcsEcsConfig().rendering.remoteVideo.checkIfVideoAttachedToDom_timeout)}}__decorate$d([loggerProperty,__metadata$d("design:type",Object)],RemoteStreamRenderer.prototype,"logger",void 0),__decorate$d([asyncOperation(ou.Start),__metadata$d("design:type",Function),__metadata$d("design:paramtypes",[]),__metadata$d("design:returntype",Promise)],RemoteStreamRenderer.prototype,"start",null),__decorate$d([syncOperation(ou.Dispose),__metadata$d("design:type",Function),__metadata$d("design:paramtypes",[String]),__metadata$d("design:returntype",void 0)],RemoteStreamRenderer.prototype,"dispose",null);var __decorate$e=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$e=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class LocalStreamRenderer{get isRendering(){return this._isRendering}get scalingMode(){return this._scalingMode}get isMirrored(){return this._isMirrored}get target(){return this._target}constructor(g,m,f,S,v){this._target=g,this._videoStream=m,this._onDisposed=S,this._eventEmitter=new bu.EventEmitter,this._isRendering=!1,this._scalingMode="Stretch",this._isMirrored=!0,this._disposed=!1,this.logger=f.createChild("LocalStreamRenderer"),this.logger.log("created"),void 0!==v?.scalingMode&&(this._scalingMode=v.scalingMode),void 0!==v?.isMirrored?this._isMirrored=v.isMirrored:"ScreenSharing"===this._videoStream.mediaStreamType&&(this._isMirrored=!1),this._localStreamTelemetryEventSender=new StreamTelemetryEventSender(this._videoStream.telemetryLogManager)}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}async start(){const g=generateGuid(),m=this.logger.createFnLogger(ou.Start),f=+new Date,S={timestampInfo:{attemptTimestamp:f},correlationId:g,operation:Su.render,kindOfEvent:Lh.attempt,mediaType:this._videoStream.mediaStreamType,streamType:fu.Local};this._localStreamTelemetryEventSender.sendMediaStreamEvent(S);try{if(m.info("attempting to select new device as a source"),this._videoStream.source instanceof VideoDeviceInfoImpl&&"Video"===this._videoStream.mediaStreamType){const g=this._videoStream.source.deviceManager.getTsDeviceManager();g.selectDevices({camera:this._videoStream.source.id}),m.info("device selected"),m.info("creating preview"),this._tsRenderer=await g.createPreview(this._target,{kind:"camera"},{scalingMode:toTsScalingMode(this._scalingMode),transparent:!1,ignoreMirroring:!1,disposeRendererWhenStreamisNotAvailable:()=>!0})}else{if("RawMedia"!==this._videoStream.mediaStreamType&&"ScreenSharing"!==this._videoStream.mediaStreamType)throw new CallingCommunicationError(z.VIEW.UNKNOWN_STREAM_TYPE);{const g=document.createElement("video");g.srcObject=await this._videoStream.getMediaStream(),g.play(),this._target.appendChild(g)}}this._isMirrored&&(this._target.style.transform="rotateY(180deg)",this._target.style.webkitTransform="rotateY(180deg)"),this._videoStream.registerRenderer(this);const S={timestampInfo:{deltaTimeInMs:+new Date-f},correlationId:g,operation:Su.render,kindOfEvent:Lh.success,mediaType:this._videoStream.mediaStreamType,streamType:fu.Local};return this._localStreamTelemetryEventSender.sendMediaStreamEvent(S),this}catch(S){this.dispose();const v=handleVideoOperationFailure(m,S),C={timestampInfo:{deltaTimeInMs:+new Date-f},correlationId:g,operation:Su.render,additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)},kindOfEvent:Lh.failure,mediaType:this._videoStream.mediaStreamType,streamType:fu.Local};throw this._localStreamTelemetryEventSender.sendMediaStreamEvent(C),v}}setScalingMode(g){if(!this._tsRenderer)throw new CallingCommunicationError(z.VIEW.SCALING_MODE);this._tsRenderer.setScalingMode(toTsScalingMode(g)),this._scalingMode=g}setSourceObject(g){this.disposeScreenSharingMediaStream();const m=this._target.querySelector("video");m&&(m.srcObject=g,m.play())}dispose(){if(!this._disposed){if(this._tsRenderer)try{this.logger.log("disposing underlying local renderer"),this._tsRenderer.dispose(),this._tsRenderer=void 0}catch(g){throw this.logger.warn(`underlying local renderer dispose failed with ${g?.message} error`),new CallingCommunicationError(z.VIEW.LOCAL_RENDERER_DISPOSE_FAIL)}this.disposeScreenSharingMediaStream(),this._target.remove(),this._onDisposed&&this._onDisposed(this),this._eventEmitter.removeAllListeners(),this._disposed=!0}}disposeScreenSharingMediaStream(){if(this._videoStream.getCall()?.localScreenSharingStream){const g=this._target.querySelector("video"),m=g?.srcObject;m&&(m.getVideoTracks().forEach((g=>{g.stop()})),g.srcObject=null,this.logger.info("disposed of ScreenSharing MediaStream"))}}}__decorate$e([loggerProperty,__metadata$e("design:type",Object)],LocalStreamRenderer.prototype,"logger",void 0),__decorate$e([asyncOperation(lu.Start),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[]),__metadata$e("design:returntype",Promise)],LocalStreamRenderer.prototype,"start",null),__decorate$e([syncOperation(lu.SetScalingMode),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[String]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"setScalingMode",null),__decorate$e([syncOperation(lu.SetSourceObject),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[MediaStream]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"setSourceObject",null),__decorate$e([syncOperation(lu.Dispose),__metadata$e("design:type",Function),__metadata$e("design:paramtypes",[]),__metadata$e("design:returntype",void 0)],LocalStreamRenderer.prototype,"dispose",null);var __decorate$f=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$f=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let gm=1;class VideoStreamRendererViewImpl{get scalingMode(){return this._streamRenderer.scalingMode}get isMirrored(){return this._streamRenderer.isMirrored}get disposed(){return this._disposed}constructor(g,m,f,S){if(this._videoStream=g,this._viewId=f,this._options=S,this._disposed=!1,this._deleteActiveRemoteVideoStreamView=(g,m)=>{if(g.call.activeRemoteVideoStreamViews?.has(g.id)){let f=g.call.activeRemoteVideoStreamViews?.get(g.id);f?.delete(m),0==f?.size&&g.call.activeRemoteVideoStreamViews?.delete(g.id)}},this.logger=m.createChild("VideoStreamRendererView"+gm++),this.target=document.createElement("div"),this.target.style.width="100%",this.target.style.height="100%",this._videoStream instanceof RemoteVideoStreamCommonImpl)this._streamRenderer=new RemoteStreamRenderer(this.target,this._viewId,this._videoStream,this.logger,(g=>{this._disposed?noop():this.dispose(g)}),this._options);else{if(!(this._videoStream instanceof LocalVideoStream))throw new CallingCommunicationError(z.VIEW.VIEW_WRONG_STREAM_TYPE);this._streamRenderer=new LocalStreamRenderer(this.target,this._videoStream,this.logger,(()=>this.dispose),this._options)}this._telemetryLogManager=this._videoStream.telemetryLogManager,this.logger.info("created")}async render(){const g=this.logger.createFnLogger(this._videoStream instanceof RemoteVideoStreamCommonImpl?tu.RenderRemoteStream:tu.RenderLocalStream);if(this._disposed)throw g.log("failed, stream disposed!"),new CallingCommunicationError(z.VIEW.RENDER_FAIL_STREAM_DISPOSED);try{await this._streamRenderer.start()}catch(m){g.error("failed");try{this.dispose()}catch(g){this.logger.warn(`Failed to dispose, message=${g.message}`)}throw m}}async updateScalingMode(g){if(this._disposed)throw new CallingCommunicationError(z.VIEW.SCALING_MODE_DISPOSED);if("Crop"!==g&&"Fit"!==g&&"Stretch"!==g)throw new CallingCommunicationError(z.VIEW.SCALING_MODE_WRONG_VAL);try{await this._streamRenderer.setScalingMode(g)}catch(g){throw new CallingCommunicationError(z.VIEW.SCALING_MODE,g)}}dispose(g=Cu.Public_App){if(this._disposed)throw new CallingCommunicationError(z.VIEW.VIEW_ALREADY_DISPOSED);this._disposed=!0;const m=+new Date,f=generateGuid();try{g===Cu.Public_App&&this.sendDisposeViewEvent({eventName:kh.acs_calling_dispose_view_attempt,correlationId:f,timestampInfo:{attemptTimestamp:m}}),this._videoStream instanceof RemoteVideoStreamImpl&&this._deleteActiveRemoteVideoStreamView(this._videoStream,this._viewId),this.logger.debug("attempt to dispose stream renderer"),this._streamRenderer.dispose(g),this.target?.remove();const S=+new Date;g===Cu.Public_App&&this.sendDisposeViewEvent({eventName:kh.acs_calling_dispose_view_success,correlationId:f,timestampInfo:{deltaTimeInMs:S-m}})}catch(S){const v=new CallingCommunicationError(z.VIEW.DISPOSE_FAIL,S);if(g===Cu.Public_App){const g=+new Date;this.sendDisposeViewEvent({eventName:kh.acs_calling_dispose_view_failure,correlationId:f,timestampInfo:{deltaTimeInMS:g-m}},v)}throw v}}sendDisposeViewEvent(g,m){try{let f,S;m&&(f="string"==typeof m?.message?m?.message:"",S={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{...this._videoStream.getStreamMetadata(),viewId:this._viewId,correlationId:g.correlationId,timestampInfo:g.timestampInfo,failureReason:f,additionalDetails:S}})}catch(g){this.logger.debug("Unable to send telemtery")}}}function collectLiveStreamStatsForCreateView(g,m,f,S){const v=["audioBitrate","videoBitrate","downloadBitrate","bufferLengthInMs","videoHeight","videoWidth","currentPlayPosition"],C=m[f.toString()];void 0!==C&&v.forEach((m=>{const f=m,v=m;if(void 0!==C[f]){const m=C[f];if(void 0===g[v])g[v]=[m];else{const f=g[v]?.length;f>=S&&g[v]?.shift(),g[v]?.push(m)}}}))}__decorate$f([loggerProperty,__metadata$f("design:type",Object)],VideoStreamRendererViewImpl.prototype,"logger",void 0),__decorate$f([asyncOperation(tu.Render),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[]),__metadata$f("design:returntype",Promise)],VideoStreamRendererViewImpl.prototype,"render",null),__decorate$f([asyncOperation(tu.UpdateScalingMode),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[String]),__metadata$f("design:returntype",Promise)],VideoStreamRendererViewImpl.prototype,"updateScalingMode",null),__decorate$f([syncOperation(tu.Dispose),__metadata$f("design:type",Function),__metadata$f("design:paramtypes",[String]),__metadata$f("design:returntype",void 0)],VideoStreamRendererViewImpl.prototype,"dispose",null);class CreateViewTelemetryHelper{get createViewStats(){return this._createViewStats}get initialCreateViewStats(){return this._initialCreateViewStats}constructor(g,m,f,S,v){this._statsCollector=g,this._streamId=m,this._logger=f,this._call=S,this._attemptTimestamp=v,this._createViewFailureStats={},this._createViewStats={},this._initialCreateViewStats={},this._statsCollector.on("sampleReported",(g=>{collectMediaStatsForCreateView(this.createViewStats,this.initialCreateViewStats,g,this._streamId)}))}getCreateViewFailureStats(){try{let g=0,m=NaN;void 0!==this.createViewStats.video?.framesDropped&&void 0!==this.initialCreateViewStats.video?.framesDropped&&(g=this.createViewStats.video?.framesDropped.length,m=this.createViewStats.video?.framesDropped[g-1]-this.initialCreateViewStats.video?.framesDropped[0]);let f=NaN,S=NaN;void 0!==this.createViewStats.video?.framesReceived&&void 0!==this.initialCreateViewStats.video?.framesReceived&&(g=this.createViewStats.video.framesReceived.length,f=this.createViewStats.video.framesReceived[g-1]-this.initialCreateViewStats.video?.framesReceived[0],g=this.initialCreateViewStats.video.framesReceived.length,S=this.initialCreateViewStats.video.framesReceived[0]);let v=NaN;void 0!==this.createViewStats.video?.framesDecoded&&void 0!==this.initialCreateViewStats.video?.framesDecoded&&(g=this.createViewStats.video.framesDecoded.length,v=this.createViewStats.video.framesDecoded[g-1]-this.initialCreateViewStats.video?.framesDecoded[0]);let C=NaN;void 0!==this.createViewStats.video?.keyFramesDecoded&&void 0!==this.initialCreateViewStats.video?.keyFramesDecoded&&(g=this.createViewStats.video.keyFramesDecoded.length,C=this.createViewStats.video.keyFramesDecoded[g-1]-this.initialCreateViewStats.video?.keyFramesDecoded[0]);let _=0;!isNaN(m)&&!isNaN(f)&&f>0&&(_=Number((m/f*100).toFixed(7)));let E=!1;f>0&&0===v&&(E=!0);let T=!1;isNaN(v)||isNaN(C)||v!==C||(T=!0);const I=[],b=this._call.networkQualityUfdEventDetails,A=getAcsEcsConfig().rendering.remoteVideo.createViewFailureNetworkUfdCheckWindowInMs;b.forEach((g=>{Math.abs(g.timestampInfo-this._attemptTimestamp)<=A&&I.push(g)}));let P=!1;isNaN(f)||isNaN(S)||f!==S||(P=!0),this._createViewFailureStats.video={framesDroppedPercentage:_,framesReceivedButNothingDecoded:E,onlyKeyFramesDecoded:T,networkQualityEventsDuringAttempt:I,zeroFramesReceived:P}}catch(g){this._logger.debug("Error calculating create view failure stats!")}return this._createViewFailureStats}}class CreateViewLiveStreamTelemetryHelper{constructor(g,m){this._liveStreamStatsCollector=g,this._streamId=m,this._liveStreamStats={},this._initialLiveStreamStats={};const f=getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStatsMaxLength;this._liveStreamStatsCollector.on("sampleReported",(g=>{collectLiveStreamStatsForCreateView(this._liveStreamStats,g,this._streamId,f),R.isEmpty(this._initialLiveStreamStats)&&(this._initialLiveStreamStats=this._liveStreamStats)}))}get initialCreateViewLiveStreamStats(){return this._initialLiveStreamStats}get createViewLiveStreamStats(){return this._liveStreamStats}}var __decorate$g=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$g=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class VideoStreamRenderer{get _createViewStats(){return"RemoteVideoStream"!==this._videoStream.kind&&"ComposedVideoStream"!==this._videoStream.kind||!this._createViewTelemetryHelper?"LiveVideoStream"===this._videoStream.kind&&this._createViewLiveStreamTelemetryHelper?this._createViewLiveStreamTelemetryHelper.createViewLiveStreamStats:{}:this._createViewTelemetryHelper.createViewStats}constructor(m){if(this.size={height:0,width:0},this.views=new Map,this.disposed=!1,this._attemptToDisposeView=g=>{try{g?.dispose()}catch(g){this.logger.warn(g?.message||"Failed to dispose, unknown error")}},this._addActiveRemoteVideoStreamView=(g,m,f)=>{if(g.call.activeRemoteVideoStreamViews?.has(g.id)){let S=g.call.activeRemoteVideoStreamViews?.get(g.id);S&&S.set(m,f)}else{let S=new Map;S.set(m,f),g.call.activeRemoteVideoStreamViews?.set(g.id,S)}},!(m instanceof LocalVideoStream||m instanceof RemoteVideoStreamCommonImpl||m instanceof RemoteVideoStreamImpl))throw new CallingCommunicationError(z.VIEW.RENDERER_WRONG_STREAM_TYPE);const f=g("ACS");this._videoStream=m,this._telemetryLogManager=m.telemetryLogManager,this.logger=new DefaultLogger(f,m instanceof LocalVideoStream?[()=>`VideoStreamRenderer:LocalVideoStream:${P.pii.Omit(m?.source?.id)}`]:[()=>`VideoStreamRenderer:${m.kind}:${m?.id}`]),this.logger.info("created")}async createView(g){if(this.disposed)throw new CallingCommunicationError(z.VIEW.RENDERER_DISPOSED);const m=+new Date,f=generateGuid(),S=generateGuid();let v,C;try{if(this.sendCreateViewEvent({eventName:kh.acs_calling_create_view_attempt,viewId:f,correlationId:S,timestampInfo:{attemptTimestamp:m}}),"RemoteVideoStream"===this._videoStream.kind&&!this._videoStream.isAvailable){const g=new CallingCommunicationError(z.VIEW.ISAVAILABLE_FALSE),v=+new Date;throw this.sendCreateViewEvent({eventName:kh.acs_calling_create_view_failure,viewId:f,correlationId:S,timestampInfo:{deltaTimeInMs:v-m}},g),g}if("RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&getAcsEcsConfig()?.calling.applyViewLimit&&getMediaConfig()?.numVideoChannelsGvc){const g=getMediaConfig().numVideoChannelsGvc,v=this._videoStream;if(!v.call.activeRemoteVideoStreamViews?.has(v.id)&&v.call.activeRemoteVideoStreamViews?.size>=g){const v=new CallingCommunicationError(z.VIEW.MAX_NUM_OF_VIEWS_REACHED(g)),C=+new Date;throw this.sendCreateViewEvent({eventName:kh.acs_calling_create_view_failure,viewId:f,correlationId:S,timestampInfo:{deltaTimeInMs:C-m}},v),v}}if(getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStats)if("RemoteVideoStream"===this._videoStream.kind||"ComposedVideoStream"===this._videoStream.kind){const g=this._videoStream,f=g.call;C=g.call.feature(am.MediaStats).createCollector();const S=g.id;this._createViewTelemetryHelper=new CreateViewTelemetryHelper(C,S,this.logger,f,m)}else if("LiveVideoStream"===this._videoStream.kind){const g=this._videoStream;C=g.call.feature(am.LiveStream).createStatsCollector();const m=g.id;this._createViewLiveStreamTelemetryHelper=new CreateViewLiveStreamTelemetryHelper(C,m)}v=new VideoStreamRendererViewImpl(this._videoStream,this.logger,f,g),this.views.set(f,v),await v.render(),"RemoteVideoStream"===this._videoStream.kind&&"ScreenSharing"!==this._videoStream.mediaStreamType&&this._addActiveRemoteVideoStreamView(this._videoStream,f,v);const _=+new Date;return this.sendCreateViewEvent({eventName:kh.acs_calling_create_view_success,viewId:f,correlationId:S,timestampInfo:{deltaTimeInMs:_-m}}),C?.dispose(),v}catch(g){const _=new CallingCommunicationError(z.VIEW.CREATE_VIEW_FAILED,g);if(this.views.delete(f),this._attemptToDisposeView(v),C?.dispose(),_.message!==z.VIEW.LARGE_MEETING_VIEW_DISPOSED.message&&_.message!==z.VIEW.REMOTE_VIDEO_STREAM_DISPOSED.message){const g=+new Date;this.sendCreateViewEvent({eventName:kh.acs_calling_create_view_failure,viewId:f,correlationId:S,timestampInfo:{deltaTimeInMs:g-m}},_)}throw _}}async sendCreateViewEvent(g,m){try{let f={},S={},v={};if(getAcsEcsConfig()?.rendering.remoteVideo.createViewSendMediaStats&&(g.eventName===kh.acs_calling_create_view_failure||g.eventName===kh.acs_calling_create_view_success)){if("RemoteVideoStream"===this._videoStream.kind){const g=this._videoStream.call,m=g.tsCall.getMediaSessionStats();f={videoSubscriptionEvents:m?.extensions?.Video_SubscriptionEvents,screenSharingSubscriptionEvents:m?.extensions?.Sharing_SubscriptionEvents,videoSendMaxCapabilities:m?.extensions?.Video_send_MaxCapabilities,screenSharingSendMaxCapabilities:m?.extensions?.Sharing_send_MaxCapabilities,iceConnectedStateTime:m?.metrics?.IceConnectedStateTime,relayCandidate:m?.extensions?.RelayCandidate,videoRecvTimeToFirstFrame:m?.extensions?.Video_recv_TimeToFirstFrame,screenSharingRecvTimeToFirstFrame:m?.extensions?.Sharing_recv_TimeToFirstFrame,optimalVideoCount:g.tsCall.optimalVideoCount||1,currentNumberOfVideosRendered:g.activeRemoteVideoStreamViews?.size||0}}g.eventName===kh.acs_calling_create_view_failure&&(v=this._createViewTelemetryHelper?.getCreateViewFailureStats()??{},S=this._createViewStats)}f.visibilityState=document.visibilityState;let C="",_={};m&&(C="string"==typeof m?.message?m?.message:"",_={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{viewId:g.viewId,correlationId:g.correlationId,timestampInfo:g.timestampInfo,...this._videoStream.getStreamMetadata(),failureReason:C,additionalProperties:f,additionalDetails:_,stats:S,createViewFailureDebugStats:v,videoStreamKind:this._videoStream.kind}})}catch(g){this.logger.debug("Unable to send telemtery")}}dispose(){if(this.disposed)throw new CallingCommunicationError(z.VIEW.RENDERER_ALREADY_DISPOSED);this.disposed=!0,this.views.forEach(this._attemptToDisposeView),this.views.clear()}}__decorate$g([loggerProperty,__metadata$g("design:type",Object)],VideoStreamRenderer.prototype,"logger",void 0),__decorate$g([asyncOperation(iu.CreateView),__metadata$g("design:type",Function),__metadata$g("design:paramtypes",[Object]),__metadata$g("design:returntype",Promise)],VideoStreamRenderer.prototype,"createView",null),__decorate$g([syncOperation(iu.Dispose),__metadata$g("design:type",Function),__metadata$g("design:paramtypes",[]),__metadata$g("design:returntype",void 0)],VideoStreamRenderer.prototype,"dispose",null);var __decorate$h=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$h=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class RemoteParticipantImpl{get identifier(){return this._identifier}get endpointDetails(){return this._tsParticipant?.endpoints?.endpointDetails.map((g=>({participantId:g.participantId})))||[]}get state(){return this._state}get videoStreams(){return[...this._mappedStreams.values()]}get isMuted(){return this._isMuted}get isSpeaking(){return this._isSpeaking}get callEndReason(){return this._callEndReason}get displayName(){return this._displayName}get role(){return this._role}constructor(g,m,f,S,v){this._mappedStreams=new Map,this._state="Idle",this._lastTsParticipantState=0,this._isMuted=!1,this._isSpeaking=!1,this._displayName="",this._role="Unknown",this.acsToTsStreamType=g=>"Video"===g?0:"ScreenSharing"===g?1:void 0,this._identifier=g,this.logger=m.createChild((()=>`RemoteParticipant{${this._identifier.kind}}`)),this._telemetryLogManager=v,this._eventEmitter=new CallingEventEmitter(this.logger),this._callAgent=S,this._call=f,this.logger.log("created"),this._renderers={Video:{renderingState:{}},ScreenSharing:{renderingState:{}}}}on(g,m){if("stateChanged"!==g&&"isMutedChanged"!==g&&"isSpeakingChanged"!==g&&"displayNameChanged"!==g&&"roleChanged"!==g&&"videoStreamsUpdated"!==g)throw new CallingCommunicationError(z.REMOTE_PARTICIPANT.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("stateChanged"!==g&&"isMutedChanged"!==g&&"isSpeakingChanged"!==g&&"displayNameChanged"!==g&&"roleChanged"!==g&&"videoStreamsUpdated"!==g)throw new CallingCommunicationError(z.REMOTE_PARTICIPANT.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}async mute(){if(!getAcsEcsConfig().calling.enableMuteOthers)throw new CallingCommunicationError(z.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_DISABLED);const g=this.logger.createFnLogger(Qh.Mute),m=+new Date,f=generateGuid();this.sendAudioEvent({eventName:kh.acs_calling_mute_attempt,eventType:xh.MuteSpecificParticipant,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{g.info("remote mute specific");var S=[];void 0!==this._tsParticipant&&(S=S.concat(this._tsParticipant)),await this._call.tsCall.muteParticipants(1,S),g.info("remote mute specific success");const v=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_mute_success,eventType:xh.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:v-m},correlationId:f,step:"mid-call"})}catch(S){const v=new CallingCommunicationError(z.REMOTE_PARTICIPANT.MUTE_PARTICIPANT_FAILED,S);g.error(v.message);const C=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_mute_failure,eventType:xh.MuteSpecificParticipant,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call"},v),v}}_dispose(){this.logger.log("dispose"),this._participantChangedHandler&&this._participantChangedHandler.dispose(),this._mappedStreams.forEach((g=>g.dispose())),this._eventEmitter.emit("stateChanged",this._state),this._eventEmitter.removeAllListeners(),this._disposeVideo(0),this._disposeVideo(1)}get tsRemoteParticipant(){return this._tsParticipant}get kind(){return"RemoteParticipant"}setCallEndReason(g){this._callEndReason=g}observeParticipant(g){this._tsParticipant||(this._tsParticipant=g,this._displayName=g.displayName,this._isMuted=g.isServerMuted,this._participantChangedHandler=this._tsParticipant.changed((()=>{if(this._tsParticipant&&this._tsParticipant.state!==this._lastTsParticipantState&&(this._lastTsParticipantState=this._tsParticipant.state,this._mapTsParticipantState(this._tsParticipant.state)),this._mapStreams(),this._tsParticipant&&this._tsParticipant.isServerMuted!==this._isMuted&&(this._isMuted=this._tsParticipant.isServerMuted,this._eventEmitter.emit("isMutedChanged")),this._tsParticipant&&this._tsParticipant.displayName!==this._displayName&&(this._displayName=g.displayName,this._eventEmitter.emit("displayNameChanged")),this._tsParticipant&&this._tsParticipant.advancedMeetingRole!==this._lastTsParticipantAdvancedRole&&(this._lastTsParticipantAdvancedRole=g.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole)),this._tsParticipant){const g=0!==this._tsParticipant.voiceLevel;g!==this._isSpeaking&&(this._isSpeaking=g,this._eventEmitter.emit("isSpeakingChanged"))}})),this._mapTsParticipantState(this._tsParticipant.state),this._mapStreams(),this._lastTsParticipantAdvancedRole=this._tsParticipant.advancedMeetingRole,this._setParticipantRole(this._tsParticipant.advancedMeetingRole))}setParticipantState(g){g!==this._state&&(this.logger.log(`state changed ${this._state}=>${this.state}`),this._state=g,"Disconnected"==this._state?this._dispose():this._eventEmitter.emit("stateChanged",this._state))}async stopRenderingVideo(){this._disposeVideo(0)}async renderVideo(g,m){if("function"==typeof g)return this._updateRenderingState(g,"Video",m);return await this._renderStreamForParticipant(g,0,m)}async _updateRenderingState(g,m,f){if("function"==typeof g){let S;const v="Video"===m?0:1;this._tsParticipant&&(S=f?.stream?f.stream:new RemoteVideoStreamImpl(this._tsParticipant.streams[v][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier),S.on("isReceivingChanged",(()=>{this._renderers[m].renderingState.isFrozen=!S.isReceiving,g(this._renderers[m].renderingState)})),S.on("isAvailableChanged",(async()=>{this._renderers[m].renderingState.isStreaming!==S?.isAvailable&&(this._renderers[m].renderingState.isStreaming=S.isAvailable,this._renderers[m].renderingState.isStreaming&&!this._renderers[m].renderer&&(this._renderers[m].renderer=this._renderers[m]?.renderer?this._renderers[m].renderer:new VideoStreamRenderer(S),this._renderers[m].view||(this._renderers[m].view=await(this._renderers[m].renderer?.createView(f?.viewOptions))),this._renderers[m].renderingState.videoTarget=this._renderers[m].view?.target)),g(this._renderers[m].renderingState)})))}}async renderScreenShare(g,m){if("function"==typeof g)return this._updateRenderingState(g,"ScreenSharing",m);return this._renderStreamForParticipant(g,1,m)}async _renderStreamForParticipant(g,m,f){if(this._tsParticipant){const S=0===m?"Video":"ScreenSharing",v=f?.stream?f.stream:new RemoteVideoStreamImpl(this._tsParticipant.streams[m][0],this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);return v.isAvailable&&(this._renderers[S].view=await this._appendVideo(g,m,v,f?.viewOptions)),v.on("isAvailableChanged",(async()=>{v.isAvailable?this._renderers[S].view=await this._appendVideo(g,m,v,f?.viewOptions):this._renderers[S]?.view&&this._renderers[S].view?.target&&this._renderers[S].view?.target.parentNode?.removeChild(this._renderers[S].view?.target)})),Promise.resolve({stream:v,view:this._renderers[S]?.view})}return Promise.reject()}async _appendVideo(g,m,f,S){try{const v=0===m?"Video":"ScreenSharing";if(0===m&&(this._renderers[v]?.renderer||(this._renderers[v].renderer=this._renderers[v]?.renderer?this._renderers[v].renderer:new VideoStreamRenderer(f),this._renderers[v].view=await(this._renderers[v].renderer?.createView(S))),this._renderers[v].view))return g.appendChild(this._renderers[v].view?.target||document.createElement("emptyNode")),Promise.resolve(this._renderers[v].view)}catch(g){return Promise.reject(g)}return Promise.reject()}async _disposeVideo(g){const m=0===g?"Video":"ScreenSharing";this._renderers[m].view?.dispose(),this._renderers[m].renderer?.dispose(),this._renderers[m]={renderingState:{}}}_setParticipantRole(g){let m=advancedMeetingRoleToParticipantRole(getAcsEcsConfig(),g);"Unknown"===m?this.logger.log(`tsParticipant advancedMeetingRole=${g} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${g}=>${m}`),this._role!=m&&(this.logger.log(`role changed ${this._role}=>${g}`),this._role=m,this._eventEmitter.emit("roleChanged"))}_mapTsParticipantState(g){let m;const f={0:"Idle",1:"Connecting",2:"Ringing",3:"Connected",4:"Disconnected",5:"Hold",7:"InLobby",6:"EarlyMedia"};f[g]?(m=f[g],this.logger.log(`mapped tsParticipant ${g}=>${this._state}`),this.setParticipantState(m)):this.logger.log(`unable to map tsCall state=${g} to call state`)}_mapStreams(){const g=[],m=[],handleNewStream=g=>{this._mappedStreams.set(g.id,g)},handleRemovedStream=g=>{const m=this._mappedStreams.get(g.id);m&&(this.logger.log(`stream removed, type==${m.mediaStreamType} id=${g.id}`),this._mappedStreams.delete(g.id),m.dispose())},mapStreamsOfType=f=>{if(this._tsParticipant)if(this._tsParticipant.streams&&isNonEmptyArray(this._tsParticipant.streams[f])){let S=[];this._tsParticipant&&(S=this._tsParticipant.streams[f]),S.forEach((m=>{if(!this._mappedStreams.get(m.id)){const f=new RemoteVideoStreamImpl(m,this.logger,this._call,this._callAgent,this._tsParticipant.id,this._telemetryLogManager,this._identifier);this.logger.log(`stream created, type==${f.mediaStreamType} id=${m.id}`),g.push(f)}})),this._mappedStreams.forEach((g=>{if(this.acsToTsStreamType(g.mediaStreamType)===f){S.some((m=>m.id===g.id))||m.push(g)}}))}else this._mappedStreams.forEach((g=>{this.acsToTsStreamType(g.mediaStreamType)===f&&m.push(g)}))};mapStreamsOfType(0),mapStreamsOfType(1),(g.length>0||m.length>0)&&(g.forEach(handleNewStream),m.forEach(handleRemovedStream),this._eventEmitter.emit("videoStreamsUpdated",{added:g,removed:m}))}sendAudioEvent(g,m){try{let f,S;m&&(f=m.message,S=extractCommunicationServicesErrorForTelemetry(m));const v={callId:this._call.id,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:f||"",additionalDetails:{...S}};void 0!==g.eventType&&(v.eventType=g.eventType),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:v})}catch(g){this.logger.debug("Unable to send mute others audio telemetry")}}}__decorate$h([loggerProperty,__metadata$h("design:type",Object)],RemoteParticipantImpl.prototype,"logger",void 0),__decorate$h([asyncOperation(Qh.Mute),__metadata$h("design:type",Function),__metadata$h("design:paramtypes",[]),__metadata$h("design:returntype",Promise)],RemoteParticipantImpl.prototype,"mute",null);class SelectedDeviceManager{constructor(g){this._deviceManager=g,this._eventEmitter=new bu.EventEmitter,this._selectedDeviceListeners=new Map,this._selectedDevices=new Map,this._deviceInfoMapper=this._deviceManager.deviceInfoMapper;const createSelectedDeviceListener=g=>()=>{const m=this._selectedDevices.get(g),f=(()=>"Speaker"===g?this._deviceManager.selectedSpeaker:"Microphone"===g?this._deviceManager.selectedMicrophone:void 0)(),S=void 0===f?void 0:{id:this._deviceInfoMapper.getDeviceId(f.id),name:this._deviceInfoMapper.scrubDeviceLabel(f.name)};this._selectedDevices.set(g,S),this._eventEmitter.emit("selectedDeviceChanged",{selectedDeviceType:g,oldDevice:m,newDevice:S})},m=createSelectedDeviceListener("Speaker");this._selectedDeviceListeners.set("Speaker",m),this._deviceManager.on("selectedSpeakerChanged",m),m();const f=createSelectedDeviceListener("Microphone");this._selectedDeviceListeners.set("Microphone",f),this._deviceManager.on("selectedMicrophoneChanged",f),f()}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}selectedDevice(g){return this._selectedDevices.get(g)}dispose(){const g=this._selectedDeviceListeners.get("Speaker");g&&this._deviceManager.off("selectedSpeakerChanged",g);const m=this._selectedDeviceListeners.get("Microphone");m&&this._deviceManager.off("selectedMicrophoneChanged",m),this._eventEmitter.removeAllListeners()}}function getCallProgressCommonPayload(g,m,f,S){const v=S===el.RoomCall||g.kind===Y.Call&&"Incoming"==g.direction&&!g.tsCall.groupId&&!!g.tsCall.meetingData?.meetingCode&&!g.tsCall.threadId,C=!v&&S===el.TeamsMeetingLink||S===el.TeamsMeetingId||S===el.TeamsCoordinates||"Incoming"==g.direction&&!g.tsCall.groupId&&!!g.tsCall.meetingData&&!!g.tsCall.threadId;return{timestampInfo:{attemptTimestamp:+new Date},correlationId:f,localParticipantId:g.tsCall.participantId||"",callId:g.tsCall.callId||"",callType:g.tsCall.callType||"",callDirection:g.direction,state:"Ringing"===g.state?"Ringing":Lu[g.tsCall.state],groupJoin:!!g.tsCall.groupId,roomJoin:v,meetingJoin:C,callEndDiagnosticsInfo:g.tsCall.callEndDiagnosticsInfo||{},isSupportedEnvironment:m?.runningEnvironmentInfo?.isSupportedEnvironment,diagnosticInfo:{...g.tsCall.callEndDiagnosticsInfo,telemetryPayloadBytesOriginal:TelemetryLogManager.telemetryPayloadBytesOriginal,telemetryPayloadBytesCompressed:TelemetryLogManager.telemetryPayloadBytesCompressed}}}function sendCallProgressEvent(g,m,f){try{"state-changed"===f.step&&"Connecting"===f.newState&&(TelemetryLogManager.telemetryPayloadBytesOriginal=0,TelemetryLogManager.telemetryPayloadBytesCompressed=0),g.sendEvent({name:kh.acs_calling_call_progress,tenant:so,properties:f})}catch(g){m.error(`Failed to send event: ${kh.acs_calling_call_progress} step: ${f.step}`)}}var pm,__decorate$i=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$i=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallCommonImpl{get id(){return this._id}get callerInfo(){return{identifier:this._callerIdentity,displayName:this._callerDisplayName}}get state(){return this._state}get role(){return this._role}get callEndReason(){return this._callEndReason}get kind(){return this._kind}get direction(){return this._direction}get isMuted(){return this._isMuted}get isScreenSharingOn(){return this._isScreenSharingOn}get isLocalVideoStarted(){return this._isLocalVideoStarted}get localVideoStreams(){return this._localVideoStreams}get localAudioStreams(){return this._localAudioStreams}get isIncomingAudioMuted(){return this._isIncomingAudioMuted}get remoteParticipants(){return this._remoteParticipants}get totalParticipantCount(){return this._totalParticipantCount}get lobby(){return this._lobby}subscribeToGetRemoteAudioStream(){if(!this._rawAudioStreamChangedSubscription)try{let g=this.tsCall.getIncomingRawAudioStream(),populateRemoteAudioStreamCollection=async()=>{try{if(0===this._remoteAudioStreams.length){if(void 0===await g.getMediaStream())throw new CallingCommunicationError(z.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_UNDEFINED);this._remoteAudioStreams.push(new RemoteAudioStreamImpl(g,this._telemetryLogManager,this.id,this.tsCall.participantId)),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:this._remoteAudioStreams,removed:[]})}else if(void 0===await g.getMediaStream()){const g=this._remoteAudioStreams[0];g.dispose(),this._remoteAudioStreams=[],this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[g]})}}catch(g){throw new CallingCommunicationError(z.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_RETURNED_ERROR,g)}};this._rawAudioStreamChangedSubscription=g.changed((()=>{this.logger.info(`Changed fired ${this.tsCall.state}, ${this.state}`),populateRemoteAudioStreamCollection().catch(noop)})),populateRemoteAudioStreamCollection().catch((()=>{this.logger.info("Failed to update remote audio stream collection, retrying on changed")}))}catch(g){this.logger.info("Failed to get raw audio stream from the stack")}}get remoteAudioStreams(){if(!getAcsEcsConfig().calling.allowAccessRawMediaStream)throw new CallingCommunicationError(z.CALL.REMOTE_AUDIO_GET_MEDIA_STREAM_DISABLED);return this._remoteAudioStreams}get deviceManager(){return this._callAgent.deviceManager}get mediaConstraintsManager(){return this._mediaConstraintsManager}get isHandlingLargeMeetingVideoRendering(){return this._isHandlingLargeMeetingVideoRendering}get networkQualityUfdEventDetails(){return this._networkQualityUfdEventDetails}get acsProxy(){return this._callAgent.acsProxy}get acsCustomRelayManager(){return this._callAgent.acsCustomRelayManager}constructor(g,m,f,S,v){this._callAgent=m,this._isMuted=!1,this._isMuted_correlationIdCache=generateGuid(),this._isIncomingAudioMuted=!1,this._isIncomingAudioMuted_correlationIdCache=generateGuid(),this._isScreenSharingOn=!1,this._isLocalVideoStarted=!1,this._localVideoStreams=[],this._localAudioStreams=[],this._remoteAudioStreams=[],this._totalParticipantCount=1,this._isDeviceNotFunctioningMuted=!1,this.__attemptedToRecoverMicNotFunctioningBySDK=!1,this._isMicrophoneMuted=!1,this._disposed=!1,this._lastTsCallState=0,this._isSpeakerMuted=!1,this._callMode=0,this._role=Bo,this._lastTsCallMeetingDetails={},this._isHandlingLargeMeetingVideoRendering=!1,this._joinContextDescription=el.Unknown,this._remoteParticipantsChangedListeners=[],this._localRingingStateSet=!1,this._networkQualityUfdEventDetails=[],this._mriToRemoteParticipantMap=new Map,this._remoteParticipants=[],this._state="None",this.localVideoStream=void 0,this.localScreenSharingStream=void 0,this._handleCallingApplicationIdentifier=g=>{this._isClosedCaptionsBot(g)&&this.logger.info("Handle participant: Ignore closed captions application")},this._handleMuteChanges=()=>{const g=new CallInfoImpl(this.tsCall,{config:this._config}),m=this.tsCall.conversationType||g.context===uu.RoomJoin?!!(this.tsCall.isMuted||10!==this.tsCall.state&&this.tsCall.isServerMuted||this._isDeviceNotFunctioningMuted):!(!this.tsCall.isMuted&&!this._isDeviceNotFunctioningMuted);if(this._isMuted!=m){this.logger.info(`isMuted changed from ${this._isMuted} to ${m}`);let g=[];this.tsCall.isMuted&&g.push("isMicrophoneMuted"),this.tsCall.isServerMuted&&g.push("isServerMuted"),this._isDeviceNotFunctioningMuted&&g.push("isDeviceNotFunctioningMuted");let f="";g.length>=1&&(f=g.join(", ")),m&&(this._isMuted_correlationIdCache=generateGuid()),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,this._isMuted_correlationIdCache,this._joinContextDescription),step:"isMuted-changed",oldIsMuted:this._isMuted,newIsMuted:m,reason:f}),this._isMuted=m,this._eventEmitter.emit("isMutedChanged")}},this._handleIncomingAudioMuteChanges=()=>{const g=this._isSpeakerMuted;this._isIncomingAudioMuted!=g&&(this.logger.info(`newIncomingAudioMuted changed from ${this._isIncomingAudioMuted} to ${g}`),g&&(this._isIncomingAudioMuted_correlationIdCache=generateGuid()),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,this._isIncomingAudioMuted_correlationIdCache,this._joinContextDescription),step:"isIncomingAudioMuted-changed",oldIsMuted:this._isIncomingAudioMuted,newIsMuted:g,reason:""}),this._isIncomingAudioMuted=g,this._eventEmitter.emit("isIncomingAudioMutedChanged"))},this._isClosedCaptionsBot=g=>"28:b1902c3e-b9f7-4650-9b23-5772bd429747"===g.id,this.getTotalNotBotParticipantCount=()=>{let g=1;if(this.tsCall.participantCounts&&this.tsCall.participantCounts.totalParticipants>0&&(g=this.tsCall.participantCounts.totalParticipants),this.tsCall.participants){g-=this.tsCall.participants.filter((g=>this.isHiddenBot(g))).length}return g},this._id=g.callId,this.tsCall=f,this._direction=g.isIncoming?"Incoming":"Outgoing",this._config=g,this.logger=this._callAgent.logger.createChild((()=>`Call:${this._id}:${this._state}`)),this._telemetryLogManager=S,this.stats=new CallStats(this.logger,this._telemetryLogManager),this._eventEmitter=new CallingEventEmitter(this.logger),this.activeRemoteVideoStreamViews=new Map,this._mediaMetricsDeviceEvents={},this._kind=v,this._optimalVideoCount=1,this._ufdsCorrelationIdCache=initializeUfdsCorrelationIdCache(),getAcsEcsConfig().calling.mediaMetricsDeviceEventsEnabled&&(this._dmDevicesChangedSub=this._callAgent.tsStack?.getDeviceManager().on("devicesChanged",(()=>{this.setOrUpdateMediaMetricsDeviceEvents()}))),this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{call:this,callAgent:this._callAgent,callInfo:new CallInfoImpl(this.tsCall,{config:this._config})},{tsCall:this.tsCall,callAgent:this._callAgent,call:this,telemetryLogManager:this._telemetryLogManager}),this._lobby=new LobbyImpl(this.tsCall,this,this.logger,this._telemetryLogManager);const C=getRegisteredFeatures(Pu.CallFeature);for(const g of C)"OnExtendedObjectConstructor"===g.activationOptions.activationEvent&&this.feature(g);this._mmrRdpConnectionManager=new MmrRdpConnectionManager(this.logger),getAcsEcsConfig().telemetry.sendNetworkChangedTelemetry&&this._sendNetworkChangedTelemetry(),getAcsEcsConfig().telemetry.deviceChangedEvents.enabled&&(this._selectedDeviceManager=new SelectedDeviceManager(this.deviceManager),this._setupSelectedDeviceChangedTelemetry()),this._mediaConstraintsManager=new MediaConstraintsManager(this.tsCall,this.logger,this._telemetryLogManager)}async accept(g={}){const m=g.audioOptions?.muted??!1,f=this.getLocalVideoStreamFromCallOptions(g),S=this.getLocalAudioStreamFromCallOptions(g),v=+new Date,C=generateGuid(),_=this._callAgent.getEcsConfigIds();let E={joinContextDescription:"",additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),muted:m,withVideo:!!f,...getMMRInfo(),AcsCallingSDKWeb_ecsConfigId:_.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:_.SkypeWebMedia},additionalDetails:{}};const handleError=(g,m)=>{const _=+new Date;let T,I={...E};if(m){const{callEndReason:m,callingCommunicationError:f}=getCallEndReason(g,this);I.additionalDetails.callEndReason=m,T=f}else T=new CallingCommunicationError(z.CALL.ACCEPT_INCOMING_CALL,g),I.additionalDetails.communicationServicesError=extractCommunicationServicesErrorForTelemetry(T).communicationServicesError;return this.sendCallStageEvent({eventName:kh.acs_calling_call_accept_failed,correlationId:C,timestampInfo:{deltaTimeInMs:_-v},additionalPayload:I},T),f&&(this.sendVideoEvent({correlationId:C,eventName:kh.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:_-v},localVideoStream:f,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn},T),this.removeLocalVideoStream(f)),S&&this.removeLocalAudioStream(S),T};try{if(g?.videoOptions?.constraints){let m=this._mediaConstraintsManager.getTelemetryPayload({video:g?.videoOptions?.constraints});E.additionalProperties.constraints=m}this.sendCallStageEvent({eventName:kh.acs_calling_call_accept_attempt,correlationId:C,timestampInfo:{attemptTimestamp:v},additionalPayload:E});let _={...E};if(f&&this.setLocalVideoStream(f),this.setLocalAudioStream(S),f&&this.sendVideoEvent({eventName:kh.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:v},correlationId:C,step:"accept",isScreenSharingOnFlag:this._isScreenSharingOn}),1!==this.tsCall.state)throw new CallingCommunicationError(z.CALL.ACCEPT_NOT_RINGING);try{if(g?.videoOptions?.constraints){const m=await this._mediaConstraintsManager.setVideoConstraints(g?.videoOptions?.constraints,"accept",C,v),f=this._mediaConstraintsManager.getTelemetryPayload({video:m});_.additionalProperties.constraints=f}}catch(g){const m=new CallingCommunicationError(z.CALL.ACCEPT_VIDEO_CONSTRAINTS,g);this.logger.error(`${m.message}`)}const T={withVideo:!!f,receiveOnlyAudioOnCallStart:!!S,muted:m};return m&&(T.muteFlags=1),getAcsEcsConfig()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(T.mediaConfiguration={connectionType:"NoDirectConnection"}),"RawMedia"===f?.mediaStreamType&&await this._setRawStream(f,1),this.tsCall.accept(T).then((async()=>{const g=+new Date;f&&this.shallRemoveLvsAfterConnectedSuccessfully(f,"accept",C,g,v),S&&(this.startAudioInternal(S,!0).catch((g=>{})),this.shallRemoveLasAfterConnectedSuccessfully(S,"accept",C,g,v)),this.sendCallStageEvent({eventName:kh.acs_calling_call_accept_connected,correlationId:C,timestampInfo:{deltaTimeInMs:g-v},additionalPayload:_})})).catch((g=>{handleError(g,!0)})),this}catch(g){throw handleError(g,!1)}}async reject(){const g=+new Date,m=generateGuid();this.sendCallStageEvent({eventName:kh.acs_calling_call_reject_attempt,correlationId:m,timestampInfo:{attemptTimestamp:g}});const f=this._callAgent.getEcsConfigIds(),S={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:f.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:f.SkypeWebMedia},additionalDetails:{}};if(1!==this.tsCall.state){const f=new CallingCommunicationError(z.CALL.REJECT_NOT_RINGING);S.additionalDetails.callEndReason=extractCommunicationServicesErrorForTelemetry(f).communicationServicesError;const v=+new Date;throw this.sendCallStageEvent({eventName:kh.acs_calling_call_reject_failed,correlationId:m,timestampInfo:{deltaTimeInMs:v-g},additionalPayload:S},f),f}return this.tsCall.reject().then((()=>{const f=+new Date;this.sendCallStageEvent({eventName:kh.acs_calling_call_reject_success,correlationId:m,timestampInfo:{deltaTimeInMs:f-g}})})).catch((f=>{const v=+new Date,{callEndReason:C,callingCommunicationError:_}=getCallEndReason(this,f);throw S.additionalDetails.callEndReason=C,this.sendCallStageEvent({eventName:kh.acs_calling_call_reject_failed,correlationId:m,timestampInfo:{deltaTimeInMs:v-g},additionalPayload:S},_),_}))}dispose(){this._disposed||(this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesChangedSub=void 0,this._extensibleApi.dispose(),this._eventEmitter.removeAllListeners(),this._onlineListener&&window.removeEventListener("online",this._onlineListener),this._offlineListener&&window.removeEventListener("offline",this._offlineListener),this._trouterStateChangedListener&&this._callAgent.offTrouterStateChanged(this._trouterStateChangedListener),this._mmrRdpConnectionManager.dispose(),this._selectedDeviceManager?.dispose(),this._disposed=!0)}async startAudioInternal(g,m=!1){const f=generateGuid(),S=+new Date;let v;this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.attempt,isInternal:m,timestampInfo:"",additionalDetails:""});try{v=await g.getMediaStream()}catch(g){const v=new CallingCommunicationError(z.CALL.LOCAL_AUDIO_GET_MEDIA_STREAM,g);this.logger.error(`Failed to get raw stream with error: ${g}`);const C=+new Date;throw this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,isInternal:m,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:C-S},additionalDetails:{failureReason:v.message||"",code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}const C=this._callAgent.tsStack?.getDeviceManager();if(!getAcsEcsConfig()?.calling?.allowAccessRawMediaStream||!C?.setRawMediaStream){const g=new CallingCommunicationError(z.CALL.LOCAL_AUDIO_SET_MEDIA_STREAM);this.logger.error("Failed to set raw input audio stream");const v=+new Date;throw this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,isInternal:m,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:v-S},additionalDetails:{failureReason:g.message||"",code:g.code,subCode:g.subCode,...extractCommunicationServicesErrorForTelemetry(g)}}),g}const _=new MediaStream(v);C?.setRawMediaStream(_,0),this.removeLocalAudioStream(this.localAudioStreams[0]),this.setLocalAudioStream(g);const E=+new Date;this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.success,isInternal:m,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:E-S},additionalDetails:""})}stopAudioInternal(g=!1){const m=generateGuid(),f=+new Date;this.sendRawMediaEvent({eventName:kh.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,kindOfEvent:Lh.attempt,isInternal:g,timestampInfo:"",additionalDetails:""});const S=this._callAgent.tsStack?.getDeviceManager();if(!getAcsEcsConfig()?.calling?.allowAccessRawMediaStream||!S?.unsetRawMediaStream){const S=new CallingCommunicationError(z.CALL.LOCAL_AUDIO_UNSET_MEDIA_STREAM);this.logger.error("Failed to unset raw input audio stream");const v=+new Date;throw this.sendRawMediaEvent({eventName:kh.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,isInternal:g,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:v-f},additionalDetails:{failureReason:S.message||"",code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}}),S}S.unsetRawMediaStream(0),this.removeLocalAudioStream(this.localAudioStreams[0]);const v=+new Date;this.sendRawMediaEvent({eventName:kh.acs_calling_stop_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,kindOfEvent:Lh.success,isInternal:g,localAudioStream:this.localAudioStreams[0],timestampInfo:{deltaTimeInMs:v-f},additionalDetails:""})}bindTsCall(){void 0!==this.tsCall.callerMri&&(this._callerIdentity=constructIdentifierKindFromMri(this.tsCall.callerMri),this._callerDisplayName=this.tsCall.participants.find((g=>g.id===this.tsCall.callerMri))?.displayName),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._setCallRole(this.tsCall.advancedMeetingRole),this.updateCallMode(),this.tsCall.changed((()=>{this.tsCall.callId!==this._id&&(this.logger.log(`tsCall callId changed=${this.tsCall.callId}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"id-changed",oldCallId:this._id,newCallId:this.tsCall.callId}),this._id=this.tsCall.callId,this._eventEmitter.emit("idChanged")),this.tsCall.state!==this._lastTsCallState&&(this.logger.log(`tsCall state changed=${this.tsCall.state}`),this._lastTsCallState=this.tsCall.state,this.mapTsCallState(this.tsCall.state),this._handleMuteChanges()),this._isScreenSharingOn!==this.tsCall.isScreenSharingOn&&(this.logger.log(`tsCall isScreenSharingOn changed=${this.tsCall.isScreenSharingOn}`),this._isScreenSharingOn=this.tsCall.isScreenSharingOn,this._isScreenSharingOn||this.removeScreenSharingStream(),this._eventEmitter.emit("isScreenSharingOnChanged")),this._isMicrophoneMuted!==this.tsCall.isMuted&&(this.logger.log(`tsCall isMuted changed=${this.tsCall.isMuted}`),this._isMicrophoneMuted=this.tsCall.isMuted,this._handleMuteChanges()),this._isSpeakerMuted!==this.tsCall.isSpeakerMuted&&(this.logger.log(`tsCall _isSpeakerMuted changed=${this.tsCall.isSpeakerMuted}`),this._isSpeakerMuted=this.tsCall.isSpeakerMuted,this._handleIncomingAudioMuteChanges()),this.tsCall.advancedMeetingRole!==this._lastTsCallAdvancedMeetingRole&&(this.logger.log(`tsCall advancedMeetingRole changed=${this.tsCall.advancedMeetingRole}`),this._setCallRole(this.tsCall.advancedMeetingRole)),(this.tsCall.meetingData?.meetingUrl||this.tsCall.meetingData?.passcode)&&this.tsCall.meetingDetails&&hasMeetingDetailsChanged(this.tsCall.meetingDetails,this._lastTsCallMeetingDetails)&&this._setMeetingCapabilities(this.tsCall.meetingDetails),this.updateCallMode(),this.optimalVideoCountChanged()})),this.tsCall.on("serverMutedChanged",(()=>{this.logger.log(`tsCall isServerMuted changed=${this.tsCall.isServerMuted}`),this._handleMuteChanges()})),this._totalParticipantCount=this.getTotalNotBotParticipantCount(),this.tsCall.on("participantCountsUpdated",(()=>{const g=this.getTotalNotBotParticipantCount();if(this._totalParticipantCount!==g){const m=this._totalParticipantCount;this._totalParticipantCount=g,this.logger.log(`tsCall totalParticipantCount changed from ${m} to ${this._totalParticipantCount}`),getAcsEcsConfig().rendering.remoteVideo.largeMeeting.handleVideoRendering&&this._enableOrDisable_largeMeeting_videoRendering(),this._eventEmitter.emit("totalParticipantCountChanged");try{this.stats.recordEvent({name:Nh.number_of_participants,callId:this.id,localParticipantId:this.tsCall.participantId,data:{totalParticipantCount:this._totalParticipantCount,participantCounts:this.tsCall.participantCounts||{},previousParticipantCount:m}})}catch(g){this.logger.error("failed to send participant count change telemetry")}}})),this.tsCall.on("callQualityChanged",(async g=>{try{let m;5===g.type||32===g.type||2===g.type||1===g.type||37===g.type?(m=Nh.network_quality,this._trackNetworkQualityUfdEventDetails(g.type)):m=44===g.type||43===g.type||9===g.type||25===g.type||27===g.type||45===g.type||33===g.type||34===g.type||55===g.type||26===g.type||47===g.type?Nh.video_device_issue:Nh.other_diagnostic,3===g.value||2===g.value?(this.logger.warn(`Ufd error raised!, ufd=${g.type}, value=${g.value}, kind=${m}`),m===Nh.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!1}))):(this.logger.warn(`Ufd error recovered!, ufd=${g.type}, value=${g.value}, kind=${m}`),m===Nh.network_quality&&window.dispatchEvent(new CustomEvent("online",{detail:!0})));let f="";const S=this._ufdsCorrelationIdCache[g.type][g.mediaType];3==g.value||2==g.value?S?f=S:(f=generateGuid(),this._ufdsCorrelationIdCache[g.type][g.mediaType]=f):(S&&(f=S),this._ufdsCorrelationIdCache[g.type][g.mediaType]=void 0);const v={type:g.type.toString(),level:g.value,mediaType:g.mediaType,correlationId:f};if(this.stats.recordEvent({name:m,callId:this.id,localParticipantId:this.tsCall.participantId,data:v}),this.shallStopVideo(g)){const m=+new Date,f=generateGuid();this.logger.warn(`Attempting to stop video gracefully due to video ufd being raised.UFD: ${g.type}, value: ${g.value}, call direction: ${this._direction}`),this.sendAudioEvent({eventName:kh.acs_calling_stop_video_on_ufd_attempt,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{this.localVideoStream&&this.stopVideo(this.localVideoStream)}catch(m){const f=`Failed to stop video on video device start failed or capture mute event ${g.type} with value ${g.value}`;this.logger.error(f)}}if(this.shallRemoveLocalVideoStreamOnBadUfd(g)){this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream);const m=new CallingCommunicationError(z.CALL.REMOVE_LOCAL_VIDEO_ON_BAD_UFD(g.type,g.value,this._direction));this.logger.error(m.message)}if(this.shallStopAudio(g)){const m=+new Date,f=generateGuid();if(getAcsEcsConfig()?.calling?.allowMuteOnBadUfd&&!this.tsCall.isMuted){this.sendAudioEvent({eventName:kh.acs_calling_mute_on_ufd_attempt,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{await this.mute()}catch(m){const f=`Failed to mute on microphone device not functioning or capture mute event ${g.type} with value ${g.value}`;this.logger.error(f)}}const S=getAcsEcsConfig()?.calling?.preventStopAudio;if(S)return this.sendAudioEvent({eventName:kh.acs_calling_prevent_stop_audio,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"}),void(!getAcsEcsConfig()?.calling?.preventFakeMute&&this.markCallMuted());this.sendAudioEvent({eventName:kh.acs_calling_stop_audio_attempt,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{await this.tsCall.stopAudio(),this.markCallMuted();const g=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_stop_audio_success,timestampInfo:{deltaTimeInMs:g-m},correlationId:f,step:"mid-call"})}catch(S){const v=new CallingCommunicationError(z.CALL.STOP_AUDIO_ON_BAD_UFD(g.type,g.value),S);this.logger.error(v.message);const C=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_stop_audio_failure,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call"},v)}}this.muteUnmuteOnMicrophoneNotFunctioningUfd(g),this.audioDidAutoRecover(g)&&(this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges())}catch(g){this.logger.error("Failed to send ufd telemetry")}})),this.tsCall.on("participantAdded",(async g=>{this.logger.debug("tsCall participant added");const m=[];g.endpoints?.endpointDetails.forEach((g=>m.push(g.participantId))),0===m.length&&m.push("remoteParticipantId unavailable");const f=constructIdentifierKindFromMri(g.id);if(this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"added",kindOfEvent:Lh.event}),this.isHiddenBot(g))return this.logger.info("Add participant: Handle hidden calling application"),void this._handleCallingApplicationIdentifier(g);this._handleLocalRingingCallState(g);try{const m=this.getOrCreateRemoteParticipant(f,g);this._eventEmitter.emit("remoteParticipantsUpdated",{added:[m],removed:[]})}catch(g){this.logger.log("unable to map call participant to ACS user")}})),this.logger.debug(`tsCall current participant count=${this.tsCall?.participants?.length}`),this.tsCall.participants.forEach((g=>{const m=constructIdentifierKindFromMri(g.id);this.getOrCreateRemoteParticipant(m,g),this._handleLocalRingingCallState(g)}));try{const g=[];this.tsCall.participants.forEach((m=>{m.endpoints?.endpointDetails.forEach((m=>g.push(m.participantId)))})),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:g,participantAddedOrRemoved:"added",kindOfEvent:Lh.initialize})}catch(g){this.logger.info("Remove participant: Ignore calling application")}this.tsCall.on("participantRemoved",(async g=>{this.logger.debug("tsCall participant removed");const m=[];if(g.endpoints?.endpointDetails.forEach((g=>m.push(g.participantId))),0===m.length&&m.push("remoteParticipantId unavailable"),this.isHiddenBot(g))return this.logger.info("Remove participant: Ignore calling application"),void this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"removed",kindOfEvent:Lh.event});const f=g.id;if(f){const S=this._remoteParticipants.find((g=>getMriFromIdentifier(g.identifier)===f));if(S){const{callEndReason:f}=getRemoteParticipantCallEndReason(this,g);S.setCallEndReason(f),this.deleteRemoteParticipant(S),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[S]}),this.sendParticipantAddedOrRemovedEvent({remoteParticipantIds:m,participantAddedOrRemoved:"removed",kindOfEvent:Lh.event,additionalDetails:{...extractCallEndReasonForTelemetry(f)}})}else this.logger.log("unable to find participant to remove")}}))}_trackNetworkQualityUfdEventDetails(g){const m=+new Date;let f="";switch(g){case 5:f=$u;break;case 32:f=Wu;break;case 2:f=Gu;break;case 1:f=ju;break;case 37:f=qu}this._networkQualityUfdEventDetails.push({eventName:f,timestampInfo:m})}async muteUnmuteOnMicrophoneNotFunctioningUfd(g){try{const m=getAcsEcsConfig().calling;if(!m.muteUnmuteOnMicrophoneNotFunctioning||this._isMuted||9!==g.type||3!==g.value)return;this.__attemptedToRecoverMicNotFunctioningBySDK=!0,await this.mute(),m.unmuteDelayForMicrophoneNotFunctioningInMs>=0&&await sleep(m.unmuteDelayForMicrophoneNotFunctioningInMs),await this.unmute()}catch(g){this.logger.info("Unable to perform mute and unmute to recover microphoneNotFunctioning",g)}finally{this.__attemptedToRecoverMicNotFunctioningBySDK=!1}}updateCallMode(){this.tsCall.callMode&&this._callMode!==this.tsCall.callMode&&(this.logger.log(`tsCall callMode changed from ${this._callMode} to ${this.tsCall.callMode}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"callMode-changed",oldState:Fu[this._callMode],newState:Fu[this.tsCall.callMode]}),this._callMode=this.tsCall.callMode)}async startCallInternal(g,m,f,S){const v=!!g?.audioOptions?.muted,C=this.getLocalVideoStreamFromCallOptions(g),_=this.getLocalAudioStreamFromCallOptions(g);let E;const T=+new Date,I=generateGuid();this._joinContextDescription=getJoinContextDescription(f);const b=this._callAgent.getEcsConfigIds(),A={joinContextDescription:this._joinContextDescription,additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,IsEmergencyCall:S?.isEmergency||!1,trouterState:this._callAgent.getTrouterState(),muted:v,withVideo:!!C,...getMMRInfo(),AcsCallingSDKWeb_ecsConfigId:b.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:b.SkypeWebMedia},additionalDetails:{}};g?.videoOptions?.constraints&&(A.additionalProperties.constraints=this._mediaConstraintsManager.getTelemetryPayload({video:g?.videoOptions?.constraints})),S?.meetingInfo?.tenantId&&(this._teamsMeetingTenantId=S.meetingInfo.tenantId,A.additionalProperties.teamsMeetingTenantId=S.meetingInfo.tenantId),S?.threadId&&(this._teamsMeetingThreadId=S.threadId,A.additionalProperties.teamsMeetingThreadId=S.threadId),getAcsEcsConfig().calling.setDeviceType&&"default"!==this._callAgent.getDeviceType()&&(A.additionalProperties.firstPartyOptions={deviceType:this._callAgent.getDeviceType(),isImmersiveMode:g?.firstPartyOptions?.isImmersiveMode}),this.sendCallStageEvent({eventName:kh.acs_calling_call_attempt,correlationId:I,timestampInfo:{attemptTimestamp:T},additionalPayload:A});let P={...A},R={...A};try{this._isMicrophoneMuted=v,g?.alternateCallerId&&(E=getMriFromIdentifier(g.alternateCallerId)),C&&this.setLocalVideoStream(C),this.setLocalAudioStream(_)}catch(g){const m=+new Date,f=new CallingCommunicationError(z.CALL.INSTANTIATE_CALL,g);throw P.additionalDetails.communicationServicesError=extractCommunicationServicesErrorForTelemetry(f).communicationServicesError,this.sendCallStageEvent({eventName:kh.acs_calling_call_failed,correlationId:I,timestampInfo:{deltaTimeInMs:m-T},additionalPayload:P},f),this.logger.error(f.message),f}try{const f={...S};!getAcsEcsConfig().calling.setDeviceType||"mesh"!==this._callAgent.getDeviceType()&&"meshV2"!==this._callAgent.getDeviceType()||(f.endpointMetadata=JSON.stringify({meshapp:!0})),this.tsCall.init(f),C&&this.sendVideoEvent({correlationId:I,eventName:kh.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:T},localVideoStream:C,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn});try{if(g?.videoOptions?.constraints){const m=await this._mediaConstraintsManager.setVideoConstraints(g?.videoOptions?.constraints,"start",I,T),f=this._mediaConstraintsManager.getTelemetryPayload({video:m});R.additionalProperties.constraints=f}}catch(g){const m=new CallingCommunicationError(z.CALL.CALLSTART_VIDEO_CONSTRAINTS,g);this.logger.error(`${m.message}`)}let b=this.setClientEndpointCapabilities(g);getAcsEcsConfig()?.calling?.enableCustomTurnUsage&&this.acsCustomRelayManager?.customRelayManagerInUse&&(b.mediaConfiguration={connectionType:"NoDirectConnection"}),v&&(b.muteFlags=1),"RawMedia"===C?.mediaStreamType&&await this._setRawStream(C,1),m?await this.tsCall.startWithMeetingData(w.generateCauseId(),{withVideo:!!C,muted:v,ringOthers:!0,alternateId:E,shouldResurrect:"resurrect",receiveOnlyAudioOnCallStart:!!_,...b}):await this.tsCall.start({withVideo:!!C,muted:v,ringOthers:!0,alternateId:E,receiveOnlyAudioOnCallStart:!!_,...b});const A=+new Date;this.sendCallStageEvent({eventName:kh.acs_calling_call_connected,correlationId:I,timestampInfo:{deltaTimeInMs:A-T},additionalPayload:R}),C&&this.shallRemoveLvsAfterConnectedSuccessfully(C,"start",I,A,T),_&&(this.startAudioInternal(_,!0).catch((g=>{})),this.shallRemoveLasAfterConnectedSuccessfully(_,"start",I,A,T))}catch(g){const m=+new Date,{callEndReason:f,callingCommunicationError:S}=getCallEndReason(this,g);throw C&&(this.sendVideoEvent({correlationId:I,eventName:kh.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:m-T},localVideoStream:C,step:"start",isScreenSharingOnFlag:this._isScreenSharingOn},S),this.removeLocalVideoStream(C)),_&&this.removeLocalAudioStream(_),P.additionalDetails.callEndReason=extractCallEndReasonForTelemetry(f).callEndReason,this.sendCallStageEvent({eventName:kh.acs_calling_call_failed,correlationId:I,timestampInfo:{deltaTimeInMs:m-T},additionalPayload:P},S),this.logger.error(`Failed to start the call, message=${f?.message}, code=${f?.code}, subCode=${f?.subCode}, resultCategories=${f?.resultCategories}`),S}}getTopNDominantSpeakersWithVideoOn(){if(this._internalDominantSpeakersListener){const g=this._internalDominantSpeakersListener.dominantSpeakers.speakersList.map((g=>this._mriToRemoteParticipantMap.get(getMriFromIdentifier(g)))).filter((g=>!!g)).filter((g=>!!g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).find((g=>g.tsStream.isAvailable))));if(this.logger.info(`There are currently ${g.length} top-n dominant speakers with video on in the large meeting where topCount is ${getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount}`),g.length<getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount){const m=this._remoteParticipants.filter((g=>!!g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).find((g=>g.tsStream.isAvailable)))).filter((m=>!g.includes(m)));m.sort(((g,m)=>{const f=g.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((g=>"audio"===g.type)).map((g=>g.sourceId))??[],S=f.length>0?Math.min(...f):void 0,v=m.tsRemoteParticipant?.endpoints?.endpointDetails[0]?.mediaStreams?.filter((g=>"audio"===g.type)).map((g=>g.sourceId))??[],C=v.length>0?Math.min(...v):void 0;return void 0!==S&&null!=C?S-C:0}));for(const f of m){if(g.length===getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount)break;g.push(f)}}else g.splice(getAcsEcsConfig().rendering.remoteVideo.largeMeeting.dominantSpeakersWithVideoOn_topCount);return g}return[]}feature(g){return this._extensibleApi.getApiObjectInstance(g.callApiCtor)}async hangUp(g){const m=+new Date,f=generateGuid();return this.sendCallStageEvent({eventName:kh.acs_calling_call_hangup_attempt,correlationId:f,timestampInfo:{attemptTimestamp:m}}),this.tsCall.stop(g?.forEveryone).then((()=>{const g=+new Date;this.sendCallStageEvent({eventName:kh.acs_calling_call_hangup_success,correlationId:f,timestampInfo:{deltaTimeInMs:g-m}})})).catch((g=>{const S=+new Date,{callEndReason:v,callingCommunicationError:C}=getCallEndReason(this,g),_=this._callAgent.getEcsConfigIds(),E={additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:_.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:_.SkypeWebMedia},additionalDetails:{...extractCallEndReasonForTelemetry(v)}};throw this.sendCallStageEvent({eventName:kh.acs_calling_call_hangup_failure,correlationId:f,timestampInfo:{deltaTimeInMs:S-m},additionalPayload:E},C),C}))}async mute(){const g=this.logger.createFnLogger(Yh.Mute),m=+new Date,f=generateGuid();this.sendAudioEvent({eventName:kh.acs_calling_mute_attempt,eventType:xh.MuteMicrophone,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{g.info("mute"),await this.tsCall.mute(),g.info("mute success");const S=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_mute_success,eventType:xh.MuteMicrophone,timestampInfo:{deltaTimeInMs:S-m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK})}catch(S){const v=new CallingCommunicationError(z.CALL.MIC_MUTE,S);g.error("Failed to mute microphone");const C=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_mute_failure,eventType:xh.MuteMicrophone,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK},v),v}}async unmute(){const g=this.logger.createFnLogger(Yh.Unmute),m=+new Date,f=generateGuid();let S=!1;this.sendAudioEvent({eventName:kh.acs_calling_unmute_attempt,eventType:xh.UnmuteMicrophone,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});try{g.info("unmute"),await this.tsCall.unmute(),g.info("unmute success");const v=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_unmute_success,eventType:xh.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:v-m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK});const C=+new Date,_=getAcsEcsConfig()?.calling?.preventStopAudio;if(!_&&this._isDeviceNotFunctioningMuted){this.sendAudioEvent({eventName:kh.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:C},correlationId:f,step:"mid-call"}),S=!0,g.info("start audio"),await this.tsCall.startAudio(),g.info("start audio success");const m=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:kh.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:m-C},correlationId:f,step:"mid-call"})}}catch(v){const C=S?z.CALL.MIC_UNMUTE_AND_STARTAUDIO:z.CALL.MIC_UNMUTE,_=new CallingCommunicationError(C,v);g.error(C.message);const E=+new Date;throw this.sendAudioEvent({eventName:S?kh.acs_calling_start_audio_failure:kh.acs_calling_unmute_failure,eventType:S?void 0:xh.UnmuteMicrophone,timestampInfo:{deltaTimeInMs:E-m},correlationId:f,step:"mid-call",initiatedBySdk:this.__attemptedToRecoverMicNotFunctioningBySDK&&!S},_),_}}async muteAllRemoteParticipants(){if(!getAcsEcsConfig().calling.enableMuteOthers)throw new CallingCommunicationError(z.CALL.MUTE_ALL_PARTICIPANTS_DISABLED);const g=this.logger.createFnLogger(Yh.MuteAllRemoteParticipants),m=+new Date,f=generateGuid();this.sendAudioEvent({eventName:kh.acs_calling_mute_attempt,eventType:xh.MuteAllRemoteParticipants,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{g.info("mute all others"),await this.tsCall.muteParticipants(0,[]),g.info("mute all others success");const S=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_mute_success,eventType:xh.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:S-m},correlationId:f,step:"mid-call"})}catch(S){const v=new CallingCommunicationError(z.CALL.MUTE_ALL_PARTICIPANTS,S);g.error(v.message);const C=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_mute_failure,eventType:xh.MuteAllRemoteParticipants,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call"},v),v}}async muteIncomingAudio(){const g=this.logger.createFnLogger(Yh.MuteIncomingAudio),m=+new Date,f=generateGuid();this.sendAudioEvent({eventName:kh.acs_calling_mute_attempt,eventType:xh.MuteIncomingAudio,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{await this.tsCall.muteSpeaker();const g=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_mute_success,eventType:xh.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:g-m},correlationId:f,step:"mid-call"})}catch(S){const v=new CallingCommunicationError(z.CALL.MUTE_INCOMING_AUDIO,S);g.error(v.message);const C=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_mute_failure,eventType:xh.MuteIncomingAudio,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call"},v),v}}async unmuteIncomingAudio(){const g=this.logger.createFnLogger(Yh.MuteIncomingAudio),m=+new Date,f=generateGuid();this.sendAudioEvent({eventName:kh.acs_calling_unmute_attempt,eventType:xh.UnmuteIncomingAudio,timestampInfo:{attemptTimestamp:m},correlationId:f,step:"mid-call"});try{await this.tsCall.unmuteSpeaker();const g=+new Date;this.sendAudioEvent({eventName:kh.acs_calling_unmute_success,eventType:xh.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:g-m},correlationId:f,step:"mid-call"})}catch(S){const v=new CallingCommunicationError(z.CALL.UNMUTE_INCOMING_AUDIO,S);g.error(v.message);const C=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_unmute_failure,eventType:xh.UnmuteIncomingAudio,timestampInfo:{deltaTimeInMs:C-m},correlationId:f,step:"mid-call"},v),v}}async sendDtmf(g){const m=toDtmfTone(g);return this.tsCall.sendDtmfTone(m).catch((g=>{throw this.logger.error("Failed to send DTMF tone"),new CallingCommunicationError(z.CALL.DTMF_TONE)}))}async startVideo(g){const m=this.logger.createFnLogger(Yh.StartVideo),f=+new Date,S=generateGuid(),v=getAcsEcsConfig()?.calling?.preventStopAudio;if(this.sendVideoEvent({eventName:kh.acs_calling_start_video_attempt,timestampInfo:{attemptTimestamp:f},localVideoStream:g,correlationId:S,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),this._isDeviceNotFunctioningMuted&&!v){this.sendAudioEvent({eventName:kh.acs_calling_start_audio_attempt,timestampInfo:{attemptTimestamp:f},correlationId:S,step:"mid-call"});try{m.info("start audio before starting video"),await this.tsCall.startAudio(),m.info("start audio success before starting video");const g=+new Date;this._isDeviceNotFunctioningMuted=!1,this._handleMuteChanges(),this.sendAudioEvent({eventName:kh.acs_calling_start_audio_success,timestampInfo:{deltaTimeInMs:g-f},correlationId:S,step:"mid-call"})}catch(g){const v="Failed to start audio before starting video",C=new CallingCommunicationError(z.CALL.START_AUDIO_BEFORE_VIDEO,g);m.error(v);const _=+new Date;throw this.sendAudioEvent({eventName:kh.acs_calling_start_audio_failure,timestampInfo:{deltaTimeInMs:_-f},correlationId:S,step:"mid-call"},C),C}}try{if(!g)throw new CallingCommunicationError(z.CALL.STREAM_NULL);if(!(g instanceof LocalVideoStream))throw new CallingCommunicationError(z.CALL.STREAM_IS_NOT_LVS);if(this.tsCall.isVideoOn)throw new CallingCommunicationError(z.CALL.VIDEO_ALREADY_ON);"RawMedia"===g?.mediaStreamType&&await this._setRawStream(g,1),this.setLocalVideoStream(g)}catch(m){const v=new CallingCommunicationError(z.CALL.START_VIDEO,m);throw this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_start_video_failure,timestampInfo:{attemptTimestamp:f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},v),v}try{m.info("start video"),await this.tsCall.startVideo();const v=+new Date;this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:v-f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),m.info("video started")}catch(v){const C=+new Date,_=handleVideoOperationFailure(m,v);throw this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:C-f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},_),this.removeLocalVideoStream(g),_}}async stopVideo(g){const m=this.logger.createFnLogger(Yh.StopVideo),f=+new Date,S=generateGuid();if(this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_stop_video_attempt,timestampInfo:{attemptTimestamp:f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),!this.tsCall.isVideoOn){const m=new CallingCommunicationError(z.CALL.VIDEO_ALREADY_OFF);throw this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},m),m}if(this.localVideoStream!==g){const m=new CallingCommunicationError(z.CALL.STOP_WRONG_STREAM);throw this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_stop_video_failure,timestampInfo:{attemptTimestamp:f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},m),m}const unsetRawVideoStream=()=>{try{if(getAcsEcsConfig().calling.allowAccessRawMediaStream&&"RawMedia"===g.mediaStreamType){const g=this._callAgent.tsStack?.getDeviceManager();g&&g.unsetRawMediaStream&&g.unsetRawMediaStream(1)}}catch(g){this.logger.info(`Unset raw video stream: ${g?.message??"Unkown error"}`)}};try{m.info("stop video"),await this.tsCall.stopVideo(),unsetRawVideoStream();const v=+new Date;this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_stop_video_success,timestampInfo:{deltaTimeInMs:v-f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn}),m.info("video stopped"),this.removeLocalVideoStream(g)}catch(v){unsetRawVideoStream();const C=+new Date,_=handleVideoOperationFailure(m,v);throw this.sendVideoEvent({correlationId:S,eventName:kh.acs_calling_stop_video_failure,timestampInfo:{deltaTimeInMs:C-f},localVideoStream:g,step:"mid-call",isScreenSharingOnFlag:this._isScreenSharingOn},_),_}}startAudio(g){return this.startAudioInternal(g)}stopAudio(){return this.stopAudioInternal()}async hold(){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:pu.Standard}}),this.tsCall.hold().then((()=>{const f=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{holdType:pu.Standard}})})).catch((f=>{const S=+new Date,v=new CallingCommunicationError(z.CALL.HOLD_CALL);throw this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,holdType:pu.Standard,...extractCommunicationServicesErrorForTelemetry(v)}}),v}))}async resume(){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:pu.Standard}}),this.tsCall.unhold().then((()=>{const f=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{holdType:pu.Standard}})})).catch((f=>{const S=+new Date,v=new CallingCommunicationError(z.CALL.RESUME_CALL);throw this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,holdType:pu.Standard,...extractCommunicationServicesErrorForTelemetry(v)}}),v}))}async startScreenSharing(g){const m=this.logger.createFnLogger(Yh.StartScreenShare),f=+new Date,S=generateGuid();try{if(this.sendScreenShareEvent({eventName:kh.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Lh.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:g}),3!==this.tsCall.state)throw new CallingCommunicationError(z.CALL.START_SS_CALL_NOT_CONNECTED);if(this.tsCall.isScreenSharingOn)throw new CallingCommunicationError(z.CALL.SS_ALREADY_ON);if(g){if(!(g instanceof LocalVideoStream))throw new CallingCommunicationError(z.CALL.SS_RAW_STREAM_IS_NOT_LVS);if("RawMedia"!==g.mediaStreamType)throw new CallingCommunicationError(z.CALL.SS_RAW_STREAM_LVS_IS_NOT_RAW_MEDIA);await this._setRawStream(g,2),this.localScreenSharingStream=g}else this.localScreenSharingStream=new LocalVideoStream(new VideoDeviceInfoImpl(hl.ScreenSharing,generateGuid(),hl.ScreenSharing,this._callAgent.deviceManager))}catch(g){const m=+new Date;this.removeScreenSharingStream();const v=new CallingCommunicationError(z.CALL.START_SS,g);throw this.sendScreenShareEvent({eventName:kh.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:m-f},additionalDetails:{failureReason:v.message,code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),v}return this.tsCall.startScreenSharing().then((()=>{const g=+new Date;this.localScreenSharingStream&&-1===this._localVideoStreams.indexOf(this.localScreenSharingStream)&&(this.localScreenSharingStream.addCall(this),this._localVideoStreams.push(this.localScreenSharingStream),this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localScreenSharingStream],removed:[]})),this.sendScreenShareEvent({eventName:kh.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:g-f},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream})})).catch((g=>{const v=+new Date;this.removeScreenSharingStream();const C=handleVideoOperationFailure(m,g);throw this.sendScreenShareEvent({eventName:kh.acs_calling_start_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:S,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:v-f},additionalDetails:{failureReason:C.message,code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),C}))}async stopScreenSharing(){const g=this.logger.createFnLogger(Yh.StopScreenShare),m=+new Date,f=generateGuid();if(this.sendScreenShareEvent({eventName:kh.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.attempt,timestampInfo:"",additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),3!==this.tsCall.state)throw new CallingCommunicationError(z.CALL.STOP_SS_CALL_NOT_CONNECTED);if(!this.tsCall.isScreenSharingOn){const g=+new Date,S=new CallingCommunicationError(z.CALL.SS_ALREADY_OFF);throw this.sendScreenShareEvent({eventName:kh.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:g-m},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),S}return this.tsCall.stopScreenSharing().then((()=>{const g=+new Date,S=R.cloneDeep(this.localScreenSharingStream);this.removeScreenSharingStream(),this.sendScreenShareEvent({eventName:kh.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:g-m},additionalDetails:"",isVideoOn:this._isLocalVideoStarted,localVideoStream:S})})).catch((S=>{const v=+new Date,C=handleVideoOperationFailure(g,S);let _="string"==typeof C?.message?C?.message:void 0;throw this.sendScreenShareEvent({eventName:kh.acs_calling_stop_screen_share,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:v-m},additionalDetails:{failureReason:_||"",code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)},isVideoOn:this._isLocalVideoStarted,localVideoStream:this.localScreenSharingStream}),C}))}async setConstraints(g){const m=+new Date,f=generateGuid();try{let S=await this._mediaConstraintsManager.setVideoConstraints(g?.video,"mid-call",f,m);this.logger.info(`Video constraints set - ${JSON.stringify(S)}`)}catch(g){throw new CallingCommunicationError(z.CALL.SET_VIDEO_CONSTRAINTS,g)}}on(g,m){if("stateChanged"!==g&&"idChanged"!==g&&"isMutedChanged"!==g&&"isIncomingAudioMutedChanged"!==g&&"isScreenSharingOnChanged"!==g&&"isLocalVideoStartedChanged"!==g&&"remoteParticipantsUpdated"!==g&&"localVideoStreamsUpdated"!==g&&"localAudioStreamsUpdated"!==g&&"remoteAudioStreamsUpdated"!==g&&"totalParticipantCountChanged"!==g&&"roleChanged"!=g)throw new CallingCommunicationError(z.CALL.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("stateChanged"!==g&&"idChanged"!==g&&"isMutedChanged"!==g&&"isIncomingAudioMutedChanged"!=g&&"isScreenSharingOnChanged"!==g&&"isLocalVideoStartedChanged"!==g&&"remoteParticipantsUpdated"!==g&&"localVideoStreamsUpdated"!==g&&"localAudioStreamsUpdated"!==g&&"remoteAudioStreamsUpdated"!==g&&"totalParticipantCountChanged"!=g&&"roleChanged"!=g)throw new CallingCommunicationError(z.CALL.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}onMeetingChanged(g,m){if("meetingCapabilitiesChanged"!==g)throw new CallingCommunicationError(z.CALL.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}offMeetingChanged(g,m){if("meetingCapabilitiesChanged"!=g)throw new CallingCommunicationError(z.CALL.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}getOrCreateRemoteParticipant(g,m){let f=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));return f||(f=new RemoteParticipantImpl(g,this.logger,this,this._callAgent,this._telemetryLogManager),this._remoteParticipants.push(f),this._mriToRemoteParticipantMap.set(getMriFromIdentifier(f.identifier),f)),m&&f.observeParticipant(m),f}deleteRemoteParticipant(g){let m=!0;return 1!==this._remoteParticipants.splice(this._remoteParticipants.indexOf(g),1).length&&(this.logger.warn("Deleted remote participant array is not 1"),m=!1),this._mriToRemoteParticipantMap.delete(getMriFromIdentifier(g.identifier))||(this.logger.warn("Deleted remote participant was not found in mri-to-remoteparticipant map"),m=!1),m}sendCallOnHoldAndResumedEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send call hold or resume telemetry")}}sendVideoEvent(g,m){try{let f,S;try{f=g.localVideoStream?.getStreamMetadata()}catch(g){this.logger.error("Unable to get stream meta data on send video event")}m&&(S="string"==typeof m?.message?m?.message:void 0,g.additionalDetails={...extractCommunicationServicesErrorForTelemetry(m)}),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{...f,callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:S||"",isScreenSharingOnFlag:g.isScreenSharingOnFlag,additionalDetails:g.additionalDetails||{}}})}catch(g){this.logger.debug("Unable to send video telemetry")}}sendScreenShareEvent(g){let m;try{m=g.localVideoStream?.getStreamMetadata()}catch(g){this.logger.error("Unable to get stream meta data on send video event")}try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{...m,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:g.correlationId,kindOfEvent:g.kindOfEvent,timestampInfo:g.timestampInfo,additionalDetails:g.additionalDetails,isVideoOn:g.isVideoOn}})}catch(g){this.logger.debug("Unable to send screen share telemetry")}}sendRawMediaEvent(g){const m={...g};m.localAudioStream=g.localAudioStream?.source instanceof MediaStream?"MediaStream":"Device";try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:m})}catch(g){this.logger.debug("Unable to send raw media telemetry")}}sendAudioEvent(g,m){try{let f;m&&(f="string"==typeof m?.message?m?.message:void 0,g.additionalDetails={...extractCommunicationServicesErrorForTelemetry(m)});const S={callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:g.timestampInfo,correlationId:g.correlationId,step:g.step||"",failureReason:f||"",additionalDetails:g.additionalDetails||{}};void 0!==g.eventType&&(S.eventType=g.eventType),g.initiatedBySdk&&(S.initiatedBySdk=!0),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:S})}catch(g){this.logger.debug("Unable to send audio telemetry")}}sendCallStageEvent(g,m,f){try{let S,v="";m&&(S=this?.tsCall?.callEndDiagnosticsInfo||f||{},v=m.message);const C=this._joinContextDescription===el.RoomCall||this.kind===Y.Call&&"Incoming"===this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData?.meetingCode&&!this.tsCall.threadId,_=!C&&this._joinContextDescription===el.TeamsMeetingLink||this._joinContextDescription===el.TeamsMeetingId||this._joinContextDescription===el.TeamsCoordinates||"Incoming"==this._direction&&!this.tsCall.groupId&&!!this.tsCall.meetingData&&!!this.tsCall.threadId,E={localParticipantId:this?.tsCall?.participantId||"",callId:this?.tsCall?.callId||"",callType:this?.tsCall?.callType||"",callDirection:this._direction,failureReason:v,callEndDiagnosticsInfo:S,calleeIdentityType:this.getParticipantIdentityType(),groupJoin:!!this?.tsCall?.groupId,roomJoin:C,meetingJoin:_,correlationId:g.correlationId,timestampInfo:g.timestampInfo,...g.additionalPayload};this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:E})}catch(g){}}getParticipantIdentityType(){if(this.tsCall?.participants.length>1)return ul.group;if(0===this.tsCall?.participants.length)return ul.unknown;const g=this.tsCall?.participants[0];return constructIdentifierKindFromMri(g.id).kind}optimalVideoCountChanged(){const g=this._optimalVideoCount,m=this.tsCall.optimalVideoCount;if(m&&g!==m)try{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"optimalVideoCount-changed",previousOptimalVideoCount:g,newOptimalVideoCount:m,currentNumberOfVideosRendered:this.activeRemoteVideoStreamViews?.size||0})}catch(g){this.logger.error("Failed to send optimal video count change telemetry")}finally{this._optimalVideoCount=this.tsCall.optimalVideoCount||1}}_sendNetworkChangedTelemetry(){try{const recordNetworkChangedTelemetry=(g,m,f)=>{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"network-changed",trouterState:g,onLine:m,rdpState:f})};this._trouterStateChangedListener=g=>{recordNetworkChangedTelemetry(g,navigator.onLine,this._mmrRdpConnectionManager.state)},this._callAgent.onTrouterStateChanged(this._trouterStateChangedListener),this._onlineListener=g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!0,this._mmrRdpConnectionManager.state)},window.addEventListener("online",this._onlineListener),this._offlineListener=g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!1,this._mmrRdpConnectionManager.state)},window.addEventListener("offline",this._offlineListener),this._mmrRdpConnectionManager.on("stateChange",(g=>{recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),!1,g)})),recordNetworkChangedTelemetry(this._callAgent.getTrouterState(),navigator.onLine,this._mmrRdpConnectionManager.state)}catch(g){this.logger.warn("Failed to subscribe to network changed")}}_setupSelectedDeviceChangedTelemetry(){try{const recordTelemetry=g=>{sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"selectedDevice-changed",selectedDeviceType:g.selectedDeviceType,oldDevice:g.oldDevice,newDevice:g.newDevice})};if(this._selectedDeviceManager){this._selectedDeviceManager.on("selectedDeviceChanged",recordTelemetry);const g=this._selectedDeviceManager.selectedDevice("Speaker"),m=this._selectedDeviceManager.selectedDevice("Microphone");recordTelemetry({selectedDeviceType:"Speaker",oldDevice:void 0,newDevice:g}),recordTelemetry({selectedDeviceType:"Microphone",oldDevice:void 0,newDevice:m})}}catch(g){this.logger.warn("Failed to subscribe to selectedDevice changed")}}setLocalVideoStream(g){if(!this._callAgent.tsStack)throw new CallingCommunicationError(z.CALL.VIDEO_UNDEFINED_STACK);if(!this.localVideoStream&&g&&!this._localVideoStreams.find((m=>m===g))){this.localVideoStream=g,this._localVideoStreams.push(this.localVideoStream),"RawMedia"!==this.localVideoStream.mediaStreamType&&this._callAgent.tsStack.getDeviceManager().selectDevices({camera:g.source.id}),this.localVideoStream.addCall(this);try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[this.localVideoStream],removed:[]})}catch(g){this.logger.warn("Application threw on emit localVideoStreamsUpdated added")}this.logger.log("isLocalVideoStarted changed=true"),this._isLocalVideoStarted=!0,this._eventEmitter.emit("isLocalVideoStartedChanged")}}removeLocalVideoStream(g){if(this.localVideoStream&&g===this.localVideoStream&&this.localVideoStreams.find((g=>g===this.localVideoStream))){this.logger.log("Attempting to remove local video stream");if(0===this._localVideoStreams.splice(this._localVideoStreams.indexOf(this.localVideoStream),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localVideoStreams collection");this.logger.log("Local video stream removed successfully"),this.localVideoStream.removeCall(this),this.localVideoStream.dispose();const g=this.localVideoStream;this.localVideoStream=void 0;try{this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[g]})}catch(g){this.logger.warn("Application threw on emit localVideoStreamsUpdated removed")}this.logger.log("isLocalVideoStarted changed=false"),this._isLocalVideoStarted=!1,this._eventEmitter.emit("isLocalVideoStartedChanged")}}setLocalAudioStream(g){if(!this._callAgent.tsStack)throw new CallingCommunicationError(z.CALL.LOCAL_AUDIO_UNDEFINED_STACK);getAcsEcsConfig().calling.allowAccessRawMediaStream&&g&&(g.on("audioSourceChanged",this.audioSourceChanged),this._localAudioStreams.push(g),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[g],removed:[]}))}removeLocalAudioStream(g){if(g){this.logger.log("Attempting to remove local audio stream"),g.off("audioSourceChanged",this.audioSourceChanged),g.dispose();if(0===this._localAudioStreams.splice(this._localAudioStreams.indexOf(g),1).length)return void this.logger.warn("Stream not found, failed to remove stream from localAudioStreams collection");this.logger.log("Local audio stream removed successfully"),this._eventEmitter.emit("localAudioStreamsUpdated",{added:[],removed:[g]})}}removeScreenSharingStream(){if(this.localScreenSharingStream&&this.localVideoStreams.find((g=>g===this.localScreenSharingStream))){if(getAcsEcsConfig()?.calling?.allowAccessRawMediaStream&&"RawMedia"===this.localScreenSharingStream?.mediaStreamType){const g=this._callAgent.tsStack?.getDeviceManager();g?.unsetRawMediaStream&&g.unsetRawMediaStream(2)}this.localScreenSharingStream.dispose(),this.localScreenSharingStream.removeCall(this);const g=this._localVideoStreams.indexOf(this.localScreenSharingStream);this._localVideoStreams.splice(g,1);const m=this.localScreenSharingStream;this.localScreenSharingStream=void 0,this._eventEmitter.emit("localVideoStreamsUpdated",{added:[],removed:[m]})}}mapTsCallState(g){let m=Lu[g];switch(m){case"Unknown":case void 0:this.logger.log(`Ignored tsCall state \`${g}\``);break;case"Disconnected":{this._callEndReason=getCallEndReason(this).callEndReason,this._remoteParticipants.forEach((g=>{g.setCallEndReason(getRemoteParticipantCallEndReason(this,g.tsRemoteParticipant).callEndReason),g.setParticipantState("Disconnected")}));const f=this._remoteParticipants.map((g=>g));this._remoteParticipants=[],this._mriToRemoteParticipantMap.clear(),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:f}),this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.localAudioStreams[0]&&this.removeLocalAudioStream(this.localAudioStreams[0]),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.remoteAudioStreams[0]&&this.removeRemoteAudioStream(this.remoteAudioStreams[0]),this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._setCallState(m),this._telemetryLogManager.flushAllEvents(this.id).then((()=>{this.logger.log("Telemetry flushed")})).catch((g=>{this.logger.warn("Failed to flush telemetry log manager events")}));break}case"Connected":this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._remoteParticipantsChangedListeners.forEach((g=>{g.dispose()})),this._setCallState(m),this.setOrUpdateMediaMetricsDeviceEvents(),getAcsEcsConfig().calling.allowAccessRawMediaStream&&this.subscribeToGetRemoteAudioStream();break;case"Incoming Call":{this.logger.log(`state changed from ${this._state} to 'Incoming Call'`);const g=new CallInfoImpl(this.tsCall,{config:this._config});sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"state-changed",oldState:this._state,newState:"Incoming Call",callTypeInfo:{initiatorKind:g.initiatorKind,targetKind:g.targetKind,transferor:g.transferorKind,context:g.context,callScenario:g.callScenario,direction:g.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1});break}default:this.logger.log(`Mapped tsCall state:${g} to ${m}`),this._setCallState(m)}}shallStopVideo(g){const m=getAcsEcsConfig()?.calling?.deviceNotFunctioningMuted,f=getAcsEcsConfig()?.calling?.deviceCaptureMutedVideo,S=getAcsEcsConfig()?.calling?.preventStopVideo,v=25===g.type&&3===g.value,C=v&&1===g.mediaType,_=33===g.type&&3===g.value,E=getBrowserInfo(),T="ios"===getOS()&&"Safari"===E.engine,I="android"===getOS(),b=3===this.tsCall.state;return S?b&&this.tsCall.isVideoOn&&_:m&&b&&this.tsCall.isVideoOn&&(_||T&&v||f&&I&&C)}shallRemoveLocalVideoStreamOnBadUfd(g){const m=this.tsCall.localMediaStreams.find((g=>1===g.mediaType)),f=1===g.mediaType&&3===g.value&&25===g.type,S=4==this.tsCall.state||5===this.tsCall.state;if("Mobile"===getBrowserInfo().formFactor&&(f||"hidden"==document.visibilityState)&&this.localVideoStream&&S&&!m)return!1;if(!getAcsEcsConfig()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return!1;const v=3===this.tsCall.state;return 1===g.mediaType&&3===g.value&&(33===g.type||25===g.type||34===g.type)&&!!this.localVideoStream&&!v&&!m}shallStopAudio(g){const m=getAcsEcsConfig()?.calling?.deviceNotFunctioningMuted,f=getAcsEcsConfig()?.calling?.osAutoRecoverAudio,S=25===g.type&&3===g.value&&0===g.mediaType,v=9===g.type&&3===g.value,C=getBrowserInfo(),_="ios"===getOS()&&"Safari"===C.engine,E=3===this.tsCall.state;return f?m&&E&&v:m&&!this._isDeviceNotFunctioningMuted&&E&&(v||_&&S)}markCallMuted(){this._isDeviceNotFunctioningMuted=!0,this._handleMuteChanges()}audioDidAutoRecover(g){const m=getAcsEcsConfig()?.calling?.deviceCaptureMuteRecover&&!getAcsEcsConfig()?.calling?.preventFakeMute,f=25===g.type&&1===g.value&&0===g.mediaType,S=3===this.tsCall.state,v=getBrowserInfo(),C="ios"===getOS()&&"Safari"===v.engine,_=9===g.type&&1===g.value;return m&&this._isDeviceNotFunctioningMuted&&S&&(_||C&&f)}sendParticipantAddedOrRemovedEvent(g){try{this._telemetryLogManager.sendEvent({name:kh.acs_calling_participant_added_or_removed,tenant:so,properties:{callId:this.id,remotePerticipantId:Array.isArray(g?.remoteParticipantIds)?g?.remoteParticipantIds.slice(0,getAcsEcsConfig().telemetry.maxExistingReportedParticipants):[],participantAddedOrRemoved:g.participantAddedOrRemoved,localParticipantId:this.tsCall.participantId,kindOfEvent:g.kindOfEvent,correlationId:g.correlationId||"",timestampInfo:g.timestampInfo||"",additionalDetails:g.additionalDetails||{}}})}catch(g){this.logger.debug("Unable to send participant added telemtery")}}_handleLocalRingingCallState(g){"Connected"===this._state||"Outgoing"!==this._direction||this._localRingingStateSet||this._remoteParticipantsChangedListeners.push(g.changed((()=>{2!==g.state||"Connected"===this._state||this._localRingingStateSet||(this._setCallState("Ringing"),this._localRingingStateSet=!0,this._remoteParticipantsChangedListeners.forEach((g=>{g.dispose()})))})))}_setCallState(g){if(g!==this._state){const m=this._state,f=g,S=new CallInfoImpl(this.tsCall,{config:this._config});this.logger.log(`state changed from ${m} to ${f}`),this._state=f,this._eventEmitter.emit("stateChanged"),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"state-changed",oldState:m,newState:f,callTypeInfo:{initiatorKind:S.initiatorKind,targetKind:S.targetKind,transferor:S.transferorKind,context:S.context,callScenario:S.callScenario,direction:S.direction},teamsMeetingTenantId:this._teamsMeetingTenantId||"",teamsMeetingThreadId:this._teamsMeetingThreadId||"",callDurationInSeconds:this.tsCall.callStartedAt?Math.floor((Date.now()-this.tsCall.callStartedAt?.getTime())/1e3):-1,additionalDetails:"Disconnected"===this._state&&this._callEndReason?{...extractCallEndReasonForTelemetry(this._callEndReason)}:void 0})}}_setCallRole(g){if(g!==this._lastTsCallAdvancedMeetingRole){let m=advancedMeetingRoleToParticipantRole(getAcsEcsConfig(),g);m===Bo?this.logger.log(`tsParticipant advancedMeetingRole=${this._role} had no mapping`):this.logger.log(`mapped tsParticipant advancedMeetingRole=${g}=>${m}`),sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"role-changed",oldAcsRole:this._role,newAcsRole:m,serviceRole:g||""}),this._role!=m&&(this.logger.log(`self-role changed ${this._role}=>${g}`),this._role=m,this._lastTsCallAdvancedMeetingRole=g,this._eventEmitter.emit("roleChanged"))}}_setMeetingCapabilities(g){hasCoreMeetingCapabilitiesChanged(g,this._lastTsCallMeetingDetails)&&(sendCallProgressEvent(this._telemetryLogManager,this.logger,{...getCallProgressCommonPayload(this,this._callAgent,generateGuid(),this._joinContextDescription),step:"meetingCapabilities-changed",oldMeetingDetails:this._lastTsCallMeetingDetails,newMeetingDetails:g}),this.logger.log(`Core Meeting Capabilities has changed to: ${JSON.stringify(g)}`),this._eventEmitter.emit("meetingCapabilitiesChanged")),Object.assign(this._lastTsCallMeetingDetails,g)}async audioSourceChanged(g){this._telemetryLogManager.sendEvent({name:kh.acs_calling_local_audio_source_changed,tenant:so,properties:{callId:this.id,localParticipantId:this.tsCall.participantId,timestampInfo:+new Date,correlationId:generateGuid(),localAudioStream:g.source?.source instanceof MediaStream?"MediaStream":"Device"}}),g.source instanceof AudioDeviceInfoImpl?(this.localAudioStreams[0]&&this.stopAudioInternal(!0),this._callAgent.tsStack?.getDeviceManager().selectDevices({microphone:g.source.id})):await this.startAudioInternal(g.source,!0)}removeRemoteAudioStream(g){if(g){this.logger.log("Attempting to remove remote audio stream");if(0===this._remoteAudioStreams.splice(this._remoteAudioStreams.indexOf(g),1).length)return void this.logger.warn("Stream not found, failed to remove stream from remoteAudioStreams collection");this.logger.log("remote audio stream removed successfully"),this._eventEmitter.emit("remoteAudioStreamsUpdated",{added:[],removed:[g]})}}async setOrUpdateMediaMetricsDeviceEvents(){if(getAcsEcsConfig().calling.mediaMetricsDeviceEventsEnabled)try{const g=this.tsCall.getMediaSessionStats();if(void 0!==g?.metrics?.DeviceEvents){const m=JSON.parse(g.metrics.DeviceEvents),f=getSafeObjectDiff(this._mediaMetricsDeviceEvents||{},m);f.length>0&&(this._mediaMetricsDeviceEvents=m,this.stats.recordEvent({name:Nh.media_metrics_device_events,callId:this.id,localParticipantId:this.tsCall.participantId,data:{metricsDeviceEvents:f||{},metricsDevicesChangeCount:m?.metrics_DevicesChangeCount||0,metricsDevicesCount:m?.metrics_DevicesCount||{}}}))}else this.logger.error("Failed to set media metrics device events telemetry: no valid events data")}catch(g){this.logger.error("Failed to set media metrics device events telemetry")}}setClientEndpointCapabilities(g){const m={};let f=0;return g?.firstPartyOptions?.isImmersiveMode&&(f|=32768),getAcsEcsConfig()?.calling?.supportLiveStreaming&&(f|=32),f>0&&(m.clientEndpointCapabilities=f),m}getLocalVideoStreamFromCallOptions(g){let m;if(Array.isArray(g?.videoOptions?.localVideoStreams)){if(1!==g?.videoOptions?.localVideoStreams.length)throw new CallingCommunicationError(z.CALL.ONLY_SINGLE_VIDEO_STREAM);if(m=g?.videoOptions?.localVideoStreams[0],!(m instanceof LocalVideoStream))throw new CallingCommunicationError(z.CALL.NOT_INSTANCE_OF_LVS)}return m}getLocalAudioStreamFromCallOptions(g){let m;if(Array.isArray(g?.audioOptions?.localAudioStreams)){if(1!==g?.audioOptions?.localAudioStreams.length)throw new CallingCommunicationError(z.CALL.ONLY_SINGLE_AUDIO_STREAM);if(m=g?.audioOptions?.localAudioStreams[0],!(m instanceof LocalAudioStream))throw new CallingCommunicationError(z.CALL.NOT_INSTANCE_OF_LAS)}return m}async _setRawStream(g,m){if(!getAcsEcsConfig().calling.allowAccessRawMediaStream)throw new CallingCommunicationError(z.CALL.ACCESS_RAW_MEDIA_STREAM_DISABLED);const f=this._callAgent.tsStack?.getDeviceManager();if(!f?.setRawMediaStream)throw new CallingCommunicationError(z.CALL.ACCESS_RAW_MEDIA_STREAM_UNDEFINED_FUNC);try{const S=await g.getMediaStream();f.setRawMediaStream(S,m)}catch(g){if(1===m)throw new CallingCommunicationError(z.CALL.VIDEO_SET_MEDIA_STREAM,g);if(2===m)throw new CallingCommunicationError(z.CALL.SS_RAW_STREAM_SET,g)}}shallRemoveLvsAfterConnectedSuccessfully(g,m,f,S,v){if(this.tsCall.localMediaStreams.find((g=>1===g.mediaType)))this.sendVideoEvent({correlationId:f,eventName:kh.acs_calling_start_video_success,timestampInfo:{deltaTimeInMs:S-v},localVideoStream:g,step:m,isScreenSharingOnFlag:this._isScreenSharingOn});else{if(!getAcsEcsConfig()?.calling?.removeLvsCheckOnCallStartAndCallAccept)return;this.localVideoStream&&this.removeLocalVideoStream(this.localVideoStream);const S=+new Date,C=new CallingCommunicationError(z.CALL.VIDEO_FAILED_TO_START(m));this.logger.error(C.message),this.sendVideoEvent({correlationId:f,eventName:kh.acs_calling_start_video_failure,timestampInfo:{deltaTimeInMs:S-v},localVideoStream:g,step:m,isScreenSharingOnFlag:this._isScreenSharingOn},C)}}shallRemoveLasAfterConnectedSuccessfully(g,m,f,S,v){if(this.tsCall.localMediaStreams.find((g=>0===g.mediaType)))this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,kindOfEvent:Lh.success,localAudioStream:g,timestampInfo:{deltaTimeInMs:S-v},additionalDetails:""});else{if(!getAcsEcsConfig().calling.removeLocalAudioStreamCheckOnCallStartAndCallAccept)return;this.removeLocalAudioStream(this.localAudioStreams[0]);const S=+new Date;this.logger.error(`Removing local audio stream because audio failed to start during call-${m} process.`);const C=new CallingCommunicationError(z.CALL.AUDIO_FAILED_TO_START(m));this.sendRawMediaEvent({eventName:kh.acs_calling_start_audio_stream_track,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:f,localAudioStream:g,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:S-v},additionalDetails:{failureReason:C.message||"",code:C.code,subCode:C.subCode,...extractCommunicationServicesErrorForTelemetry(C)}})}}_enableOrDisable_largeMeeting_videoRendering(){try{!this._isHandlingLargeMeetingVideoRendering&&this._totalParticipantCount-1>=getAcsEcsConfig().rendering.remoteVideo.largeMeeting.participantCountThreshold?(this._isHandlingLargeMeetingVideoRendering=!0,this._internalDominantSpeakersListener=new DominantSpeakersCallImplOverTsCall(new CallingEventEmitter(this.logger.createChild((()=>`DominanSpeakersFeatureInternal:: Call(id=${this.tsCall.callId})`)))),this._internalDominantSpeakersListener.initialize(this.tsCall,this._callAgent,this._telemetryLogManager,this.logger,!0),this.logger.info("Initialized internal dominant speakers listener"),this._internalDominantSpeakersListener.on("dominantSpeakersChanged",(()=>{this.handleDominantSpeakersVideos()})),this.handleDominantSpeakersVideos(),this.logger.info("Initialized large meeting video rendering handler")):this._isHandlingLargeMeetingVideoRendering&&(this._totalParticipantCount-1>=getAcsEcsConfig().rendering.remoteVideo.largeMeeting.participantCountThreshold?this.handleDominantSpeakersVideos():(this._isHandlingLargeMeetingVideoRendering=!1,this._internalDominantSpeakersListener?.dispose(),this._internalDominantSpeakersListener=void 0,this.logger.info("Disposed of internal dominant speakers listener"),this.remoteParticipants.forEach((g=>{g.videoStreams.forEach((g=>{g.setIsAvailable(g.tsStream.isAvailable)}))})),this.logger.info("All remote streams isAvailable flags were reset"),this.logger.info("Disposed large meeting video rendering handler")))}catch(g){this.logger.error("Failed to handle large meeting video rendering",g)}}isHiddenBot(g){if(isCallingApplication(g.id)){if(isGlobalCallingApplication(g.id))return!0;if(getAcsEcsConfig()?.calling?.blacklistedBots?.includes(g.id))return!0;if(g.endpoints?.endpointDetails&&g.endpoints?.endpointDetails.length>0)return g.endpoints?.endpointDetails[0].endpointMetadata?.__platform?.ui?.hidden}return!1}handleDominantSpeakersVideos(){this.logger.info("Dominant speakers changed during large meeting");const g=this.getTopNDominantSpeakersWithVideoOn();this.logger.info(`There are currently ${g.length} top-n speakers with video on in the large meeting`),g.forEach((g=>{g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).forEach((g=>{g.setIsAvailable(g.tsStream.isAvailable)}))})),this._remoteParticipants.filter((m=>!g.includes(m))).forEach((g=>{g.videoStreams.filter((g=>"Video"===g.mediaStreamType)).forEach((g=>{try{g.setIsAvailable(!1)}catch(g){const m=new CallingCommunicationError(z.CALL.LARGEMEETING_FORCE_ISAVAILABLE,g);this.logger.warn(m.message)}const m=this.activeRemoteVideoStreamViews.get(g.id);m&&m.forEach((g=>{try{g.disposed||(g.dispose(Cu.Internal_LargeMeetingVideoRendering),this.logger.info("Successfully disposed of view during large meeting"))}catch(g){const m=new CallingCommunicationError(z.CALL.LARGEMEETING_DISPOSE_VIEW,g);this.logger.warn(m.message)}}))}))}))}}__decorate$i([loggerProperty,__metadata$i("design:type",Object)],CallCommonImpl.prototype,"logger",void 0),__decorate$i([syncOperation(Yh.BindToCall),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",void 0)],CallCommonImpl.prototype,"bindTsCall",null),__decorate$i([syncOperation(Yh.Feature),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype","function"==typeof(pm="undefined"!=typeof TFeature&&TFeature)?pm:Object)],CallCommonImpl.prototype,"feature",null),__decorate$i([asyncOperation(Yh.HangUp),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"hangUp",null),__decorate$i([asyncOperation(Yh.Mute),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"mute",null),__decorate$i([asyncOperation(Yh.Unmute),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"unmute",null),__decorate$i([asyncOperation(Yh.MuteAllRemoteParticipants),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"muteAllRemoteParticipants",null),__decorate$i([asyncOperation(Yh.MuteIncomingAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"muteIncomingAudio",null),__decorate$i([asyncOperation(Yh.UnmuteIncomingAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"unmuteIncomingAudio",null),__decorate$i([asyncOperation(Yh.SendDtmf),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[String]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"sendDtmf",null),__decorate$i([asyncOperation(Yh.StartVideo),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startVideo",null),__decorate$i([asyncOperation(Yh.StopVideo),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"stopVideo",null),__decorate$i([asyncOperation(Yh.startAudio),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalAudioStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startAudio",null),__decorate$i([validateEmergencyCallOperation(Yh.Hold),asyncOperation(Yh.Hold),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"hold",null),__decorate$i([validateEmergencyCallOperation(Yh.Resume),asyncOperation(Yh.Resume),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"resume",null),__decorate$i([asyncOperation(Yh.StartScreenShare),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[LocalVideoStream]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"startScreenSharing",null),__decorate$i([asyncOperation(Yh.StopScreenShare),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"stopScreenSharing",null),__decorate$i([asyncOperation(Yh.SetConstraints),__metadata$i("design:type",Function),__metadata$i("design:paramtypes",[Object]),__metadata$i("design:returntype",Promise)],CallCommonImpl.prototype,"setConstraints",null);var __decorate$j=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$j=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallImpl extends CallCommonImpl{get info(){return this._info}constructor(g,m,f,S){super(g,m,f,S,Y.Call),this._info=new CallInfoImpl(f,{roomId:g.roomId})}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(g,m){let S,v;const C=m,_=m,E=m,T=+new Date,I=generateGuid();if(this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.attempt,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{attemptTimestamp:T}}),this._callAgent.isCteUser()){this.validateThreadId(g,m);switch(f(g).kind){case"communicationUser":v=C.threadId;break;case"microsoftTeamsUser":v=E.threadId;break;case"phoneNumber":v=_.threadId;break;default:{const g=new CallingCommunicationError(z.CALL.ADD_UNKNOWN);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{deltaTimeInMs:+new Date-T},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}}}let b;_?.alternateCallerId&&(validateIdentifier(_.alternateCallerId),S=getMriFromIdentifier(_.alternateCallerId));try{if(b=validateIdentifier(g),!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,b))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN)}catch(g){throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{deltaTimeInMs:+new Date-T},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}if(this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))){const m=new CallingCommunicationError(z.CALL.PARTICIPANT_ALREADY_IN_CALL(f(g).kind));throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{deltaTimeInMs:+new Date-T},additionalDetails:{code:m.code,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}getAcsEcsConfig().calling.enableSmePassFakeConversation&&!v&&g&&IsAdhocInteropCall([g])&&(v=this.tsCall.threadId||`${G}${generateGuid()}`);const A=this.getOrCreateRemoteParticipant(constructIdentifierKindFromMri(getMriFromIdentifier(g)));return this.tsCall.addParticipant(getMriFromIdentifier(g),{alternateId:S,threadId:v}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.success,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{deltaTimeInMs:+new Date-T}})})).catch((m=>{const{callEndReason:f}=getRemoteParticipantCallEndReason(this,A.tsRemoteParticipant,m);A.callEndReason||A.setCallEndReason(f);const S=extractCallEndReasonForTelemetry(f);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:I,timestampInfo:{deltaTimeInMs:+new Date-T},additionalDetails:{code:S?.callEndReason.code,subCode:S?.callEndReason.subCode,failureReason:S?.callEndReason.message,...S}}),this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))&&(this.deleteRemoteParticipant(A),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[A]}))})),A}async removeParticipant(g,m){const S=+new Date,v=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.attempt,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{attemptTimestamp:S}});try{validateIdentifier(g)}catch(g){const m=new CallingCommunicationError(z.IDENTIFIER.PARSE_INVALID_IDENTIFIER,g);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:+new Date-S},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}let C=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(!C){const m=new CallingCommunicationError(z.CALL.PARTICIPANT_NOT_IN_CALL(f(g).kind));throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:m.code,subCode:m.subCode,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}try{await this.tsCall.removeParticipant(getMriFromIdentifier(g)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.success,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date}})}catch(g){const m=getRemoteParticipantCallEndReason(this,C.tsRemoteParticipant,g).callEndReason;C.callEndReason||C.setCallEndReason(m);const f=extractCallEndReasonForTelemetry(m);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:f?.callEndReason.code,subCode:f?.callEndReason.subCode,failureReason:f?.callEndReason.message,...f}}),new CallingCommunicationError({message:m.message,code:m.code,subCode:m.subCode||0,resultCategories:m.resultCategories},g)}}validateThreadId(g,m){if(!m?.threadId)throw new CallingCommunicationError(z.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID)}}__decorate$j([syncOperation(Yh.AddParticipant),__metadata$j("design:type",Function),__metadata$j("design:paramtypes",[Object,Object]),__metadata$j("design:returntype",Object)],CallImpl.prototype,"addParticipant",null),__decorate$j([asyncOperation(Yh.RemoveParticipant),__metadata$j("design:type",Function),__metadata$j("design:paramtypes",[Object,Object]),__metadata$j("design:returntype",Promise)],CallImpl.prototype,"removeParticipant",null);var __decorate$k=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$k=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class IncomingCallCommonImpl{get kind(){return this._kind}get id(){return this._callCommon.id}get callerInfo(){return this._callCommon.callerInfo}get callEndReason(){return this._callCommon.callEndReason}constructor(g,m){this._callCommon=g,this._eventEmitter=new bu.EventEmitter,this._kind=m,this._callConnected="Connected"===this._callCommon.state,this._callCommon.on("stateChanged",(()=>{"Connected"===this._callCommon.state?this._callConnected=!0:"Disconnected"!==this._callCommon.state||this._callConnected||this._eventEmitter.emit("callEnded",{callEndReason:this._callCommon.callEndReason})}))}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}reject(){return this._callCommon.reject()}}__decorate$k([asyncOperation(),__metadata$k("design:type",Function),__metadata$k("design:paramtypes",[]),__metadata$k("design:returntype",Promise)],IncomingCallCommonImpl.prototype,"reject",null);var __decorate$l=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$l=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class IncomingCallImpl extends IncomingCallCommonImpl{get info(){return this._call.info}constructor(g){super(g,Q.IncomingCall),this._call=g}async accept(g){if("microsoftTeamsUser"===this.info?.initiatorKind&&!isProxyAndCustomTurnAllowed(this._call.acsProxy,this._call.acsCustomRelayManager,!0))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN);return await this._call.accept(g),this._call}}__decorate$l([asyncOperation(Yh.Accept),__metadata$l("design:type",Function),__metadata$l("design:paramtypes",[Object]),__metadata$l("design:returntype",Promise)],IncomingCallImpl.prototype,"accept",null);var mm,fm=function bind(g,m){return function wrap(){for(var f=new Array(arguments.length),S=0;S<f.length;S++)f[S]=arguments[S];return g.apply(m,f)}},Sm=Object.prototype.toString,vm=(mm=Object.create(null),function(g){var m=Sm.call(g);return mm[m]||(mm[m]=m.slice(8,-1).toLowerCase())});function kindOfTest(g){return g=g.toLowerCase(),function isKindOf(m){return vm(m)===g}}function isArray$4(g){return Array.isArray(g)}function isUndefined$3(g){return void 0===g}function isBuffer$1(g){return null!==g&&!isUndefined$3(g)&&null!==g.constructor&&!isUndefined$3(g.constructor)&&"function"==typeof g.constructor.isBuffer&&g.constructor.isBuffer(g)}var ym=kindOfTest("ArrayBuffer");function isArrayBufferView$1(g){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(g):g&&g.buffer&&ym(g.buffer)}function isString$3(g){return"string"==typeof g}function isNumber$3(g){return"number"==typeof g}function isObject$2(g){return null!==g&&"object"==typeof g}function isPlainObject$1(g){if("object"!==vm(g))return!1;var m=Object.getPrototypeOf(g);return null===m||m===Object.prototype}var Cm=kindOfTest("Date"),_m=kindOfTest("File"),Em=kindOfTest("Blob"),Tm=kindOfTest("FileList");function isFunction$3(g){return"[object Function]"===Sm.call(g)}function isStream$1(g){return isObject$2(g)&&isFunction$3(g.pipe)}function isFormData$1(g){var m="[object FormData]";return g&&("function"==typeof FormData&&g instanceof FormData||Sm.call(g)===m||isFunction$3(g.toString)&&g.toString()===m)}var Im=kindOfTest("URLSearchParams");function trim$1(g){return g.trim?g.trim():g.replace(/^\s+|\s+$/g,"")}function isStandardBrowserEnv$1(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)}function forEach$1(g,m){if(null!=g)if("object"!=typeof g&&(g=[g]),isArray$4(g))for(var f=0,S=g.length;f<S;f++)m.call(null,g[f],f,g);else for(var v in g)Object.prototype.hasOwnProperty.call(g,v)&&m.call(null,g[v],v,g)}function merge$1(){var g={};function assignValue(m,f){isPlainObject$1(g[f])&&isPlainObject$1(m)?g[f]=merge$1(g[f],m):isPlainObject$1(m)?g[f]=merge$1({},m):isArray$4(m)?g[f]=m.slice():g[f]=m}for(var m=0,f=arguments.length;m<f;m++)forEach$1(arguments[m],assignValue);return g}function extend$2(g,m,f){return forEach$1(m,(function assignValue(m,S){g[S]=f&&"function"==typeof m?fm(m,f):m})),g}function stripBOM$1(g){return 65279===g.charCodeAt(0)&&(g=g.slice(1)),g}function inherits(g,m,f,S){g.prototype=Object.create(m.prototype,S),g.prototype.constructor=g,f&&Object.assign(g.prototype,f)}function toFlatObject(g,m,f){var S,v,C,_={};m=m||{};do{for(v=(S=Object.getOwnPropertyNames(g)).length;v-- >0;)_[C=S[v]]||(m[C]=g[C],_[C]=!0);g=Object.getPrototypeOf(g)}while(g&&(!f||f(g,m))&&g!==Object.prototype);return m}function endsWith(g,m,f){g=String(g),(void 0===f||f>g.length)&&(f=g.length),f-=m.length;var S=g.indexOf(m,f);return-1!==S&&S===f}function toArray(g){if(!g)return null;var m=g.length;if(isUndefined$3(m))return null;for(var f=new Array(m);m-- >0;)f[m]=g[m];return f}var bm,Am=(bm="undefined"!=typeof Uint8Array&&Object.getPrototypeOf(Uint8Array),function(g){return bm&&g instanceof bm}),Pm={isArray:isArray$4,isArrayBuffer:ym,isBuffer:isBuffer$1,isFormData:isFormData$1,isArrayBufferView:isArrayBufferView$1,isString:isString$3,isNumber:isNumber$3,isObject:isObject$2,isPlainObject:isPlainObject$1,isUndefined:isUndefined$3,isDate:Cm,isFile:_m,isBlob:Em,isFunction:isFunction$3,isStream:isStream$1,isURLSearchParams:Im,isStandardBrowserEnv:isStandardBrowserEnv$1,forEach:forEach$1,merge:merge$1,extend:extend$2,trim:trim$1,stripBOM:stripBOM$1,inherits:inherits,toFlatObject:toFlatObject,kindOf:vm,kindOfTest:kindOfTest,endsWith:endsWith,toArray:toArray,isTypedArray:Am,isFileList:Tm};function encode$1(g){return encodeURIComponent(g).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var Rm=function buildURL(g,m,f){if(!m)return g;var S;if(f)S=f(m);else if(Pm.isURLSearchParams(m))S=m.toString();else{var v=[];Pm.forEach(m,(function serialize(g,m){null!=g&&(Pm.isArray(g)?m+="[]":g=[g],Pm.forEach(g,(function parseValue(g){Pm.isDate(g)?g=g.toISOString():Pm.isObject(g)&&(g=JSON.stringify(g)),v.push(encode$1(m)+"="+encode$1(g))})))})),S=v.join("&")}if(S){var C=g.indexOf("#");-1!==C&&(g=g.slice(0,C)),g+=(-1===g.indexOf("?")?"?":"&")+S}return g};function InterceptorManager$1(){this.handlers=[]}InterceptorManager$1.prototype.use=function use(g,m,f){return this.handlers.push({fulfilled:g,rejected:m,synchronous:!!f&&f.synchronous,runWhen:f?f.runWhen:null}),this.handlers.length-1},InterceptorManager$1.prototype.eject=function eject(g){this.handlers[g]&&(this.handlers[g]=null)},InterceptorManager$1.prototype.forEach=function forEach(g){Pm.forEach(this.handlers,(function forEachHandler(m){null!==m&&g(m)}))};var wm=InterceptorManager$1,Mm=function normalizeHeaderName(g,m){Pm.forEach(g,(function processHeader(f,S){S!==m&&S.toUpperCase()===m.toUpperCase()&&(g[m]=f,delete g[S])}))};function AxiosError(g,m,f,S,v){Error.call(this),this.message=g,this.name="AxiosError",m&&(this.code=m),f&&(this.config=f),S&&(this.request=S),v&&(this.response=v)}Pm.inherits(AxiosError,Error,{toJSON:function toJSON(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code,status:this.response&&this.response.status?this.response.status:null}}});var Dm=AxiosError.prototype,Om={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED"].forEach((function(g){Om[g]={value:g}})),Object.defineProperties(AxiosError,Om),Object.defineProperty(Dm,"isAxiosError",{value:!0}),AxiosError.from=function(g,m,f,S,v,C){var _=Object.create(Dm);return Pm.toFlatObject(g,_,(function filter(g){return g!==Error.prototype})),AxiosError.call(_,g.message,m,f,S,v),_.name=g.name,C&&Object.assign(_,C),_};var Nm=AxiosError,km={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1};function toFormData(g,m){m=m||new FormData;var f=[];function convertValue(g){return null===g?"":Pm.isDate(g)?g.toISOString():Pm.isArrayBuffer(g)||Pm.isTypedArray(g)?"function"==typeof Blob?new Blob([g]):Buffer.from(g):g}function build(g,S){if(Pm.isPlainObject(g)||Pm.isArray(g)){if(-1!==f.indexOf(g))throw Error("Circular reference detected in "+S);f.push(g),Pm.forEach(g,(function each(g,f){if(!Pm.isUndefined(g)){var v,C=S?S+"."+f:f;if(g&&!S&&"object"==typeof g)if(Pm.endsWith(f,"{}"))g=JSON.stringify(g);else if(Pm.endsWith(f,"[]")&&(v=Pm.toArray(g)))return void v.forEach((function(g){!Pm.isUndefined(g)&&m.append(C,convertValue(g))}));build(g,C)}})),f.pop()}else m.append(S,convertValue(g))}return build(g),m}var Lm=toFormData,Fm=function settle(g,m,f){var S=f.config.validateStatus;f.status&&S&&!S(f.status)?m(new Nm("Request failed with status code "+f.status,[Nm.ERR_BAD_REQUEST,Nm.ERR_BAD_RESPONSE][Math.floor(f.status/100)-4],f.config,f.request,f)):g(f)},xm=Pm.isStandardBrowserEnv()?function standardBrowserEnv(){return{write:function write(g,m,f,S,v,C){var _=[];_.push(g+"="+encodeURIComponent(m)),Pm.isNumber(f)&&_.push("expires="+new Date(f).toGMTString()),Pm.isString(S)&&_.push("path="+S),Pm.isString(v)&&_.push("domain="+v),!0===C&&_.push("secure"),document.cookie=_.join("; ")},read:function read(g){var m=document.cookie.match(new RegExp("(^|;\\s*)("+g+")=([^;]*)"));return m?decodeURIComponent(m[3]):null},remove:function remove(g){this.write(g,"",Date.now()-864e5)}}}():{write:function write(){},read:function read(){return null},remove:function remove(){}},Um=function isAbsoluteURL(g){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(g)},Vm=function combineURLs(g,m){return m?g.replace(/\/+$/,"")+"/"+m.replace(/^\/+/,""):g},Bm=function buildFullPath(g,m){return g&&!Um(m)?Vm(g,m):m},Hm=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],$m=function parseHeaders(g){var m,f,S,v={};return g?(Pm.forEach(g.split("\n"),(function parser(g){if(S=g.indexOf(":"),m=Pm.trim(g.substr(0,S)).toLowerCase(),f=Pm.trim(g.substr(S+1)),m){if(v[m]&&Hm.indexOf(m)>=0)return;v[m]="set-cookie"===m?(v[m]?v[m]:[]).concat([f]):v[m]?v[m]+", "+f:f}})),v):v},Gm=Pm.isStandardBrowserEnv()?function standardBrowserEnv(){var g,m=/(msie|trident)/i.test(navigator.userAgent),f=document.createElement("a");function resolveURL(g){var S=g;return m&&(f.setAttribute("href",S),S=f.href),f.setAttribute("href",S),{href:f.href,protocol:f.protocol?f.protocol.replace(/:$/,""):"",host:f.host,search:f.search?f.search.replace(/^\?/,""):"",hash:f.hash?f.hash.replace(/^#/,""):"",hostname:f.hostname,port:f.port,pathname:"/"===f.pathname.charAt(0)?f.pathname:"/"+f.pathname}}return g=resolveURL(window.location.href),function isURLSameOrigin(m){var f=Pm.isString(m)?resolveURL(m):m;return f.protocol===g.protocol&&f.host===g.host}}():function isURLSameOrigin(){return!0};function CanceledError(g){Nm.call(this,null==g?"canceled":g,Nm.ERR_CANCELED),this.name="CanceledError"}Pm.inherits(CanceledError,Nm,{__CANCEL__:!0});var jm=CanceledError,Wm=function parseProtocol(g){var m=/^([-+\w]{1,25})(:?\/\/|:)/.exec(g);return m&&m[1]||""},qm=function xhrAdapter(g){return new Promise((function dispatchXhrRequest(m,f){var S,v=g.data,C=g.headers,_=g.responseType;function done(){g.cancelToken&&g.cancelToken.unsubscribe(S),g.signal&&g.signal.removeEventListener("abort",S)}Pm.isFormData(v)&&Pm.isStandardBrowserEnv()&&delete C["Content-Type"];var E=new XMLHttpRequest;if(g.auth){var T=g.auth.username||"",I=g.auth.password?unescape(encodeURIComponent(g.auth.password)):"";C.Authorization="Basic "+btoa(T+":"+I)}var b=Bm(g.baseURL,g.url);function onloadend(){if(E){var S="getAllResponseHeaders"in E?$m(E.getAllResponseHeaders()):null,v={data:_&&"text"!==_&&"json"!==_?E.response:E.responseText,status:E.status,statusText:E.statusText,headers:S,config:g,request:E};Fm((function _resolve(g){m(g),done()}),(function _reject(g){f(g),done()}),v),E=null}}if(E.open(g.method.toUpperCase(),Rm(b,g.params,g.paramsSerializer),!0),E.timeout=g.timeout,"onloadend"in E?E.onloadend=onloadend:E.onreadystatechange=function handleLoad(){E&&4===E.readyState&&(0!==E.status||E.responseURL&&0===E.responseURL.indexOf("file:"))&&setTimeout(onloadend)},E.onabort=function handleAbort(){E&&(f(new Nm("Request aborted",Nm.ECONNABORTED,g,E)),E=null)},E.onerror=function handleError(){f(new Nm("Network Error",Nm.ERR_NETWORK,g,E,E)),E=null},E.ontimeout=function handleTimeout(){var m=g.timeout?"timeout of "+g.timeout+"ms exceeded":"timeout exceeded",S=g.transitional||km;g.timeoutErrorMessage&&(m=g.timeoutErrorMessage),f(new Nm(m,S.clarifyTimeoutError?Nm.ETIMEDOUT:Nm.ECONNABORTED,g,E)),E=null},Pm.isStandardBrowserEnv()){var A=(g.withCredentials||Gm(b))&&g.xsrfCookieName?xm.read(g.xsrfCookieName):void 0;A&&(C[g.xsrfHeaderName]=A)}"setRequestHeader"in E&&Pm.forEach(C,(function setRequestHeader(g,m){void 0===v&&"content-type"===m.toLowerCase()?delete C[m]:E.setRequestHeader(m,g)})),Pm.isUndefined(g.withCredentials)||(E.withCredentials=!!g.withCredentials),_&&"json"!==_&&(E.responseType=g.responseType),"function"==typeof g.onDownloadProgress&&E.addEventListener("progress",g.onDownloadProgress),"function"==typeof g.onUploadProgress&&E.upload&&E.upload.addEventListener("progress",g.onUploadProgress),(g.cancelToken||g.signal)&&(S=function(g){E&&(f(!g||g&&g.type?new jm:g),E.abort(),E=null)},g.cancelToken&&g.cancelToken.subscribe(S),g.signal&&(g.signal.aborted?S():g.signal.addEventListener("abort",S))),v||(v=null);var P=Wm(b);P&&-1===["http","https","file"].indexOf(P)?f(new Nm("Unsupported protocol "+P+":",Nm.ERR_BAD_REQUEST,g)):E.send(v)}))},zm=null,Km={"Content-Type":"application/x-www-form-urlencoded"};function setContentTypeIfUnset$1(g,m){!Pm.isUndefined(g)&&Pm.isUndefined(g["Content-Type"])&&(g["Content-Type"]=m)}function getDefaultAdapter$1(){var g;return("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(g=qm),g}function stringifySafely$1(g,m,f){if(Pm.isString(g))try{return(m||JSON.parse)(g),Pm.trim(g)}catch(g){if("SyntaxError"!==g.name)throw g}return(f||JSON.stringify)(g)}var Jm={transitional:km,adapter:getDefaultAdapter$1(),transformRequest:[function transformRequest(g,m){if(Mm(m,"Accept"),Mm(m,"Content-Type"),Pm.isFormData(g)||Pm.isArrayBuffer(g)||Pm.isBuffer(g)||Pm.isStream(g)||Pm.isFile(g)||Pm.isBlob(g))return g;if(Pm.isArrayBufferView(g))return g.buffer;if(Pm.isURLSearchParams(g))return setContentTypeIfUnset$1(m,"application/x-www-form-urlencoded;charset=utf-8"),g.toString();var f,S=Pm.isObject(g),v=m&&m["Content-Type"];if((f=Pm.isFileList(g))||S&&"multipart/form-data"===v){var C=this.env&&this.env.FormData;return Lm(f?{"files[]":g}:g,C&&new C)}return S||"application/json"===v?(setContentTypeIfUnset$1(m,"application/json"),stringifySafely$1(g)):g}],transformResponse:[function transformResponse(g){var m=this.transitional||Jm.transitional,f=m&&m.silentJSONParsing,S=m&&m.forcedJSONParsing,v=!f&&"json"===this.responseType;if(v||S&&Pm.isString(g)&&g.length)try{return JSON.parse(g)}catch(g){if(v){if("SyntaxError"===g.name)throw Nm.from(g,Nm.ERR_BAD_RESPONSE,this,null,this.response);throw g}}return g}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:zm},validateStatus:function validateStatus(g){return g>=200&&g<300},headers:{common:{Accept:"application/json, text/plain, */*"}}};Pm.forEach(["delete","get","head"],(function forEachMethodNoData(g){Jm.headers[g]={}})),Pm.forEach(["post","put","patch"],(function forEachMethodWithData(g){Jm.headers[g]=Pm.merge(Km)}));var Ym=Jm,Qm=function transformData(g,m,f){var S=this||Ym;return Pm.forEach(f,(function transform(f){g=f.call(S,g,m)})),g},Xm=function isCancel(g){return!(!g||!g.__CANCEL__)};function throwIfCancellationRequested$1(g){if(g.cancelToken&&g.cancelToken.throwIfRequested(),g.signal&&g.signal.aborted)throw new jm}var Zm=function dispatchRequest(g){return throwIfCancellationRequested$1(g),g.headers=g.headers||{},g.data=Qm.call(g,g.data,g.headers,g.transformRequest),g.headers=Pm.merge(g.headers.common||{},g.headers[g.method]||{},g.headers),Pm.forEach(["delete","get","head","post","put","patch","common"],(function cleanHeaderConfig(m){delete g.headers[m]})),(g.adapter||Ym.adapter)(g).then((function onAdapterResolution(m){return throwIfCancellationRequested$1(g),m.data=Qm.call(g,m.data,m.headers,g.transformResponse),m}),(function onAdapterRejection(m){return Xm(m)||(throwIfCancellationRequested$1(g),m&&m.response&&(m.response.data=Qm.call(g,m.response.data,m.response.headers,g.transformResponse))),Promise.reject(m)}))},ef=function mergeConfig(g,m){m=m||{};var f={};function getMergedValue(g,m){return Pm.isPlainObject(g)&&Pm.isPlainObject(m)?Pm.merge(g,m):Pm.isPlainObject(m)?Pm.merge({},m):Pm.isArray(m)?m.slice():m}function mergeDeepProperties(f){return Pm.isUndefined(m[f])?Pm.isUndefined(g[f])?void 0:getMergedValue(void 0,g[f]):getMergedValue(g[f],m[f])}function valueFromConfig2(g){if(!Pm.isUndefined(m[g]))return getMergedValue(void 0,m[g])}function defaultToConfig2(f){return Pm.isUndefined(m[f])?Pm.isUndefined(g[f])?void 0:getMergedValue(void 0,g[f]):getMergedValue(void 0,m[f])}function mergeDirectKeys(f){return f in m?getMergedValue(g[f],m[f]):f in g?getMergedValue(void 0,g[f]):void 0}var S={url:valueFromConfig2,method:valueFromConfig2,data:valueFromConfig2,baseURL:defaultToConfig2,transformRequest:defaultToConfig2,transformResponse:defaultToConfig2,paramsSerializer:defaultToConfig2,timeout:defaultToConfig2,timeoutMessage:defaultToConfig2,withCredentials:defaultToConfig2,adapter:defaultToConfig2,responseType:defaultToConfig2,xsrfCookieName:defaultToConfig2,xsrfHeaderName:defaultToConfig2,onUploadProgress:defaultToConfig2,onDownloadProgress:defaultToConfig2,decompress:defaultToConfig2,maxContentLength:defaultToConfig2,maxBodyLength:defaultToConfig2,beforeRedirect:defaultToConfig2,transport:defaultToConfig2,httpAgent:defaultToConfig2,httpsAgent:defaultToConfig2,cancelToken:defaultToConfig2,socketPath:defaultToConfig2,responseEncoding:defaultToConfig2,validateStatus:mergeDirectKeys};return Pm.forEach(Object.keys(g).concat(Object.keys(m)),(function computeConfigValue(g){var m=S[g]||mergeDeepProperties,v=m(g);Pm.isUndefined(v)&&m!==mergeDirectKeys||(f[g]=v)})),f},tf={version:"0.27.2"},nf=tf.version,rf={};["object","boolean","number","function","string","symbol"].forEach((function(g,m){rf[g]=function validator(f){return typeof f===g||"a"+(m<1?"n ":" ")+g}}));var sf={};function assertOptions$1(g,m,f){if("object"!=typeof g)throw new Nm("options must be an object",Nm.ERR_BAD_OPTION_VALUE);for(var S=Object.keys(g),v=S.length;v-- >0;){var C=S[v],_=m[C];if(_){var E=g[C],T=void 0===E||_(E,C,g);if(!0!==T)throw new Nm("option "+C+" must be "+T,Nm.ERR_BAD_OPTION_VALUE)}else if(!0!==f)throw new Nm("Unknown option "+C,Nm.ERR_BAD_OPTION)}}rf.transitional=function transitional(g,m,f){function formatMessage(g,m){return"[Axios v"+nf+"] Transitional option '"+g+"'"+m+(f?". "+f:"")}return function(f,S,v){if(!1===g)throw new Nm(formatMessage(S," has been removed"+(m?" in "+m:"")),Nm.ERR_DEPRECATED);return m&&!sf[S]&&(sf[S]=!0,console.warn(formatMessage(S," has been deprecated since v"+m+" and will be removed in the near future"))),!g||g(f,S,v)}};var af={assertOptions:assertOptions$1,validators:rf},of=af.validators;function Axios$1(g){this.defaults=g,this.interceptors={request:new wm,response:new wm}}Axios$1.prototype.request=function request(g,m){"string"==typeof g?(m=m||{}).url=g:m=g||{},(m=ef(this.defaults,m)).method?m.method=m.method.toLowerCase():this.defaults.method?m.method=this.defaults.method.toLowerCase():m.method="get";var f=m.transitional;void 0!==f&&af.assertOptions(f,{silentJSONParsing:of.transitional(of.boolean),forcedJSONParsing:of.transitional(of.boolean),clarifyTimeoutError:of.transitional(of.boolean)},!1);var S=[],v=!0;this.interceptors.request.forEach((function unshiftRequestInterceptors(g){"function"==typeof g.runWhen&&!1===g.runWhen(m)||(v=v&&g.synchronous,S.unshift(g.fulfilled,g.rejected))}));var C,_=[];if(this.interceptors.response.forEach((function pushResponseInterceptors(g){_.push(g.fulfilled,g.rejected)})),!v){var E=[Zm,void 0];for(Array.prototype.unshift.apply(E,S),E=E.concat(_),C=Promise.resolve(m);E.length;)C=C.then(E.shift(),E.shift());return C}for(var T=m;S.length;){var I=S.shift(),b=S.shift();try{T=I(T)}catch(g){b(g);break}}try{C=Zm(T)}catch(g){return Promise.reject(g)}for(;_.length;)C=C.then(_.shift(),_.shift());return C},Axios$1.prototype.getUri=function getUri(g){g=ef(this.defaults,g);var m=Bm(g.baseURL,g.url);return Rm(m,g.params,g.paramsSerializer)},Pm.forEach(["delete","get","head","options"],(function forEachMethodNoData(g){Axios$1.prototype[g]=function(m,f){return this.request(ef(f||{},{method:g,url:m,data:(f||{}).data}))}})),Pm.forEach(["post","put","patch"],(function forEachMethodWithData(g){function generateHTTPMethod(m){return function httpMethod(f,S,v){return this.request(ef(v||{},{method:g,headers:m?{"Content-Type":"multipart/form-data"}:{},url:f,data:S}))}}Axios$1.prototype[g]=generateHTTPMethod(),Axios$1.prototype[g+"Form"]=generateHTTPMethod(!0)}));var lf=Axios$1;function CancelToken$1(g){if("function"!=typeof g)throw new TypeError("executor must be a function.");var m;this.promise=new Promise((function promiseExecutor(g){m=g}));var f=this;this.promise.then((function(g){if(f._listeners){var m,S=f._listeners.length;for(m=0;m<S;m++)f._listeners[m](g);f._listeners=null}})),this.promise.then=function(g){var m,S=new Promise((function(g){f.subscribe(g),m=g})).then(g);return S.cancel=function reject(){f.unsubscribe(m)},S},g((function cancel(g){f.reason||(f.reason=new jm(g),m(f.reason))}))}CancelToken$1.prototype.throwIfRequested=function throwIfRequested(){if(this.reason)throw this.reason},CancelToken$1.prototype.subscribe=function subscribe(g){this.reason?g(this.reason):this._listeners?this._listeners.push(g):this._listeners=[g]},CancelToken$1.prototype.unsubscribe=function unsubscribe(g){if(this._listeners){var m=this._listeners.indexOf(g);-1!==m&&this._listeners.splice(m,1)}},CancelToken$1.source=function source(){var g;return{token:new CancelToken$1((function executor(m){g=m})),cancel:g}};var cf=CancelToken$1,df=function spread(g){return function wrap(m){return g.apply(null,m)}},hf=function isAxiosError(g){return Pm.isObject(g)&&!0===g.isAxiosError};function createInstance$1(g){var m=new lf(g),f=fm(lf.prototype.request,m);return Pm.extend(f,lf.prototype,m),Pm.extend(f,m),f.create=function create(m){return createInstance$1(ef(g,m))},f}var uf=createInstance$1(Ym);uf.Axios=lf,uf.CanceledError=jm,uf.CancelToken=cf,uf.isCancel=Xm,uf.VERSION=tf.version,uf.toFormData=Lm,uf.AxiosError=Nm,uf.Cancel=uf.CanceledError,uf.all=function all(g){return Promise.all(g)},uf.spread=df,uf.isAxiosError=hf;var gf=uf,pf=uf;gf.default=pf;var mf=gf;class HttpRequestHelper{constructor(g,m){this.logger=g,this.proxy=m}async sendRequestWithRetry(g,m,f,S,v,C=1,_){if(C>v)throw new Error("Max retry reached");S.timeout||(S.timeout=2e4),S.maxRedirects=0,this.proxy&&(m=this.proxy.proxyfyUrl(m));try{switch(g){case"post":default:return await mf.post(m,f,S);case"get":return await mf.get(m,S);case"put":return await mf.put(m,f,S);case"delete":return await mf.delete(m,S)}}catch(E){let T=E?.response?.status;this.logger.error(`Found error for request ${g} ${m} ${T||""}`);const I=C+1;if(I<=v){let C=m;if(E&&E.response)if(301===E.response.status||302===E.response.status||303===E.response.status||307===E.response.status||404===E.response.status)C=E.response.headers&&E.response.headers.location?E.response.headers.location:C;else if(E.response.status<500)throw E;return this.logger.error(`Retrying, attempt #${I} url=${C}`),await new Promise((g=>setTimeout(g,_))),this.sendRequestWithRetry(g,C,f,S,v,I,_)}throw E}}}const ff={callNotification:"callNotification",conversationInvitation:"conversationInvitation",debugContent:"debugContent",groupContext:"groupContext"};class IncomingCallPushNotificationHandler{get callId(){return this._callId}get localParticipantId(){return this._localParticipantId}constructor(g,m,f){if(this._callId="",this._localParticipantId="",this._logger=f.createChild("IncomingCallPushNotificationHandler"),!g.incomingCallContext)throw new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD_NO_CONTEXT_PROVIDED);if(Object.keys(g).length>1)throw new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_NO_PAYLOAD);if(this._payload=g,this._incomingCallContext=this._payload.incomingCallContext,this._tsCallRegistry=m,this._gp=JSON.parse(Mh.inflate(atob(this._incomingCallContext),{to:"string"})),!(this._gp.hasOwnProperty(ff.callNotification)&&this._gp.hasOwnProperty(ff.conversationInvitation)&&this._gp.hasOwnProperty(ff.debugContent)&&this._gp.hasOwnProperty(ff.groupContext)))throw this._logger.error(`Missing incoming call context data. Found: ${Object.keys(this._gp)}`),new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_INVALID_PAYLOAD);this._callId=this._gp.debugContent.callId,this._localParticipantId=this._gp.debugContent.participantId}async process(){try{if(this._tsCallRegistry.calls.some((g=>g.callId==this._callId)))throw new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_ALREADY_PROCESSED);const g=defer$1(),callAddedListener=m=>{const checkNotified=()=>{m.callId===this._callId&&m.participantId===this._localParticipantId&&1===m.state&&g.resolve()};this._tsCallStateSub=m.on("callStateChanged",checkNotified),checkNotified()};this._tsCallRegistrySub=this._tsCallRegistry.on("callAdded",callAddedListener);const m={eventId:Oo,body:{gp:this._gp}};if(!this._tsCallRegistry.incomingCallMessageHandler.handleMessage(m))throw new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_FAILED_TO_PROCESS);setTimeout((()=>{g.isPending()&&g.reject(new CallingCommunicationError(z.CALL_AGENT.INCOMING_PUSH_NOTIFICATION_CALL_MISSED))}),5e3),await g.promise}catch(g){throw g}finally{this._tsCallRegistrySub?.dispose(),this._tsCallStateSub?.dispose()}}}const Sf=0,vf=220004,yf=220005;class AcsMiddleTierPolicyService{constructor(m){this._httpRequestHelper=m,this._isPolicyFetchApplicable=!1,this._policySettingData={};const f=g("ACS");this._logger=new DefaultLogger(f)}initialize(g){this._localParticipant=g.localParticipant,this._skypeToken=g.skypeToken,this._userDialedPstnNumber=g.pstnNumber,this._emergencyNumber=this._userDialedPstnNumber,this._telemetryLogManager=g.telemetryLogManager}async fetchUserPoliciesFromAcsMiddleTier(g,m,f){this._callId=g,this._participantId=m;let S="",v={};const C=+new Date;if(this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.attempt,timestampInfo:"",additionalDetails:""}),!this._localParticipant){const g=+new Date,m=new CallingCommunicationError(z.CTE_MID_TIER_POLICY_SERVICE.TEAMS_USER_ID_NOT_PROVIDED);throw this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:g-C},additionalDetails:{failureReason:m.message,code:m.code,subCode:m.subCode,resultCategories:m.resultCategories,...extractCommunicationServicesErrorForTelemetry(m)}}),m}if(f){let g=f.policyUrlSuffix;S=0==g.indexOf("/")?getAcsEcsConfig().MiddleTier.baseServiceUrl+g:getAcsEcsConfig().MiddleTier.baseServiceUrl+"/"+g,v={id:this._localParticipant,userPolicies:f.userPolicies,userProperties:f.userProperties}}else S=getAcsEcsConfig().MiddleTier.baseServiceUrl+getAcsEcsConfig().MiddleTier.policyUrlSuffix,v={id:this._localParticipant};const _=this.getAmtRequestHeader();try{let g=await this._httpRequestHelper.sendRequestWithRetry("post",S,v,{headers:_},getAcsEcsConfig().MiddleTier.maxRetry);this._policySettingData=g?.data;const m=+new Date;this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:m-C},additionalDetails:{phrase:"Teams user policy was fetched successfully from ACS MiddleTier Service",code:Sf,subCode:vf}})}catch(g){const m=+new Date,f=handleFetchPoliciesFromAcsMiddleTierFailure(g,z.CTE_MID_TIER_POLICY_SERVICE.FETCH_POLICY);throw this._logger.error(f.message),this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_policy,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:m-C},additionalDetails:{failureReason:f.message,code:f.code,subCode:f.subCode,resultCategories:f.resultCategories}}),f}}isEvEnabled(){let g=this._policySettingData?.userAggregatedPolicySettingData?.userProperties;return g?.evEnabled||!1}isMoHEnabled(){let g=this._policySettingData?.userAggregatedPolicySettingData?.userPolicies?.teamsCallingPolicy,m=g?.musicOnHoldEnabledType;return this._logger.info("Checking Music on Hold Policy, Enabled Type is: "+m),m===(gu.Enabled||gu.UserOverride)}getTeamsUserCaptionsPoliciesData(){const g=+new Date;let m="";this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.attempt,timestampInfo:"",additionalDetails:""});let f=this._policySettingData.userAggregatedPolicySettingData,S=f?.userPolicies,v=f?.userProperties;if(!S?.teamsCallingPolicy){const m=+new Date,f=new CallingCommunicationError(z.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_CALLINGPOLICY_FETCHING_FAILED);this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:f.message,code:f.code,subCode:f.subCode,...extractCommunicationServicesErrorForTelemetry(f)}})}if(!S?.teamsMeetingPolicy){const m=+new Date,f=new CallingCommunicationError(z.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_MEETINGPOLICY_FETCHING_FAILED);this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:f.message,code:f.code,subCode:f.subCode,...extractCommunicationServicesErrorForTelemetry(f)}})}if(!v?.featureTypes){const m=+new Date,f=new CallingCommunicationError(z.CTE_MID_TIER_POLICY_SERVICE.TEAMSUSER_FEATURETYPE_TEAMSPROMGMT_FETCHING_FAILED);this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:m-g},additionalDetails:{failureReason:f.message,code:f.code,subCode:f.subCode,...extractCommunicationServicesErrorForTelemetry(f)}})}if(S?.teamsCallingPolicy||S?.teamsMeetingPolicy||v?.featureTypes?.includes(cl.TeamsProMgmt)){m=JSON.stringify({isLiveCaptionsEnabledForCalling:S?.teamsCallingPolicy?.liveCaptionsEnabledTypeForCalling===dl.DisabledUserOverride,isLiveCaptionsEnabledForMeeting:S?.teamsMeetingPolicy?.liveCaptionsEnabledType===dl.DisabledUserOverride,isTeamsProMgmtSkuAvailable:v?.featureTypes?.includes(cl.TeamsProMgmt)??!1});const f=+new Date;this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_fetch_user_policies_for_captions,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{phrase:"Fetching Captions policy from ACS MiddleTier Service response was successful",code:Sf}}),this._logger.info(`Fetching user's captions policy content = ${m}`)}return m}getEmergencyContent(){const g=+new Date;this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.attempt,timestampInfo:"",additionalDetails:""});let m="";try{let f=this._policySettingData.userAggregatedPolicySettingData,S=f?.userPolicies,v=!1,C="";if(S?.locationPolicy?.emergencyNumbers){let g=S.locationPolicy.emergencyNumbers||[];this.isPhoneNumberInLocationPolicy(g)&&(v=!0,m=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:f?.userProperties.region,locationPolicyTag:S?.locationPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:S?.teamsEmergencyCallingPolicy?.policyDocument}),C="LocationPolicy")}if(!v&&S?.teamsEmergencyCallRoutingPolicy){let g=S?.teamsEmergencyCallRoutingPolicy?.emergencyNumbers||[];this.isPhoneNumberInTeamsEmergenencyRoutingPolicy(g)&&(v=!0,m=JSON.stringify({enableSecurityMemberNotifications:this.isSecurityDeskEnabled(),callerLocation:f?.userProperties.region,teamsEmergencyCallRoutingPolicyTag:S?.teamsEmergencyCallRoutingPolicy?.policyDocument,teamsEmergencyCallingPolicyTag:S?.teamsEmergencyCallingPolicy?.policyDocument}),C="TeamsEmergencyCallingRoutingPolicy")}const _=v?`Created Emergency policy using ${C}`:"This is NOT an emergency call",E=+new Date;return this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:E-g},additionalDetails:{phrase:"Deriving Emergency policy from ACS MiddleTier Service response was successful",code:Sf,subCode:yf}}),this._logger.info(`Deriving emergency policy message = ${_}. Emergency Content = ${m}`),m}catch(m){const f=+new Date,S=new CallingCommunicationError(z.CTE_MID_TIER_POLICY_SERVICE.DERIVE_EMERGENCY_POLICY,m);throw this.sendMiddleTierPolicyEvent({eventName:kh.acs_calling_middletier_gateway_emergency_content,callId:this._callId,localParticipantId:this._participantId,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,resultCategories:S.resultCategories,...extractCommunicationServicesErrorForTelemetry(S)}}),S}}isFetchUserPoliciesAndSettingsApplicable(g,m){return isNullOrUndefined$2(g)||isNullOrUndefined$2(m)||(this._isPolicyFetchApplicable=this.verifyFetchUserPoliciesSettings(g,m)),this._isPolicyFetchApplicable}getEmergencyNumber(){return this._emergencyNumber}getUserDialedPstnNumber(){return this._userDialedPstnNumber}getUserPolicy(){return this._policySettingData.userAggregatedPolicySettingData?.userPolicies}isPhoneNumberInLocationPolicy(g){if(!isNullOrUndefined$2(g))for(let m of g)if(m.dialString===this._userDialedPstnNumber||!isNullOrUndefined$2(m.dialMask?.split(";").find((g=>g===this._userDialedPstnNumber))))return this._emergencyNumber=m.dialString,!0;return!1}isPhoneNumberInTeamsEmergenencyRoutingPolicy(g){if(!isNullOrUndefined$2(g))for(let m of g)if(m.emergencyDialString===this._userDialedPstnNumber||!isNullOrUndefined$2(m.emergencyDialMask?.split(";").find((g=>g===this._userDialedPstnNumber))))return this._emergencyNumber=m.emergencyDialString,!0;return!1}verifyFetchUserPoliciesSettings(g,m){let f=getAcsEcsConfig().MiddleTier;return f.enabled?f.userPolicySettingsApi?g?Array.isArray(m)&&(m.length>1||!S(m[0]))?(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):Array.isArray(m)||S(m)?(this._logger.info("Teams user is eligible to fetch policies and settings from MiddleTier Service "),!0):(this._logger.info("Target particpant (Callee) is not a PSTN Number"),!1):(this._logger.info("Originator (Caller) is not a Teams User"),!1):(this._logger.info("ACS MiddleTier Policy API is disabled"),f.userPolicySettingsApi):(this._logger.info("ACS MiddleTier service is disabled"),f.enabled)}isSecurityDeskEnabled(){let g=this._policySettingData.userAggregatedPolicySettingData?.userPolicies?.teamsEmergencyCallingPolicy;return!(isNullOrUndefined$2(g?.notificationGroup)&&isNullOrUndefined$2(g?.notificationDialOutNumber)||0==g?.notificationGroup?.trim().length&&0==g?.notificationDialOutNumber?.trim().length)}getAmtRequestHeader(){return{"Content-Type":"application/json","X-Skypetoken":this._skypeToken||"","Access-Control-Allow-Origin":"*","X-Microsoft-Skype-Chain-ID":this._callId}}sendMiddleTierPolicyEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this._logger.debug("Unable to send AcsMiddleTierPolicyService telemetry")}}}var Cf,__decorate$m=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$m=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let _f=1;class CallAgentCommonImpl{get kind(){return this._kind}get connectionState(){return this._connectionState}constructor(g,m,f,S,v,C,_){this._callClient=g,this._disposed=!1,this.tokenProvider=async g=>{if(this._parsedTokenCredential.exp<Date.now()&&!g)throw this.updateConnectionState("tokenExpired"),new CallingCommunicationError(z.CALL_AGENT.ACCESSTOKEN_EXPIRED);if(!this._communicationTokenCredential)throw new CallingCommunicationError(z.CALL_AGENT.GET_TOKEN_BEFORE_INIT);const m=await parseTokenCredential(this._communicationTokenCredential,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal});return m.acsResourceId===this._parsedTokenCredential?.acsResourceId&&m.identityMri===this._parsedTokenCredential?.identityMri||logErrorAndThrow(z.CALL_AGENT.REFRESHED_TOKEN_INVALID_USERID,this.logger),g?this._tokenFetchTries+=1:this._tokenFetchTries=0,this._tokenFetchTries>this._maxNmberOfRetries&&(this.sendTokenExpiredEvent(),this.updateConnectionState("tokenExpired"),this._disposed||await this.dispose(),logErrorAndThrow(z.CALL_AGENT.REFRESHED_TOKEN_RETRIES,this.logger)),m.jwtToken},this.sendTokenChangedEvent=(g,m)=>{try{this._telemetryLogManager.sendEvent({name:m?kh.acs_calling_token_expiration_changed:kh.acs_calling_token_expiration_changed_failure,tenant:so,properties:{deltaTimeInMs:g}})}catch(g){this.logger.debug("Unable to send token change telemetry")}},this.sendTokenExpiredEvent=()=>{try{this._telemetryLogManager.sendEvent({name:kh.acs_calling_token_expired,tenant:so})}catch(g){this.logger.debug("Unable to send token expired telemetry")}},this.logger=m.createChild("CallAgent"+_f++),this._telemetryLogManager=S,this._kind=C,this._connectionState="Connected",this._eventEmitter=new CallingEventEmitter(this.logger),this.clientId=f,this._abortController=new AbortController,this._maxDisplayNameLength=getAcsEcsConfig()?.calling?.maxDisplayNameLength||Po,this._previousTokenExpiration=0,this._tokenFetchTries=0,this._maxNmberOfRetries=getAcsEcsConfig()?.calling?.maxNumberOfTokenFetchRetries||Co,this._callStack=v,this.acsProxy=this._callClient.acsProxy,this.acsCustomRelayManager=this._callClient.acsCustomRelayManager,this._httpRequestHelper=new HttpRequestHelper(this.logger,this.acsProxy),this.mtPolicyService=new AcsMiddleTierPolicyService(this._httpRequestHelper),this._parsedTokenCredential={jwtToken:"",acsResourceId:void 0,identityMri:"",cloudType:ca.Public,isCte:!1,region:"",rgnClaimExists:!1,exp:0},this._caConfigBag={clientId:"",acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?fa.Enterprise:fa.Consumer,region:this._parsedTokenCredential.region,emergencyCountryCode:void 0,IsUserEmergencyCountryCode:!1},this.deviceManager=_,this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{callClient:this._callClient,callAgent:this},{tsStack:this.tsStack,callAgent:this,telemetryLogManager:this._telemetryLogManager});const E=getRegisteredFeatures(Pu.CallAgentFeature);for(const g of E)"OnExtendedObjectConstructor"===g.activationOptions.activationEvent&&this.feature(g);this._trouterStateChangeCallback=g=>{this.logger.log(`Callback Trouter state changed to ${g}`),this.updateConnectionState("trouterChanged")},this._registrarStateChangeCallback=g=>{this.logger.log(`Callback Registrar state changed to ${g}`),this.updateConnectionState("registrarChanged")}}getHttpRequestHelper(){return this._httpRequestHelper}getTrouterState(){return this._callStack?this._callStack.getTrouterState():"Unknown"}onTrouterStateChanged(g){return this._callStack.onTrouterStateChanged(g)}offTrouterStateChanged(g){return this._callStack.offTrouterStateChanged(g)}getAcsResourceId(){return this._parsedTokenCredential?.acsResourceId||""}getUserMri(){return`8:${this._parsedTokenCredential?.identityMri}`||""}getUserPolicy(){return this._userPolicies}async initialize(g,m,f){const S=+new Date;try{if(this.sendCallAgentInitializiedEvent(kh.acs_calling_call_agent_init_attempt,{attemptTimestamp:S}),this._communicationTokenCredential=g,this._parsedTokenCredential=await parseTokenCredential(g,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._kind!==J.TeamsCallAgent||this._parsedTokenCredential.isCte?this._kind===J.CallAgent&&this._parsedTokenCredential.isCte&&logErrorAndThrow(z.CALL_AGENT.ACS_CALLAGENT_TOKEN_ONLY,this.logger):logErrorAndThrow(z.CALL_AGENT.TEAMS_CALLAGENT_TOKEN_ONLY,this.logger),f?.displayName){if(this._parsedTokenCredential.isCte)throw new CallingCommunicationError(z.CALL_AGENT.CTE_DISPLAY_NAME);if(f?.displayName.length>this._maxDisplayNameLength)throw new CallingCommunicationError(z.CALL_AGENT.DISPLAYNAME_TOO_LONG)}if(this._parsedTokenCredential.cloudType===ca.Public&&(!this._parsedTokenCredential.region||""===this._parsedTokenCredential.region)){try{const g=+new Date-S;this._telemetryLogManager.sendEvent({name:kh.acs_calling_token_has_no_data_location,tenant:so,properties:{deltaTimeInMs:g}})}catch(g){this.logger.debug("Unable to send token has no data location assigned")}this._parsedTokenCredential.region=this._parsedTokenCredential.rgnClaimExists?va[0]:Sa[0],this.logger.info("Used default data location because token has no data location assigned")}this._caConfigBag={clientId:this.clientId,acsResourceId:this._parsedTokenCredential.acsResourceId,identityMri:this._parsedTokenCredential.identityMri,cloudType:this._parsedTokenCredential.cloudType,identityType:this._parsedTokenCredential.isCte?fa.Enterprise:fa.Consumer,emergencyCountryCode:f?.emergencyCallOptions?.countryCode,region:this._parsedTokenCredential.region,IsUserEmergencyCountryCode:!!f?.emergencyCallOptions?.countryCode},this.addToCallAgentsMap(this._parsedTokenCredential),this.onDisposedCallback=m;const v=this._communicationTokenCredential.getToken;this._disposed=!1;const wrappedGetToken=async g=>{const m=+new Date;try{const f=await v.apply(this._communicationTokenCredential,[g]),S=+new Date;return f.expiresOnTimestamp!==this._previousTokenExpiration&&(this.sendTokenChangedEvent(S-m,!0),this._previousTokenExpiration=f.expiresOnTimestamp),f}catch(g){const f=+new Date;this._previousTokenExpiration=0,this.sendTokenChangedEvent(f-m,!1),logErrorAndThrow(z.CALL_AGENT.FAILED_TO_GET_TOKEN,this.logger)}};g.getToken=wrappedGetToken;try{this.runningEnvironmentInfo=await this._callClient.getEnvironmentInfoInternal()}catch(g){this.logger.debug("Unable to get the running environment info")}if(this.tsStack=await this._callStack.initializeStackForUser(this.tokenProvider,this._caConfigBag),this._parsedTokenCredential.rgnClaimExists)try{await this.updateParsedTokenCredentials(g)}catch(g){this.logger.debug(`Failed to update parsed token credentials. Error message = ${g?.message||""}`)}this._telemetryLogManager.initialize(this._caConfigBag),this._tsCallRegistry=await this.initializeCallRegistry(this.tsStack,f),this.registerConnectionStateEventHandlers();const C=+new Date;this.sendCallAgentInitializiedEvent(kh.acs_calling_call_agent_init_success,{deltaTimeInMs:C-S})}catch(g){this._caConfigBag&&!this._telemetryLogManager.isInitialized()&&this._telemetryLogManager.initialize(this._caConfigBag);const m=new CallingCommunicationError(z.CALL_AGENT.INIT_FAIL,g);this.removeFromCallAgentsMap(this._parsedTokenCredential);const f=+new Date;throw this.sendCallAgentInitializiedEvent(kh.acs_calling_call_agent_init_failure,{deltaTimeInMs:f-S},m),this._telemetryLogManager.clearTelemetryLoggers(),m}}isCteUser(){return void 0!==this._parsedTokenCredential?.isCte&&this._parsedTokenCredential?.isCte}getClientId(){return this.clientId}getCallByCallId(g,m){return m?this._tsCallRegistry.getCall(g,m):this._tsCallRegistry.calls.filter((m=>m.callId===g))?.[0]}createTransferTargetCall(g){const m=w.generateCauseId(),f=generateGuid(),S=generateGuid(),v=this._tsCallRegistry.createCall("",f,S,void 0,m),C=this.createNewCall(f,v);return this.addToCallArray(C),this.handleCallState(C),v.addParticipant(g.targetMri).catch((()=>{this.logger.error("Failed to add participant for transer call")})),C.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[C],removed:[]}),C}getEcsConfigIds(){return this._callStack.getEcsConfigIds()}feature(g){return this._extensibleApi.getApiObjectInstance(g.callAgentApiCtor)}async handlePushNotification(g){const m=generateGuid(),f=+new Date;let S;try{if(this.sendHandlePushNotificationEvent({eventName:kh.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:"",localParticipantId:"",kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),!g.incomingCallContext)throw new CallingCommunicationError(z.CALL_AGENT.INVALID_PUSHNOTIFICAITON_DATA);S=new IncomingCallPushNotificationHandler(g,this._tsCallRegistry,this.logger),await S.process(),this.sendHandlePushNotificationEvent({eventName:kh.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:S.callId,localParticipantId:S.localParticipantId,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:""})}catch(g){const v=new CallingCommunicationError(z.CALL_AGENT.PUSHNOTIFICAITON_FAIL,g);throw this.sendHandlePushNotificationEvent({eventName:kh.acs_calling_handle_push_notification,correlationId:m,featureName:"handlePushNotification",operationName:"handleIncomingCallPushNotification",callId:S?.callId||"",localParticipantId:S?.localParticipantId||"",kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:{failureReason:v.message,code:v.code,...extractCommunicationServicesErrorForTelemetry(v)}}),v}}getDeviceType(){const g=this._callClient?.firstPartyOptions?.acsDeviceType;return g?il[g]:"default"}trackCallEndTimeToStopTelemetry(g){0===g.length?TelemetryLogManager.callEndTimestamp=Date.now():TelemetryLogManager.callEndTimestamp=Number.MAX_SAFE_INTEGER}updateConnectionState(g){const m=this.getCallAgentConnectionState(),f=this.getTrouterState(),S=this._callStack?.isRegistered()?"Connected":"Disconnected",v="Connected"===m?void 0:"tokenExpired"==g?"tokenExpired":"signalingIssue";if(m!==this._connectionState||v!==this._connectionStateReason){this.sendCallAgentInfoEvent({eventName:kh.acs_calling_call_agent,additionalDetails:{step:"connectionState-changed",oldState:this._connectionState,newState:m,trouterState:f,registrarState:S,reason:v}});const g={oldValue:this._connectionState,newValue:m,reason:v};this._connectionState=m,this._connectionStateReason=v,this._eventEmitter.emit("connectionStateChanged",g)}}sendCallAgentInfoEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{...g.additionalDetails}})}catch(g){this.logger.debug("Failed to send connection state changed event",g)}}sendCallAgentInitializiedEvent(g,m,f){try{let S="string"==typeof f?.message?f?.message:void 0;g!==kh.acs_calling_call_agent_init_failure&&(S=void 0);let v=f?extractCommunicationServicesErrorForTelemetry(f):void 0;this._telemetryLogManager.sendEvent({name:g,tenant:so,properties:{...m,isSupportedEnvironment:this.runningEnvironmentInfo?.isSupportedEnvironment,failureReason:S,additionalInformation:{trouterState:this.getTrouterState()},additionalDetails:{...v}}})}catch(g){this.logger.debug("Unable to send telemtery")}}sendHandlePushNotificationEvent(g){try{this._telemetryLogManager?.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send handle push notification telemetry")}}async initializeCallRegistry(g,m){let f=m?.displayName;const S=await this.getCallRegistry(g,this._parsedTokenCredential,this.tokenProvider,f);return this.logger.info(`registry created for version number=${getSdkVersion()}`),S}async getCallRegistry(g,m,f,S){const v={id:m.identityMri,displayName:S||"",tokenProvider:f},C=await g.createCallRegistry(v);await C.login(v);const _=getAcsEcsConfig()?.tsCalling?.accountConfiguration?.ring||void 0,E=m.isCte?fa.Enterprise:fa.Consumer,T=m.acsResourceId,I=m.region;let b={acsResourceId:T,clientType:E,ring:_};getAcsEcsConfig().calling.setDeviceType&&(b.deviceType=this.getDeviceType());const A=getAcsEcsConfig().calling.eudb;return A.isEnabled&&A.sendRegionToNgc&&(A.isRgnClaimEnabledForACS||m.isCte)&&(b={...b,region:I}),getAcsEcsConfig()?.calling.supportLiveStreaming&&(b.clientSupportsUms=!0),C.setConfiguration(b),C.on("callAdded",this.handleCallAdded),C.on("callRemoved",this.handleCallRemoved),S&&C.updateDisplayName(S),C}async updateParsedTokenCredentials(g){this._parsedTokenCredential=await parseTokenCredential(g,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS,{abortSignal:this._abortController.signal}),this._caConfigBag.region=this._parsedTokenCredential.region}registerConnectionStateEventHandlers(){this._callStack.onRegisteredChanged(this._registrarStateChangeCallback),this.onTrouterStateChanged(this._trouterStateChangeCallback)}getCallAgentConnectionState(){return this._callStack?.isRegistered()&&"Connected"===this.getTrouterState()?"Connected":this._callStack?.isRegistered()||"Disconnected"!==this.getTrouterState()?"Connecting":"Disconnected"}}__decorate$m([loggerProperty,__metadata$m("design:type",Object)],CallAgentCommonImpl.prototype,"logger",void 0),__decorate$m([asyncOperation(Jh.Initialize),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object,Function,Object]),__metadata$m("design:returntype",Promise)],CallAgentCommonImpl.prototype,"initialize",null),__decorate$m([syncOperation(Jh.Feature),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object]),__metadata$m("design:returntype","function"==typeof(Cf="undefined"!=typeof TFeature&&TFeature)?Cf:Object)],CallAgentCommonImpl.prototype,"feature",null),__decorate$m([asyncOperation(Jh.HandlePushNotification),__metadata$m("design:type",Function),__metadata$m("design:paramtypes",[Object]),__metadata$m("design:returntype",Promise)],CallAgentCommonImpl.prototype,"handlePushNotification",null);var __decorate$n=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$n=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const Ef=new Map;class CallAgentImpl extends CallAgentCommonImpl{get calls(){return this._calls}constructor(g,m,f,S,v,C,_){super(g,m,S,v,f,J.CallAgent,C),this._calls=[],this.handleCallRemoved=g=>{this.logger.info(`removing callId=${g.callId}`);const m=this._calls.find((m=>m.id===g.callId));if(m){const g=this._calls.indexOf(m);-1!==g&&this._calls.splice(g,1),m.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[m]}),this.logger.info("call removed")}},this.handleCallAdded=g=>{if(!this._calls.find((m=>m.id===g.callId))){const m=g.on("callStateChanged",(()=>{if(1===g.state){const f=g.callId;m.dispose();const S=new CallImpl({callId:f,isIncoming:!0},this,g,this._telemetryLogManager),v=new IncomingCallImpl(S);this.handleCallState(S),S.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:v})}}))}},this.handleCallState=g=>{g.on("stateChanged",(()=>{try{if("Disconnected"===g.state){this.tsStack?(this._tsCallRegistry.deleteCall(g.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${g.id}`),g.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(g.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry")}else"Connecting"===g.state&&"Incoming"==g.direction&&(this.addToCallArray(g),this._eventEmitter.emit("callsUpdated",{added:[g],removed:[]}))}catch(g){this.logger.error("Failed to handle call state changed event")}}))},this.displayName=_?.displayName}addToCallAgentsMap(g){Ef.get(g?.identityMri)&&logErrorAndThrow(z.CALL_AGENT.ACS_CALLAGENT_ALREADY_EXSISTS,this.logger),Ef.set(g?.identityMri,this)}removeFromCallAgentsMap(g){g?.identityMri&&Ef.get(g?.identityMri)===this&&Ef.delete(g?.identityMri)}async getExistingCallAgentWithToken(g){try{const m=await parseTokenCredential(g,getAcsEcsConfig().calling.eudb.isRgnClaimEnabledForACS);return Ef.get(m.identityMri)}catch(g){throw new CallingCommunicationError(z.CALL_AGENT.PARSE_ACCESSTOKEN,g)}}createNewCall(g,m){return new CallImpl({callId:g},this,m,this._telemetryLogManager)}addToCallArray(g){this._calls.push(g),this.trackCallEndTimeToStopTelemetry(this._calls)}startCall(g,m){if(this.assertCallUserIds(g),m?.alternateCallerId&&validateIdentifier(m.alternateCallerId),g.find((g=>getMriFromIdentifier(g)===this.getUserMri())))throw new CallingCommunicationError(z.CALL_AGENT.CANT_CALL_YOURSELF);let f=m?.audioOptions?.muted;return void 0===f&&(f=!1),this.logger.info(`startCall with video=${!!m?.videoOptions},muted=${f}`),this.createCall({participants:g,startCallOptions:m})}join(g,m){if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,void 0,g))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN);this.assertCallContext(g);let f=m?.audioOptions?.muted;return void 0===f&&(f=!1),this.logger.info(`join with video=${!!m?.videoOptions},muted=${f}`),this.createCall({callContext:g,startCallOptions:m})}async dispose(){if(this._disposed)throw new CallingCommunicationError(z.CALL_AGENT.ACS_ALREADY_DISPOSED);this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&Ef.delete(this._parsedTokenCredential?.identityMri);try{const g=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(g))}catch(g){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError(z.CALL_AGENT.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError(z.CALL_AGENT.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}createCall(g){if(g?.startCallOptions?.firstPartyOptions?.isImmersiveMode&&"meshV2"!==this.getDeviceType())throw new CallingCommunicationError(z.CALL_AGENT.MESH_DEVICETYPE_V2);let m,f,S,v,C=g?.callContext?.threadId||g?.startCallOptions?.threadId,_=g?.callContext?.groupId;const E=g?.callContext?.roomId,T=g?.callContext?.meetingLink,I=g?.callContext?.meetingId,b=g?.callContext?.passcode||"";if(_&&_.startsWith("19:")&&(C=_,_=""),T){getAcsEcsConfig().calling.tfl.isEnabled&&this.isTflMeetingLink(T.trim().toLocaleLowerCase())?S=parseTflMeetingLink(T):f=parseMeetingUrl(T)}if(g?.callContext?.threadId&&g?.callContext?.organizerId&&g?.callContext?.tenantId&&(f={threadId:g?.callContext?.threadId,messageId:g?.callContext?.messageId?g?.callContext?.messageId.toString():"0",organizerId:g?.callContext?.organizerId,tenantId:g?.callContext?.tenantId}),f&&(v={meetingType:"0"===f.messageId?1:2,tenantId:f.tenantId,organizerId:f.organizerId,replyChainMessageId:f.messageId}||void 0,C=f.threadId,m=f.messageId),this.tsStack){const f=w.generateCauseId(),T=generateGuid(),A=generateGuid();let P;if(_)P=this._tsCallRegistry.createCallWithGroupId(_,T,A,f);else if(I)P=this._tsCallRegistry.createCallWithMeetingData({meetingCode:I,passcode:b,threadId:C},T,A,f);else if(E)P=this._tsCallRegistry.createCallWithMeetingData({meetingCode:E},T,A,f);else if(S)P=this._tsCallRegistry.createCallWithMeetingData(S,T,A,f);else{const S=!!g?.participants&&g.participants.length>=2&&IsAdhocInteropCall(g.participants);getAcsEcsConfig().calling.enableSmePassFakeConversation&&!C&&S&&(C=`${G}${generateGuid()}`),P=this._tsCallRegistry.createCall(C||"",T,A,m,f)}const R=new CallImpl({callId:T,roomId:E},this,P,this._telemetryLogManager);this.addToCallArray(R),this.handleCallState(R);const M={threadId:C||"",messageId:m||"",meetingInfo:v,mediaPeerType:2};return g?.participants&&g?.participants.forEach((g=>{P.addParticipant(getMriFromIdentifier(g)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),R.startCallInternal(g?.startCallOptions,!!I||!!E,g?.callContext,M).catch(noop),R.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[R],removed:[]}),R}throw new CallingCommunicationError(z.CALL_AGENT.STACK_NOT_INIT)}assertCallContext(g){if(!g||this.checkForAtLeastOneValidCallConfig(g)||this.checkIfMultiplesConfigsWereSpecified(g)||this.checkForInvalidTeamsMeetingCoordinates(g))throw new CallingCommunicationError(z.CALL_AGENT.INVALID_CALL_CONFIG)}checkForAtLeastOneValidCallConfig(g){return!(g.threadId||g.meetingLink||g.groupId||g.meetingId||g.roomId)}checkIfMultiplesConfigsWereSpecified(g){return g.threadId&&g.groupId||g.groupId&&g.meetingLink}checkForInvalidTeamsMeetingCoordinates(g){return!g.threadId&&g.tenantId&&g.organizerId||g.threadId&&(g.organizerId&&!g.tenantId||!g.organizerId&&g.tenantId)}isTflMeetingLink(g){return getAcsEcsConfig().calling.tfl.hosts.some((m=>g.includes(m.trim().toLocaleLowerCase())))}assertCallUserIds(g){assertIsObject(g,z.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),assertNotNull(g,z.CALL_AGENT.USERIDS_CANNOT_BE_NULL),assertIsArrayOfIdentifiers(g),g.forEach((g=>{const m=validateIdentifier(g);if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!1,m))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN)}))}}__decorate$n([syncOperation(Jh.StartCall),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[Array,Object]),__metadata$n("design:returntype",Object)],CallAgentImpl.prototype,"startCall",null),__decorate$n([syncOperation(Jh.Join),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[Object,Object]),__metadata$n("design:returntype",Object)],CallAgentImpl.prototype,"join",null),__decorate$n([asyncOperation(Jh.Dispose),__metadata$n("design:type",Function),__metadata$n("design:paramtypes",[]),__metadata$n("design:returntype",Promise)],CallAgentImpl.prototype,"dispose",null);class EcsProvider{constructor(g,m,f){this._configIds={AcsCallingSDKWeb:"",SkypeWebMedia:""},this.setConfigOrDefault=(g,m)=>{g&&Object.keys(g).forEach((f=>{void 0!==g[f]&&(m[f]=g[f])}))},this._logger=g,this.sdkDiagnosticInformation=m,this._acsProxy=f;const S=getAcsEcsConfig().calling.applicationSettingsUrls;this._trouterSettings={version:`${getPlatformId()}/${getSdkInternalVersion()}`,productName:"AcsWeb",trouterServiceUrl:S.Public_TrouterServiceUrl,registrarServiceUrl:S.Public_RegistrarServiceUrl,maxRegistrationTimeInMs:36e5,pnhAppId:"AcsWeb",pnhTemplate:"AcsWeb_2.0",environment:"Prod",platform:getPlatformName()},this._JsCsaConfig={languageCode:"en",emergencyCallCountry:"",autoResolveConflictedCall:!1,handleRosterFromCreateAndJoin:!0,conversationServiceUrl:f.proxyfyUrl(S.Public_ConversationServiceUrl),useInternalHttpDispatcher:!f.hasProxyUrl(),supportsHostlessGroupCalls:!0,doHostlessCalling:!0,shouldServiceSendCallEventMessages:!0,shouldServiceSendNGCUpgradeMessages:!0,supportsCompressedServicePayload:!0,handleNewOfferRequest:!0,handleMediaOfferFromPushNotification:!0,isWebRtcEnabled:!0,supportsSynchronousTrouterResponse:!0,autoJoinOnConflict:!0,brokerEnabledOutgoing:!0,brokerEnabledIncoming:!0,brokerExclusively:!1,brokerRequestBatching:!0,isGVCOutgoingEnabled:!0,isGVCJoiningEnabled:!0,enableTokenCache:!1},this._JamaSettingsMobile={webrtcCameraOpenFs:900,webrtcMultipartyMaxScalingFs:900,webrtcMaxScalingFs:900},this._JamaSettings={debug:!1,numVideoChannelsGvc:6,webcv:null},this._MDNTrapSettings={Service:{url:f.proxyfyUrl(S.Public_MdnTrapServiceUrl),tokenUrl:f.proxyfyUrl(S.Public_MdnTrapServiceTokenUrl)},Relay:{Skype:{addresses:[],fqdns:[S.Public_MdnTrapRelaySkypeFqdns],tcpPort:443,udpPort:3478},Turn:{addresses:[],fqdns:[S.Public_MdnTrapRelayTurnFqdns],tcpPort:443,udpPort:3478,url:S.Public_MdnTrapRelayTurnUrl}},Http:{connectionTimeout:30,requestTimeout:60},Token:{earlyRefreshMinutes:1080,earlyRefreshPercentage:25}},this._TrouterJScriptClient={TelemetryEnabled:!1,ClientTelemetryEventEnabled:{trouter_js_client_connected:!1,trouter_js_client_disconnected:!1,trouter_js_client_error:!1,trouter_js_client_progress:!1,trouter_js_client_response:!1,trouter_js_client_check_connection:!1,trouter_js_client_registration:!1,trouter_js_client_unregistration:!1,logHealthCheckError:!1,logSendPingError:!1,numberOfStepsToMaintain:0,sendProgressTimeoutSecs:0}}}getTrouterTelemetryConfig(){return{enabled:this._TrouterJScriptClient.TelemetryEnabled,...this._TrouterJScriptClient.ClientTelemetryEventEnabled}}getJamaSettings(){const g=getBrowserInfo();let m=this._JamaSettings;return"Mobile"==g.formFactor&&(m={...m,...this._JamaSettingsMobile}),m}getClientInformation(){const g=getAcsEcsConfig().telemetry.reportSdkUaToService,m=getAcsEcsConfig().telemetry.reportEnvToService;return`ACSWeb(${getPlatformId()}/${getSdkInternalVersion()})`+(m?`/${getInternalEnvInfo()}`:"")+(g?`/(${this.sdkDiagnosticInformation})`:"")}getJsCsaConfig(){return{...this._JsCsaConfig,clientInformation:this.getClientInformation()}}getMdnTrapSettings(){return this._MDNTrapSettings}getTrouterSettings(){return this._trouterSettings}setConfig(g,m){this._logger.info("Update ECS settings");const f=getAcsEcsConfig().calling.applicationSettingsUrls,S=getAcsEcsConfig().calling.applicationSettingsEudbUrls,v=g&&isEudbConfigurationsApplicable(g.identityType,g.region);if(g?.identityType==fa.Enterprise)v?(this._trouterSettings.trouterServiceUrl=S.Enterprise_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.Enterprise_RegistrarServiceUrl_EUDB)):(this._trouterSettings.trouterServiceUrl=f.Enterprise_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(f.Enterprise_RegistrarServiceUrl));else switch(g?.cloudType){case ca.Public:v&&(this._trouterSettings.trouterServiceUrl=S.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[S.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[S.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=S.Public_MdnTrapRelayTurnUrl_EUDB);break;case ca.GccHigh:this._trouterSettings.trouterServiceUrl=f.GccHigh_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(f.GccHigh_RegistrarServiceUrl);break;case ca.Dod:this._trouterSettings.trouterServiceUrl=f.Dod_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(f.Dod_RegistrarServiceUrl);break;case ca.AirGap08:this._trouterSettings.trouterServiceUrl=f.AirGap08_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(f.AirGap08_RegistrarServiceUrl);break;case ca.AirGap09:this._trouterSettings.trouterServiceUrl=f.AirGap09_TrouterServiceUrl,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(f.AirGap09_RegistrarServiceUrl)}if(m)this._configIds={AcsCallingSDKWeb:m?.ConfigIDs?.AcsCallingSDKWeb||"",SkypeWebMedia:m?.ConfigIDs?.SkypeWebMedia||""},this.setConfigOrDefault(m?.SkypeCalling,this._JsCsaConfig),this.setConfigOrDefault(m?.MDN_TRAP,this._MDNTrapSettings),this.setConfigOrDefault(m?.SkypeWebMedia?.mediaAgent,this._JamaSettings),this.setConfigOrDefault(m?.TrouterJScriptClient,this._TrouterJScriptClient);else if(g?.identityType===fa.Enterprise)v?(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.Enterprise_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.Enterprise_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.Enterprise_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[S.Enterprise_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[S.Enterprise_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=S.Enterprise_MdnTrapRelayTurnUrl_EUDB):(this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(f.Enterprise_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(f.Enterprise_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(f.Enterprise_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[f.Enterprise_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[f.Enterprise_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=f.Enterprise_MdnTrapRelayTurnUrl);else switch(g?.cloudType){case ca.Public:v&&(this._trouterSettings.trouterServiceUrl=S.Public_TrouterServiceUrl_EUDB,this._trouterSettings.registrarServiceUrl=this._acsProxy.proxyfyUrl(S.Public_RegistrarServiceUrl_EUDB),this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(S.Public_ConversationServiceUrl_EUDB),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(S.Public_MdnTrapServiceUrl_EUDB),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(S.Public_MdnTrapServiceTokenUrl_EUDB),this._MDNTrapSettings.Relay.Skype.fqdns=[S.Public_MdnTrapRelaySkypeFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.fqdns=[S.Public_MdnTrapRelayTurnFqdns_EUDB],this._MDNTrapSettings.Relay.Turn.url=S.Public_MdnTrapRelayTurnUrl_EUDB);break;case ca.GccHigh:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(f.GccHigh_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(f.GccHigh_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(f.GccHigh_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[f.GccHigh_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[f.GccHigh_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=f.GccHigh_MdnTrapRelayTurnUrl;break;case ca.Dod:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(f.Dod_ConversationServiceUrl),this._MDNTrapSettings.Service.url=this._acsProxy.proxyfyUrl(f.Dod_MdnTrapServiceUrl),this._MDNTrapSettings.Service.tokenUrl=this._acsProxy.proxyfyUrl(f.Dod_MdnTrapServiceTokenUrl),this._MDNTrapSettings.Relay.Skype.fqdns=[f.Dod_MdnTrapRelaySkypeFqdns],this._MDNTrapSettings.Relay.Turn.fqdns=[f.Dod_MdnTrapRelayTurnFqdns],this._MDNTrapSettings.Relay.Turn.url=f.Dod_MdnTrapRelayTurnUrl;break;case ca.AirGap08:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(f.AirGap08_ConversationServiceUrl);break;case ca.AirGap09:this._JsCsaConfig.conversationServiceUrl=this._acsProxy.proxyfyUrl(f.AirGap09_ConversationServiceUrl)}}getConfigIds(){return this._configIds}assertConfigs(g){const m="SkypeCalling",f="MDN_TRAP",S="SkypeWebMedia",v="SkypeWebMedia.mediaAgent",C="TrouterJScriptClient";let _=[];if(g?.SkypeCalling||_.push(m),g?.MDN_TRAP||_.push(f),g?.SkypeWebMedia?g?.SkypeWebMedia?.mediaAgent||_.push(v):_.push(S),g?.TrouterJScriptClient||_.push(C),_.length>0){const g=new CallingCommunicationError(z.CALL_STACK.FOUND_UNDEFINED_CONFIGS(_.join(", ")));throw this._logger.error(g.message),g}}}var Tf,If=createCommonjsModule((function(g,m){var f;f=function(){return function(g){function e(f){if(m[f])return m[f].exports;var S=m[f]={i:f,l:!1,exports:{}};return g[f].call(S.exports,S,S.exports,e),S.l=!0,S.exports}var m={};return e.m=g,e.c=m,e.i=function(g){return g},e.d=function(g,m,f){e.o(g,m)||Object.defineProperty(g,m,{configurable:!1,enumerable:!0,get:f})},e.n=function(g){var m=g&&g.__esModule?function(){return g.default}:function(){return g};return e.d(m,"a",m),m},e.o=function(g,m){return Object.prototype.hasOwnProperty.call(g,m)},e.p="",e(e.s=1)}([function(g,m,f){function n(g,m){var f,S=new Promise((function(m,S){fetch(g).then((function(g){clearTimeout(f),m(g)})).catch((function(g){clearTimeout(f),S(g)}))}));if(0!==m){var v=new Promise((function(S,v){f=setTimeout(v,m,new Error("Fetch for '".concat(g.url,"' timed out")))}));return Promise.race([S,v])}return S}function o(g){try{return JSON.stringify(g)}catch(m){return"Unable to serialize object of type ".concat(typeof g)}}Object.defineProperty(m,"__esModule",{value:!0}),m.Timespan=m.toJson=m.fetchWithTimeout=void 0,m.fetchWithTimeout=n,m.toJson=o;var S=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();m.Timespan=S},function(g,m,f){function n(g,m,f){return new b(g,m,f)}var S=this&&this.__extends||function(){var t=function(g,m){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)Object.prototype.hasOwnProperty.call(m,f)&&(g[f]=m[f])})(g,m)};return function(g,m){function n(){this.constructor=g}if("function"!=typeof m&&null!==m)throw new TypeError("Class extends value "+String(m)+" is not a constructor or null");t(g,m),g.prototype=null===m?Object.create(m):(n.prototype=m.prototype,new n)}}(),v=this&&this.__awaiter||function(g,m,f,S){function o(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{c(S.next(g))}catch(g){v(g)}}function a(g){try{c(S.throw(g))}catch(g){v(g)}}function c(g){g.done?f(g.value):o(g.value).then(s,a)}c((S=S.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function r(g){return function(m){return n([g,m])}}function n(E){if(f)throw new TypeError("Generator is already executing.");for(;C&&(C=0,E[0]&&(_=0)),_;)try{if(f=1,S&&(v=2&E[0]?S.return:E[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,E[1])).done)return v;switch(S=0,v&&(E=[2&E[0],v.value]),E[0]){case 0:case 1:v=E;break;case 4:return _.label++,{value:E[1],done:!1};case 5:_.label++,S=E[1],E=[0];continue;case 7:E=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===E[0]||2===E[0])){_=0;continue}if(3===E[0]&&(!v||E[1]>v[0]&&E[1]<v[3])){_.label=E[1];break}if(6===E[0]&&_.label<v[1]){_.label=v[1],v=E;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(E);break}v[2]&&_.ops.pop(),_.trys.pop();continue}E=m.call(g,_)}catch(g){E=[6,g],S=0}finally{f=v=0}if(5&E[0])throw E[1];return{value:E[0]?E[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:r(0),throw:r(1),return:r(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.createRegistrarClient=m.RegistrarClient=void 0;var _=f(0),E=["skype","aad","cae"],T=function(g){function e(m){var f=g.call(this,m)||this;return f.name="CancelationError",f}return S(e,g),e}(Error),I=function(){function t(g,m,f){this.logger=g,this.maxBackoffInMs=m,this.initialDelay=f,this.backoffCount=0,this.id=++t.idCounter}return t.prototype.delay=function(g){var m=this;if(void 0!==this.timerHandle)throw new Error("Retry sequence logical failure");if(-1===this.backoffCount)return new Promise((function(g,m){m(new T("Cancelled"))}));var f=this.calculateNextBackoffMs();return this.backoffCount++,this.logger.info("[RegistrarClient] Backing off ".concat(g," for ").concat(f," milliseconds with ID ").concat(this.id)),new Promise((function(S,v){m.cancelFunc=v,m.timerHandle=setTimeout((function(){m.logger.info("[RegistrarClient] Back off for ".concat(g," with ID ").concat(m.id," complete")),m.timerHandle=void 0,S()}),f)}))},t.prototype.cancel=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off"),clearTimeout(this.timerHandle),void 0!==this.cancelFunc&&this.cancelFunc(new T("Cancelled"))),this.backoffCount=-1},t.prototype.calculateNextBackoffMs=function(){var g=1+.4*(Math.random()-.5),m=this.initialDelay*Math.pow(2,this.backoffCount)*g;return m=Math.round(m),Math.min(this.maxBackoffInMs,m)},t.idCounter=0,t}(),b=function(){function t(g,m,f){var S;this.logger=g,this.tokenProvider=m,this.options=f,this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN=15,this.DEFAULT_MAX_BACKOFF_TIME_IN_MS=3e5,this.backoffs={},this.maxBackOffTime=this.options.maxRetryDelayMs>0?this.options.maxRetryDelayMs:this.DEFAULT_MAX_BACKOFF_TIME_IN_MS,this.maxRetriesForGetToken=void 0===f.maxRetriesForGetToken||null===f.maxRetriesForGetToken?this.DEFAULT_MAX_RETRIES_FOR_GET_TOKEN:f.maxRetriesForGetToken,this.proxyUrlRewrite=null!==(S=f.proxyUrlRewrite)&&void 0!==S?S:function(g){return g}}return t.prototype.setTelemetryLogger=function(g){this.eventLogger=g},t.prototype.register=function(g,m){return v(this,void 0,void 0,(function(){return C(this,(function(f){switch(f.label){case 0:return[4,this.performRegistration(g,m,"pr_set_registration")];case 1:return f.sent(),this.cachedRegistrationParams=[g,m],[2]}}))}))},t.prototype.unregister=function(){return v(this,void 0,void 0,(function(){var g;return C(this,(function(m){switch(m.label){case 0:return this.logger.info("[RegistrarClient] sending unregister request"),g=new Request(this.proxyUrlRewrite("".concat(this.options.registrarUrl,"/").concat(this.options.registrationId)),{method:"DELETE",mode:"cors",headers:new Headers({accept:"application/json, text/javascript"})}),[4,this.callRegistrar(g,"pr_delete_registration")];case 1:return m.sent(),[2]}}))}))},t.prototype.cancelPendingRequests=function(){var g=this;Object.keys(this.backoffs).forEach((function(m){g.backoffs[m].cancel()})),this.backoffs={}},t.prototype.resendRegistration=function(){return v(this,void 0,void 0,(function(){return C(this,(function(g){switch(g.label){case 0:if(!this.cachedRegistrationParams)throw new Error("Re-registration failed because there is no registration parameters cached");return[4,this.performRegistration(this.cachedRegistrationParams[0],this.cachedRegistrationParams[1],"pr_resend_registration")];case 1:return g.sent(),[2]}}))}))},t.prototype.performRegistration=function(g,m,f){return v(this,void 0,void 0,(function(){var S,v;return C(this,(function(C){switch(C.label){case 0:return this.logger.info("[RegistrarClient] Sending register request"),S={clientDescription:g,registrationId:this.options.registrationId,nodeId:"",transports:m},v=new Request(this.proxyUrlRewrite(this.options.registrarUrl),{method:"POST",mode:"cors",headers:new Headers({"content-type":"application/json",accept:"application/json, text/javascript"}),body:(0,_.toJson)(S)}),[4,this.callRegistrar(v,f)];case 1:return C.sent(),[2]}}))}))},t.prototype.startBackoff=function(){var g=new I(this.logger,this.maxBackOffTime,this.options.initialRetryDelayMs);return this.backoffs[g.id]=g,g},t.prototype.stopBackoff=function(g){g.cancel(),delete this.backoffs[g.id]},t.prototype.getToken=function(g){return v(this,void 0,void 0,(function(){var m,f,S,v,_,T,I;return C(this,(function(C){switch(C.label){case 0:m=this.startBackoff(),f=0,C.label=1;case 1:return C.trys.push([1,3,,8]),this.logger.info("[RegistrarClient] Asking for a new token"),[4,this.tokenProvider({needFresh:!0,supportedTokenTypes:E,wwwAuthenticateHeader:g,purpose:"registrar"})];case 2:return S=C.sent(),this.stopBackoff(m),[2,S];case 3:v=C.sent(),C.label=4;case 4:return C.trys.push([4,6,,7]),f++,_=JSON.stringify(v),f>this.maxRetriesForGetToken?(T="[RegistrarClient] getToken retry limit hit. Will not retry now. Error: ".concat(_),this.logger.error(T),this.stopBackoff(m),[2,Promise.reject(T)]):(this.logger.warn("[RegistrarClient] Retrying for a new token. Retry Count: ".concat(f," Error: ").concat(_)),[4,m.delay("Fetching a new token")]);case 5:return C.sent(),[3,8];case 6:throw I=C.sent(),this.stopBackoff(m),I;case 7:return[3,8];case 8:return[3,1];case 9:return[2]}}))}))},t.prototype.callRegistrar=function(g,m){var f,S,T;return v(this,void 0,void 0,(function(){var v,I,b,A,P,R,w,M,D,O,N,k,L,F,x,U;return C(this,(function(C){switch(C.label){case 0:return v=this.startBackoff(),[4,this.tokenProvider({needFresh:!1,supportedTokenTypes:E,wwwAuthenticateHeader:void 0,purpose:"registrar"})];case 1:I=C.sent(),this.setTokenHeader(g,I),b=new _.Timespan,A=0,C.label=2;case 2:P=void 0,C.label=3;case 3:return C.trys.push([3,10,15,16]),R=g.clone(),[4,(0,_.fetchWithTimeout)(R,this.options.requestTimeoutMs)];case 4:return 401!==(P=C.sent()).status?[3,8]:++A>this.maxRetriesForGetToken?(w="[RegistrarClient] getSkypeToken retry limit hit. Will not retry now. Request '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText),this.logger.error(w),this.stopBackoff(v),[2,Promise.reject(w)]):(this.logger.warn("[RegistrarClient] Retry Count ".concat(A,". Request '").concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText)),M=null!==(S=null===(f=P.headers)||void 0===f?void 0:f.get("www-authenticate"))&&void 0!==S?S:void 0,D=this.setTokenHeader,O=[g],[4,this.getToken(M)]);case 5:return D.apply(this,O.concat([C.sent()])),A>1?[4,v.delay("Registrar call retry after 401")]:[3,7];case 6:C.sent(),C.label=7;case 7:return[3,22];case 8:if(P.status>=500&&P.status<600)throw new Error("Fetch for '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText));C.label=9;case 9:return[3,16];case 10:N=C.sent(),this.logger.error("[RegistrarClient] Request failed with ".concat(N)),C.label=11;case 11:return C.trys.push([11,13,,14]),[4,v.delay("Registrar call retry")];case 12:return C.sent(),[3,22];case 13:throw k=C.sent(),this.logger.error("[RegistrarClient] Request cancelled"),this.stopBackoff(v),k;case 14:return[3,16];case 15:return this.sendTelemetryEvent(m,g,P,b),[7];case 16:return this.stopBackoff(v),P.ok?[2,P]:[3,17];case 17:L=void 0,C.label=18;case 18:return C.trys.push([18,20,,21]),x=(F=JSON).stringify,[4,P.json()];case 19:return L=x.apply(F,[C.sent()]),[3,21];case 20:return C.sent(),L="no details",[3,21];case 21:throw U="Fetch for '".concat(g.url,"' failed with ").concat(P.status," ").concat(P.statusText," (").concat(L,", MS-CV: ").concat(null===(T=P.headers)||void 0===T?void 0:T.get("MS-CV"),")"),this.logger.error("[RegistrarClient] ".concat(U)),new Error(U);case 22:return[3,2];case 23:return[2]}}))}))},t.prototype.setTokenHeader=function(g,m){switch(g.headers.delete("X-Skypetoken"),g.headers.delete("Authorization"),g.headers.delete("X-MS-Migration"),m.tokenType.toLowerCase()){case"skype":g.headers.set("X-Skypetoken",m.token);break;case"aad":case"cae":g.headers.set("Authorization","Bearer ".concat(m.token));break;default:throw new Error("unsupported token type: ".concat(m.tokenType))}!1===this.options.usingLegacyTokenApi&&g.headers.set("X-MS-Migration","True")},t.prototype.sendTelemetryEvent=function(g,m,f,S){if(void 0!==this.eventLogger){var v={name:g,properties:{url:{value:m.url},result_code:{value:void 0!==f?f.status:0},begin_timestamp:{value:S.startTime},elapsed:{value:S.duration}}};this.eventLogger.logEvent(v)}},t}();m.RegistrarClient=b,m.createRegistrarClient=n}])},g.exports=f()})),bf=createCommonjsModule((function(g,m){var f;f=function(g){return function(g){function e(f){if(m[f])return m[f].exports;var S=m[f]={i:f,l:!1,exports:{}};return g[f].call(S.exports,S,S.exports,e),S.l=!0,S.exports}var m={};return e.m=g,e.c=m,e.i=function(g){return g},e.d=function(g,m,f){e.o(g,m)||Object.defineProperty(g,m,{configurable:!1,enumerable:!0,get:f})},e.n=function(g){var m=g&&g.__esModule?function(){return g.default}:function(){return g};return e.d(m,"a",m),m},e.o=function(g,m){return Object.prototype.hasOwnProperty.call(g,m)},e.p="",e(e.s=19)}([function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.Logger=void 0;var S=function(){function t(g,m){this.name=g,this.logger=m}return t.prototype.debug=function(g){this.logger.debug("["+this.name+"] "+g)},t.prototype.info=function(g){this.logger.info("["+this.name+"] "+g)},t.prototype.warn=function(g){this.logger.warn("["+this.name+"] "+g)},t.prototype.error=function(g){this.logger.error("["+this.name+"] "+g)},t}();m.Logger=S},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.USER_AUTHENTICATE_EVENT_NAME=m.SUPPORTED_TOKEN_TYPES=m.FAILED_MESSAGE_ACK=m.UNHANDLED_MESSAGE_ACK=m.HANDLED_MESSAGE_ACK=m.CLIENT_VERSION=m.constants=void 0,m.constants={TROUTER_INIT:"trouterinit",TROUTER_READY_EVENT:"trouterReadyEvent",TROUTER_READY_TIMEOUT:"trouterReadyTimeout",TROUTER_TOKEN_REQUEST:"trouterTokenRequest",TROUTER_TOKEN_GET_SUCCEEDED:"trouterTokenGetSucceeded",TROUTER_TOKEN_GET_FAILED:"trouterTokenGetFailed",TROUTER_RECONNECTING:"trouterReconnecting",RENEWAL:"renewal",NEW_CONNECTION:"newConnection",ENDPOINT_REGISTRATION_FAILED:"endpointRegistrationFailed"},m.CLIENT_VERSION="2024.04.01.23",m.HANDLED_MESSAGE_ACK=200,m.UNHANDLED_MESSAGE_ACK=404,m.FAILED_MESSAGE_ACK=500,m.SUPPORTED_TOKEN_TYPES=["skype","aad","cae"],m.USER_AUTHENTICATE_EVENT_NAME="user.authenticate"},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterState=m.UserActivityState=void 0,function(g){g[g.Unknown=0]="Unknown",g[g.Active=1]="Active",g[g.Inactive=2]="Inactive"}(m.UserActivityState||(m.UserActivityState={})),function(g){g[g.Unknown=0]="Unknown",g[g.Connected=2]="Connected",g[g.Disconnected=3]="Disconnected",g[g.Switching=9]="Switching"}(m.TrouterState||(m.TrouterState={}))},function(g,m,f){function o(g){try{return JSON.stringify(g)}catch(m){return"Unable to serialize object of type "+typeof g}}function i(g){var m=Math.round((new Date).getTime()/1e3);return void 0!==g&&g>m?g-m:0}function r(g){return Math.round((new Date).getTime()/1e3)+g}function s(g,m){return S(this,void 0,void 0,(function(){var f,S,C;return v(this,(function(v){return S=new Promise((function(m,S){fetch(g).then((function(g){clearTimeout(f),m(g)})).catch((function(g){clearTimeout(f),S(g)}))})),0!==m?(C=new Promise((function(S,v){var C=new URL(g.url),_=new Error(g.method+" "+C.origin+C.pathname+" timed out");f=setTimeout(v,m,_)})),[2,Promise.race([S,C])]):[2,S]}))}))}var S=this&&this.__awaiter||function(g,m,f,S){function i(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{a(S.next(g))}catch(g){v(g)}}function c(g){try{a(S.throw(g))}catch(g){v(g)}}function a(g){g.done?f(g.value):i(g.value).then(s,c)}a((S=S.apply(g,m||[])).next())}))},v=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===C[0]||2===C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.Timespan=m.CorrelationVector=m.fetchWithTimeout=m.calculateExpireTsInSec=m.calculateTtlInSec=m.toJson=void 0,m.toJson=o,m.calculateTtlInSec=i,m.calculateExpireTsInSec=r,m.fetchWithTimeout=s;var C=function(){function t(g){this.base=void 0!==g?g:this.createCorrelationVectorBase(),this.extension=0}return t.extend=function(g){return new t(g)},t.prototype.increase=function(){this.extension++},t.prototype.value=function(){return this.base+"."+this.extension},t.prototype.createCorrelationVectorBase=function(){for(var g="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0987654321/+",m="AQgw",f="",S=0;S<21;S++)f+=g.charAt(Math.floor(Math.random()*g.length));return f+m.charAt(Math.floor(Math.random()*m.length))},t}();m.CorrelationVector=C;var _=function(){function t(){this.start=Date.now()}return Object.defineProperty(t.prototype,"duration",{get:function(){return Date.now()-this.start},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"startTime",{get:function(){return this.start},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.start=Date.now()},t}();m.Timespan=_},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManagerState=m.UserActivityEventReason=m.ServerState=void 0;var S=f(3),v=function(){function t(g,m,f,S,v,C,_){this.connectionId=g,this.connectedClientId=m,this.domId=f,this.unsecureUrl=S,this.url=v,this.c2cUrlBase=C,this.expirationTsSec=_}return t.prototype.getRemainingTtlInSec=function(){return(0,S.calculateTtlInSec)(this.expirationTsSec)},t}();m.ServerState=v,function(g){g[g.Unknown=0]="Unknown",g[g.Modified=1]="Modified",g[g.Snapshot=2]="Snapshot",g[g.Connected=3]="Connected"}(m.UserActivityEventReason||(m.UserActivityEventReason={})),function(g){g[g.Unknown=0]="Unknown",g[g.Connected=2]="Connected",g[g.Disconnected=3]="Disconnected",g[g.Switching=9]="Switching",g[g.TerminalError=10]="TerminalError"}(m.TrouterManagerState||(m.TrouterManagerState={}))},function(g,m,f){function o(g,m){return"skype"===g&&"1"!==i(null==m?void 0:m.scae)?"v4a":"v4c"}function i(g){return"string"==typeof g?g:"number"==typeof g?g.toString():void 0}function r(g,m){return"v4c-websocket-failure"===(null==m?void 0:m.kind)?"v4a":g}function s(g){return Object.prototype.hasOwnProperty.call(g,"connectparams")}function c(g,m){return"v4a"===m?g.replace(/\/v4\/c\b/,"/v4/a").replace("wss://","https://").replace("ws://","http://"):g.replace(/\/v4\/a\b/,"/v4/c").replace("https://","wss://").replace("http://","ws://")}function a(g){if(void 0!==g)return S(S({},g),{reconnectUrl:void 0,serviceUrl:void 0})}function u(g){return"string"==typeof g?parseInt(g,10):g}function h(g){if("redirect"===(null==g?void 0:g.kind)&&void 0!==g.host){var m=g.host;return m.endsWith("/")&&(m=m.substring(0,m.length-1)),m.endsWith("/v4/c")||m.endsWith("/v4/a")||(m+="/v4/c"),m}}var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.redirectUrlIfPresent=m.ensureNumber=m.reconnectParamsWithoutUrls=m.adaptUrl=m.isV4ConnectEvent=m.usedProtocolAfterFallback=m.usedProtocol=void 0,m.usedProtocol=o,m.usedProtocolAfterFallback=r,m.isV4ConnectEvent=s,m.adaptUrl=c,m.reconnectParamsWithoutUrls=a,m.ensureNumber=u,m.redirectUrlIfPresent=h},function(g,m,f){function o(g,m){var f=m?void 0:{"X-MS-Migration":"True"};switch(g.tokenType.toLowerCase()){case"skype":return S({"X-Skypetoken":g.token},f);case"aad":case"cae":return S({Authorization:"Bearer "+g.token},f);default:throw new Error("unsupported token type: "+g.tokenType)}}function i(g){return null!=g&&"function"==typeof g.toString?g.toString():"["+typeof g+"]"}function r(g){return"object"==typeof g&&null!==g&&void 0!==g.stack?(0,T.toJson)(g.stack):'"(no error.stack)"'}function s(g){return"object"==typeof g&&null!==g&&"string"==typeof g.message?g.message:"(no error.message)"}var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)},v=this&&this.__awaiter||function(g,m,f,S){function i(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{a(S.next(g))}catch(g){v(g)}}function c(g){try{a(S.throw(g))}catch(g){v(g)}}function a(g){g.done?f(g.value):i(g.value).then(s,c)}a((S=S.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===C[0]||2===C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterConnection=m.ReconnectReason=void 0;var _,E=f(20),T=f(3),I=f(15),b=f(1),A=f(16),P=f(17),R=f(2),w=f(4),M=f(0),D=f(5),O=f(7),N=f(12),k=function(){function t(){this.cv=b.CLIENT_VERSION,this.ua="",this.hr="",this.v=""}return t}(),L=function(){function t(){this["force new connection"]=!0,this.reconnect=!1,this.query="",this.ackTimeoutMs=5e3}return t.prototype.rewriteUrlForProxy=function(g){return g},t}(),F="MS-CV",x=function(){function t(g,m){this.logger=m,this.cvCounter=0;var f=JSON.parse(g);this.startTS=this.safeJsonNumber(f,"startTS",0),this.url=this.safeJsonString(f,"url",""),this.shortUrl=this.safeJsonString(f,"shortUrl",""),this.body=this.safeJsonString(f,"body",""),this.headers=this.safeJsonRecord(f,"headers",{}),this.id=this.safeJsonNumber(f,"id",-1),this.method=this.safeJsonString(f,"method",""),this.replied=!1,this.timedout=!1,this.receivedCv=this.headers[F],this.updateCvHeader()}return Object.defineProperty(t.prototype,"correlationVector",{get:function(){return this.receivedCv?this.receivedCv+"."+this.cvCounter:""},enumerable:!1,configurable:!0}),t.prototype.on=function(g,m){"data"===g?this.dataCallback=m:"end"===g&&("function"==typeof this.dataCallback&&this.dataCallback(this.body),m())},t.prototype.incrementCorrelationVector=function(){++this.cvCounter,this.updateCvHeader()},t.prototype.updateCvHeader=function(){var g=this.correlationVector;g&&(this.headers[F]=g)},t.prototype.safeJsonNumber=function(g,m,f){var S;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var v=g;if("number"==typeof v[m])return v[m];if("string"==typeof v[m])return parseFloat(v[m]);null===(S=this.logger)||void 0===S||S.warn("unexpected type of '"+m+"': "+typeof v[m])}return f},t.prototype.safeJsonString=function(g,m,f){var S;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var v=g;if("string"==typeof v[m])return v[m];null===(S=this.logger)||void 0===S||S.warn("unexpected type of '"+m+"': "+typeof v[m])}return f},t.prototype.safeJsonRecord=function(g,m,f){var S;if(null!=g&&Object.prototype.hasOwnProperty.call(g,m)){var v=g;if("object"==typeof v[m])return v[m];null===(S=this.logger)||void 0===S||S.warn("unexpected type of '"+m+"': "+typeof v[m])}return f},t}(),U=function(){function t(g,m,f){this.request=g,this.responseData=m,this.sendResponse=f}return t.prototype.writeHead=function(g,m){this.responseData.status=g,this.responseData.headers=m},t.prototype.write=function(g){this.responseData.body+=g},t.prototype.end=function(g){return g&&(this.responseData.body+=g),this.sendResponse(this.request,this.responseData)},t}(),V=function(){function t(g){this.name=g,this.args={},this.timeoutTimerId=0}return t}();!function(g){g[g.Configuration=0]="Configuration",g[g.ServerInitiated=1]="ServerInitiated"}(_=m.ReconnectReason||(m.ReconnectReason={}));var B=function(){function t(g,m,f,S,v,C,_,T){var A,R=this;this.options=m,this.manager=f,this.tokenProvider=S,this.usingLegacyTokenApi=v,this.protocolSelector=_,this.audienceSubscriptionState=T,this.connectionId="",this.inIncallMode=!1,this.connectionAttempt=0,this.connectedClientId="",this.isNavigatorOnline=!0,this.onNavigatorOnlineStatusUpdateBound=this.onNavigatorOnlineStatusUpdate.bind(this),this.c2cUrlBase="",this.connectingErrorsInRow=0,this.unauthorizedErrorCount=0,this.pendingSentEventTimers={},this.lastDisconnectReason="",this.UNKNOWN_TRANSPORT="unknown_transport",this.connectingErrorsThreshold=3,this.logger=new M.Logger("Connection",g),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff=new P.ExponentialBackoff(this.logger,this.timeoutOptions.maxBackoffMs),this.clientID=Date.now(),"undefined"!=typeof window&&window.location&&(this.domId=window.location.hostname);var w=new k;w.cv=b.CLIENT_VERSION,w.ua="",(null===(A=this.options)||void 0===A?void 0:A.clientInfo)&&(w.ua=this.safeString(this.options.clientInfo.ua),w.v=this.safeString(this.options.clientInfo.v)),this.clientInfo=w,this.connectionTracker=new I.ConnectionTracker(g,this.clientID,this.clientInfo,(function(){return R.getServerState()}),this.options.endpointId,this.options.clientCorrelationID,this.options.environment),this.applyConnectionTrackerOptions(m);var D=this.options.incallModeTimeoutMs>0;if(this.fsm=new O.TrouterFsm(g,this,D,this.protocolSelector),m.registration){var N={registrarUrl:m.registration.registrarUrl,proxyUrlRewrite:m.rewriteUrlForProxy,registrationId:m.registration.registrationId,requestTimeoutMs:m.timeoutOptions.fetchTimeoutMs,initialRetryDelayMs:1e3,maxRetryDelayMs:m.timeoutOptions.maxBackoffMs,usingLegacyTokenApi:this.usingLegacyTokenApi,maxRetriesForGetToken:m.retryLimitOnTokenFetch};this.registrarClient=(0,E.createRegistrarClient)(g,this.tokenProvider,N)}this.userActivityState=C}return t.prototype.start=function(g){this.logger.info("Starting"),this.reconnectParams=g,"undefined"!=typeof window&&window.navigator?(this.isNavigatorOnline=window.navigator.onLine,window.addEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.addEventListener("offline",this.onNavigatorOnlineStatusUpdateBound),this.logger.debug("Registered for browser online notifications - current state: "+this.isNavigatorOnline)):this.isNavigatorOnline=!0,this.fsm.start()},t.prototype.stop=function(g){this.logger.info("Stopping"),"undefined"!=typeof window&&window.navigator&&(window.removeEventListener("online",this.onNavigatorOnlineStatusUpdateBound),window.removeEventListener("offline",this.onNavigatorOnlineStatusUpdateBound)),this.fsm.stop(g),this.connectionTracker.close()},t.prototype.configure=function(g){var m=this.options.trouterUrl!==g.trouterUrl;this.options=g,this.applyConnectionTrackerOptions(g),m&&(this.logger.info("Configuration changed. Reconnection required."),this.fsm.onReconnectRequired(!1,_.Configuration))},t.prototype.checkConnection=function(g){this.logger.info("checkConnection called with "+g),this.fsm.checkConnection(g),g&&this.connectionTracker.sendTelemetry(I.ClientEventName.CheckConnection,{disconnectDetected:g},[])},t.prototype.disableRegistrationsAndAutoReconnect=function(){this.stopRegistrationTimer(),this.cancelPendingRegistrationRequests(),this.fsm.disableAutoReconnect()},t.prototype.getServerState=function(){return new w.ServerState(this.connectionId,this.connectedClientId,this.domId?this.domId:"",this.allocateResult?this.allocateResult.url:"",this.allocateResult?this.allocateResult.surl:"",this.c2cUrlBase,this.connectionExpireTimestampInSecs)},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.getToken=function(g,m,f,S,v){var C=this;void 0===v&&(v=0),this.logger.info("Getting token "+(m?"with backoff":"without backoff"));var s=function(){C.connectionTracker.trackStart("token");var m={needFresh:!g,wwwAuthenticateHeader:f,supportedTokenTypes:b.SUPPORTED_TOKEN_TYPES,purpose:"trouter"};C.logger.info("Requesting token: needFresh="+m.needFresh+" types=["+b.SUPPORTED_TOKEN_TYPES+"], wwwAuthenticateHeader is "+(m.wwwAuthenticateHeader?"non empty":"empty")),C.tokenProvider(m).then((function(g){C.logger.debug(g.tokenType+" token is received"),C.connectionTracker.trackEnd("token"),C.fsm.onTokenReceived(g,S,C.reconnectParams)})).catch((function(m){var _=(0,T.toJson)(m.stack);if(C.logger.error("Getting token failed, will retry after timeout. Error: "+_),C.connectionTracker.trackError("token",_),!C.canRetryTokenFetchRequest(v+C.unauthorizedErrorCount))return C.connectionTracker.trackError("token","getToken retry limit hit, reached terminal error state"),C.resetTokenBackoff(),void C.fsm.onTerminalError();C.getToken(g,!0,f,S,v+1)}))};m?this.tokenBackoff.backoff("getting token",s):(this.resetTokenBackoff(),s())},t.prototype.startConnectionTimer=function(){var g=this;this.stopConnectionTimer(),this.logger.debug("Starting connection timeout for "+this.timeoutOptions.connectionTimeoutMs+" ms"),this.connectionTimeoutId=setTimeout((function(){g.logger.info("Connection timeout is fired"),g.fsm.onConnectingTimeout()}),this.timeoutOptions.connectionTimeoutMs)},t.prototype.stopConnectionTimer=function(){this.connectionTimeoutId&&(this.logger.debug("Stopping connection timeout"),clearTimeout(this.connectionTimeoutId),this.connectionTimeoutId=void 0)},t.prototype.startPingTimer=function(){var g=this;"websocket"===this.transportTypeName?(this.logger.debug("Starting ping timeout for "+this.timeoutOptions.pingTimeoutMs+" ms"),this.pingTimerId=setInterval((function(){g.logger.info("Ping interval fired"),g.fsm.onPingInterval()}),this.timeoutOptions.pingTimeoutMs)):this.logger.debug("Not starting ping for transport "+this.transportTypeName)},t.prototype.stopPingTimer=function(){this.pingTimerId&&(this.logger.debug("Stopping ping timeout"),this.clearPingResponseTimer(),clearInterval(this.pingTimerId),this.pingTimerId=void 0)},t.prototype.shouldSkipRegistration=function(){return void 0===this.options.registration},t.prototype.hasCustomRegistrationTtl=function(){var g,m;return void 0!==(null===(g=this.options.registration)||void 0===g?void 0:g.registrarTtlSec)&&0!==(null===(m=this.options.registration)||void 0===m?void 0:m.registrarTtlSec)},t.prototype.startRegistrationTimer=function(){var g=this;this.stopRegistrationTimer();var m=this.getRegistrationTtl(),f=m[0],S=m[1];if(f<=30||!S)return this.logger.debug("Starting registration expiration timer (TTL "+f+" sec)"),void(this.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.logger.warn("Registration expired but the connection is still alive. Should never happen"),g.dispatchUnregistered()}),1e3*f));var v=f-30;this.logger.debug("Starting registration extension timer for "+v+" sec"),this.registrationTimerId=setTimeout((function(){g.logger.info("Registration extension timer fired"),g.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.logger.debug("Registration extension did not happen in time"),g.dispatchUnregistered()}),3e4),g.fsm.onRegistrationNearExpiry()}),1e3*v)},t.prototype.startRegistrationRetryTimer=function(){var g=this;this.stopRegistrationTimer(),this.registrationTimerId=setTimeout((function(){g.registrationTimerId=void 0,g.fsm.onRetryRegistration()}),123e3)},t.prototype.stopRegistrationTimer=function(){this.registrationTimerId&&(this.logger.debug("Stopping registration timeout"),clearTimeout(this.registrationTimerId),this.registrationTimerId=void 0)},t.prototype.resendRegistration=function(){if(!this.registrarClient)throw new Error("Trouter Client not configured to handle registrations");return this.fsm.onResendRegistration(),Promise.resolve()},t.prototype.buildSocketIoUrlParams=function(g){if(!this.allocateResult)throw new Error("Allocate result is undefined in buildSocketIoUrlParams()");for(var m={},f=this.allocateResult.connectparams,S=0,v=Object.keys(f);S<v.length;S++){var C=v[S];if(void 0!==f[C]){var _=f[C];"string"==typeof _||"number"==typeof _?m[C]=_:this.logger.error("signatureData["+C+"] has unsupported type "+typeof _)}}return m.v="v4",m.tc=encodeURI((0,T.toJson)(this.clientInfo)),m.timeout=this.timeoutOptions.pingTimeoutMs/1e3,m.auth="true",this.options.endpointId&&(m.epid=this.options.endpointId),g&&(m.userActivity=encodeURI((0,T.toJson)(g))),this.appendConnectedClientIds(this.buildQuery(m),!0)},t.prototype.startSocketIo=function(g){var m,f;if(this.logger.debug("Starting socket io"),this.connectionTracker.trackStart("connectSocket"),!this.allocateResult)throw new Error("Allocate result is undefined in startSocketIo()");var v=this.options.ioOptions?S({},this.options.ioOptions):new L,C=this.userActivityState.state!==R.UserActivityState.Unknown?this.userActivityState.increaseCvAndGetEventObject():void 0;if(v["force new connection"]=!0,v.reconnect=!1,v.rewriteUrlForProxy=this.options.rewriteUrlForProxy,v.requestHeaders=o(g,this.usingLegacyTokenApi),v.query=this.buildSocketIoUrlParams(C),this.logger.info("connecting to "+this.allocateResult.socketio+"?"+v.query),this.stopSocketIo(),this.socket=(null!==(m=this.options.io)&&void 0!==m?m:N).connect(this.allocateResult.socketio,v),void 0===this.socket)throw new Error("Can't create Socket.io object");var _=null===(f=this.audienceSubscriptionState)||void 0===f?void 0:f.increaseCvAndGetEventObject();this.attachSocketIoHandlers(this.socket,g,C,_)},t.prototype.stopSocketIo=function(){if(this.socket){this.logger.debug("clearing socket.io");try{for(var g=0,m=["connecting","connect","connect_failed","close_during_connecting","disconnect","reconnect","reconnect_failed","reconnecting","error","message","trouter.connected","trouter.reconnect","trouter.message_loss"];g<m.length;g++){var f=m[g];this.socket.removeAllListeners(f)}this.socket.disconnect(),this.logger.debug("cleared socket"),this.socket=void 0}catch(g){this.logger.error("exception in disconnecting previous socket. Error: "+r(g))}}},t.prototype.dispatchConnected=function(){this.logger.info("dispatching connected"),this.manager.onConnected(this)},t.prototype.dispatchRegistered=function(){this.logger.info("dispatching registered"),this.manager.onRegistered(this)},t.prototype.dispatchUnregistered=function(){this.logger.info("dispatching unregistered"),this.manager.onUnregistered(this)},t.prototype.dispatchDownstreamRequest=function(g){var m=this;this.logger.debug("dispatching downstream request");try{var f=new U(g,new I.ResponseData(g.id),(function(g,f){return m.logger.debug("sending response to downstream"),m.sendResponse(g,f)}));this.manager.onDownstreamRequest(this,g,f)}catch(g){this.logger.error("exception in socket.on message. Error : "+r(g))}},t.prototype.dispatchReconnecting=function(){this.logger.info("dispatching reconnecting"),this.manager.onReconnecting(this)},t.prototype.dispatchReconnectIsRequired=function(g,m){this.logger.info("dispatching reconnect is required by server"),this.manager.onReconnectIsRequired(this,g,m)},t.prototype.dispatchDisconnected=function(){this.logger.info("dispatching disconnected"),this.manager.onDisconnected(this)},t.prototype.dispatchTerminalError=function(){this.logger.info("dispatching terminal error"),this.manager.onTerminalError(this)},t.prototype.dispatchTrouterMessageLost=function(g){this.logger.info("dispatching trouter message lost"),this.manager.onTrouterMessageLost(g)},t.prototype.countDisconnectBeforeConnectionEstablishment=function(){this.logger.warn("counting disconnect before connection was fully established as a connection failure"),++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold()},t.prototype.sendProcessedDroppedIndicators=function(g){var m=this;try{this.logger.debug("emitting processed flow tags to the server");var f=new V("trouter.processed_message_loss");f.args={droppedIndicators:g},this.sendDownstreamEvent(f,(function(){m.logger.info("emitted processed flow tags to the server")}))}catch(g){var S=r(g);this.logger.error("unable to send processed message loss event. Error: "+S),this.connectionTracker.trackError("trouter.processed_message_loss",S,!1)}},t.prototype.sendAllocateRequest=function(g){var m=this;this.connectionAttempt++,this.connectionTracker.trackNewConnection();var f,v=this.options.trouterUrl,C=this.reconnectParams,_="string"==typeof(null==C?void 0:C.se)?parseInt(C.se,10):"number"==typeof(null==C?void 0:C.se)?C.se:void 0;_&&_<=Date.now()+36e5&&(this.logger.warn("Dropping expired cached connection parameters: "+new Date(_)),this.reconnectParams=C=void 0),C&&C.serviceUrl!==v&&(this.logger.warn("Dropping cached connection parameters for a different environment ("+C.serviceUrl+", now "+v+")"),this.reconnectParams=C=void 0),(null==C?void 0:C.reconnectUrl)&&(v=C.reconnectUrl),f=C?S(S({},C),{serviceUrl:void 0,reconnectUrl:void 0}):null,v=(0,D.adaptUrl)(v,"v4a"),v=this.appendCorrelationIds(v,!1),v=this.appendEndpointId(v,!1),f&&(v+="&"+this.buildQuery(f),f.v||(v+="&v=v4")),v=this.options.rewriteUrlForProxy(v);var E=new Request(v,{method:"POST",mode:"cors",headers:new Headers(S({"Content-Type":"text/plain"},o(g,this.usingLegacyTokenApi)))});this.logger.info("sendAllocateRequest: POST "+v),this.connectionTracker.trackStart("allocation");var I,b=Date.now(),A=-1,P=!1;(0,T.fetchWithTimeout)(E,this.timeoutOptions.fetchTimeoutMs).then((function(g){var f;if(A=g.status,!g.ok)throw I=null!==(f=g.headers.get("www-authenticate"))&&void 0!==f?f:void 0,P="1"===g.headers.get("x-trouter-skypetoken-deprecated"),m.logger.warn("Allocation request got response status "+g.status+", www-authenticate header was "+(I?"not empty":"empty")),new Error(g.statusText);var S=g.headers.get("content-type");if(!S||"application/json"!==S&&!S.startsWith("application/json;"))throw new Error("Content-type '"+S+"' is unexpected");return m.connectionTracker.trackEnd("allocation"),g.json()})).then((function(f){m.unauthorizedErrorCount=0,m.onAllocationResponse(f,g)})).catch((function(g){m.connectingErrorsInRow++;var f=g+(A>=0?", status code "+A:"");if(m.logger.error(m.connectingErrorsInRow+" failed connecting attempt(s) in a row. "+f),m.connectionTracker.trackError("allocation",f),P){var S="Skypetoken deprecated response, not retrying any further";return m.logger.error(S),m.connectionTracker.trackError("allocation",S),void m.fsm.onTerminalError()}if(401===A&&m.unauthorizedErrorCount++,!m.canRetryTokenFetchRequest(m.unauthorizedErrorCount))return S="getToken retry limit hit, reached terminal error state",m.connectionTracker.trackError("allocation",S),void m.fsm.onTerminalError();if(-1!==A||m.isNavigatorOnline){if(m.reconnectParams&&m.connectingErrorsInRow>=m.connectingErrorsThreshold)if(A>=400&&A<=599)m.resetReconnectParamsOnErrorThreshold();else if(m.reconnectParams.reconnectUrl&&m.connectingErrorsInRow%3==0){m.logger.warn(m.connectingErrorsInRow+" connection attempts, testing nominal service URL");var v=Math.min(m.timeoutOptions.connectionTimeoutMs-(Date.now()-b)-500,m.timeoutOptions.fetchTimeoutMs);return void m.testNominalUrlConnectivity(v).then((function(g){m.connectionTracker.trackProgress("nomcheck",g?"ok":"failed"),g?(m.logger.warn("Nominal service URL is reachable, erasing cached reconnect URL"),m.reconnectParams&&delete m.reconnectParams.reconnectUrl):m.logger.warn("Nominal service URL is not reachable either, keeping cached reconnect URL"),m.fsm.onAllocationFailed(!1,void 0)}),(function(){m.fsm.onAllocationFailed(!1,void 0)}))}}else m.logger.info("Expected failure, the browser says it is not online at the moment");m.fsm.onAllocationFailed(401===A,I)}))},t.prototype.testNominalUrlConnectivity=function(g){var m,f=this;if(g<1e3)return this.logger.warn("There is no time left to reasonably perform the nominal service URL connectivity check ("+g+" ms), falling back to assuming that the connectivity is fine"),Promise.resolve(!0);try{var S=new URL(this.options.trouterUrl);S.pathname="/",S.search="?"+this.buildQuery({check:Date.now(),cor_id:encodeURIComponent(this.options.clientCorrelationID),epid:encodeURIComponent(this.options.endpointId?this.options.endpointId:""),tc:encodeURIComponent((0,T.toJson)(this.clientInfo))}),m=new Request(this.options.rewriteUrlForProxy(S.toString()),{method:"GET",headers:{Accept:"text/plain"}})}catch(g){return this.logger.warn("Nominal service URL connectivity test request could not be created ("+g+"), falling back to assuming that the connectivity is fine"),Promise.resolve(!0)}return(0,T.fetchWithTimeout)(m,g).then((function(g){if(200!==g.status)throw new Error("Not 200 OK: "+g.status+" "+g.statusText);return g.text()})).then((function(g){if("Trouter"!==g)throw new Error('Not "Trouter": '+g.substring(0,16)+(g.length>16?"...":""));return!0})).catch((function(g){return f.logger.error("Nominal service URL connectivity test failed: "+g),!1}))},t.prototype.sendPingRequest=function(){var g=this;if(this.socket&&void 0===this.pingResponseTimerId)try{this.logger.debug("emitting ping event");var m=!1;this.socket.emit("ping",(function(){!0!==m&&g.onPingResponse()})),this.pingResponseTimerId=setTimeout((function(){g.logger.error("Ping response timeout is fired"),m=!0,g.clearPingResponseTimer(),g.fsm.onPingResponseTimeout()}),this.timeoutOptions.pongTimeoutMs)}catch(g){var f=r(g);this.logger.error("unable to send ping. Error: "+f),this.connectionTracker.trackError("ping",f,!1)}},t.prototype.connectV4c=function(g,m){var f,v,C,_,E,T=this.options.ioOptions?S({},this.options.ioOptions):new L;T["force new connection"]=!0,T.reconnect=!1,(null===(f=this.reconnectParams)||void 0===f?void 0:f.serviceUrl)&&(0,D.adaptUrl)(this.reconnectParams.serviceUrl,"v4c")!==(0,D.adaptUrl)(this.options.trouterUrl,"v4c")&&(this.logger.warn("Dropping cached connection parameters for a different environment ("+this.reconnectParams.serviceUrl+", now "+this.options.trouterUrl+")"),this.reconnectParams=void 0);var I=null!==(_=null!==(v=(0,D.redirectUrlIfPresent)(m))&&void 0!==v?v:"redirect-no-host"!==(null==m?void 0:m.kind)?null===(C=this.reconnectParams)||void 0===C?void 0:C.reconnectUrl:void 0)&&void 0!==_?_:this.options.trouterUrl,b=(0,D.adaptUrl)(I,"v4c");T["skipped handshake data"]={timeout:70,websocketUrl:b},T.query=this.buildV4cUrlParams(),T.rewriteUrlForProxy=this.options.rewriteUrlForProxy;try{if(this.stopSocketIo(),this.transportTypeName="websocket",this.socket=(null!==(E=this.options.io)&&void 0!==E?E:N).connect(this.options.trouterUrl,T),void 0===this.socket)throw new Error("failed to create Socket.io object");this.attachSocketIoHandlers(this.socket,g,void 0)}catch(g){this.logger.error(""+g),this.connectionTracker.trackError("v4c",""+g),this.fsm.onV4cException()}},t.prototype.sendV4cAuthenticationEvent=function(g){var m,f={headers:o(g,this.usingLegacyTokenApi),connectparams:(0,D.reconnectParamsWithoutUrls)(this.reconnectParams)};null===(m=this.socket)||void 0===m||m.emit(b.USER_AUTHENTICATE_EVENT_NAME,f)},t.prototype.setUserActivityState=function(g){var m=g.state!==this.userActivityState.state;this.userActivityState=g,m?(this.logger.info("Changing user activity state to '"+g.toEventJSON()+"'"),this.fsm.onSetNewUserActivityState()):(this.logger.debug("Not changing the same user activity state '"+g.toEventJSON()+"'"),this.manager.onUserActivityStateAccepted(g.correlationVector.value()))},t.prototype.sendUserActivityState=function(g,m){this.userActivityState.state!==R.UserActivityState.Unknown&&("websocket"===this.transportTypeName&&m?g===w.UserActivityEventReason.Connected?this.sendUserActivityStateMultiple(2):this.sendUserActivityStateMultiple(1):"xhr-polling"===this.transportTypeName&&g===w.UserActivityEventReason.Modified&&this.fsm.forceReconnect("user activity/force reconnect"))},t.prototype.setAudienceSubscriptionsAsync=function(g,m){if("websocket"!==this.transportTypeName)throw new Error("xhr-polling transport is not yet supported for audience subscription");return this.audienceSubscriptionState=g,this.setAudienceSubscriptionsInternalAsync(g.increaseCvAndGetEventObject(),m)},t.prototype.setAudienceSubscriptionsUnsafeAsync=function(g){if("websocket"===this.transportTypeName)return g?this.setAudienceSubscriptionsInternalAsync(g,15e3):void 0;this.logger.error("xhr-polling transport is not yet supported for audience subscription")},t.prototype.setAudienceSubscriptionsInternalAsync=function(g,m){return v(this,void 0,void 0,(function(){var f;return C(this,(function(S){switch(S.label){case 0:return[4,this.sendAudienceSubscriptionsRequest(g,m)];case 1:return f=S.sent(),this.manager.onAudiencesSetResolved(f,g.cv),[2,f]}}))}))},t.prototype.sendAudienceSubscriptionsRequest=function(g,m){var f=this,S=new V("audience.subscribe");return S.args=g,new Promise((function(v){var C=!1,_=setTimeout((function(){return C=!0,v(f.buildAudienceSubscriptionsTimeoutResponse(g))}),m);f.sendDownstreamEvent(S,(function(g,m){C||(clearTimeout(_),f.logger.debug("Audience subscription response: "+m),v(f.parseAudienceSubscriptionsResponseModel(m)))}))}))},t.prototype.parseAudienceSubscriptionsResponseModel=function(g){return g},t.prototype.buildAudienceSubscriptionsTimeoutResponse=function(g){return this.logger.error("Audience subscription has timed out."),{responses:g.audiences.map((function(g){return{audienceId:g.id,result:{audienceSubscriptionState:"Timeout"}}}))}},t.prototype.sendRegisterRequest=function(){var g=this;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");if(!this.allocateResult)throw new Error("Allocate result is undefined in sendRegisterRequest()");this.logger.info("sending register request");var m=new T.Timespan;this.connectionTracker.trackStart("registration");var f=this.getRegistrationTtl()[0];this.registrarClient.register({appId:this.options.registration.pnhAppId,aesKey:"",languageId:"en-US",platform:this.options.registration.platform,templateKey:this.options.registration.pnhTemplateKey,platformUIVersion:this.options.registration.platformUIVersion,productContext:this.options.registration.productContext},{TROUTER:[{context:this.options.registration.context,path:this.allocateResult.surl,ttl:f}]}).then((function(){g.logger.info("Register request successful"),g.connectionTracker.trackEnd("registration"),g.fsm.onRegistrationSucceeded(),g.connectionTracker.sendTelemetry(I.ClientEventName.Registration,{duration:m.duration},[])})).catch((function(f){g.logger.error("Register request failed. Error: "+f),g.connectionTracker.trackError("registration",s(f)),g.fsm.onRegistrationFailed(),g.connectionTracker.sendTelemetry(I.ClientEventName.Registration,{duration:m.duration},[])}))},t.prototype.sendUnregisterRequest=function(){var g=this;this.logger.info("sending unregister request");var m=new T.Timespan;if(!this.options.registration||!this.registrarClient)throw new Error("Internal error - options.registration is undefined");this.connectionTracker.trackStart("unregistration"),this.registrarClient.unregister().then((function(){g.logger.info("Unregister request successful"),g.connectionTracker.trackEnd("unregistration"),g.fsm.onUnregistrationDone(),g.connectionTracker.sendTelemetry(I.ClientEventName.Unregistration,{duration:m.duration},[])})).catch((function(f){g.logger.error("Unregister request failed. Error: "+f),g.connectionTracker.trackError("unregistration",s(f)),g.fsm.onUnregistrationDone(),g.connectionTracker.sendTelemetry(I.ClientEventName.Unregistration,{duration:m.duration},[])}))},t.prototype.resetTokenBackoff=function(){this.tokenBackoff.reset()},t.prototype.cancelPendingRegistrationRequests=function(){this.registrarClient&&this.registrarClient.cancelPendingRequests()},t.prototype.clearSentEventTimers=function(){var g=Object.keys(this.pendingSentEventTimers);if(g.length>0){this.logger.debug("Clearing all pending downstream events related timers");for(var m=0,f=g;m<f.length;m++){var S=f[m];this.clearSentEventTimer(Number(S))}}},t.prototype.restartIncallModeTimer=function(){var g=this;this.clearIncallModeTimerId(),this.logger.debug("Restarting incall mode timer"),this.incallModeTimerId=setTimeout((function(){g.logger.info("Call mode timer fired"),g.fsm.onIncallModeTimer()}),this.options.incallModeTimeoutMs)},t.prototype.enterIncallMode=function(){this.logger.info("Entering incall mode"),this.timeoutOptions=this.options.incallTimeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!0},t.prototype.exitIncallMode=function(){this.logger.info("Exiting incall mode"),this.clearIncallModeTimerId(),this.timeoutOptions=this.options.timeoutOptions,this.tokenBackoff.setMaxBackoffMs(this.timeoutOptions.maxBackoffMs),this.inIncallMode=!1},t.prototype.isIncallMode=function(){return this.inIncallMode},t.prototype.sendDisconnectTelemetryEvent=function(g){var m={reason:g,serverClosed:!this.fsm.isActive()};this.connectionTracker.trackDisconnected(m),this.connectionTracker.clearConnectedInfo()},t.prototype.resetReconnectParamsOnErrorThreshold=function(){this.logger.warn(this.connectingErrorsInRow+" connection attempts, server-side failure: erasing cached connection parameters"),this.reconnectParams=void 0},t.prototype.onSocketConnecting=function(g){this.logger.info("onSocketConnecting("+g+")"),this.transportTypeName=g,this.connectionTracker.trackProgress("connecting",this.transportTypeName),this.fsm.onConnecting()},t.prototype.onSocketConnect=function(g){this.logger.info("onSocketConnect"),this.fsm.onSocketConnect(g)},t.prototype.onSocketConnectFailed=function(g){this.logger.error("onSocketConnectFailed"),this.connectionTracker.trackError("connect_failed",g,!0,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),this.fsm.onConnectingFailed()},t.prototype.onSocketDisconnect=function(g){var m=this.connectionTracker.getSessionLength()||0,f=A.DisconnectReason.fromRawReason(g);this.logger.error("onSocketDisconnect, reason: "+f.reason),"dup"===f.reason&&"dup"===this.lastDisconnectReason&&m<this.options.duplicateDisconnectThresholdMs&&(this.logger.warn("Socket was closed by server as Duplicate for the second time in a row after "+m+" ms which is below the threshold of "+this.options.duplicateDisconnectThresholdMs+" ms. Resetting cached connection parameters and making a new allocation."),this.reconnectParams=void 0),this.lastDisconnectReason=f.reason,this.fsm.onSocketDisconnect(f),this.connectionExpireTimestampInSecs=void 0},t.prototype.onSocketReconnect=function(){this.logger.error("onSocketReconnect"),this.fsm.onTrouterConnected()},t.prototype.onSocketReconnectFailed=function(g){this.logger.error("onSocketReconnectFailed with '"+g+"'"),this.fsm.onSocketDisconnect(A.DisconnectReason.fromSocketIoEventData("reconnecterror",g))},t.prototype.onSocketReconnecting=function(){this.logger.error("onSocketReconnecting")},t.prototype.onSocketError=function(g){this.logger.error("onSocketError with '"+(0,T.toJson)(g)+"'"),this.fsm.isConnecting()&&++this.connectingErrorsInRow>=this.connectingErrorsThreshold&&this.resetReconnectParamsOnErrorThreshold(),this.connectionTracker.trackError("connectSocket",i(g)),this.fsm.onSocketDisconnect(A.DisconnectReason.fromSocketIoEventData("socketerror",g))},t.prototype.onSocketMessage=function(g){var m,f,S=this;this.logger.debug("onSocketMessage");try{var v=null===(m=(f=new x(g,this.logger)).headers)||void 0===m?void 0:m["X-Microsoft-Skype-Chain-ID"],C=v?" Chain-Id "+v:"";this.logger.info("Received request N "+f.id+C+" CV "+f.correlationVector+" to '"+f.url+"'"),f.startTS=Date.now(),f.url&&this.urlPath&&f.url.startsWith(this.urlPath)&&(f.shortUrl=f.url.substring(this.urlPath.length))}catch(g){var _=r(g);return this.logger.error("unable to parse request. Error: "+_),this.connectionTracker.trackRequest(void 0,_),void this.connectionTracker.sendResponseError("unable to parse request, error: "+g)}f.timeoutTimerId=setTimeout((function(){if(!f.replied){S.logger.error("Request "+f.id+" timed out");var g=new I.ResponseData(f.id);g.status=504,g.headers={"Trouter-Responder":"ClientLib"},S.sendResponse(f,g),f.timedout=!0}}),this.timeoutOptions.requestTimeoutMs);try{this.connectionTracker.trackRequest(f),this.fsm.onDownstreamRequest(f)}catch(g){this.logger.error("exception in socket.on message. Error: "+r(g)),this.connectionTracker.sendResponseError(s(g),f,void 0)}},t.prototype.onTrouterConnected=function(g,m,f){var v,C,_,E,I=this;if((0,D.isV4ConnectEvent)(g)){var b=g;this.allocateResult=S(S({},b),{ttl:g.ttl.toString()}),this.populateAndCacheReconnectParams(b,b.reconnectUrl),this.populateConnectionStateFields(b)}else if(!this.allocateResult)return void this.logger.error("Invalid internal state - received onTrouterConnected while allocateResult is not set");this.connectingErrorsInRow=0,this.logger.info("onTrouterConnected: "+this.allocateResult.url),"xhr-polling"===this.transportTypeName&&m&&this.manager.onUserActivityStateAccepted(m.cv),(null===(_=null===(C=null===(v=this.socket)||void 0===v?void 0:v.socket)||void 0===C?void 0:C.options)||void 0===_?void 0:_.query)&&(this.socket.socket.options.query+="&connected=true"),this.urlPath=this.allocateResult.url.replace(/https?:\/\/([A-z0-9\:\$\-\_\.\+\!\*\"\(\)\,]*)\//,"/");var A=this.connectedUrl!==this.allocateResult.url;this.connectedUrl=this.allocateResult.url,this.connectionExpireTimestampInSecs=(0,T.calculateExpireTsInSec)((0,D.ensureNumber)(g.ttl)),this.connectionTracker.trackEnd("connectSocket"),this.connectionTracker.trackConnected(A,this.transportTypeName?this.transportTypeName:this.UNKNOWN_TRANSPORT),null===(E=this.setAudienceSubscriptionsUnsafeAsync(f))||void 0===E||E.catch((function(g){return I.logger.error("Re-subscribe to audiences has failed with "+g)})),this.fsm.onTrouterConnected()},t.prototype.onTrouterReconnect=function(g){var m=g.target;this.logger.info("onTrouterReconnect target: "+m),"self"===m?this.fsm.onReconnectRequired(!0,_.ServerInitiated):this.fsm.onReconnectRequired(!1,_.ServerInitiated,g)},t.prototype.onTrouterMessageLoss=function(g){this.logger.debug("onTrouterMessageLoss"),this.fsm.onTrouterMessageLost(g.droppedIndicators)},t.prototype.buildV4cUrlParams=function(){var g={};return g.tc=encodeURI((0,T.toJson)(this.clientInfo)),g.timeout=Math.floor(this.timeoutOptions.pingTimeoutMs/1e3),this.options.endpointId&&(g.epid=this.options.endpointId),this.appendConnectedClientIds(this.buildQuery(g),!0)},t.prototype.attachSocketIoHandlers=function(g,m,f,S){var v=this;g.on("connecting",(function(g){v.onSocketConnecting(g)})),g.on("connect",(function(){v.onSocketConnect(m)})),g.on("connect_failed",(function(g){v.onSocketConnectFailed(g)})),g.on("close_during_connecting",(function(g){v.onSocketConnectFailed(g)})),g.on("disconnect",(function(g){v.onSocketDisconnect(g)})),g.on("reconnect",(function(){v.onSocketReconnect()})),g.on("reconnect_failed",(function(g){v.onSocketReconnectFailed(g)})),g.on("reconnecting",(function(){v.onSocketReconnecting()})),g.on("error",(function(g){v.onSocketError(g)})),g.on("message",(function(g){v.onSocketMessage(g)})),g.on("trouter.connected",(function(g){v.onTrouterConnected(g,f,S)})),g.on("trouter.reconnect",(function(g){v.onTrouterReconnect(g)})),g.on("trouter.message_loss",(function(g){v.onTrouterMessageLoss(g)}))},t.prototype.onNavigatorOnlineStatusUpdate=function(){var g=window.navigator.onLine;this.logger.debug("Browser online status update - new state: "+g+", previously: "+this.isNavigatorOnline),g&&!this.isNavigatorOnline?(this.isNavigatorOnline=!0,this.tokenBackoff.expediteIfPending(),this.connectionTracker.trackProgress("browserNet","online")):!g&&this.isNavigatorOnline&&(this.isNavigatorOnline=!1,this.connectionTracker.trackProgress("browserNet","offline"))},t.prototype.onAllocationResponse=function(g,m){this.logger.info("Received allocation response "+JSON.stringify(g)),this.allocateResult=g,this.populateAndCacheReconnectParams(this.allocateResult,this.allocateResult.socketio+"v4/a"),this.populateConnectionStateFields(this.allocateResult),this.fsm.onAllocationSucceed(m)},t.prototype.populateAndCacheReconnectParams=function(g,m){this.reconnectParams=S({serviceUrl:this.options.trouterUrl,reconnectUrl:m},g.connectparams),this.manager.onConnectionParametersUpdated(this.reconnectParams)},t.prototype.populateConnectionStateFields=function(g){var m,f,S="string"==typeof g.ttl?parseInt(g.ttl,10):g.ttl;if(this.connectionExpireTimestampInSecs=(0,T.calculateExpireTsInSec)(S),this.connectionId=null!==(m=g.id)&&void 0!==m?m:"",this.connectedClientId=g.ccid,this.logger.debug("connected client id set {connectedClientId:"+this.connectedClientId+"}"),this.c2cUrlBase=null!==(f=g.curlb)&&void 0!==f?f:"",""===this.c2cUrlBase){var v=g.surl.indexOf("://");v>=0&&(v=g.surl.indexOf("/",v+3))>=5&&":3443"===g.surl.substr(v-5,5)&&(this.c2cUrlBase=g.surl.substr(0,v-5))}},t.prototype.onPingResponse=function(){this.logger.debug("onPingResponse"),this.connectionTracker.increasePingResponseCount(),this.clearPingResponseTimer(),this.fsm.onPingResponse()},t.prototype.clearPingResponseTimer=function(){void 0!==this.pingResponseTimerId&&(clearTimeout(this.pingResponseTimerId),this.pingResponseTimerId=void 0)},t.prototype.buildQuery=function(g){for(var m=[],f=0,S=Object.keys(g);f<S.length;f++){var v=S[f];void 0!==g[v]&&m.push(v+"="+g[v])}return m.join("&")},t.prototype.appendConnectedClientIds=function(g,m){var f="";g.includes("ccid=")||(f="ccid="+this.connectedClientId+"&"),this.domId&&(f+="dom="+this.domId+"&"),f.length>0&&(f=f.slice(0,-1));var S=m||g.includes("?")?"&":"?";return this.appendCorrelationIds(g+S+f,m)},t.prototype.appendEndpointId=function(g,m){var f=m||g.includes("?")?"&":"?";return!g.includes("epid")&&this.options.endpointId?""+g+f+"epid="+this.options.endpointId:g},t.prototype.appendCorrelationIds=function(g,m){var f=m||g.includes("?")?"&":"?";return g.includes("cor_id")?g:""+g+f+"cor_id="+this.options.clientCorrelationID+"&con_num="+this.clientID+"_"+this.connectionAttempt},t.prototype.safeString=function(g){return"string"==typeof g?g:""},t.prototype.sendResponse=function(g,m){var f,S;if(g.timedout)return this.logger.error("Request "+g.id+" already timed out"),1;if(g.replied)return this.logger.error("Response for request "+g.id+" already sent"),2;clearTimeout(g.timeoutTimerId),g.timeoutTimerId=void 0,g.replied=!0,m.headers=null!==(f=m.headers)&&void 0!==f?f:{};var v=g.correlationVector;this.logger.info("Sending response N "+g.id+" CV "+v+" with status "+m.status),v&&(m.headers[F]=v),(null===(S=g.headers)||void 0===S?void 0:S["trouter-request"])&&!m.headers["trouter-request"]&&(m.headers["trouter-request"]=g.headers["trouter-request"]);var C=Date.now()-g.startTS;if(m.headers["trouter-client"]=(0,T.toJson)({cd:C}),this.logger.debug("response: "+(0,T.toJson)(m)),!this.socket)return this.connectionTracker.sendResponseError("no socket",g,m),4;try{return this.socket.send((0,T.toJson)(m)),m.sentTS=Date.now(),g.incrementCorrelationVector(),this.connectionTracker.trackResponse(g,C,m),"websocket"===this.transportTypeName&&this.sendPingRequest(),0}catch(f){var _="unable to send data on response.end. Error: "+r(f);return this.logger.error(_),this.connectionTracker.sendResponseError(_,g,m),4}},t.prototype.sendUserActivityStateMultiple=function(g){var m=this,f=new V("user.activity"),S=this.userActivityState.increaseCvAndGetEventObject();f.args=S,this.logger.debug("Sending user activity '"+this.userActivityState.toEventJSON()+"', remaining "+(g-1));var v=!1;this.sendDownstreamEvent(f,(function(){if(!0!==v&&(m.logger.info("User activity state: "+S.state+", cv: "+S.cv+" accepted"),m.manager.onUserActivityStateAccepted(S.cv),m.clearSentEventTimer(f.timeoutTimerId),g>1)){var C=setTimeout((function(){m.clearSentEventTimer(C),m.sendUserActivityStateMultiple(g-1)}),m.options.userActivitySecondResendDelayMs);m.registerSentEventTimer(C,"user.activity/resend")}})),f.timeoutTimerId=setTimeout((function(){m.logger.error("Activity state response timeout is fired"),v=!0,m.fsm.onActivityStateResponseTimeout(),m.clearSentEventTimer(f.timeoutTimerId)}),this.timeoutOptions.userActivityResponseTimeoutMs),this.registerSentEventTimer(f.timeoutTimerId,"user.activity/response")},t.prototype.sendDownstreamEvent=function(g,m){this.logger.debug("Sending downstream event "+g.name),this.socket&&this.socket.emit(g.name,g.args,m)},t.prototype.registerSentEventTimer=function(g,m){this.logger.debug("registering timer "+g+" -> "+m),this.pendingSentEventTimers[g]=m},t.prototype.clearSentEventTimer=function(g){var m=this.pendingSentEventTimers[g];this.logger.debug("clearing timer "+g+" -> "+m),delete this.pendingSentEventTimers[g],clearTimeout(g)},t.prototype.getRegistrationTtl=function(){var g,m,f=(0,T.calculateTtlInSec)(this.connectionExpireTimestampInSecs);if(this.logger.debug("Current connectionID will expire in "+f+" seconds"),(null===(g=this.options.registration)||void 0===g?void 0:g.registrarTtlSec)&&f>0){var S=this.options.registration.registrarTtlSec<f;return[Math.min(this.options.registration.registrarTtlSec,f),S]}return(null===(m=this.options.registration)||void 0===m?void 0:m.registrarTtlSec)?[this.options.registration.registrarTtlSec,!1]:f>0?[f,!1]:[3600,!1]},t.prototype.clearIncallModeTimerId=function(){void 0!==this.incallModeTimerId&&(this.logger.debug("Clearing in-call mode timer"),clearTimeout(this.incallModeTimerId),this.incallModeTimerId=void 0)},t.prototype.applyConnectionTrackerOptions=function(g){try{g.eventLogger&&"function"==typeof g.eventLogger.logEvent?(this.connectionTracker.mergeSettings(g.telemetrySettings),this.connectionTracker.enable(g.eventLogger)):this.logger.warn("Trouter client event logging disabled due to invalid configuration.")}catch(g){this.logger.warn("Trouter client event logging disabled. Error: "+r(g)),this.connectionTracker.disable()}},t.prototype.canRetryTokenFetchRequest=function(g){var m=this.options.retryLimitOnTokenFetch;return null==m||g<m||(this.logger.warn("Reached limit on maximum number of token fetch request. Current count: "+g+", retry limit: "+m),!1)},t}();m.TrouterConnection=B},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterFsm=m.State=void 0;var S,v,C=f(4),_=f(0),E=f(5);!function(g){g[g.Initial=0]="Initial",g[g.RetrievingToken=1]="RetrievingToken",g[g.Allocating=2]="Allocating",g[g.Handshaking=3]="Handshaking",g[g.Connecting=4]="Connecting",g[g.AnonymousConnecting=5]="AnonymousConnecting",g[g.WebsocketAuthenticating=6]="WebsocketAuthenticating",g[g.Connected=7]="Connected",g[g.Unregistering=8]="Unregistering",g[g.TerminalError=9]="TerminalError"}(S=m.State||(m.State={})),function(g){g[g.Initial=0]="Initial",g[g.Registering=1]="Registering",g[g.RegisteringButResendPending=2]="RegisteringButResendPending",g[g.Retrying=3]="Retrying",g[g.Registered=4]="Registered",g[g.RegistrationDisabled=5]="RegistrationDisabled"}(v||(v={}));var T=function(){function t(g,m,f,C){this.worker=m,this.incallModeEnabled=f,this.protocolSelector=C,this.state=S.Initial,this.autoReconnect=!0,this.logger=new _.Logger("ConnectionFsm",g),this.registrationState=v.Initial}return t.prototype.getState=function(){return this.state},t.prototype.isActive=function(){return this.state===S.Allocating||this.state===S.Connected||this.state===S.Handshaking||this.state===S.Connecting||this.state===S.RetrievingToken||this.state===S.AnonymousConnecting||this.state===S.WebsocketAuthenticating},t.prototype.isConnecting=function(){return this.state===S.Allocating||this.state===S.Handshaking||this.state===S.Connecting||this.state===S.AnonymousConnecting},t.prototype.start=function(){return this.state===S.Initial?(this.setState(S.RetrievingToken),this.worker.getToken(!0,!1,void 0),!0):(this.showIgnored("start"),!1)},t.prototype.stop=function(g,m){g&&(this.registrationState=v.Initial),this.worker.isIncallMode()&&this.worker.exitIncallMode(),this.worker.resetTokenBackoff(),this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.state===S.Connected&&this.worker.sendDisconnectTelemetryEvent("connection stopped"),this.registrationState!==v.Registered&&this.registrationState!==v.Registering&&this.registrationState!==v.RegisteringButResendPending||this.state===S.Unregistering?m?(this.setState(S.TerminalError),this.worker.dispatchTerminalError()):(this.setState(S.Initial),this.worker.dispatchDisconnected()):(this.registrationState=v.Initial,this.setState(S.Unregistering),this.worker.sendUnregisterRequest())},t.prototype.onTokenReceived=function(g,m,f){this.state===S.RetrievingToken?"v4c"===(0,E.usedProtocolAfterFallback)(this.protocolSelector(g.tokenType,f),m)?(this.setState(S.AnonymousConnecting),this.worker.startConnectionTimer(),this.worker.connectV4c(g,m)):(this.setState(S.Allocating),this.worker.startConnectionTimer(),this.worker.sendAllocateRequest(g)):this.showIgnored("onTokenReceived")},t.prototype.checkConnection=function(g){g&&this.onPingInterval()},t.prototype.onAllocationSucceed=function(g){return this.state===S.Allocating&&this.registrationState===v.Registered&&this.worker.dispatchUnregistered(),this.state===S.Allocating?(this.setState(S.Handshaking),this.registrationState=v.Initial,this.worker.startSocketIo(g),!0):(this.showIgnored("onAllocationSucceed"),!1)},t.prototype.onAllocationFailed=function(g,m){this.state===S.Allocating?this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!g,claimsChallenge:m}):this.showIgnored("onAllocationFailed")},t.prototype.onV4cException=function(){this.state!==S.AnonymousConnecting&&this.state!==S.WebsocketAuthenticating||(this.logger.error("v4c exception, falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}}))},t.prototype.onConnectingTimeout=function(){this.state===S.Allocating||this.state===S.Connecting||this.state===S.Handshaking||this.state===S.AnonymousConnecting||this.state===S.WebsocketAuthenticating?this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0}):this.showIgnored("onConnectingTimeout")},t.prototype.onConnecting=function(){this.state===S.Handshaking?this.setState(S.Connecting):this.showIgnored("onConnecting")},t.prototype.onSocketConnect=function(g){this.state===S.AnonymousConnecting?(this.setState(S.WebsocketAuthenticating),this.worker.sendV4cAuthenticationEvent(g)):this.showIgnored("onSocketConnect")},t.prototype.onConnectingFailed=function(){this.state===S.Connecting?this.onConnectingTimeout():this.state===S.Handshaking?(this.logger.error("Unexpected error in Socket.io - no valid transports"),this.onConnectingTimeout()):this.state===S.AnonymousConnecting||this.state===S.WebsocketAuthenticating?(this.logger.info("/v4/c falling back to longpoll"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"v4c-websocket-failure"}})):this.showIgnored("onConnectingFailed")},t.prototype.onSocketDisconnect=function(g){this.state===S.Handshaking||this.state===S.Connected||this.state===S.WebsocketAuthenticating?(this.state===S.Connected&&this.worker.sendDisconnectTelemetryEvent(null==g?void 0:g.toTelemetryString()),this.state===S.WebsocketAuthenticating&&this.worker.countDisconnectBeforeConnectionEstablishment(),"skypetoken-deprecated"===(null==g?void 0:g.reason)?(this.logger.error("Skypetoken deprecated response, not retrying any further"),this.onTerminalError()):this.cleanUpAndInitiateReconnect({backoff:this.state!==S.Connected&&"dup"!==(null==g?void 0:g.reason),allowCachedToken:"unauthorized"!==(null==g?void 0:g.reason),claimsChallenge:null==g?void 0:g.claims})):this.showIgnored("onSocketDisconnect")},t.prototype.onTrouterConnected=function(){this.state===S.Connecting||this.state===S.WebsocketAuthenticating?(this.setState(S.Connected),this.worker.resetTokenBackoff(),this.worker.stopConnectionTimer(),this.worker.sendUserActivityState(C.UserActivityEventReason.Connected,!0),this.worker.startPingTimer(),this.worker.dispatchConnected(),this.worker.shouldSkipRegistration()?(this.registrationState=v.RegistrationDisabled,this.worker.dispatchRegistered()):(this.registrationState=v.Registering,this.worker.sendRegisterRequest())):this.showIgnored("onTrouterConnected")},t.prototype.onReconnectRequired=function(g,m,f){this.state===S.AnonymousConnecting||this.state===S.WebsocketAuthenticating?void 0===f||"host"!==f.target||void 0===f.url||""===f.url?(this.logger.error("unexpected reconnect arguments: "+(null==f?void 0:f.target)+" "+(null==f?void 0:f.url)+", reconnecting without cache"),this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect-no-host"}})):this.cleanUpAndInitiateReconnect({backoff:!0,allowCachedToken:!0,fallbackReason:{kind:"redirect",host:f.url}}):this.worker.dispatchReconnectIsRequired(g,m)},t.prototype.disableAutoReconnect=function(){this.autoReconnect=!1},t.prototype.onDownstreamRequest=function(g){this.state===S.Connected?(this.switchToIncallModeIfEnabled(),this.worker.dispatchDownstreamRequest(g)):this.showIgnored("onDownstreamRequest")},t.prototype.onTrouterMessageLost=function(g){this.state===S.Connected?this.worker.dispatchTrouterMessageLost(g):this.showIgnored("onTrouterMessageLost")},t.prototype.onPingInterval=function(){this.state===S.Connected?this.worker.sendPingRequest():this.showIgnored("onPingInterval")},t.prototype.onPingResponseTimeout=function(){this.onMissedResponse("onPingResponseTimeout")},t.prototype.onPingResponse=function(){this.state===S.Connected||this.showIgnored("onPingResponse")},t.prototype.onRegistrationFailed=function(){this.state===S.Connected&&this.registrationState===v.Registering?(this.worker.dispatchUnregistered(),this.registrationState=v.Retrying,this.worker.startRegistrationRetryTimer()):this.state===S.Connected&&this.registrationState===v.RegisteringButResendPending?(this.registrationState=v.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationFailed")},t.prototype.onRetryRegistration=function(){this.state===S.Connected&&this.registrationState===v.Retrying?(this.registrationState=v.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRetryRegistration")},t.prototype.onRegistrationSucceeded=function(){this.state===S.Connected&&this.registrationState===v.Registering?(this.registrationState=v.Registered,this.worker.dispatchRegistered(),this.worker.startRegistrationTimer()):this.state===S.Connected&&this.registrationState===v.RegisteringButResendPending?(this.registrationState=v.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationSucceeded")},t.prototype.onRegistrationNearExpiry=function(){this.state===S.Connected&&this.registrationState===v.Registered?(this.registrationState=v.Registering,this.worker.sendRegisterRequest()):this.showIgnored("onRegistrationNearExpiry")},t.prototype.onUnregistrationDone=function(){this.state===S.Unregistering?(this.setState(S.Initial),this.worker.dispatchUnregistered(),this.worker.dispatchDisconnected()):this.showIgnored("onUnregistrationDone")},t.prototype.onResendRegistration=function(){this.worker.dispatchUnregistered(),this.state===S.Connected&&this.registrationState===v.Registered?(this.registrationState=v.Registering,this.worker.stopRegistrationTimer(),this.worker.sendRegisterRequest()):this.state===S.Connected&&this.registrationState===v.Registering&&(this.registrationState=v.RegisteringButResendPending)},t.prototype.onIncallModeTimer=function(){this.worker.exitIncallMode(),this.state===S.Connected?(this.worker.stopPingTimer(),this.worker.startPingTimer()):this.showIgnored("onIncallModeTimer")},t.prototype.onSetNewUserActivityState=function(){this.worker.sendUserActivityState(C.UserActivityEventReason.Modified,this.state===S.Connected)},t.prototype.onActivityStateResponseTimeout=function(){this.onMissedResponse("onActivityStateResponseTimeout")},t.prototype.forceReconnect=function(g){this.state===S.Connected&&this.worker.sendDisconnectTelemetryEvent(g),this.worker.resetTokenBackoff(),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})},t.prototype.onTerminalError=function(){this.logger.error("Cannot proceed, reached terminal state. Switching from state '"+S[this.state]+"' to "+S[S.TerminalError]),this.stop(!0,!0),this.setState(S.TerminalError)},t.prototype.onMissedResponse=function(g){this.state===S.Connected?(this.worker.sendDisconnectTelemetryEvent(g),this.cleanUpAndInitiateReconnect({backoff:!1,allowCachedToken:!0})):this.showIgnored(g)},t.prototype.showIgnored=function(g){this.logger.debug("Ignoring event '"+g+"' in state '"+S[this.state]+"'")},t.prototype.setState=function(g){this.logger.info("Switching from state '"+S[this.state]+"' to state '"+S[g]+"'"),this.state!==g?this.state=g:this.logger.error("Attempt to switch to the current state '"+S[g]+"'")},t.prototype.switchToIncallModeIfEnabled=function(){this.incallModeEnabled&&(this.worker.isIncallMode()||(this.worker.enterIncallMode(),this.worker.stopPingTimer(),this.worker.startPingTimer()),this.worker.restartIncallModeTimer())},t.prototype.cleanUpAndInitiateReconnect=function(g){if(!this.autoReconnect)return this.logger.info("Automatic reconnect is disabled, stopping this connection"),void this.stop(!0);this.worker.cancelPendingRegistrationRequests(),this.worker.stopConnectionTimer(),this.worker.stopPingTimer(),this.worker.clearSentEventTimers(),this.worker.stopRegistrationTimer(),this.worker.stopSocketIo(),this.setState(S.RetrievingToken),this.worker.dispatchReconnecting(),this.worker.getToken(g.allowCachedToken,g.backoff,g.claimsChallenge,g.fallbackReason)},t}();m.TrouterFsm=T},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.MessageHandlerRegistry=void 0;var S=f(1),v=f(0),C=function(){function t(g){this.messageHandlers=[],this.logger=new v.Logger("MessageHandlers",g)}return t.prototype.register=function(g){if(this.messageHandlers.some((function(m){return m===g})))throw new Error("Registering the same handler twice is not allowed");this.messageHandlers.push(g)},t.prototype.clear=function(){this.logger.debug("Clearing message handlers"),this.messageHandlers=[]},t.prototype.active=function(){return this.messageHandlers.length>0},t.prototype.handleMessage=function(g){for(var m={resultCode:S.UNHANDLED_MESSAGE_ACK,isHandled:!1},f=0,v=this.messageHandlers;f<v.length;f++){var C=v[f],_=this.safeExecuteHandle(C,g);if(void 0!==_&&(void 0===_.isHandled||_.isHandled))return void 0===_.resultCode&&(_.resultCode=S.HANDLED_MESSAGE_ACK),_}return m},t.prototype.safeExecuteHandle=function(g,m){try{return g.handleMessage(m)}catch(g){return void this.logger.warn("Trouter message handler threw an exception: "+g)}},t}();m.MessageHandlerRegistry=C},function(g,m,f){function o(g){var m,f=this;return function(C){return S(f,void 0,void 0,(function(){return v(this,(function(f){return C&&(m=void 0),[2,new Promise((function(f,S){g(C).then((function(g){m=g,f(g)})).catch((function(g){void 0!==m&&m.length>0&&f(m),S(g)}))}))]}))}))}}var S=this&&this.__awaiter||function(g,m,f,S){function i(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{a(S.next(g))}catch(g){v(g)}}function c(g){try{a(S.throw(g))}catch(g){v(g)}}function a(g){g.done?f(g.value):i(g.value).then(s,c)}a((S=S.apply(g,m||[])).next())}))},v=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===C[0]||2===C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.addCacheAsBackupTo=void 0,m.addCacheAsBackupTo=o},function(g,m,f){var S=this&&this.__awaiter||function(g,m,f,S){function i(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{a(S.next(g))}catch(g){v(g)}}function c(g){try{a(S.throw(g))}catch(g){v(g)}}function a(g){g.done?f(g.value):i(g.value).then(s,c)}a((S=S.apply(g,m||[])).next())}))},v=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===C[0]||2===C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManager=m.AudienceSubscriptionState=m.UserActivityObject=void 0;var C=f(3),_=f(2),E=f(4),T=f(0),I=f(5),b=f(6),A=f(7),P=f(18),R=function(){function t(g,m){this.state=g,this.correlationVector=void 0!==m?m:C.CorrelationVector.extend()}return t.prototype.getStateString=function(){switch(this.state){case _.UserActivityState.Active:return"active";case _.UserActivityState.Inactive:return"inactive";case _.UserActivityState.Unknown:return"unknown";default:return"undefined"}},t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return{state:this.getStateString(),cv:this.correlationVector.value()}},t.prototype.toEventJSON=function(){return(0,C.toJson)(this.toEventObject())},t}();m.UserActivityObject=R;var w=function(){function t(g,m){void 0===m&&(m=C.CorrelationVector.extend()),this.audienceSubscriptionModel=g,this.correlationVector=m}return t.prototype.increaseCvAndGetEventObject=function(){return this.correlationVector.increase(),this.toEventObject()},t.prototype.toEventObject=function(){return{audiences:this.audienceSubscriptionModel.audienceSubscriptions,cv:this.correlationVector.value()}},t}();m.AudienceSubscriptionState=w;var M=function(){function t(g,m,f,S,v,E){var b=this;this.logFunc=g,this.options=m,this.tokenProvider=f,this.usingLegacyTokenApi=S,this.listener=v,this.tokenTypeProtocolSelector=function(g,m){return b.options.forceV4aProtocol?"v4a":(0,I.usedProtocol)(g,m)},this.logger=new T.Logger("Manager",g),this.logger.info("Created TrouterManager with options "+(0,C.toJson)(this.options)),this.fsm=new P.TrouterManagerFsm(g,this),this.baseEndpointUrl="",this.processedMessageLoss={},this.userActivityObject=new R(_.UserActivityState.Unknown),this.protocolSelector=null!=E?E:this.tokenTypeProtocolSelector.bind(this)}return t.prototype.start=function(){this.fsm.start()},t.prototype.stop=function(g){this.fsm.stop(g)},t.prototype.configure=function(g){this.options=g,void 0!==this.firstConnection&&this.firstConnection.configure(g),void 0!==this.secondConnection&&this.secondConnection.configure(g),this.logger.info("Reconfigured TrouterManager with options "+(0,C.toJson)(this.options))},t.prototype.checkConnection=function(g){void 0!==this.firstConnection&&this.firstConnection.checkConnection(g),void 0!==this.secondConnection&&this.secondConnection.checkConnection(g)},t.prototype.resendRegistration=function(){return S(this,void 0,void 0,(function(){return v(this,(function(g){return void 0!==this.secondConnection?(this.logger.info("Resending registration on the second/new connection"),[2,this.secondConnection.resendRegistration()]):void 0!==this.firstConnection?(this.logger.info("Resending registration on the first/current connection"),[2,this.firstConnection.resendRegistration()]):(this.logger.info("No connection to resend registration on, will be done upon (re)connect"),[2])}))}))},t.prototype.getServerState=function(){if(void 0!==this.firstConnection)return this.firstConnection.getServerState()},t.prototype.getState=function(){return this.fsm.getState()},t.prototype.isInTerminalState=function(){return this.fsm.getInternalState()===E.TrouterManagerState.TerminalError},t.prototype.reportStateInfo=function(){var g=this.firstConnection?A.State[this.firstConnection.getState()]:"Unknown",m=E.TrouterManagerState[this.fsm.getInternalState()];return this.secondConnection?"Manager "+m+"; 1st "+g+"; 2nd "+A.State[this.secondConnection.getState()]:"Manager "+m+"; Connection "+g},t.prototype.startFirstConnection=function(){var g=new b.TrouterConnection(this.logFunc,this.options,this,this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.firstConnection=g,this.getConnectionCache().then((function(m){g.start(m)})).catch((function(){}))},t.prototype.startSecondConnection=function(g){var m=new b.TrouterConnection(this.logFunc,this.options,this,this.tokenProvider,this.usingLegacyTokenApi,this.userActivityObject,this.protocolSelector,this.audienceSubscriptionState);this.secondConnection=m,void 0!==this.firstConnection&&this.firstConnection.disableRegistrationsAndAutoReconnect(),g?this.getConnectionCache().then((function(g){m.start(g)})).catch((function(){})):m.start()},t.prototype.stopFirstConnection=function(g){void 0!==this.firstConnection&&(this.storedFirstConnection=this.firstConnection,this.firstConnection.stop(g),this.firstConnection=void 0)},t.prototype.stopSecondConnection=function(g){void 0!==this.secondConnection&&(this.secondConnection.stop(g),this.secondConnection=void 0)},t.prototype.stopSecondConnectionDelayed=function(){if(void 0!==this.secondConnection){var g=this.secondConnection;this.secondConnection=void 0,this.logger.info("Closing an inactive connection in "+Math.round(this.options.lingeringConnectionDelayMs/1e3)+"s"),setTimeout((function(){g.stop(!0)}),this.options.lingeringConnectionDelayMs)}},t.prototype.forceStopLingeringConnection=function(){this.storedFirstConnection&&(this.storedFirstConnection.stop(!1),this.storedFirstConnection=void 0)},t.prototype.switchConnections=function(){var g=this.firstConnection;this.firstConnection=this.secondConnection,this.secondConnection=g},t.prototype.doesSecondConnectionExist=function(){return void 0!==this.secondConnection},t.prototype.dispatchConnected=function(){if(void 0!==this.firstConnection){var g=this.firstConnection.getServerState(),m=g.url.endsWith("/")?g.url.slice(0,-1):g.url,f={baseEndpointUrl:m,newEndpointUrl:m!==this.baseEndpointUrl,c2cUrlBase:g.c2cUrlBase,clientId:g.connectedClientId,connectionId:g.connectionId,connectionTtlSec:g.getRemainingTtlInSec()};this.baseEndpointUrl=m,this.listener.onTrouterConnected(g.url,f)}},t.prototype.dispatchDisconnected=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},t.prototype.dispatchTerminalError=function(){this.listener.onTrouterDisconnected&&this.listener.onTrouterDisconnected()},t.prototype.dispatchRegistrationState=function(g){this.options.registrationStateCallback&&this.options.registrationStateCallback(g)},t.prototype.onDownstreamRequest=function(g,m,f){var S={id:m.id,method:m.method,path:"/"+m.shortUrl,body:m.body,headers:m.headers},v={id:m.id,status:0,headers:{},body:"",send:function(){return v.status<=100||v.status>=999?3:(f.writeHead(v.status,v.headers),f.end(v.body))}};this.listener.onTrouterRequest(S,v)},t.prototype.onConnected=function(g){this.fsm.onConnected(g===this.firstConnection)},t.prototype.onRegistered=function(g){this.fsm.onRegistered(g===this.firstConnection)},t.prototype.onUnregistered=function(g){this.fsm.onUnregistered(g===this.firstConnection||g===this.storedFirstConnection)},t.prototype.onReconnecting=function(g){this.fsm.onReconnecting(g===this.firstConnection)},t.prototype.onReconnectIsRequired=function(g,m,f){this.fsm.onReconnectionRequired(g===this.firstConnection,m,f)},t.prototype.onDisconnected=function(g){this.fsm.onDisconnected(g===this.firstConnection||g==this.storedFirstConnection),this.storedFirstConnection=void 0},t.prototype.onTerminalError=function(g){this.fsm.onTerminalError(g===this.firstConnection||g==this.storedFirstConnection),this.storedFirstConnection=void 0},t.prototype.onUserActivityStateAccepted=function(g){this.listener.onTrouterUserActivityStateAccepted&&this.listener.onTrouterUserActivityStateAccepted(g)},t.prototype.onAudiencesSetResolved=function(g,m){var f,S;null===(S=(f=this.listener).onAudiencesSetResolved)||void 0===S||S.call(f,g,m)},t.prototype.onConnectionParametersUpdated=function(g){this.setConnectionCache(g)},t.prototype.setUserActivityState=function(g,m){return this.userActivityObject=new R(g,C.CorrelationVector.extend(m)),void 0!==this.secondConnection?(this.logger.info("Setting user activity "+this.userActivityObject.toEventJSON()+" on the second/new connection"),void this.secondConnection.setUserActivityState(this.userActivityObject)):void 0!==this.firstConnection?(this.logger.info("Setting user activity "+this.userActivityObject.toEventJSON()+" on the first/current connection"),void this.firstConnection.setUserActivityState(this.userActivityObject)):void 0},t.prototype.setAudienceSubscriptionsAsync=function(g,m,f){if(this.audienceSubscriptionState=new w(g,C.CorrelationVector.extend(f)),this.secondConnection)return this.logger.info("Setting audience subscriptions on second/new connection"),this.secondConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,m);if(this.firstConnection)return this.logger.info("Setting audience subscriptions on first/current connection"),this.firstConnection.setAudienceSubscriptionsAsync(this.audienceSubscriptionState,m);throw new Error("No connection found")},t.prototype.onTrouterMessageLost=function(g){var m=this;if(this.listener.onTrouterMessageLoss)if(null==g?void 0:g.length){var f=g.filter((function(g){return void 0!==m.processedMessageLoss[g.tag+"-"+g.etag]}));if(f.length&&(this.logger.info("onTrouterMessageLoss - immediately acknowledging "+f.length+" seen dropped indicators"),this.sendProcessedDroppedIndicators(f),!(g=g.filter((function(g){return void 0===m.processedMessageLoss[g.tag+"-"+g.etag]}))).length))return void this.logger.info("onTrouterMessageLoss - all declared dropped indicators have been seen before");if(!this.listener.onTrouterMessageLoss(g.map((function(g){return g.tag}))))return void this.logger.warn("onTrouterMessageLoss - some flow tag(s) have not been processed by listeners");g.forEach((function(g){m.processedMessageLoss[g.tag+"-"+g.etag]=""})),this.sendProcessedDroppedIndicators(g)}else this.logger.warn("onTrouterMessageLoss - no flow tags have been provided")},t.prototype.getConnectionCache=function(){var g=this;return this.options.connectionCache?(this.logger.debug("Querying host's connection cache"),this.options.connectionCache.onGetTrouterConnectionCache().then((function(g){var m=g?JSON.parse(g):void 0;return"object"==typeof m?m:void 0})).catch((function(m){return g.logger.warn("Invalid connection cache content provided: "+m),g.connectionCache}))):Promise.resolve(this.connectionCache)},t.prototype.setConnectionCache=function(g){if(this.connectionCache=g,this.options.connectionCache)try{this.options.connectionCache.onSetTrouterConnectionCache(JSON.stringify(g))}catch(g){this.logger.warn("Error setting external connection cache: "+g)}},t.prototype.sendProcessedDroppedIndicators=function(g){return void 0!==this.firstConnection?void this.firstConnection.sendProcessedDroppedIndicators(g):void 0!==this.secondConnection?void this.secondConnection.sendProcessedDroppedIndicators(g):void 0},t}();m.TrouterManager=M},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterUrlPromise=void 0;var S=f(0),v=function(){function t(g){this.logger=new S.Logger("UrlPromise",g)}return t.prototype.getPromise=function(){var g=this;return void 0!==this.url?(this.logger.debug("returning previously resolved url: "+this.url),Promise.resolve(this.url)):(void 0===this.pendingPromise?(this.logger.debug("creating and returning promise"),this.pendingPromise=new Promise((function(m,f){g.pendingPromiseResolveRef=m,g.pendingPromiseRejectRef=f}))):this.logger.debug("returning existing promise"),this.pendingPromise)},t.prototype.resolveUrl=function(g){this.url=g,this.logger.debug("got url: "+this.url);var m=this.pendingPromiseResolveRef;this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==m&&(this.logger.debug("resolving promise"),m(g))},t.prototype.rejectUrl=function(g){this.logger.debug("aborting");var m=this.pendingPromiseRejectRef;this.url=void 0,this.pendingPromise=void 0,this.pendingPromiseResolveRef=void 0,this.pendingPromiseRejectRef=void 0,void 0!==m&&(this.logger.debug("rejecting promise"),m(g))},t.prototype.resetUrl=function(){this.logger.debug("resetting url"),this.url=void 0},t}();m.TrouterUrlPromise=v},function(g,m,f){(function(g,f){!function(g,m){var f=g;f.version="0.9.6",f.protocol=1,f.transports=[],f.j=[],f.sockets={},f.connect=function(g,S){var v,C,_=f.util.parseUri(g);m&&m.location&&(_.protocol=_.protocol||m.location.protocol.slice(0,-1),_.host=_.host||(m.document?m.document.domain:m.location.hostname),_.port=_.port||m.location.port),v=f.util.uniqueUri(_);var E={host:_.host,secure:"https"==_.protocol,port:_.port||("https"==_.protocol?443:80),query:_.query||""};return f.util.merge(E,S),!E["force new connection"]&&f.sockets[v]||(C=new f.Socket(E)),!E["force new connection"]&&C&&(f.sockets[v]=C),C=C||f.sockets[v],E["skipped handshake data"]?C.of(""):C.of(_.path.length>1?_.path:"")}}(f.exports,void 0===g?window:g);var S=f.exports;!function(g,m){var f=g.util={},S=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,v=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];f.parseUri=function(g){for(var m=S.exec(g||""),f={},C=14;C--;)f[v[C]]=m[C]||"";return f},f.uniqueUri=function(g){var f=g.protocol,S=g.host,v=g.port;return"document"in m?(S=S||document.domain,v=v||("https"==f&&"https:"!==document.location.protocol?443:document.location.port)):(S=S||"localhost",v||"https"!=f||(v=443)),(f||"http")+"://"+S+":"+(v||80)},f.query=function(g,m){var S=f.chunkQuery(g||""),v=[];for(var C in f.merge(S,f.chunkQuery(m||"")),S)S.hasOwnProperty(C)&&v.push(C+"="+S[C]);return v.length?"?"+v.join("&"):""},f.chunkQuery=function(g){for(var m,f={},S=g.split("&"),v=0,C=S.length;v<C;++v)(m=S[v].split("="))[0]&&(f[m[0]]=m[1]);return f};var C=!1;f.load=function(g){if("document"in m&&"complete"===document.readyState||C)return g();f.on(m,"load",g,!1)},f.on=function(g,m,f,S){g.attachEvent?g.attachEvent("on"+m,f):g.addEventListener&&g.addEventListener(m,f,S)},f.request=function(g){if(g&&"undefined"!=typeof XDomainRequest)return new XDomainRequest;if("undefined"!=typeof XMLHttpRequest&&(!g||f.ua.hasCORS))return new XMLHttpRequest;if(!g)try{return new(window[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(g){}return null},"undefined"!=typeof window&&f.load((function(){C=!0})),f.defer=function(g){if(!f.ua.webkit||"undefined"!=typeof importScripts)return g();f.load((function(){setTimeout(g,100)}))},f.merge=function(g,m,S,v){var C,_=v||[],E=void 0===S?2:S;for(C in m)m.hasOwnProperty(C)&&f.indexOf(_,C)<0&&("object"==typeof g[C]&&E?f.merge(g[C],m[C],E-1,_):(g[C]=m[C],_.push(m[C])));return g},f.mixin=function(g,m){f.merge(g.prototype,m.prototype)},f.inherit=function(g,m){function n(){}n.prototype=m.prototype,g.prototype=new n},f.isArray=Array.isArray||function(g){return"[object Array]"===Object.prototype.toString.call(g)},f.intersect=function(g,m){for(var S=[],v=g.length>m.length?g:m,C=g.length>m.length?m:g,_=0,E=C.length;_<E;_++)~f.indexOf(v,C[_])&&S.push(C[_]);return S},f.indexOf=function(g,m,f){var S=g.length;for(f=f<0?f+S<0?0:f+S:f||0;f<S&&g[f]!==m;f++);return S<=f?-1:f},f.toArray=function(g){for(var m=[],f=0,S=g.length;f<S;f++)m.push(g[f]);return m},f.ua={},f.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&function(){try{var g=new XMLHttpRequest}catch(g){return!1}return null!=g.withCredentials}(),f.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent)}(void 0!==S?S:f.exports,void 0===g?window:g),function(g,m){function n(){}g.EventEmitter=n,n.prototype.on=function(g,f){return this.$events||(this.$events={}),this.$events[g]?m.util.isArray(this.$events[g])?this.$events[g].push(f):this.$events[g]=[this.$events[g],f]:this.$events[g]=f,this},n.prototype.addListener=n.prototype.on,n.prototype.once=function(g,m){function n(){f.removeListener(g,n),m.apply(this,arguments)}var f=this;return n.listener=m,this.on(g,n),this},n.prototype.removeListener=function(g,f){if(this.$events&&this.$events[g]){var S=this.$events[g];if(m.util.isArray(S)){for(var v=-1,C=0,_=S.length;C<_;C++)if(S[C]===f||S[C].listener&&S[C].listener===f){v=C;break}if(v<0)return this;S.splice(v,1),S.length||delete this.$events[g]}else(S===f||S.listener&&S.listener===f)&&delete this.$events[g]}return this},n.prototype.removeAllListeners=function(g){return this.$events&&this.$events[g]&&(this.$events[g]=null),this},n.prototype.listeners=function(g){return this.$events||(this.$events={}),this.$events[g]||(this.$events[g]=[]),m.util.isArray(this.$events[g])||(this.$events[g]=[this.$events[g]]),this.$events[g]},n.prototype.emit=function(g){if(!this.$events)return!1;var f=this.$events[g];if(!f)return!1;var S=Array.prototype.slice.call(arguments,1);if("function"==typeof f)f.apply(this,S);else{if(!m.util.isArray(f))return!1;for(var v=f.slice(),C=0,_=v.length;C<_;C++)v[C].apply(this,S)}return!0}}(void 0!==S?S:f.exports,void 0!==S?S:f.parent.exports),function(g,m){if(m&&m.parse)return g.JSON={parse:m.parse,stringify:m.stringify};throw new Error("JSON not available")}(void 0!==S?S:f.exports,"undefined"!=typeof JSON?JSON:void 0),function(g,m){var f=g.parser={},S=f.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"],v=f.reasons=["transport not supported","client not handshaken","unauthorized"],C=f.advice=["reconnect"],_=m.JSON,E=m.util.indexOf;f.encodePacket=function(g){var m=E(S,g.type),f=g.id||"",T=g.endpoint||"",I=g.ack,b=null;switch(g.type){case"error":var A=g.reason?E(v,g.reason):"",P=g.advice?E(C,g.advice):"";""===A&&""===P||(b=A+(""!==P?"+"+P:""));break;case"message":""!==g.data&&(b=g.data);break;case"event":var R={name:g.name};g.args&&g.args.length&&(R.args=g.args),b=_.stringify(R);break;case"json":b=_.stringify(g.data);break;case"connect":g.qs&&(b=g.qs);break;case"ack":b=g.ackId+(g.args&&g.args.length?"+"+_.stringify(g.args):"")}var w=[m,f+("data"==I?"+":""),T];return null!=b&&w.push(b),w.join(":")},f.encodePayload=function(g){var m="";if(1==g.length)return g[0];for(var f=0,S=g.length;f<S;f++)m+="�"+g[f].length+"�"+g[f];return m};var T=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;f.decodePacket=function(g){if(!(E=g.match(T)))return{};var m=E[2]||"",f=(g=E[5]||"",{type:S[E[1]],endpoint:E[4]||""});switch(m&&(f.id=m,E[3]?f.ack="data":f.ack=!0),f.type){case"error":var E=g.split("+");f.reason=v[E[0]]||"",f.advice=C[E[1]]||"";break;case"message":f.data=g||"";break;case"event":try{var I=_.parse(g);f.name=I.name,f.args=I.args}catch(g){}f.args=f.args||[];break;case"json":try{f.data=_.parse(g)}catch(g){}break;case"connect":f.qs=g||"";break;case"ack":if((E=g.match(/^([0-9]+)(\+)?(.*)/))&&(f.ackId=E[1],f.args=[],E[3]))try{f.args=E[3]?_.parse(E[3]):[]}catch(g){}break;case"disconnect":f.reason=g}return f},f.decodePayload=function(g){if("�"==g.charAt(0)){for(var m=[],S=1,v="";S<g.length;S++)"�"==g.charAt(S)?(m.push(f.decodePacket(g.substr(S+1).substr(0,v))),S+=Number(v)+1,v=""):v+=g.charAt(S);return m}return[f.decodePacket(g)]}}(void 0!==S?S:f.exports,void 0!==S?S:f.parent.exports),function(g,m){function n(g,m){this.socket=g,this.sessid=m,this.connectErrorCallback=void 0,this.isOpened=!1}g.Transport=n,m.util.mixin(n,m.EventEmitter),n.prototype.onData=function(g){if(this.clearCloseTimeout(),(this.socket.connected||this.socket.connecting||this.socket.reconnecting)&&this.setCloseTimeout(),""!==g){var f=m.parser.decodePayload(g);if(f&&f.length)for(var S=0,v=f.length;S<v;S++)this.onPacket(f[S])}return this},n.prototype.onPacket=function(g){return this.socket.setHeartbeatTimeout(),"heartbeat"==g.type?this.onHeartbeat():("connect"==g.type&&""==g.endpoint&&this.onConnect(),"error"==g.type&&"reconnect"==g.advice&&(this.isOpened=!1),this.socket.onPacket(g),this)},n.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var g=this;this.closeTimeout=setTimeout((function(){g.onDisconnect()}),this.socket.closeTimeout)}},n.prototype.onDisconnect=function(){return this.close&&this.isOpened&&this.close(),this.clearTimeouts(),this.socket.onDisconnect(),this},n.prototype.onConnect=function(){return this.socket.onConnect(),this.connectErrorCallback=void 0,this},n.prototype.clearCloseTimeout=function(){this.closeTimeout&&(clearTimeout(this.closeTimeout),this.closeTimeout=null)},n.prototype.clearTimeouts=function(){this.clearCloseTimeout(),this.reopenTimeout&&clearTimeout(this.reopenTimeout)},n.prototype.packet=function(g){this.send(m.parser.encodePacket(g))},n.prototype.onHeartbeat=function(g){this.packet({type:"heartbeat"})},n.prototype.onOpen=function(){this.isOpened=!0,this.clearCloseTimeout(),this.socket.onOpen()},n.prototype.onClose=function(){this.isOpened=!1,this.socket.onClose(),this.onDisconnect()},n.prototype.prepareUrl=function(g){var f=this.socket.options;if(f["skipped handshake data"])return f.rewriteUrlForProxy(f["skipped handshake data"].websocketUrl+(g||""));var S=this.scheme()+"://"+f.host+":"+f.port+"/"+f.resource+"/"+m.protocol+"/"+this.name+"/"+this.sessid+(g||"");return f.rewriteUrlForProxy(S)},n.prototype.ready=function(g,m){m.call(this)},n.prototype.clearEventHandlers=function(){return this}}(void 0!==S?S:f.exports,void 0!==S?S:f.parent.exports),function(g,m,f){function o(g){if(this.options={port:80,secure:!1,document:"document"in f&&document,resource:"socket.io",transports:m.transports.slice(),"connect timeout":1e4,"try multiple transports":!0,reconnect:!0,"reconnection delay":500,"reconnection limit":1/0,"reopen delay":3e3,"max reconnection attempts":10,"sync disconnect on unload":!0,"auto connect":!0,"flash policy port":10843},m.util.merge(this.options,g),this.connected=!1,this.open=!1,this.connecting=!1,this.reconnecting=!1,this.namespaces={},this.buffer=[],this.doBuffer=!1,this.disconnected=!1,this.options["sync disconnect on unload"]&&(!this.isXDomain()||m.util.ua.hasCORS)){var S=this;m.util.on(f,"unload",(function(){S.disconnectSync()}),!1)}this.options["auto connect"]&&this.connect()}function i(){}g.Socket=o,m.util.mixin(o,m.EventEmitter),o.prototype.of=function(g){return this.namespaces[g]||(this.namespaces[g]=new m.SocketNamespace(this,g),""!==g&&this.namespaces[g].packet({type:"connect"})),this.namespaces[g]},o.prototype.publish=function(){var g;for(var m in this.emit.apply(this,arguments),this.namespaces)this.namespaces.hasOwnProperty(m)&&(g=this.of(m)).$emit.apply(g,arguments)},o.prototype.handshake=function(g){function n(m){m instanceof Error?f.onError(m.message):g.apply(null,m.split(":"))}var f=this,S=this.options;if(!f.disconnected){var v=S.rewriteUrlForProxy(["http"+(S.secure?"s":"")+":/",S.host+":"+S.port,S.resource,m.protocol,m.util.query(this.options.query,"t="+ +new Date)].join("/"));if(this.isXDomain()&&!m.util.ua.hasCORS){var C=document.getElementsByTagName("script")[0],_=document.createElement("script");_.src=v+"&jsonp="+m.j.length,C.parentNode.insertBefore(_,C),m.j.push((function(g){n(g),_.parentNode.removeChild(_)}))}else{var E=m.util.request();E.open("GET",v,!0);var T=this.options.requestHeaders;void 0!==T&&Object.keys(T).forEach((function(g){E.setRequestHeader(g,T[g])})),E.onreadystatechange=function(){4==E.readyState&&(E.onreadystatechange=i,200==E.status?n(E.responseText):!f.reconnecting&&f.onError(E.responseText))},E.send(null)}}},o.prototype.getTransport=function(g){for(var f,S=g||this.transports,v=0;f=S[v];v++)if(m.Transport[f]&&m.Transport[f].check(this)&&(!this.isXDomain()||m.Transport[f].xdomainCheck()))return new m.Transport[f](this,this.sessionid);return null},o.prototype.connect=function(g){if(this.connecting||this.disconnected)return this;var f=this,o=function(S,v,C,_){function c(){if(!f.connected&&!f.disconnected)if(f.connecting=!1,clearTimeout(f.connectTimeoutTimer),f.options["try multiple transports"]){for(;f.remainingTransports.length>0&&f.remainingTransports.splice(0,1)[0]!=f.transport.name;);f.remainingTransports.length?a(f.remainingTransports):f.publish("connect_failed")}else f.publish("connect_failed")}function a(g){if(f.transport&&(f.transport.clearTimeouts(),f.transport.clearEventHandlers()),f.transport=f.getTransport(g),!f.transport||f.disconnected)return f.publish("connect_failed");f.transport.ready(f,(function(){f.connecting=!0,f.publish("connecting",f.transport.name),f.transport.open(c),f.options["connect timeout"]&&(f.connectTimeoutTimer=setTimeout((function(){c()}),f.options["connect timeout"]))}))}f.sessionid=S,f.closeTimeout=1e3*C+2e3,f.heartbeatTimeout=1e3*v+2e3,f.transports=_?m.util.intersect(_.split(","),f.options.transports):f.options.transports,f.setHeartbeatTimeout(),f.remainingTransports=f.transports.slice(0),a(f.transports),f.once("connect",(function(){clearTimeout(f.connectTimeoutTimer),g&&"function"==typeof g&&g()}))};if(this.options["skipped handshake data"]){var S=this.options["skipped handshake data"];o("v4c-"+(new Date).getTime(),S.timeout,S.timeout,"websocket")}else this.handshake(o);return this},o.prototype.setHeartbeatTimeout=function(){clearTimeout(this.heartbeatTimeoutTimer);var g=this;this.heartbeatTimeoutTimer=setTimeout((function(){g.transport.onClose()}),this.heartbeatTimeout)},o.prototype.packet=function(g){return this.connected&&!this.doBuffer?this.transport.packet(g):this.buffer.push(g),this},o.prototype.setBuffer=function(g){this.doBuffer=g,!g&&this.connected&&this.buffer.length&&(this.transport.payload(this.buffer),this.buffer=[])},o.prototype.disconnect=function(){return(this.connected||this.connecting)&&(this.open&&this.of("").packet({type:"disconnect"}),this.onDisconnect("booted")),this.disconnected=!0,this},o.prototype.disconnectSync=function(){var g=m.util.request(),f=this.resource+"/"+m.protocol+"/"+this.sessionid;g.open("GET",f,!0),this.onDisconnect("booted")},o.prototype.isXDomain=function(){var g=f.location.port||("https:"==f.location.protocol?443:80);return this.options.host!==f.location.hostname||this.options.port!=g},o.prototype.onConnect=function(){this.connected||(this.connected=!0,this.connecting=!1,this.doBuffer||this.setBuffer(!1),this.emit("connect"))},o.prototype.onOpen=function(){this.open=!0},o.prototype.onClose=function(){this.open=!1,clearTimeout(this.heartbeatTimeoutTimer)},o.prototype.onPacket=function(g){this.of(g.endpoint).onPacket(g)},o.prototype.onError=function(g){g&&g.advice&&"reconnect"===g.advice&&(this.connected||this.connecting)&&(this.disconnect(),this.options.reconnect&&this.reconnect()),this.publish("error",g&&g.reason?g.reason:g)},o.prototype.onDisconnect=function(g){var m=this.connected,f=this.connecting;this.connected=!1,this.connecting=!1,this.open=!1,(m||f)&&(this.transport.close(),this.transport.clearTimeouts(),m?(this.publish("disconnect",g),"booted"!=g&&this.options.reconnect&&!this.reconnecting&&this.reconnect()):this.publish("close_during_connecting",g))},o.prototype.reconnect=function(){function t(){if(g.connected){for(var m in g.namespaces)g.namespaces.hasOwnProperty(m)&&""!==m&&g.namespaces[m].packet({type:"connect"});g.publish("reconnect",g.transport.name,g.reconnectionAttempts)}clearTimeout(g.reconnectionTimer),g.removeListener("connect_failed",e),g.removeListener("connect",e),g.reconnecting=!1,delete g.reconnectionAttempts,delete g.reconnectionDelay,delete g.reconnectionTimer,delete g.redoTransports,g.options["try multiple transports"]=f}function e(){if(g.reconnecting)return g.connected?t():g.connecting&&g.reconnecting?g.reconnectionTimer=setTimeout(e,1e3):void(g.reconnectionAttempts++>=m?g.redoTransports?(g.publish("reconnect_failed"),t()):(g.on("connect_failed",e),g.options["try multiple transports"]=!0,g.transport=g.getTransport(),g.redoTransports=!0,g.connect()):(g.reconnectionDelay<S&&(g.reconnectionDelay*=2),g.connect(),g.publish("reconnecting",g.reconnectionDelay,g.reconnectionAttempts),g.reconnectionTimer=setTimeout(e,g.reconnectionDelay)))}this.reconnecting=!0,this.reconnectionAttempts=0,this.reconnectionDelay=this.options["reconnection delay"];var g=this,m=this.options["max reconnection attempts"],f=this.options["try multiple transports"],S=this.options["reconnection limit"];this.options["try multiple transports"]=!1,this.reconnectionTimer=setTimeout(e,this.reconnectionDelay),this.on("connect",e)}}(void 0!==S?S:f.exports,void 0!==S?S:f.parent.exports,void 0===g?window:g),function(g,m){function n(g,m){this.socket=g,this.name=m||"",this.flags={},this.json=new o(this,"json"),this.ackPackets=0,this.acks={}}function o(g,m){this.namespace=g,this.name=m}g.SocketNamespace=n,m.util.mixin(n,m.EventEmitter),n.prototype.$emit=m.EventEmitter.prototype.emit,n.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)},n.prototype.packet=function(g){return g.endpoint=this.name,this.socket.packet(g),this.flags={},this},n.prototype.send=function(g,m){var f={type:this.flags.json?"json":"message",data:g};return"function"==typeof m&&(f.id=++this.ackPackets,f.ack=!0,this.acks[f.id]=m),this.packet(f)},n.prototype.emit=function(g){var m=Array.prototype.slice.call(arguments,1),f=m[m.length-1],S={type:"event",name:g};return"function"==typeof f&&(S.id=++this.ackPackets,S.ack="data",this.acks[S.id]=f,m=m.slice(0,m.length-1)),S.args=m,this.packet(S)},n.prototype.disconnect=function(){return""===this.name?this.socket.disconnect():(this.packet({type:"disconnect"}),this.$emit("disconnect")),this},n.prototype.onPacket=function(g){function n(){f.packet({type:"ack",args:m.util.toArray(arguments),ackId:g.id})}var f=this;switch(g.type){case"connect":this.$emit("connect");break;case"disconnect":""===this.name?this.socket.onDisconnect(g.reason||"booted"):this.$emit("disconnect",g.reason||"");break;case"message":case"json":var S=["message",g.data];"data"==g.ack?S.push(n):g.ack&&this.packet({type:"ack",ackId:g.id}),this.$emit.apply(this,S);break;case"event":S=[g.name].concat(g.args),"data"==g.ack&&S.push(n),this.$emit.apply(this,S);break;case"ack":this.acks[g.ackId]&&(this.acks[g.ackId].apply(this,g.args),delete this.acks[g.ackId]);break;case"error":g.advice?this.socket.onError(g):"unauthorized"==g.reason?this.$emit("connect_failed",g.reason):this.$emit("error",g.reason)}},o.prototype.send=function(){this.namespace.flags[this.name]=!0,this.namespace.send.apply(this.namespace,arguments)},o.prototype.emit=function(){this.namespace.flags[this.name]=!0,this.namespace.emit.apply(this.namespace,arguments)}}(void 0!==S?S:f.exports,void 0!==S?S:f.parent.exports),function(g,m,f){function o(g){m.Transport.apply(this,arguments)}function i(){}g.websocket=o,m.util.inherit(o,m.Transport),o.prototype.name="websocket",o.prototype.open=function(g){var S,v=m.util.query(this.socket.options.query),C=this;return this.connectErrorCallback=g,S||(S=f.MozWebSocket||f.WebSocket),this.websocket=new S(this.prepareUrl(v)),this.websocket.onopen=function(){C.onOpen(),C.socket.setBuffer(!1)},this.websocket.onmessage=function(g){C.onData(g.data)},this.websocket.onclose=function(){C.onClose(),C.socket.setBuffer(!0)},this.websocket.onerror=function(g){C.onError(g)},this},o.prototype.send=function(g){return this.websocket.send(g),this},o.prototype.payload=function(g){for(var m=0,f=g.length;m<f;m++)this.packet(g[m]);return this},o.prototype.close=function(){return this.websocket.close(),this},o.prototype.onError=function(g){void 0!==this.connectErrorCallback&&(this.connectErrorCallback(),this.connectErrorCallback=void 0),this.socket.onError(g)},o.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"},o.check=function(){return"WebSocket"in f&&!("__addTask"in WebSocket)||"MozWebSocket"in f},o.xdomainCheck=function(){return!0},o.prototype.clearEventHandlers=function(){return this.websocket&&(this.websocket.onopen=this.websocket.onmessage=this.websocket.onclose=this.websocket.onerror=i),this},m.transports.push("websocket")}(void 0!==S?S.Transport:f.exports,void 0!==S?S:f.parent.exports,void 0===g?window:g),function(g,m,f){function o(g){g&&(m.Transport.apply(this,arguments),this.sendBuffer=[])}function i(){}g.XHR=o,m.util.inherit(o,m.Transport),o.prototype.open=function(){return this.socket.setBuffer(!1),this.onOpen(),this.get(),this.setCloseTimeout(),this},o.prototype.payload=function(g){for(var f=[],S=0,v=g.length;S<v;S++)f.push(m.parser.encodePacket(g[S]));this.send(m.parser.encodePayload(f))},o.prototype.send=function(g){return this.post(g),this},o.prototype.post=function(g){function e(){4==this.readyState&&(this.onreadystatechange=i,m.posting=!1,200==this.status?(m.socket.setBuffer(!1),clearTimeout(m.sendXHR.ackTimeoutTimer)):m.onClose())}function o(){this.onload=i,m.socket.setBuffer(!1)}var m=this;this.socket.setBuffer(!0),this.sendXHR=this.request("POST"),f.XDomainRequest&&this.sendXHR instanceof XDomainRequest?this.sendXHR.onload=this.sendXHR.onerror=o:this.sendXHR.onreadystatechange=e,this.sendXHR.send(g),m.sendXHR.ackTimeoutTimer=setTimeout((function(){m.onClose()}),m.socket.options.ackTimeoutMs)},o.prototype.close=function(){return this.onClose(),this},o.prototype.request=function(g){var f=m.util.request(this.socket.isXDomain()),S=m.util.query(this.socket.options.query,"t="+ +new Date);f.open(g||"GET",this.prepareUrl(S),!0);var v=this.socket.options.requestHeaders;if(void 0!==v&&Object.keys(v).forEach((function(g){f.setRequestHeader(g,v[g])})),"POST"==g)try{f.setRequestHeader?f.setRequestHeader("Content-type","text/plain;charset=UTF-8"):f.contentType="text/plain"}catch(g){}return f},o.prototype.scheme=function(){return this.socket.options.secure?"https":"http"},o.check=function(g,S){try{var v=m.util.request(S),C=f.XDomainRequest&&v instanceof XDomainRequest,_=(g&&g.options&&g.options.secure?"https:":"http:")!=f.location.protocol;if(v&&(!C||!_))return!0}catch(g){}return!1},o.xdomainCheck=function(){return o.check(null,!0)},o.prototype.clearEventHandlers=function(){return this.sendXHR&&(this.sendXHR.onreadystatechange=this.sendXHR.onload=i),this}}(void 0!==S?S.Transport:f.exports,void 0!==S?S:f.parent.exports,void 0===g?window:g),function(g,m,f){function o(){m.Transport.XHR.apply(this,arguments)}function i(){}g["xhr-polling"]=o,m.util.inherit(o,m.Transport.XHR),m.util.merge(o,m.Transport.XHR),o.prototype.name="xhr-polling",o.prototype.open=function(g){var f=this;return f.connectErrorCallback=g,m.Transport.XHR.prototype.open.call(f),!1},o.prototype.get=function(){function t(){4==this.readyState&&(this.onreadystatechange=i,200==this.status?(g.connectErrorCallback=void 0,g.onData(this.responseText),g.get()):(g.onClose(),void 0!==g.connectErrorCallback&&(g.connectErrorCallback(),g.connectErrorCallback=void 0)))}function e(){g.connectErrorCallback=void 0,this.onload=i,this.onerror=i,g.onData(this.responseText),g.get()}function o(){g.onClose(),void 0!==g.connectErrorCallback&&(g.connectErrorCallback(),g.connectErrorCallback=void 0)}if(this.isOpened){var g=this;this.xhr=this.request(),f.XDomainRequest&&this.xhr instanceof XDomainRequest?(this.xhr.onload=e,this.xhr.onerror=o):this.xhr.onreadystatechange=t,this.xhr.send(null)}},o.prototype.onClose=function(){if(m.Transport.XHR.prototype.onClose.call(this),this.xhr){this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i;try{this.xhr.abort()}catch(g){}this.xhr=null}},o.prototype.ready=function(g,f){var S=this;m.util.defer((function(){f.call(S)}))},o.prototype.clearEventHandlers=function(){return m.Transport.XHR.prototype.clearEventHandlers.call(this),this.xhr&&(this.xhr.onreadystatechange=this.xhr.onload=this.xhr.onerror=i),this},m.transports.push("xhr-polling")}(void 0!==S?S.Transport:f.exports,void 0!==S?S:f.parent.exports,void 0===g?window:g),m.io=S}).call(m,f(13),f(14)(g))},function(g,m){var f;f=function(){return this}();try{f=f||Function("return this")()||(0,eval)("this")}catch(g){"object"==typeof window&&(f=window)}g.exports=f},function(g,m){g.exports=function(g){return g.webpackPolyfill||(g.deprecate=function(){},g.paths=[],g.children||(g.children=[]),Object.defineProperty(g,"loaded",{enumerable:!0,get:function(){return g.l}}),Object.defineProperty(g,"id",{enumerable:!0,get:function(){return g.i}}),g.webpackPolyfill=1),g}},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.ConnectionTracker=m.Properties=m.TrackerStep=m.ClientEventName=m.ResponseData=void 0;var S,v=f(3),C=f(1),_=f(0),E=function(){function t(g){this.id=g,this.status=200,this.headers={},this.body=""}return t}();m.ResponseData=E,function(g){g.Connected="trouter_js_client_connected",g.Disconnected="trouter_js_client_disconnected",g.Error="trouter_js_client_error",g.Progress="trouter_js_client_progress",g.Response="trouter_js_client_response",g.Request="trouter_js_client_request",g.CheckConnection="trouter_js_client_check_connection",g.Registration="trouter_js_client_registration",g.Unregistration="trouter_js_client_unregistration"}(S=m.ClientEventName||(m.ClientEventName={}));var T=function(){function t(g,m,f,S,v){this.stepName=g,this.operation=m,this.delta=f,this.ts=S,this.error=v}return t}();m.TrackerStep=T;var I=function(){function t(){}return t}();m.Properties=I;var b=function(){function t(){this.numberOfPingReplies=0,this.connectedTimestamp=0,this.isNewUrl=!1,this.transportType="",this.connectionNumber=0}return t}(),A=function(){function t(){this.enabled=!1,this.numberOfStepsToMaintain=40,this.logHealthCheckError=!1,this.sendProgressTimeoutSecs=55,this.logSendPingError=!1,this.maxBackoffInMs=12e4,this.trouter_js_client_connected=!1,this.trouter_js_client_disconnected=!1,this.trouter_js_client_error=!1,this.trouter_js_client_progress=!1,this.trouter_js_client_response=!1,this.trouter_js_client_request=!1,this.trouter_js_client_registration=!1,this.trouter_js_client_unregistration=!1,this.trouter_js_client_check_connection=!0}return t}(),P=function(){function t(g,m,f,S,C,E,T){this.clientId=m,this.clientInfo=f,this.getServerState=S,this.endpointId=C,this.clientCorrelationID=E,this.environment=T,this.logger=new _.Logger("ConnectionTracker",g),this.clientCorrelationID=void 0!==E?E:"",this.steps=[],this.connectionAttempt=0,this.totalStepCount=0,this.beginTimestamp=new v.Timespan,this.eventLogSettings=new A,this.connectedInfo=new b}return t.prototype.enable=function(g){this.eventLogSettings.enabled=!0,this.eventLogger=g},t.prototype.disable=function(){this.eventLogSettings.enabled=!1},t.prototype.sendProgress=function(g){this.steps.length>0&&this.sendTelemetry(S.Progress,g,this.steps)},t.prototype.cancelProgressTimer=function(){void 0!==this.progressTimeout&&(clearTimeout(this.progressTimeout),this.progressTimeout=void 0)},t.prototype.resetProgressSendTimer=function(){var g=this;this.cancelProgressTimer(),void 0!==this.eventLogSettings.sendProgressTimeoutSecs&&this.eventLogSettings.sendProgressTimeoutSecs>0&&(this.progressTimeout=setTimeout((function(){g.sendProgress({reason:"timeout",timeoutSecs:g.eventLogSettings.sendProgressTimeoutSecs})}),1e3*this.eventLogSettings.sendProgressTimeoutSecs))},t.prototype.setConnectedInfo=function(g,m){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=Date.now(),this.connectedInfo.isNewUrl=g,this.connectedInfo.transportType=m,++this.connectedInfo.connectionNumber},t.prototype.clearConnectedInfo=function(){this.connectedInfo.numberOfPingReplies=0,this.connectedInfo.connectedTimestamp=0,this.connectedInfo.isNewUrl=!0,this.connectedInfo.transportType=""},t.prototype.copyProperties=function(g,m){for(var f=0,S=Object.keys(m);f<S.length;f++){var v=S[f];void 0!==m[v]&&(g[v.replace(/-/g,"_")]={value:m[v]})}},t.prototype.increasePingResponseCount=function(){++this.connectedInfo.numberOfPingReplies},t.prototype.sendTelemetry=function(g,m,f){try{if(!0===this.eventLogSettings.enabled&&!0===this.eventLogSettings[g]&&void 0!==this.eventLogger){var S=this.getServerState(),_={name:g,properties:{connectionAttempt:{value:this.connectionAttempt},epid:{value:this.endpointId},clientCorrelationID:{value:this.clientCorrelationID},steps:{value:(0,v.toJson)(f)},clientID:{value:this.clientId},eventVersion:{value:3},environment:{value:this.environment},cv:{value:C.CLIENT_VERSION},ua:{value:this.clientInfo.ua},connectionId:{value:S.connectionId},connectedClientId:{value:S.connectedClientId},domId:{value:S.domId},url:{value:S.unsecureUrl},surl:{value:S.url},ttlInSecs:{value:S.getRemainingTtlInSec()},numberOfPingReplies:{value:this.connectedInfo.numberOfPingReplies},connectedTimestamp:{value:this.connectedInfo.connectedTimestamp},isNewUrl:{value:this.connectedInfo.isNewUrl},transportType:{value:this.connectedInfo.transportType},connectionNumber:{value:this.connectedInfo.connectionNumber}}};this.copyProperties(_.properties,m),this.eventLogger.logEvent(_)}}catch(m){this.logger.warn("error in sending event "+g+": "+(0,v.toJson)(m))}},t.prototype.createStep=function(g,m,f){return new T(g,m,this.beginTimestamp.duration,Date.now(),f)},t.prototype.addStep=function(g,m,f){if(!1!==this.eventLogSettings.enabled&&(0===this.steps.length&&this.beginTimestamp.reset(),this.steps.push(this.createStep(g,m,f)),++this.totalStepCount,void 0!==this.eventLogSettings.numberOfStepsToMaintain&&this.steps.length>this.eventLogSettings.numberOfStepsToMaintain)){var v=this.steps.slice(0);this.steps.length=0,this.sendTelemetry(S.Progress,{reason:"flush"},v)}},t.prototype.trackStart=function(g){this.addStep(g,"start")},t.prototype.trackEnd=function(g){this.addStep(g,"end")},t.prototype.trackError=function(g,m,f,v){void 0===f&&(f=!0),"health"===g&&!0!==this.eventLogSettings.logHealthCheckError||"ping"===g&&!1===this.eventLogSettings.logSendPingError||(void 0===v&&(v="error"),!0===f&&this.addStep(g,v,m),this.sendTelemetry(S.Error,{},[this.createStep(g,v,m)]))},t.prototype.trackProgress=function(g,m){this.addStep(g,m)},t.prototype.trackConnected=function(g,m){this.setConnectedInfo(g,m);var f=this.steps.slice(0),v=this.totalStepCount,C=this.beginTimestamp.duration;this.steps.length=0,this.totalStepCount=0,this.sendTelemetry(S.Connected,{stepCount:f.length,totalStepCount:v,connectionEstablishmentMs_Total:C},f),this.cancelProgressTimer()},t.prototype.getSessionLength=function(){return Date.now()-this.connectedInfo.connectedTimestamp},t.prototype.trackDisconnected=function(g){g.sessionLengthMS=this.getSessionLength(),this.sendTelemetry(S.Disconnected,g,[]),this.resetProgressSendTimer()},t.prototype.trackNewConnection=function(){++this.connectionAttempt},t.prototype.trackRequest=function(g,m){var f={};void 0!==m&&(f.hasError=!0,f.error=m);try{if(g){f.requestID=g.id,f.httpMethod=g.method,f.url=g.url,f.bodyLength=g.body.length,f.shortUrl=g.shortUrl,f.requestTimeStamp=g.startTS,f.correlationVector=g.correlationVector;for(var C=g.headers,_=0,E=Object.keys(C);_<E.length;_++){var T=E[_];f[T]=C[T]}}}catch(g){f.hasError=!0,f.error=f.error+" error creating request context "+(0,v.toJson)(g)}this.sendTelemetry(S.Request,f,[])},t.prototype.trackResponse=function(g,m,f,C){var _={};void 0!==C&&(_.hasError=!0,_.error=C);try{if(_.responseTimestamp=void 0!==f?f.sentTS:Date.now(),g){_.requestID=g.id,_.httpMethod=g.method,_.shortUrl=g.shortUrl,_.correlationVector=g.correlationVector;for(var E=g.headers,T=0,I=Object.keys(E);T<I.length;T++){var b=I[T];_[b]=E[b]}}f&&(_.latencyMS=m,_.responseCode=f.status,_.responseLength=f.body.length)}catch(g){_.hasError=!0,_.error=_.error+" error creating response context "+(0,v.toJson)(g)}this.sendTelemetry(S.Response,_,[])},t.prototype.sendResponseError=function(g,m,f){this.trackResponse(m,void 0,f,g)},t.prototype.close=function(){this.sendProgress({reason:"closed"}),this.steps.length=0,this.cancelProgressTimer()},t.prototype.mergeSettings=function(g){if(g){this.eventLogSettings.numberOfStepsToMaintain=Math.min(40,Math.max(10,void 0!==g.numberOfStepsToMaintain?g.numberOfStepsToMaintain:0));var m=Math.min(3600,Math.max(55,void 0!==g.sendProgressTimeoutSecs?g.sendProgressTimeoutSecs:0));this.eventLogSettings.logHealthCheckError=g.logHealthCheckError,this.eventLogSettings.logSendPingError=g.logSendPingError;for(var f=0,v=Object.keys(S).map((function(g){return S[g]}));f<v.length;f++){var C=v[f];void 0!==g[C]&&(this.eventLogSettings[C]=g[C])}this.eventLogSettings.sendProgressTimeoutSecs!==m&&(this.eventLogSettings.sendProgressTimeoutSecs=m,this.resetProgressSendTimer())}},t}();m.ConnectionTracker=P},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.DisconnectReason=void 0;var S=function(){function t(g,m,f){this.reason=g,this.claims=m,this.details=f}return t.fromRawReason=function(g,m){if(""===g||"dup"===g)return new t(g);try{var f=JSON.parse(g);return"object"!=typeof f||void 0===f.reason?(null==m||m.error("invalid disconnect reason format"),new t("unknown",void 0,g)):new t(f.reason,f.claims,f.details)}catch(m){return new t("disconnect",void 0,g)}},t.fromSocketIoEventData=function(g,m){return"string"==typeof m?new t(g,void 0,m):void 0},t.prototype.toTelemetryString=function(){return"socketerror"===this.reason||"reconnecterror"===this.reason||"disconnect"===this.reason?this.details:this.reason},t}();m.DisconnectReason=S},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.ExponentialBackoff=void 0;var S=function(){function t(g,m){this.logger=g,this.maxBackoffInMs=m,this.backoffId=0,this.backoffCount=0}return t.calculateNextBackoffMs=function(g,m){var f=1+.4*(Math.random()-.5),S=1e3*Math.pow(2,g)*f;return S=Math.round(S),Math.min(m,S)},t.prototype.setMaxBackoffMs=function(g){this.maxBackoffInMs=g},t.prototype.backoff=function(g,m){var f=this;void 0!==this.timerHandle&&(this.logger.debug("Clearing current back off"),clearTimeout(this.timerHandle),this.timerHandle=void 0);var S=t.calculateNextBackoffMs(this.backoffCount,this.maxBackoffInMs);this.backoffId++,this.backoffCount++,this.logger.info("Backing off "+g+" for "+S+" milliseconds with ID "+this.backoffId),this.callback=function(){f.logger.info("Back off for "+g+" with ID "+f.backoffId+" complete, invoking handler"),f.timerHandle=void 0,f.callback=void 0,m()},this.timerHandle=setTimeout(this.callback,S)},t.prototype.reset=function(){void 0!==this.timerHandle&&(this.logger.debug("Resetting back off with ID "+this.backoffId),clearTimeout(this.timerHandle),this.timerHandle=void 0,this.callback=void 0),this.backoffCount=0},t.prototype.expediteIfPending=function(){if(this.backoffCount=0,void 0!==this.timerHandle){this.logger.debug("Expediting back off with ID "+this.backoffId),clearTimeout(this.timerHandle),this.timerHandle=void 0;var g=this.callback;this.callback=void 0,g&&g()}},t}();m.ExponentialBackoff=S},function(g,m,f){Object.defineProperty(m,"__esModule",{value:!0}),m.TrouterManagerFsm=void 0;var S=f(2),v=f(4),C=f(0),_=f(6),E=function(){function t(g,m){this.worker=m,this.state=v.TrouterManagerState.Unknown,this.logger=new C.Logger("ManagerFsm",g)}return t.prototype.start=function(){this.state===v.TrouterManagerState.Unknown?(this.setState(v.TrouterManagerState.Disconnected),this.worker.forceStopLingeringConnection(),this.worker.startFirstConnection()):this.showIgnored("start")},t.prototype.stop=function(g){this.state!==v.TrouterManagerState.Unknown?(this.setState(v.TrouterManagerState.Unknown),this.worker.stopFirstConnection(!0===g),this.worker.stopSecondConnection(!0===g)):this.showIgnored("stop")},t.prototype.getState=function(){switch(this.state){case v.TrouterManagerState.Unknown:case v.TrouterManagerState.Connected:case v.TrouterManagerState.Disconnected:case v.TrouterManagerState.Switching:return this.state;case v.TrouterManagerState.TerminalError:return S.TrouterState.Disconnected}},t.prototype.getInternalState=function(){return this.state},t.prototype.onConnected=function(g){this.state===v.TrouterManagerState.Disconnected&&g?this.worker.doesSecondConnectionExist()?this.setState(v.TrouterManagerState.Switching):(this.setState(v.TrouterManagerState.Connected),this.worker.dispatchConnected()):this.showIgnored("onConnected("+g+")")},t.prototype.onRegistered=function(g){this.state!==v.TrouterManagerState.Disconnected||g?this.state!==v.TrouterManagerState.Switching||g?this.state===v.TrouterManagerState.Disconnected&&g&&(this.setState(v.TrouterManagerState.Connected),this.worker.dispatchConnected()):(this.setState(v.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnectionDelayed(),this.worker.dispatchConnected()):(this.setState(v.TrouterManagerState.Connected),this.worker.switchConnections(),this.worker.stopSecondConnection(!0),this.worker.dispatchConnected()),this.worker.dispatchRegistrationState(!0)},t.prototype.onUnregistered=function(g){g&&this.worker.dispatchRegistrationState(!1)},t.prototype.onReconnecting=function(g){this.state!==v.TrouterManagerState.Connected&&this.state!==v.TrouterManagerState.Switching||!g?this.showIgnored("onReconnecting("+g+")"):(this.setState(v.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected())},t.prototype.onReconnectionRequired=function(g,m,f){this.state===v.TrouterManagerState.Connected&&g?(this.setState(v.TrouterManagerState.Switching),this.worker.startSecondConnection(m)):this.state===v.TrouterManagerState.Disconnected&&g?this.worker.startSecondConnection(m):this.state===v.TrouterManagerState.Switching&&g&&f===_.ReconnectReason.Configuration?(this.logger.debug("onReconnectionRequired: switch requested while already in Switching state"),this.worker.stopSecondConnection(!0),this.worker.startSecondConnection(m)):this.showIgnored("onReconnectionRequired("+g+")")},t.prototype.onDisconnected=function(g){this.state==v.TrouterManagerState.Unknown&&g?this.worker.dispatchDisconnected():this.state==v.TrouterManagerState.Switching&&g?(this.worker.switchConnections(),this.worker.stopSecondConnection(!1),this.setState(v.TrouterManagerState.Disconnected),this.worker.dispatchDisconnected()):this.showIgnored("onDisconnected("+g+")")},t.prototype.onTerminalError=function(g){this.setState(v.TrouterManagerState.TerminalError),this.worker.dispatchTerminalError()},t.prototype.showIgnored=function(g){this.logger.info("Ignoring event '"+g+"' in state '"+v.TrouterManagerState[this.state]+"'")},t.prototype.setState=function(g){this.logger.info("Switching from state '"+v.TrouterManagerState[this.state]+"' to state '"+v.TrouterManagerState[g]+"'"),this.state!==g?this.state=g:this.logger.error("Attempt to switch to the current state '"+v.TrouterManagerState[g]+"'")},t}();m.TrouterManagerFsm=E},function(g,m,f){function o(g,m){if(!m)return g;var f=S(S({},g),{enabled:m.TelemetryEnabled});return void 0!==m.ClientTelemetryEventEnabled&&(f=S(S({},f),m.ClientTelemetryEventEnabled)),f}function i(g,m,f){var v,C,_,E,T,I,b,A,p=function(f){return g.proxyUrlRewrite?(m.info("Using rewritten URL for proxy"),g.proxyUrlRewrite(f)):f};return{clientInfo:{ua:g.trouterSettings.productName,v:g.trouterSettings.version},ioOptions:{ackTimeoutMs:5e3,rewriteUrlForProxy:p},clientCorrelationID:g.trouterSettings.sessionId,environment:g.trouterSettings.environment,telemetrySettings:o(g.telemetryConfig.settings,f),eventLogger:g.telemetryConfig.eventLogger,endpointId:g.trouterSettings.registrationId,trouterUrl:(null==f?void 0:f.TrouterConnectionUrl)||g.trouterSettings.trouterServiceUrl,registration:g.trouterSettings.registrarServiceUrl?{registrarUrl:g.trouterSettings.registrarServiceUrl,registrationId:null!==(v=g.trouterSettings.registrationId)&&void 0!==v?v:"",pnhAppId:null!==(C=g.trouterSettings.pnhAppId)&&void 0!==C?C:"",platform:null!==(_=g.trouterSettings.platform)&&void 0!==_?_:"",pnhTemplateKey:null!==(E=g.trouterSettings.pnhTemplate)&&void 0!==E?E:"",platformUIVersion:null!==(T=g.trouterSettings.platformUIVersion)&&void 0!==T?T:"",productContext:g.trouterSettings.pnhProductContext||void 0,context:null!==(I=g.trouterSettings.pnhContext)&&void 0!==I?I:"",registrarTtlSec:(null!==(b=g.trouterSettings.maxRegistrationTimeInMs)&&void 0!==b?b:0)/1e3}:void 0,timeoutOptions:S({connectionTimeoutMs:g.trouterSettings.trouterConnectTimeoutInMs||3e4,fetchTimeoutMs:1e4,pingTimeoutMs:4e4,pongTimeoutMs:5e3,maxBackoffMs:"TeamsCDL"===g.trouterSettings.productName?3e5:3e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},g.trouterSettings.timeoutOptions),incallTimeoutOptions:S({connectionTimeoutMs:1e4,fetchTimeoutMs:5e3,pingTimeoutMs:5e3,pongTimeoutMs:2e3,maxBackoffMs:"TeamsCDL"===g.trouterSettings.productName?3e5:1e4,requestTimeoutMs:5e3,userActivityResponseTimeoutMs:1e4},g.trouterSettings.incallTimeoutOptions),incallModeTimeoutMs:null!==(A=g.trouterSettings.incallModeTimeoutMs)&&void 0!==A?A:0,lingeringConnectionDelayMs:6e4,userActivitySecondResendDelayMs:g.trouterSettings.userActivitySecondResendDelayMs||1e4,duplicateDisconnectThresholdMs:1e4,connectionCache:g.connectionCache,registrationStateCallback:g.registrationStateCallbackForAcsDoNotUse,rewriteUrlForProxy:p,retryLimitOnTokenFetch:g.trouterSettings.retryLimitOnTokenFetch,toJSON:function(){return S(S({},this),{connectionCache:this.connectionCache?{}:this.connectionCache})}}}function r(g){return new R(g)}function s(){return _.CLIENT_VERSION}function c(g,m){var f=g.indexOf("://");if(f>=0){var S=g.indexOf("/",f+3);if(S>=0)return m+g.substr(S)}return""}function a(g){var m=this;return function(f){return v(m,void 0,void 0,(function(){var m;return C(this,(function(S){switch(S.label){case 0:return m={},[4,g(f.needFresh)];case 1:return[2,(m.token=S.sent(),m.tokenType="skype",m)]}}))}))}}function u(g,m){var f,S=this;return function(_){return v(S,void 0,void 0,(function(){var S,v,E;return C(this,(function(C){switch(C.label){case 0:S=new Date,v=setInterval((function(){var m=Math.round((Date.now()-S.getTime())/6e4);g.warn("Note: Trouter auth token request promise from "+S.toISOString()+" has not been resolved for "+m+" minutes. The client is blocked from operating properly")}),3e5),C.label=1;case 1:return C.trys.push([1,,3,4]),[4,m(_)];case 2:return E=C.sent(),_.needFresh&&E.token===f&&g.error("API violation: Trouter auth token provider got a request with needRefresh=true, but returned the same token as last time anyway. Please fix the host app"),f=E.token,[2,E];case 3:return clearInterval(v),[7];case 4:return[2]}}))}))}}var S=this&&this.__assign||function(){return S=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},S.apply(this,arguments)},v=this&&this.__awaiter||function(g,m,f,S){function i(g){return g instanceof f?g:new f((function(m){m(g)}))}return new(f||(f=Promise))((function(f,v){function s(g){try{a(S.next(g))}catch(g){v(g)}}function c(g){try{a(S.throw(g))}catch(g){v(g)}}function a(g){g.done?f(g.value):i(g.value).then(s,c)}a((S=S.apply(g,m||[])).next())}))},C=this&&this.__generator||function(g,m){function n(g){return function(m){return o([g,m])}}function o(C){if(f)throw new TypeError("Generator is already executing.");for(;_;)try{if(f=1,S&&(v=2&C[0]?S.return:C[0]?S.throw||((v=S.return)&&v.call(S),0):S.next)&&!(v=v.call(S,C[1])).done)return v;switch(S=0,v&&(C=[2&C[0],v.value]),C[0]){case 0:case 1:v=C;break;case 4:return _.label++,{value:C[1],done:!1};case 5:_.label++,S=C[1],C=[0];continue;case 7:C=_.ops.pop(),_.trys.pop();continue;default:if(!(v=(v=_.trys).length>0&&v[v.length-1])&&(6===C[0]||2===C[0])){_=0;continue}if(3===C[0]&&(!v||C[1]>v[0]&&C[1]<v[3])){_.label=C[1];break}if(6===C[0]&&_.label<v[1]){_.label=v[1],v=C;break}if(v&&_.label<v[2]){_.label=v[2],_.ops.push(C);break}v[2]&&_.ops.pop(),_.trys.pop();continue}C=m.call(g,_)}catch(g){C=[6,g],S=0}finally{f=v=0}if(5&C[0])throw C[1];return{value:C[0]?C[1]:void 0,done:!0}}var f,S,v,C,_={label:0,sent:function(){if(1&v[0])throw v[1];return v[1]},trys:[],ops:[]};return C={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(C[Symbol.iterator]=function(){return this}),C};Object.defineProperty(m,"__esModule",{value:!0}),m.replaceTrouterUrlBase=m.getTrouterServiceVersion=m.createTrouterService=m.TrouterService=m.UserActivityState=m.TrouterState=void 0;var _=f(1),E=f(2);Object.defineProperty(m,"TrouterState",{enumerable:!0,get:function(){return E.TrouterState}}),Object.defineProperty(m,"UserActivityState",{enumerable:!0,get:function(){return E.UserActivityState}});var T=f(0),I=f(8),b=f(9),A=f(10),P=f(11),R=function(){function t(g){this.logProvider=g,this.stateChangedListeners=[],this.logger=new T.Logger("Trouter",g),this.trouterUrlPromise=new P.TrouterUrlPromise(g),this.messageHandlers=new I.MessageHandlerRegistry(g),this.listeners={},this.connectionInfo=null,this.logger.info("Created TrouterService version "+_.CLIENT_VERSION)}return t.prototype.start=function(g){var m;if(this.logger.info("Start"),!g.skypeTokenProvider&&!g.authTokenProvider)throw new Error("no token provider has been configured, either skypeTokenProvider or authTokenProvider must be populated");g.skypeTokenProvider&&!g.trouterSettings.disableInternalSkypeTokenCache&&(g.skypeTokenProvider=(0,b.addCacheAsBackupTo)(g.skypeTokenProvider)),this.trouterCfg=g;var f=i(g,this.logger,this.ecsCfg);!1===g.internalEnableV4cProtocol&&(f.forceV4aProtocol=!0);var S=u(this.logger,null!==(m=g.authTokenProvider)&&void 0!==m?m:a(g.skypeTokenProvider));void 0===this.trouterServer&&(this.trouterServer=new A.TrouterManager(this.logProvider,f,S,void 0===g.authTokenProvider,this)),void 0!==this.pendingActivityState&&(this.trouterServer.setUserActivityState(this.pendingActivityState[0],this.pendingActivityState[1]),this.pendingActivityState=void 0),this.trouterServer.start()},t.prototype.stop=function(g){this.logger.info("close connection"),this.trouterUrlPromise.rejectUrl(new Error("TrouterService is stopped")),void 0!==this.trouterServer&&this.trouterServer.stop(g)},t.prototype.setEcsConfig=function(g){return v(this,void 0,void 0,(function(){var m=this;return C(this,(function(f){return[2,new Promise((function(f){if(m.ecsCfg=g.TrouterJScriptClient,m.logger.info("Setting ECS configuration to "+JSON.stringify(m.ecsCfg)),void 0!==m.trouterServer&&void 0!==m.trouterCfg){var S=i(m.trouterCfg,m.logger,m.ecsCfg);m.trouterServer.configure(S)}f()}))]}))}))},t.prototype.checkConnection=function(g){void 0!==this.trouterServer&&this.trouterServer.checkConnection(null!=g&&g)},t.prototype.resendRegistration=function(){return v(this,void 0,void 0,(function(){return C(this,(function(g){if(!this.trouterServer)throw new Error("resendRegistration called too early");return[2,this.trouterServer.resendRegistration()]}))}))},t.prototype.registerListener=function(g,m){return""===m||!m.startsWith("/")||m.includes("?")||m.includes("#")?(this.logger.error("Listener path '"+m+"' is not valid"),!1):this.listeners[m]?(this.logger.error("Another listener is already registered for path '"+m+"'"),!1):(this.listeners[m]=g,this.logger.debug("Listener for path '"+m+"' registered"),this.connectionInfo&&g.onTrouterConnected(this.connectionInfo.baseEndpointUrl+m,this.connectionInfo),!0)},t.prototype.unregisterListener=function(g){for(var m=[],f=0,S=Object.keys(this.listeners);f<S.length;f++){var v=S[f];this.listeners[v]===g&&m.push(v)}if(0===m.length)return!1;for(var C=0,_=m;C<_.length;C++)v=_[C],delete this.listeners[v];return this.logger.debug("Listener for path(s) '"+m.join("', '")+"' unregistered"),!0},t.prototype.onTrouterConnected=function(g,m){this.logger.debug("Trouter is now connected");for(var f=0,S=Object.keys(this.listeners);f<S.length;f++){var v=S[f];try{this.listeners[v].onTrouterConnected(m.baseEndpointUrl+v,m)}catch(g){this.logger.error("Listener '"+v+"' threw an exception from onTrouterConnected(): "+g)}}this.connectionInfo=m,this.trouterUrlPromise.resolveUrl(g),this.notifyStateChanged(E.TrouterState.Connected,{url:g,getRemainingTtlInSec:function(){return m.connectionTtlSec}})},t.prototype.onTrouterDisconnected=function(){this.logger.debug("Trouter is now disconnected"),this.connectionInfo=null;for(var g=0,m=Object.keys(this.listeners);g<m.length;g++){var f=m[g],S=this.listeners[f];if(S.onTrouterDisconnected)try{S.onTrouterDisconnected()}catch(g){this.logger.error("Listener '"+f+"' threw an exception from onTrouterDisconnected(): "+g)}}this.notifyStateChanged(E.TrouterState.Disconnected)},t.prototype.onTrouterRequest=function(g,m){for(var f="",S=0,v=Object.keys(this.listeners);S<v.length;S++){var C=v[S];g.path.startsWith(C)&&C.length>f.length&&(f=C)}if(""===f)this.tryMessageHandlers(g,m)||(m.status=404,m.headers={"Trouter-Responder":"ClientLib"},m.send());else try{this.listeners[f].onTrouterRequest(g,m)}catch(g){this.logger.error("Listener '"+f+"' threw an exception from onTrouterRequest(): "+g),m.status=500,m.headers={"Trouter-Responder":"ClientLib"},m.send()}},t.prototype.onTrouterMessageLoss=function(g){this.logger.info("onTrouterMessageLoss called with tags ["+g+"]");for(var m=!0,f=0,S=Object.keys(this.listeners);f<S.length;f++){var v=S[f],C=this.listeners[v];if(C.onTrouterMessageLoss)try{void 0===(m=C.onTrouterMessageLoss(g)&&m)&&(this.logger.error("Listener '"+v+"' did not return a boolean value from onTrouterMessageLoss()"),m=!1)}catch(g){this.logger.error("Listener '"+v+"' threw an exception from onTrouterMessageLoss(): "+g),m=!1}}return m},t.prototype.onTrouterUserActivityStateAccepted=function(g){this.logger.debug("onTrouterUserActivityStateAccepted cv: "+g);for(var m=0,f=Object.keys(this.listeners);m<f.length;m++){var S=f[m],v=this.listeners[S];if(v.onTrouterUserActivityStateAccepted)try{v.onTrouterUserActivityStateAccepted(g)}catch(g){this.logger.error("Listener '"+S+"' threw an exception from onTrouterUserActivityStateAccepted(): "+g)}}},t.prototype.onAudiencesSetResolved=function(g,m){this.logger.debug("onAudiencesSetResolved cv: "+m);for(var f=0,S=Object.keys(this.listeners);f<S.length;f++){var v=S[f],C=this.listeners[v];if(C.onAudiencesSetResolved)try{C.onAudiencesSetResolved(g,m)}catch(g){this.logger.error("Listener '"+v+"' threw an exception from onAudienceSubscribed(): "+g)}}},t.prototype.setUserActivityState=function(g,m){if(g!==E.UserActivityState.Active&&g!==E.UserActivityState.Inactive)throw new Error("setUserActivityState called with unsupported value "+g);this.logger.info("setUserActivityState called with value "+E.UserActivityState[g]),this.trouterServer&&this.state()!==E.TrouterState.Unknown?this.trouterServer.setUserActivityState(g,m):(this.pendingActivityState=[g,m],this.logger.warn("setUserActivityState called before start() or after stop()"))},t.prototype.setAudienceSubscriptions=function(g,m){if(this.trouterServer&&this.state()!==E.TrouterState.Unknown)return this.trouterServer.setAudienceSubscriptionsAsync(g,15e3,m);throw new Error("audience subscribe called before start() or after stop()")},t.prototype.state=function(){return void 0!==this.trouterServer?this.trouterServer.getState():E.TrouterState.Unknown},t.prototype.isInTerminalState=function(){return void 0!==this.trouterServer&&this.trouterServer.isInTerminalState()},t.prototype.reportStateInfo=function(){return void 0===this.trouterServer?"":this.trouterServer.reportStateInfo()},t.prototype.getServerState=function(){if(void 0!==this.trouterServer)return this.trouterServer.getServerState()},t.prototype.getTrouterUrlAsync=function(){return void 0!==this.trouterServer?this.trouterUrlPromise.getPromise():Promise.reject(new Error("TrouterService has not been started"))},t.prototype.onStateChanged=function(g){if(this.logger.info("onStateChanged called"),void 0===g)this.stateChangedListeners=this.stateChangedListeners.filter((function(g){return void 0===g.wrappedCallback}));else{this.offStateChanged(g);var e=function(m,f){g(m,f?f.url:"")};e.wrappedCallback=g,this.stateChangedListeners.push(e)}},t.prototype.offStateChanged=function(g){this.logger.info("offStateChanged called");var m=this.stateChangedListeners.length;return this.stateChangedListeners=this.stateChangedListeners.filter((function(m){return m.wrappedCallback!==g})),m>this.stateChangedListeners.length},t.prototype.addCallback=function(g){this.logger.info("addListener called"),-1===this.stateChangedListeners.indexOf(g,0)&&void 0!==g&&this.stateChangedListeners.push(g)},t.prototype.removeCallback=function(g){this.logger.info("removeListener called");var m=this.stateChangedListeners.indexOf(g,0);return m>-1&&(this.stateChangedListeners.splice(m,1),!0)},t.prototype.registerMessageHandler=function(g){this.logger.info("registerMessageHandler is called"),this.messageHandlers.register(g)},t.prototype.clearMessageHandlers=function(){this.logger.info("clearMessageHandlers is called"),this.messageHandlers.clear()},t.prototype.notifyStateChanged=function(g,m){var f=this;this.logger.info("notifyStateChanged called, will forward to "+this.stateChangedListeners.length+" listeners"),this.stateChangedListeners.forEach((function(S){try{S(g,m)}catch(g){f.logger.error("Error in callback "+g)}}))},t.prototype.tryMessageHandlers=function(g,m){if(!this.messageHandlers.active())return!1;var f,S=null;try{S=(f=JSON.parse(g.body))&&(f.evt||f.eventId)||null}catch(g){}var v={eventId:S,url:(this.connectionInfo?this.connectionInfo.baseEndpointUrl:"")+g.path,body:f,rawBody:g.body,headers:g.headers},C=this.messageHandlers.handleMessage(v);return!!C.isHandled&&(m.status=C.resultCode,C.responseHeaders&&(m.headers=C.responseHeaders),C.responseBody&&(m.body=C.responseBody),m.send(),!0)},t}();m.TrouterService=R,m.createTrouterService=r,m.getTrouterServiceVersion=s,m.replaceTrouterUrlBase=c},function(m,f){m.exports=g}])},g.exports=f(If)}));class TelemetrySender{constructor(g,m){this.logEvent=g=>{this._logger.debug(g),this._telemetryLogManager.sendEvent({name:g.name,tenant:co,properties:{...g.properties}})},this._logger=g.createChild("TelemetrySender"),this._telemetryLogManager=m}}class Trouter{constructor(g,m,f,S,v){this._ecsProvider=m,this._tokenProvider=f,this._isRegistered=!1,this._registeredChangedListeners=[],this._logger=g.createChild("Trouter"),this._logger.info("init"),this._initialRegistrationCompleteDefer=defer$1(),this._telemetryLogManager=S,this._acsProxy=v}async start(g){let m;if(this._trouterService)throw this._logger.error("Trouterservice already initialized"),new CallingCommunicationError(z.CALL_STACK.SIGNALING_SERVICE_ALREADY_INITIALIZED);{const f=new Promise((async(m,f)=>{try{if(this._logger.info("Trouterservice start"),this._trouterService=bf.createTrouterService(this._logger),!this._trouterService)throw this._logger.error("Failed to create trouter service"),new CallingCommunicationError(z.CALL_STACK.SIGNALING_SERVICE_CREATE_FAIL);this._options=this._getTrouterConfig(this._logger,this._tokenProvider),g&&(this._options.trouterSettings.environment=g.environment||"",this._options.trouterSettings.sessionId=g.sessionId);let f,S,v=+new Date;this._trouterService.start(this._options),this._trouterService.onStateChanged(((g,m)=>{g===bf.TrouterState.Connected&&(f=+new Date)})),await this._initialRegistrationCompleteDefer.promise;const C=+new Date;f=f??+new Date,S=f,m({trouterRequestCompletionTimeDeltaMs:Math.max(0,f-v),registrarRequestCompletionTimeDeltaMs:Math.max(0,C-S)})}catch(g){f(g)}}));try{const g=wait((()=>f),Da);m=await g}catch(g){throw 408===g.code?(this._logger.error("Signaling init timeout"),new CallingCommunicationError(z.CALL_STACK.SIGNALING_SERVICE_CREATE_TIMEOUT(Da))):(this._logger.error("Signaling init failed"),new CallingCommunicationError(z.CALL_STACK.SIGNALING_INIT_FAIL))}}return m}isRegistered(){return this._isRegistered}onRegisteredChanged(g){this._logger.info("TrouterService onRegisteredChanged"),this._registeredChangedListeners.push(g)}offRegisteredChanged(g){const m=this._registeredChangedListeners.indexOf(g);this._logger.info(`TrouterService offRegisteredChanged: ${m}`),m>-1&&this._registeredChangedListeners.splice(m,1)}stop(g){this._logger.info("Trouterservice stop"),this._trouterService?(this._trouterService.onStateChanged(void 0),this._trouterService.stop(g),this._trouterService=void 0):this._logger.error("Trouterservice not inited")}registerMessageHandler(g){this._logger.info("Trouterservice registerMessageHandler"),this._trouterService&&this._trouterService.registerMessageHandler(g)}clearMessageHandlers(){this._trouterService&&this._trouterService.clearMessageHandlers()}checkConnection(){this._trouterService&&this._trouterService.checkConnection()}state(){return this._logger.info("Trouterservice state"),this._trouterService?this._trouterService.state():bf.TrouterState.Unknown}onStateChanged(g){this._logger.info("Trouterservice onStateChanged"),this._trouterService&&this._trouterService.onStateChanged(g)}offStateChanged(g){this._logger.info("Trouterservice offStateChanged"),this._trouterService&&this._trouterService.offStateChanged(g)}getTrouterUrlAsync(){return this._trouterService?(this._logger.info("getTrouterUrlAsync called"),this._trouterService.getTrouterUrlAsync()):Promise.reject("Trouterservice not started yet")}_getSettings(){return{registrationId:generateGuid(),registrarServiceUrl:this._ecsProvider.getTrouterSettings().registrarServiceUrl,registrarTtlInSeconds:this._ecsProvider.getTrouterSettings().registrarTtlInSeconds,maxRegistrationTimeInMs:this._ecsProvider.getTrouterSettings().maxRegistrationTimeInMs,registrarRefreshTimeoutInMs:this._ecsProvider.getTrouterSettings().registrarRefreshTimeoutInMs,pnhAppId:this._ecsProvider.getTrouterSettings().pnhAppId,pnhTemplate:this._ecsProvider.getTrouterSettings().pnhTemplate,platform:this._ecsProvider.getTrouterSettings().platform,platformUIVersion:this._ecsProvider.getTrouterSettings().version,trouterServiceUrl:this._ecsProvider.getTrouterSettings().trouterServiceUrl,version:this._ecsProvider.getTrouterSettings().version,trouterConnectTimeoutInMs:this._ecsProvider.getTrouterSettings().trouterConnectTimeoutInMs,productName:this._ecsProvider.getTrouterSettings().productName,sessionId:generateGuid(),environment:this._ecsProvider.getTrouterSettings().environment,timeoutOptions:this._ecsProvider.getTrouterSettings().timeoutOptions}}_createTrouterTelemetryConfig(g){return{eventLogger:new TelemetrySender(g.createChild("TrouterTelemetry"),this._telemetryLogManager),settings:{enabled:this._ecsProvider.getTrouterTelemetryConfig().enabled,logHealthCheckError:this._ecsProvider.getTrouterTelemetryConfig().logHealthCheckError,trouter_js_client_connected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_connected,trouter_js_client_disconnected:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_disconnected,trouter_js_client_error:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_error,trouter_js_client_progress:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_progress,trouter_js_client_response:this._ecsProvider.getTrouterTelemetryConfig().trouter_js_client_response,numberOfStepsToMaintain:this._ecsProvider.getTrouterTelemetryConfig().numberOfStepsToMaintain,sendProgressTimeoutSecs:this._ecsProvider.getTrouterTelemetryConfig().sendProgressTimeoutSecs}}}_getTrouterConfig(g,m){return{trouterSettings:this._getSettings(),proxyUrlRewrite:this._acsProxy.hasProxyUrl()?g=>this._acsProxy.proxyfyUrl(g):void 0,skypeTokenProvider:m,telemetryConfig:this._createTrouterTelemetryConfig(g),registrationStateCallbackForAcsDoNotUse:g=>{this._logger.info(`TrouterService registrationStateCallbackForAcs: ${g}`),this._isRegistered=g,this._initialRegistrationCompleteDefer.isPending()&&this._isRegistered?this._initialRegistrationCompleteDefer.resolve():this._isRegistered?this._logger.info("Signaling service is currently registered"):this._logger.error("Signaling service is currently not registered. Unable to receive incoming calls"),this._onRegisteredChanged(g)}}}_onRegisteredChanged(g){this._logger.info(`TrouterService onRegisteredChanged: ${g}`),this._registeredChangedListeners.forEach((m=>{m(g)}))}}class TelemetryService{constructor(g){this._eventToTenantId={skypecosi_concore_web_csa_conversation_httprequest:ao,skypecosi_concore_web_ts_calling_in_call_session:ao,skypecosi_concore_web_ts_calling_call_setup_session:ao,skypecosi_concore_native_ts_calling_in_call_session:ao,skypecosi_concore_native_ts_calling_call_setup_session:ao,skypecosi_concore_web_pluginless_call_session:ao,skypecosi_concore_web_pluginless_modality_session:ao,skypecosi_concore_web_csa_conversation_callmodality:ao,skypecosi_concore_web_ts_calling_registry:ao,mdsc_webrtc_session:oo,mdsc_webrtc_session_initial:oo,live_events:lo,mdsc_ortc_reports:oo,mdsc_ortc_reports_initial:oo,mdsc_rt_log:oo},this.getTenant=g=>this._eventToTenantId[g]?this._eventToTenantId[g]:"",this.getCallingAdapter=()=>({sendEvent:(g,m)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g),name:g,properties:m})}}),this.getGenericTelemetryLogger=g=>({sendEvent:g=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g.eventName),name:g.eventName,properties:g.props})}}),this.getMediaAdapter=()=>({sendEvent:(g,m)=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g),name:g,properties:m})}}),this.sendEvents=g=>(g.forEach((g=>{this._telemetryLogManager.sendEvent({tenant:this.getTenant(g.eventName),name:g.eventName,properties:g.props})})),Promise.resolve()),this._telemetryLogManager=g}}class EcsConfigObj{constructor(g,m,f,S,v,C=!0,_,E,T,I){this.configType=g,this.caConfigBag=m,this.queryParameters=f,this.ecsConfigReceiver=S,this.platformId=v,this.isAppInitiallyInForeground=C,this.userRawSkypeToken=_,this.userSkypeTokenExpiration=E,this.projectName=T,this.ecsHosts=I}}class WebCVProvider{constructor(){this._timedVideoEffectProviderPromise=timedDefer(W),this._timedModelConfigPromise=timedDefer(W)}get videoEffectProviderDeferredPromise(){return this._timedVideoEffectProviderPromise.deferredPromise}get modelConfigDeferredPromise(){return this._timedModelConfigPromise.deferredPromise}async getVideoEffectProvider(){return this._timedVideoEffectProviderPromise.timerStart(),this._timedVideoEffectProviderPromise.deferredPromise.promise}async getModelConfig(){return this._timedModelConfigPromise.deferredPromise.resolve({modelUrl:"",weightPathPrefix:""}),this._timedModelConfigPromise.deferredPromise.promise}}class EncodedStreamsWorkerProvider{constructor(g){this._encodedStreamsJsPath=g}async getWorkerUrl(){return this._encodedStreamsJsPath}}class HttpRequestDispatcher{constructor(g,m){this.logger=g,this.proxy=m}getRequestOptions(g,m,f,S,v){return{headers:m||{},timeout:S,payload:f||null,responseType:v}}getAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"GET")}postAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"POST")}putAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"PUT")}removeAsync(g,m){return this.sendRequest(this.proxy.proxyfyUrl(g),m,"DELETE")}async sendRequest(g,m={headers:{}},f){const S=this.logger.createChild(`[${m.causeId||generateGuid()}][Request]`);S.info(`sending, ${f}-${g}`);const v=Date.now();let C;m.headers=m.headers||{},m.headers["content-type"]||(m.headers["content-type"]=m.contentType||"application/json");try{const _=mf.request({url:g,method:f,headers:m.headers||{},timeout:"number"==typeof m.timeout?m.timeout:45e3,data:m.payload||"",responseType:m.responseType||m.dataType||"json",withCredentials:valueOrDefault(m.withCredentials,!1),cancelToken:new mf.CancelToken((g=>{C=g}))});isPromiseLike(m.timeout)&&m.timeout.then((()=>{S.info("Aborting pending request"),C()}),(()=>{S.info("Timeout promise rejected, ignoring")}));const E=await _;return S.info(`success, status=${E.status}`),{response:E.data,request:E.request,duration:Date.now()-v}}catch(g){if(S.info("failed"),mf.isCancel(g))throw S.info(`response=${safeJsonStringify(g.response)}`),{aborted:!0};throw g.response?S.info(`response=${safeJsonStringify(g.response)}`):g.request?S.info(`no response, request=${safeJsonStringify(g.request)}`):S.info(`request not made, error=${safeJsonStringify(g)}`),g||new Error("Request failed")}}}class VideoEffectsStatusManager{constructor(){this._activeEffects=[],this.eventEmitter=new bu.EventEmitter}on(g,m){if("statusChanged"!==g)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("statusChanged"!==g)throw new CallingCommunicationError(z.FEATURES.VIDEO_EFFECTS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}getActiveEffects(){return this._activeEffects}setActiveEffects(g){const m=this._activeEffects;this._activeEffects=g,this.eventEmitter.emit("statusChanged",m,this._activeEffects)}}!function(g){g[g.Default=0]="Default",g[g.User=1]="User"}(Tf||(Tf={}));class AudioEffectsStatusManager{constructor(){this._activeEffects={echoCancellation:[],noiseSuppression:[],autoGainControl:[]},this.eventEmitter=new bu.EventEmitter}on(g,m){if("statusChanged"!==g)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.EVENT_SUBSCRIBE(g));this.eventEmitter.on(g,m)}off(g,m){if("statusChanged"!==g)throw new CallingCommunicationError(z.FEATURES.AUDIO_EFFECTS.EVENT_UNSUBSCRIBE(g));this.eventEmitter.off(g,m)}getActiveEffects(){return this._activeEffects}setActiveEffects(g,m){const f={...this._activeEffects};this._activeEffects={...g},this.eventEmitter.emit("statusChanged",f,this._activeEffects,m)}}class WasmVqeProvider{get providerValue(){return this._providerValue}set providerValue(g){this._providerValue=g}async getAudioEffectProvider(){return this.providerValue}}var Af=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function AllowBackgroundFetchData(){this._isAllowed=!1}return AllowBackgroundFetchData.prototype.putBackgroundFetchAllowed=function(g){if(this._isAllowed=g,this.isBackgroundFetchAllowed()&&this._isAllowedDeferral){var m=this._isAllowedDeferral;this._isAllowedDeferral=void 0,m.resolve(void 0)}},AllowBackgroundFetchData.prototype.isBackgroundFetchAllowed=function(){return this._isAllowed},AllowBackgroundFetchData.prototype.waitForBackgroundFetchAllowed=function(){return this.isBackgroundFetchAllowed()?T.Resolved():(this._isAllowedDeferral||(this._isAllowedDeferral=T.Defer()),this._isAllowedDeferral.promise())},AllowBackgroundFetchData}();m.default=f})),Pf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function AppActiveData(){this._isActive=!1}return AppActiveData.prototype.putAppActive=function(g){if(this._isActive=g,this.isAppActive()&&this._appActiveDeferral){var m=this._appActiveDeferral;this._appActiveDeferral=void 0,m.resolve(void 0)}},AppActiveData.prototype.isAppActive=function(){return this._isActive},AppActiveData.prototype.waitForAppActive=function(){return this.isAppActive()?T.Resolved():(this._appActiveDeferral||(this._appActiveDeferral=T.Defer()),this._appActiveDeferral.promise())},AppActiveData}();m.default=f})),Rf=function(){function SubscriptionToken(g,m){this._event=g,this._callback=m}return SubscriptionToken.prototype.unsubscribe=function(){this._event.unsubscribe(this._callback)},SubscriptionToken}(),wf=function(){function SubscribableEvent(g){void 0===g&&(g=!1);var m=this;this._allowStopPropagation=g,this.fire=function(){for(var g=[],f=0;f<arguments.length;f++)g[f]=arguments[f];for(var S=m._subscribers,v=S.length-1;v>=0;v--){var C=S[v].apply(null,g);if(m._allowStopPropagation&&C)return!0}return!1},this._subscribers=[]}return SubscribableEvent.prototype.dispose=function(){this._subscribers=[]},SubscribableEvent.prototype.subscribe=function(g){return this._subscribers=this._subscribers.concat(g),new Rf(this,g)},SubscribableEvent.prototype.unsubscribe=function(g){this._subscribers=this._subscribers.filter((function(m){return m!==g}))},SubscribableEvent}(),Mf=Object.freeze({__proto__:null,SubscriptionToken:Rf,default:wf}),Df=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.Default=0]="Default",g[g.User=1]="User"}(m.EcsConfigType||(m.EcsConfigType={}))})),Of=getAugmentedNamespace(Mf),Nf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function Cache(g){this._config=g,this.configUpdated=new Of.default,this._cachedConfigs={}}return Cache.prototype.initialize=function(){return this.updateConfigsToFetch()},Cache.prototype.updateConfigsToFetch=function(){var g=this,m=this._config.getConfig(),f=m.databaseInterface,S=m.configsToFetch;if(!f)return T.Resolved();for(var v=[],_loop_1=function(m){if(C._cachedConfigs[m])return"continue";v.push(f.getData(m).then((function(f){f&&(g._cachedConfigs[m]=f)})).catch((function(){return T.Resolved()})))},C=this,_=0,E=S;_<E.length;_++){_loop_1(E[_])}return T.all(v).then((function(){v.length>0&&g.configUpdated.fire()}))},Cache.prototype.getEcsConfig=function(){return this._cachedConfigs[Df.EcsConfigType.User]||this._cachedConfigs[Df.EcsConfigType.Default]},Cache.prototype.getEcsConfigByType=function(g){return this._cachedConfigs[g]},Cache.prototype.putConfig=function(g){var m=this.getEcsConfig();this._cachedConfigs[g.configType]=g;var f=this.getEcsConfig();(f&&f.configType===g.configType||m&&f&&m.configType!==f.configType)&&this.configUpdated.fire();var S=this._config.getConfig().databaseInterface;return S?S.putData(g.configType,g):T.Resolved()},Cache}();m.default=f})),kf=createCommonjsModule((function(g,m){var f=C&&C.__assign||function(){return f=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},f.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function Config(){}return Config.prototype.initialize=function(g){if(this._config)throw"ECS Configuration already initialized";this._config=g},Config.prototype.getConfig=function(){if(!this._config)throw"ECS Configuration not yet initialized";return this._config},Config.prototype.setConfigsToFetch=function(g){if(!this._config)throw"ECS Configuration not yet initialized";this._config=f({},this._config,{configsToFetch:g})},Config.prototype.setFetchTimeout=function(g){if(!this._config)throw"ECS Configuration not yet initialized";this._config=f({},this._config,{fetchTimeout:g})},Config}();m.default=S})),Lf=createCommonjsModule((function(g,m){var f=C&&C.__assign||function(){return f=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},f.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0}),m.assert=function(g,m){if(!g)throw new Error(m)},m.isObject=function(g){return null!==g&&"object"==typeof g},m.isString=function(g){return"string"==typeof g},m.attempt=function(g){for(var m=[],f=1;f<arguments.length;f++)m[f-1]=arguments[f];try{return g.apply(void 0,m)}catch(g){return new Error(g)}},m.remove=function(g,m){for(var f=g.length-1;f>=0;f--)g[f]===m&&g.splice(f,1)},m.clone=function(g){return Array.isArray(g)?g.map(m.clone):m.isObject(g)?Object.keys(g).reduce((function(S,v){var C;return f(f({},S),((C={})[v]=m.clone(g[v]),C))}),{}):g}})),Ff=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.DEFAULT_TIME_GROW_FACTOR=2.718281828459045,m.DEFAULT_TIME_JITTER=.11962656472;var f=function(){function ExponentialTime(g,f,S,v){void 0===S&&(S=m.DEFAULT_TIME_GROW_FACTOR),void 0===v&&(v=m.DEFAULT_TIME_JITTER),this._initialTime=g,this._maxTime=f,this._growFactor=S,this._jitterFactor=v,Lf.assert(this._initialTime>0,"Initial delay must be positive"),Lf.assert(this._maxTime>0,"Delay upper bound must be positive"),Lf.assert(this._growFactor>=0,"Ratio must be non-negative"),Lf.assert(this._jitterFactor>=0,"Jitter factor must be non-negative"),this.reset()}return ExponentialTime.prototype.reset=function(){this._incrementCount=0,this._currentTime=Math.round(this._initialTime*(1+Math.random()*this._jitterFactor))},ExponentialTime.prototype.getTime=function(){return this._currentTime},ExponentialTime.prototype.getIncrementCount=function(){return this._incrementCount},ExponentialTime.prototype.calculateNext=function(){var g=this._currentTime*this._growFactor;return g>this._maxTime&&(g=this._maxTime),this._jitterFactor<1e-5?this._currentTime=g:this._currentTime=Math.round(Math.random()*g*this._jitterFactor+g),this._currentTime<this._initialTime&&(this._currentTime=this._initialTime),this._currentTime>this._maxTime&&(this._currentTime=this._maxTime),this._incrementCount++,this._currentTime},ExponentialTime.prototype.getTimeAndCalculateNext=function(){var g=this.getTime();return this.calculateNext(),g},ExponentialTime}();m.ExponentialTime=f})),xf=createCommonjsModule((function(g,m){var f,S,v,_=C&&C.__extends||(f=function(g,m){return f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},f(g,m)},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}),E=C&&C.__assign||function(){return E=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},E.apply(this,arguments)};function isJsonContentType(g){return!!g&&0===g.indexOf("application/json")}function isFormContentType(g){return!!g&&0===g.indexOf("application/x-www-form-urlencoded")}function isFormDataContentType(g){return!!g&&0===g.indexOf("multipart/form-data")}function DefaultErrorHandler(g,m){return m.canceled||!m.statusCode||m.statusCode>=400&&m.statusCode<600?v.DoNotRetry:v.RetryCountedWithBackoff}Object.defineProperty(m,"__esModule",{value:!0}),function(g){g[g.DontCare=0]="DontCare",g[g.Low=1]="Low",g[g.Normal=2]="Normal",g[g.High=3]="High",g[g.Critical=4]="Critical"}(S=m.WebRequestPriority||(m.WebRequestPriority={})),function(g){g[g.DoNotRetry=0]="DoNotRetry",g[g.RetryUncountedImmediately=1]="RetryUncountedImmediately",g[g.RetryUncountedWithBackoff=2]="RetryUncountedWithBackoff",g[g.RetryCountedWithBackoff=3]="RetryCountedWithBackoff",g[g.PauseUntilResumed=4]="PauseUntilResumed"}(v=m.ErrorHandlingType||(m.ErrorHandlingType={})),m.DefaultOptions={priority:S.Normal},m.SimpleWebRequestOptions={MaxSimultaneousRequests:5,HungRequestCleanupIntervalMs:1e4,setTimeout:function(g,m){return setTimeout(g,m)},clearTimeout:function(g){return clearTimeout(g)}},m.DefaultErrorHandler=DefaultErrorHandler;var I,b=[],A=[],P=[],R=0,w=0,M=function(){function SimpleWebRequestBase(g,f,S,v,C){this._action=g,this._url=f,this.options=S,this._getHeaders=v,this._blockRequestUntil=C,this._aborted=!1,this._timedOut=!1,this._paused=!1,this._created=Date.now(),this._finishHandled=!1,this._retryExponentialTime=new Ff.ExponentialTime(1e3,3e5),this._options=E(E({},m.DefaultOptions),S)}return SimpleWebRequestBase.prototype.getPriority=function(){return this._options.priority||S.DontCare},SimpleWebRequestBase.checkQueueProcessing=function(){for(var _loop_1=function(){var g=b.shift();A.push(g),(g._blockRequestUntil&&g._blockRequestUntil()||T.Resolved()).finally((function(){Lf.remove(A,g)})).then((function(){P.length<m.SimpleWebRequestOptions.MaxSimultaneousRequests&&!g._aborted?(P.push(g),D._scheduleHungRequestCleanupIfNeeded(),g._fire()):g._enqueue()}),(function(m){g._respond("_blockRequestUntil rejected: "+m)}))};b.length>0&&P.length<m.SimpleWebRequestOptions.MaxSimultaneousRequests;)_loop_1()},SimpleWebRequestBase._scheduleHungRequestCleanupIfNeeded=function(){P.length>0&&void 0===I?I=m.SimpleWebRequestOptions.setTimeout(this._hungRequestCleanupTimerCallback,m.SimpleWebRequestOptions.HungRequestCleanupIntervalMs):0===P.length&&I&&(m.SimpleWebRequestOptions.clearTimeout(I),I=void 0)},SimpleWebRequestBase.prototype._removeFromQueue=function(){Lf.remove(P,this),Lf.remove(b,this)},SimpleWebRequestBase.prototype._assertAndClean=function(g,m){g||(this._removeFromQueue(),console.error(m),Lf.assert(g,m))},SimpleWebRequestBase.prototype._fire=function(){var g=this;this._xhr=new XMLHttpRequest,this._xhrRequestHeaders={};var f=Lf.attempt((function(){g._xhr.open(g._action,g._url,!0)}));if(f)this._respond(f.toString());else{if(this._options.timeout){var S=w;3!==S&&(this._assertAndClean(!this._requestTimeoutTimer,"Double-fired requestTimeoutTimer"),this._requestTimeoutTimer=m.SimpleWebRequestOptions.setTimeout((function(){g._requestTimeoutTimer=void 0,g._timedOut=!0,g.abort()}),this._options.timeout)),(3===S||S<=1)&&(this._xhr.timeout=this._options.timeout,this._xhr.ontimeout=function(){w=3,3===S&&(g._timedOut=!0,g._aborted=!0,g._respond("TimedOut"))})}var v=R;3!==v?(0===v&&(R=1),this._xhr.onreadystatechange=function(){g._xhr&&(3!==g._xhr.readyState||!g._options.streamingDownloadProgress||g._aborted?4===g._xhr.readyState&&(0===v&&1===R&&m.SimpleWebRequestOptions.setTimeout((function(){3!==R&&(R=2)}),1e4),g._respond()):g._options.streamingDownloadProgress(g._xhr.responseText))}):this._options.streamingDownloadProgress&&(this._xhr.onreadystatechange=function(){g._xhr&&3===g._xhr.readyState&&g._options.streamingDownloadProgress&&!g._aborted&&g._options.streamingDownloadProgress(g._xhr.responseText)}),2!==v&&(this._xhr.onload=function(){R=3,3===v&&g._respond()},this._xhr.onerror=function(){R=3,3===v&&g._respond()}),this._xhr.onabort=function(){g._aborted=!0,g._respond("Aborted")},this._xhr.upload&&this._options.onProgress&&(this._xhr.upload.onprogress=this._options.onProgress);var C=this._options.acceptType||"json",_=this._options.customResponseType||SimpleWebRequestBase._getResponseType(C),E=Lf.attempt((function(){g._xhr.responseType=_}));if(E&&"json"!==_)throw E;D._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Accept",SimpleWebRequestBase.mapContentType(C)),this._xhr.withCredentials=!!this._options.withCredentials;var T=this.getRequestHeaders(),I={};if(Object.keys(T).forEach((function(m){var f=T[m],S=m.toLowerCase();"content-type"!==S?"accept"!==S?(g._assertAndClean(!I[S],"Setting duplicate header key: "+I[S]+" and "+m),null!=f?(I[S]=!0,D._setRequestHeader(g._xhr,g._xhrRequestHeaders,m,f)):console.warn('Tried to set header "'+m+'" on request with "'+f+'" value, header will be dropped')):g._assertAndClean(!1,"Don't set Accept with options.headers -- use it with the options.acceptType property"):g._assertAndClean(!1,"Don't set Content-Type with options.headers -- use it with the options.contentType property")})),this._options.sendData){var b=SimpleWebRequestBase.mapContentType(this._options.contentType||"json");D._setRequestHeader(this._xhr,this._xhrRequestHeaders,"Content-Type",b);var A=SimpleWebRequestBase.mapBody(this._options.sendData,b);this._xhr.send(A)}else this._xhr.send()}},SimpleWebRequestBase._setRequestHeader=function(g,m,f,S){g.setRequestHeader(f,S),m[f]=S},SimpleWebRequestBase.mapContentType=function(g){return"json"===g?"application/json":"form"===g?"application/x-www-form-urlencoded":g},SimpleWebRequestBase.mapBody=function(g,m){if(isJsonContentType(m)){if(!Lf.isString(g))return JSON.stringify(g)}else if(isFormContentType(m)){if(!Lf.isString(g)&&Lf.isObject(g)){var f=g;return Object.keys(f).map((function(g){return encodeURIComponent(g)+(f[g]?"="+encodeURIComponent(f[g].toString()):"")})).join("&")}}else if(isFormDataContentType(m)){if(Lf.isObject(g)){var S=new FormData,v=g;return Object.keys(v).forEach((function(g){return S.append(g,v[g])})),S}Lf.assert(!1,"contentType multipart/form-data must include an object as sendData")}return g},SimpleWebRequestBase.prototype.setUrl=function(g){this._url=g},SimpleWebRequestBase.prototype.setHeader=function(g,m){this._options.augmentHeaders||(this._options.augmentHeaders={}),m?this._options.augmentHeaders[g]=m:delete this._options.augmentHeaders[g]},SimpleWebRequestBase.prototype.getRequestHeaders=function(){var g={};return!this._getHeaders||this._options.overrideGetHeaders||this._options.headers||(g=E(E({},g),this._getHeaders())),this._options.overrideGetHeaders&&(g=E(E({},g),this._options.overrideGetHeaders)),this._options.headers&&(g=E(E({},g),this._options.headers)),this._options.augmentHeaders&&(g=E(E({},g),this._options.augmentHeaders)),g},SimpleWebRequestBase.prototype.getOptions=function(){return Lf.clone(this._options)},SimpleWebRequestBase.prototype.setPriority=function(g){this._options.priority!==g&&(this._options.priority=g,this._paused||this._xhr||(Lf.remove(b,this),this._enqueue()))},SimpleWebRequestBase.prototype.resumeRetrying=function(){this._paused?(this._paused=!1,this._enqueue()):Lf.assert(!1,"resumeRetrying() called but not paused!")},SimpleWebRequestBase.prototype._enqueue=function(){var g=this;if(!this._aborted&&!(P.indexOf(this)>=0||A.indexOf(this)>=0||b.indexOf(this)>=0)){var m=b.findIndex((function(m){return m.getPriority()===g.getPriority()&&m._created>g._created||m.getPriority()<g.getPriority()}));m>-1?b.splice(m,0,this):b.push(this),SimpleWebRequestBase.checkQueueProcessing()}},SimpleWebRequestBase._getResponseType=function(g){return"blob"===g?"arraybuffer":"text/xml"===g||"application/xml"===g?"document":"text/plain"===g?"text":"json"},SimpleWebRequestBase._hungRequestCleanupTimerCallback=function(){I=void 0,P.filter((function(g){return!(!g._xhr||4!==g._xhr.readyState)&&(console.warn("SimpleWebRequests found a completed XHR that hasn't invoked it's callback functions, manually responding"),!0)})).forEach((function(g){g._respond()})),D._scheduleHungRequestCleanupIfNeeded()},SimpleWebRequestBase}();m.SimpleWebRequestBase=M;var D=function(g){function SimpleWebRequest(m,f,S,v,C){return g.call(this,m,f,S,v,C)||this}return _(SimpleWebRequest,g),SimpleWebRequest.prototype.abort=function(){this._aborted?Lf.assert(!1,"Already aborted "+this._action+" request to "+this._url):(this._aborted=!0,this._retryTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._deferred?(this._respond("Aborted"),this._xhr&&this._xhr.abort()):Lf.assert(!1,"Haven't even fired start() yet -- can't abort"))},SimpleWebRequest.prototype.start=function(){var g=this;return this._deferred?(Lf.assert(!1,"WebRequest already started"),T.Rejected("WebRequest already started")):(this._deferred=T.Defer(),this._deferred.onCancel((function(){g.abort()})),this._enqueue(),this._deferred.promise())},SimpleWebRequest.prototype._respond=function(g){var f=this;if(!this._finishHandled){this._finishHandled=!0,this._removeFromQueue(),this._retryTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._retryTimer),this._retryTimer=void 0),this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0);var S,C=0;if(this._xhr)try{C=this._xhr.status,S=this._xhr.statusText||g}catch(g){}else S=g||"Browser Error - Possible CORS or Connectivity Issue";var _,E,T={};if(this._xhr){if((this._xhr.getAllResponseHeaders()||"").split(/\r?\n/).forEach((function(g){if(0!==g.length){var m=g.indexOf(":");-1===m?T[g]="":T[g.substr(0,m).toLowerCase()]=g.substr(m+1).trim()}})),!T["content-type"]){var I=this._xhr.getResponseHeader("content-type");I&&(T["content-type"]=I)}if(_=this._xhr.response,T["content-type"]&&isJsonContentType(T["content-type"])&&(!_||!Lf.isObject(_))&&("text"===this._xhr.responseType||""===this._xhr.responseType)&&this._xhr.responseText)try{_=JSON.parse(this._xhr.responseText)}catch(g){E=g,console.warn("Failed to parse XHR JSON response")}}if(this._xhr&&4===this._xhr.readyState&&(C>=200&&C<300||304===C)){var b={url:this._xhr.responseURL||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:C,statusText:S,headers:T,body:_,responseParsingException:E};this._deferred.resolve(b)}else{var A={url:(this._xhr?this._xhr.responseURL:void 0)||this._url,method:this._action,requestOptions:this._options,requestHeaders:this._xhrRequestHeaders||{},statusCode:C,statusText:S,headers:T,body:_,canceled:this._aborted,timedOut:this._timedOut,responseParsingException:E};this._options.augmentErrorResponse&&this._options.augmentErrorResponse(A);var P=this._options.customErrorHandler?this._options.customErrorHandler(this,A):DefaultErrorHandler(this,A);P!==v.DoNotRetry&&(this._options.retries&&this._options.retries>0||P===v.PauseUntilResumed||P===v.RetryUncountedImmediately||P===v.RetryUncountedWithBackoff)?(P===v.RetryCountedWithBackoff&&this._options.retries--,this._requestTimeoutTimer&&(m.SimpleWebRequestOptions.clearTimeout(this._requestTimeoutTimer),this._requestTimeoutTimer=void 0),this._aborted=!1,this._timedOut=!1,this._finishHandled=!1,this._xhr&&(this._xhr.onabort=null,this._xhr.onerror=null,this._xhr.onload=null,this._xhr.onprogress=null,this._xhr.onreadystatechange=null,this._xhr.ontimeout=null,this._xhr=void 0,this._xhrRequestHeaders=void 0),P===v.PauseUntilResumed?this._paused=!0:P===v.RetryUncountedImmediately?this._enqueue():this._retryTimer=m.SimpleWebRequestOptions.setTimeout((function(){f._retryTimer=void 0,f._enqueue()}),this._retryExponentialTime.getTimeAndCalculateNext())):this._deferred.reject(A)}M.checkQueueProcessing()}},SimpleWebRequest}(M);m.SimpleWebRequest=D})),Uf=createCommonjsModule((function(g,m){var f=C&&C.__assign||function(){return f=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},f.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var S=function(){function GenericRestClient(g){this._defaultOptions={excludeEndpointUrl:!1,withCredentials:!1,retries:0},this._endpointUrl=g}return GenericRestClient.prototype._performApiCall=function(g,m,S,v){var C=this;void 0===v&&(v={});var _=f(f({},this._defaultOptions),v);S&&(_.sendData=S),_.eTag&&(_.augmentHeaders||(_.augmentHeaders={}),_.augmentHeaders["If-None-Match"]=_.eTag),_.contentType||(_.contentType=Lf.isString(_.sendData)?"form":"json");var E=_.excludeEndpointUrl?g:this._endpointUrl+g;return new xf.SimpleWebRequest(m,E,_,(function(){return C._getHeaders(_)}),(function(){return C._blockRequestUntil(_)})).start().then((function(g){return C._processSuccessResponse(g),g}))},GenericRestClient.prototype._getHeaders=function(g){return{}},GenericRestClient.prototype._blockRequestUntil=function(g){},GenericRestClient.prototype._processSuccessResponse=function(g){},GenericRestClient.prototype.performApiGet=function(g,m){return this.performApiGetDetailed(g,m).then((function(g){return g.body}))},GenericRestClient.prototype.performApiGetDetailed=function(g,m){return this._performApiCall(g,"GET",void 0,m)},GenericRestClient.prototype.performApiPost=function(g,m,f){return this.performApiPostDetailed(g,m,f).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPostDetailed=function(g,m,f){return this._performApiCall(g,"POST",m,f)},GenericRestClient.prototype.performApiPatch=function(g,m,f){return this.performApiPatchDetailed(g,m,f).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPatchDetailed=function(g,m,f){return this._performApiCall(g,"PATCH",m,f)},GenericRestClient.prototype.performApiPut=function(g,m,f){return this.performApiPutDetailed(g,m,f).then((function(g){return g.body}))},GenericRestClient.prototype.performApiPutDetailed=function(g,m,f){return this._performApiCall(g,"PUT",m,f)},GenericRestClient.prototype.performApiDelete=function(g,m,f){return this.performApiDeleteDetailed(g,m,f).then((function(g){return g.body}))},GenericRestClient.prototype.performApiDeleteDetailed=function(g,m,f){return this._performApiCall(g,"DELETE",m,f)},GenericRestClient}();m.GenericRestClient=S})),Vf=createCommonjsModule((function(g,m){function __export(g){for(var f in g)m.hasOwnProperty(f)||(m[f]=g[f])}Object.defineProperty(m,"__esModule",{value:!0}),__export(Ff),__export(Uf),__export(xf)})),Bf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function TelemetryEventBase(){}return TelemetryEventBase.prototype.getAttributes=function(){return{Source:"ecs_client"}},TelemetryEventBase}();m.TelemetryEventBase=f})),Hf=createCommonjsModule((function(g,m){var f,S=C&&C.__extends||(f=function(g,m){return f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},f(g,m)},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)});Object.defineProperty(m,"__esModule",{value:!0});var v=function(g){function EcsConfigFetchResponse(m,f,S,v,C,_,E,T,I,b,A,P,R){var w=g.call(this)||this;return w._responseTime=m,w._responseCode=f,w._fetchAttempts=S,w._hasValidToken=v,w._serverEndpoint=C,w._etag=_,w._fetchDurationValid=E,w._cacheAvailable=T,w._responseSize=I,w._configAge=b,w._configExpired=A,w._fetchStart=P,w._fetchEnd=R,w}return S(EcsConfigFetchResponse,g),EcsConfigFetchResponse.prototype.getEventName=function(){return"ecs_tsclient_fetch_config"},EcsConfigFetchResponse.prototype.getAttributes=function(){var m=g.prototype.getAttributes.call(this);return m.fetch_delay_ms=this._responseTime,m.fetch_response_code=this._responseCode,m.fetch_attempts=this._fetchAttempts,m.authenticated_user=this._hasValidToken,m.url=this._serverEndpoint,m.fetched_etag=this._etag,m.fetch_duration_valid=this._fetchDurationValid,m.cache_available=this._cacheAvailable,m.response_size=this._responseSize,m.config_age=this._configAge,m.config_expired=this._configExpired,m.fetch_start=this._fetchStart,m.fetch_end=this._fetchEnd,m},EcsConfigFetchResponse}(Bf.TelemetryEventBase);m.EcsConfigFetchResponse=v})),$f=createCommonjsModule((function(g,m){var f,S=C&&C.__extends||(f=function(g,m){return f=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(g,m){g.__proto__=m}||function(g,m){for(var f in m)m.hasOwnProperty(f)&&(g[f]=m[f])},f(g,m)},function(g,m){function __(){this.constructor=g}f(g,m),g.prototype=null===m?Object.create(m):(__.prototype=m.prototype,new __)}),v=C&&C.__assign||function(){return v=Object.assign||function(g){for(var m,f=1,S=arguments.length;f<S;f++)for(var v in m=arguments[f])Object.prototype.hasOwnProperty.call(m,v)&&(g[v]=m[v]);return g},v.apply(this,arguments)};Object.defineProperty(m,"__esModule",{value:!0});var _,E,I=1728e5,b=18e5,A=31536e6,P=3e4,R=function(g){function EcsFetcher(m,f,S,v,C,_,E,T){var I=g.call(this,m)||this;if(I._config=f,I._skypeTokenData=S,I._appActiveData=v,I._allowBackgroundFetchData=C,I._etag=_,I._getUserConfig=E,I._apiPath="/config/v1/"+I._config.getConfig().clientName+"/"+I._config.getConfig().clientVersion,T){var b=Object.keys(T).map((function(g){return encodeURIComponent(g)+"="+encodeURIComponent(T[g].toString())}));b&&(I._apiPath+="?"+b.join("&"))}return I}return S(EcsFetcher,g),EcsFetcher.prototype._blockRequestUntil=function(g){var m=this;if(this._getUserConfig&&!this._skypeTokenData.isSkypeTokenValid()&&console.log("ECS - Delaying User config fetch until we have a valid SkypeToken"),!this._appActiveData.isAppActive()&&!this._allowBackgroundFetchData.isBackgroundFetchAllowed()){var f=this._getUserConfig?"User config":"config";console.log("ECS - Delaying "+f+" fetch until the app is active (or background fetch is allowed)")}return T.race([this._appActiveData.waitForAppActive(),this._allowBackgroundFetchData.waitForBackgroundFetchAllowed()]).then((function(){if(m._getUserConfig)return m._skypeTokenData.waitForValidSkypeToken()})).then((function(){E=Date.now()}))},EcsFetcher.prototype._getHeaders=function(){var g={};return this._etag&&(g["If-None-Match"]=this._etag),this._getUserConfig&&(g.Authorization=this._skypeTokenData.getSkypeToken()),g},EcsFetcher.prototype.getConfig=function(){var m=this._config.getConfig().fetchTimeout;return void 0!==m&&(m<0?m=0:m>0&&m<P&&(m=P)),g.prototype.performApiGetDetailed.call(this,this._apiPath,{timeout:m})},EcsFetcher}(Vf.GenericRestClient),w=function(){function EcsClient(g,m,f,S,v){this._config=g,this._skypeTokenData=m,this._appActiveData=f,this._allowBackgroundFetchData=S,this._telemetryManager=v,this._ecsFailureBackoffTimer=new Vf.ExponentialTime(1e3,3e5),this._cacheMaxAgeRegex=/.*max-age=(\d+).*/gi,this._serverIndex=NaN}return EcsClient.prototype.getConfig=function(g,m,f){var S=this,C=this._config.getConfig().hosts;if((isNaN(this._serverIndex)||this._serverIndex>C.length-1)&&(this._serverIndex=Math.floor(Math.random()*C.length)),!C||!C.length)return T.Rejected(new Error("no configuration service endpoint"));var I=T.Defer(),b=0,callConfigServer=function(){var P=g&&g.eTag?g.eTag:void 0,w=new R(C[S._serverIndex],S._config,S._skypeTokenData,S._appActiveData,S._allowBackgroundFetchData,P,m,f);b++,w.getConfig().then((function(f){var R=f.headers.etag,w=f.headers.expires;if(f.body&&f.body.Headers&&(R||(R=f.body.Headers.ETag),w||(w=f.body.Headers.Expires)),_=Date.now(),!R||!w)return console.warn("ECS - Service returned an empty ETag or Expiration header: "+JSON.stringify(f)),T.Rejected();var M,D=new Date(S._calculateExpirationDate(f.headers)).getTime();if(304===f.statusCode&&g)(M=v({},g)).eTag=R,M.expiration=D,M.cacheUpdateTime=_,M.lastFetchTokenHash=S._skypeTokenData.getSkypeTokenHash(f.requestHeaders.Authorization);else{if("object"!=typeof f.body)return console.warn("ECS - Service returned invalid response "+JSON.stringify(f)),T.Rejected();M={config:f.body,configType:m?Df.EcsConfigType.User:Df.EcsConfigType.Default,eTag:R,expiration:D,cacheUpdateTime:E,lastFetchTokenHash:S._skypeTokenData.getSkypeTokenHash(f.requestHeaders.Authorization),appVersion:S._config.getConfig().clientVersion}}var O=_-E,N=!(O<0||O>A),k=g?Date.now()-g.cacheUpdateTime:0;S._telemetryManager.sendTelemetryEvent(new Hf.EcsConfigFetchResponse(O,f.statusCode,b,S._skypeTokenData.isSkypeTokenValid(),C[S._serverIndex],R,N,!!P,JSON.stringify(f).length,k,!(g&&g.expiration-Date.now()>0),E,_)),S._ecsFailureBackoffTimer.reset(),I.resolve(M)})).catch((function(){S._serverIndex=(S._serverIndex+1)%C.length,setTimeout((function(){callConfigServer()}),S._ecsFailureBackoffTimer.getTimeAndCalculateNext())}))};return callConfigServer(),I.promise()},EcsClient.prototype._calculateExpirationDate=function(g){var m=Date.now()+I;if(g.date&&g.expires){var f=new Date(g.date).getTime(),S=Date.now()-f,v=new Date(g.expires).getTime();return isNaN(v)?m:Math.min(m,v+S)}var C=this._cacheMaxAgeRegex.exec(g["cache-control"]);return this._cacheMaxAgeRegex.lastIndex=0,C&&2===C.length?Math.min(m,Date.now()+1e3*Number(C[1])):Date.now()+b},EcsClient}();m.default=w})),Gf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function Scheduler(g,m,f,S,v,C){var _=this;this._config=g,this._skypeTokenData=m,this._cache=f,this._isFetchingSettings={},this._pendingFetch={},this._paused=!1,this._fetchEcsSettingsIfNeeded=function(g){var m=_._config.getConfig(),f=_._cache.getEcsConfigByType(g);if(-1!==m.configsToFetch.indexOf(g)&&!_._isFetchingSettings[g])if(f||!_._pendingFetch[g]){var S=f?f.expiration-Date.now():-1;S<=0||f&&g===Df.EcsConfigType.User&&_._skypeTokenData.isSkypeTokenValid()&&f.lastFetchTokenHash!==_._skypeTokenData.getSkypeTokenHash(_._skypeTokenData.getSkypeToken())?_._fetchSkypeEcsSettings(g):setTimeout((function(){return _._fetchEcsSettingsIfNeeded(g)}),S)}else _._fetchSkypeEcsSettings(g)},this._fetchSkypeEcsSettings=function(g,m){(void 0===m&&(m=!1),_._isFetchingSettings[g]||_._paused&&!m)?_._pendingFetch[g]=!0:(_._pendingFetch[g]=!1,_._isFetchingSettings[g]=!0,_._config.getConfig().getEcsParameters().catch((function(){return console.warn("ECS - Failed to fetch ECS fetching parameters"),{}})).then((function(m){return _._ecsClient.getConfig(_._cache.getEcsConfig(),g===Df.EcsConfigType.User,m)})).then((function(m){console.log("ECS - Config fetch complete"),_._isFetchingSettings[g]=!1,_._cache.putConfig(m),_._fetchEcsSettingsIfNeeded(g)})))},this._ecsClient=new $f.default(this._config,this._skypeTokenData,S,v,C)}return Scheduler.prototype.initialize=function(){var g=this;this.updateConfigsToFetch(),this._skypeTokenData.skypeTokenChanged.subscribe((function(){return g._fetchEcsSettingsIfNeeded(Df.EcsConfigType.User)}))},Scheduler.prototype.updateConfigsToFetch=function(){for(var g=this._config.getConfig(),m=0,f=g.configsToFetch;m<f.length;m++){(C=f[m])in this._isFetchingSettings||(this._isFetchingSettings[C]=!1),C in this._isFetchingSettings||(this._pendingFetch[C]=!1)}for(var S=0,v=g.configsToFetch;S<v.length;S++){var C=v[S],_=this._cache.getEcsConfigByType(C);!_||_.appVersion&&_.appVersion!==g.clientVersion?this._fetchSkypeEcsSettings(C,!0):this._fetchEcsSettingsIfNeeded(C)}},Scheduler.prototype.requestUpdate=function(){for(var g=0,m=this._config.getConfig().configsToFetch;g<m.length;g++){var f=m[g];this._fetchSkypeEcsSettings(f)}},Scheduler.prototype.pause=function(){this._paused=!0},Scheduler.prototype.resume=function(){this._paused=!1;for(var g=0,m=this._config.getConfig().configsToFetch;g<m.length;g++){var f=m[g];this._fetchEcsSettingsIfNeeded(f)}},Scheduler}();m.default=f})),jf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function SkypeTokenData(){this.skypeTokenChanged=new Of.default}return SkypeTokenData.prototype.putSkypeTokenData=function(g){if(this._data=g,this.isSkypeTokenValid()&&this.skypeTokenChanged.fire(),this.isSkypeTokenValid()&&this._validSkypeTokenDeferral){var m=this._validSkypeTokenDeferral;this._validSkypeTokenDeferral=void 0,m.resolve(void 0)}},SkypeTokenData.prototype.isSkypeTokenValid=function(){var g=this._data;return!!g&&!!g.skypeToken&&g.skypeTokenExpiration>Date.now()},SkypeTokenData.prototype.getSkypeToken=function(){var g=this._data;if(!g||!g.skypeToken)throw"No Skype Token provided";return g.skypeToken},SkypeTokenData.prototype.getSkypeTokenHash=function(g){return void 0===g?0:g.split("").reduce((function(g,m){return(101*g+m.charCodeAt(0))%999727999}),g.length)},SkypeTokenData.prototype.waitForValidSkypeToken=function(){return this.isSkypeTokenValid()?T.Resolved():(this._validSkypeTokenDeferral||(this._validSkypeTokenDeferral=T.Defer()),this._validSkypeTokenDeferral.promise())},SkypeTokenData}();m.default=f})),Wf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0});var f=function(){function TelemetryManager(g){this._cache=g,this.telemetryEventAdded=new Of.default}return TelemetryManager.prototype.sendTelemetryEvent=function(g){var m=g.getEventName(),f=g.getAttributes(),S=!1,v=this._cache.getEcsConfig();if(v&&TelemetryManager._containsEcsClientTelemetryConfig(v.config)){var C=v.config.ECSCONFIG;C&&C.ecsClientTelemetry&&(S=!!C.ecsClientTelemetry[m])}S&&this.telemetryEventAdded.fire(m,f)},TelemetryManager._containsEcsClientTelemetryConfig=function(g){return!!g&&!!g.ECSCONFIG&&!!g.ECSCONFIG.ecsClientTelemetry},TelemetryManager}();m.default=f})),qf=createCommonjsModule((function(g,m){Object.defineProperty(m,"__esModule",{value:!0}),m.Models=Df;var f=function(){function EcsClient(){this._allowBackgroundFetchData=new Af.default,this._appActiveData=new Pf.default,this._config=new kf.default,this._cache=new Nf.default(this._config),this._skypeTokenData=new jf.default,this._telemetryManager=new Wf.default(this._cache),this._scheduler=new Gf.default(this._config,this._skypeTokenData,this._cache,this._appActiveData,this._allowBackgroundFetchData,this._telemetryManager),this.telemetryEventAdded=this._telemetryManager.telemetryEventAdded,this.configUpdated=this._cache.configUpdated}return EcsClient.prototype.initialize=function(g){var m=this;return this._config.initialize(g),this._skypeTokenData.putSkypeTokenData(g.initialSkypeTokenData),this._appActiveData.putAppActive(g.initialAppActiveState),this._cache.initialize().then((function(){m._scheduler.initialize()}))},EcsClient.prototype.getConfig=function(){return this._cache.getEcsConfig()},EcsClient.prototype.getConfigType=function(){var g=this._cache.getEcsConfig();if(g)return g.configType},EcsClient.prototype.requestUpdate=function(){this._scheduler.requestUpdate()},EcsClient.prototype.pause=function(){this._scheduler.pause()},EcsClient.prototype.resume=function(){this._scheduler.resume()},EcsClient.prototype.setAllowBackgroundFetch=function(g){this._allowBackgroundFetchData.putBackgroundFetchAllowed(g)},EcsClient.prototype.useSkypeToken=function(g,m){this._skypeTokenData.putSkypeTokenData({skypeToken:g,skypeTokenExpiration:m})},EcsClient.prototype.setAppActive=function(g){this._appActiveData.putAppActive(g)},EcsClient.prototype.setConfigsToFetch=function(g){var m=this;return this._config.setConfigsToFetch(g),this._cache.updateConfigsToFetch().then((function(){m._scheduler.updateConfigsToFetch()}))},EcsClient.prototype.setFetchTimeout=function(g){this._config.setFetchTimeout(g)},EcsClient}();m.default=f})),zf=getDefaultExportFromCjs(qf);class EcsSkypeToken{constructor(g,m){this.skypeToken=g,this.skypeTokenExpiration=m}}class EcsConfigFetcher{constructor(g,m,f){this._logger=g,this._acsProxy=m,this._counter=0,this._resumeCounter=3e3,this._disposed=!1,this._ecsClient=f||new zf,this._isSubscribed=this._initialized=!1}subscribeEcsConfig(g){return g.configType!==Tf.Default&&g.configType!==Tf.User?Promise.reject(sa):(this._resetConfigCache(g),this._initialized||this._isSubscribed?Promise.reject(oa):Promise.resolve(this._initializeEcsConfig(g).then((()=>{this._ecsClient.configUpdated.subscribe((()=>{if(this._isSubscribed=!0,this._config=this._ecsClient.getConfig(),g.ecsConfigReceiver&&this._config){if(g.ecsConfigReceiver(this._config.config)?this._counter=0:this._counter+=1,this._counter>3)try{this._ecsClient.pause(),this._counter=0,this._resumeCounter*=2,window.setTimeout((()=>{this._disposed||this._ecsClient.resume()}),this._resumeCounter)}catch(g){this._logger.warn("Failed to retry fetch ECS")}}}))})).catch((g=>{this._logger.warn("Failed to initialize ECS config because: "+g)}))))}setConfigsToFetch(g){return this._ecsClient.setConfigsToFetch(g)}dispose(){try{this._ecsClient.configUpdated.dispose(),this._disposed=!0}catch(g){this._logger.warn(`Failed to dispose ECS config update, e=${g}`)}}getConfigType(){if(void 0!==this._configDefCache)return this._ecsClient.getConfigType()}getETag(){return void 0===this._config?"":this._config.eTag}getConfigId(g){return void 0===this._config?Promise.reject(aa):Promise.resolve(this._config.config[ra][g])}setAllowBackgroundFetch(g){return this._ecsClient.setAllowBackgroundFetch(g),Promise.resolve()}setSkypeToken(g,m){return this._ecsClient.useSkypeToken(g,m),Promise.resolve()}setAppActiveState(g){return this._ecsClient.setAppActive(g),Promise.resolve()}_resetConfigCache(g){void 0===g||void 0===this._configDefCache||g.queryParameters===this._configDefCache.queryParameters&&g.configType===this._configDefCache.configType||(this._isSubscribed=!1,this._initialized=!1,this._config=void 0),this._configDefCache=g}_initializeEcsConfig(g){this._initialized=!0;const m={hosts:g.ecsHosts?g.ecsHosts:this._getHostUrls(g.caConfigBag),clientName:na,clientVersion:this._getClientVersion(g.platformId),configsToFetch:this._getLibConfigType(g.configType),getEcsParameters:()=>this._getQueryParameterPromise(g.queryParameters),initialAppActiveState:g.isAppInitiallyInForeground,initialSkypeTokenData:new EcsSkypeToken(g.userRawSkypeToken,g.userSkypeTokenExpiration)};return new Promise(((g,f)=>{this._ecsClient.initialize(m).then(g,f)}))}_getHostUrls(g){let m;if(g)if(g.identityType===fa.Enterprise)m=pa.Enterprise_Ecs_ServerUrl;else switch(g.cloudType){case ca.Public:m=pa.Public_EcsServer_Url;break;case ca.Dod:m=pa.Dod_EcsServer_Url;break;case ca.GccHigh:m=pa.GccHigh_EcsServer_Url;break;case ca.AirGap08:m=pa.AirGap08_EcsServer_Url;break;case ca.AirGap09:m=pa.AirGap09_EcsServer_Url;break;default:m=pa.Public_EcsServer_Url}else m=pa.Public_EcsServer_Url;return[this._acsProxy.proxyfyUrl(m)]}_getClientVersion(g){let m="";return m+=g||getPlatformId(),m+="_",m+=getSdkInternalVersion(),m}_getLibConfigType(g){return[g===Tf.Default?qf.Models.EcsConfigType.Default:qf.Models.EcsConfigType.User]}_getQueryParameterPromise(g={}){return T.Resolved(g)}}var Kf,__decorate$o=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$o=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class CallStack{constructor(g,m,f,S,v,C,_){if(this._ECS_FETCH_TYPE_USER="User",this._ECS_FETCH_TYPE_DEFAULT="Default",this._disposed=!1,this._trouterStateChangedListenersRegistered=new Map,this.clientId=m,this.sdkDiagnosticInformation=S,this.logger=g.createChild("CallStack"),this._telemetryLogManager=f,this._acsProxy=v,this._acsCustomRelayManager=C,this._webcvProvider=new WebCVProvider,this._wasmvqeProvider=new WasmVqeProvider,"https:"!==location.protocol&&"file:"!==location.protocol&&"localhost"!==location.hostname)throw new CallingCommunicationError(z.CALL_STACK.BAD_PROTOCOL);this._telemetryService=new TelemetryService(this._telemetryLogManager),this._ecsProvider=new EcsProvider(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new EcsConfigFetcher(this.logger,this._acsProxy),this._videoEffectsStatusManager=new VideoEffectsStatusManager,this._audioEffectsStatusManager=new AudioEffectsStatusManager,void 0!==_&&(this._encodedStreamsWorkerProvider=new EncodedStreamsWorkerProvider(_))}getClientId(){return this.clientId}getTrouterState(){const g=this?._trouterService?.state();return this.mapTsTrouterState(g)}getEcsConfigIds(){return this._ecsProvider.getConfigIds()}isRegistered(){return this._trouterService?.isRegistered()??!1}onRegisteredChanged(g){this._trouterService?.onRegisteredChanged(g)}offRegisteredChanged(g){this._trouterService?.offRegisteredChanged(g)}onTrouterStateChanged(g){const tsTrouterStateChangedListener=(m,f)=>{g(this.mapTsTrouterState(m))};return this._trouterService?.onStateChanged(tsTrouterStateChangedListener),this._trouterStateChangedListenersRegistered.set(g,tsTrouterStateChangedListener),{listener:g,tsTrouterStateChangedListener:tsTrouterStateChangedListener}}offTrouterStateChanged(g){const m=this._trouterStateChangedListenersRegistered.get(g);if(m)return this._trouterService?.offStateChanged(m),this._trouterStateChangedListenersRegistered.delete(g),{listener:g,tsTrouterStateChangedListener:m}}mapTsTrouterState(g){let m="Uninitialized";if(void 0!==g)switch(g){case 0:m="Unknown";break;case 2:m="Connected";break;case 3:m="Disconnected";break;case 9:m="Switching"}return m}get webcvProvider(){return this._webcvProvider}get wasmvqeProvider(){return this._wasmvqeProvider}get videoEffectsStatusManager(){return this._videoEffectsStatusManager}get audioEffectsStatusManager(){return this._audioEffectsStatusManager}async createStackBase(g){if(this._createStackBaseWaitPromise)return this._createStackBaseWaitPromise;const m=new Promise((async(m,f)=>{try{const f=this._getBaseStackConfig();this._tsStack=await w.pluginlessStackFactory.buildBaseStack(f),await this.initializeEcsBase(g),m(this._tsStack)}catch(g){f(g)}}));try{this._createStackBaseWaitPromise=wait((()=>m),wa);const g=await this._createStackBaseWaitPromise;return this.logger.log("Base stack init success"),g}catch(g){throw await this.dispose(),g.code===L?new CallingCommunicationError(z.CALL_STACK.BASE_STACK_INIT_TIMEOUT):new CallingCommunicationError(z.CALL_STACK.BASE_STACK_INIT_FAILED,g)}}async initializeStackForUser(g,m){if(this.caConfigBag=m,this._initializeStackForUserWaitPromise)return this._initializeStackForUserWaitPromise;this._tsStack=await this.createStackBase(m),this._disposed=!1;const f=new Promise((async(f,S)=>{try{this._tsStack?(this._telemetryService=new TelemetryService(this._telemetryLogManager),this._ecsProvider=new EcsProvider(this.logger,this.sdkDiagnosticInformation,this._acsProxy),this._ecsFetcher=new EcsConfigFetcher(this.logger,this._acsProxy),await this.initializeEcsBase(m),await this.initializeEcsForUser(g),DefaultLogger.overrideDefaultLogDump(),getAcsEcsConfig().calling.doNotWaitForTrouter?this._initTrouter(g).catch((()=>{this.logger.warn(z.CALL_STACK.SIGNALING_UNINITIALIZED.message)})):await this._initTrouter(g),this.logger.log("Signaling initialized successfully."),await this._tsStack.initializeMediaAgent({httpRequestDispatcher:this.getRequestDispatcher(),tokenProvider:g,relayManager:this.getCustomRelayManager(),configProvider:{getSkypeConfig:()=>Promise.resolve({}),getRelayConfig:()=>{const g=this._ecsProvider.getMdnTrapSettings();return Promise.resolve(g)}},appStateProvider:this._getAppStateProvider(),clientInformation:this._ecsProvider.getJsCsaConfig().clientInformation}),await this._tsStack.initializeSignalingAgentProvider({signalingAgentConfig:this._getSignalingConfig(g),trouterService:this._trouterService}),await this._tsStack.init(),f(this._tsStack)):(this.logger.error("Base stack failed to create"),S(new CallingCommunicationError(z.CALL_STACK.BASE_STACK_CREATE_FAILED)))}catch(g){S(g)}}));try{this._initializeStackForUserWaitPromise=wait((()=>f),Ma);const g=await this._initializeStackForUserWaitPromise;return this.sendStackInitEvent(!0),this.logger.log("User stack init success"),g}catch(g){if(await this.dispose(),g.code===L)throw this.sendStackInitEvent(!1,"User stack init timeout",g),new CallingCommunicationError(z.CALL_STACK.USER_STACK_INIT_TIMEOUT);if("Uninitialized"===this.getTrouterState())throw new CallingCommunicationError(z.CALL_STACK.SIGNALING_UNINITIALIZED);throw this.sendStackInitEvent(!1,"User stack init failed",g),new CallingCommunicationError(z.CALL_STACK.USER_STACK_INIT_FAILED,g)}}getRequestDispatcher(){return this._acsProxy.hasProxyUrl()?(this.logger.info("Using custom proxy for network requests (non media)"),new HttpRequestDispatcher(this.logger,this._acsProxy)):new w.HttpRequestDispatcherImplementation}async initializeEcsBase(g){const m=defer(),f=this.getEcsQueryParameters(g),S=generateGuid(),v=g?this._ECS_FETCH_TYPE_USER:this._ECS_FETCH_TYPE_DEFAULT,C=new EcsConfigObj(Tf.Default,g,f,(f=>{if(f?.Headers?.CountryCode&&this.updateEmergencyCallCountry(f?.Headers?.CountryCode),m.resolve(),this._ecsFetcher.getConfigType()===Tf.User&&this._ecsSetupCompleteForUser.resolve(),this._ecsFetcher&&this._tsStack&&void 0!==f){let m;const C=+new Date;try{return setAcsEcsConfig(f),this._ecsProvider.setConfig(g,f),setMediaConfig(this._ecsProvider.getJamaSettings()),m=JSON.stringify(f),this._tsStack.getEcsProvider().setEcsConfig({ecsBlob:m,userIdentity:"",etag:this._ecsFetcher.getETag()}),this._ecsProvider.assertConfigs(f),!0}catch(g){const m=+new Date;this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_failure,{deltaTimeInMs:m-C},v,S,this._ecsProvider.getConfigIds(),new CallingCommunicationError(z.CALL_STACK.PARSE_CONFIG,g)),this.logger.error("Unable to parse configuration")}}return!1}),getPlatformId()),_=+new Date;try{await this._ecsFetcher.subscribeEcsConfig(C),this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_attempt,{attemptTimestamp:_},v,S);const g=wait((()=>m.promise),ho);await g;const f=+new Date;this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_success,{deltaTimeInMs:f-_},v,S,this._ecsProvider.getConfigIds())}catch(m){const f=new CallingCommunicationError(z.CALL_STACK.PARSE_CONFIG,m),C=+new Date;this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_failure,{deltaTimeInMs:C-_},v,S,this._ecsProvider.getConfigIds(),f),this.logger.warn("Failed to fetch base settings. Stack will initialize without default settings",m),this._ecsProvider.setConfig(g,void 0)}}async initializeEcsForUser(g){const m=await g();this._ecsSetupCompleteForUser=defer();try{await this._ecsFetcher.setConfigsToFetch([Tf.User]),await this._ecsFetcher.setSkypeToken(m,1e3*parseJWT(m).exp)}catch(g){throw this.logger.error("Unable to set skype token for user ecs config"),new CallingCommunicationError(z.CALL_STACK.SET_STACK_CONFIG)}const f=generateGuid(),S=this.caConfigBag?"User":"Default",v=+new Date;try{this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_attempt,{attemptTimestamp:v},S,f);const g=wait((()=>this._ecsSetupCompleteForUser.promise),ho);await g;const m=+new Date;this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_success,{deltaTimeInMs:m-v},S,f,this._ecsProvider.getConfigIds())}catch(g){const m=+new Date;this.sendEcsSettingsFetchedDataEvent(kh.acs_calling_config_fetched_failure,{deltaTimeInMs:m-v},S,f,this._ecsProvider.getConfigIds(),g),this.logger.warn("Failed to fetch user settings. Stack will initialize without user settings",g)}}async getDeviceManager(){if(!this._createStackBaseWaitPromise)throw new CallingCommunicationError(z.CALL_STACK.GET_DM);return(await this._createStackBaseWaitPromise).getDeviceManager()}async dispose(g){if(!this._disposed){if(this._disposed=!0,this._trouterService)try{this._trouterService.clearMessageHandlers(),this._trouterService.stop(g),this._trouterService=void 0}catch(g){this.logger.error("Failed to dispose signaling")}if(this._tsStack)try{await this._tsStack.dispose(),this._tsStack=void 0}catch(g){this.logger.error("Failed to dispose calling stack")}this._ecsFetcher.dispose(),this._createStackBaseWaitPromise=void 0,this._initializeStackForUserWaitPromise=void 0,this._tsStack=void 0,this.logger.info("Calling stack disposed")}}getEcsQueryParameters(g){const m={};try{m.CLRelease=w.getVersion();const f=getBrowserInfo();m.BrowserName=f.name,m.BrowserEngine=f.engine,m.BrowserVersion=f.version,m.FormFactor=f.formFactor,m.IdentityType=fa.Consumer,m.Cloud=ca.Public,m.OSVer=`${getOS()}-${getOSVersion()}`,g&&(m.Cloud=g.cloudType,m.IdentityType=g.identityType);const S="_TS_BUILC_VERSION_".replace("C","D");m.CLRelease===S?m.CLRelease="9999.99":m.CLRelease.match(/^\d+\.\d+\.\d+\.\d+$/)||delete m.CLRelease}catch(g){throw this.logger.error(g),new CallingCommunicationError(z.CALL_STACK.SET_STACK_PARAMS,g)}return m}sendEcsSettingsFetchedDataEvent(g,m,f,S,v,C){let _,E;C&&(_=C.message,E=extractCommunicationServicesErrorForTelemetry(C)),this._telemetryLogManager.sendEvent({name:g,tenant:so,properties:{...m,ecsFetchType:f,correlationId:S,failureReason:_,ecsConfigIds_AcsCallingSDKWeb:v?.AcsCallingSDKWeb||"",ecsConfigIds_SkypeWebMedia:v?.SkypeWebMedia||"",additionalDetails:{...E}}})}updateEmergencyCallCountry(g){this.caConfigBag&&!this.caConfigBag.emergencyCountryCode&&!this.caConfigBag.IsUserEmergencyCountryCode&&g&&(this.caConfigBag.emergencyCountryCode=g)}async _initTrouter(g){let m=+new Date;try{this._trouterService=new Trouter(this.logger,this._ecsProvider,(m=>g(m)),this._telemetryLogManager,this._acsProxy),m=+new Date;let f=await this._trouterService.start();return void this.sendSignalingInitEvent(!0,+new Date-m,f.trouterRequestCompletionTimeDeltaMs,f.registrarRequestCompletionTimeDeltaMs)}catch(g){throw this.sendSignalingInitEvent(!1,+new Date-m,void 0,void 0,g),g}}_getBaseStackConfig(){const g=this._getMediaProviderConfig(),m={clientInformation:this._ecsProvider.getClientInformation(),logger:this.logger,mediaSettings:g.mediaSettings,platformType:getPlatformName(),callSettings:{useLwjForAllCalls:!1},usePlatformSupportApi:!0,telemetryTenants:{media:"mediaAgent",signaling:"signalingAgent",tlePlayer:Ao},telemetryService:this._telemetryService,webcvProvider:this._webcvProvider,wasmVqeProvider:this._wasmvqeProvider};return void 0!==this._encodedStreamsWorkerProvider&&(m.encodedStreamsWorkerProvider=this._encodedStreamsWorkerProvider),m}_getSignalingConfig(g){const m={...this._ecsProvider.getJsCsaConfig(),httpRequestDispatcher:this.getRequestDispatcher(),telemetryManager:this._telemetryService.getCallingAdapter(),logger:this.logger,skypeToken:()=>g(),trouterServiceProvider:this._trouterService,ecsEtag:this._ecsFetcher.getETag()};return this.caConfigBag?.emergencyCountryCode&&(m.emergencyCallCountry=this.caConfigBag?.emergencyCountryCode),m}_getMediaProviderConfig(){return{logger:this.logger,mediaSettings:this._getMediaAgentConfig()}}_getMediaAgentConfig(){return{...this._ecsProvider.getJamaSettings()}}_getAppStateProvider(){return{isOnline:()=>!0}}sendStackInitEvent(g,m,f){try{let S,v;f&&(S=f.message,v=extractCommunicationServicesErrorForTelemetry(f)),this._telemetryLogManager.sendEvent({name:kh.acs_calling_stack_init,tenant:so,properties:{success:g,reason:m,failureReason:S||"unknown",additionalDetails:{...v}}})}catch(g){}}sendSignalingInitEvent(g,m,f,S,v){try{let C,_;v&&(C=v.message,_=extractCommunicationServicesErrorForTelemetry(v)),this._telemetryLogManager.sendEvent({name:kh.acs_calling_signaling_init,tenant:so,properties:{success:g,failureReason:C||"unknown",timestampInfo:{deltaTimeInMs:m,deltaTimeInMsTrouterRequest:f,deltaTimeInMsRegistrarRequest:S},additionalDetails:{..._}}})}catch(g){}}getCustomRelayManager(){if(this._tsCustomRelayManager=this._acsCustomRelayManager.getTsRelayManager(),this._tsCustomRelayManager&&getAcsEcsConfig().calling.enableCustomTurnUsage)return this.logger.info("Using custom relays for media traffic"),this._acsCustomRelayManager.customRelayManagerInUse=!0,this._tsCustomRelayManager}}__decorate$o([loggerProperty,__metadata$o("design:type",Object)],CallStack.prototype,"logger",void 0),__decorate$o([asyncOperation(Zh.CreateStackBase),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"createStackBase",null),__decorate$o([asyncOperation(Zh.InitializeStackForUser),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Function,Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeStackForUser",null),__decorate$o([asyncOperation(Zh.InitializeEcsBase),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Object]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeEcsBase",null),__decorate$o([asyncOperation(Zh.InitializeEcsForUser),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Function]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"initializeEcsForUser",null),__decorate$o([asyncOperation(Zh.GetDeviceManager),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"getDeviceManager",null),__decorate$o([asyncOperation(Zh.Dispose),__metadata$o("design:type",Function),__metadata$o("design:paramtypes",[Boolean]),__metadata$o("design:returntype",Promise)],CallStack.prototype,"dispose",null);class ObservableSubjects{constructor(){this._eventEmitter=new bu.EventEmitter}notifyAll(g){this._eventEmitter.emit(g)}waitFor(g,m){return new Promise(((f,S)=>{let v=0;const listener=()=>{f(),clearTimeout(v)};this._eventEmitter.once(g,listener),v=window.setTimeout((()=>{this._eventEmitter.off(g,listener),S(new Error("timeout"))}),m)}))}}class DeviceInfoMapper{constructor(){this._deviceIdMapping=new Map,this._deviceId=1,this._keywords=getAcsEcsConfig().telemetry.deviceChangedEvents.piiSafeWords}getDeviceId(g){let m=this._deviceIdMapping.get(g);if(void 0!==m)return m;++this._deviceId;return m=`${g.split(":")[0]??""}:${this._deviceId}`,this._deviceIdMapping.set(g,m),m}scrubDeviceLabel(g){return scrubDeviceLabelPii(g,this._keywords)}}function scrubDeviceLabelPii(g,m){if(!g)return"";if(g.length<3)return g;const f=[],S=g.match(/\(([0-9a-zA-Z]+:[0-9a-zA-Z]+)\)/);S&&f.push(S[1]);try{if(!m?.length)return"no_keywords";{const S=new RegExp(`(${m.join("|")})`,"gi");let v=S.exec(g);for(;v;)f.push(v[1]),v=S.exec(g)}}catch(g){const stringifyError=g=>R.isString(g)?g:g?.message??"";f.push(`Error: ${stringifyError(g)}`)}return 0===f.length?"unknown":f.join(" ")}!function(g){g.deviceSelection="deviceSelection"}(Kf||(Kf={}));var __decorate$p=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$p=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class DeviceManagerImpl{constructor(g,m,f){this._callStack=m,this._videoDevices=[],this._audioDevices=[],this._tsDeviceTypeToAudioDeviceType={2:"Microphone",3:"Speaker",4:"CompositeAudioDevice"},this.logger=g.createChild("DeviceManager"),this._telemetryLogManager=f,this._eventEmitter=new CallingEventEmitter(this.logger),this._browserInfo=getBrowserInfo(),this._safariVideoPermissionState="unknown",this._combinedDevicePermission=new Map,this._deviceInfoMapper=new DeviceInfoMapper,this._deviceSelectionNotifications=new ObservableSubjects}get telemetryLogManager(){return this._telemetryLogManager}getRawDeviceMediaStream(g){const m=generateGuid(),f=+new Date;if(this.sendRawMediaEvent({eventName:kh.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"attempt",mediaType:g,timestampInfo:"",additionalDetails:""}),!this._tsDeviceManager?.getRawDeviceMediaStream){const S=new CallingCommunicationError(z.DEVICE_MANAGER.GET_MEDIA_STREAM_TRACK);this.logger.error("Failed to get raw device stream track");const v=+new Date;throw this.sendRawMediaEvent({eventName:kh.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"failure",mediaType:g,timestampInfo:{deltaTimeInMs:v-f},additionalDetails:{failureReason:S.message||"",code:S.code,subCode:S.subCode,...extractCommunicationServicesErrorForTelemetry(S)}}),S}let S;try{S=this._tsDeviceManager?.getRawDeviceMediaStream(g);const v=+new Date;return this.sendRawMediaEvent({eventName:kh.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"success",mediaType:g,timestampInfo:{deltaTimeInMs:v-f},additionalDetails:""}),S}catch(S){const v=new CallingCommunicationError(z.DEVICE_MANAGER.GET_MEDIA_STREAM_DEVICE_UNAVAILABLE,S);this.logger.error("Failed to get raw device stream track");const C=+new Date;throw this.sendRawMediaEvent({eventName:kh.acs_calling_get_raw_device_media_stream,correlationId:m,kindOfEvent:"failure",mediaType:g,timestampInfo:{deltaTimeInMs:C-f},additionalDetails:{failureReason:v.message||"",code:v.code,subCode:v.subCode,...extractCommunicationServicesErrorForTelemetry(v)}}),v}}getClientId(){return this._callStack.getClientId()}async getDeviceManager(){if(this._tsDeviceManager)return this._tsDeviceManager;const g=+new Date;try{this.sendGetDeviceManagerEvent({eventName:kh.acs_calling_get_device_manager,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),await this._callStack.createStackBase(),this._tsDeviceManager=await this._callStack.getDeviceManager();const m=await this._tsDeviceManager.enumerateDevicesAsync();this.logger.info(`tsDevicesList:${JSON.stringify(m)}`),m.forEach((g=>{if(1===g.kind){const m=g;this._videoDevices.push(new VideoDeviceInfoImpl(m.label,m.id,"UsbCamera",this))}else if(2===g.kind||3===g.kind){const m=g,f=new AudioDeviceInfoImpl(m.label,m.id,m.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[m.kind],this);this._audioDevices.push(f)}}));const f=this._tsDeviceManager.getSelectedDevices();this._selectedMicrophone=this._audioDevices.find((g=>g.id===f.microphone)),this._selectedSpeaker=this._audioDevices.find((g=>g.id===f.speaker)),this._dmDevicesChangedSub=this._tsDeviceManager.on("devicesChanged",(async()=>{try{await this.syncDeviceList(await(this._tsDeviceManager?.enumerateDevicesAsync())),this.checkForSelectedDevicesChanges()}catch(m){this.logger.warn(`Unable to handle devicesChanged, error=${m?.message}, code=${m?.code}`);const f=+new Date;this.sendGetDeviceManagerEvent({eventName:kh.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{failureReason:m?.message,code:m?.code,...extractCommunicationServicesErrorForTelemetry(m),context:"devicesChanged"}})}})),getAcsEcsConfig().calling.devicePermissions.getCurrentState&&(this._audioDevicePermission=permissionStateToBool(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),this._videoDevicePermission=permissionStateToBool(this._tsDeviceManager?.getPermissionState("camera"),this.logger)),this.logger.info("Initial permission state audio:",this._audioDevicePermission,"video:",this._videoDevicePermission),this._dmDevicesPermissionChangedSub=this._tsDeviceManager.on("onPermissionStateChanged",this.permissionsChanged.bind(this));const S=+new Date;this.sendGetDeviceManagerEvent({eventName:kh.acs_calling_get_device_manager,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:S-g},additionalDetails:""})}catch(m){const f=new CallingCommunicationError(z.DEVICE_MANAGER.GET_DM,m);this.logger.error(f.message);const S=+new Date;this.sendGetDeviceManagerEvent({eventName:kh.acs_calling_get_device_manager,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:S-g},additionalDetails:{failureReason:f.message,code:f.code,...extractCommunicationServicesErrorForTelemetry(f)}})}return this._tsDeviceManager}on(g,m){if("videoDevicesUpdated"!==g&&"audioDevicesUpdated"!==g&&"selectedMicrophoneChanged"!==g&&"selectedSpeakerChanged"!==g)throw new CallingCommunicationError(z.DEVICE_MANAGER.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("videoDevicesUpdated"!==g&&"audioDevicesUpdated"!==g&&"selectedMicrophoneChanged"!==g&&"selectedSpeakerChanged"!==g)throw new CallingCommunicationError(z.DEVICE_MANAGER.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}getTsDeviceManager(){if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);return this._tsDeviceManager}getSafariPermissionState(){return"Safari"===this._browserInfo.engine?this._safariVideoPermissionState:"unknown"}getAcsResourceId(){return this._callStack?.caConfigBag?.acsResourceId}getAudioDevicePermission(){return this._audioDevicePermission}getVideoDevicePermission(){return this._videoDevicePermission}get callStackWebCvProvider(){return this._callStack.webcvProvider}get callStackWasmVqeProvider(){return this._callStack.wasmvqeProvider}get callStackVideoEffectsStatusManager(){return this._callStack.videoEffectsStatusManager}get callStackAudioEffectsStatusManager(){return this._callStack.audioEffectsStatusManager}get deviceInfoMapper(){return this._deviceInfoMapper}getEnvironmentInfoInternal(){return this._environmentInfo||(this._environmentInfo=getEnvironmentInfos()),this._environmentInfo}sendRawMediaEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send raw media telemetry")}}sendGetDeviceManagerEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send get_device_manager telemetry")}}permissionsChanged(g,m){const f=this._audioDevicePermission,S=this._videoDevicePermission;let v,C;getAcsEcsConfig().calling.devicePermissions.getCurrentState?(v=permissionStateToBool(this._tsDeviceManager?.getPermissionState("microphone"),this.logger),C=permissionStateToBool(this._tsDeviceManager?.getPermissionState("camera"),this.logger)):(v=f,C=S),this._audioDevicePermission=v||!!g?.audio,this._videoDevicePermission=C||!!g?.video,m&&(m.audio&&(this._audioDevicePermission=g?.audio??!1),m.video&&(this._videoDevicePermission=g?.video??!1)),f===this._audioDevicePermission&&S===this._videoDevicePermission||(this.logger.info(`permission state changed from audio: ${f}, video: ${S}\n                          to audio: ${this._audioDevicePermission}, video: ${this._videoDevicePermission}`),this._telemetryLogManager.sendEvent({name:kh.acs_calling_device_permission_changed,tenant:so,properties:{previousAudioDevicePermission:this.nullHandler(f),previousVideoDevicePermission:this.nullHandler(S),newAudioDevicePermission:this.nullHandler(this._audioDevicePermission),newVideoDevicePermission:this.nullHandler(this._videoDevicePermission)}}))}checkForSelectedDevicesChanges(){if(this.logger.info("checkForSelectedDevicesChanges"),this._tsDeviceManager){const g=this._tsDeviceManager.getSelectedDevices();g.microphone!==this._selectedMicrophone?.id&&(this._selectedMicrophone=this._audioDevices.find((m=>m.id===g.microphone)),this._eventEmitter.emit("selectedMicrophoneChanged"),void 0!==g.microphone&&this._deviceSelectionNotifications.notifyAll(g.microphone)),g.speaker!==this._selectedSpeaker?.id&&(this._selectedSpeaker=this._audioDevices.find((m=>m.id===g.speaker)),this._eventEmitter.emit("selectedSpeakerChanged"),void 0!==g.speaker&&this._deviceSelectionNotifications.notifyAll(g.speaker))}else this.logger.warn("DeviceManager is undefined, Unable to check selected devices")}isACSDeviceEqualToTSDevice(g,m){return g.id===m.id}async syncDeviceList(g){if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);this.logger.info("syncDeviceList"),void 0===g&&(g=await this._tsDeviceManager.enumerateDevicesAsync());const m=[];let f=[];const S=[];let v=[];g.map((g=>{if(1===g.kind){const f=this._videoDevices.find((m=>this.isACSDeviceEqualToTSDevice(m,g)));if(f)f.setName(g.label),f.setId(g.id),f.setDeviceType("UsbCamera");else{const f=new VideoDeviceInfoImpl(g.label,g.id,"UsbCamera",this);m.push(f),this._videoDevices.push(f)}}else if(2===g.kind||3===g.kind){const m=this._audioDevices.find((m=>this.isACSDeviceEqualToTSDevice(m,g)));if(m){const f=g;m.setName(f.label),m.setId(f.id),m.setIsSystemDefault(f.isSystemDefault),m.setDeviceType(this._tsDeviceTypeToAudioDeviceType[f.kind])}else{const m=new AudioDeviceInfoImpl(g.label,g.id,g.isSystemDefault,this._tsDeviceTypeToAudioDeviceType[g.kind],this);S.push(m),this._audioDevices.push(m)}}}));const calculateRemovedDiffs=m=>{const f=m.filter((m=>!g.find((g=>this.isACSDeviceEqualToTSDevice(m,g)))));return f.map((g=>{m.splice(m.indexOf(g),1)})),f};f=calculateRemovedDiffs(this._videoDevices),v=calculateRemovedDiffs(this._audioDevices),(m.length>0||f.length>0)&&this._eventEmitter.emit("videoDevicesUpdated",{added:m,removed:f}),(S.length>0||v.length>0)&&this._eventEmitter.emit("audioDevicesUpdated",{added:S,removed:v})}get isSpeakerSelectionAvailable(){if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);return this._tsDeviceManager.isAudioOutputSelectionSupported}get selectedMicrophone(){return this._selectedMicrophone}get selectedSpeaker(){return this._selectedSpeaker}async getCameras(){return await this.syncDeviceList(),this._videoDevices}async getMicrophones(){return await this.syncDeviceList(),this._audioDevices.filter((g=>"Microphone"===g.deviceType))}async getSpeakers(){if(this.isSpeakerSelectionAvailable)return await this.syncDeviceList(),this._audioDevices.filter((g=>"Speaker"===g.deviceType));throw new CallingCommunicationError(z.DEVICE_MANAGER.SPEAKER_ENUMERATION_UNSUPPORTED)}async selectMicrophone(g){if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);if(!g||!g.id)throw new CallingCommunicationError(z.DEVICE_MANAGER.INVALID_DEVICE);if("microphone:"===g.id)throw new CallingCommunicationError(z.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE);if(this.logger.info("selectMicrophone called"),this._selectedMicrophone?.id!==g.id){const m=getAcsEcsConfig().calling.deviceSelectionTimeoutInMs,f=this._deviceSelectionNotifications.waitFor(g.id,m),S="Microphone",v=this._deviceInfoMapper.getDeviceId(g.id),C=this._deviceInfoMapper.scrubDeviceLabel(g.name),_=generateGuid(),sendEvent=(g,m,f)=>{this.sendDeviceSelectionEvent({eventName:kh.acs_calling_client_operations,operation:Kf.deviceSelection,kindOfEvent:g,correlationId:_,timestampInfo:void 0!==m?{deltaTimeInMs:m}:{},additionalDetails:void 0!==f?{failureReason:f.message,code:f.code,...extractCommunicationServicesErrorForTelemetry(f)}:"",deviceSelection:{deviceId:v,deviceName:C,deviceType:S}})};sendEvent("attempt");const E=Date.now();try{this._tsDeviceManager.selectDevices({microphone:g.id}),await f.catch((m=>{if(this._selectedMicrophone?.id!==g.id)throw m})),sendEvent("success",Date.now()-E)}catch(g){let m;throw m="timeout"===g?.message?new CallingCommunicationError(z.DEVICE_MANAGER.SELECT_MICROPHONE_TIMEOUT):new CallingCommunicationError(z.DEVICE_MANAGER.SELECT_MICROPHONE_FAIL,g),sendEvent("failure",Date.now()-E,m),m}}else this.logger.warn("microphoneDevice is already active")}async selectSpeaker(g){const m=this.logger.createFnLogger(eu.SelectSpeaker);if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);if(!this.isSpeakerSelectionAvailable)throw new CallingCommunicationError(z.DEVICE_MANAGER.SPEAKER_SELECTION_UNSUPPORTED);if(!g||!g.id)throw new CallingCommunicationError(z.DEVICE_MANAGER.INVALID_DEVICE);if("speaker:"===g.id)throw new CallingCommunicationError(z.DEVICE_MANAGER.DEVICE_NOT_SELECTABLE);if(m.info("selectSpeaker called"),this._selectedSpeaker?.id!==g.id){const m=getAcsEcsConfig().calling.deviceSelectionTimeoutInMs,f=this._deviceSelectionNotifications.waitFor(g.id,m),S="Speaker",v=this._deviceInfoMapper.getDeviceId(g.id),C=this._deviceInfoMapper.scrubDeviceLabel(g.name),_=generateGuid(),sendEvent=(g,m,f)=>{this.sendDeviceSelectionEvent({eventName:kh.acs_calling_client_operations,operation:Kf.deviceSelection,kindOfEvent:g,correlationId:_,timestampInfo:void 0!==m?{deltaTimeInMs:m}:{},additionalDetails:void 0!==f?{failureReason:f.message,code:f.code,...extractCommunicationServicesErrorForTelemetry(f)}:"",deviceSelection:{deviceId:v,deviceName:C,deviceType:S}})};sendEvent("attempt");const E=Date.now();try{this._tsDeviceManager.selectDevices({speaker:g.id}),await f.catch((m=>{if(this._selectedSpeaker?.id!==g.id)throw m})),sendEvent("success",Date.now()-E)}catch(g){let m;throw m="timeout"===g?.message?new CallingCommunicationError(z.DEVICE_MANAGER.SELECT_SPEAKER_TIMEOUT):new CallingCommunicationError(z.DEVICE_MANAGER.SELECT_SPEAKER_FAIL,g),sendEvent("failure",Date.now()-E,m),m}}else m.warn("device is already selected")}async askDevicePermission(g){const m={audio:!!g.audio,video:!!g.video};if(!g.audio&&!g.video)throw new CallingCommunicationError(z.DEVICE_MANAGER.ONE_PERMISSION_ATLEAST);const f=this.getKeyForConstrains(m);let S=this._combinedDevicePermission.get(f);return S?this.logger.info(`askDevicePermission attempt: audio:${m.audio}, video:${m.video} on pending existing request ${getPrintableObject(S)}`):(S=this.askDevicePermissionInternal(m),this._combinedDevicePermission.set(f,S),S.finally((()=>{this._combinedDevicePermission.delete(f)}))),S}getKeyForConstrains(g){return Object.keys(g).filter((m=>g[m])).toString()}async askDevicePermissionInternal(g){this.logger.info(`askDevicePermission attempt: audio:${g.audio}, video:${g.video}`);const m=generateGuid(),f=+new Date;this.sendAudioVideoPermissionEvent({eventName:kh.acs_calling_adp_attempt,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video});try{if(!this._tsDeviceManager)throw new CallingCommunicationError(z.DEVICE_MANAGER.ACCESS_DM);const S=[];if(getAcsEcsConfig().calling.devicePermissions.splitAskAudioVideo){this.logger.info("askDevicePermission, split permission check");const m=[];if(g.audio&&(this.logger.info("askDevicePermission, split permission audio"),m.push(this._tsDeviceManager.askDevicePermission({audio:g.audio,video:!1}))),g.video){const askDevicePermissionVideoWithDelay=async m=>new Promise(((f,S)=>{const askDevicePermissionVideo=async()=>{if(this.logger.info("askDevicePermission, split permission video"),!this._tsDeviceManager){const g="askDevicePermission, split permission video failed device manager not found";return this.logger.error(g),void S(g)}try{const m=await this._tsDeviceManager.askDevicePermission({audio:!1,video:g.video});f(m)}catch(g){S(g)}};m?window.setTimeout(askDevicePermissionVideo,m):askDevicePermissionVideo()}));m.push(askDevicePermissionVideoWithDelay(getAcsEcsConfig().calling.devicePermissions.timeoutInBetween))}const f=await Promise.allSettled(m);let v={audio:!1,video:!1};f.forEach((g=>{"fulfilled"===g.status&&g?.value&&(v={audio:v.audio||!!g?.value?.audio,video:v.video||!!g?.value?.video}),"rejected"===g.status&&g?.reason&&S.push(g.reason)})),this.permissionsChanged(v,g),this._safariVideoPermissionState=this._videoDevicePermission?"granted":"denied"}else{const m=await this._tsDeviceManager.askDevicePermission({audio:g.audio,video:g.video});this.permissionsChanged(m,g)}if(g?.audio&&!this._audioDevicePermission||g?.video&&!this._videoDevicePermission)this.sendAudioVideoPermissionEvent({eventName:kh.acs_calling_adp_failure,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission},new CallingCommunicationError(z.DEVICE_MANAGER.PERMISSION_NOT_GRANTED_OR_FAILED(getPrintableObject(S))));else{const S=+new Date;this.sendAudioVideoPermissionEvent({eventName:kh.acs_calling_adp_success,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:S-f})}}catch(S){const v=new CallingCommunicationError(z.DEVICE_MANAGER.ADP_FAIL,S),C=+new Date;this.sendAudioVideoPermissionEvent({eventName:kh.acs_calling_adp_failure,correlationId:m,audioPermissionRequested:g.audio,videoPermissionRequested:g.video,audioPermissionGranted:this._audioDevicePermission,videoPermissionGranted:this._videoDevicePermission,deltaTimeInMs:C-f},v)}return{audio:!!this._audioDevicePermission,video:!!this._videoDevicePermission}}sendAudioVideoPermissionEvent(g,m){try{let f,S,v;m&&(f="string"==typeof m?.message?m?.message:void 0,S=extractCommunicationServicesErrorForTelemetry(m)),g.deltaTimeInMs&&(v=g.deltaTimeInMs>25e3),this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:{audioPermissionGranted:this.nullHandler(g.audioPermissionGranted),videoPermissionGranted:this.nullHandler(g.videoPermissionGranted),audioPermissionRequested:g.audioPermissionRequested,videoPermissionRequested:g.videoPermissionRequested,correlationId:g.correlationId||"",failureReason:f||"",deltaTimeInMs:g.deltaTimeInMs||"",deltaTimeGreaterThanJAMATimeout:this.nullHandler(v),additionalDetails:{...S}}})}catch(g){this.logger.debug("Unable to send audio video permission failure success telemtery")}}sendDeviceSelectionEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send device selection telemetry")}}nullHandler(g){return void 0===g?"":g}dispose(){this._dmDevicesChangedSub&&this._dmDevicesChangedSub.dispose(),this._dmDevicesPermissionChangedSub&&this._dmDevicesPermissionChangedSub.dispose(),this._dmDevicesPermissionChangedSub=void 0,this._dmDevicesChangedSub=void 0}}__decorate$p([loggerProperty,__metadata$p("design:type",Object)],DeviceManagerImpl.prototype,"logger",void 0),__decorate$p([asyncOperation(eu.GetDeviceManager),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getDeviceManager",null),__decorate$p([asyncOperation(eu.GetCameras),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getCameras",null),__decorate$p([asyncOperation(eu.GetMicrophones),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getMicrophones",null),__decorate$p([syncOperation(eu.GetSpeakers),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"getSpeakers",null),__decorate$p([asyncOperation(eu.SelectMicrophone),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"selectMicrophone",null),__decorate$p([asyncOperation(eu.SelectSpeaker),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"selectSpeaker",null),__decorate$p([asyncOperation(eu.AskDevicePermission),__metadata$p("design:type",Function),__metadata$p("design:paramtypes",[Object]),__metadata$p("design:returntype",Promise)],DeviceManagerImpl.prototype,"askDevicePermission",null);var __decorate$q=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$q=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TeamsIncomingCallImpl extends IncomingCallCommonImpl{get info(){return this._teamsCall.info}constructor(g){super(g,Q.TeamsIncomingCall),this._teamsCall=g}async accept(g){if(!isProxyAndCustomTurnAllowed(this._teamsCall.acsProxy,this._teamsCall.acsCustomRelayManager,!0))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN);return await this._teamsCall.accept(g),this._teamsCall}}__decorate$q([asyncOperation(Yh.Accept),__metadata$q("design:type",Function),__metadata$q("design:paramtypes",[Object]),__metadata$q("design:returntype",Promise)],TeamsIncomingCallImpl.prototype,"accept",null);class TeamsCallInfoImpl extends CallInfoCommonImpl{constructor(g){super(g)}}var __decorate$r=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$r=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};class TeamsCallImpl extends CallCommonImpl{get info(){return this._info}constructor(g,m,f,S){super(g,m,f,S,Y.TeamsCall),this._isEmergencyCall=!1,this._musicOnHoldEnabled=!1,this._info=new TeamsCallInfoImpl(f),this._mtPolicyService=m.mtPolicyService}async startCallInternal(g,m,f,S,v){if(this._mtPolicyService&&this._mtPolicyService.isFetchUserPoliciesAndSettingsApplicable()){let g="",m=!0;this._isEmergencyCall=!1;try{this.logger.info("Fetching Teams User policy from MiddleTier Service"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId)}catch(g){m=!1,this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n                    Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.\n                    Proceeding as normal pstn call`)}if(m){try{this.enforcePolicyAndLicenseRestrictions()}catch(g){return void this.handlePolicyAndLicenseRestrictionsFailure(g)}try{this.logger.info("Deriving emergency content from fetched policies and settings"),g=this._mtPolicyService.getEmergencyContent()}catch(g){this.logger.warn(`Error deriving emergency content from fetched policies and settings. \n                    Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}. Proceeding as normal pstn call`)}S&&(S.emergencyContent=g||"",S.isEmergency=g?.trim().length>0||!1,this._isEmergencyCall=S.isEmergency)}}if(v){let g=[];Array.isArray(v)?g=v:g.push(v),this._isEmergencyCall&&1==g.length&&(this.logger.info(`user dialed number (${g[0].phoneNumber}) resolved to actual emergency number (${this._mtPolicyService.getEmergencyNumber()} during startCall`),g[0]={phoneNumber:this._mtPolicyService.getEmergencyNumber()}),g.forEach((g=>{this.tsCall.addParticipant(getMriFromIdentifier(g)).catch((()=>{this.logger.error("Failed to add participant during call start")}))})),this.logger.info("Paticipant added during startCall")}super.startCallInternal(g,m,f,S)}isEmergencyCallInProgress(){return this._isEmergencyCall}dispose(){super.dispose(),this._extensibleApi.dispose()}addParticipant(g,m){const S=+new Date,v=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.attempt,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{attemptTimestamp:S}});let C="";try{this.validateThreadId(g,m),C=m.threadId,validateIdentifier(g)}catch(g){const m=new CallingCommunicationError(z.IDENTIFIER.PARSE_INVALID_IDENTIFIER,g);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}if(!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!0)){const g=new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(g)}}),g}if(this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))){const m=new CallingCommunicationError(z.CALL.PARTICIPANT_ALREADY_IN_CALL(f(g).kind));throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:m.code,failureReason:m.message,...extractCommunicationServicesErrorForTelemetry(m)}}),m}const _=this.getOrCreateRemoteParticipant(constructIdentifierKindFromMri(getMriFromIdentifier(g)));return this.tsCall.addParticipant(getMriFromIdentifier(g),{threadId:C}).then((()=>{this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.success,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date}})})).catch((m=>{const{callEndReason:f}=getRemoteParticipantCallEndReason(this,_.tsRemoteParticipant,m);_.callEndReason||_.setCallEndReason(f);const C=extractCallEndReasonForTelemetry(f);this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"add",correlationId:v,timestampInfo:{deltaTimeInMs:S-+new Date},additionalDetails:{code:C?.callEndReason.code,subCode:C?.callEndReason.subCode,failureReason:C?.callEndReason.message,...C}}),this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)))&&(this.deleteRemoteParticipant(_),this._eventEmitter.emit("remoteParticipantsUpdated",{added:[],removed:[_]}))})),_}async removeParticipant(g){const m=+new Date,S=generateGuid();this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.attempt,participantAddedOrRemoved:"remove",correlationId:S,timestampInfo:{attemptTimestamp:m}});try{validateIdentifier(g)}catch(g){const f=new CallingCommunicationError(z.IDENTIFIER.PARSE_INVALID_IDENTIFIER,g);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:S,timestampInfo:{deltaTimeInMs:m-+new Date},additionalDetails:{code:g.code,failureReason:g.message,...extractCommunicationServicesErrorForTelemetry(f)}}),f}let v=this._remoteParticipants.find((m=>getMriFromIdentifier(m.identifier)===getMriFromIdentifier(g)));if(!v){const v=new CallingCommunicationError(z.CALL.PARTICIPANT_NOT_IN_CALL(f(g).kind));throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:S,timestampInfo:{deltaTimeInMs:+new Date-m},additionalDetails:{code:v.code,subCode:v.subCode,failureReason:v.message,...extractCommunicationServicesErrorForTelemetry(v)}}),v}try{await this.tsCall.removeParticipant(getMriFromIdentifier(g)),this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.success,participantAddedOrRemoved:"remove",correlationId:S,timestampInfo:{deltaTimeInMs:m-+new Date}})}catch(g){const{callEndReason:f}=getRemoteParticipantCallEndReason(this,v.tsRemoteParticipant,g);v.callEndReason||v.setCallEndReason(f);const C=extractCallEndReasonForTelemetry(f);throw this.sendParticipantAddedOrRemovedEvent({kindOfEvent:Lh.failure,participantAddedOrRemoved:"remove",correlationId:S,timestampInfo:{deltaTimeInMs:m-+new Date},additionalDetails:{code:C?.callEndReason.code,subCode:C?.callEndReason.subCode,failureReason:C?.callEndReason.message,...C}}),new CallingCommunicationError({message:f.message,code:f.code,subCode:f.subCode||0,resultCategories:f.resultCategories},g)}}async mute(){super.mute()}async unmute(){super.unmute()}async hold(){if(4===this.tsCall.state)return void this.logger.info("Call already on hold");if(!getAcsEcsConfig().calling.musicOnHoldEnabled)return this.logger.warn("Music on Hold is not enabled"),super.hold();this._musicOnHoldEnabled=!1;const g=+new Date,m=generateGuid();this._causeId=w.generateCauseId(),this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:pu.MusicOnHold}});try{this.logger.info("Fetching Teams Calling Policy from Azure Communication Services"),await this._mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(this.tsCall.callId,this.tsCall.participantId,{policyUrlSuffix:getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,userPolicies:["TeamsCallingPolicy"]}),this._musicOnHoldEnabled=this._mtPolicyService.isMoHEnabled()}catch(g){this.logger.warn(`Fetching Teams Calling Policy from Azure Communication Services failed.\n                Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.`)}return this._musicOnHoldEnabled?await this.tsCall.hold(void 0,this._causeId,{isLocal:!0},1).then((async()=>{this.logger.info("Successfully detached devices as part of Hold"),await this.tsCall.park(3,this._causeId).then((()=>{const f=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{holdType:pu.MusicOnHold}}),this.logger.info("Successful park() as part of hold, Music on Hold completed successfully")}))})).catch((()=>{const f=+new Date,S=new CallingCommunicationError(z.CALL.HOLD_CALL);throw this.logger.warn(`Attempting to perform Music on Hold failed.\n                    Error message = ${S.message}, code = ${S.code}, subcode = ${S.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Hold,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,holdType:pu.MusicOnHold,...extractCommunicationServicesErrorForTelemetry(S)}}),S})):(this.logger.info("Fetching  of Teams Calling Policy failed or Music on Hold Disabled, proceeding with standard hold"),super.hold())}async resume(){if(this._musicOnHoldEnabled){const g=+new Date,m=generateGuid();return this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.attempt,timestampInfo:{deltaTimeInMs:g},additionalDetails:{holdType:pu.MusicOnHold}}),await this.tsCall.unpark(3,this._causeId).then((async()=>{this.logger.info("Successful unpark() as part of resume"),await this.tsCall.unhold(void 0,this._causeId).then((()=>{const f=+new Date;this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.success,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{holdType:pu.MusicOnHold}}),this.logger.info("Successful unhold() as part of resume, resume completed successfully")}))})).catch((()=>{const f=+new Date,S=new CallingCommunicationError(z.CALL.RESUME_CALL);throw this.logger.warn(`Attempting to perform resume from Music on Hold failed.\n                    Error message = ${S.message}, code = ${S.code}, subcode = ${S.subCode}`),this.sendCallOnHoldAndResumedEvent({eventName:kh.acs_calling_call_hold_and_resume,callId:this.id,localParticipantId:this.tsCall.participantId,correlationId:m,operation:Yh.Resume,kindOfEvent:Lh.failure,timestampInfo:{deltaTimeInMs:f-g},additionalDetails:{failureReason:S.message,code:S.code,subCode:S.subCode,holdType:pu.MusicOnHold,...extractCommunicationServicesErrorForTelemetry(S)}}),S}))}return this.logger.info("Music on Hold Disabled, proceeding with standard resume"),super.resume()}validateThreadId(g,m){if(!m?.threadId)throw new CallingCommunicationError(z.CALL.CTE_ADDPARTICIPANT_NO_THREAD_ID)}enforcePolicyAndLicenseRestrictions(){const g=+new Date;if(!this._mtPolicyService.isEvEnabled()){const m=+new Date,f=new CallingCommunicationError(z.CALL.CTE_VOICE_NOT_ENABLED);this.logger.error(`Error Message = ${f.message}, code = ${f.code}, subcode = ${f.subCode}`);const S=this._callAgent.getEcsConfigIds();throw this.sendCallStageEvent({eventName:kh.acs_calling_call_failed,correlationId:generateGuid(),timestampInfo:{deltaTimeInMs:m-g},additionalPayload:{additionalProperties:{EmergencyCountryCode:this._callAgent._caConfigBag?.emergencyCountryCode||"",IsUserEmergencyCountryCode:this._callAgent._caConfigBag?.IsUserEmergencyCountryCode||!1,trouterState:this._callAgent.getTrouterState(),AcsCallingSDKWeb_ecsConfigId:S.AcsCallingSDKWeb,SkypeWebMedia_ecsConfigId:S.SkypeWebMedia},additionalDetails:{...extractCommunicationServicesErrorForTelemetry(f)}}},f,{code:f.code,subCode:f.subCode,phrase:f.message}),f}}handlePolicyAndLicenseRestrictionsFailure(g){this._callEndReason={message:"Unknown",code:g?.code,subCode:g?.subCode,resultCategories:g?.resultCategories},this._state="Disconnected",this._eventEmitter.emit("stateChanged"),this._callAgent.handleCallRemoved(this.tsCall)}}__decorate$r([validateEmergencyCallOperation(Yh.AddParticipant),syncOperation(Yh.AddParticipant),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[Object,Object]),__metadata$r("design:returntype",Object)],TeamsCallImpl.prototype,"addParticipant",null),__decorate$r([validateEmergencyCallOperation(Yh.RemoveParticipant),asyncOperation(Yh.RemoveParticipant),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[Object]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"removeParticipant",null),__decorate$r([validateEmergencyCallOperation(Yh.Mute),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"mute",null),__decorate$r([validateEmergencyCallOperation(Yh.Unmute),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"unmute",null),__decorate$r([validateEmergencyCallOperation(Yh.Hold),asyncOperation(Yh.Hold),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"hold",null),__decorate$r([validateEmergencyCallOperation(Yh.Resume),asyncOperation(Yh.Resume),__metadata$r("design:type",Function),__metadata$r("design:paramtypes",[]),__metadata$r("design:returntype",Promise)],TeamsCallImpl.prototype,"resume",null);var __decorate$s=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$s=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};const Jf=new Map;class TeamsCallAgentImpl extends CallAgentCommonImpl{get calls(){return this._calls}constructor(g,m,f,S,v,C){super(g,m,S,v,f,J.TeamsCallAgent,C),this._calls=[],this.handleCallAdded=g=>{if(!this._calls.find((m=>m.id===g.callId))){const m=g.on("callStateChanged",(()=>{if(1===g.state){const f=g.callId;m.dispose();const S=new TeamsCallImpl({callId:f,isIncoming:!0},this,g,this._telemetryLogManager),v=new TeamsIncomingCallImpl(S);this.handleCallState(S),S.bindTsCall(),this._eventEmitter.emit("incomingCall",{incomingCall:v})}}))}},this.handleCallRemoved=g=>{this.logger.info(`removing callId=${g.callId}`);const m=this._calls.find((m=>m.id===g.callId));if(m){const g=this._calls.indexOf(m);-1!==g&&this._calls.splice(g,1),m.dispose(),this.trackCallEndTimeToStopTelemetry(this._calls),this._eventEmitter.emit("callsUpdated",{added:[],removed:[m]}),this.logger.info("call removed")}},this.handleCallState=g=>{g.on("stateChanged",(()=>{try{if("Disconnected"===g.state){this.tsStack?(this._tsCallRegistry.deleteCall(g.tsCall)||this.logger.error(`Failed to remove call from registry, call id: ${g.id}`),g.stats.flushEvents(),this._telemetryLogManager.flushAllEvents(g.id).catch((()=>{this.logger.error("Failed to flush telemetry log manager events")}))):this.logger.info("Unable to remove call from registry")}else"Connecting"===g.state&&"Incoming"==g.direction&&(this.addToCallArray(g),this._eventEmitter.emit("callsUpdated",{added:[g],removed:[]}))}catch(g){this.logger.error("Failed to handle call state changed event")}}))},this.logger=m}createNewCall(g,m){return new TeamsCallImpl({callId:g},this,m,this._telemetryLogManager)}addToCallArray(g){this._calls.push(g),this.trackCallEndTimeToStopTelemetry(this._calls)}addToCallAgentsMap(g){Jf.get(g?.identityMri)&&logErrorAndThrow(z.CALL_AGENT.TEAMS_CALLAGENT_ALREADY_EXSISTS,this.logger),Jf.set(g?.identityMri,this)}removeFromCallAgentsMap(g){g?.identityMri&&Jf.get(g?.identityMri)===this&&Jf.delete(g?.identityMri)}getMiddleTierServiceInstance(){return this.mtPolicyService}async setUserPoliciesOnAgentInitialization(){try{if(this.isCteUser()){this.mtPolicyService.initialize({localParticipant:this.getUserMri(),skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});let g=generateGuid();this.logger.info(`ACS MiddleTier service called on Teams Call Agent initialization with call Id=${g}`),await this.mtPolicyService.fetchUserPoliciesFromAcsMiddleTier(g,this.getUserMri(),{policyUrlSuffix:getAcsEcsConfig().MiddleTier.policyUrlSuffixV2,userPolicies:["EmergencyPolicies","TeamsCallingPolicy","TeamsMeetingPolicy"],userProperties:["FeatureTypes","PoliciesMetadata","phoneNumber","sipUri","hostType","accountEnabled","useTeamsCalling","evEnabled","region","routingType","preferredDataLocation","featureTypes"]}),this._userPolicies=this.mtPolicyService.getUserPolicy(),this.logger.info(`****User policy initialized to ${JSON.stringify(this._userPolicies)}`)}}catch(g){this.logger.warn(`Fetching Teams user policy from ACS MiddleTier Service failed.\n            Error message = ${g?.message}, code = ${g?.code}, subcode = ${g?.subCode}.`)}}startCall(g,m){let f;if(this.assertParticipants(g),this.isCteUser()&&Array.isArray(g)){if(f=m,g.length>1&&!f?.threadId)throw new CallingCommunicationError(z.CALL_AGENT.GROUPCALL_THREADID);if(1==g.length&&f?.threadId)throw new CallingCommunicationError(z.CALL_AGENT.ONE_TO_ONE_THREADID)}else f=m;this.mtPolicyService.isFetchUserPoliciesAndSettingsApplicable(this.isCteUser(),g)&&this.mtPolicyService.initialize({localParticipant:this.getUserMri(),pstnNumber:Array.isArray(g)?g[0].phoneNumber:g.phoneNumber,skypeToken:this._parsedTokenCredential.jwtToken,telemetryLogManager:this._telemetryLogManager});let S=f?.audioOptions?.muted;return void 0===S&&(S=!1),this.logger.info(`startCall with video=${!!f?.videoOptions},muted=${S}`),this.createCall({participants:g,startCallOptions:f})}join(g,m){this.assertCallContext(g);let f=!!m?.audioOptions?.muted;return this.logger.info(`join with video=${!!m?.videoOptions},muted=${f}`),this.createCall({teamsCallContext:g,startCallOptions:m})}async dispose(){if(this._disposed)throw new CallingCommunicationError(z.CALL_AGENT.CTE_ALREADY_DISPOSED);this._disposed=!0,this._abortController.abort(),this._extensibleApi.dispose(),this._parsedTokenCredential?.identityMri&&Jf.delete(this._parsedTokenCredential?.identityMri);try{const g=this._tokenFetchTries>this._maxNmberOfRetries;await(this._callStack?.dispose(g))}catch(g){this.logger.error("Call Agent failed to dispose to Call Stack")}this.offTrouterStateChanged(this._trouterStateChangeCallback),this._callStack.offRegisteredChanged(this._registrarStateChangeCallback),delete this._callStack,this._telemetryLogManager.clearTelemetryLoggers(),this.onDisposedCallback&&this.onDisposedCallback()}on(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError(z.CALL_AGENT.EVENT_SUBSCRIBE(g));this._eventEmitter.on(g,m)}off(g,m){if("incomingCall"!==g&&"callsUpdated"!==g&&"connectionStateChanged"!==g)throw new CallingCommunicationError(z.CALL_AGENT.EVENT_UNSUBSCRIBE(g));this._eventEmitter.off(g,m)}createCall(g){let m,f,S,v=g?.teamsCallContext?.threadId;const C=g?.teamsCallContext?.meetingLink,_=g?.teamsCallContext?.meetingId,E=g?.teamsCallContext?.passcode||"",T=!!g?.participants&&(Array.isArray(g?.participants)&&g?.participants.length>1);if(this.isCteUser()&&T&&(v=(g?.startCallOptions).threadId),!isProxyAndCustomTurnAllowed(this.acsProxy,this.acsCustomRelayManager,!0))throw new CallingCommunicationError(z.CALL_AGENT.PROXY_CUSTOM_TURN_FORBIDDEN);if(C&&(f=parseMeetingUrl(C)),g?.teamsCallContext?.threadId&&g?.teamsCallContext?.organizerId&&g?.teamsCallContext?.tenantId&&(f={threadId:g?.teamsCallContext?.threadId,messageId:g?.teamsCallContext?.messageId?g?.teamsCallContext?.messageId.toString():"0",organizerId:g?.teamsCallContext?.organizerId,tenantId:g?.teamsCallContext?.tenantId}),f&&(S={meetingType:"0"===f.messageId?1:2,tenantId:f.tenantId,organizerId:f.organizerId,replyChainMessageId:f.messageId}||void 0,v=f.threadId,m=f.messageId),this.tsStack){const f=w.generateCauseId(),C=generateGuid(),T=generateGuid();let I;I=_?this._tsCallRegistry.createCallWithMeetingData({meetingCode:_,passcode:E,threadId:v},C,T,f):this._tsCallRegistry.createCall(v||"",C,T,m,f);const b=new TeamsCallImpl({callId:C},this,I,this._telemetryLogManager);this.addToCallArray(b),this.handleCallState(b);const A={threadId:v||"",messageId:m||"",meetingInfo:S,mediaPeerType:2};return b.startCallInternal(g?.startCallOptions,!!_,g?.teamsCallContext,A,g?.participants).catch(noop),b.bindTsCall(),this._eventEmitter.emit("callsUpdated",{added:[b],removed:[]}),b}throw new CallingCommunicationError(z.CALL_AGENT.STACK_NOT_INIT)}assertParticipants(g){assertIsObject(g,z.CALL_AGENT.USERIDS_MUST_BE_OBJECTS),assertNotNull(g,z.CALL_AGENT.USERIDS_CANNOT_BE_NULL)}assertCallContext(g){if(!g||this.checkForAtLeastOneValidCallConfig(g)||this.checkForInvalidTeamsMeetingCoordinates(g))throw new CallingCommunicationError(z.CALL_AGENT.INVALID_CALL_CONFIG)}checkForAtLeastOneValidCallConfig(g){return!g.threadId&&!g.meetingLink&&!g.meetingId}checkForInvalidTeamsMeetingCoordinates(g){return!g.threadId&&g.tenantId&&g.organizerId||g.threadId&&(g.organizerId&&!g.tenantId||!g.organizerId&&g.tenantId)}}__decorate$s([syncOperation(Jh.StartCall),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[Object,Object]),__metadata$s("design:returntype",Object)],TeamsCallAgentImpl.prototype,"startCall",null),__decorate$s([syncOperation(Jh.Join),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[Object,Object]),__metadata$s("design:returntype",Object)],TeamsCallAgentImpl.prototype,"join",null),__decorate$s([asyncOperation(Jh.Dispose),__metadata$s("design:type",Function),__metadata$s("design:paramtypes",[]),__metadata$s("design:returntype",Promise)],TeamsCallAgentImpl.prototype,"dispose",null);class AcsProxy{constructor(){this._proxyInUse=!1;const m=g("ACS-calling");this.logger=new DefaultLogger(m,[()=>"AcsProxy"])}get proxyInUse(){return this._proxyInUse}set proxyInUse(g){this._proxyInUse=g}get proxyUrl(){return this._proxyUrl?.toString()||""}set proxyUrl(g){if(g.length<4)throw new CallingCommunicationError(z.CALL_CLIENT.PROXY_SHORT_URL);"/"!==g.slice(-1)&&(g=g.concat("","/"));try{const m=new URL(g);if("https:"!==m.protocol&&"http:"!==m.protocol)throw new CallingCommunicationError(z.CALL_CLIENT.PROXY_PROTOCOL);this._proxyUrl=m}catch(g){const m=new CallingCommunicationError(z.CALL_CLIENT.SETUP_PROXY(JSON.stringify(g)),g);throw this.logger.error(m.message),m}}hasProxyUrl(){return!!this._proxyUrl}proxyfyUrl(g){let m=g;if(!this._proxyUrl)return this.logger.info(`Proxy url not defined, return original ${m}`),m;try{const g=new URL(m);m=`${`${g.protocol}//${this._proxyUrl.host}${this._proxyUrl.pathname}`}${g.host}${g.pathname}${g.search}`,this.logger.info(`Proxyfing url from ${g} to ${m}`)}catch(g){const m=`Failed proxyfy url with error: ${JSON.stringify(g)}, returning original`;this.logger.error(m)}return this._proxyInUse=!0,m}}class AcsCustomRelayManager{constructor(){this._hasCustomRelay=!1,this._customRelayManagerInUse=!1;const m=g("ACS-calling");this._logger=new DefaultLogger(m,[()=>"AcsCustomRelayManager"])}getRelayConfig(){return this._relayConfig}setRelayConfig(g){this._relayConfig={...g},this._logger.info("Custom relay config provided"),this._hasCustomRelay=!0,this._createTsRelayManager()}get hasRelayConfig(){return this._hasCustomRelay}get customRelayManagerInUse(){return this._customRelayManagerInUse}set customRelayManagerInUse(g){this._customRelayManagerInUse=g}getTsRelayManager(){return this._tsRelayManager}_createTsRelayManager(){if(!this._hasCustomRelay||!this._relayConfig||this._relayConfig.iceServers.length<1)return void this._logger.warn("No relay config provided. No op.");const g=[];this._relayConfig.iceServers.forEach((m=>{m.urls.forEach((f=>{const S=this._getIndividualRelay(f,m?.username,m?.credential);g.push(S)}))})),this._tsRelayManager={initialize(){},queryRelaysAsync:m=>Promise.resolve(g)}}_getIndividualRelay(g,m,f){const S=3478,v=[],C=[],_=[vu.turn,vu.turns,vu.stun],E=[yu.tcp,yu.tls,yu.udp];let T;try{T=new URL(g)}catch(g){throw new CallingCommunicationError(z.CALL_CLIENT.RELAY_INFO(JSON.stringify(g)),g)}const I=T.protocol.replace(":","");if(!_.includes(I))throw new CallingCommunicationError(z.CALL_CLIENT.RELAY_UNRECOGNIZED_SCHEMA);let b;try{const g=T.href.replace(/((turn)s?|stun):/,"https:");b=new URL(g)}catch(g){throw new CallingCommunicationError(z.CALL_CLIENT.RELAY_INFO(JSON.stringify(g)),g)}let A=b.searchParams.get("transport")??"";E.includes(A)||(this._logger.warn(`Unknown transport protocol detected for the provided turn, defaulting to ${yu.udp}`),A=yu.udp);let P=""===b.port?this._extractPortFromUrl(T):Number(b.port);P||(this._logger.warn(`Could not read port from relay url, defaulting to ${S}`),P=S);let R=b.hostname;return isIpv4Address(R)?v.push(R):C.push(R),{addresses:v,udpPort:A===yu.udp?P:void 0,tcpPort:A===yu.tcp?P:void 0,tlsPort:A===yu.tls?P:void 0,username:m??"",password:f??"",type:"turn",fqdns:C}}_extractPortFromUrl(g){const m=g.href.match(ll)?.[0];return Number(m?.replace(":",""))}}var Yf,__decorate$t=function(g,m,f,S){var v,C=arguments.length,_=C<3?m:null===S?S=Object.getOwnPropertyDescriptor(m,f):S;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)_=Reflect.decorate(g,m,f,S);else for(var E=g.length-1;E>=0;E--)(v=g[E])&&(_=(C<3?v(_):C>3?v(m,f,_):v(m,f))||_);return C>3&&_&&Object.defineProperty(m,f,_),_},__metadata$t=function(g,m){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(g,m)};let Qf=1;class CallClient{get callAgent(){return this._callAgent}get teamsCallAgent(){return this._teamsCallAgent}get sdkDiagnosticInformation(){return this._sdkDiagnosticInformation}get telemetryLogManager(){return this._telemetryLogManager}setCallAgent(g){this._callAgent=g}setTeamsCallAgent(g){this._teamsCallAgent=g}on(g,m){this._eventEmitter.on(g,m)}off(g,m){this._eventEmitter.off(g,m)}constructor(m){this._customProxyAndTurnInformation={proxy:null,turn:null},this.sendTelemetry=()=>{try{if(getAcsEcsConfig().telemetry.telemetryBeforeUnload&&this._callAgent&&this._callAgent._calls)for(const g of this._callAgent._calls){g.tsCall.sendLastKnownStats()}}catch(g){this.logger.debug("Error logging telemetry",g)}},this.handleVisibilityChange=()=>{"hidden"===document.visibilityState?(this.logger.debug("Visibility changed to hidden"),this.sendPageVisibilityInfoEvent("visibilityChange",!0),this.hangupCalls()):(this.logger.debug("Visibility changed to visible"),this.sendPageVisibilityInfoEvent("visibilityChange",!1))},this.handlePageShow=()=>{this.logger.debug("Page show"),this.sendPageVisibilityInfoEvent("pageShow",!0)},this.handlePageHide=()=>{this.logger.debug("Page hide"),this.sendPageVisibilityInfoEvent("pageHide",!1)},this.handleOrientationChange=()=>{this.logger.debug(`Orientation changed to ${screen.orientation.type}`),this.sendOrientationChangeEvent(screen.orientation.type)},this.getOrientationBasedOnWindowSize=()=>window.innerHeight>window.innerWidth?"portrait-primary":"landscape-primary",this.handleResize=()=>{const g=this.getOrientationBasedOnWindowSize();this._previousOrientation!==g&&(this._previousOrientation=g,this.sendOrientationChangeEvent(g))};const f=+new Date;this.clientId=generateGuid();const S=m?.logger||g("ACS-calling"),v=Qf++;if(this._acsProxy=new AcsProxy,this._acsCustomRelayManager=new AcsCustomRelayManager,m?.networkConfiguration){m.networkConfiguration.proxy?.url&&(this._customProxyAndTurnInformation.proxy={...m.networkConfiguration.proxy},this._acsProxy.proxyUrl=this._customProxyAndTurnInformation.proxy.url),m.networkConfiguration.turn&&(this._customProxyAndTurnInformation.turn={...m.networkConfiguration.turn},this._acsCustomRelayManager.setRelayConfig(this._customProxyAndTurnInformation.turn));const g=this.getTelemetryTag();m.diagnostics?m.diagnostics.tags?m.diagnostics.tags.push(g):m.diagnostics.tags=[g]:m.diagnostics={tags:[g]}}this.logger=new DefaultLogger(S,[()=>`CallClient${v}`]),this._eventEmitter=new CallingEventEmitter(this.logger),this._sdkDiagnosticInformation=buildCallingUserAgent(getSdkVersion(),this.logger,m),this.diagnosticOptions=m?.diagnostics,this.firstPartyOptions=m?.firstPartyOptions,this._telemetryLogManager=new TelemetryLogManager(this.logger,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager);try{this.sendCallClientInitEvent({eventName:kh.acs_calling_call_client_init,kindOfEvent:"attempt",timestampInfo:"",additionalDetails:""}),Object.defineProperty(globalThis,Do,{value:v,writable:!0,enumerable:!1}),1===v&&Object.defineProperty(globalThis,Mo,{value:this._telemetryLogManager,writable:!1,enumerable:!1}),this.logger.info("created"),this._callStack=new CallStack(this.logger,this.clientId,this._telemetryLogManager,this._sdkDiagnosticInformation,this._acsProxy,this._acsCustomRelayManager,this.firstPartyOptions?.encodedStreamsJsPath),this._deviceManager=new DeviceManagerImpl(this.logger,this._callStack,this._telemetryLogManager),this._previousOrientation="",this.sendInitialOrientation(),window.addEventListener("beforeunload",this.sendTelemetry),window.addEventListener("visibilitychange",this.handleVisibilityChange,!1),window.addEventListener("pageshow",this.handlePageShow,!1),window.addEventListener("pagehide",this.handlePageHide,!1),screen.orientation?screen.orientation.addEventListener("change",this.handleOrientationChange):window.addEventListener("resize",this.handleResize,!1),this._extensibleApi=new ExtensibleFeatureImpl(this.logger,{callClient:this},{callClient:this,telemetryLogManager:this._telemetryLogManager});const g=getRegisteredFeatures(Pu.CallClientFeature);for(const m of g)"OnExtendedObjectConstructor"===m.activationOptions.activationEvent&&this.feature(m);this.sendCallClientInitEvent({eventName:kh.acs_calling_call_client_init,kindOfEvent:"success",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:""})}catch(g){const m=new CallingCommunicationError(z.CALL_CLIENT.INIT_CALL_CLIENT,g);throw this.sendCallClientInitEvent({eventName:kh.acs_calling_call_client_init,kindOfEvent:"failure",timestampInfo:{deltaTimeInMs:+new Date-f},additionalDetails:{failureReason:m.message,code:m.code,subCode:m.subCode,...extractCommunicationServicesErrorForTelemetry(m)}}),m}}createInstance(g){return new CallClient(g)}get acsProxy(){return this._acsProxy}get acsCustomRelayManager(){return this._acsCustomRelayManager}getSDKVersion(){return getSdkVersion()}feature(g){return this._extensibleApi.getApiObjectInstance(g.callClientApiCtor)}async createCallAgent(g,m){(this._callAgent||this._teamsCallAgent)&&logErrorAndThrow(z.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger),this.validateEmergencyCountryCode(m);try{const onDisposedCallback=()=>{this._callAgent=void 0};return this._callAgent=new CallAgentImpl(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager,m),await this._callAgent.initialize(g,onDisposedCallback,m),this._eventEmitter.emit("callAgentCreated"),this._callAgent}catch(g){throw this._callAgent=void 0,new CallingCommunicationError(z.CALL_CLIENT.CREATE_CALL_AGENT,g)}}async createTeamsCallAgent(g,m){(this._callAgent||this._teamsCallAgent)&&logErrorAndThrow(z.CALL_CLIENT.ONE_CALL_AGENT_PER_CALL_CLIENT,this.logger);try{const onDisposedCallback=()=>{this._teamsCallAgent=void 0};return this._teamsCallAgent=new TeamsCallAgentImpl(this,this.logger,this._callStack,this.clientId,this._telemetryLogManager,this._deviceManager),await this._teamsCallAgent.initialize(g,onDisposedCallback,m),this._teamsCallAgent.setUserPoliciesOnAgentInitialization(),this._eventEmitter.emit("teamsCallAgentCreated"),this._teamsCallAgent}catch(g){throw this._teamsCallAgent=void 0,new CallingCommunicationError(z.CALL_CLIENT.CREATE_TEAMS_CALL_AGENT,g)}}async getDeviceManager(){return await this._deviceManager.getDeviceManager(),this._deviceManager}async getEnvironmentInfoInternal(){return this._environmentInfos||(await this._callStack.createStackBase(),this._environmentInfos=getEnvironmentInfos()),this._environmentInfos}validateEmergencyCountryCode(g){g?.emergencyCallOptions?.countryCode&&g.emergencyCallOptions?.countryCode.length>uo&&logErrorAndThrow(z.CALL_CLIENT.EMERGENCY_CODE_TOO_LONG,this.logger)}sendOrientationChangeEvent(g,m=!1){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:kh.acs_calling_orientation_changed,tenant:so,properties:{orientation:g,isInitial:m}})}catch(g){this.logger.debug("Unable to send orientation change telemtery")}}sendInitialOrientation(){let g=screen.orientation&&screen.orientation.type;g||(g=this.getOrientationBasedOnWindowSize()),this.sendOrientationChangeEvent(g,!0)}sendCallClientInitEvent(g){try{this._telemetryLogManager.sendEvent({name:g.eventName,tenant:so,properties:g})}catch(g){this.logger.debug("Unable to send CallClient initialized telemtery event")}}hangupCalls(){try{"Mobile"===getBrowserInfo().formFactor&&getAcsEcsConfig().calling.hangUpCallOnPageHide&&this._callAgent?.calls.forEach((g=>g.hangUp()))}catch(g){try{this.logger.error(`Unable to hangup call on page hide due to ${JSON.stringify(g)}`)}catch(g){this.logger.error("Unable to hangup call on page hide due to unknown error")}}}sendPageVisibilityInfoEvent(g,m){if(this._callAgent?._calls?.length)try{this._telemetryLogManager.sendEvent({name:kh.acs_calling_page_hidden,tenant:so,properties:{eventName:g,pageHidden:m}})}catch(g){this.logger.debug("Unable to send page hide telemtery")}}getTelemetryTag(){return this._customProxyAndTurnInformation.proxy&&this._customProxyAndTurnInformation.turn?nl.usedProxyAndNonMsftTurn:this._customProxyAndTurnInformation.proxy?nl.onlyUsedProxy:this._customProxyAndTurnInformation.turn?nl.onlyUsedNonMsftTurn:""}}__decorate$t([loggerProperty,__metadata$t("design:type",Object)],CallClient.prototype,"logger",void 0),__decorate$t([syncOperation(Kh.GetSDKVersion),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",String)],CallClient.prototype,"getSDKVersion",null),__decorate$t([syncOperation(Kh.Feature),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object]),__metadata$t("design:returntype","function"==typeof(Yf="undefined"!=typeof TFeature&&TFeature)?Yf:Object)],CallClient.prototype,"feature",null),__decorate$t([asyncOperation(Kh.CreateCallAgent),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object,Object]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"createCallAgent",null),__decorate$t([asyncOperation(Kh.CreateTeamsCallAgent),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[Object,Object]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"createTeamsCallAgent",null),__decorate$t([asyncOperation(Kh.GetDeviceManager),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"getDeviceManager",null),__decorate$t([asyncOperation(Kh.GetEnvironmentInfo),__metadata$t("design:type",Function),__metadata$t("design:paramtypes",[]),__metadata$t("design:returntype",Promise)],CallClient.prototype,"getEnvironmentInfoInternal",null);export{J as CallAgentKind,CallClient,Y as CallKind,Wg as DataChannelState,Hu as DiagnosticQuality,am as Features,Q as IncomingCallKind,LocalAudioStream,Eg as LocalRecordingState,LocalVideoStream,_g as RecordingState,VideoStreamRenderer};
